exports.id=7954,exports.ids=[7954],exports.modules={41692:(e,t,a)=>{Promise.resolve().then(a.bind(a,37761))},14443:(e,t,a)=>{Promise.resolve().then(a.t.bind(a,2583,23)),Promise.resolve().then(a.t.bind(a,26840,23)),Promise.resolve().then(a.t.bind(a,38771,23)),Promise.resolve().then(a.t.bind(a,13225,23)),Promise.resolve().then(a.t.bind(a,9295,23)),Promise.resolve().then(a.t.bind(a,43982,23))},94444:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var n=a(95344),o=a(3729);let r=()=>{let[e,t]=(0,o.useState)("light"),[a,r]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{r(!0);let e=localStorage.getItem("theme");if(e)t(e),document.documentElement.classList.toggle("dark","dark"===e);else{let e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";t(e),document.documentElement.classList.toggle("dark","dark"===e)}},[]),a)?n.jsx("button",{"data-theme-toggle":!0,onClick:()=>{let a="light"===e?"dark":"light";document.documentElement.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",t(a),localStorage.setItem("theme",a),document.documentElement.classList.toggle("dark","dark"===a);let n=document.querySelector("[data-theme-toggle]");n&&(n.style.transform="scale(0.95)",setTimeout(()=>{n.style.transform="scale(1)"},150)),setTimeout(()=>{document.documentElement.style.transition="",document.body.style.transition=""},600)},className:"p-2.5 text-gray-600 hover:text-gray-900 hover:bg-white/60 rounded-lg transition-all duration-200 hover:shadow-sm   dark:text-gray-300 dark:hover:text-white dark:hover:bg-gray-700",title:"light"===e?"Cambiar a modo oscuro":"Cambiar a modo claro",children:"light"===e?n.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"})}):n.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h1M3 12H2m15.325 6.675l-.707.707M6.707 6.707l-.707-.707m10.626 0l.707-.707M6.707 17.293l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z"})})}):n.jsx("div",{className:"p-2.5 text-gray-600 rounded-lg",children:n.jsx("div",{className:"w-5 h-5"})})}},37761:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>r});var n=a(95344),o=a(3729);let r=({children:e})=>{let[t,a]=(0,o.useState)(!1),[r,s]=(0,o.useState)("light");return(0,o.useEffect)(()=>{let e=new MutationObserver(e=>{e.forEach(e=>{if("attributes"===e.type&&"class"===e.attributeName){let e=document.documentElement.classList.contains("dark")?"dark":"light";e!==r&&(s(e),a(!0),setTimeout(()=>{a(!1)},600))}})});return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[r]),(0,n.jsxs)("div",{className:`relative transition-all duration-500 ease-in-out ${t?"opacity-90 scale-[0.98] blur-[1px]":"opacity-100 scale-100 blur-0"}`,children:[t&&(0,n.jsxs)("div",{className:"fixed inset-0 z-[9999] pointer-events-none",children:[n.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-indigo-500/10 dark:from-gray-900/20 dark:via-gray-800/20 dark:to-gray-900/20 animate-pulse"}),n.jsx("div",{className:"absolute inset-0 bg-white/5 dark:bg-black/5 backdrop-blur-sm"}),n.jsx("div",{className:"absolute inset-0 bg-gradient-radial from-blue-400/20 via-transparent to-transparent animate-ping"})]}),e]})}},48048:(e,t,a)=>{"use strict";a.d(t,{Z:()=>u});var n=a(95344),o=a(3729),r=a(72829),s=a(86071);function i({conversationId:e,otherUser:t,onClose:a,userId:s,userRole:i,session:l,windowIndex:c=0,isInChatBar:d=!1}){let[u,h]=(0,o.useState)([]),[g,m]=(0,o.useState)(""),[x,f]=(0,o.useState)(!1),[v,p]=(0,o.useState)(!1),[D,C]=(0,o.useState)(!1),[w,y]=(0,o.useState)({x:0,y:0}),[b,j]=(0,o.useState)({x:0,y:0}),E=(0,o.useRef)(null),N=(0,o.useRef)(null),k=()=>{if(d){let e=window.innerWidth-24-320,t=window.innerWidth-e+8+328*c;return console.log("\uD83E\uDE9F [IndividualChatWindow] Posici\xf3n en barra de chat (derecha a izquierda):",{windowIndex:c,windowInnerWidth:window.innerWidth,mainChatLeftEdge:e,finalRight:t,isInChatBar:d}),{right:t,y:0}}{let e=window.innerHeight-500-24,t=window.innerWidth-24-320,a=t-20,n=a-320-340*c,o=Math.max(20,n);return console.log("\uD83E\uDE9F [IndividualChatWindow] Calculando posici\xf3n flotante:",{windowIndex:c,windowWidth:320,windowHeight:500,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,mainChatLeftEdge:t,individualWindowRightEdge:a,finalX:n,adjustedX:o,finalY:e}),{x:o,y:e}}};(0,o.useEffect)(()=>{y(k())},[c]);let W=async()=>{if(e&&l)try{f(!0);let t=await fetch(`/api/chat/messages?conversation_id=${e}`,{headers:{Authorization:`Bearer ${l.access_token}`}}),a=await t.json();a.success&&h(a.messages||[])}catch(e){console.error("Error cargando mensajes:",e)}finally{f(!1)}},_=async()=>{if(console.log("\uD83D\uDCE4 [IndividualChat] Intentando enviar mensaje:",{newMessage:g.trim(),conversationId:e,hasSession:!!l,sessionToken:l?.access_token?"Presente":"Ausente"}),!g.trim()||!e||!l){console.log("❌ [IndividualChat] Validaci\xf3n fallida:",{hasMessage:!!g.trim(),hasConversationId:!!e,hasSession:!!l});return}try{console.log("\uD83D\uDE80 [IndividualChat] Enviando mensaje a API...");let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({conversation_id:e,content:g.trim()})});console.log("\uD83D\uDCE1 [IndividualChat] Respuesta de API:",t.status,t.statusText);let a=await t.json();console.log("\uD83D\uDCCB [IndividualChat] Datos de respuesta:",a),a.success?(console.log("✅ [IndividualChat] Mensaje enviado exitosamente"),m(""),await W()):console.log("❌ [IndividualChat] Error en respuesta:",a.error)}catch(e){console.error("❌ [IndividualChat] Error enviando mensaje:",e)}},S=()=>{N.current?.scrollIntoView({behavior:"smooth"})};(0,o.useEffect)(()=>{S()},[u]),(0,o.useEffect)(()=>{W()},[e]),(0,o.useEffect)(()=>{if(!e)return;let t=r.O.channel(`individual-chat-${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`conversation_id=eq.${e}`},async e=>{console.log("\uD83D\uDCE8 [IndividualChat] Nuevo mensaje recibido:",e),await W()}).subscribe();return()=>{r.O.removeChannel(t)}},[e]);let A=e=>{v&&y({x:e.clientX-b.x,y:e.clientY-b.y})},I=()=>{p(!1)};(0,o.useEffect)(()=>{if(v)return document.addEventListener("mousemove",A),document.addEventListener("mouseup",I),()=>{document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",I)}},[v,b]);let T=(t?.email||"").split("@")[0]||t.name||t.email||"Usuario";return(0,n.jsxs)("div",{ref:E,className:"w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] fixed",style:d?{right:`${w.right}px`,bottom:"0px",cursor:"default",height:D?"48px":"500px"}:{left:`${w.x}px`,top:`${w.y}px`,cursor:v?"grabbing":"default",height:D?"48px":"500px"},children:[(0,n.jsxs)("div",{className:`flex items-center justify-between ${D?"px-3 py-2":"p-4"} border-b border-gray-700 bg-gray-900 rounded-t-lg ${d?"cursor-default":"cursor-grab active:cursor-grabbing"}`,onMouseDown:d?void 0:e=>{if(E.current){let t=E.current.getBoundingClientRect();j({x:e.clientX-t.left,y:e.clientY-t.top}),p(!0)}},children:[D?n.jsx("div",{className:"flex items-center min-w-0 pr-2",children:n.jsx("span",{className:"text-white text-sm font-medium truncate",title:T,children:T})}):(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[n.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md",children:n.jsx("span",{className:"text-white font-bold text-xs tracking-wider",children:(t.name||t.email||"Usuario").charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{children:[n.jsx("h3",{className:"text-white font-semibold",children:t.name||t.email||"Usuario"}),n.jsx("p",{className:"text-gray-400 text-xs",children:t.role})]})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[n.jsx("button",{onClick:()=>C(e=>!e),className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Minimizar","aria-expanded":!D,children:D?n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8h12a2 2 0 0 1 2 2v8H6a2 2 0 0 1-2-2V8z"})}):n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),n.jsx("button",{onClick:a,className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar",children:n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),!D&&(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[x?n.jsx("div",{className:"flex justify-center items-center h-full",children:n.jsx("div",{className:"text-gray-400",children:"Cargando mensajes..."})}):0===u.length?n.jsx("div",{className:"flex justify-center items-center h-full",children:(0,n.jsxs)("div",{className:"text-gray-400 text-center",children:[n.jsx("p",{children:"No hay mensajes a\xfan"}),n.jsx("p",{className:"text-xs mt-1",children:"Env\xeda el primer mensaje"})]})}):u.map(e=>n.jsx("div",{className:`flex ${e.sender_id===s?"justify-end":"justify-start"}`,children:(0,n.jsxs)("div",{className:`max-w-[70%] px-3 py-2 rounded-lg ${e.sender_id===s?"bg-blue-600 text-white":"bg-gray-700 text-gray-100"}`,children:[n.jsx("p",{className:"text-sm",children:e.content}),n.jsx("p",{className:"text-xs opacity-70 mt-1",children:new Date(e.created_at).toLocaleTimeString()})]})},e.id)),n.jsx("div",{ref:N})]}),!D&&n.jsx("div",{className:"p-4 border-t border-gray-700",children:(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[n.jsx("input",{type:"text",value:g,onChange:e=>m(e.target.value),onKeyDown:e=>{console.log("⌨️ [IndividualChat] Tecla presionada:",e.key),"Enter"!==e.key||e.shiftKey||(e.preventDefault(),console.log("\uD83D\uDE80 [IndividualChat] Enter presionado, enviando mensaje..."),_())},placeholder:"Escribe tu mensaje...",className:"flex-1 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.jsx("button",{onClick:()=>{console.log("\uD83D\uDDB1️ [IndividualChat] Bot\xf3n enviar clickeado"),_()},disabled:!g.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg transition-colors","aria-label":"Enviar mensaje",children:n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]})}var l=a(43995);let c=({onClose:e,userId:t,userRole:a,session:o,windowIndex:r=0,view:s="users",setView:i,availableUsers:c=[],expandedSections:d={online:!0,offline:!1},setExpandedSections:u,openChatWithUser:h,conversations:g=[],selectedConversation:m,setSelectedConversation:x,messages:f=[],newMessage:v="",setNewMessage:p,sendMessage:D,handleKeyPress:C,showDeleteConfirm:w,setShowDeleteConfirm:y,deleteConversation:b,tempChatUser:j,getDisplayName:E=e=>e.name||e.email})=>{let N=(g||[]).filter(e=>{let t=e?.last_message?.content;return"string"==typeof t&&t.trim().length>0});return(0,n.jsxs)("div",{className:"w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] fixed",style:{right:"24px",bottom:"0px",cursor:"default",maxHeight:"calc(100vh - 20px)",height:"500px"},children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg cursor-default",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[n.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300 rounded-xl flex items-center justify-center shadow-md border border-white/20 dark:border-gray-700/30",children:n.jsx("span",{className:"text-white dark:text-gray-900 font-bold text-xs tracking-wider",children:"AIM"})}),(0,n.jsxs)("div",{children:[n.jsx("p",{className:"text-white text-sm font-semibold",children:"AIM Assistant"}),n.jsx("p",{className:"text-gray-400 text-xs",children:"Soporte y tips"})]})]}),n.jsx("button",{onClick:e,className:"text-gray-400 hover:text-white",children:n.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,n.jsxs)("div",{className:"flex border-b border-gray-700 px-2 gap-2",children:[n.jsx("button",{onClick:()=>i?.("users"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ${"users"===s?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"}`,children:"Usuarios disponibles"}),(0,n.jsxs)("button",{onClick:()=>i?.("conversations"),className:`flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ${"conversations"===s?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"}`,children:["Conversaciones (",N.length,")"]})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:["users"===s&&n.jsx(n.Fragment,{children:n.jsx("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:[(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsxs)("button",{onClick:()=>u?.({...d,online:!d.online}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,n.jsxs)("span",{className:"flex items-center",children:[n.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"En l\xednea (",c.filter(e=>e.is_online).length,")"]}),n.jsx("svg",{className:`w-4 h-4 transition-transform ${d.online?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d.online&&n.jsx("div",{className:"ml-4 space-y-1",children:c.filter(e=>e.is_online).map(e=>(0,n.jsxs)("button",{onClick:()=>h?.(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[n.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3",children:n.jsx("span",{className:"text-white text-xs font-bold",children:E(e).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{children:[n.jsx("p",{className:"text-sm font-medium",children:E(e)}),n.jsx("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]}),(0,n.jsxs)("div",{className:"space-y-1",children:[(0,n.jsxs)("button",{onClick:()=>u?.({...d,offline:!d.offline}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,n.jsxs)("span",{className:"flex items-center",children:[n.jsx("span",{className:"w-2 h-2 bg-gray-500 rounded-full mr-2"}),"Offline (",c.filter(e=>!e.is_online).length,")"]}),n.jsx("svg",{className:`w-4 h-4 transition-transform ${d.offline?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d.offline&&n.jsx("div",{className:"ml-4 space-y-1",children:c.filter(e=>!e.is_online).map(e=>(0,n.jsxs)("button",{onClick:()=>h?.(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[n.jsx("div",{className:"w-6 h-6 bg-gradient-to-br from-gray-500 to-gray-600 rounded-full flex items-center justify-center mr-3",children:n.jsx("span",{className:"text-white text-xs font-bold",children:E(e).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{children:[n.jsx("p",{className:"text-sm font-medium",children:E(e)}),n.jsx("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]})]})})}),"conversations"===s&&n.jsx(n.Fragment,{children:n.jsx("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:n.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:0===N.length?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[n.jsx("svg",{className:"w-12 h-12 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),n.jsx("p",{className:"text-sm text-center",children:"No hay conversaciones activas"}),n.jsx("p",{className:"text-xs text-center mt-1",children:"Los mensajes aparecer\xe1n aqu\xed cuando inicies una conversaci\xf3n"})]}):N.map(e=>(0,n.jsxs)("div",{className:`flex items-center w-full p-2 text-left rounded-lg transition-colors ${m===e.id?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"}`,children:[(0,n.jsxs)("button",{onClick:()=>{h?.(e.other_participant.id)},className:"flex items-center flex-1 min-w-0 text-left",children:[n.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3",children:n.jsx("span",{className:"text-white text-xs font-bold",children:E(e.other_participant).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"text-sm font-medium truncate",children:E(e.other_participant)}),n.jsx("p",{className:"text-xs text-gray-400 truncate",children:e.last_message?.content})]})]}),e.unread_count>0&&n.jsx("div",{className:"bg-red-500 text-white text-[10px] rounded-full px-2 py-1 min-w-[20px] text-center ml-2",children:e.unread_count}),n.jsx("button",{onClick:t=>{t.stopPropagation(),y?.(e.id)},className:"ml-2 p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-600/50","aria-label":"Eliminar conversaci\xf3n",title:"Eliminar conversaci\xf3n",children:n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-7 0a2 2 0 012-2h4a2 2 0 012 2m-8 0H5"})})})]},e.id))})})}),"chat"===s&&m&&(0,n.jsxs)(n.Fragment,{children:[n.jsx("div",{className:"flex-1 p-4 overflow-y-auto custom-scrollbar min-h-0",children:f.map(e=>n.jsx("div",{className:`flex mb-4 ${e.sender_id===t?"justify-end":"justify-start"}`,children:(0,n.jsxs)("div",{className:`max-w-[70%] p-3 rounded-lg ${e.sender_id===t?"bg-blue-600 text-white":"bg-gray-700 text-white"}`,children:[n.jsx("p",{className:"text-sm",children:e.content}),n.jsx("span",{className:"text-xs text-gray-300 block text-right mt-1",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id))}),n.jsx("div",{className:"p-4 border-t border-gray-700 flex-shrink-0",children:(0,n.jsxs)("div",{className:"flex space-x-2",children:[n.jsx("input",{type:"text",value:v,onChange:e=>p?.(e.target.value),onKeyPress:C,placeholder:"Escribe tu mensaje...",className:"flex-1 p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.jsx("button",{onClick:D,disabled:!v.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:n.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]}),w&&(0,n.jsxs)(l.Z,{isOpen:!0,onClose:()=>y?.(null),title:"Eliminar conversaci\xf3n",maxWidthClass:"max-w-md",children:[n.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-6",children:"\xbfEst\xe1s seguro de que quieres eliminar esta conversaci\xf3n? Esta acci\xf3n no se puede deshacer."}),(0,n.jsxs)("div",{className:"flex space-x-3",children:[n.jsx("button",{onClick:()=>y?.(null),className:"flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:"Cancelar"}),n.jsx("button",{onClick:()=>b?.(w),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Eliminar"})]})]})]})]})},d=({openChatWindows:e,onCloseWindow:t,userId:a,userRole:o,session:r,isMainChatOpen:s=!1,onCloseMainChat:l,view:d,setView:u,availableUsers:h=[],expandedSections:g={online:!0,offline:!1},setExpandedSections:m,openChatWithUser:x,conversations:f,selectedConversation:v,setSelectedConversation:p,messages:D,newMessage:C,setNewMessage:w,sendMessage:y,handleKeyPress:b,showDeleteConfirm:j,setShowDeleteConfirm:E,deleteConversation:N,tempChatUser:k,getDisplayName:W})=>0!==e.length||s?(0,n.jsxs)(n.Fragment,{children:[s&&n.jsx(c,{onClose:l,userId:a,userRole:o,session:r,windowIndex:-1,view:d,setView:u,availableUsers:h,expandedSections:g,setExpandedSections:m,openChatWithUser:x,conversations:f,selectedConversation:v,setSelectedConversation:p,messages:D,newMessage:C,setNewMessage:w,sendMessage:y,handleKeyPress:b,showDeleteConfirm:j,setShowDeleteConfirm:E,deleteConversation:N,tempChatUser:k,getDisplayName:W}),e.map((e,s)=>n.jsx(i,{conversationId:e.conversationId,otherUser:e.otherUser,onClose:()=>t(e.id),userId:a,userRole:o,session:r,windowIndex:s,isInChatBar:!0},e.id))]}):null;function u({userId:e,userRole:t}){let[a,i]=(0,o.useState)(!1),[l,c]=(0,o.useState)([]),[u,h]=(0,o.useState)([]),[g,m]=(0,o.useState)(null),[x,f]=(0,o.useState)([]),[v,p]=(0,o.useState)(""),[D,C]=(0,o.useState)(!1),[w,y]=(0,o.useState)("users"),[b,j]=(0,o.useState)(!1),[E,N]=(0,o.useState)({online:!0,offline:!1}),[k,W]=(0,o.useState)(!1),[_,S]=(0,o.useState)(!1),[A,I]=(0,o.useState)(0),[T,L]=(0,o.useState)(!1),[M,U]=(0,o.useState)(null),[O,$]=(0,o.useState)(null),z=(0,o.useRef)(null),[B,F]=(0,o.useState)(null),H=(0,o.useRef)(null),[P,R]=(0,o.useState)(!1),[J,V]=(0,o.useState)([]);(0,o.useEffect)(()=>{console.log("\uD83E\uDE9F [ChatWidget] Ventanas abiertas actualizadas:",J.length,J)},[J]);let q=e=>"modelo"===e.role?e.email.split("@")[0]:e.name;(0,o.useEffect)(()=>{(async()=>{let{data:{session:e}}=await r.O.auth.getSession();F(e)})()},[]),(0,o.useEffect)(()=>{let e;let t=()=>{R(!0),clearTimeout(e),e=setTimeout(()=>{R(!1)},150)};return window.addEventListener("scroll",t,{passive:!0}),()=>{window.removeEventListener("scroll",t),clearTimeout(e)}},[]),(0,o.useEffect)(()=>{if(!e)return;let t=async()=>{try{await (0,s.do)(e)}catch(e){console.error("❌ [ChatWidget] Error enviando heartbeat:",e)}};t(),H.current=setInterval(t,3e4);let a=async()=>{try{await (0,s.lH)(e)}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}},n=async()=>{document.hidden?(H.current&&clearInterval(H.current),H.current=setInterval(t,6e4)):(H.current&&clearInterval(H.current),H.current=setInterval(t,3e4),t())};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",n),()=>{H.current&&clearInterval(H.current),window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",n),(0,s.lH)(e).catch(e=>{console.error("❌ [ChatWidget] Error marcando usuario offline en cleanup:",e)})}},[e]),(0,o.useEffect)(()=>{let t=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n restaurada"),e)try{await en(!0),console.log("\uD83D\uDFE2 [ChatWidget] Usuario marcado como online tras restaurar conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario online:",e)}},a=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n perdida"),e)try{await en(!1),console.log("\uD83D\uDD34 [ChatWidget] Usuario marcado como offline por p\xe9rdida de conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}};return window.addEventListener("online",t),window.addEventListener("offline",a),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",a)}},[e]);let Z=async()=>{if(B)try{let t=await fetch("/api/chat/conversations",{headers:{Authorization:`Bearer ${B.access_token}`}}),n=await t.json();if(n.success){c(n.conversations);let t=n.conversations.reduce((t,a)=>a.last_message&&a.last_message.sender_id!==e?t+1:t,0);console.log("\uD83D\uDCCA [ChatWidget] Mensajes no le\xeddos detectados:",{unread:t,lastUnreadCount:A,hasNewMessage:t>A}),!(t>0)||a||T||(console.log("\uD83D\uDD14 [ChatWidget] \xa1NUEVO MENSAJE DETECTADO! Activando notificaci\xf3n..."),L(!0),er()),t>A&&A>=0&&!T&&(console.log("\uD83D\uDD14 [ChatWidget] \xa1INCREMENTO DE MENSAJES DETECTADO!",{unread:t,lastUnreadCount:A,isOpen:a,notificationTriggered:T}),a?console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - No activando notificaci\xf3n"):(console.log("\uD83D\uDD14 [ChatWidget] Chat cerrado - Activando notificaci\xf3n autom\xe1tica..."),L(!0),er())),a&&T&&(console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando notificaciones..."),L(!1),W(!1),S(!1)),I(t)}}catch(e){console.error("Error cargando conversaciones:",e)}},G=async()=>{if(B)try{let e=await fetch("/api/chat/users",{headers:{Authorization:`Bearer ${B.access_token}`}}),t=await e.json();t.success&&h(t.users)}catch(e){console.error("Error cargando usuarios:",e)}},K=async t=>{if(B)try{let a=await fetch(`/api/chat/messages?conversation_id=${t}`,{headers:{Authorization:`Bearer ${B.access_token}`}}),n=await a.json();if(n.success)f(t=>{let a=n.messages;if(t.length!==a.length||t.some((e,t)=>!a[t]||e.id!==a[t].id)){if(console.log("\uD83D\uDCE8 [ChatWidget] Mensajes actualizados:",{previous:t.length,new:a.length}),a.length>t.length){let t=a[a.length-1];t&&t.sender_id!==e&&(console.log("\uD83D\uDD14 [ChatWidget] Nuevo mensaje detectado via polling, activando notificaci\xf3n..."),er())}return a}return t}),m(t);else{if(console.error("❌ [ChatWidget] Error en respuesta de mensajes:",n),n.error&&(n.error.includes("no encontrada")||n.error.includes("no existe"))){console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante carga de mensajes, preparando nueva conversaci\xf3n..."),await Y(t);return}await X(t)}}catch(e){console.error("❌ [ChatWidget] Error cargando mensajes:",e),await X(t)}},Y=async t=>{if(B){console.log("\uD83D\uDD04 [ChatWidget] Manejando conversaci\xf3n eliminada:",t);try{if(await Z(),t.startsWith("temp_"))console.log("\uD83E\uDDF9 [ChatWidget] Limpiando conversaci\xf3n temporal eliminada"),f([]),U(null),y("users");else{console.log("\uD83D\uDCA1 [ChatWidget] Conversaci\xf3n eliminada, preparando nueva conversaci\xf3n autom\xe1ticamente");let a=x[x.length-1];if(a&&a.sender_id!==e){let e=a.sender_id,t=u.find(t=>t.id===e);if(t){console.log("\uD83C\uDFAF [ChatWidget] Usuario identificado para nueva conversaci\xf3n:",t.name||t.email),U(t),m(`temp_${e}`),f([]);let a={id:`info_${Date.now()}`,content:`💬 Conversaci\xf3n reiniciada con ${q(t)}. Puedes continuar chateando.`,sender_id:"system",conversation_id:`temp_${e}`,created_at:new Date().toISOString(),is_system_message:!0};f([a]);return}}console.log("⚠️ [ChatWidget] No se pudo identificar al usuario, mostrando mensaje gen\xe9rico"),f([]),U(null);let n={id:`info_${Date.now()}`,content:"\uD83D\uDCAC Esta conversaci\xf3n fue eliminada. Selecciona un usuario para iniciar una nueva conversaci\xf3n.",sender_id:"system",conversation_id:t,created_at:new Date().toISOString(),is_system_message:!0};f([n]),y("users")}}catch(e){console.error("❌ [ChatWidget] Error manejando conversaci\xf3n eliminada:",e),f([]),U(null),y("users")}}},X=async e=>{if(B)try{console.log("\uD83D\uDD0D [ChatWidget] Ejecutando diagn\xf3stico de polling...");let t=await fetch(`/api/chat/debug-polling?conversation_id=${e}`,{headers:{Authorization:`Bearer ${B.access_token}`}}),a=await t.json();a.success?console.log("✅ [ChatWidget] Diagn\xf3stico exitoso:",a.debug):console.error("❌ [ChatWidget] Diagn\xf3stico fall\xf3:",a)}catch(e){console.error("❌ [ChatWidget] Error en diagn\xf3stico:",e)}},Q=async()=>{if(v.trim()&&g&&B){console.log("\uD83D\uDCE4 [ChatWidget] Enviando mensaje:",{content:v.trim(),conversationId:g,userId:e}),C(!0);try{let e=g;if(g.startsWith("temp_")){console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n temporal...");let t=g.replace("temp_",""),a=await et(t);if(a)e=a,m(a),U(null),console.log("✅ [ChatWidget] Conversaci\xf3n creada:",a);else{console.error("❌ [ChatWidget] Error creando conversaci\xf3n");return}}let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B.access_token}`},body:JSON.stringify({conversation_id:e,content:v.trim()})}),a=await t.json();console.log("\uD83D\uDCE8 [ChatWidget] Respuesta del servidor:",a),a.success?(console.log("✅ [ChatWidget] Mensaje enviado exitosamente"),p(""),setTimeout(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Recargando mensajes como fallback..."),await K(e)},1e3),await Z()):(console.error("❌ [ChatWidget] Error en respuesta del servidor:",a),a.error&&(a.error.includes("no encontrada")||a.error.includes("no existe"))&&(console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante env\xedo, preparando nueva conversaci\xf3n..."),await Y(e)))}catch(e){console.error("❌ [ChatWidget] Error enviando mensaje:",e)}finally{C(!1)}}},ee=async e=>{if(console.log("\uD83D\uDDB1️ [ChatWidget] Click detectado en usuario:",e),console.log("\uD83D\uDDB1️ [ChatWidget] Sesi\xf3n disponible:",!!B),console.log("\uD83D\uDDB1️ [ChatWidget] Usuarios disponibles:",u.length),!B){console.log("❌ [ChatWidget] No hay sesi\xf3n disponible");return}console.log("\uD83D\uDCAC [ChatWidget] Abriendo chat con usuario:",e);let t=l.find(t=>t.other_participant.id===e),a=u.find(t=>t.id===e);if(console.log("\uD83D\uDC64 [ChatWidget] Usuario encontrado:",a),!a){console.log("❌ [ChatWidget] Usuario no encontrado en availableUsers");return}if(J.find(t=>t.otherUser.id===e)){console.log("\uD83E\uDE9F [ChatWidget] Ventana ya abierta para este usuario");return}if(t){console.log("\uD83D\uDCC2 [ChatWidget] Abriendo conversaci\xf3n existente en ventana individual:",t.id);let e={id:`window_${t.id}`,conversationId:t.id,otherUser:a};V(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando ventana:",e),[...t,e]))}else{console.log("\uD83C\uDD95 [ChatWidget] Creando nueva conversaci\xf3n en ventana individual con:",a.name||a.email);try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B.access_token}`},body:JSON.stringify({participant_2_id:e})}),n=await t.json();if(console.log("\uD83D\uDCE1 [ChatWidget] Respuesta API crear conversaci\xf3n:",n),n.success){let e={id:`window_${n.conversation.id}`,conversationId:n.conversation.id,otherUser:a};V(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando nueva ventana:",e),[...t,e])),await Z()}else console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",n.error)}catch(e){console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",e)}}},et=async e=>{if(B){try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B.access_token}`},body:JSON.stringify({participant_2_id:e})}),a=await t.json();if(a.success)return a.conversation.id}catch(e){console.error("Error creando conversaci\xf3n:",e)}return null}},ea=async e=>{if(B)try{let t=await fetch(`/api/chat/conversations?conversation_id=${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${B.access_token}`}}),a=await t.json();a.success?(console.log("\uD83D\uDDD1️ [ChatWidget] Conversaci\xf3n eliminada exitosamente"),await Z(),g===e&&(m(null),f([]),U(null),console.log("\uD83E\uDDF9 [ChatWidget] Estado de chat limpiado despu\xe9s de eliminaci\xf3n")),$(null)):console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",a.error)}catch(e){console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",e)}},en=async e=>{if(B)try{await fetch("/api/chat/users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B.access_token}`},body:JSON.stringify({is_online:e})})}catch(e){console.error("Error actualizando estado:",e)}},eo=()=>{try{console.log("\uD83C\uDFB5 [ChatWidget] Iniciando reproducci\xf3n de sonido...");let e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),a=e.createGain();t.connect(a),a.connect(e.destination),t.type="sine";let n=[400,600,800,1e3,1200,1e3,800,600,400,600,800,1e3,1200];console.log("\uD83C\uDFBC [ChatWidget] Configurando frecuencias:",n),n.forEach((a,o)=>{let r=e.currentTime+o/n.length*.5;t.frequency.setValueAtTime(a,r)}),a.gain.setValueAtTime(0,e.currentTime),a.gain.linearRampToValueAtTime(.4,e.currentTime+.02),a.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5),console.log("✅ [ChatWidget] Sonido de notificaci\xf3n reproducido exitosamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido de notificaci\xf3n:",e)}},er=()=>{if(console.log("\uD83D\uDD0D [ChatWidget] triggerNotification llamada - isOpen:",a),a){console.log("\uD83D\uDCC2 [ChatWidget] Chat abierto - NO activando notificaciones");return}console.log("\uD83D\uDD14 [ChatWidget] TRIGGER NOTIFICATION - Activando notificaciones (chat cerrado)..."),console.log("\uD83D\uDD0A [ChatWidget] Reproduciendo sonido de notificaci\xf3n...");try{eo(),console.log("✅ [ChatWidget] Sonido iniciado correctamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido:",e)}console.log("\uD83D\uDCAB [ChatWidget] Activando parpadeo del bot\xf3n..."),W(!0),S(!0),console.log("\uD83D\uDCC2 [ChatWidget] Abriendo chat autom\xe1ticamente..."),i(!0),setTimeout(()=>{console.log("⏹️ [ChatWidget] Deteniendo latido de coraz\xf3n..."),W(!1)},6e3)};return(0,o.useEffect)(()=>{B&&(Z(),G(),en(!0))},[B]),(0,o.useEffect)(()=>{if(!B)return;let e=setInterval(()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling de respaldo: actualizando lista de usuarios..."),G()},3e4);return()=>{clearInterval(e)}},[B]),(0,o.useEffect)(()=>{if(!B||!g)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de mensajes como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando mensajes nuevos..."),await K(g)},3e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de mensajes..."),clearInterval(e)}},[B,g]),(0,o.useEffect)(()=>{if(!B)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de conversaciones como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando conversaciones actualizadas..."),await Z()},5e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de conversaciones..."),clearInterval(e)}},[B]),(0,o.useEffect)(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[x]),(0,o.useEffect)(()=>{if(!B||!e)return;console.log("\uD83D\uDD14 [ChatWidget] Configurando suscripci\xf3n en tiempo real...");let t=r.O.channel("chat-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},async t=>{let a=t.new;console.log("\uD83D\uDCE8 [ChatWidget] Nuevo mensaje recibido:",a);try{let{data:t,error:n}=await r.O.from("chat_conversations").select("participant_1_id, participant_2_id").eq("id",a.conversation_id).single();if(n||!t){console.log("❌ [ChatWidget] Error verificando conversaci\xf3n:",n);return}t.participant_1_id===e||t.participant_2_id===e?(console.log("✅ [ChatWidget] Usuario es participante de la conversaci\xf3n"),g===a.conversation_id&&(console.log("\uD83D\uDCAC [ChatWidget] Agregando mensaje a conversaci\xf3n activa"),f(e=>e.some(e=>e.id===a.id)?(console.log("⚠️ [ChatWidget] Mensaje ya existe en la lista, no agregando"),e):(console.log("➕ [ChatWidget] Agregando nuevo mensaje a la lista"),[...e,a]))),console.log("\uD83D\uDD04 [ChatWidget] Actualizando lista de conversaciones..."),Z(),a.sender_id!==e?(console.log("\uD83D\uDD14 [ChatWidget] Activando notificaci\xf3n para mensaje de otro usuario"),er()):console.log("\uD83D\uDC64 [ChatWidget] Mensaje del usuario actual, no notificando")):console.log("❌ [ChatWidget] Usuario no es participante de la conversaci\xf3n")}catch(e){console.error("❌ [ChatWidget] Error en verificaci\xf3n de conversaci\xf3n:",e)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_conversations"},e=>{let t=e.new;console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n actualizada:",t),l.some(e=>e.id===t.id)&&(console.log("✅ [ChatWidget] Conversaci\xf3n relevante actualizada, recargando lista..."),Z())}).subscribe(e=>{console.log("\uD83D\uDCE1 [ChatWidget] Estado de suscripci\xf3n:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n en tiempo real"),r.O.removeChannel(t)}},[B,e]),(0,o.useEffect)(()=>{if(!B)return;console.log("\uD83D\uDC65 [ChatWidget] Configurando suscripci\xf3n para estados de usuarios...");let e=r.O.channel("chat-user-status-realtime").on("postgres_changes",{event:"*",schema:"public",table:"chat_user_status"},async e=>{console.log("\uD83D\uDC65 [ChatWidget] Estado de usuario actualizado:",e),await G()}).subscribe(e=>{console.log("\uD83D\uDC65 [ChatWidget] Estado de suscripci\xf3n de usuarios:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n de estados de usuarios"),r.O.removeChannel(e)}},[B]),(0,o.useEffect)(()=>{},[l,g]),(0,n.jsxs)(n.Fragment,{children:[n.jsx("button",{onClick:()=>{let e=!a;i(e),e&&B&&Z(),e?(S(!1),W(!1),L(!1),console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando todas las notificaciones")):U(null)},onContextMenu:e=>{e.preventDefault(),console.log("\uD83E\uDDEA [ChatWidget] Prueba manual de notificaci\xf3n"),er()},className:`fixed bottom-6 right-6 w-10 h-10 bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300 hover:w-16 hover:h-10 text-white dark:text-gray-900 rounded-xl shadow-lg border border-white/20 dark:border-gray-700/30 transition-all duration-300 flex items-center justify-center z-[9995] group overflow-hidden ${k?"animate-heartbeat bg-gradient-to-r from-red-500 via-pink-500 to-red-600 text-white":""}`,"aria-label":"Abrir chat de soporte (clic derecho para probar notificaci\xf3n)",children:(0,n.jsxs)("div",{className:"flex items-center justify-center",children:[n.jsx("span",{className:"text-white dark:text-gray-900 font-bold text-sm group-hover:hidden drop-shadow-sm",children:"A"}),n.jsx("span",{className:"text-white dark:text-gray-900 font-bold text-xs hidden group-hover:block whitespace-nowrap drop-shadow-sm",children:"AIM"})]})}),n.jsx(d,{openChatWindows:J,onCloseWindow:e=>{V(t=>t.filter(t=>t.id!==e))},userId:e,userRole:t,session:B,isMainChatOpen:a,onCloseMainChat:()=>i(!1),view:w,setView:y,availableUsers:u,expandedSections:E,setExpandedSections:N,openChatWithUser:ee,conversations:l,selectedConversation:g,setSelectedConversation:m,messages:x,newMessage:v,setNewMessage:p,sendMessage:Q,handleKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Q())},showDeleteConfirm:O,setShowDeleteConfirm:$,deleteConversation:ea,tempChatUser:M,getDisplayName:q})]})}},43995:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var n=a(95344),o=a(3729);function r({isOpen:e,onClose:t,children:a,title:r,maxWidthClass:s="max-w-lg",paddingClass:i="p-7",headerMarginClass:l="mb-5",formSpaceYClass:c="space-y-5",className:d="",showCloseButton:u=!0,closeOnBackdrop:h=!0}){let[g,m]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{if(!e)return;let t=requestAnimationFrame(()=>m(!0));return()=>{cancelAnimationFrame(t),m(!1)}},[e]),(0,o.useEffect)(()=>{if(!e)return;let a=e=>{"Escape"===e.key&&t()};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[e,t]),e)?n.jsx("div",{className:`fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-200 ${g?"opacity-100":"opacity-0"}`,onClick:()=>{h&&t()},"aria-modal":"true",role:"dialog",children:(0,n.jsxs)("div",{className:`bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-2xl shadow-xl ${i} w-full ${s} max-h-[90vh] overflow-y-auto transform transition-all duration-200 ease-out ${g?"opacity-100 scale-100":"opacity-0 scale-95"} ${d}`,onClick:e=>e.stopPropagation(),children:[(r||u)&&(0,n.jsxs)("div",{className:`flex items-center justify-between ${l}`,children:[r?n.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:r}):n.jsx("div",{}),u&&n.jsx("button",{onClick:t,className:"text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300","aria-label":"Cerrar",children:n.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),n.jsx("div",{className:c,children:a})]})}):null}},67766:(e,t,a)=>{"use strict";a.d(t,{E4:()=>r,P1:()=>s});var n=a(72829),o=a(86071);async function r(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:t,error:a}=await n.O.auth.signInWithPassword({email:e.email,password:e.password});if(a)return console.error("❌ [AUTH] Error de autenticaci\xf3n:",a.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!t.user)return{success:!1,error:"Usuario no encontrado"};console.log("✅ [AUTH] Usuario autenticado en Supabase:",t.user.id);let{data:r,error:s}=await n.O.from("users").select(`
        id,
        name,
        email,
        role,
        is_active,
        last_login,
        organization_id,
        user_groups!inner(
          group_id,
          is_manager,
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",t.user.id).single();if(s)return console.error("❌ [AUTH] Error obteniendo perfil:",s.message),{success:!1,error:"Error obteniendo perfil de usuario"};if(!r)return{success:!1,error:"Perfil de usuario no encontrado"};if(!r.is_active)return{success:!1,error:"Usuario inactivo"};await n.O.from("users").update({last_login:new Date().toISOString()}).eq("id",t.user.id);let i={id:r.id,email:t.user.email,name:r.name,role:r.role,organization_id:r.organization_id,groups:r.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:r.is_active,last_login:r.last_login};console.log("✅ [AUTH] Login exitoso:",{id:i.id,email:i.email,role:i.role,groups:i.groups.length});try{await (0,o.MY)(i.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:i}}catch(e){return console.error("❌ [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function s(){try{let{data:{user:e}}=await n.O.auth.getUser(),{error:t}=await n.O.auth.signOut();if(t&&console.error("❌ [AUTH] Error en logout:",t.message),e)try{await (0,o.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("❌ [AUTH] Error general en logout:",e)}}},86071:(e,t,a)=>{"use strict";a.d(t,{MY:()=>r,do:()=>i,lH:()=>s});var n=a(72829);async function o(e,t){try{console.log(`📊 [CHAT-STATUS] Actualizando estado de usuario ${e}: ${t?"EN L\xcdNEA":"OFFLINE"}`);let{error:a}=await n.O.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});a?console.error("❌ [CHAT-STATUS] Error actualizando estado:",a):console.log(`✅ [CHAT-STATUS] Estado actualizado exitosamente: ${t?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("❌ [CHAT-STATUS] Error general:",e)}}async function r(e){await o(e,!0)}async function s(e){await o(e,!1)}async function i(e){try{let{error:t}=await n.O.from("chat_user_status").upsert({user_id:e,is_online:!0,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});t&&console.error("❌ [CHAT-STATUS] Error actualizando heartbeat:",t)}catch(e){console.error("❌ [CHAT-STATUS] Error en heartbeat:",e)}}},72829:(e,t,a)=>{"use strict";a.d(t,{O:()=>n});let n=(0,a(36654).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c")},41878:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c,metadata:()=>l});var n=a(25036);a(67272);let o=(0,a(86843).createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\components\ThemeTransition.tsx`),{__esModule:r,$$typeof:s}=o,i=o.default,l={title:"AIM Sistema de Gesti\xf3n",description:"Sistema de gesti\xf3n de usuarios con roles y grupos - Dise\xf1o Apple.com",icons:{icon:[{url:"/favicon.svg",type:"image/svg+xml"},{url:"/favicon.ico",type:"image/x-icon"}]}};function c({children:e}){return n.jsx("html",{lang:"es",children:n.jsx("body",{className:"min-h-screen bg-white text-gray-900 antialiased",children:n.jsx(i,{children:e})})})}},67272:()=>{}};