exports.id=9609,exports.ids=[9609],exports.modules={41692:(e,t,a)=>{Promise.resolve().then(a.bind(a,37761))},14443:(e,t,a)=>{Promise.resolve().then(a.t.bind(a,2583,23)),Promise.resolve().then(a.t.bind(a,26840,23)),Promise.resolve().then(a.t.bind(a,38771,23)),Promise.resolve().then(a.t.bind(a,13225,23)),Promise.resolve().then(a.t.bind(a,9295,23)),Promise.resolve().then(a.t.bind(a,43982,23))},94444:(e,t,a)=>{"use strict";a.d(t,{Z:()=>n});var o=a(95344),s=a(3729);let n=()=>{let[e,t]=(0,s.useState)("light"),[a,n]=(0,s.useState)(!1);return((0,s.useEffect)(()=>{n(!0);let e=localStorage.getItem("theme");if(e)t(e),document.documentElement.classList.toggle("dark","dark"===e);else{let e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";t(e),document.documentElement.classList.toggle("dark","dark"===e)}},[]),a)?o.jsx("button",{"data-theme-toggle":!0,onClick:()=>{let a="light"===e?"dark":"light";document.documentElement.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",t(a),localStorage.setItem("theme",a),document.documentElement.classList.toggle("dark","dark"===a);let o=document.querySelector("[data-theme-toggle]");o&&(o.style.transform="scale(0.95)",setTimeout(()=>{o.style.transform="scale(1)"},150)),setTimeout(()=>{document.documentElement.style.transition="",document.body.style.transition=""},600)},className:"p-2.5 text-gray-600 hover:text-gray-900 hover:bg-white/60 rounded-lg transition-all duration-200 hover:shadow-sm   dark:text-gray-300 dark:hover:text-white dark:hover:bg-gray-700",title:"light"===e?"Cambiar a modo oscuro":"Cambiar a modo claro",children:"light"===e?o.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"})}):o.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h1M3 12H2m15.325 6.675l-.707.707M6.707 6.707l-.707-.707m10.626 0l.707-.707M6.707 17.293l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z"})})}):o.jsx("div",{className:"p-2.5 text-gray-600 rounded-lg",children:o.jsx("div",{className:"w-5 h-5"})})}},37761:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>n});var o=a(95344),s=a(3729);let n=({children:e})=>{let[t,a]=(0,s.useState)(!1),[n,r]=(0,s.useState)("light");return(0,s.useEffect)(()=>{let e=new MutationObserver(e=>{e.forEach(e=>{if("attributes"===e.type&&"class"===e.attributeName){let e=document.documentElement.classList.contains("dark")?"dark":"light";e!==n&&(r(e),a(!0),setTimeout(()=>{a(!1)},600))}})});return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[n]),(0,o.jsxs)("div",{className:`relative transition-all duration-500 ease-in-out ${t?"opacity-90 scale-[0.98] blur-[1px]":"opacity-100 scale-100 blur-0"}`,children:[t&&(0,o.jsxs)("div",{className:"fixed inset-0 z-[9999] pointer-events-none",children:[o.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/10 via-purple-500/10 to-indigo-500/10 dark:from-gray-900/20 dark:via-gray-800/20 dark:to-gray-900/20 animate-pulse"}),o.jsx("div",{className:"absolute inset-0 bg-white/5 dark:bg-black/5 backdrop-blur-sm"}),o.jsx("div",{className:"absolute inset-0 bg-gradient-radial from-blue-400/20 via-transparent to-transparent animate-ping"})]}),e]})}},58946:(e,t,a)=>{"use strict";a.d(t,{Z:()=>i});var o=a(95344),s=a(3729),n=a(72829),r=a(86071);function i({userId:e,userRole:t}){let[a,i]=(0,s.useState)(!1),[l,c]=(0,s.useState)([]),[d,u]=(0,s.useState)([]),[h,m]=(0,s.useState)(null),[g,x]=(0,s.useState)([]),[v,f]=(0,s.useState)(""),[p,D]=(0,s.useState)(!1),[C,b]=(0,s.useState)(!0),[j,w]=(0,s.useState)(!1),[y,N]=(0,s.useState)({online:!0,offline:!1}),[E,_]=(0,s.useState)(!1),[W,k]=(0,s.useState)(!1),[A,S]=(0,s.useState)(0),[T,I]=(0,s.useState)(!1),[L,M]=(0,s.useState)(null),[O,z]=(0,s.useState)(null),U=(0,s.useRef)(null),[H,$]=(0,s.useState)(null),B=(0,s.useRef)(null),[F,P]=(0,s.useState)(!1),J=e=>"modelo"===e.role?e.email.split("@")[0]:e.name;(0,s.useEffect)(()=>{(async()=>{let{data:{session:e}}=await n.O.auth.getSession();$(e)})()},[]),(0,s.useEffect)(()=>{let e;let t=()=>{P(!0),clearTimeout(e),e=setTimeout(()=>{P(!1)},150)};return window.addEventListener("scroll",t,{passive:!0}),()=>{window.removeEventListener("scroll",t),clearTimeout(e)}},[]),(0,s.useEffect)(()=>{if(!e)return;let t=async()=>{try{await (0,r.do)(e)}catch(e){console.error("‚ùå [ChatWidget] Error enviando heartbeat:",e)}};t(),B.current=setInterval(t,3e4);let a=async()=>{try{await (0,r.lH)(e)}catch(e){console.error("‚ùå [ChatWidget] Error marcando usuario offline:",e)}},o=async()=>{document.hidden?(B.current&&clearInterval(B.current),B.current=setInterval(t,6e4)):(B.current&&clearInterval(B.current),B.current=setInterval(t,3e4),t())};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",o),()=>{B.current&&clearInterval(B.current),window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",o),(0,r.lH)(e).catch(e=>{console.error("‚ùå [ChatWidget] Error marcando usuario offline en cleanup:",e)})}},[e]);let V=async()=>{if(H)try{let t=await fetch("/api/chat/conversations",{headers:{Authorization:`Bearer ${H.access_token}`}}),o=await t.json();if(o.success){c(o.conversations);let t=o.conversations.reduce((t,a)=>a.last_message&&a.last_message.sender_id!==e?t+1:t,0);console.log("\uD83D\uDCCA [ChatWidget] Mensajes no le\xeddos detectados:",{unread:t,lastUnreadCount:A,hasNewMessage:t>A}),!(t>0)||a||T||(console.log("\uD83D\uDD14 [ChatWidget] \xa1NUEVO MENSAJE DETECTADO! Activando notificaci\xf3n..."),I(!0),ea()),t>A&&A>=0&&!T&&(console.log("\uD83D\uDD14 [ChatWidget] \xa1INCREMENTO DE MENSAJES DETECTADO!",{unread:t,lastUnreadCount:A,isOpen:a,notificationTriggered:T}),a?console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - No activando notificaci\xf3n"):(console.log("\uD83D\uDD14 [ChatWidget] Chat cerrado - Activando notificaci\xf3n autom\xe1tica..."),I(!0),ea())),a&&T&&(console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando notificaciones..."),I(!1),_(!1),k(!1)),S(t)}}catch(e){console.error("Error cargando conversaciones:",e)}},R=async()=>{if(H)try{let e=await fetch("/api/chat/users",{headers:{Authorization:`Bearer ${H.access_token}`}}),t=await e.json();t.success&&u(t.users)}catch(e){console.error("Error cargando usuarios:",e)}},q=async t=>{if(H)try{let a=await fetch(`/api/chat/messages?conversation_id=${t}`,{headers:{Authorization:`Bearer ${H.access_token}`}}),o=await a.json();if(o.success)x(t=>{let a=o.messages;if(t.length!==a.length||t.some((e,t)=>!a[t]||e.id!==a[t].id)){if(console.log("\uD83D\uDCE8 [ChatWidget] Mensajes actualizados:",{previous:t.length,new:a.length}),a.length>t.length){let t=a[a.length-1];t&&t.sender_id!==e&&(console.log("\uD83D\uDD14 [ChatWidget] Nuevo mensaje detectado via polling, activando notificaci\xf3n..."),ea())}return a}return t}),m(t);else{if(console.error("‚ùå [ChatWidget] Error en respuesta de mensajes:",o),o.error&&(o.error.includes("no encontrada")||o.error.includes("no existe"))){console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante carga de mensajes, preparando nueva conversaci\xf3n..."),await Z(t);return}await G(t)}}catch(e){console.error("‚ùå [ChatWidget] Error cargando mensajes:",e),await G(t)}},Z=async t=>{if(H){console.log("\uD83D\uDD04 [ChatWidget] Manejando conversaci\xf3n eliminada:",t);try{if(await V(),t.startsWith("temp_"))console.log("\uD83E\uDDF9 [ChatWidget] Limpiando conversaci\xf3n temporal eliminada"),x([]),M(null),b(!0);else{console.log("\uD83D\uDCA1 [ChatWidget] Conversaci\xf3n eliminada, preparando nueva conversaci\xf3n autom\xe1ticamente");let a=g[g.length-1];if(a&&a.sender_id!==e){let e=a.sender_id,t=d.find(t=>t.id===e);if(t){console.log("\uD83C\uDFAF [ChatWidget] Usuario identificado para nueva conversaci\xf3n:",t.name||t.email),M(t),m(`temp_${e}`),x([]);let a={id:`info_${Date.now()}`,content:`üí¨ Conversaci\xf3n reiniciada con ${J(t)}. Puedes continuar chateando.`,sender_id:"system",conversation_id:`temp_${e}`,created_at:new Date().toISOString(),is_system_message:!0};x([a]);return}}console.log("‚ö†Ô∏è [ChatWidget] No se pudo identificar al usuario, mostrando mensaje gen\xe9rico"),x([]),M(null);let o={id:`info_${Date.now()}`,content:"\uD83D\uDCAC Esta conversaci\xf3n fue eliminada. Selecciona un usuario para iniciar una nueva conversaci\xf3n.",sender_id:"system",conversation_id:t,created_at:new Date().toISOString(),is_system_message:!0};x([o]),b(!0)}}catch(e){console.error("‚ùå [ChatWidget] Error manejando conversaci\xf3n eliminada:",e),x([]),M(null),b(!0)}}},G=async e=>{if(H)try{console.log("\uD83D\uDD0D [ChatWidget] Ejecutando diagn\xf3stico de polling...");let t=await fetch(`/api/chat/debug-polling?conversation_id=${e}`,{headers:{Authorization:`Bearer ${H.access_token}`}}),a=await t.json();a.success?console.log("‚úÖ [ChatWidget] Diagn\xf3stico exitoso:",a.debug):console.error("‚ùå [ChatWidget] Diagn\xf3stico fall\xf3:",a)}catch(e){console.error("‚ùå [ChatWidget] Error en diagn\xf3stico:",e)}},Y=async()=>{if(v.trim()&&h&&H){console.log("\uD83D\uDCE4 [ChatWidget] Enviando mensaje:",{content:v.trim(),conversationId:h,userId:e}),D(!0);try{let e=h;if(h.startsWith("temp_")){console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n temporal...");let t=h.replace("temp_",""),a=await K(t);if(a)e=a,m(a),M(null),console.log("‚úÖ [ChatWidget] Conversaci\xf3n creada:",a);else{console.error("‚ùå [ChatWidget] Error creando conversaci\xf3n");return}}let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H.access_token}`},body:JSON.stringify({conversation_id:e,content:v.trim()})}),a=await t.json();console.log("\uD83D\uDCE8 [ChatWidget] Respuesta del servidor:",a),a.success?(console.log("‚úÖ [ChatWidget] Mensaje enviado exitosamente"),f(""),setTimeout(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Recargando mensajes como fallback..."),await q(e)},1e3),await V()):(console.error("‚ùå [ChatWidget] Error en respuesta del servidor:",a),a.error&&(a.error.includes("no encontrada")||a.error.includes("no existe"))&&(console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante env\xedo, preparando nueva conversaci\xf3n..."),await Z(e)))}catch(e){console.error("‚ùå [ChatWidget] Error enviando mensaje:",e)}finally{D(!1)}}},X=async e=>{if(!H)return;console.log("\uD83D\uDCAC [ChatWidget] Abriendo chat con usuario:",e);let t=l.find(t=>t.other_participant.id===e);if(t)console.log("\uD83D\uDCC2 [ChatWidget] Conversaci\xf3n existente encontrada:",t.id),b(!1),m(t.id),M(null),await q(t.id);else{let t=d.find(t=>t.id===e);console.log("\uD83C\uDD95 [ChatWidget] Iniciando nueva conversaci\xf3n con:",t?.name||t?.email),b(!1),m(`temp_${e}`),M(t||null),x([])}},K=async e=>{if(H){try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H.access_token}`},body:JSON.stringify({participant_2_id:e})}),a=await t.json();if(a.success)return a.conversation.id}catch(e){console.error("Error creando conversaci\xf3n:",e)}return null}},Q=async e=>{if(H)try{let t=await fetch(`/api/chat/conversations?conversation_id=${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${H.access_token}`}}),a=await t.json();a.success?(console.log("\uD83D\uDDD1Ô∏è [ChatWidget] Conversaci\xf3n eliminada exitosamente"),await V(),h===e&&(m(null),x([]),M(null),console.log("\uD83E\uDDF9 [ChatWidget] Estado de chat limpiado despu\xe9s de eliminaci\xf3n")),z(null)):console.error("‚ùå [ChatWidget] Error eliminando conversaci\xf3n:",a.error)}catch(e){console.error("‚ùå [ChatWidget] Error eliminando conversaci\xf3n:",e)}},ee=e=>{N(t=>({...t,[e]:!t[e]}))},et=()=>{try{console.log("\uD83C\uDFB5 [ChatWidget] Iniciando reproducci\xf3n de sonido...");let e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),a=e.createGain();t.connect(a),a.connect(e.destination),t.type="sine";let o=[400,600,800,1e3,1200,1e3,800,600,400,600,800,1e3,1200];console.log("\uD83C\uDFBC [ChatWidget] Configurando frecuencias:",o),o.forEach((a,s)=>{let n=e.currentTime+s/o.length*.5;t.frequency.setValueAtTime(a,n)}),a.gain.setValueAtTime(0,e.currentTime),a.gain.linearRampToValueAtTime(.4,e.currentTime+.02),a.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5),console.log("‚úÖ [ChatWidget] Sonido de notificaci\xf3n reproducido exitosamente")}catch(e){console.error("‚ùå [ChatWidget] Error reproduciendo sonido de notificaci\xf3n:",e)}},ea=()=>{if(console.log("\uD83D\uDD0D [ChatWidget] triggerNotification llamada - isOpen:",a),a){console.log("\uD83D\uDCC2 [ChatWidget] Chat abierto - NO activando notificaciones");return}console.log("\uD83D\uDD14 [ChatWidget] TRIGGER NOTIFICATION - Activando notificaciones (chat cerrado)..."),console.log("\uD83D\uDD0A [ChatWidget] Reproduciendo sonido de notificaci\xf3n...");try{et(),console.log("‚úÖ [ChatWidget] Sonido iniciado correctamente")}catch(e){console.error("‚ùå [ChatWidget] Error reproduciendo sonido:",e)}console.log("\uD83D\uDCAB [ChatWidget] Activando parpadeo del bot\xf3n..."),_(!0),k(!0),console.log("\uD83D\uDCC2 [ChatWidget] Abriendo chat autom\xe1ticamente..."),i(!0),setTimeout(()=>{console.log("‚èπÔ∏è [ChatWidget] Deteniendo latido de coraz\xf3n..."),_(!1)},6e3)};(0,s.useEffect)(()=>{H&&(V(),R())},[H]),(0,s.useEffect)(()=>{if(!H)return;let e=setInterval(()=>{R()},1e4);return()=>{clearInterval(e)}},[H]),(0,s.useEffect)(()=>{if(!H||!h)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de mensajes como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando mensajes nuevos..."),await q(h)},3e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de mensajes..."),clearInterval(e)}},[H,h]),(0,s.useEffect)(()=>{if(!H)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de conversaciones como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando conversaciones actualizadas..."),await V()},5e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de conversaciones..."),clearInterval(e)}},[H]),(0,s.useEffect)(()=>{U.current?.scrollIntoView({behavior:"smooth"})},[g]),(0,s.useEffect)(()=>{if(!H||!e)return;console.log("\uD83D\uDD14 [ChatWidget] Configurando suscripci\xf3n en tiempo real...");let t=n.O.channel("chat-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},async t=>{let a=t.new;console.log("\uD83D\uDCE8 [ChatWidget] Nuevo mensaje recibido:",a);try{let{data:t,error:o}=await n.O.from("chat_conversations").select("participant_1_id, participant_2_id").eq("id",a.conversation_id).single();if(o||!t){console.log("‚ùå [ChatWidget] Error verificando conversaci\xf3n:",o);return}t.participant_1_id===e||t.participant_2_id===e?(console.log("‚úÖ [ChatWidget] Usuario es participante de la conversaci\xf3n"),h===a.conversation_id&&(console.log("\uD83D\uDCAC [ChatWidget] Agregando mensaje a conversaci\xf3n activa"),x(e=>e.some(e=>e.id===a.id)?(console.log("‚ö†Ô∏è [ChatWidget] Mensaje ya existe en la lista, no agregando"),e):(console.log("‚ûï [ChatWidget] Agregando nuevo mensaje a la lista"),[...e,a]))),console.log("\uD83D\uDD04 [ChatWidget] Actualizando lista de conversaciones..."),V(),a.sender_id!==e?(console.log("\uD83D\uDD14 [ChatWidget] Activando notificaci\xf3n para mensaje de otro usuario"),ea()):console.log("\uD83D\uDC64 [ChatWidget] Mensaje del usuario actual, no notificando")):console.log("‚ùå [ChatWidget] Usuario no es participante de la conversaci\xf3n")}catch(e){console.error("‚ùå [ChatWidget] Error en verificaci\xf3n de conversaci\xf3n:",e)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_conversations"},e=>{let t=e.new;console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n actualizada:",t),l.some(e=>e.id===t.id)&&(console.log("‚úÖ [ChatWidget] Conversaci\xf3n relevante actualizada, recargando lista..."),V())}).subscribe(e=>{console.log("\uD83D\uDCE1 [ChatWidget] Estado de suscripci\xf3n:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n en tiempo real"),n.O.removeChannel(t)}},[H,e]),(0,s.useEffect)(()=>{},[l,h]);let eo=()=>{let e=!a;i(e),e&&H&&V(),e?(k(!1),_(!1),I(!1),console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando todas las notificaciones")):M(null)};return(0,o.jsxs)(o.Fragment,{children:[o.jsx("button",{onClick:eo,onContextMenu:e=>{e.preventDefault(),console.log("\uD83E\uDDEA [ChatWidget] Prueba manual de notificaci\xf3n"),ea()},className:`fixed bottom-6 right-6 w-10 h-10 bg-gray-900 hover:w-16 hover:h-10 text-white rounded-2xl shadow-lg transition-all duration-300 flex items-center justify-center z-[9995] group overflow-hidden ${E?"animate-heartbeat bg-gradient-to-r from-red-500 via-pink-500 to-red-600":""}`,"aria-label":"Abrir chat de soporte (clic derecho para probar notificaci\xf3n)",children:(0,o.jsxs)("div",{className:"flex items-center justify-center",children:[o.jsx("span",{className:"text-white font-bold text-sm group-hover:hidden",children:"A"}),o.jsx("span",{className:"text-white font-bold text-xs hidden group-hover:block whitespace-nowrap",children:"AIM"})]})}),a&&(0,o.jsxs)("div",{className:"fixed bottom-6 right-24 w-80 h-[500px] bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9995]",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg",children:[(0,o.jsxs)("div",{className:"flex items-center space-x-3",children:[o.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:o.jsx("span",{className:"text-white font-bold text-sm",children:L?J(L).charAt(0).toUpperCase():"AIM"})}),(0,o.jsxs)("div",{children:[o.jsx("h3",{className:"text-white font-semibold",children:L?J(L):"AIM Assistant"}),o.jsx("p",{className:"text-gray-400 text-xs",children:L?L.role:"Soporte y tips"})]})]}),(0,o.jsxs)("div",{className:"flex items-center space-x-2",children:[o.jsx("button",{onClick:()=>{b(!C),m(null),M(null)},className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":C?"Ver conversaciones":"Ver usuarios",children:C?o.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}):o.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),o.jsx("button",{onClick:eo,className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar chat",children:o.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),C&&!h&&(0,o.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[o.jsx("h4",{className:"text-white text-sm font-medium mb-3",children:"Usuarios disponibles"}),(0,o.jsxs)("div",{className:"mb-4",children:[(0,o.jsxs)("button",{onClick:()=>ee("online"),className:"flex items-center space-x-2 mb-2 w-full hover:bg-gray-700 rounded-lg p-1 transition-colors",children:[o.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),(0,o.jsxs)("span",{className:"text-green-400 text-xs font-medium",children:["En l\xednea (",d.filter(e=>e.is_online).length,")"]}),o.jsx("svg",{className:`w-3 h-3 text-green-400 transition-transform duration-200 ml-auto ${y.online?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),y.online&&o.jsx("div",{className:"space-y-2",children:d.filter(e=>e.is_online).map(e=>(0,o.jsxs)("button",{onClick:()=>X(e.id),className:"w-full flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-lg transition-colors",children:[o.jsx("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center",children:o.jsx("span",{className:"text-white text-xs font-medium",children:J(e).charAt(0).toUpperCase()})}),(0,o.jsxs)("div",{className:"flex-1 text-left",children:[o.jsx("div",{className:"text-white text-sm font-medium",children:J(e)}),o.jsx("div",{className:"text-gray-400 text-xs",children:e.role})]}),o.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"})]},e.id))})]}),(0,o.jsxs)("div",{children:[(0,o.jsxs)("button",{onClick:()=>ee("offline"),className:"flex items-center space-x-2 mb-2 w-full hover:bg-gray-700 rounded-lg p-1 transition-colors",children:[o.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full"}),(0,o.jsxs)("span",{className:"text-gray-400 text-xs font-medium",children:["Offline (",d.filter(e=>!e.is_online).length,")"]}),o.jsx("svg",{className:`w-3 h-3 text-gray-400 transition-transform duration-200 ml-auto ${y.offline?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),y.offline&&o.jsx("div",{className:"space-y-2",children:d.filter(e=>!e.is_online).map(e=>(0,o.jsxs)("button",{onClick:()=>X(e.id),className:"w-full flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-lg transition-colors opacity-75",children:[o.jsx("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center",children:o.jsx("span",{className:"text-white text-xs font-medium",children:J(e).charAt(0).toUpperCase()})}),(0,o.jsxs)("div",{className:"flex-1 text-left",children:[o.jsx("div",{className:"text-white text-sm font-medium",children:J(e)}),o.jsx("div",{className:"text-gray-400 text-xs",children:e.role})]}),o.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full"})]},e.id))})]})]}),!C&&!h&&(0,o.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[o.jsx("h4",{className:"text-white text-sm font-medium mb-3",children:"Conversaciones"}),o.jsx("div",{className:"space-y-1",children:l.map(e=>(0,o.jsxs)("div",{className:"group flex items-center space-x-2 p-2 hover:bg-gray-700 rounded-lg transition-colors",children:[(0,o.jsxs)("button",{onClick:()=>q(e.id),className:"flex-1 flex items-center space-x-2 min-w-0",children:[o.jsx("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0",children:o.jsx("span",{className:"text-white text-xs font-medium",children:J(e.other_participant).charAt(0).toUpperCase()})}),(0,o.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[o.jsx("div",{className:"text-white text-sm font-medium truncate",children:J(e.other_participant)}),o.jsx("div",{className:"text-gray-400 text-xs truncate",children:e.last_message?.content||"Sin mensajes"})]}),(0,o.jsxs)("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[o.jsx("div",{className:`w-2 h-2 rounded-full ${e.other_participant.is_online?"bg-green-500":"bg-gray-500"}`}),o.jsx("div",{className:"text-gray-400 text-xs",children:new Date(e.last_message_at).toLocaleDateString()})]})]}),o.jsx("button",{onClick:()=>z(e.id),className:"opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-400 transition-all",title:"Eliminar conversaci\xf3n (disponible para todos los participantes)",children:o.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},e.id))})]}),h&&(0,o.jsxs)(o.Fragment,{children:[o.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:(0,o.jsxs)("div",{className:"space-y-4",children:[g.map(t=>t.is_system_message?o.jsx("div",{className:"flex justify-center",children:o.jsx("div",{className:"max-w-[80%] p-2 rounded-lg bg-yellow-600/20 border border-yellow-600/30 text-yellow-200 text-center",children:o.jsx("div",{className:"text-sm",children:t.content})})},t.id):o.jsx("div",{className:`flex ${t.sender_id===e?"justify-end":"justify-start"}`,children:(0,o.jsxs)("div",{className:`max-w-[80%] p-3 rounded-lg ${t.sender_id===e?"bg-blue-600 text-white":"bg-gray-700 text-white"}`,children:[o.jsx("div",{className:"text-sm",children:t.content}),o.jsx("div",{className:"text-xs opacity-70 mt-1",children:new Date(t.created_at).toLocaleTimeString()})]})},t.id)),o.jsx("div",{ref:U})]})}),(0,o.jsxs)("div",{className:"p-4 border-t border-gray-700 bg-gray-800",children:[(0,o.jsxs)("div",{className:"flex items-end space-x-2",children:[o.jsx("div",{className:"flex-1 relative",children:o.jsx("textarea",{value:v,onChange:e=>f(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Y())},placeholder:"Escribe tu mensaje...",className:"w-full resize-none border border-gray-600 bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent placeholder-gray-400",rows:1,disabled:p})}),o.jsx("button",{onClick:()=>w(!j),className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":"Abrir emojis",children:o.jsx("span",{className:"text-lg",children:"\uD83D\uDE0A"})}),o.jsx("button",{onClick:Y,disabled:!v.trim()||p,className:"p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg transition-colors","aria-label":"Enviar mensaje",children:p?(0,o.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[o.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),o.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):o.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]}),(0,o.jsxs)("div",{className:"flex items-center justify-between mt-2 text-xs text-gray-400",children:[o.jsx("button",{onClick:()=>m(null),className:"hover:text-white transition-colors",children:"‚Üê Volver a conversaciones"}),o.jsx("span",{children:"‚Ä¢ Sesi\xf3n activa"})]})]})]})]}),O&&o.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9995]",children:(0,o.jsxs)("div",{className:"bg-gray-800 border border-gray-700 rounded-lg p-6 max-w-sm w-full mx-4",children:[o.jsx("h3",{className:"text-white text-lg font-semibold mb-4",children:"Eliminar conversaci\xf3n"}),o.jsx("p",{className:"text-gray-300 text-sm mb-6",children:"\xbfEst\xe1s seguro de que quieres eliminar esta conversaci\xf3n? Esta acci\xf3n eliminar\xe1 todos los mensajes y no se puede deshacer."}),(0,o.jsxs)("div",{className:"flex space-x-3",children:[o.jsx("button",{onClick:()=>z(null),className:"flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:"Cancelar"}),o.jsx("button",{onClick:()=>Q(O),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Eliminar"})]})]})})]})}},67766:(e,t,a)=>{"use strict";a.d(t,{E4:()=>n,P1:()=>r});var o=a(72829),s=a(86071);async function n(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:t,error:a}=await o.O.auth.signInWithPassword({email:e.email,password:e.password});if(a)return console.error("‚ùå [AUTH] Error de autenticaci\xf3n:",a.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!t.user)return{success:!1,error:"Usuario no encontrado"};console.log("‚úÖ [AUTH] Usuario autenticado en Supabase:",t.user.id);let{data:n,error:r}=await o.O.from("users").select(`
        id,
        name,
        email,
        role,
        is_active,
        last_login,
        organization_id,
        user_groups!inner(
          group_id,
          is_manager,
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",t.user.id).single();if(r)return console.error("‚ùå [AUTH] Error obteniendo perfil:",r.message),{success:!1,error:"Error obteniendo perfil de usuario"};if(!n)return{success:!1,error:"Perfil de usuario no encontrado"};if(!n.is_active)return{success:!1,error:"Usuario inactivo"};await o.O.from("users").update({last_login:new Date().toISOString()}).eq("id",t.user.id);let i={id:n.id,email:t.user.email,name:n.name,role:n.role,organization_id:n.organization_id,groups:n.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:n.is_active,last_login:n.last_login};console.log("‚úÖ [AUTH] Login exitoso:",{id:i.id,email:i.email,role:i.role,groups:i.groups.length});try{await (0,s.MY)(i.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("‚ùå [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:i}}catch(e){return console.error("‚ùå [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function r(){try{let{data:{user:e}}=await o.O.auth.getUser(),{error:t}=await o.O.auth.signOut();if(t&&console.error("‚ùå [AUTH] Error en logout:",t.message),e)try{await (0,s.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("‚ùå [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("‚ùå [AUTH] Error general en logout:",e)}}},86071:(e,t,a)=>{"use strict";a.d(t,{MY:()=>n,do:()=>i,lH:()=>r});var o=a(72829);async function s(e,t){try{console.log(`üìä [CHAT-STATUS] Actualizando estado de usuario ${e}: ${t?"EN L\xcdNEA":"OFFLINE"}`);let{error:a}=await o.O.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});a?console.error("‚ùå [CHAT-STATUS] Error actualizando estado:",a):console.log(`‚úÖ [CHAT-STATUS] Estado actualizado exitosamente: ${t?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("‚ùå [CHAT-STATUS] Error general:",e)}}async function n(e){await s(e,!0)}async function r(e){await s(e,!1)}async function i(e){try{let{error:t}=await o.O.from("chat_user_status").upsert({user_id:e,is_online:!0,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});t&&console.error("‚ùå [CHAT-STATUS] Error actualizando heartbeat:",t)}catch(e){console.error("‚ùå [CHAT-STATUS] Error en heartbeat:",e)}}},72829:(e,t,a)=>{"use strict";a.d(t,{O:()=>o});let o=(0,a(36654).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c")},41878:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c,metadata:()=>l});var o=a(25036);a(67272);let s=(0,a(86843).createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\components\ThemeTransition.tsx`),{__esModule:n,$$typeof:r}=s,i=s.default,l={title:"AIM Sistema de Gesti\xf3n",description:"Sistema de gesti\xf3n de usuarios con roles y grupos - Dise\xf1o Apple.com",icons:{icon:[{url:"/favicon.svg",type:"image/svg+xml"},{url:"/favicon.ico",type:"image/x-icon"}]}};function c({children:e}){return o.jsx("html",{lang:"es",children:o.jsx("body",{className:"min-h-screen bg-white text-gray-900 antialiased",children:o.jsx(i,{children:e})})})}},67272:()=>{}};