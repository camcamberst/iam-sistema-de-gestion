"use strict";exports.id=1065,exports.ids=[1065],exports.modules={1065:(e,r,o)=>{o.d(r,{Dv:()=>c,H4:()=>t,M_:()=>n,Z:()=>d,b4:()=>s,vk:()=>l});let a=(0,o(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=async(e,r,o,t)=>{try{let{data:l}=await a.from("calculator_period_closure_status").select("id").eq("period_date",e).single();if(l){let{error:e}=await a.from("calculator_period_closure_status").update({status:o,metadata:t||{},updated_at:new Date().toISOString()}).eq("id",l.id);if(e)throw e}else{let{error:l}=await a.from("calculator_period_closure_status").insert({period_date:e,period_type:r,status:o,metadata:t||{}});if(l)throw l}return{success:!0}}catch(e){return console.error("‚ùå [CLOSURE-HELPERS] Error actualizando estado:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}},l=async(e,r,o)=>{try{let t=o.map(o=>({period_date:e,model_id:r,platform_id:o,frozen_at:new Date().toISOString()})),{error:l}=await a.from("calculator_early_frozen_platforms").upsert(t,{onConflict:"period_date,model_id,platform_id",ignoreDuplicates:!1});if(l)throw l;return{success:!0}}catch(e){return console.error("‚ùå [CLOSURE-HELPERS] Error congelando plataformas:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}},s=async(e,r,o)=>{try{let{data:t,error:l}=await a.from("calculator_early_frozen_platforms").select("id").eq("period_date",e).eq("model_id",r).eq("platform_id",o).single();if(l&&"PGRST116"!==l.code)throw l;return!!t}catch(e){return console.error("‚ùå [CLOSURE-HELPERS] Error verificando congelaci\xf3n:",e),!1}},d=async(e,r)=>{try{let{data:o,error:t}=await a.from("calculator_early_frozen_platforms").select("platform_id").eq("period_date",e).eq("model_id",r);if(t)throw t;return o?.map(e=>e.platform_id)||[]}catch(e){return console.error("‚ùå [CLOSURE-HELPERS] Error obteniendo plataformas congeladas:",e),[]}},i=(e,r,o,a)=>{if("EUR"===o)return"big7"===r?e*a.eur_usd*.84:"mondo"===r?e*a.eur_usd*.78:e*a.eur_usd;if("GBP"===o)return"aw"===r?e*a.gbp_usd*.677:e*a.gbp_usd;if("USD"===o){if("cmd"===r||"camlust"===r||"skypvt"===r)return .75*e;if("chaturbate"===r||"myfreecams"===r||"stripchat"===r)return .05*e;if("dxlive"===r)return .6*e;if("secretfriends"===r)return .5*e;else if("superfoon"===r)return e;else return e}return 0},c=async(e,r,o)=>{try{let t,l;let[s,d]=r.split("-").map(Number);if("1-15"===o)t=`${s}-${String(d).padStart(2,"0")}-01`,l=`${s}-${String(d).padStart(2,"0")}-15`;else{t=`${s}-${String(d).padStart(2,"0")}-16`;let e=new Date(s,d,0).getDate();l=`${s}-${String(d).padStart(2,"0")}-${String(e).padStart(2,"0")}`}console.log(`‚öõÔ∏è [ATOMIC-CLOSE] Iniciando cierre at\xf3mico para ${o}: ${t} a ${l}`);let{data:c,error:n}=await a.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1});if(n)throw n;let _={eur_usd:c?.find(e=>"EUR‚ÜíUSD"===e.kind)?.value||1.01,gbp_usd:c?.find(e=>"GBP‚ÜíUSD"===e.kind)?.value||1.2,usd_cop:c?.find(e=>"USD‚ÜíCOP"===e.kind)?.value||3900},{data:u,error:p}=await a.from("calculator_config").select("*").eq("model_id",e).eq("active",!0).single();if(p&&"PGRST116"!==p.code)throw p;let f=u?.percentage_override||u?.group_percentage||80,{data:m,error:g}=await a.from("calculator_platforms").select("id, currency").eq("active",!0);if(g)throw g;let E=new Map((m||[]).map(e=>[e.id,e])),{data:v,error:h}=await a.from("model_values").select("*").eq("model_id",e).gte("period_date",t).lte("period_date",l);if(h)throw h;if(!v||0===v.length)return console.log(`‚öõÔ∏è [ATOMIC-CLOSE] No hay valores para archivar en el rango ${t} a ${l}`),{success:!0,archived:0,deleted:0};let S=new Map;for(let e of v){let r=S.get(e.platform_id);(!r||new Date(e.updated_at)>new Date(r.updated_at))&&S.set(e.platform_id,e)}let C=[];for(let[e,r]of Array.from(S.entries())){let o=E.get(e),a=o?.currency||"USD",t=i(Number(r.value),e,a,_),l=f/100*t,s=l*_.usd_cop;C.push({model_id:r.model_id,platform_id:e,value:Number(r.value),original_updated_at:r.updated_at,rate_eur_usd:_.eur_usd,rate_gbp_usd:_.gbp_usd,rate_usd_cop:_.usd_cop,platform_percentage:f,value_usd_bruto:parseFloat(t.toFixed(2)),value_usd_modelo:parseFloat(l.toFixed(2)),value_cop_modelo:parseFloat(s.toFixed(2))})}console.log(`üìù [ATOMIC-CLOSE] Archivando ${C.length} registros en calculator_history...`);let O=C.map(e=>({model_id:e.model_id,platform_id:e.platform_id,period_date:t,period_type:o,value:e.value,rate_eur_usd:e.rate_eur_usd,rate_gbp_usd:e.rate_gbp_usd,rate_usd_cop:e.rate_usd_cop,platform_percentage:e.platform_percentage,value_usd_bruto:e.value_usd_bruto,value_usd_modelo:e.value_usd_modelo,value_cop_modelo:e.value_cop_modelo,archived_at:new Date().toISOString()}));if(O.length>0){let{error:r}=await a.from("calculator_history").upsert(O,{onConflict:"model_id,platform_id,period_date,period_type",ignoreDuplicates:!1});if(r)throw console.error(`‚ùå [ATOMIC-CLOSE] Error archivando en history:`,r),r;console.log(`üîç [ATOMIC-CLOSE] Validando que el archivo completo se gener\xf3 correctamente...`);let{data:l,error:s}=await a.from("calculator_history").select("id, model_id, platform_id, period_date, period_type, value_usd_bruto, value_usd_modelo, value_cop_modelo").eq("model_id",e).eq("period_date",t).eq("period_type",o);if(s)throw console.error(`‚ùå [ATOMIC-CLOSE] Error verificando inserci\xf3n:`,s),Error(`Validaci\xf3n fallida: No se pudo verificar la inserci\xf3n en calculator_history: ${s.message}`);let d=l?.length||0;if(d<O.length){let e=`Validaci\xf3n fallida: Se intentaron insertar ${O.length} registros pero solo se verificaron ${d} en calculator_history`;throw console.error(`‚ùå [ATOMIC-CLOSE] ${e}`),Error(e)}let i=new Set(l?.map(e=>e.platform_id)||[]),c=new Set(O.map(e=>e.platform_id));if(i.size!==c.size){let e=`Validaci\xf3n fallida: Se esperaban ${c.size} plataformas pero se verificaron ${i.size}. Plataformas esperadas: ${Array.from(c).join(", ")}. Plataformas verificadas: ${Array.from(i).join(", ")}`;throw console.error(`‚ùå [ATOMIC-CLOSE] ${e}`),Error(e)}let n=l?.filter(e=>null===e.value_usd_bruto||void 0===e.value_usd_bruto||null===e.value_usd_modelo||void 0===e.value_usd_modelo||null===e.value_cop_modelo||void 0===e.value_cop_modelo)||[];if(n.length>0){let e=`Validaci\xf3n fallida: ${n.length} registros no tienen los campos calculados completos (value_usd_bruto, value_usd_modelo, value_cop_modelo)`;throw console.error(`‚ùå [ATOMIC-CLOSE] ${e}`),Error(e)}console.log(`‚úÖ [ATOMIC-CLOSE] Validaci\xf3n exitosa: ${d} registros verificados con detalle completo por plataforma`),console.log(`   üìä Plataformas archivadas: ${Array.from(i).join(", ")}`)}console.log(`‚úÖ [ATOMIC-CLOSE] ${O.length} registros archivados y verificados`),console.log(`üõ°Ô∏è [ATOMIC-CLOSE] Creando backup de seguridad F\xcdSICO antes del DELETE...`);let{data:$,error:w}=await a.rpc("create_safety_backup_before_delete",{p_model_id:e,p_period_start_date:t,p_period_end_date:l,p_period_type:o});if(w||!$||0===$.length||!$[0].success){let e=w?.message||$?.[0]?.error_message||"Error desconocido";throw console.error(`‚ùå [ATOMIC-CLOSE] FALLO CR\xcdTICO: No se pudo crear backup de seguridad: ${e}`),Error(`SEGURIDAD: No se puede eliminar datos sin backup. Error: ${e}`)}let y=$[0].backed_up_count||0;if(console.log(`üõ°Ô∏è [ATOMIC-CLOSE] Backup de seguridad creado: ${y} registros respaldados`),y!==v.length){let e=`SEGURIDAD: Backup incompleto. Esperados: ${v.length}, Respaldados: ${y}`;throw console.error(`‚ùå [ATOMIC-CLOSE] ${e}`),Error(e)}console.log(`üîç [ATOMIC-CLOSE] Verificaci\xf3n FINAL antes del DELETE...`);let{data:b,error:A}=await a.rpc("verify_history_and_mark_backup",{p_model_id:e,p_period_start_date:t,p_period_type:o});if(A||!b||0===b.length||!b[0].success){let e=A?.message||b?.[0]?.error_message||"Verificaci\xf3n fall\xf3";throw console.error(`‚ùå [ATOMIC-CLOSE] FALLO CR\xcdTICO: Verificaci\xf3n final fall\xf3: ${e}`),Error(`SEGURIDAD: No se puede eliminar datos. Verificaci\xf3n fall\xf3: ${e}`)}let I=b[0].history_count||0,L=b[0].backup_count||0;console.log(`‚úÖ [ATOMIC-CLOSE] Verificaci\xf3n FINAL exitosa:`),console.log(`   - Registros en calculator_history: ${I}`),console.log(`   - Plataformas en backup: ${L}`),console.log("   - Backup marcado como verificado"),console.log(`üóëÔ∏è [ATOMIC-CLOSE] INICIANDO DELETE (protegido por triple verificaci\xf3n)...`),console.log(`   ‚ö†Ô∏è  Este DELETE est\xe1 protegido por:`),console.log(`   ‚úÖ Backup f\xedsico en model_values_safety_backup`),console.log(`   ‚úÖ Archivo completo en calculator_history`),console.log(`   ‚úÖ Verificaci\xf3n cruzada exitosa`);let{data:x,error:T}=await a.from("model_values").delete().eq("model_id",e).gte("period_date",t).lte("period_date",l).select();if(T)throw console.error(`‚ùå [ATOMIC-CLOSE] Error eliminando model_values:`,T),console.error(`‚ö†Ô∏è  IMPORTANTE: Los datos est\xe1n PROTEGIDOS en model_values_safety_backup`),T;let D=x?.length||0;return console.log(`‚úÖ [ATOMIC-CLOSE] ${D} valores eliminados de model_values`),await a.from("model_values_safety_backup").update({deleted_from_model_values:!0}).eq("model_id",e).eq("period_start_date",t).eq("period_type",o),console.log(`‚úÖ [ATOMIC-CLOSE] \xc9xito: Archivados ${O.length}, Borrados ${D}, Respaldados ${y}`),{success:!0,archived:O.length,deleted:D}}catch(e){return console.error("‚ùå [ATOMIC-CLOSE] Error cr\xedtico:",e),{success:!1,archived:0,deleted:0,error:e instanceof Error?e.message:"Error desconocido"}}},n=async(e,r,t)=>{try{let l,s;let[d,i]=r.split("-").map(Number);if("1-15"===t)l=`${d}-${String(i).padStart(2,"0")}-01`,s=`${d}-${String(i).padStart(2,"0")}-15`;else{l=`${d}-${String(i).padStart(2,"0")}-16`;let e=new Date(d,i,0).getDate();s=`${d}-${String(i).padStart(2,"0")}-${String(e).padStart(2,"0")}`}console.log(`üíæ [BACKUP] Creando snapshot para modelo ${e}, per\xedodo ${t}: ${l} a ${s}`);let{data:c,error:n}=await a.from("model_values").select("*").eq("model_id",e).gte("period_date",l).lte("period_date",s);if(n)throw console.error(`‚ùå [BACKUP] Error obteniendo valores:`,n),n;let{data:_,error:u}=await a.from("rates").select("*").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1});if(u)throw console.error(`‚ùå [BACKUP] Error obteniendo tasas:`,u),u;let{data:p,error:f}=await a.from("calculator_config").select("*").eq("model_id",e).eq("active",!0).single();if(f&&"PGRST116"!==f.code)throw console.error(`‚ùå [BACKUP] Error obteniendo configuraci\xf3n:`,f),f;new Date().toISOString();let m=`${r}_${t}_${e}`,g=o(6113).createHash("sha256").update(m).digest("hex"),E=`${g.substring(0,8)}-${g.substring(8,12)}-${g.substring(12,16)}-${g.substring(16,20)}-${g.substring(20,32)}`,v={model_id:e,period_id:E,totals_json:{period_date:r,period_type:t,period_start:l,period_end:s,values:c||[],total_platforms:c?.length||0,total_value:c?.reduce((e,r)=>e+(Number(r.value)||0),0)||0,snapshot_metadata:{created_at:new Date().toISOString(),backup_purpose:"period_closure_safety_backup"}},rates_applied_json:{rates:_||[],model_config:p||null,snapshot_timestamp:new Date().toISOString(),period_reference:m}},{data:h,error:S}=await a.from("calc_snapshots").upsert(v,{onConflict:"model_id,period_id",ignoreDuplicates:!1}).select().single();if(S)throw console.error(`‚ùå [BACKUP] Error guardando snapshot:`,S),S;return console.log(`‚úÖ [BACKUP] Snapshot creado exitosamente: ${h?.id}`),{success:!0,snapshotId:h?.id}}catch(e){return console.error("‚ùå [BACKUP] Error cr\xedtico creando snapshot:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}}}};