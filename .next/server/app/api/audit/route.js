"use strict";(()=>{var e={};e.id=8701,e.ids=[8701],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},80666:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>b,originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>h,serverHooks:()=>I,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>D});var s={};r.r(s),r.d(s,{GET:()=>f,dynamic:()=>m});var i=r(95419),a=r(69108),o=r(99678),n=r(78070),c=r(72964),u=r(8234);async function l(e={}){try{let t=u.O.from("audit_logs").select("*").order("timestamp",{ascending:!1});e.userId&&(t=t.eq("user_id",e.userId)),e.action&&(t=t.eq("action",e.action)),e.severity&&(t=t.eq("severity",e.severity)),e.organizationId&&(t=t.eq("organization_id",e.organizationId)),e.startDate&&(t=t.gte("timestamp",e.startDate.toISOString())),e.endDate&&(t=t.lte("timestamp",e.endDate.toISOString())),void 0!==e.success&&(t=t.eq("success",e.success)),e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||50)-1));let{data:r,error:s}=await t;if(s)return console.error("❌ [AUDIT] Error obteniendo logs:",s),[];return(r||[]).map(e=>({...e,timestamp:new Date(e.timestamp)}))}catch(e){return console.error("❌ [AUDIT] Error general:",e),[]}}async function d(e,t=30){try{let r=new Date;r.setDate(r.getDate()-t);let s=await l({organizationId:e,startDate:r,limit:1e4}),i=s.length,a=s.filter(e=>e.success).length,o=s.filter(e=>"critical"===e.severity&&!e.success).length,n={};s.forEach(e=>{n[e.action]=(n[e.action]||0)+1});let c=Object.entries(n).map(([e,t])=>({action:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,10),u={};s.forEach(e=>{u[e.user_id]=(u[e.user_id]||0)+1});let d=Object.entries(u).map(([e,t])=>({userId:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,10),p=s.filter(e=>e.action.includes("auth.")||e.action.includes("permission.")||"high"===e.severity||"critical"===e.severity).length;return{totalLogs:i,successRate:Math.round(100*(i>0?a/i*100:0))/100,criticalIssues:o,topActions:c,topUsers:d,securityEvents:p}}catch(e){return console.error("❌ [AUDIT] Error obteniendo estad\xedsticas:",e),{totalLogs:0,successRate:0,criticalIssues:0,topActions:[],topUsers:[],securityEvents:0}}}async function p(e,t=24){try{let r=new Date;r.setHours(r.getHours()-t);let s=await l({organizationId:e,startDate:r,limit:1e4}),i=s.filter(e=>"auth.login_failed"===e.action).length,a=s.filter(e=>"auth.login"===e.action),o={};a.forEach(e=>{e.ip_address&&(o[e.ip_address]=(o[e.ip_address]||0)+1)});let n=Object.values(o).filter(e=>e>5).length,c={};s.forEach(e=>{c[e.user_id]=(c[e.user_id]||0)+1});let u=Object.values(c).filter(e=>e>50).length,d=s.filter(e=>"critical"===e.severity&&!e.success).length;return{suspiciousLogins:n,failedAttempts:i,unusualActivity:u,criticalAlerts:d}}catch(e){return console.error("❌ [AUDIT] Error detectando anomal\xedas:",e),{suspiciousLogins:0,failedAttempts:0,unusualActivity:0,criticalAlerts:0}}}let m="force-dynamic";async function g(e){try{let t=e.headers.get("authorization"),r=t?.replace("Bearer ","");if(!r)return{success:!1,error:"No autenticado"};let s=(0,c.createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c"),{data:{user:i},error:a}=await s.auth.getUser(r);if(a||!i)return{success:!1,error:"Token inv\xe1lido"};let{data:o,error:n}=await s.from("users").select("*").eq("id",i.id).single();if(n||!o)return{success:!1,error:"Perfil no encontrado"};if(!o.is_active)return{success:!1,error:"Usuario inactivo"};return{success:!0,user:o}}catch(e){return console.error("❌ [AUTH] Error:",e),{success:!1,error:"Error de autenticaci\xf3n"}}}async function f(e){try{console.log("\uD83D\uDCCA [API] Obteniendo logs de auditor\xeda");let t=await g(e);if(!t.success)return n.Z.json({success:!1,error:t.error},{status:401});let r=t.user;if(!["super_admin","admin"].includes(r.role))return n.Z.json({success:!1,error:"Sin permisos para ver auditor\xeda"},{status:403});let s=new URL(e.url),i=s.searchParams.get("action"),a=parseInt(s.searchParams.get("days")||"7");if("stats"===i){let e=await d(r.organization_id,a);return n.Z.json({success:!0,stats:e})}if("anomalies"===i){let e=await p(r.organization_id,24);return n.Z.json({success:!0,anomalies:e})}let o=await l({organizationId:r.organization_id,limit:1e3});return n.Z.json({success:!0,logs:o})}catch(e){return console.error("❌ [AUDIT API] Error:",e),n.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/audit/route",pathname:"/api/audit",filename:"route",bundlePath:"app/api/audit/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\audit\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:I,headerHooks:b,staticGenerationBailout:D}=h,w="/api/audit/route";function x(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:y})}},8234:(e,t,r)=>{r.d(t,{O:()=>n});var s=r(86843);let i=(0,s.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts`),{__esModule:a,$$typeof:o}=i;i.default;let n=(0,s.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts#supabase`)},86843:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createProxy",{enumerable:!0,get:function(){return s}});let s=r(18195).createClientModuleProxy},50482:(e,t,r)=>{e.exports=r(20399)},18195:(e,t,r)=>{e.exports=r(50482).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2964],()=>r(80666));module.exports=s})();