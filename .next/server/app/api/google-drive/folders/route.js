"use strict";(()=>{var e={};e.id=2099,e.ids=[2099],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},72254:e=>{e.exports=require("node:buffer")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},85477:e=>{e.exports=require("punycode")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},59796:e=>{e.exports=require("zlib")},10719:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>x,originalPathname:()=>m,patchFetch:()=>E,requestAsyncStorage:()=>f,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>q});var o={};t.r(o),t.d(o,{GET:()=>d,dynamic:()=>p});var s=t(95419),a=t(69108),i=t(99678),n=t(78070),u=t(73355),c=t(68260);let p="force-dynamic";async function d(e){try{let{searchParams:r}=new URL(e.url),t=r.get("folderId"),o=r.get("userId");if(!t)return n.Z.json({success:!1,error:"folderId es requerido"},{status:400});if(!o)return n.Z.json({success:!1,error:"userId es requerido"},{status:400});try{let e=await (0,c.l)(o),r=u.lkr.drive({version:"v3",auth:e}),s=((await r.files.list({q:`'${t}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,fields:"files(id, name)",orderBy:"name"})).data.files||[]).map(e=>({id:e.id,name:e.name}));return n.Z.json({success:!0,folders:s})}catch(e){if(e.message.includes("no autenticado")||e.message.includes("no est\xe1 configurado")||e.message.includes("Error al refrescar token")||e.message.includes("invalid_grant"))return console.log("\uD83D\uDD10 [GOOGLE-DRIVE-FOLDERS] Autenticaci\xf3n requerida:",e.message),n.Z.json({success:!1,error:e.message,requiresAuth:!0,requiresSetup:e.message.includes("no est\xe1 configurado")},{status:401});throw e}}catch(e){return console.error("❌ [GOOGLE-DRIVE-FOLDERS] Error:",e),n.Z.json({success:!1,error:e.message||"Error al listar carpetas"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/google-drive/folders/route",pathname:"/api/google-drive/folders",filename:"route",bundlePath:"app/api/google-drive/folders/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\google-drive\\folders\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:g,headerHooks:x,staticGenerationBailout:q}=l,m="/api/google-drive/folders/route";function E(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},68260:(e,r,t)=>{t.d(r,{L:()=>a,l:()=>i});var o=t(73355),s=t(66569);async function a(e){try{let r=s.R,{data:t,error:o}=await r.from("users").select("metadata").eq("id",e).single();if(o||!t)return null;let a=t.metadata,i=a?.google_drive;if(!i||!i.access_token)return null;return{access_token:i.access_token,refresh_token:i.refresh_token,expiry_date:i.expiry_date,token_type:i.token_type,scope:i.scope}}catch(e){return console.error("❌ [GOOGLE-DRIVE-AUTH] Error obteniendo tokens:",e),null}}async function i(e){let r=process.env.GOOGLE_CLIENT_ID,t=process.env.GOOGLE_CLIENT_SECRET,i=process.env.GOOGLE_REDIRECT_URI||"http://localhost:3000/api/google-drive/callback";if(!r||!t)throw Error("Google OAuth no est\xe1 configurado");let n=new o.lkr.auth.OAuth2(r,t,i),u=await a(e);if(!u)throw Error("Usuario no autenticado con Google Drive");if(!u.scope?.includes("https://www.googleapis.com/auth/drive"))throw console.warn("⚠️ [GOOGLE-DRIVE-AUTH] Scope insuficiente. Scope actual:",u.scope),Error("Usuario necesita reautenticarse con permisos completos de Google Drive");if(console.log("✅ [GOOGLE-DRIVE-AUTH] Tokens v\xe1lidos con scope completo:",u.scope),n.setCredentials(u),u.expiry_date&&u.expiry_date<Date.now()){if(u.refresh_token)try{let{credentials:r}=await n.refreshAccessToken(),t=s.R;await t.from("users").update({metadata:{...(await t.from("users").select("metadata").eq("id",e).single()).data?.metadata||{},google_drive:{access_token:r.access_token,refresh_token:r.refresh_token||u.refresh_token,expiry_date:r.expiry_date,token_type:r.token_type,scope:r.scope}},updated_at:new Date().toISOString()}).eq("id",e),n.setCredentials(r)}catch(e){throw console.error("❌ [GOOGLE-DRIVE-AUTH] Error refrescando token:",e),Error("Error al refrescar token de acceso")}else throw Error("Token expirado y no hay refresh token disponible")}return n}},66569:(e,r,t)=>{t.d(r,{A:()=>n,R:()=>i});var o=t(72964);let s="https://mhernfrkvwigxdubiozm.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",i=(0,o.createClient)(s,a,{auth:{autoRefreshToken:!1,persistSession:!1}}),n=(0,o.createClient)(s,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964,3355],()=>t(10719));module.exports=o})();