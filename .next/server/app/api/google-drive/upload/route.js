"use strict";(()=>{var e={};e.id=6609,e.ids=[6609],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},72254:e=>{e.exports=require("node:buffer")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},85477:e=>{e.exports=require("punycode")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},59796:e=>{e.exports=require("zlib")},8548:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>O,originalPathname:()=>D,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>h});var t={};o.r(t),o.d(t,{POST:()=>p,dynamic:()=>l});var s=o(95419),a=o(69108),i=o(99678),n=o(78070),u=o(73355),c=o(68260),d=o(12781);let l="force-dynamic";async function p(e){try{let r=await e.formData(),o=r.get("file"),t=r.get("folderId"),s=r.get("modelId"),a=r.get("userId");if(!o||!t)return n.Z.json({success:!1,error:"Archivo y folderId son requeridos"},{status:400});if(!a)return n.Z.json({success:!1,error:"userId es requerido"},{status:400});if(!o.type.startsWith("image/"))return n.Z.json({success:!1,error:"Solo se permiten archivos de imagen"},{status:400});try{console.log("\uD83D\uDD0D [GOOGLE-DRIVE-UPLOAD] Iniciando upload:",{fileName:o.name,folderId:t,modelId:s,userId:a,fileSize:o.size,fileType:o.type}),console.log("\uD83D\uDD0D [GOOGLE-DRIVE-UPLOAD] Obteniendo cliente OAuth2 para userId:",a);let e=await (0,c.l)(a);console.log("✅ [GOOGLE-DRIVE-UPLOAD] Cliente OAuth2 obtenido exitosamente");let r=u.lkr.drive({version:"v3",auth:e});console.log("✅ [GOOGLE-DRIVE-UPLOAD] Cliente Drive inicializado"),console.log("\uD83D\uDCE4 [GOOGLE-DRIVE-UPLOAD] Convirtiendo archivo a buffer...");let i=await o.arrayBuffer(),l=Buffer.from(i);console.log("✅ [GOOGLE-DRIVE-UPLOAD] Buffer creado, tama\xf1o:",l.length,"bytes");let p=d.Readable.from(l);console.log("✅ [GOOGLE-DRIVE-UPLOAD] Stream creado desde buffer"),console.log("\uD83D\uDD0D [GOOGLE-DRIVE-UPLOAD] Verificando acceso a carpeta:",t);try{await r.files.get({fileId:t,fields:"id, name, mimeType"}),console.log("✅ [GOOGLE-DRIVE-UPLOAD] Carpeta verificada y accesible")}catch(e){throw console.error("❌ [GOOGLE-DRIVE-UPLOAD] Error verificando carpeta:",{message:e.message,code:e.code,errors:e.errors}),Error(`No se puede acceder a la carpeta: ${e.message}`)}console.log("\uD83D\uDCE4 [GOOGLE-DRIVE-UPLOAD] Iniciando subida de archivo a Google Drive...");let f=await r.files.create({requestBody:{name:o.name,parents:[t]},media:{mimeType:o.type,body:p},fields:"id, name, webViewLink"});return console.log("✅ [GOOGLE-DRIVE-UPLOAD] Archivo subido exitosamente:",{fileId:f.data.id,fileName:f.data.name,webViewLink:f.data.webViewLink}),n.Z.json({success:!0,fileId:f.data.id,fileName:f.data.name,webViewLink:f.data.webViewLink})}catch(e){if(console.error("❌ [GOOGLE-DRIVE-UPLOAD] Error en upload:",{message:e.message,code:e.code,errors:e.errors,stack:e.stack}),e.message?.includes("no autenticado")||e.message?.includes("no est\xe1 configurado")||e.message?.includes("necesita reautenticarse")||401===e.code||403===e.code)return n.Z.json({success:!1,error:e.message||"Error de autenticaci\xf3n con Google Drive. Por favor, vuelve a autenticarte.",requiresAuth:!0,requiresSetup:e.message?.includes("no est\xe1 configurado")},{status:401});if(403===e.code||e.message?.includes("permission")||e.message?.includes("access"))return n.Z.json({success:!1,error:`Error de permisos: ${e.message||"No tienes permisos para subir archivos a esta carpeta"}`,requiresAuth:!0},{status:403});throw e}}catch(e){return console.error("❌ [GOOGLE-DRIVE-UPLOAD] Error:",e),n.Z.json({success:!1,error:e.message||"Error al subir archivo"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/google-drive/upload/route",pathname:"/api/google-drive/upload",filename:"route",bundlePath:"app/api/google-drive/upload/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\google-drive\\upload\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:E,headerHooks:O,staticGenerationBailout:h}=f,D="/api/google-drive/upload/route";function x(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:g})}},68260:(e,r,o)=>{o.d(r,{L:()=>a,l:()=>i});var t=o(73355),s=o(66569);async function a(e){try{let r=s.R,{data:o,error:t}=await r.from("users").select("metadata").eq("id",e).single();if(t||!o)return null;let a=o.metadata,i=a?.google_drive;if(!i||!i.access_token)return null;return{access_token:i.access_token,refresh_token:i.refresh_token,expiry_date:i.expiry_date,token_type:i.token_type,scope:i.scope}}catch(e){return console.error("❌ [GOOGLE-DRIVE-AUTH] Error obteniendo tokens:",e),null}}async function i(e){let r=process.env.GOOGLE_CLIENT_ID,o=process.env.GOOGLE_CLIENT_SECRET,i=process.env.GOOGLE_REDIRECT_URI||"http://localhost:3000/api/google-drive/callback";if(!r||!o)throw Error("Google OAuth no est\xe1 configurado");let n=new t.lkr.auth.OAuth2(r,o,i),u=await a(e);if(!u)throw Error("Usuario no autenticado con Google Drive");if(!u.scope?.includes("https://www.googleapis.com/auth/drive"))throw console.warn("⚠️ [GOOGLE-DRIVE-AUTH] Scope insuficiente. Scope actual:",u.scope),Error("Usuario necesita reautenticarse con permisos completos de Google Drive");if(console.log("✅ [GOOGLE-DRIVE-AUTH] Tokens v\xe1lidos con scope completo:",u.scope),n.setCredentials(u),u.expiry_date&&u.expiry_date<Date.now()){if(u.refresh_token)try{let{credentials:r}=await n.refreshAccessToken(),o=s.R;await o.from("users").update({metadata:{...(await o.from("users").select("metadata").eq("id",e).single()).data?.metadata||{},google_drive:{access_token:r.access_token,refresh_token:r.refresh_token||u.refresh_token,expiry_date:r.expiry_date,token_type:r.token_type,scope:r.scope}},updated_at:new Date().toISOString()}).eq("id",e),n.setCredentials(r)}catch(e){throw console.error("❌ [GOOGLE-DRIVE-AUTH] Error refrescando token:",e),Error("Error al refrescar token de acceso")}else throw Error("Token expirado y no hay refresh token disponible")}return n}},66569:(e,r,o)=>{o.d(r,{A:()=>n,R:()=>i});var t=o(72964);let s="https://mhernfrkvwigxdubiozm.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",i=(0,t.createClient)(s,a,{auth:{autoRefreshToken:!1,persistSession:!1}}),n=(0,t.createClient)(s,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964,3355],()=>o(8548));module.exports=t})();