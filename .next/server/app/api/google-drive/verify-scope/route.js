"use strict";(()=>{var e={};e.id=7941,e.ids=[7941],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},85158:e=>{e.exports=require("http2")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},72254:e=>{e.exports=require("node:buffer")},87561:e=>{e.exports=require("node:fs")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},77282:e=>{e.exports=require("process")},85477:e=>{e.exports=require("punycode")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},59796:e=>{e.exports=require("zlib")},18553:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>f,originalPathname:()=>q,patchFetch:()=>E,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>g});var o={};t.r(o),t.d(o,{GET:()=>c,dynamic:()=>u});var s=t(95419),i=t(69108),a=t(99678),n=t(78070),p=t(68260);let u="force-dynamic";async function c(e){try{let{searchParams:r}=new URL(e.url),t=r.get("userId");if(!t)return n.Z.json({success:!1,error:"userId es requerido"},{status:400});let o=await (0,p.L)(t);if(!o)return n.Z.json({success:!1,authenticated:!1,error:"Usuario no autenticado con Google Drive"});let s=o.scope?.includes("https://www.googleapis.com/auth/drive"),i=o.scope?.includes("https://www.googleapis.com/auth/drive.file");return n.Z.json({success:!0,authenticated:!0,scope:o.scope,hasFullDriveAccess:s,hasDriveFileAccess:i,needsReauth:!s,expiryDate:o.expiry_date,isExpired:!!o.expiry_date&&o.expiry_date<Date.now()})}catch(e){return console.error("❌ [GOOGLE-DRIVE-VERIFY-SCOPE] Error:",e),n.Z.json({success:!1,error:e.message||"Error al verificar scope"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/google-drive/verify-scope/route",pathname:"/api/google-drive/verify-scope",filename:"route",bundlePath:"app/api/google-drive/verify-scope/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\google-drive\\verify-scope\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:l,staticGenerationAsyncStorage:h,serverHooks:x,headerHooks:f,staticGenerationBailout:g}=d,q="/api/google-drive/verify-scope/route";function E(){return(0,a.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},68260:(e,r,t)=>{t.d(r,{L:()=>i,l:()=>a});var o=t(73355),s=t(66569);async function i(e){try{let r=s.R,{data:t,error:o}=await r.from("users").select("metadata").eq("id",e).single();if(o||!t)return null;let i=t.metadata,a=i?.google_drive;if(!a||!a.access_token)return null;return{access_token:a.access_token,refresh_token:a.refresh_token,expiry_date:a.expiry_date,token_type:a.token_type,scope:a.scope}}catch(e){return console.error("❌ [GOOGLE-DRIVE-AUTH] Error obteniendo tokens:",e),null}}async function a(e){let r=process.env.GOOGLE_CLIENT_ID,t=process.env.GOOGLE_CLIENT_SECRET,a=process.env.GOOGLE_REDIRECT_URI||"http://localhost:3000/api/google-drive/callback";if(!r||!t)throw Error("Google OAuth no est\xe1 configurado");let n=new o.lkr.auth.OAuth2(r,t,a),p=await i(e);if(!p)throw Error("Usuario no autenticado con Google Drive");if(!p.scope?.includes("https://www.googleapis.com/auth/drive"))throw console.warn("⚠️ [GOOGLE-DRIVE-AUTH] Scope insuficiente. Scope actual:",p.scope),Error("Usuario necesita reautenticarse con permisos completos de Google Drive");if(console.log("✅ [GOOGLE-DRIVE-AUTH] Tokens v\xe1lidos con scope completo:",p.scope),n.setCredentials(p),p.expiry_date&&p.expiry_date<Date.now()){if(p.refresh_token)try{let{credentials:r}=await n.refreshAccessToken(),t=s.R;await t.from("users").update({metadata:{...(await t.from("users").select("metadata").eq("id",e).single()).data?.metadata||{},google_drive:{access_token:r.access_token,refresh_token:r.refresh_token||p.refresh_token,expiry_date:r.expiry_date,token_type:r.token_type,scope:r.scope}},updated_at:new Date().toISOString()}).eq("id",e),n.setCredentials(r)}catch(e){throw console.error("❌ [GOOGLE-DRIVE-AUTH] Error refrescando token:",e),Error("Error al refrescar token de acceso")}else throw Error("Token expirado y no hay refresh token disponible")}return n}},66569:(e,r,t)=>{t.d(r,{A:()=>n,R:()=>a});var o=t(72964);let s="https://mhernfrkvwigxdubiozm.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY||"",a=(0,o.createClient)(s,i,{auth:{autoRefreshToken:!1,persistSession:!1}}),n=(0,o.createClient)(s,i,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964,3355],()=>t(18553));module.exports=o})();