"use strict";(()=>{var e={};e.id=1729,e.ids=[1729],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},61448:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>b,originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>E});var o={};t.r(o),t.d(o,{GET:()=>m,POST:()=>f,dynamic:()=>d});var a=t(95419),s=t(69108),n=t(99678),i=t(78070),l=t(72964),u=t(5218);let d="force-dynamic",c="https://mhernfrkvwigxdubiozm.supabase.co",p=process.env.SUPABASE_SERVICE_ROLE_KEY;async function m(e){try{let{searchParams:r}=new URL(e.url),t=r.get("model_id"),o=r.get("platform_id");if(!t)return i.Z.json({error:"model_id es requerido"},{status:400});let a=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}).from("modelo_plataformas").select(`
        platform_id,
        login_username,
        login_password_encrypted,
        status,
        calculator_platforms (
          id,
          name,
          login_url
        )
      `).eq("model_id",t).eq("status","entregada").not("login_username","is",null).not("login_password_encrypted","is",null);o&&(a=a.eq("platform_id",o));let{data:s,error:n}=await a;if(n)return console.error("Error obteniendo credenciales para AIM Browser:",n),i.Z.json({error:n.message},{status:500});if(!s||0===s.length)return i.Z.json({success:!0,model_id:t,credentials:{},count:0});let d={};for(let e of s)try{let r=(0,u.pe)(e.login_password_encrypted),t=e.calculator_platforms,o=t?.name||e.platform_id,a=t?.login_url;if(!a){console.warn(`Plataforma ${e.platform_id} no tiene URL de login configurado`);continue}d[e.platform_id]={platform_name:o,login_url:a,login_username:e.login_username,login_password:r,status:e.status}}catch(r){console.error(`Error desencriptando contrase\xf1a para plataforma ${e.platform_id}:`,r)}return i.Z.json({success:!0,model_id:t,credentials:d,count:Object.keys(d).length,timestamp:new Date().toISOString()})}catch(e){return console.error("Error in GET /api/aim-browser/platform-credentials:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function f(e){try{let r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return i.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let t=r.split(" ")[1],o=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:s}=await o.auth.getUser(t);if(s||!a)return i.Z.json({error:"Token inv\xe1lido"},{status:401});let{model_id:n,platform_id:d}=await e.json();if(!n)return i.Z.json({error:"model_id es requerido"},{status:400});let{data:m}=await o.from("users").select("role, id").eq("id",a.id).single();if(!(m?.id===n||m?.role==="admin"||m?.role==="super_admin"))return i.Z.json({error:"No autorizado para acceder a estas credenciales"},{status:403});let f=o.from("modelo_plataformas").select(`
        platform_id,
        login_username,
        login_password_encrypted,
        status,
        calculator_platforms (
          id,
          name,
          login_url
        )
      `).eq("model_id",n).eq("status","entregada").not("login_username","is",null).not("login_password_encrypted","is",null);d&&(f=f.eq("platform_id",d));let{data:g,error:_}=await f;if(_)return console.error("Error obteniendo credenciales para AIM Browser:",_),i.Z.json({error:_.message},{status:500});if(!g||0===g.length)return i.Z.json({success:!0,model_id:n,credentials:{},count:0});let h={};for(let e of g)try{let r=(0,u.pe)(e.login_password_encrypted),t=e.calculator_platforms,o=t?.name||e.platform_id,a=t?.login_url;if(!a){console.warn(`Plataforma ${e.platform_id} no tiene URL de login configurado`);continue}h[e.platform_id]={platform_name:o,login_url:a,login_username:e.login_username,login_password:r,status:e.status}}catch(r){console.error(`Error desencriptando contrase\xf1a para plataforma ${e.platform_id}:`,r)}return i.Z.json({success:!0,model_id:n,credentials:h,count:Object.keys(h).length,timestamp:new Date().toISOString()})}catch(e){return console.error("Error in POST /api/aim-browser/platform-credentials:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/aim-browser/platform-credentials/route",pathname:"/api/aim-browser/platform-credentials",filename:"route",bundlePath:"app/api/aim-browser/platform-credentials/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\aim-browser\\platform-credentials\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:w,headerHooks:b,staticGenerationBailout:E}=g,y="/api/aim-browser/platform-credentials/route";function v(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},5218:(e,r,t)=>{t.d(r,{HI:()=>l,pe:()=>u});var o=t(6113),a=t.n(o);let s=process.env.ENCRYPTION_KEY||"default-encryption-key-change-in-production-32-chars!!",n=()=>{let e;return e=s.length>=32?s.substring(0,32):a().createHash("sha256").update(s).digest().toString("hex").substring(0,32),Buffer.from(e,"utf8")},i="aes-256-gcm";function l(e){try{if(!e)throw Error("Texto vac\xedo para encriptar");let r=n(),t=a().randomBytes(16),o=a().randomBytes(64),s=a().pbkdf2Sync(r,o,1e5,32,"sha256"),l=a().createCipheriv(i,s,t),u=l.update(e,"utf8","base64");u+=l.final("base64");let d=l.getAuthTag();return[o.toString("base64"),t.toString("base64"),d.toString("base64"),u].join(":")}catch(e){throw console.error("❌ [ENCRYPTION] Error encriptando:",e),Error("Error al encriptar datos")}}function u(e){try{if(!e)throw Error("Texto encriptado vac\xedo");let r=e.split(":");if(4!==r.length)throw Error("Formato de texto encriptado inv\xe1lido");let[t,o,s,l]=r,u=n(),d=Buffer.from(t,"base64"),c=Buffer.from(o,"base64"),p=Buffer.from(s,"base64"),m=a().pbkdf2Sync(u,d,1e5,32,"sha256"),f=a().createDecipheriv(i,m,c);f.setAuthTag(p);let g=f.update(l,"base64","utf8");return g+=f.final("utf8")}catch(e){throw console.error("❌ [ENCRYPTION] Error desencriptando:",e),Error("Error al desencriptar datos")}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(61448));module.exports=o})();