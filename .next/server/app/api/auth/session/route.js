"use strict";(()=>{var e={};e.id=7603,e.ids=[7603],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7069:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>A,originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>T});var a={};o.r(a),o.d(a,{DELETE:()=>m,GET:()=>l,POST:()=>c,PUT:()=>d});var t=o(95419),i=o(69108),s=o(99678),n=o(78070),u=o(84487);async function l(e){try{console.log("\uD83D\uDC64 [API] Obteniendo sesi\xf3n actual");let e=await (0,u.ts)();if(!e)return n.Z.json({success:!1,error:"No hay sesi\xf3n activa"},{status:401});return console.log("✅ [API] Sesi\xf3n obtenida:",{id:e.id,email:e.email,role:e.role}),n.Z.json({success:!0,user:{id:e.id,email:e.email,name:e.name,role:e.role,organization_id:e.organization_id,groups:e.groups,is_active:e.is_active,last_login:e.last_login}})}catch(e){return console.error("❌ [API] Error obteniendo sesi\xf3n:",e),n.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function c(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}async function d(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}async function m(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}let g=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/session/route",pathname:"/api/auth/session",filename:"route",bundlePath:"app/api/auth/session/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\auth\\session\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:f,headerHooks:A,staticGenerationBailout:T}=g,h="/api/auth/session/route";function v(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},84487:(e,r,o)=>{o.d(r,{E4:()=>i,P1:()=>s,ts:()=>n});var a=o(8234),t=o(37542);async function i(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:r,error:o}=await a.O.auth.signInWithPassword({email:e.email,password:e.password});if(o)return console.error("❌ [AUTH] Error de autenticaci\xf3n:",o.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!r.user)return{success:!1,error:"Usuario no encontrado"};console.log("✅ [AUTH] Usuario autenticado en Supabase:",r.user.id);let{data:i,error:s}=await a.O.from("users").select(`
        id,
        name,
        email,
        role,
        is_active,
        last_login,
        organization_id,
        user_groups!inner(
          group_id,
          is_manager,
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",r.user.id).single();if(s)return console.error("❌ [AUTH] Error obteniendo perfil:",s.message),{success:!1,error:"Error obteniendo perfil de usuario"};if(!i)return{success:!1,error:"Perfil de usuario no encontrado"};if(!i.is_active)return{success:!1,error:"Usuario inactivo"};await a.O.from("users").update({last_login:new Date().toISOString()}).eq("id",r.user.id);let n={id:i.id,email:r.user.email,name:i.name,role:i.role,organization_id:i.organization_id,groups:i.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:i.is_active,last_login:i.last_login};console.log("✅ [AUTH] Login exitoso:",{id:n.id,email:n.email,role:n.role,groups:n.groups.length});try{await (0,t.MY)(n.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:n}}catch(e){return console.error("❌ [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function s(){try{let{data:{user:e}}=await a.O.auth.getUser(),{error:r}=await a.O.auth.signOut();if(r&&console.error("❌ [AUTH] Error en logout:",r.message),e)try{await (0,t.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("❌ [AUTH] Error general en logout:",e)}}async function n(){try{let{data:{user:e},error:r}=await a.O.auth.getUser();if(r||!e)return null;let{data:o,error:t}=await a.O.from("users").select(`
        id,
        name,
        email,
        role,
        is_active,
        last_login,
        organization_id,
        user_groups!inner(
          group_id,
          is_manager,
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",e.id).single();if(t||!o)return null;return{id:o.id,email:e.email,name:o.name,role:o.role,organization_id:o.organization_id,groups:o.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:o.is_active,last_login:o.last_login}}catch(e){return console.error("❌ [AUTH] Error obteniendo usuario actual:",e),null}}},37542:(e,r,o)=>{o.d(r,{GZ:()=>n,MY:()=>i,lH:()=>s});var a=o(8234);async function t(e,r){try{console.log(`📊 [CHAT-STATUS] Actualizando estado de usuario ${e}: ${r?"EN L\xcdNEA":"OFFLINE"}`);let{error:o}=await a.O.from("chat_user_status").upsert({user_id:e,is_online:r,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});o?console.error("❌ [CHAT-STATUS] Error actualizando estado:",o):console.log(`✅ [CHAT-STATUS] Estado actualizado exitosamente: ${r?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("❌ [CHAT-STATUS] Error general:",e)}}async function i(e){await t(e,!0)}async function s(e){await t(e,!1)}async function n(){try{let e=new Date(Date.now()-6e4).toISOString(),{count:r}=await a.O.from("chat_user_status").select("*",{count:"exact",head:!0}).lt("updated_at",e).eq("is_online",!0),{error:o}=await a.O.from("chat_user_status").update({is_online:!1}).lt("updated_at",e).eq("is_online",!0);o?console.error("❌ [CHAT-STATUS] Error limpiando usuarios inactivos:",o):r&&r>0&&console.log(`✅ [CHAT-STATUS] ${r} usuarios inactivos marcados como offline`)}catch(e){console.error("❌ [CHAT-STATUS] Error en limpieza:",e)}}},8234:(e,r,o)=>{o.d(r,{O:()=>n});var a=o(86843);let t=(0,a.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts`),{__esModule:i,$$typeof:s}=t;t.default;let n=(0,a.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts#supabase`)},86843:(e,r,o)=>{Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"createProxy",{enumerable:!0,get:function(){return a}});let a=o(18195).createClientModuleProxy},50482:(e,r,o)=>{e.exports=o(20399)},18195:(e,r,o)=>{e.exports=o(50482).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),a=r.X(0,[1638,6206],()=>o(7069));module.exports=a})();