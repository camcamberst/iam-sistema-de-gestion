"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},26067:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>A,originalPathname:()=>T,patchFetch:()=>E,requestAsyncStorage:()=>p,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>h});var a={};o.r(a),o.d(a,{DELETE:()=>m,GET:()=>c,POST:()=>l,PUT:()=>d});var t=o(95419),s=o(69108),i=o(99678),n=o(78070),u=o(84487);async function l(e){try{console.log("\uD83D\uDD10 [API] Iniciando login moderno via API");let{email:r,password:o}=await e.json();if(!r||!o)return n.Z.json({success:!1,error:"Email y contrase\xf1a son requeridos"},{status:400});let a=await (0,u.E4)({email:r,password:o});if(!a.success)return n.Z.json({success:!1,error:a.error||"Error de autenticaci\xf3n"},{status:401});return console.log("âœ… [API] Login exitoso:",{id:a.user?.id,email:a.user?.email,role:a.user?.role}),n.Z.json({success:!0,user:{id:a.user?.id,email:a.user?.email,name:a.user?.name,role:a.user?.role,organization_id:a.user?.organization_id,groups:a.user?.groups,is_active:a.user?.is_active,last_login:a.user?.last_login}})}catch(e){return console.error("âŒ [API] Error en login:",e),n.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function c(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}async function d(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}async function m(){return n.Z.json({error:"M\xe9todo no permitido"},{status:405})}let g=new t.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:f,headerHooks:A,staticGenerationBailout:h}=g,T="/api/auth/login/route";function E(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},84487:(e,r,o)=>{o.d(r,{E4:()=>s,P1:()=>i,ts:()=>n});var a=o(8234),t=o(37542);async function s(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:r,error:o}=await a.O.auth.signInWithPassword({email:e.email,password:e.password});if(o)return console.error("âŒ [AUTH] Error de autenticaci\xf3n:",o.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!r.user)return{success:!1,error:"Usuario no encontrado"};console.log("âœ… [AUTH] Usuario autenticado en Supabase:",r.user.id);let{data:s,error:i}=await a.O.from("users").select("id, name, email, role, is_active, last_login, organization_id").eq("id",r.user.id).single();if(i)return console.error("âŒ [AUTH] Error obteniendo perfil base:",i.message),{success:!1,error:"Error obteniendo perfil de usuario"};let{data:n,error:u}=await a.O.from("user_groups").select("is_manager, groups(id, name)").eq("user_id",r.user.id);if(!s)return{success:!1,error:"Perfil de usuario no encontrado"};if(!s.is_active)return{success:!1,error:"Usuario inactivo"};await a.O.from("users").update({last_login:new Date().toISOString()}).eq("id",r.user.id);let l={id:s.id,email:r.user.email,name:s.name,role:s.role,organization_id:s.organization_id,groups:(n||[]).map(e=>({id:e.groups?.id,name:e.groups?.name,is_manager:e.is_manager})),is_active:s.is_active,last_login:s.last_login};console.log("âœ… [AUTH] Login exitoso:",{id:l.id,email:l.email,role:l.role,groups:l.groups.length});try{await (0,t.MY)(l.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("âŒ [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:l}}catch(e){return console.error("âŒ [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function i(){try{let{data:{user:e}}=await a.O.auth.getUser(),{error:r}=await a.O.auth.signOut();if(r&&console.error("âŒ [AUTH] Error en logout:",r.message),e)try{await (0,t.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("âŒ [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("âŒ [AUTH] Error general en logout:",e)}}async function n(){try{let{data:{user:e},error:r}=await a.O.auth.getUser();if(r||!e)return null;let{data:o,error:t}=await a.O.from("users").select("id, name, email, role, is_active, last_login, organization_id").eq("id",e.id).single();if(t||!o)return null;let{data:s}=await a.O.from("user_groups").select("is_manager, groups(id, name)").eq("user_id",e.id);return{id:o.id,email:e.email,name:o.name,role:o.role,organization_id:o.organization_id,groups:(s||[]).map(e=>({id:e.groups?.id,name:e.groups?.name,is_manager:e.is_manager})),is_active:o.is_active,last_login:o.last_login}}catch(e){return console.error("âŒ [AUTH] Error obteniendo usuario actual:",e),null}}},37542:(e,r,o)=>{o.d(r,{GZ:()=>u,MY:()=>i,lH:()=>n});var a=o(72964);function t(){{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,a.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}async function s(e,r){try{console.log(`ðŸ“Š [CHAT-STATUS] Actualizando estado de usuario ${e}: ${r?"EN L\xcdNEA":"OFFLINE"}`);let o=t(),{error:a}=await o.from("chat_user_status").upsert({user_id:e,is_online:r,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});a?console.error("âŒ [CHAT-STATUS] Error actualizando estado:",a):console.log(`âœ… [CHAT-STATUS] Estado actualizado exitosamente: ${r?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("âŒ [CHAT-STATUS] Error general:",e)}}async function i(e){await s(e,!0)}async function n(e){await s(e,!1)}async function u(){try{let e=t(),r=new Date(Date.now()-12e4).toISOString(),{count:o}=await e.from("chat_user_status").select("*",{count:"exact",head:!0}).eq("is_online",!0).or(`updated_at.lt.${r},last_seen.lt.${r}`),{error:a}=await e.from("chat_user_status").update({is_online:!1}).eq("is_online",!0).or(`updated_at.lt.${r},last_seen.lt.${r}`);a?console.error("âŒ [CHAT-STATUS] Error limpiando usuarios inactivos:",a):o&&o>0&&console.log(`âœ… [CHAT-STATUS] ${o} usuarios inactivos (>2 min) marcados como offline`)}catch(e){console.error("âŒ [CHAT-STATUS] Error en limpieza:",e)}}},8234:(e,r,o)=>{o.d(r,{O:()=>n});var a=o(86843);let t=(0,a.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts`),{__esModule:s,$$typeof:i}=t;t.default;let n=(0,a.createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\lib\supabase.ts#supabase`)},86843:(e,r,o)=>{Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"createProxy",{enumerable:!0,get:function(){return a}});let a=o(18195).createClientModuleProxy},50482:(e,r,o)=>{e.exports=o(20399)},18195:(e,r,o)=>{e.exports=o(50482).vendored["react-rsc"].ReactServerDOMWebpackServerEdge}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>o(26067));module.exports=a})();