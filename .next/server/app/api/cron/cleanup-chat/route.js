"use strict";(()=>{var e={};e.id=1683,e.ids=[1683],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},41047:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>S,originalPathname:()=>E,patchFetch:()=>A,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>T});var r={};a.r(r),a.d(r,{GET:()=>u,POST:()=>l});var o=a(95419),s=a(69108),n=a(99678),i=a(78070),c=a(37542);async function u(e){try{console.log("\uD83D\uDD50 [CRON] Ejecutando limpieza autom\xe1tica de chat...");let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(a&&t!==`Bearer ${a}`)return i.Z.json({success:!1,error:"No autorizado"},{status:401});return await (0,c.GZ)(),console.log("âœ… [CRON] Limpieza autom\xe1tica completada"),i.Z.json({success:!0,message:"Limpieza autom\xe1tica de chat completada",timestamp:new Date().toISOString()})}catch(e){return console.error("âŒ [CRON] Error en limpieza autom\xe1tica:",e),i.Z.json({success:!1,error:"Error ejecutando limpieza autom\xe1tica",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}async function l(e){return u(e)}let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/cleanup-chat/route",pathname:"/api/cron/cleanup-chat",filename:"route",bundlePath:"app/api/cron/cleanup-chat/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\cron\\cleanup-chat\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:S,staticGenerationBailout:T}=p,E="/api/cron/cleanup-chat/route";function A(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},37542:(e,t,a)=>{a.d(t,{GZ:()=>c,MY:()=>n,lH:()=>i});var r=a(72964);function o(){{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,r.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}async function s(e,t){try{console.log(`ðŸ“Š [CHAT-STATUS] Actualizando estado de usuario ${e}: ${t?"EN L\xcdNEA":"OFFLINE"}`);let a=o(),{error:r}=await a.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});r?console.error("âŒ [CHAT-STATUS] Error actualizando estado:",r):console.log(`âœ… [CHAT-STATUS] Estado actualizado exitosamente: ${t?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("âŒ [CHAT-STATUS] Error general:",e)}}async function n(e){await s(e,!0)}async function i(e){await s(e,!1)}async function c(){try{let e=o(),t=new Date(Date.now()-12e4).toISOString(),{count:a}=await e.from("chat_user_status").select("*",{count:"exact",head:!0}).eq("is_online",!0).or(`updated_at.lt.${t},last_seen.lt.${t}`),{error:r}=await e.from("chat_user_status").update({is_online:!1}).eq("is_online",!0).or(`updated_at.lt.${t},last_seen.lt.${t}`);r?console.error("âŒ [CHAT-STATUS] Error limpiando usuarios inactivos:",r):a&&a>0&&console.log(`âœ… [CHAT-STATUS] ${a} usuarios inactivos (>2 min) marcados como offline`)}catch(e){console.error("âŒ [CHAT-STATUS] Error en limpieza:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,2964],()=>a(41047));module.exports=r})();