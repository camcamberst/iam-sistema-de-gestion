"use strict";(()=>{var e={};e.id=1026,e.ids=[1026],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},51287:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>_,originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>D,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>E});var t={};r.r(t),r.d(t,{GET:()=>n,POST:()=>d});var a=r(95419),s=r(69108),i=r(99678),l=r(78070),c=r(13532);async function n(e){try{console.log("\uD83D\uDD50 [CRON] Iniciando cierre autom\xe1tico de calculadora...");let e=(0,c.iR)(),o=(0,c.LQ)();console.log("\uD83D\uDD50 [CRON] Fecha actual:",e),console.log("\uD83D\uDD50 [CRON] Per\xedodo:",o.description);let t=new Date().getDate();if(15!==t&&30!==t)return console.log("\uD83D\uDD50 [CRON] No es d\xeda de corte. D\xeda actual:",t),l.Z.json({success:!0,message:"No es d\xeda de corte autom\xe1tico",current_day:t,cutoff_days:[15,30]});console.log("\uD83D\uDD50 [CRON] Es d\xeda de corte. Ejecutando cierre autom\xe1tico...");let{createClient:a}=await r.e(2964).then(r.bind(r,72964)),s=a("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});console.log("\uD83D\uDD04 [CRON] Ejecutando l\xf3gica de cierre autom\xe1tico...");let i=await (0,c.wU)(e);console.log("âœ… [CRON] Per\xedodo actual:",i);let{data:n,error:d}=await s.from("users").select("id, email, name, role").eq("role","modelo").eq("is_active",!0);if(d)return console.error("âŒ [CRON] Error obteniendo modelos:",d),l.Z.json({success:!1,error:"Error obteniendo modelos"},{status:500});console.log("\uD83D\uDD04 [CRON] Modelos encontrados:",n?.length||0);let u=[];for(let o of n||[])try{console.log(`ðŸ”„ [CRON] Procesando modelo: ${o.email} (${o.id})`);let{data:r,error:t}=await s.from("model_values").select("*").eq("model_id",o.id).eq("period_date",e);if(t){console.error(`âŒ [CRON] Error obteniendo valores para ${o.id}:`,t),u.push({model_id:o.id,model_email:o.email,status:"error",error:t.message});continue}let{data:a,error:l}=await s.rpc("cleanup_calculator_period",{p_period_date:e,p_period_type:i.type});if(l){console.error(`âŒ [CRON] Error en limpieza completa para ${o.email}:`,l),u.push({model_id:o.id,model_email:o.email,status:"error",error:l.message});continue}a&&a.success?console.log(`âœ… [CRON] Limpieza completa exitosa para ${o.email}:`,{archived:a.archived_values,deleted_values:a.deleted_values,deleted_totals:a.deleted_totals,notifications:a.notifications_sent}):console.error(`âŒ [CRON] Limpieza fall\xf3 para ${o.email}:`,a?.error),u.push({model_id:o.id,model_email:o.email,status:"success",values_archived:a?.archived_values||0,values_deleted:a?.deleted_values||0,totals_deleted:a?.deleted_totals||0,notifications_sent:a?.notifications_sent||0}),console.log(`âœ… [CRON] Modelo ${o.email} procesado: ${a?.archived_values||0} valores archivados, ${a?.deleted_values||0} valores eliminados, ${a?.deleted_totals||0} totales eliminados`)}catch(e){console.error(`âŒ [CRON] Error procesando modelo ${o.email}:`,e),u.push({model_id:o.id,model_email:o.email,status:"error",error:e instanceof Error?e.message:"Error desconocido"})}let m={success:!0,message:"Cierre autom\xe1tico completado",period:o.description,date:e,current_period:i,results:u,summary:{total_models:u.length,successful:u.filter(e=>"success"===e.status).length,failed:u.filter(e=>"error"===e.status).length}};return console.log("âœ… [CRON] Cierre autom\xe1tico completado:",m),l.Z.json({success:!0,message:"Cierre autom\xe1tico ejecutado exitosamente",execution_time:new Date().toISOString(),period:o.description,date:e,results:m})}catch(e){return console.error("âŒ [CRON] Error en cron job:",e),l.Z.json({success:!1,error:"Error interno del servidor",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}async function d(e){try{console.log("\uD83D\uDD04 [CRON-MANUAL] Ejecutando cierre manual...");let e=(0,c.iR)(),o=(0,c.LQ)(),r=await fetch("http://localhost:3000/api/calculator/auto-close-period",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.CRON_SECRET_KEY||"cron-secret"}`}});if(!r.ok){let e=await r.json();return console.error("âŒ [CRON-MANUAL] Error en cierre autom\xe1tico:",e),l.Z.json({success:!1,error:"Error ejecutando cierre autom\xe1tico",details:e},{status:500})}let t=await r.json();return console.log("âœ… [CRON-MANUAL] Cierre manual completado:",t),l.Z.json({success:!0,message:"Cierre manual ejecutado exitosamente",execution_time:new Date().toISOString(),period:o.description,date:e,results:t})}catch(e){return console.error("âŒ [CRON-MANUAL] Error en cierre manual:",e),l.Z.json({success:!1,error:"Error interno del servidor",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cron/auto-close-calculator/route",pathname:"/api/cron/auto-close-calculator",filename:"route",bundlePath:"app/api/cron/auto-close-calculator/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\cron\\auto-close-calculator\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:D,headerHooks:_,staticGenerationBailout:E}=u,g="/api/cron/auto-close-calculator/route";function h(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:p})}},13532:(e,o,r)=>{r.d(o,{LQ:()=>i,iR:()=>a,t2:()=>l,wU:()=>c});let t=()=>(console.warn("âš ï¸ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),s=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),i=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},l=()=>{let e=new Date;return e.setDate(e.getDate()+1),s(e)},c=async e=>{let{createClient:o}=await r.e(2964).then(r.bind(r,72964)),a=o("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e||t();try{let{data:e,error:o}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",s).eq("end_date",s).eq("is_active",!0).single();if(o&&"PGRST116"!==o.code)throw console.error("âŒ [CREATE-PERIOD] Error verificando per\xedodo:",o),o;if(e)return console.log("âœ… [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",s);let{data:r,error:t}=await a.from("periods").insert({name:`Per\xedodo ${s}`,start_date:s,end_date:s,is_active:!0}).select().single();if(t)throw console.error("âŒ [CREATE-PERIOD] Error creando per\xedodo:",t),t;return console.log("âœ… [CREATE-PERIOD] Per\xedodo creado exitosamente:",r),r}catch(e){throw console.error("âŒ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206],()=>r(51287));module.exports=t})();