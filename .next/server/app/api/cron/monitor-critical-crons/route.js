"use strict";(()=>{var e={};e.id=6074,e.ids=[6074],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},87977:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>E,originalPathname:()=>N,patchFetch:()=>_,requestAsyncStorage:()=>R,routeModule:()=>O,serverHooks:()=>f,staticGenerationAsyncStorage:()=>C,staticGenerationBailout:()=>x});var o={};t.r(o),t.d(o,{GET:()=>g});var a=t(95419),n=t(69108),i=t(99678),c=t(78070),s=t(72964),l=t(37863);let u=(0,s.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),d=async e=>{try{console.log("\uD83D\uDEA8 [CRON-ALERT] Enviando alerta de fallo cr\xedtico de cron:",e.cronName);let{data:r,error:t}=await u.from("users").select("id, email, name").eq("role","super_admin").eq("is_active",!0);if(t||!r||0===r.length){console.error("âŒ [CRON-ALERT] No se pudieron obtener super_admins:",t);return}let o=`
ðŸš¨ **ALERTA CR\xcdTICA: FALLO DE CRON JOB**

**Cron:** ${e.cronName}
**Hora Esperada:** ${e.expectedTime}
**Hora Actual:** ${e.actualTime}
${e.error?`**Error:** ${e.error}`:""}

âš ï¸ **ACCI\xd3N REQUERIDA:**
El cron job NO se ejecut\xf3 autom\xe1ticamente. Se requiere ejecuci\xf3n manual inmediata para evitar p\xe9rdida de datos.

**Pasos a seguir:**
1. Verificar logs de Vercel
2. Ejecutar manualmente el cierre de per\xedodo
3. Verificar que el archivo hist\xf3rico se cre\xf3 correctamente
`.trim();for(let e of r)try{await (0,l.MW)(e.id,"cron_failure_critical",o),console.log(`âœ… [CRON-ALERT] Alerta enviada a ${e.email}`)}catch(r){console.error(`âŒ [CRON-ALERT] Error enviando alerta a ${e.email}:`,r)}await u.from("system_alerts").insert({alert_type:"cron_failure",severity:"critical",cron_name:e.cronName,expected_time:e.expectedTime,actual_time:e.actualTime,error_message:e.error,metadata:e.metadata,notified_admins:r.map(e=>e.id),created_at:new Date().toISOString()}).catch(e=>{console.warn("âš ï¸ [CRON-ALERT] No se pudo registrar en system_alerts:",e.message)}),console.log(`âœ… [CRON-ALERT] Alerta enviada a ${r.length} super_admins`)}catch(e){console.error("âŒ [CRON-ALERT] Error cr\xedtico enviando alertas:",e)}},m=async(e,r,t=15)=>{try{let[o,a,n]=[r.getFullYear(),r.getMonth()+1,r.getDate()],i=n<=15?`${o}-${String(a).padStart(2,"0")}-01`:`${o}-${String(a).padStart(2,"0")}-16`,{data:c,error:s}=await u.from("calculator_period_closure_status").select("created_at, status").eq("period_date",i).eq("period_type",n<=15?"1-15":"16-31").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s||!c)return console.warn(`âš ï¸ [CRON-CHECK] No se encontr\xf3 registro de cierre para ${i}`),{executed:!1};let l=new Date(c.created_at),d=Math.floor((l.getTime()-r.getTime())/6e4);return d>t&&console.warn(`âš ï¸ [CRON-CHECK] Cron ${e} se ejecut\xf3 con ${d} minutos de retraso`),{executed:!0,latency:d}}catch(e){return console.error("âŒ [CRON-CHECK] Error verificando ejecuci\xf3n de cron:",e),{executed:!1}}},p=async()=>{try{let e=new Date,r=new Date(e.toLocaleString("en-US",{timeZone:"America/Bogota"})),t=r.getDate(),o=r.getHours(),a=r.getMinutes();if((1===t||16===t)&&(o>0||0===o&&a>=15)){console.log("\uD83D\uDD0D [CRON-MONITOR] Verificando ejecuci\xf3n de cron de cierre...");let e=new Date(r);e.setHours(0,0,0,0);let n=await m("period-closure-full-close",e,15);n.executed?n.latency&&n.latency>5?console.warn(`âš ï¸ [CRON-MONITOR] Cron se ejecut\xf3 con ${n.latency} minutos de retraso`):console.log(`âœ… [CRON-MONITOR] Cron ejecutado correctamente`):await d({cronName:"period-closure-full-close",expectedTime:e.toISOString(),actualTime:r.toISOString(),error:"Cron no se ejecut\xf3 en el tiempo esperado (00:00 - 00:15 Colombia)",metadata:{day:t,hour:o,minute:a,checked_at:r.toISOString()}})}}catch(e){console.error("âŒ [CRON-MONITOR] Error en monitoreo de crons:",e)}};async function g(e){try{return console.log("\uD83D\uDD0D [CRON-MONITOR-API] Iniciando monitoreo de cron jobs cr\xedticos..."),await p(),c.Z.json({success:!0,message:"Monitoreo completado",timestamp:new Date().toISOString()})}catch(e){return console.error("âŒ [CRON-MONITOR-API] Error:",e),c.Z.json({success:!1,error:e instanceof Error?e.message:"Error desconocido",timestamp:new Date().toISOString()},{status:500})}}let O=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/cron/monitor-critical-crons/route",pathname:"/api/cron/monitor-critical-crons",filename:"route",bundlePath:"app/api/cron/monitor-critical-crons/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\cron\\monitor-critical-crons\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:R,staticGenerationAsyncStorage:C,serverHooks:f,headerHooks:E,staticGenerationBailout:x}=O,N="/api/cron/monitor-critical-crons/route";function _(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:C})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964,7863],()=>t(87977));module.exports=o})();