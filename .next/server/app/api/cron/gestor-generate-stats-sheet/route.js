"use strict";(()=>{var e={};e.id=3301,e.ids=[3301],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},7142:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>$,originalPathname:()=>x,patchFetch:()=>N,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>T});var a={};t.r(a),t.d(a,{GET:()=>E});var s=t(95419),o=t(69108),n=t(99678),i=t(78070),l=t(72964),c=t(13532);let u=process.env.SUPABASE_SERVICE_ROLE_KEY,d=process.env.CRON_SECRET_KEY,p=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",u);async function E(e){try{let r=e.headers.get("authorization"),t=e.headers.get("x-cron-secret")||e.nextUrl.searchParams.get("secret");if(d&&t!==d&&r!==`Bearer ${d}`)return console.error("‚ùå [CRON-GENERATE-SHEET] Acceso no autorizado"),i.Z.json({success:!1,error:"No autorizado"},{status:401});let a=(0,c.iR)(),[s,o,n]=a.split("-").map(Number);if(1!==n)return i.Z.json({success:!0,message:"No es d\xeda 1 del mes",currentDate:a,day:n});console.log(`üìä [CRON-GENERATE-SHEET] Iniciando generaci\xf3n autom\xe1tica de planilla mensual para ${s}-${String(o).padStart(2,"0")}`);let l=`${s}-${String(o).padStart(2,"0")}-01`,u=`${s}-${String(o).padStart(2,"0")}-16`,{data:E}=await p.from("gestor_stats_values").select("id").in("period_date",[l,u]).limit(1).single();if(E)return console.log(`‚úÖ [CRON-GENERATE-SHEET] La planilla ya existe para este mes`),i.Z.json({success:!0,message:"La planilla ya existe para este mes",year:s,month:o});try{let e=await fetch("http://localhost:3000/api/gestor/stats/generate-sheet",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d||"internal"}`},body:JSON.stringify({year:s,month:o})}),r=await e.json();if(!e.ok)return console.error("‚ùå [CRON-GENERATE-SHEET] Error generando planilla:",r),i.Z.json({success:!1,error:"Error generando planilla",details:r},{status:500});return console.log(`‚úÖ [CRON-GENERATE-SHEET] Planilla mensual generada exitosamente:`,r),i.Z.json({success:!0,message:"Planilla mensual generada exitosamente",year:s,month:o,...r})}catch(e){return console.error("‚ùå [CRON-GENERATE-SHEET] Error llamando al endpoint de generaci\xf3n:",e),i.Z.json({success:!1,error:"Error llamando al endpoint de generaci\xf3n",details:e.message},{status:500})}}catch(e){return console.error("‚ùå [CRON-GENERATE-SHEET] Error inesperado:",e),i.Z.json({success:!1,error:"Error interno del servidor",details:e.message},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/gestor-generate-stats-sheet/route",pathname:"/api/cron/gestor-generate-stats-sheet",filename:"route",bundlePath:"app/api/cron/gestor-generate-stats-sheet/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\cron\\gestor-generate-stats-sheet\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:S,serverHooks:h,headerHooks:$,staticGenerationBailout:T}=g,x="/api/cron/gestor-generate-stats-sheet/route";function N(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:S})}},13532:(e,r,t)=>{t.d(r,{Bs:()=>o,Jz:()=>s,iR:()=>n,lm:()=>a});let a=()=>{let[e,r,t]=n().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},s=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("‚ö†Ô∏è [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),a();let[r,t,s]=e.split("-").map(Number);if(!r||!t||!s)return a();return`${r}-${String(t).padStart(2,"0")}-${String(s<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("‚ùå [DATE-UTILS] Error normalizando fecha:",e),a()}},o=e=>{try{let[r,t,a]=e.split("-").map(Number),s=a<=15,o=`${r}-${String(t).padStart(2,"0")}-${s?"01":"16"}`,n="";if(s)n=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();n=`${r}-${String(t).padStart(2,"0")}-${e}`}let i=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${s?"1":"2"}`;return{startDate:o,endDate:n,name:i,isP1:s}}catch(r){return console.error("‚ùå [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},n=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(7142));module.exports=a})();