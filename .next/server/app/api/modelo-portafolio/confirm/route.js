"use strict";(()=>{var e={};e.id=5698,e.ids=[5698],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},88422:(e,a,r)=>{r.r(a),r.d(a,{headerHooks:()=>g,originalPathname:()=>q,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>u,serverHooks:()=>_,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>w});var o={};r.r(o),r.d(o,{POST:()=>m});var t=r(95419),i=r(69108),s=r(99678),n=r(78070),l=r(72964),c=r(37863);let d=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function m(e){try{let{platformId:a,modelId:r}=await e.json();if(!a||!r)return n.Z.json({success:!1,error:"platformId y modelId son requeridos"},{status:400});let o=async e=>{let{data:a}=await d.from("calculator_platforms").select("id, name").eq("id",e).maybeSingle();if(a)return a.id;let{data:r}=await d.from("calculator_platforms").select("id, name").ilike("id",e).maybeSingle();if(r)return r.id;let{data:o}=await d.from("calculator_platforms").select("id, name").eq("name",e).maybeSingle();if(o)return o.id;let t=e.replace(/\s+/g,""),{data:i}=await d.from("calculator_platforms").select("id, name").ilike("name",`%${t}%`).maybeSingle();return i?i.id:e},t=await o(a),{data:i,error:s}=await d.from("modelo_plataformas").select("*").eq("model_id",r).eq("platform_id",t).single();if(s||!i)return n.Z.json({success:!1,error:"Plataforma no encontrada"},{status:404});if("entregada"!==i.status)return n.Z.json({success:!1,error:"Solo se pueden confirmar plataformas en estado entregada"},{status:400});let l=new Date().toISOString(),{data:m,error:u}=await d.from("modelo_plataformas").update({status:"confirmada",confirmed_at:l,confirmed_by:r,calculator_sync:!0,calculator_activated_at:l,updated_at:l}).eq("model_id",r).eq("platform_id",t).select().single();if(u)return console.error("Error actualizando plataforma:",u),n.Z.json({success:!1,error:"Error al confirmar la plataforma"},{status:500});try{let{data:e,error:a}=await d.from("calculator_config").select("*").eq("model_id",r).eq("active",!0).single();if(a&&"PGRST116"!==a.code&&console.warn("⚠️ [CONFIRM] Error obteniendo config calculadora:",a.message),e){let a=Array.isArray(e.enabled_platforms)?e.enabled_platforms:[];if(!a.includes(t)){let r=[...a,t],{error:o}=await d.from("calculator_config").update({enabled_platforms:r,updated_at:l}).eq("id",e.id);o&&console.warn("⚠️ [CONFIRM] No se pudo actualizar enabled_platforms:",o.message)}}else{let{error:e}=await d.from("calculator_config").insert({model_id:r,active:!0,enabled_platforms:[t],created_at:l,updated_at:l});e&&console.warn("⚠️ [CONFIRM] No se pudo crear calculator_config:",e.message)}}catch(e){console.warn("⚠️ [CONFIRM] Error sincronizando calculadora:",e?.message||e)}try{let e=i.platform_name||a,{data:o}=await d.from("users").select("name").eq("id",r).single(),t=o?.name||"Modelo";await (0,c.Ui)(r,e),await (0,c.wY)(r,t,e),console.log("✅ [CONFIRM] Notificaciones enviadas")}catch(e){console.warn("⚠️ [CONFIRM] Error enviando notificaci\xf3n:",e)}return n.Z.json({success:!0,data:m,message:"Plataforma confirmada correctamente"})}catch(e){return console.error("Error en confirmaci\xf3n de plataforma:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let u=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/modelo-portafolio/confirm/route",pathname:"/api/modelo-portafolio/confirm",filename:"route",bundlePath:"app/api/modelo-portafolio/confirm/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\modelo-portafolio\\confirm\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:p,serverHooks:_,headerHooks:g,staticGenerationBailout:w}=u,q="/api/modelo-portafolio/confirm/route";function b(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:p})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),o=a.X(0,[1638,6206,2964,7863],()=>r(88422));module.exports=o})();