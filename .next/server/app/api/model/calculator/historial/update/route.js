"use strict";(()=>{var e={};e.id=9388,e.ids=[9388],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},53527:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>A,originalPathname:()=>v,patchFetch:()=>h,requestAsyncStorage:()=>_,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>g});var o={};t.r(o),t.d(o,{POST:()=>c,PUT:()=>l,dynamic:()=>n});var a=t(95419),s=t(69108),u=t(99678),i=t(78070);let d=(0,t(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),n="force-dynamic";async function l(e){try{let{historyId:r,period_date:t,period_type:o,model_id:a,platform_id:s,value:u,value_usd_bruto:n,value_usd_modelo:l,value_cop_modelo:c}=await e.json();if(!r&&(!t||!o||!a||!s))return i.Z.json({success:!1,error:"historyId o (period_date, period_type, model_id, platform_id) son requeridos"},{status:400});let p=e.headers.get("authorization"),_=null,m=null;if(p&&p.startsWith("Bearer ")&&(m=p.substring(7)),m)try{let{data:{user:e},error:r}=await d.auth.getUser(m);!r&&e&&(_=e.id)}catch(e){console.warn("âš ï¸ [CALCULATOR-HISTORIAL-UPDATE] Error verificando autenticaci\xf3n:",e)}if(!_)return i.Z.json({success:!1,error:"Autenticaci\xf3n requerida"},{status:401});let{data:f}=await d.from("users").select("role").eq("id",_).single(),A=f?.role||"modelo";if(!("admin"===A||"super_admin"===A))return console.warn(`ðŸš« [CALCULATOR-HISTORIAL-UPDATE] Usuario ${_} sin permisos de edici\xf3n`),i.Z.json({success:!1,error:"No autorizado: Solo admins pueden editar historial"},{status:403});let g=d.from("calculator_history").select("*");g=r?g.eq("id",r):g.eq("period_date",t).eq("period_type",o).eq("model_id",a).eq("platform_id",s);let{data:v,error:h}=await g;if(h||!v||0===v.length)return i.Z.json({success:!1,error:"Registro no encontrado"},{status:404});let T=v[0],b=r||T.id,L={updated_at:new Date().toISOString()};void 0!==u&&(L.value=Number(u)),void 0!==n&&(L.value_usd_bruto=Number(n)),void 0!==l&&(L.value_usd_modelo=Number(l)),void 0!==c&&(L.value_cop_modelo=Number(c));let{data:U,error:E}=await d.from("calculator_history").update(L).eq("id",b).select().single();if(E)return console.error("âŒ [CALCULATOR-HISTORIAL-UPDATE] Error actualizando:",E),i.Z.json({success:!1,error:"Error al actualizar registro"},{status:500});return console.log(`âœ… [CALCULATOR-HISTORIAL-UPDATE] Registro ${b} actualizado por admin ${_}`),i.Z.json({success:!0,data:U,message:"Registro actualizado exitosamente"})}catch(e){return console.error("âŒ [CALCULATOR-HISTORIAL-UPDATE] Error:",e),i.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function c(e){try{let{period_date:r,period_type:t,model_id:o,rates:a}=await e.json();if(!r||!t||!o||!a)return i.Z.json({success:!1,error:"period_date, period_type, model_id y rates son requeridos"},{status:400});let s=e.headers.get("authorization"),u=null,n=null;if(s&&s.startsWith("Bearer ")&&(n=s.substring(7)),n)try{let{data:{user:e},error:r}=await d.auth.getUser(n);!r&&e&&(u=e.id)}catch(e){console.warn("âš ï¸ [CALCULATOR-HISTORIAL-UPDATE] Error verificando autenticaci\xf3n:",e)}if(!u)return i.Z.json({success:!1,error:"Autenticaci\xf3n requerida"},{status:401});let{data:l}=await d.from("users").select("role").eq("id",u).single(),c=l?.role||"modelo";if(!("admin"===c||"super_admin"===c))return i.Z.json({success:!1,error:"No autorizado: Solo admins pueden editar tasas"},{status:403});let{data:p,error:_}=await d.from("calculator_history").select("*").eq("model_id",o).eq("period_date",r).eq("period_type",t);if(_)return console.error("âŒ [CALCULATOR-HISTORIAL-UPDATE] Error obteniendo registros:",_),i.Z.json({success:!1,error:"Error al obtener registros del per\xedodo"},{status:500});if(!p||0===p.length)return i.Z.json({success:!1,error:"No se encontraron registros para este per\xedodo"},{status:404});let m=Array.from(new Set(p.map(e=>e.platform_id).filter(Boolean))),{data:f,error:A}=await d.from("calculator_platforms").select("id, currency").eq("active",!0).in("id",m);if(A)return console.error("âŒ [CALCULATOR-HISTORIAL-UPDATE] Error obteniendo plataformas:",A),i.Z.json({success:!1,error:"Error al obtener informaci\xf3n de plataformas"},{status:500});let g=new Map((f||[]).map(e=>[e.id,e])),v={eur_usd:void 0!==a.eur_usd?Number(a.eur_usd):p[0].rate_eur_usd||1.01,gbp_usd:void 0!==a.gbp_usd?Number(a.gbp_usd):p[0].rate_gbp_usd||1.2,usd_cop:void 0!==a.usd_cop?Number(a.usd_cop):p[0].rate_usd_cop||3900},h=(e,r,t,o)=>{if("EUR"===t)return"big7"===r?e*o.eur_usd*.84:"mondo"===r?e*o.eur_usd*.78:e*o.eur_usd;if("GBP"===t)return"aw"===r?e*o.gbp_usd*.677:e*o.gbp_usd;if("USD"===t){if("cmd"===r||"camlust"===r||"skypvt"===r)return .75*e;if("chaturbate"===r||"myfreecams"===r||"stripchat"===r)return .05*e;if("dxlive"===r)return .6*e;if("secretfriends"===r)return .5*e;else if("superfoon"===r)return e;else return e}return 0},T=p.map(e=>{let r=g.get(e.platform_id),t=r?.currency||"USD",o=Number(e.value)||0,a=e.platform_percentage||80,s=h(o,e.platform_id,t,v),u=a/100*s,i=u*v.usd_cop;return{id:e.id,rate_eur_usd:v.eur_usd,rate_gbp_usd:v.gbp_usd,rate_usd_cop:v.usd_cop,value_usd_bruto:parseFloat(s.toFixed(2)),value_usd_modelo:parseFloat(u.toFixed(2)),value_cop_modelo:parseFloat(i.toFixed(2)),updated_at:new Date().toISOString()}}),b=0;for(let e of T){let{error:r}=await d.from("calculator_history").update({rate_eur_usd:e.rate_eur_usd,rate_gbp_usd:e.rate_gbp_usd,rate_usd_cop:e.rate_usd_cop,value_usd_bruto:e.value_usd_bruto,value_usd_modelo:e.value_usd_modelo,value_cop_modelo:e.value_cop_modelo,updated_at:e.updated_at}).eq("id",e.id);if(r){console.error(`âŒ [CALCULATOR-HISTORIAL-UPDATE] Error actualizando registro ${e.id}:`,r);continue}b++}return console.log(`âœ… [CALCULATOR-HISTORIAL-UPDATE] ${b} de ${T.length} registros actualizados con nuevas tasas y valores recalculados`),i.Z.json({success:!0,updated_count:b,message:`Tasas y valores recalculados exitosamente para ${b} registros del per\xedodo.`})}catch(e){return console.error("âŒ [CALCULATOR-HISTORIAL-UPDATE] Error:",e),i.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/model/calculator/historial/update/route",pathname:"/api/model/calculator/historial/update",filename:"route",bundlePath:"app/api/model/calculator/historial/update/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\model\\calculator\\historial\\update\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:f,headerHooks:A,staticGenerationBailout:g}=p,v="/api/model/calculator/historial/update/route";function h(){return(0,u.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(53527));module.exports=o})();