"use strict";(()=>{var e={};e.id=9479,e.ids=[9479],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},90346:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>c,routeModule:()=>n,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var o={};a.r(o),a.d(o,{GET:()=>_,dynamic:()=>u});var r=a(95419),d=a(69108),i=a(99678),s=a(78070);let l=(0,a(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),u="force-dynamic";async function _(e){try{let{searchParams:t}=new URL(e.url),a=t.get("modelId");if(!a)return s.Z.json({success:!1,error:"modelId es requerido"},{status:400});let o=e.headers.get("authorization"),r=null,d=null;if(o&&o.startsWith("Bearer ")&&(d=o.substring(7)),d)try{let{data:{user:e},error:t}=await l.auth.getUser(d);!t&&e&&(r=e.id)}catch(e){console.warn("âš ï¸ [CALCULATOR-HISTORIAL] Error verificando autenticaci\xf3n:",e)}if(!r)return s.Z.json({success:!1,error:"Autenticaci\xf3n requerida"},{status:401});let{data:i}=await l.from("users").select("role, affiliate_studio_id").eq("id",r).single(),u=i?.role||"modelo",_="superadmin_aff"===u;if("modelo"===u&&r!==a)return console.warn(`ðŸš« [CALCULATOR-HISTORIAL] Intento de acceso no autorizado: Usuario ${r} intent\xf3 acceder a datos de ${a}`),s.Z.json({success:!1,error:"No autorizado: Solo puedes consultar tu propio historial"},{status:403});if(_||"admin"===u&&i?.affiliate_studio_id){let{data:e,error:t}=await l.from("users").select("affiliate_studio_id").eq("id",a).single();if(t||!e)return s.Z.json({success:!1,error:"Modelo no encontrado"},{status:404});if(e.affiliate_studio_id!==i?.affiliate_studio_id)return console.warn(`ðŸš« [CALCULATOR-HISTORIAL] Intento de acceso no autorizado: Usuario ${r} (affiliate: ${i?.affiliate_studio_id}) intent\xf3 acceder a datos de ${a} (affiliate: ${e.affiliate_studio_id})`),s.Z.json({success:!1,error:"No autorizado para consultar este historial"},{status:403})}if(!("admin"===u||"super_admin"===u)&&!_&&r!==a)return console.warn(`ðŸš« [CALCULATOR-HISTORIAL] Intento de acceso no autorizado: Usuario ${r} intent\xf3 acceder a datos de ${a}`),s.Z.json({success:!1,error:"No autorizado para consultar este historial"},{status:403});let{data:n,error:c}=await l.from("calculator_history").select("id, platform_id, value, period_date, period_type, archived_at, rate_eur_usd, rate_gbp_usd, rate_usd_cop, platform_percentage, value_usd_bruto, value_usd_modelo, value_cop_modelo").eq("model_id",a).gte("period_date","2025-01-01").order("period_date",{ascending:!1}),{data:p,error:m}=await l.from("calculator_history").select("id, platform_id, value, period_date, period_type, archived_at, rate_eur_usd, rate_gbp_usd, rate_usd_cop, platform_percentage, value_usd_bruto, value_usd_modelo, value_cop_modelo").eq("model_id",a).gte("period_date","2024-12-01").lte("period_date","2024-12-15").eq("period_type","1-15").order("period_date",{ascending:!1}),f=(p||[]).map(e=>({...e,period_date:e.period_date.replace("2024-","2025-")})),g=[...n||[],...f],h=c||m;if(h)return console.error("âŒ [CALCULATOR-HISTORIAL] Error obteniendo historial:",h),s.Z.json({success:!1,error:"Error al obtener historial"},{status:500});if(!g||0===g.length)return s.Z.json({success:!0,periods:[],total_periods:0});let v=Array.from(new Set((g||[]).map(e=>e.platform_id).filter(Boolean))),b=new Map;if(v.length>0){let{data:e}=await l.from("calculator_platforms").select("id, name, currency").in("id",v);e&&e.forEach(e=>{b.set(e.id,{name:e.name||e.id,currency:e.currency||"USD"})})}let A=80,w=470,{data:y}=await l.from("calculator_config").select("percentage_override, group_percentage, min_quota_override, group_min_quota").eq("model_id",a).eq("active",!0).single();y&&(A=y.percentage_override||y.group_percentage||80,w=y.min_quota_override||y.group_min_quota||470);let L=new Map;g.forEach(e=>{if(!e.period_date||!e.period_type||!e.platform_id){console.warn("âš ï¸ [CALCULATOR-HISTORIAL] Registro con datos incompletos:",e);return}let t=`${e.period_date}-${e.period_type}`,a=b.get(e.platform_id),o=null!=e.value?Number(e.value):0,r=isNaN(o)?0:o;L.has(t)||L.set(t,{period_date:e.period_date,period_type:e.period_type,archived_at:e.archived_at||new Date().toISOString(),platforms:[],total_value:0,total_usd_bruto:0,total_usd_modelo:0,total_cop_modelo:0,total_anticipos:0,total_deducciones:0,neto_pagar:null,deducciones:[],rates:{eur_usd:e.rate_eur_usd||null,gbp_usd:e.rate_gbp_usd||null,usd_cop:e.rate_usd_cop||null}});let d=L.get(t);(null!=e.rate_eur_usd||null!=e.rate_gbp_usd||null!=e.rate_usd_cop)&&(d.rates={eur_usd:e.rate_eur_usd??d.rates?.eur_usd??null,gbp_usd:e.rate_gbp_usd??d.rates?.gbp_usd??null,usd_cop:e.rate_usd_cop??d.rates?.usd_cop??null});let i={eur_usd:e.rate_eur_usd??d.rates?.eur_usd??1.01,gbp_usd:e.rate_gbp_usd??d.rates?.gbp_usd??1.2,usd_cop:e.rate_usd_cop??d.rates?.usd_cop??3900},s="superfoon"===String(e.platform_id||"").toLowerCase().replace(/[^a-z0-9]/g,"")?100:A,l=null!=e.value_usd_bruto?Number(e.value_usd_bruto):null,u=null,_=null;if(null===l){let t=a?.currency||"USD";l=((e,t,a,o)=>{let r=String(t||"").toLowerCase().replace(/[^a-z0-9]/g,"");if("EUR"===a)return"big7"===r?e*o.eur_usd*.84:"mondo"===r?e*o.eur_usd*.78:e*o.eur_usd;if("GBP"===a)return"aw"===r?e*o.gbp_usd*.677:e*o.gbp_usd;if("USD"===a)return"cmd"===r||"camlust"===r||"skypvt"===r?.75*e:"chaturbate"===r||"myfreecams"===r||"stripchat"===r?.05*e:"dxlive"===r?.6*e:"secretfriends"===r?.5*e:e;return 0})(r,e.platform_id,t,i)}_=(u=s/100*l)*i.usd_cop;let n=l??0,c=u??0,p=_??0;d.platforms.push({platform_id:e.platform_id,platform_name:a?.name||e.platform_id,platform_currency:a?.currency||"USD",value:r,value_usd_bruto:n,value_usd_modelo:c,value_cop_modelo:p,platform_percentage:s,rates:{eur_usd:i.eur_usd,gbp_usd:i.gbp_usd,usd_cop:i.usd_cop}}),d.total_value+=r,d.total_usd_bruto+=n,d.total_usd_modelo+=c,d.total_cop_modelo+=p});let{data:C,error:S}=await l.from("calculator_totals").select("period_date, total_usd_bruto, total_usd_modelo, total_cop_modelo, updated_at").eq("model_id",a).gte("period_date","2025-12-01").lte("period_date","2025-12-15").order("period_date",{ascending:!1}),{data:R,error:I}=await l.from("calculator_totals").select("period_date, total_usd_bruto, total_usd_modelo, total_cop_modelo, updated_at").eq("model_id",a).gte("period_date","2024-12-01").lte("period_date","2024-12-15").order("period_date",{ascending:!1}),T=[...C||[],...(R||[]).map(e=>({...e,period_date:e.period_date.replace("2024-","2025-")}))];if(!(S||I)&&T&&T.length>0){console.warn(`âš ï¸ [CALCULATOR-HISTORIAL] RECONSTRUCCI\xd3N DE EMERGENCIA ACTIVADA para modelo ${a}`),console.warn(`   Se encontraron ${T.length} per\xedodos en calculator_totals que no est\xe1n en calculator_history`),console.warn(`   Esto indica que el proceso de cierre fall\xf3. Reconstruyendo desde calculator_totals...`),console.warn(`   NOTA: Los per\xedodos reconstruidos solo incluyen totales consolidados, sin detalle por plataforma`),console.log(`ðŸ”§ [CALCULATOR-HISTORIAL] Encontrados ${T.length} totales en calculator_totals para per\xedodos faltantes`);let{data:e}=await l.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),t={eur_usd:e?.find(e=>"EURâ†’USD"===e.kind)?.value||1.01,gbp_usd:e?.find(e=>"GBPâ†’USD"===e.kind)?.value||1.2,usd_cop:e?.find(e=>"USDâ†’COP"===e.kind)?.value||3900},o=T.find(e=>String(e.period_date).endsWith("-12-15"))||T[0];if(o){let e=o.period_date,a="1-15",r=`${e}-${a}`;L.has(r)||(console.log(`ðŸ”§ [CALCULATOR-HISTORIAL] Creando per\xedodo sint\xe9tico consolidado para ${r} desde calculator_totals`),L.set(r,{period_date:e,period_type:a,archived_at:o.updated_at||new Date().toISOString(),platforms:[],total_value:0,total_usd_bruto:Number(o.total_usd_bruto)||0,total_usd_modelo:Number(o.total_usd_modelo)||0,total_cop_modelo:Number(o.total_cop_modelo)||0,total_anticipos:0,total_deducciones:0,neto_pagar:null,deducciones:[],rates:{eur_usd:t.eur_usd,gbp_usd:t.gbp_usd,usd_cop:t.usd_cop},is_synthetic:!0,synthetic_note:"Per\xedodo reconstruido desde totales (sin desglose por plataforma)"}))}}let U=Array.from(L.values()),q=U.map(e=>e.period_date);if(q.length>0){let{data:e,error:t}=await l.from("calculator_notifications").select("id, notification_type, notification_data, period_date, created_at, read_at").eq("model_id",a).in("period_date",q);if(!t&&e){let t=new Map;e.forEach(e=>{let a=e.period_date;t.has(a)||t.set(a,[]),t.get(a).push(e)}),U.forEach(e=>{let a=e.period_date,o=t.get(a)||[];e.alerts=o.filter(e=>{let t=e.notification_type;return"periodo_cerrado"===t||"calculator_cleared"===t||"period_closed"===t||"value_correction"===t||"quota_alert"===t}).map(e=>({id:e.id,type:e.notification_type,message:e.notification_data?.message||e.notification_data?.body||"Notificaci\xf3n del per\xedodo",created_at:e.created_at,read_at:e.read_at,data:e.notification_data})).sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime());let r=e.total_usd_bruto||0,d=w>0?r/w*100:0;e.cuota_minima=w,e.porcentaje_alcanzado=Math.round(100*d)/100,e.esta_por_debajo=r<w})}}let E=U.filter(e=>!e.rates?.eur_usd&&!e.rates?.gbp_usd&&!e.rates?.usd_cop);if(E.length>0){let{data:e,error:t}=await l.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1});if(!t&&e){let t={eur_usd:e.find(e=>"EURâ†’USD"===e.kind)?.value||1.01,gbp_usd:e.find(e=>"GBPâ†’USD"===e.kind)?.value||1.2,usd_cop:e.find(e=>"USDâ†’COP"===e.kind)?.value||3900};E.forEach(e=>{e.rates={eur_usd:t.eur_usd,gbp_usd:t.gbp_usd,usd_cop:t.usd_cop}})}}if(q.length>0){let{data:e,error:t}=await l.from("periods").select("id, start_date").in("start_date",q);if(!t&&e&&e.length>0){let t=new Map(e.map(e=>[e.start_date,e.id])),o=e.map(e=>e.id),{data:r,error:d}=await l.from("anticipos").select("period_id, monto_solicitado").eq("model_id",a).in("period_id",o).in("estado",["aprobado","realizado","confirmado"]);if(!d&&r){let e=new Map;r.forEach(t=>{let a=e.get(t.period_id)||0;e.set(t.period_id,a+Number(t.monto_solicitado))}),U.forEach(a=>{let o=t.get(a.period_date);if(o){let t=e.get(o)||0;a.total_anticipos=t}})}}}if(q.length>0)try{let{data:e,error:t}=await l.from("calculator_deductions").select("*").eq("model_id",a).in("period_date",q);if(!t&&e){let t=new Map;e.forEach(e=>{let a=`${e.period_date}-${e.period_type}`;t.has(a)||t.set(a,[]),t.get(a).push(e)}),U.forEach(e=>{let a=`${e.period_date}-${e.period_type}`,o=t.get(a)||[];e.deducciones=o,e.total_deducciones=o.reduce((e,t)=>e+Number(t.amount),0)})}}catch(e){console.warn("âš ï¸ [CALCULATOR-HISTORIAL] No se pudieron cargar deducciones manuales:",e)}U.forEach(e=>{void 0===e.total_anticipos&&(e.total_anticipos=0),void 0===e.total_deducciones&&(e.total_deducciones=0);let t=e.total_cop_modelo-e.total_anticipos-e.total_deducciones;e.neto_pagar=Math.max(0,t)});let O=U.sort((e,t)=>{let a=new Date(e.period_date),o=new Date(t.period_date);return a.getTime()!==o.getTime()?o.getTime()-a.getTime():"1-15"===e.period_type?-1:1});return s.Z.json({success:!0,periods:O,total_periods:O.length})}catch(e){return console.error("âŒ [CALCULATOR-HISTORIAL] Error:",e),s.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let n=new r.AppRouteRouteModule({definition:{kind:d.x.APP_ROUTE,page:"/api/model/calculator/historial/route",pathname:"/api/model/calculator/historial",filename:"route",bundlePath:"app/api/model/calculator/historial/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\model\\calculator\\historial\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:f,staticGenerationBailout:g}=n,h="/api/model/calculator/historial/route";function v(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[1638,6206,2964],()=>a(90346));module.exports=o})();