"use strict";(()=>{var r={};r.id=5097,r.ids=[5097],r.modules={30517:r=>{r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:r=>{r.exports=require("crypto")},13685:r=>{r.exports=require("http")},95687:r=>{r.exports=require("https")},85477:r=>{r.exports=require("punycode")},12781:r=>{r.exports=require("stream")},57310:r=>{r.exports=require("url")},59796:r=>{r.exports=require("zlib")},49569:(r,e,t)=>{t.r(e),t.d(e,{headerHooks:()=>E,originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>y});var a={};t.r(a),t.d(a,{GET:()=>m,POST:()=>_});var o=t(95419),s=t(69108),n=t(99678),i=t(78070),d=t(72964),u=t(5218);let p="https://mhernfrkvwigxdubiozm.supabase.co",c=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(r){let e=r.headers.get("authorization");if(!e||!e.startsWith("Bearer "))return{error:"Token de autenticaci\xf3n requerido",user:null};let t=e.substring(7),a=(0,d.createClient)(p,c,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:o},error:s}=await a.auth.getUser(t);if(s||!o)return{error:"Token inv\xe1lido o expirado",user:null};let{data:n,error:i}=await a.from("users").select("role").eq("id",o.id).single();return i||!n?{error:"Error obteniendo datos de usuario",user:null}:["admin","super_admin","modelo"].includes(n.role)?{error:null,user:{id:o.id,role:n.role}}:{error:"No autorizado",user:null}}async function m(r){try{let e;let t=await l(r);if(t.error)return i.Z.json({error:t.error},{status:401});let{searchParams:a}=new URL(r.url),o=a.get("platform_id"),s=a.get("model_id");if(!o||!s)return i.Z.json({error:"platform_id y model_id son requeridos"},{status:400});let n=(0,d.createClient)(p,c,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:m,error:_}=await n.from("modelo_plataformas").select("id, app_3cx_username, app_3cx_password_encrypted").eq("model_id",s).eq("platform_id",o).maybeSingle();if(_)return console.error("Error verificando plataforma:",_),i.Z.json({error:_.message},{status:500});if(!m)return i.Z.json({error:"Plataforma no encontrada para este modelo"},{status:404});if(!m.app_3cx_username||!m.app_3cx_password_encrypted)return i.Z.json({success:!0,data:{app_3cx_username:null,app_3cx_password:null,hasCredentials:!1}});try{e=(0,u.pe)(m.app_3cx_password_encrypted)}catch(r){return console.error("Error desencriptando contrase\xf1a 3CX:",r),i.Z.json({error:"Error desencriptando contrase\xf1a"},{status:500})}return i.Z.json({success:!0,data:{app_3cx_username:m.app_3cx_username,app_3cx_password:e,hasCredentials:!0}})}catch(r){return console.error("Error in GET /api/modelo-plataformas/credentials-3cx:",r),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function _(r){try{let e;let t=await l(r);if(t.error)return i.Z.json({error:t.error},{status:401});if("admin"!==t.user.role&&"super_admin"!==t.user.role)return i.Z.json({error:"Solo los administradores pueden editar credenciales de 3CX"},{status:403});let{platform_id:a,model_id:o,app_3cx_username:s,app_3cx_password:n}=await r.json();if(!a||!o)return i.Z.json({error:"platform_id y model_id son requeridos"},{status:400});if(!s||!n)return i.Z.json({error:"app_3cx_username y app_3cx_password son requeridos"},{status:400});let m=(0,d.createClient)(p,c,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:_,error:f}=await m.from("modelo_plataformas").select("id, status").eq("model_id",o).eq("platform_id",a).maybeSingle();if(f)return console.error("Error verificando plataforma:",f),i.Z.json({error:f.message},{status:500});if(!_)return i.Z.json({error:"Plataforma no encontrada para este modelo"},{status:404});try{e=(0,u.HI)(n)}catch(r){return console.error("Error encriptando contrase\xf1a 3CX:",r),i.Z.json({error:"Error encriptando contrase\xf1a"},{status:500})}let{data:h,error:x}=await m.from("modelo_plataformas").update({app_3cx_username:s,app_3cx_password_encrypted:e,app_3cx_credentials_updated_at:new Date().toISOString(),app_3cx_credentials_updated_by:t.user.id,updated_at:new Date().toISOString()}).eq("model_id",o).eq("platform_id",a).select("id, app_3cx_username, app_3cx_credentials_updated_at").single();if(x)return console.error("Error guardando credenciales 3CX:",x),i.Z.json({error:x.message},{status:500});return i.Z.json({success:!0,message:"Credenciales de 3CX guardadas correctamente",data:{id:h.id,app_3cx_username:h.app_3cx_username,app_3cx_credentials_updated_at:h.app_3cx_credentials_updated_at}})}catch(r){return console.error("Error in POST /api/modelo-plataformas/credentials-3cx:",r),i.Z.json({error:"Error interno del servidor"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/modelo-plataformas/credentials-3cx/route",pathname:"/api/modelo-plataformas/credentials-3cx",filename:"route",bundlePath:"app/api/modelo-plataformas/credentials-3cx/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\modelo-plataformas\\credentials-3cx\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:g,headerHooks:E,staticGenerationBailout:y}=f,w="/api/modelo-plataformas/credentials-3cx/route";function b(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:x})}},5218:(r,e,t)=>{t.d(e,{HI:()=>d,pe:()=>u});var a=t(6113),o=t.n(a);let s=process.env.ENCRYPTION_KEY||"default-encryption-key-change-in-production-32-chars!!",n=()=>{let r;return r=s.length>=32?s.substring(0,32):o().createHash("sha256").update(s).digest().toString("hex").substring(0,32),Buffer.from(r,"utf8")},i="aes-256-gcm";function d(r){try{if(!r)throw Error("Texto vac\xedo para encriptar");let e=n(),t=o().randomBytes(16),a=o().randomBytes(64),s=o().pbkdf2Sync(e,a,1e5,32,"sha256"),d=o().createCipheriv(i,s,t),u=d.update(r,"utf8","base64");u+=d.final("base64");let p=d.getAuthTag();return[a.toString("base64"),t.toString("base64"),p.toString("base64"),u].join(":")}catch(r){throw console.error("❌ [ENCRYPTION] Error encriptando:",r),Error("Error al encriptar datos")}}function u(r){try{if(!r)throw Error("Texto encriptado vac\xedo");let e=r.split(":");if(4!==e.length)throw Error("Formato de texto encriptado inv\xe1lido");let[t,a,s,d]=e,u=n(),p=Buffer.from(t,"base64"),c=Buffer.from(a,"base64"),l=Buffer.from(s,"base64"),m=o().pbkdf2Sync(u,p,1e5,32,"sha256"),_=o().createDecipheriv(i,m,c);_.setAuthTag(l);let f=_.update(d,"base64","utf8");return f+=_.final("utf8")}catch(r){throw console.error("❌ [ENCRYPTION] Error desencriptando:",r),Error("Error al desencriptar datos")}}}};var e=require("../../../../webpack-runtime.js");e.C(r);var t=r=>e(e.s=r),a=e.X(0,[1638,6206,2964],()=>t(49569));module.exports=a})();