"use strict";(()=>{var e={};e.id=6311,e.ids=[6311],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},4015:(e,a,r)=>{r.r(a),r.d(a,{headerHooks:()=>q,originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>_,serverHooks:()=>b,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>v});var t={};r.r(t),r.d(t,{DELETE:()=>f,GET:()=>c,POST:()=>u,PUT:()=>p});var o=r(95419),i=r(69108),s=r(99678),n=r(78070),l=r(72964),d=r(37863);let m=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"");async function c(e){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{searchParams:a}=new URL(e.url),r=a.get("model_id"),t=a.get("group_id"),o=a.get("room_id"),i=a.get("jornada"),s=a.get("platform_id"),l=a.get("status"),d=m.from("modelo_plataformas_detailed").select("*");if(r&&(d=d.eq("model_id",r)),t&&(d=d.eq("group_id",t)),s&&(d=d.eq("platform_id",s)),l&&(d=d.eq("status",l)),o||i){let{data:e}=await m.from("room_assignments_detailed").select("model_id").eq(o?"room_id":"id",o||"").eq(i?"jornada":"id",i||"");if(e&&e.length>0){let a=e.map(e=>e.model_id);d=d.in("model_id",a)}}if(!r){let{data:e}=await m.from("users").select("id").eq("role","modelo"),a=(e||[]).map(e=>e.id);if(!(a.length>0))return n.Z.json([]);d=d.in("model_id",a)}let{data:c,error:u}=await d.order("model_name",{ascending:!0});if(u)return console.error("Error fetching modelo plataformas:",u),n.Z.json({error:u.message},{status:500});return n.Z.json(c||[])}catch(e){return console.error("Error in GET /api/modelo-plataformas:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}async function u(e){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{model_id:a,platform_id:r,new_status:t,changed_by:o,reason:i,notes:s}=await e.json();if(!a||!r||!t||!o)return n.Z.json({error:"Faltan campos requeridos: model_id, platform_id, new_status, changed_by"},{status:400});if(!["disponible","solicitada","pendiente","entregada","desactivada","inviable"].includes(t))return n.Z.json({error:"Estado inv\xe1lido"},{status:400});let l=async e=>{let{data:a}=await m.from("calculator_platforms").select("id, name").eq("id",e).maybeSingle();if(a)return a.id;let{data:r}=await m.from("calculator_platforms").select("id, name").ilike("id",e).maybeSingle();if(r)return r.id;let{data:t}=await m.from("calculator_platforms").select("id, name").eq("name",e).maybeSingle();if(t)return t.id;let o=e.replace(/\s+/g,""),{data:i}=await m.from("calculator_platforms").select("id, name").ilike("name",`%${o}%`).maybeSingle();return i?i.id:e},c=await l(r),{data:u,error:p}=await m.rpc("change_platform_status",{p_model_id:a,p_platform_id:c,p_new_status:t,p_changed_by:o,p_reason:i||s||null});if(p)return console.error("Error changing platform status:",p),n.Z.json({error:p.message},{status:500});try{let{data:e}=await m.from("calculator_platforms").select("name").eq("id",c).single(),{data:o}=await m.from("users").select("name").eq("id",a).single(),i=e?.name||r;"entregada"===t?(await (0,d.c_)(a,i),console.log("✅ [PLATAFORMAS] Notificaci\xf3n de plataforma entregada enviada")):"disponible"===t&&u&&(await (0,d.d6)(a,i),console.log("✅ [PLATAFORMAS] Notificaci\xf3n de plataforma agregada enviada"))}catch(e){console.warn("⚠️ [PLATAFORMAS] Error enviando notificaci\xf3n:",e)}let f=new Date().toISOString();if("disponible"===t){let{data:e}=await m.from("calculator_config").select("id, enabled_platforms").eq("model_id",a).eq("active",!0).maybeSingle();if(e&&Array.isArray(e.enabled_platforms)){let a=e.enabled_platforms.filter(e=>e!==c);await m.from("calculator_config").update({enabled_platforms:a,updated_at:f}).eq("id",e.id)}await m.from("modelo_plataformas").update({calculator_sync:!1,calculator_activated_at:null}).eq("model_id",a).eq("platform_id",c)}else if("confirmada"===t){let{data:e,error:r}=await m.from("calculator_config").select("id, enabled_platforms").eq("model_id",a).eq("active",!0).maybeSingle();if(!r&&e){let a=Array.isArray(e.enabled_platforms)?e.enabled_platforms:[];if(!a.includes(c)){let r=[...a,c];await m.from("calculator_config").update({enabled_platforms:r,updated_at:f}).eq("id",e.id)}}}return n.Z.json({success:!0,message:`Estado cambiado a ${t}`})}catch(e){return console.error("Error in POST /api/modelo-plataformas:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}async function p(e){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{id:a,notes:r,revert_reason:t}=await e.json();if(!a)return n.Z.json({error:"ID de plataforma requerido"},{status:400});let o={};void 0!==r&&(o.notes=r),void 0!==t&&(o.revert_reason=t);let{data:i,error:s}=await m.from("modelo_plataformas").update(o).eq("id",a).select();if(s)return console.error("Error updating modelo plataforma:",s),n.Z.json({error:s.message},{status:500});return n.Z.json({success:!0,data:i?.[0]})}catch(e){return console.error("Error in PUT /api/modelo-plataformas:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}async function f(e){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{searchParams:a}=new URL(e.url),r=a.get("id");if(!r)return n.Z.json({error:"ID de plataforma requerido"},{status:400});let{error:t}=await m.from("modelo_plataformas").delete().eq("id",r);if(t)return console.error("Error deleting modelo plataforma:",t),n.Z.json({error:t.message},{status:500});return n.Z.json({success:!0,message:"Plataforma eliminada"})}catch(e){return console.error("Error in DELETE /api/modelo-plataformas:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/modelo-plataformas/route",pathname:"/api/modelo-plataformas",filename:"route",bundlePath:"app/api/modelo-plataformas/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\modelo-plataformas\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:b,headerHooks:q,staticGenerationBailout:v}=_,w="/api/modelo-plataformas/route";function S(){return(0,s.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:E})}}};var a=require("../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[1638,6206,2964,7863],()=>r(4015));module.exports=t})();