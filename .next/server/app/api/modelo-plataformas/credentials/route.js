"use strict";(()=>{var e={};e.id=3904,e.ids=[3904],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},58087:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>b,originalPathname:()=>q,patchFetch:()=>S,requestAsyncStorage:()=>E,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>j});var o={};t.r(o),t.d(o,{DELETE:()=>g,GET:()=>f,POST:()=>_,dynamic:()=>u});var a=t(95419),s=t(69108),n=t(99678),i=t(78070),l=t(72964),d=t(5218);let u="force-dynamic",c="https://mhernfrkvwigxdubiozm.supabase.co",p=process.env.SUPABASE_SERVICE_ROLE_KEY;async function m(e,r=!1){let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return{error:"No autorizado",user:null};let o=t.split(" ")[1],a=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:s},error:n}=await a.auth.getUser(o);if(n||!s)return{error:"Token inv\xe1lido",user:null};let{data:i,error:d}=await a.from("users").select("role").eq("id",s.id).single();if(d||!i)return{error:"Error obteniendo datos de usuario",user:null};let u=["admin","super_admin"];return(r&&u.push("modelo"),u.includes(i.role))?{error:null,user:{id:s.id,role:i.role}}:{error:"No autorizado",user:null}}async function f(e){try{let r=await m(e,!0);if(r.error)return i.Z.json({error:r.error},{status:401});let{searchParams:t}=new URL(e.url),o=t.get("platform_id"),a=t.get("model_id");if(!o||!a)return i.Z.json({error:"platform_id y model_id son requeridos"},{status:400});if("modelo"===r.user.role&&r.user.id!==a)return i.Z.json({error:"No autorizado: solo puedes ver tus propias credenciales"},{status:403});let s=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:n,error:u}=await s.from("calculator_platforms").select("login_url").eq("id",o).single(),f=n?.login_url||null,{data:_,error:g}=await s.from("modelo_plataformas").select("id, login_username, login_password_encrypted, credentials_updated_at, credentials_updated_by").eq("model_id",a).eq("platform_id",o).maybeSingle();if(g)return console.error("Error obteniendo credenciales:",g),i.Z.json({error:g.message},{status:500});if(!_)return i.Z.json({success:!0,hasCredentials:!1,data:{login_url:f,login_username:null,login_password:null}});let h=null;if(_.login_password_encrypted)try{h=(0,d.pe)(_.login_password_encrypted)}catch(e){return console.error("Error desencriptando contrase\xf1a:",e),i.Z.json({error:"Error desencriptando contrase\xf1a"},{status:500})}return i.Z.json({success:!0,hasCredentials:!!(_.login_username&&_.login_password_encrypted),data:{id:_.id,login_url:f,login_username:_.login_username,login_password:h,credentials_updated_at:_.credentials_updated_at,credentials_updated_by:_.credentials_updated_by}})}catch(e){return console.error("Error in GET /api/modelo-plataformas/credentials:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function _(e){try{let r;let t=await m(e);if(t.error)return i.Z.json({error:t.error},{status:401});let{platform_id:o,model_id:a,login_username:s,login_password:n}=await e.json();if(!o||!a)return i.Z.json({error:"platform_id y model_id son requeridos"},{status:400});if(!s||!n)return i.Z.json({error:"login_username y login_password son requeridos"},{status:400});let u=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:f,error:_}=await u.from("calculator_platforms").select("login_url").eq("id",o).single();if(_||!f)return i.Z.json({error:"Plataforma no encontrada en el cat\xe1logo"},{status:404});if(!f.login_url)return i.Z.json({error:'La plataforma no tiene URL de login configurado. Config\xfaralo en "Gesti\xf3n de Plataformas"'},{status:400});let g=f.login_url;try{r=(0,d.HI)(n)}catch(e){return console.error("Error encriptando contrase\xf1a:",e),i.Z.json({error:"Error encriptando contrase\xf1a"},{status:500})}let{data:h,error:E}=await u.from("modelo_plataformas").select("id, status").eq("model_id",a).eq("platform_id",o).maybeSingle();if(E)return console.error("Error verificando plataforma:",E),i.Z.json({error:E.message},{status:500});if(!h)return i.Z.json({error:"Plataforma no encontrada para este modelo"},{status:404});let{data:y,error:w}=await u.from("modelo_plataformas").update({login_username:s,login_password_encrypted:r,credentials_updated_at:new Date().toISOString(),credentials_updated_by:t.user.id,updated_at:new Date().toISOString()}).eq("model_id",a).eq("platform_id",o).select("id, login_username, credentials_updated_at").single();if(w)return console.error("Error guardando credenciales:",w),i.Z.json({error:w.message},{status:500});return i.Z.json({success:!0,message:"Credenciales guardadas correctamente",data:{id:y.id,login_url:g,login_username:y.login_username,credentials_updated_at:y.credentials_updated_at}})}catch(e){return console.error("Error in POST /api/modelo-plataformas/credentials:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function g(e){try{let r=await m(e);if(r.error)return i.Z.json({error:r.error},{status:401});let{searchParams:t}=new URL(e.url),o=t.get("platform_id"),a=t.get("model_id");if(!o||!a)return i.Z.json({error:"platform_id y model_id son requeridos"},{status:400});let s=(0,l.createClient)(c,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),{error:n}=await s.from("modelo_plataformas").update({login_username:null,login_password_encrypted:null,credentials_updated_at:null,credentials_updated_by:null,updated_at:new Date().toISOString()}).eq("model_id",a).eq("platform_id",o);if(n)return console.error("Error eliminando credenciales:",n),i.Z.json({error:n.message},{status:500});return i.Z.json({success:!0,message:"Credenciales eliminadas correctamente"})}catch(e){return console.error("Error in DELETE /api/modelo-plataformas/credentials:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/modelo-plataformas/credentials/route",pathname:"/api/modelo-plataformas/credentials",filename:"route",bundlePath:"app/api/modelo-plataformas/credentials/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\modelo-plataformas\\credentials\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:E,staticGenerationAsyncStorage:y,serverHooks:w,headerHooks:b,staticGenerationBailout:j}=h,q="/api/modelo-plataformas/credentials/route";function S(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},5218:(e,r,t)=>{t.d(r,{HI:()=>l,pe:()=>d});var o=t(6113),a=t.n(o);let s=process.env.ENCRYPTION_KEY||"default-encryption-key-change-in-production-32-chars!!",n=()=>{let e;return e=s.length>=32?s.substring(0,32):a().createHash("sha256").update(s).digest().toString("hex").substring(0,32),Buffer.from(e,"utf8")},i="aes-256-gcm";function l(e){try{if(!e)throw Error("Texto vac\xedo para encriptar");let r=n(),t=a().randomBytes(16),o=a().randomBytes(64),s=a().pbkdf2Sync(r,o,1e5,32,"sha256"),l=a().createCipheriv(i,s,t),d=l.update(e,"utf8","base64");d+=l.final("base64");let u=l.getAuthTag();return[o.toString("base64"),t.toString("base64"),u.toString("base64"),d].join(":")}catch(e){throw console.error("❌ [ENCRYPTION] Error encriptando:",e),Error("Error al encriptar datos")}}function d(e){try{if(!e)throw Error("Texto encriptado vac\xedo");let r=e.split(":");if(4!==r.length)throw Error("Formato de texto encriptado inv\xe1lido");let[t,o,s,l]=r,d=n(),u=Buffer.from(t,"base64"),c=Buffer.from(o,"base64"),p=Buffer.from(s,"base64"),m=a().pbkdf2Sync(d,u,1e5,32,"sha256"),f=a().createDecipheriv(i,m,c);f.setAuthTag(p);let _=f.update(l,"base64","utf8");return _+=f.final("utf8")}catch(e){throw console.error("❌ [ENCRYPTION] Error desencriptando:",e),Error("Error al desencriptar datos")}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(58087));module.exports=o})();