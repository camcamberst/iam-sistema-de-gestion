"use strict";(()=>{var e={};e.id=8036,e.ids=[8036],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},67237:(e,a,r)=>{r.r(a),r.d(a,{headerHooks:()=>_,originalPathname:()=>h,patchFetch:()=>b,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var t={};r.r(t),r.d(t,{GET:()=>d,PUT:()=>m});var o=r(95419),l=r(69108),s=r(99678),n=r(78070);let i=(0,r(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"");async function d(e,{params:a}){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{modelId:e}=a;if(!e)return n.Z.json({error:"ID de modelo requerido"},{status:400});let{data:r,error:t}=await i.from("users").select("role").eq("id",e).single();if(t||!r||"modelo"!==r.role)return n.Z.json([]);let{data:o,error:l}=await i.from("modelo_plataformas_detailed").select("*").eq("model_id",e).order("platform_name",{ascending:!0});if(l)return console.error("Error fetching existing platforms:",l),n.Z.json({error:l.message},{status:500});let{data:s,error:d}=await i.from("calculator_platforms").select("id, name").order("name",{ascending:!0});if(d)return console.error("Error fetching catalog platforms:",d),n.Z.json({error:d.message},{status:500});let m=new Map(o?.map(e=>[e.platform_id,e])||[]),c=s?.map(a=>m.get(a.id)||{id:null,model_id:e,platform_id:a.id,platform_name:a.name,platform_code:a.id,status:"disponible",requested_at:null,delivered_at:null,confirmed_at:null,deactivated_at:null,reverted_at:null,requested_by_name:null,delivered_by_name:null,confirmed_by_name:null,deactivated_by_name:null,reverted_by_name:null,notes:null,revert_reason:null,is_initial_config:!1,calculator_sync:!1,calculator_activated_at:null,created_at:null,updated_at:null})||[];return n.Z.json(c)}catch(e){return console.error("Error in GET /api/modelo-plataformas/[modelId]:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}async function m(e,{params:a}){try{if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return n.Z.json({error:"Configuraci\xf3n de base de datos no disponible"},{status:503});let{modelId:r}=a,{platforms:t,changed_by:o}=await e.json();if(!r||!t||!Array.isArray(t)||!o)return n.Z.json({error:"Faltan campos requeridos: modelId, platforms (array), changed_by"},{status:400});let l=[],s=[];for(let e of t){let{platform_id:a,new_status:t,reason:n}=e;if(!a||!t){s.push(`Plataforma ${a}: faltan campos requeridos`);continue}try{let e=async e=>{let{data:a}=await i.from("calculator_platforms").select("id, name").eq("id",e).maybeSingle();if(a)return a.id;let{data:r}=await i.from("calculator_platforms").select("id, name").ilike("id",e).maybeSingle();if(r)return r.id;let{data:t}=await i.from("calculator_platforms").select("id, name").eq("name",e).maybeSingle();if(t)return t.id;let o=e.replace(/\s+/g,""),{data:l}=await i.from("calculator_platforms").select("id, name").ilike("name",`%${o}%`).maybeSingle();return l?l.id:e},d=await e(a),{data:m,error:c}=await i.rpc("change_platform_status",{p_model_id:r,p_platform_id:d,p_new_status:t,p_changed_by:o,p_reason:n||null});if(c)s.push(`Plataforma ${a}: ${c.message}`);else if(l.push({platform_id:d,status:t,success:!0}),"confirmada"===t)try{let e=new Date().toISOString(),{data:a,error:t}=await i.from("calculator_config").select("id, enabled_platforms").eq("model_id",r).eq("active",!0).maybeSingle();if(t&&"PGRST116"!==t.code&&console.warn("[modelo-plataformas][PUT] Error leyendo calculator_config:",t.message),a){let r=Array.isArray(a.enabled_platforms)?a.enabled_platforms:[];if(!r.includes(d)){let t=[...r,d],{error:o}=await i.from("calculator_config").update({enabled_platforms:t,updated_at:e}).eq("id",a.id);o&&console.warn("[modelo-plataformas][PUT] No se pudo actualizar enabled_platforms:",o.message)}}else{let{error:a}=await i.from("calculator_config").insert({model_id:r,active:!0,enabled_platforms:[d],created_at:e,updated_at:e});a&&console.warn("[modelo-plataformas][PUT] No se pudo crear calculator_config:",a.message)}}catch(e){console.warn("[modelo-plataformas][PUT] Error sincronizando calculadora:",e?.message||e)}}catch(e){s.push(`Plataforma ${a}: Error inesperado`)}}return n.Z.json({success:0===s.length,results:l,errors:s,message:`Procesadas ${l.length} plataformas${s.length>0?` con ${s.length} errores`:""}`})}catch(e){return console.error("Error in PUT /api/modelo-plataformas/[modelId]:",e),n.Z.json({error:"Error interno del servidor"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/modelo-plataformas/[modelId]/route",pathname:"/api/modelo-plataformas/[modelId]",filename:"route",bundlePath:"app/api/modelo-plataformas/[modelId]/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\modelo-plataformas\\[modelId]\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:f,headerHooks:_,staticGenerationBailout:g}=c,h="/api/modelo-plataformas/[modelId]/route";function b(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[1638,6206,2964],()=>r(67237));module.exports=t})();