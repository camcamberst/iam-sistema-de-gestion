"use strict";(()=>{var e={};e.id=1949,e.ids=[1949],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},64227:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>h,originalPathname:()=>A,patchFetch:()=>E,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>I});var a={};s.r(a),s.d(a,{GET:()=>u,POST:()=>d});var t=s(95419),n=s(69108),o=s(99678),i=s(78070);let c=(0,s(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e){try{let{searchParams:r}=new URL(e.url),s=r.get("modelId"),a=r.get("startDate"),t=r.get("endDate"),n=parseInt(r.get("limit")||"30");console.log("\uD83D\uDD0D [DAILY-EARNINGS-HISTORY] Consultando historial:",{modelId:s,startDate:a,endDate:t,limit:n});let o=c.from("daily_earnings_history").select(`
        model_id,
        earnings_date,
        earnings_amount,
        archived_at,
        users!inner(name, email)
      `).order("earnings_date",{ascending:!1}).limit(n);s&&(o=o.eq("model_id",s)),a&&(o=o.gte("earnings_date",a)),t&&(o=o.lte("earnings_date",t));let{data:u,error:d}=await o;if(d)return console.error("❌ [DAILY-EARNINGS-HISTORY] Error:",d),i.Z.json({success:!1,error:d.message||"Error consultando historial"},{status:500});let l=u?.map(e=>({modelId:e.model_id,modelName:e.users?.name||e.users?.email||"Modelo desconocido",earningsDate:e.earnings_date,earningsAmount:e.earnings_amount,archivedAt:e.archived_at}))||[];return console.log("✅ [DAILY-EARNINGS-HISTORY] Historial obtenido:",l.length,"registros"),i.Z.json({success:!0,history:l,total:l.length,filters:{modelId:s,startDate:a,endDate:t,limit:n}})}catch(e){return console.error("❌ [DAILY-EARNINGS-HISTORY] Error:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function d(e){try{let{action:r,date:s}=await e.json();if(console.log("\uD83D\uDD04 [DAILY-EARNINGS-HISTORY] Acci\xf3n manual:",{action:r,date:s}),"archive"===r){let e=s||new Date(Date.now()-864e5).toISOString().split("T")[0],{data:r,error:a}=await c.rpc("archive_daily_earnings");if(a)return console.error("❌ [DAILY-EARNINGS-HISTORY] Error archivando:",a),i.Z.json({success:!1,error:a.message||"Error archivando ganancias"},{status:500});return i.Z.json({success:!0,message:`Ganancias archivadas para la fecha ${e}`,data:r})}if("reset"!==r)return i.Z.json({success:!1,error:'Acci\xf3n no v\xe1lida. Use "archive" o "reset"'},{status:400});{let{data:e,error:r}=await c.rpc("reset_today_earnings");if(r)return console.error("❌ [DAILY-EARNINGS-HISTORY] Error reiniciando:",r),i.Z.json({success:!1,error:r.message||"Error reiniciando ganancias"},{status:500});return i.Z.json({success:!0,message:"Ganancias del d\xeda actual reiniciadas",data:e})}}catch(e){return console.error("❌ [DAILY-EARNINGS-HISTORY] Error:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let l=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/daily-earnings/history/route",pathname:"/api/daily-earnings/history",filename:"route",bundlePath:"app/api/daily-earnings/history/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\daily-earnings\\history\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:p,headerHooks:h,staticGenerationBailout:I}=l,A="/api/daily-earnings/history/route";function E(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>s(64227));module.exports=a})();