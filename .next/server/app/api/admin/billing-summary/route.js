"use strict";(()=>{var e={};e.id=8765,e.ids=[8765],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},14317:(e,o,t)=>{t.r(o),t.d(o,{headerHooks:()=>M,originalPathname:()=>S,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>D,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var r={};t.r(r),t.d(r,{GET:()=>c});var a=t(95419),d=t(69108),l=t(99678),s=t(78070),n=t(66569),i=t(13532);let u=n.R;async function c(e){let{searchParams:o}=new URL(e.url),t=o.get("sedeId"),r=o.get("periodDate")||(0,i.iR)(),a=o.get("adminId");if(!a)return s.Z.json({success:!1,error:"adminId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [BILLING-SUMMARY] Obteniendo resumen:",{sedeId:t,periodDate:r,adminId:a});let{data:e,error:o}=await u.from("users").select(`
        role,
        user_groups(
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",a).single();if(o)return console.error("❌ [BILLING-SUMMARY] Error al obtener admin:",o),s.Z.json({success:!1,error:"Admin no encontrado"},{status:404});let d="super_admin"===e.role,l="admin"===e.role;if(!d&&!l)return s.Z.json({success:!1,error:"No tienes permisos para ver este resumen"},{status:403});let n=d?[]:e.user_groups?.map(e=>e.groups.id)||[];console.log("\uD83D\uDD0D [BILLING-SUMMARY] Admin groups:",n),console.log("\uD83D\uDD0D [BILLING-SUMMARY] User role:",e.role),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Is Super Admin:",d),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Is Admin:",l);let c=u.from("users").select(`
        id, 
        email, 
        name
      `).eq("role","modelo").eq("is_active",!0);if(l&&!d&&n.length>0){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Aplicando filtros de admin para grupos:",n);let{data:e,error:o}=await u.from("user_groups").select("user_id").in("group_id",n);if(o)return console.error("❌ [BILLING-SUMMARY] Error al obtener grupos de modelos:",o),s.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});let t=e?.map(e=>e.user_id)||[];if(0===t.length)return s.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:r});c=c.in("id",t)}if(t){let{data:e,error:o}=await u.from("user_groups").select("user_id").eq("group_id",t);if(o)return console.error("❌ [BILLING-SUMMARY] Error al obtener grupos de sede:",o),s.Z.json({success:!1,error:"Error al obtener grupos de sede"},{status:500});let a=e?.map(e=>e.user_id)||[];if(0===a.length)return s.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:r});c=c.in("id",a)}let{data:p,error:m}=await c;if(m)return console.error("❌ [BILLING-SUMMARY] Error al obtener modelos:",m),s.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});if(!p||0===p.length)return s.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:r});let g=p.map(e=>e.id),{data:D,error:M}=await u.from("user_groups").select(`
        user_id,
        groups!inner(
          id,
          name,
          organization_id
        )
      `).in("user_id",g);M&&console.error("❌ [BILLING-SUMMARY] Error al obtener grupos:",M);let _=new Map;D?.forEach(e=>{e.groups&&_.set(e.user_id,e.groups)}),await (0,i.wU)(r);let{data:S,error:I}=await u.from("periods").select("id, start_date, end_date, is_active").eq("start_date",r).single();if(I)return console.error("❌ [BILLING-SUMMARY] Error al obtener per\xedodo:",I),s.Z.json({success:!1,error:"Error al obtener per\xedodo"},{status:500});let U=S.start_date,f=S.end_date,L=S.is_active?"active":"closed",h=S.is_active,A=new Date().toISOString().split("T")[0],R=A>f?A:f,E=new Date(U);E.setDate(E.getDate()-2);let B=E.toISOString().split("T")[0],C=new Date(R);C.setDate(C.getDate()+2);let w=C.toISOString().split("T")[0];console.log("\uD83D\uDD0D [BILLING-SUMMARY] Rango de b\xfasqueda:",{originalStart:U,originalEnd:f,extendedStart:B,extendedEnd:w,periodType:L,isActivePeriod:h,today:A});let G=null,y=null;if(h){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Per\xedodo activo - consultando calculator_totals");let{data:e,error:o}=await u.from("calculator_totals").select("*").in("model_id",g).gte("period_date",B).lte("period_date",w).order("period_date",{ascending:!1});o?console.error("❌ [BILLING-SUMMARY] Error al obtener totales:",o):y=e}else{console.log("\uD83D\uDD0D [BILLING-SUMMARY] Per\xedodo cerrado - consultando calculator_history");let{data:e,error:o}=await u.from("calculator_history").select("model_id, platform_id, value, period_date, period_type").in("model_id",g).gte("period_date",B).lte("period_date",w).eq("period_type",L);o?console.error("❌ [BILLING-SUMMARY] Error al verificar historial:",o):G=e}let{data:N,error:b}=await u.from("calculator_totals").select("*").in("model_id",g).eq("period_date",A).order("updated_at",{ascending:!1});b&&console.error("❌ [BILLING-SUMMARY] Error al obtener totales exactos:",b);let v=[...y||[],...N||[]].reduce((e,o)=>{let t=e.find(e=>e.model_id===o.model_id);return!t||new Date(o.updated_at)>new Date(t.updated_at)?e.filter(e=>e.model_id!==o.model_id).concat([o]):e},[]);console.log("\uD83D\uDD0D [BILLING-SUMMARY] Datos encontrados:",{historyRecords:G?.length||0,totalsRecords:v?.length||0,exactTotalsRecords:N?.length||0,historyModels:G?Array.from(new Set(G.map(e=>e.model_id))):[],totalsModels:v?Array.from(new Set(v.map(e=>e.model_id))):[],timestamp:new Date().toISOString()});let Y=new Map;G&&G.length>0&&(console.log("\uD83D\uDCDA [BILLING-SUMMARY] Procesando datos de calculator_history"),G.forEach(e=>{Y.has(e.model_id)||Y.set(e.model_id,{model_id:e.model_id,total_usd_bruto:0,total_usd_modelo:0,total_cop_modelo:0,period_date:e.period_date,dataSource:"calculator_history"});let o=Y.get(e.model_id);"_total_usd_modelo"===e.platform_id?o.total_usd_modelo=e.value||0:o.total_usd_bruto+=e.value||0}),Y.forEach((e,o)=>{0===e.total_usd_bruto&&e.total_usd_modelo>0&&(e.total_usd_bruto=1.4*e.total_usd_modelo),e.total_cop_modelo=3900*e.total_usd_modelo}));let P=new Map;v&&v.length>0&&(console.log("\uD83D\uDCCA [BILLING-SUMMARY] Procesando datos de calculator_totals"),v.forEach(e=>{Y.has(e.model_id)||P.set(e.model_id,{model_id:e.model_id,total_usd_bruto:e.total_usd_bruto||0,total_usd_modelo:e.total_usd_modelo||0,total_cop_modelo:e.total_cop_modelo||0,period_date:e.period_date,dataSource:"calculator_totals"})}));let q=new Map;Y.forEach((e,o)=>q.set(o,e)),P.forEach((e,o)=>q.set(o,e));let x=Array.from(q.values());console.log("\uD83D\uDCCA [BILLING-SUMMARY] Datos finales:",{totalModels:x.length,fromHistory:Array.from(Y.keys()).length,fromTotals:Array.from(P.keys()).length});let{data:O,error:T}=await u.from("rates").select("value").eq("active",!0).eq("kind","USD→COP").order("valid_from",{ascending:!1}).limit(1).single();if(T)return console.error("❌ [BILLING-SUMMARY] Error al obtener tasas:",T),s.Z.json({success:!1,error:"Error al obtener tasas de cambio"},{status:500});let j=O?.value||3900,k=p.map(e=>{let o=(x||[]).filter(o=>o.model_id===e.id),t=_.get(e.id);if(!o||0===o.length)return{modelId:e.id,email:e.email.split("@")[0],name:e.name,groupId:t?.id,groupName:t?.name,usdBruto:0,usdModelo:0,usdSede:0,copModelo:0,copSede:0};let r=o.reduce((e,o)=>e+(o.total_usd_bruto||0),0),a=o.reduce((e,o)=>e+(o.total_usd_modelo||0),0),d=r-a,l=o[0]?.dataSource||"unknown";return console.log(`📊 [BILLING-SUMMARY] Modelo ${e.email}: USD Bruto=${r}, USD Modelo=${a}, Fuente=${l}`),{modelId:e.id,email:e.email.split("@")[0],name:e.name,groupId:t?.id,groupName:t?.name,usdBruto:r,usdModelo:a,usdSede:d,copModelo:a*j,copSede:d*j}}),Z=k.reduce((e,o)=>({totalModels:e.totalModels+1,totalUsdBruto:e.totalUsdBruto+o.usdBruto,totalUsdModelo:e.totalUsdModelo+o.usdModelo,totalUsdSede:e.totalUsdSede+o.usdSede,totalCopModelo:e.totalCopModelo+o.copModelo,totalCopSede:e.totalCopSede+o.copSede}),{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0}),$=null;if(console.log("\uD83D\uDD0D [BILLING-SUMMARY] Condiciones para groupedData:",{isSuperAdmin:d,isAdmin:l,adminGroupsLength:n.length,shouldCreateGroupedData:d||l&&n.length>0}),d||l&&n.length>0){let e=Array.from(new Set(k.map(e=>e.groupId).filter(Boolean))),{data:o,error:t}=await u.from("groups").select("id, name").in("id",e);if(t&&console.error("❌ [BILLING-SUMMARY] Error al obtener grupos:",t),d){let e={sedeId:"agencia-innova",sedeName:"Agencia Innova",groups:[],models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},t=new Map;k.forEach(r=>{let a=r.groupId;t.has(a)||t.set(a,{groupId:a,groupName:o?.find(e=>e.id===a)?.name||"Grupo Desconocido",models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0});let d=t.get(a);d.models.push(r),d.totalModels+=1,d.totalUsdBruto+=r.usdBruto,d.totalUsdModelo+=r.usdModelo,d.totalUsdSede+=r.usdSede,d.totalCopModelo+=r.copModelo,d.totalCopSede+=r.copSede,e.models.push(r),e.totalModels+=1,e.totalUsdBruto+=r.usdBruto,e.totalUsdModelo+=r.usdModelo,e.totalUsdSede+=r.usdSede,e.totalCopModelo+=r.copModelo,e.totalCopSede+=r.copSede}),e.groups=Array.from(t.values()),$=[e]}else if(l&&n.length>0){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Creando sedes individuales para admin"),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Admin groups:",n),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Billing data models:",k.length);let e=new Map;k.forEach(t=>{let r=t.groupId;if(console.log("\uD83D\uDD0D [BILLING-SUMMARY] Procesando modelo:",t.email,"grupo:",r),n.includes(r)){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Grupo asignado al admin, agregando modelo"),e.has(r)||e.set(r,{sedeId:r,sedeName:o?.find(e=>e.id===r)?.name||"Grupo Desconocido",groups:[],models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0});let a=e.get(r);a.models.push(t),a.totalModels+=1,a.totalUsdBruto+=t.usdBruto,a.totalUsdModelo+=t.usdModelo,a.totalUsdSede+=t.usdSede,a.totalCopModelo+=t.copModelo,a.totalCopSede+=t.copSede}}),$=Array.from(e.values()),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Sedes creadas para admin:",$.length),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Sedes:",$.map(e=>({id:e.sedeId,name:e.sedeName,models:e.totalModels})))}}return console.log("✅ [BILLING-SUMMARY] Resumen generado:",{models:k.length,summary:Z,groupedData:$?.length||0,isSuperAdmin:d,isAdmin:l,adminGroups:n,dataSource:"mixed (calculator_history + calculator_totals)",periodType:L,periodRange:`${U} - ${f}`,historyModels:Array.from(Y.keys()).length,totalsModels:Array.from(P.keys()).length}),s.Z.json({success:!0,data:k,summary:Z,groupedData:$,periodDate:r,sedeId:t||"all",adminRole:e.role})}catch(e){return console.error("❌ [BILLING-SUMMARY] Error:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:d.x.APP_ROUTE,page:"/api/admin/billing-summary/route",pathname:"/api/admin/billing-summary",filename:"route",bundlePath:"app/api/admin/billing-summary/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\billing-summary\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:D,headerHooks:M,staticGenerationBailout:_}=p,S="/api/admin/billing-summary/route";function I(){return(0,l.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:g})}},66569:(e,o,t)=>{t.d(o,{A:()=>s,R:()=>l});var r=t(72964);let a="https://mhernfrkvwigxdubiozm.supabase.co",d=process.env.SUPABASE_SERVICE_ROLE_KEY||"",l=(0,r.createClient)(a,d,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=(0,r.createClient)(a,d,{auth:{autoRefreshToken:!1,persistSession:!1}})},13532:(e,o,t)=>{t.d(o,{LQ:()=>l,iR:()=>a,t2:()=>s,wU:()=>n});let r=()=>(console.warn("⚠️ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),d=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),l=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},s=()=>{let e=new Date;return e.setDate(e.getDate()+1),d(e)},n=async e=>{let{createClient:o}=await t.e(2964).then(t.bind(t,72964)),a=o("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),d=e||r();try{let{data:e,error:o}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",d).eq("end_date",d).eq("is_active",!0).single();if(o&&"PGRST116"!==o.code)throw console.error("❌ [CREATE-PERIOD] Error verificando per\xedodo:",o),o;if(e)return console.log("✅ [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",d);let{data:t,error:r}=await a.from("periods").insert({name:`Per\xedodo ${d}`,start_date:d,end_date:d,is_active:!0}).select().single();if(r)throw console.error("❌ [CREATE-PERIOD] Error creando per\xedodo:",r),r;return console.log("✅ [CREATE-PERIOD] Per\xedodo creado exitosamente:",t),t}catch(e){throw console.error("❌ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var o=require("../../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),r=o.X(0,[1638,6206,2964],()=>t(14317));module.exports=r})();