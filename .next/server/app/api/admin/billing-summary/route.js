"use strict";(()=>{var e={};e.id=8765,e.ids=[8765],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},14317:(e,o,a)=>{a.r(o),a.d(o,{headerHooks:()=>S,originalPathname:()=>I,patchFetch:()=>U,requestAsyncStorage:()=>f,routeModule:()=>_,serverHooks:()=>M,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>D});var t={};a.r(t),a.d(t,{GET:()=>p});var d=a(95419),l=a(69108),r=a(99678),i=a(78070),s=a(66569),n=a(43178),u=a(13532),c=a(34196);let m=s.R;async function p(e){let{searchParams:o}=new URL(e.url),a=o.get("sedeId"),t=o.get("periodDate")||(0,u.iR)(),d=o.get("adminId"),l=o.get("emails");if(!d)return i.Z.json({success:!1,error:"adminId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [BILLING-SUMMARY] Obteniendo resumen:",{sedeId:a,periodDate:t,adminId:d,emailsParam:l});let{data:e,error:o}=await m.from("users").select(`
        role,
        affiliate_studio_id,
        user_groups(
          groups!inner(
            id,
            name
          )
        )
      `).eq("id",d).single();if(o)return console.error("‚ùå [BILLING-SUMMARY] Error al obtener admin:",o),i.Z.json({success:!1,error:"Admin no encontrado"},{status:404});let r="super_admin"===e.role,s="admin"===e.role,p="superadmin_aff"===e.role;if(!r&&!s&&!p)return i.Z.json({success:!1,error:"No tienes permisos para ver este resumen"},{status:403});let _=r||p?[]:e.user_groups?.map(e=>e.groups.id)||[];console.log("\uD83D\uDD0D [BILLING-SUMMARY] Admin groups:",_),console.log("\uD83D\uDD0D [BILLING-SUMMARY] User role:",e.role),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Affiliate Studio ID:",e.affiliate_studio_id),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Is Super Admin:",r),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Is Admin:",s),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Is Superadmin AFF:",p);let f=m.from("users").select(`
        id, 
        email, 
        name,
        affiliate_studio_id
      `).eq("role","modelo").eq("is_active",!0);if(f=f.neq("id",n.mo).neq("email",n.y6),p||s&&e.affiliate_studio_id){let o={id:d,role:e.role,affiliate_studio_id:e.affiliate_studio_id};f=(0,c.rd)(f,o),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Aplicando filtro de afiliado para affiliate_studio_id:",e.affiliate_studio_id)}if(l){let e=l.split(",").map(e=>e.trim().toLowerCase());e.length>0&&(f=f.in("email",e),console.log("\uD83D\uDD0E [BILLING-SUMMARY] Filtrando por emails:",e))}if(s&&!r&&!p&&_.length>0){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Aplicando filtros de admin para grupos:",_);let{data:e,error:o}=await m.from("user_groups").select("user_id").in("group_id",_);if(o)return console.error("‚ùå [BILLING-SUMMARY] Error al obtener grupos de modelos:",o),i.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});let a=e?.map(e=>e.user_id)||[];if(0===a.length)return i.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:t});f=f.in("id",a)}if(a){let e=a.split(",").map(e=>e.trim()).filter(Boolean),o=[];try{let{data:a}=await m.from("groups").select("id, name").in("id",e);o=a||[]}catch{}let d=[];for(let o of e)try{let{data:e}=await m.from("groups").select("id, name").ilike("name",`%${o}%`);e&&e.length>0&&d.push(...e)}catch{}let l=Array.from(new Set([...o,...d].map(e=>e.id)));if(console.log("\uD83D\uDD0E [BILLING-SUMMARY] Sedes solicitadas:",e,"‚Üí groupIds:",l),0===l.length)return i.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:t});let{data:r,error:s}=await m.from("user_groups").select("user_id").in("group_id",l);if(s)return console.error("‚ùå [BILLING-SUMMARY] Error al obtener grupos de sede:",s),i.Z.json({success:!1,error:"Error al obtener grupos de sede"},{status:500});let n=r?.map(e=>e.user_id)||[];if(console.log("\uD83D\uDD0E [BILLING-SUMMARY] Modelos en sedes:",n.length),0===n.length)return i.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:t});f=f.in("id",n)}let{data:g,error:M}=await f;if(M)return console.error("‚ùå [BILLING-SUMMARY] Error al obtener modelos:",M),i.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});if(!g||0===g.length)return i.Z.json({success:!0,data:[],summary:{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},periodDate:t});let S=g.map(e=>e.id),{data:D,error:I}=await m.from("user_groups").select(`
        user_id,
        groups!inner(
          id,
          name,
          organization_id
        )
      `).in("user_id",S);I&&console.error("‚ùå [BILLING-SUMMARY] Error al obtener grupos:",I);let U=new Map;D?.forEach(e=>{e.groups&&U.set(e.user_id,e.groups)});let h=new Date(t),L=h.getFullYear(),v=h.getMonth(),A=h.getDate(),B=new Date(L,v+1,0).getDate(),y=A<=15?`${L}-${String(v+1).padStart(2,"0")}-01`:`${L}-${String(v+1).padStart(2,"0")}-16`,b=A<=15?`${L}-${String(v+1).padStart(2,"0")}-15`:`${L}-${String(v+1).padStart(2,"0")}-${String(B).padStart(2,"0")}`,N=(0,u.iR)(),R=N>=y&&N<=b,x=R?"active":"closed";console.log("\uD83D\uDD0D [BILLING-SUMMARY] Rango de b\xfasqueda:",{originalStart:y,originalEnd:b,periodType:x,isActivePeriod:R,today:N});let E=[],$=[];if(R){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Per\xedodo activo - consultando calculator_totals (rango exacto quincena)");let{data:e,error:o}=await m.from("calculator_totals").select("*").in("model_id",S).gte("period_date",y).lte("period_date",b).order("period_date",{ascending:!1});if(o)console.error("‚ùå [BILLING-SUMMARY] Error al obtener totales:",o);else{let o=new Map;e&&e.length>0&&(e.forEach(e=>{let a=o.get(e.model_id);(!a||new Date(e.updated_at)>new Date(a.updated_at))&&o.set(e.model_id,e)}),$=Array.from(o.values()))}let a=new Set,t=new Set($?.map(e=>e.model_id)||[]),{data:d,error:l}=await m.from("model_values").select("model_id, period_date, value, updated_at").in("model_id",S).gte("period_date",y).lte("period_date",b).gt("value",0);if(!l&&d&&d.length>0){let e=new Map;if(d.forEach(o=>{e.has(o.model_id)||e.set(o.model_id,[]),e.get(o.model_id).push(o)}),e.forEach((e,o)=>{!t.has(o)&&e.some(e=>e.value>0)&&a.add(o)}),a.size>0){console.log("‚ö†Ô∏è [BILLING-SUMMARY] Detectados modelos con valores pero sin totales:",Array.from(a));let{data:e,error:o}=await m.from("model_values").select(`
              *,
              platforms!inner(id, name, currency, percentage)
            `).in("model_id",Array.from(a)).gte("period_date",y).lte("period_date",b).order("updated_at",{ascending:!1});if(!o&&e&&e.length>0){let{data:o}=await m.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),a={usd_cop:3900,eur_usd:1.01,gbp_usd:1.2};o&&o.forEach(e=>{"USD‚ÜíCOP"===e.kind&&(a.usd_cop=e.value),"EUR‚ÜíUSD"===e.kind&&(a.eur_usd=e.value),"GBP‚ÜíUSD"===e.kind&&(a.gbp_usd=e.value)});let t=[],d=new Map;e.forEach(e=>{d.has(e.model_id)||d.set(e.model_id,[]),d.get(e.model_id).push(e)});let l=Array.from(d.keys());for(let e=0;e<l.length;e++){let o=l[e],r=d.get(o)||[],{data:i}=await m.from("calculator_config").select("percentage_override, group_percentage").eq("model_id",o).eq("active",!0).single(),s=0,n=new Map;r.forEach(e=>{let o=e.platform_id;(!n.has(o)||new Date(e.updated_at)>new Date(n.get(o)?.updated_at||0))&&n.set(o,e)});let u=Array.from(n.keys());for(let e=0;e<u.length;e++){let o=u[e],t=n.get(o);if(!t)continue;let d=t.platforms;if(!d||!t.value||t.value<=0)continue;let l=0;"EUR"===d.currency?l="big7"===o?t.value*a.eur_usd*.84:"mondo"===o?t.value*a.eur_usd*.78:t.value*a.eur_usd:"GBP"===d.currency?l="aw"===o?t.value*a.gbp_usd*.677:t.value*a.gbp_usd:"USD"===d.currency&&(l=["cmd","camlust","skypvt"].includes(o)?.75*t.value:["chaturbate","myfreecams","stripchat"].includes(o)?.05*t.value:"dxlive"===o?.6*t.value:"secretfriends"===o?.5*t.value:t.value),s+=l}let c=(i?.percentage_override||i?.group_percentage||70)/100*s,p=c*a.usd_cop;t.push({model_id:o,period_date:N,total_usd_bruto:Math.round(100*s)/100,total_usd_modelo:Math.round(100*c)/100,total_cop_modelo:Math.round(p),updated_at:new Date().toISOString()})}if(t.length>0){let{data:e,error:o}=await m.from("calculator_totals").upsert(t,{onConflict:"model_id,period_date"}).select();!o&&e?($=[...$||[],...e],console.log(`‚úÖ [BILLING-SUMMARY] Sincronizados ${e.length} totales faltantes`)):o&&console.error("‚ùå [BILLING-SUMMARY] Error insertando totales:",o)}}}}E=[]}else{console.log("\uD83D\uDD0D [BILLING-SUMMARY] Per\xedodo cerrado - consultando calculator_history (rango exacto quincena)");let e=b.endsWith("-15")?"1-15":"16-31";console.log("\uD83D\uDD0D [BILLING-SUMMARY] Buscando period_type:",e,"para rango:",{startStr:y,endStr:b});let{data:o,error:a}=await m.from("calculator_history").select("model_id, platform_id, value, value_usd_bruto, value_usd_modelo, value_cop_modelo, period_date, period_type").in("model_id",S).gte("period_date",y).lte("period_date",b).eq("period_type",e);if(a?console.error("‚ùå [BILLING-SUMMARY] Error al verificar historial:",a):E=o,!E||0===E.length){console.log("‚ö†Ô∏è [BILLING-SUMMARY] calculator_history vac\xedo para per\xedodo cerrado. Intentando reconstruir desde calculator_totals...");let{data:o,error:a}=await m.from("calculator_totals").select("model_id, period_date, total_usd_bruto, total_usd_modelo, total_cop_modelo, updated_at").in("model_id",S).gte("period_date",y).lte("period_date",b).order("period_date",{ascending:!1}),[t,d]=y.split("-"),l=parseInt(t)-1,r=`${l}-${d}-${y.split("-")[2]}`,i=`${l}-${d}-${b.split("-")[2]}`,{data:s,error:n}=await m.from("calculator_totals").select("model_id, period_date, total_usd_bruto, total_usd_modelo, total_cop_modelo, updated_at").in("model_id",S).gte("period_date",r).lte("period_date",i).order("period_date",{ascending:!1});a&&console.error("‚ùå [BILLING-SUMMARY] Error buscando totals 2025:",a),n&&console.error("‚ùå [BILLING-SUMMARY] Error buscando totals 2024:",n);let u=[...o||[],...s||[]];if(u&&u.length>0){console.warn(`‚ö†Ô∏è [BILLING-SUMMARY] RECONSTRUCCI\xd3N DE EMERGENCIA ACTIVADA`),console.warn(`   El per\xedodo ${e} (${y} a ${b}) no tiene datos en calculator_history`),console.warn(`   Esto indica que el proceso de cierre fall\xf3. Reconstruyendo desde calculator_totals...`),console.warn("   NOTA: Los datos reconstruidos solo incluyen totales consolidados, sin detalle por plataforma"),console.log(`‚úÖ [BILLING-SUMMARY] Reconstruyendo desde calculator_totals: ${u.length} registros encontrados`);let o=new Map;for(let e of u){let a=o.get(e.model_id);if(!a||new Date(e.updated_at)>new Date(a.updated_at)){let a=e.period_date.startsWith(l.toString())?e.period_date.replace(l.toString(),t):e.period_date;o.set(e.model_id,{...e,period_date:a})}}let a=[];for(let[t,d]of Array.from(o.entries()))a.push({model_id:t,platform_id:"_consolidated",value:0,value_usd_bruto:d.total_usd_bruto||0,value_usd_modelo:d.total_usd_modelo||0,value_cop_modelo:d.total_cop_modelo||0,period_date:d.period_date,period_type:e,_is_synthetic:!0});E=a,console.log(`‚úÖ [BILLING-SUMMARY] Reconstrucci\xf3n completada: ${a.length} modelos con totales consolidados`)}else console.log("‚ö†Ô∏è [BILLING-SUMMARY] No se encontraron datos en calculator_totals para reconstruir")}}let C=[...$||[]].reduce((e,o)=>{let a=e.find(e=>e.model_id===o.model_id);return!a||new Date(o.updated_at)>new Date(a.updated_at)?e.filter(e=>e.model_id!==o.model_id).concat([o]):e},[]);if(console.log("\uD83D\uDD0D [BILLING-SUMMARY] Datos encontrados:",{historyRecords:E?.length||0,totalsRecords:C?.length||0,historyModels:E?Array.from(new Set(E.map(e=>e.model_id))):[],totalsModels:C?Array.from(new Set(C.map(e=>e.model_id))):[],timestamp:new Date().toISOString()}),l)try{let e=l.split(",").map(e=>e.trim().toLowerCase()),o=new Map(g.map(e=>[e.email.toLowerCase(),e.id])),a=e.map(e=>o.get(e)).filter(Boolean),t=new Set((E||[]).map(e=>e.model_id)),d=new Set((C||[]).map(e=>e.model_id));console.log("\uD83D\uDD0E [BILLING-SUMMARY] Debug por emails:",{emails:e,ids:a,inHistory:a.map(e=>({id:e,has:t.has(e)})),inTotals:a.map(e=>({id:e,has:d.has(e)}))})}catch(e){console.log("‚ö†Ô∏è [BILLING-SUMMARY] Error en debug por emails:",e)}let{data:w,error:G}=await m.from("rates").select("value").eq("active",!0).eq("kind","USD‚ÜíCOP").order("valid_from",{ascending:!1}).limit(1).single();G&&console.error("‚ùå [BILLING-SUMMARY] Error al obtener tasas:",G);let Y=w?.value||3900,q=new Map;if(E&&E.length>0){if(E.some(e=>e._is_synthetic))console.log("\uD83D\uDCDA [BILLING-SUMMARY] Procesando datos sint\xe9ticos reconstruidos desde calculator_totals"),E.forEach(e=>{e._is_synthetic&&q.set(e.model_id,{model_id:e.model_id,total_usd_bruto:e.value_usd_bruto||0,total_usd_modelo:e.value_usd_modelo||0,total_cop_modelo:e.value_cop_modelo||0,period_date:e.period_date,dataSource:"calculator_totals_reconstructed"})});else{console.log("\uD83D\uDCDA [BILLING-SUMMARY] Procesando datos de calculator_history (misma l\xf3gica que Mi Historial)"),E.forEach(e=>{q.has(e.model_id)||q.set(e.model_id,{model_id:e.model_id,total_usd_bruto:0,total_usd_modelo:0,total_cop_modelo:0,period_date:e.period_date,dataSource:"calculator_history"});let o=q.get(e.model_id);null!==e.value_usd_bruto&&void 0!==e.value_usd_bruto?o.total_usd_bruto+=Number(e.value_usd_bruto)||0:o.total_usd_bruto+=Number(e.value)||0,null!==e.value_usd_modelo&&void 0!==e.value_usd_modelo&&(o.total_usd_modelo+=Number(e.value_usd_modelo)||0),null!==e.value_cop_modelo&&void 0!==e.value_cop_modelo&&(o.total_cop_modelo+=Number(e.value_cop_modelo)||0)});let e=Array.from(q.keys()),{data:o,error:a}=await m.from("calculator_config").select("model_id, percentage_override, group_percentage").in("model_id",e);a&&console.warn("‚ö†Ô∏è [BILLING-SUMMARY] Error obteniendo configuraciones de modelos:",a);let t=new Map((o||[]).map(e=>[e.model_id,e]));q.forEach((e,o)=>{if(e.total_usd_modelo>0||e.total_cop_modelo>0){console.log(`üìä [BILLING-SUMMARY] Modelo ${o}: Usando totales ya calculados (USD Modelo=${e.total_usd_modelo.toFixed(2)})`);return}let a=t.get(o),d=a?.percentage_override||a?.group_percentage||80;e.total_usd_modelo=e.total_usd_bruto*(d/100),e.total_cop_modelo=e.total_usd_modelo*(Y||3900),console.log(`üìä [BILLING-SUMMARY] Modelo ${o}: USD Bruto=${e.total_usd_bruto.toFixed(2)}, Porcentaje=${d}%, USD Modelo=${e.total_usd_modelo.toFixed(2)}`)})}}let F=new Map;C&&C.length>0&&(console.log("\uD83D\uDCCA [BILLING-SUMMARY] Procesando datos de calculator_totals"),C.forEach(e=>{q.has(e.model_id)||F.set(e.model_id,{model_id:e.model_id,total_usd_bruto:e.total_usd_bruto||0,total_usd_modelo:e.total_usd_modelo||0,total_cop_modelo:e.total_cop_modelo||0,period_date:e.period_date,dataSource:"calculator_totals"})}));let P=new Map;q.forEach((e,o)=>P.set(o,e)),F.forEach((e,o)=>P.set(o,e));let T=Array.from(P.values());g.map(e=>[e.id,e]),console.log("\uD83D\uDCCA [BILLING-SUMMARY] Datos finales:",{totalModels:T.length,fromHistory:Array.from(q.keys()).length,fromTotals:Array.from(F.keys()).length});let k=new Map;if(g.some(e=>e.affiliate_studio_id)){let e=new Set;g.filter(e=>e.affiliate_studio_id).forEach(o=>{o.affiliate_studio_id&&e.add(o.affiliate_studio_id)});let o=Array.from(e),{data:a}=await m.from("affiliate_studios").select("id, commission_percentage").in("id",o).eq("is_active",!0);a&&a.forEach(e=>{let o=e.commission_percentage?parseFloat(e.commission_percentage.toString())/100:.1;k.set(e.id,o)})}let z=g.map(o=>{let a,t;let d=(T||[]).filter(e=>e.model_id===o.id),l=U.get(o.id),r=d.reduce((e,o)=>e+(o.total_usd_bruto||0),0);if(p||s&&e.affiliate_studio_id||o.affiliate_studio_id){let e=o.affiliate_studio_id&&k.get(o.affiliate_studio_id)||.1;a=.6*r,t=r*(.4-e)}else a=d.reduce((e,o)=>e+(o.total_usd_modelo||0),0),t=r-a;let i=a*Y,n=t*Y,u=d[0]?.dataSource||"none";return console.log(`üìä [BILLING-SUMMARY] Modelo ${o.email}: USD Bruto=${r}, USD Modelo=${a}, USD Sede=${t}, Fuente=${u}`),{modelId:o.id,email:o.email.split("@")[0],name:o.name,groupId:l?.id,groupName:l?.name,affiliate_studio_id:o.affiliate_studio_id,usdBruto:r,usdModelo:a,usdSede:t,copModelo:i,copSede:n}}),j=z.reduce((e,o)=>({totalModels:e.totalModels+1,totalUsdBruto:e.totalUsdBruto+o.usdBruto,totalUsdModelo:e.totalUsdModelo+o.usdModelo,totalUsdSede:e.totalUsdSede+o.usdSede,totalCopModelo:e.totalCopModelo+o.copModelo,totalCopSede:e.totalCopSede+o.copSede}),{totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0}),K=null;if(p&&e.affiliate_studio_id){let{data:o}=await m.from("affiliate_studios").select("name").eq("id",e.affiliate_studio_id).single();o&&(K=o.name);let{data:a}=await m.from("rates").select("value").eq("kind","USD‚ÜíCOP").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}).limit(1).single(),t=a?.value?parseFloat(a.value):3900;j.totalCopSede=j.totalUsdSede*t,console.log("\uD83D\uDCB0 [BILLING-SUMMARY] Summary para superadmin_aff (neto del estudio):",{studioName:K,totalUsdBruto:j.totalUsdBruto,totalUsdModelo:j.totalUsdModelo,totalUsdSede:j.totalUsdSede,commissionInnova:.1*j.totalUsdBruto,verificacion:{modelo:(j.totalUsdModelo/j.totalUsdBruto*100).toFixed(1)+"%",estudio:(j.totalUsdSede/j.totalUsdBruto*100).toFixed(1)+"%",innova:(.1*j.totalUsdBruto/j.totalUsdBruto*100).toFixed(1)+"%"}})}let O=null;if(console.log("\uD83D\uDD0D [BILLING-SUMMARY] Condiciones para groupedData:",{isSuperAdmin:r,isAdmin:s,adminGroupsLength:_.length,shouldCreateGroupedData:r||s&&_.length>0}),r||s&&_.length>0){let e=Array.from(new Set(z.map(e=>e.groupId).filter(Boolean))),{data:o,error:a}=await m.from("groups").select("id, name").in("id",e);if(a&&console.error("‚ùå [BILLING-SUMMARY] Error al obtener grupos:",a),r){let e={sedeId:"agencia-innova",sedeName:"Agencia Innova",isAffiliate:!1,groups:[],models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0},a=new Map;z.filter(e=>!e.affiliate_studio_id).forEach(t=>{let d=t.groupId;a.has(d)||a.set(d,{groupId:d,groupName:o?.find(e=>e.id===d)?.name||"Grupo Desconocido",models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0});let l=a.get(d);l.models.push(t),l.totalModels+=1,l.totalUsdBruto+=t.usdBruto,l.totalUsdModelo+=t.usdModelo,l.totalUsdSede+=t.usdSede,l.totalCopModelo+=t.copModelo,l.totalCopSede+=t.copSede,e.models.push(t),e.totalModels+=1,e.totalUsdBruto+=t.usdBruto,e.totalUsdModelo+=t.usdModelo,e.totalUsdSede+=t.usdSede,e.totalCopModelo+=t.copModelo,e.totalCopSede+=t.copSede}),e.groups=Array.from(a.values());let t=[],{data:d}=await m.from("affiliate_studios").select("id, name, commission_percentage").eq("is_active",!0);if(d&&d.length>0){let{data:e}=await m.from("rates").select("value").eq("kind","USD‚ÜíCOP").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}).limit(1).single(),o=e?.value?parseFloat(e.value):3900;for(let e of d){let{data:a,error:d}=await m.from("users").select("id, email, name").eq("affiliate_studio_id",e.id).eq("role","modelo").eq("is_active",!0);if(d||!a||0===a.length)continue;let l=a.map(e=>e.id),{data:r,error:i}=await m.from("user_groups").select(`
                user_id,
                groups!inner(
                  id,
                  name
                )
              `).in("user_id",l);i&&console.error("‚ùå [BILLING-SUMMARY] Error obteniendo grupos de afiliado:",i);let s=new Map;r?.forEach(e=>{e.groups&&s.set(e.user_id,e.groups)});let n=[];if(R){let{data:t,error:d}=await m.from("calculator_totals").select("*").in("model_id",l).gte("period_date",y).lte("period_date",b).order("period_date",{ascending:!1});d?console.error("‚ùå [BILLING-SUMMARY] Error obteniendo totales de afiliado:",d):console.log("\uD83D\uDD0D [BILLING-SUMMARY] Totales de afiliado encontrados:",t?.length||0,"para",l.length,"modelos");let r=new Map;t&&t.length>0&&t.forEach(e=>{let o=r.get(e.model_id);(!o||new Date(e.updated_at)>new Date(o.updated_at))&&r.set(e.model_id,e)});let i=e.commission_percentage?parseFloat(e.commission_percentage.toString())/100:.1;n=a.map(e=>{let a=r.get(e.id),t=s.get(e.id),d=parseFloat(a?.total_usd_bruto||0),l=.6*d,n=d*i,u=d*(.4-i),c=l*o,m=u*o,p=n*o;return{modelId:e.id,email:e.email.split("@")[0],name:e.name,groupId:t?.id,groupName:t?.name,usdBruto:d,usdModelo:l,usdSede:u,copModelo:c,copSede:m,commissionUsd:n,commissionCop:p}})}else{let t=A<=15?"1-15":"16-31",{data:d,error:r}=await m.from("calculator_history").select("model_id, value_usd_bruto, value_usd_modelo").in("model_id",l).gte("period_date",y).lte("period_date",b).eq("period_type",t);r?console.error("‚ùå [BILLING-SUMMARY] Error obteniendo historial de afiliado:",r):console.log("\uD83D\uDD0D [BILLING-SUMMARY] Historial de afiliado encontrado:",d?.length||0,"registros para",l.length,"modelos");let i=new Map;d&&d.length>0&&d.forEach(e=>{let o=i.get(e.model_id);o?(o.usd_bruto+=parseFloat(e.value_usd_bruto||0),o.usd_modelo+=parseFloat(e.value_usd_modelo||0)):i.set(e.model_id,{usd_bruto:parseFloat(e.value_usd_bruto||0),usd_modelo:parseFloat(e.value_usd_modelo||0)})});let u=e.commission_percentage?parseFloat(e.commission_percentage.toString())/100:.1;n=a.map(e=>{let a=i.get(e.id)||{usd_bruto:0,usd_modelo:0},t=s.get(e.id),d=a.usd_bruto,l=.6*d,r=d*u,n=d*(.4-u),c=l*o,m=n*o,p=r*o;return{modelId:e.id,email:e.email.split("@")[0],name:e.name,groupId:t?.id,groupName:t?.name,usdBruto:d,usdModelo:l,usdSede:n,copModelo:c,copSede:m,commissionUsd:r,commissionCop:p}})}e.commission_percentage&&parseFloat(e.commission_percentage.toString());let u=n.reduce((e,o)=>e+o.usdBruto,0),c=n.reduce((e,o)=>e+o.usdModelo,0),p=n.reduce((e,o)=>e+o.usdSede,0),_=n.reduce((e,o)=>e+(o.commissionUsd||0),0),f=n.reduce((e,o)=>e+o.copModelo,0),g=n.reduce((e,o)=>e+o.copSede,0),M=n.reduce((e,o)=>e+(o.commissionCop||0),0);console.log("\uD83D\uDCB0 [BILLING-SUMMARY] Totales del afiliado:",{studio:e.name,commission_percentage:e.commission_percentage,totalUsdBruto:u,totalCommissionUsd:_,totalUsdAfiliado:u-_,totalUsdModelo:c,totalUsdEstudio:p,modelsCount:n.length});let S=new Map;n.forEach(e=>{let o=e.groupId;S.has(o)||S.set(o,{groupId:o,groupName:e.groupName||"Sin Grupo",models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0});let a=S.get(o);a.models.push(e),a.totalModels+=1,a.totalUsdBruto+=e.usdBruto,a.totalUsdModelo+=e.usdModelo,a.totalUsdSede+=e.usdSede,a.totalCopModelo+=e.copModelo,a.totalCopSede+=e.copSede});let D=u-_,I=D*o;t.push({sedeId:`affiliate-${e.id}`,sedeName:`${e.name} - Afiliado`,isAffiliate:!0,affiliate_studio_id:e.id,groups:Array.from(S.values()),models:n,totalModels:n.length,totalUsdBruto:u,totalUsdSede:_,totalUsdAfiliado:D,totalCopSede:M,totalCopAfiliado:I,totalUsdModelo:c,totalUsdEstudio:p,totalCopModelo:f,totalCopEstudio:g,commission_percentage:e.commission_percentage?parseFloat(e.commission_percentage.toString()):10,sedes_count:S.size})}}let l=t.reduce((e,o)=>e+o.totalUsdSede,0),r=t.reduce((e,o)=>e+o.totalCopSede,0);console.log("\uD83D\uDCCA [BILLING-SUMMARY] Resumen de comisiones de afiliados:",{affiliateBillingDataCount:t.length,totalAffiliateCommissions:l,totalAffiliateCommissionsCop:r,summaryBefore:{totalUsdSede:j.totalUsdSede,totalCopSede:j.totalCopSede},agenciaInnovaBefore:{totalUsdSede:e.totalUsdSede,totalCopSede:e.totalCopSede}}),j.totalUsdSede+=l,j.totalCopSede+=r,e.totalUsdSede+=l,e.totalCopSede+=r,console.log("‚úÖ [BILLING-SUMMARY] Comisiones agregadas a resumen:",{summaryAfter:{totalUsdSede:j.totalUsdSede,totalCopSede:j.totalCopSede},agenciaInnovaAfter:{totalUsdSede:e.totalUsdSede,totalCopSede:e.totalCopSede}}),O=[e,...t]}else if(s&&_.length>0){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Creando sedes individuales para admin"),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Admin groups:",_),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Billing data models:",z.length);let e=new Map;z.forEach(a=>{let t=a.groupId;if(console.log("\uD83D\uDD0D [BILLING-SUMMARY] Procesando modelo:",a.email,"grupo:",t),_.includes(t)){console.log("\uD83D\uDD0D [BILLING-SUMMARY] Grupo asignado al admin, agregando modelo"),e.has(t)||e.set(t,{sedeId:t,sedeName:o?.find(e=>e.id===t)?.name||"Grupo Desconocido",groups:[],models:[],totalModels:0,totalUsdBruto:0,totalUsdModelo:0,totalUsdSede:0,totalCopModelo:0,totalCopSede:0});let d=e.get(t);d.models.push(a),d.totalModels+=1,d.totalUsdBruto+=a.usdBruto,d.totalUsdModelo+=a.usdModelo,d.totalUsdSede+=a.usdSede,d.totalCopModelo+=a.copModelo,d.totalCopSede+=a.copSede}}),O=Array.from(e.values()),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Sedes creadas para admin:",O.length),console.log("\uD83D\uDD0D [BILLING-SUMMARY] Sedes:",O.map(e=>({id:e.sedeId,name:e.sedeName,models:e.totalModels})))}}return console.log("‚úÖ [BILLING-SUMMARY] Resumen generado:",{models:z.length,summary:j,groupedData:O?.length||0,isSuperAdmin:r,isAdmin:s,adminGroups:_,dataSource:"mixed (calculator_history + calculator_totals)",periodType:x,periodRange:`${y} - ${b}`,historyModels:Array.from(q.keys()).length,totalsModels:Array.from(F.keys()).length}),i.Z.json({success:!0,data:z,summary:j,groupedData:O,periodDate:t,sedeId:a||"all",adminRole:e.role,affiliateStudioName:K||null})}catch(e){return console.error("‚ùå [BILLING-SUMMARY] Error:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let _=new d.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/admin/billing-summary/route",pathname:"/api/admin/billing-summary",filename:"route",bundlePath:"app/api/admin/billing-summary/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\billing-summary\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:M,headerHooks:S,staticGenerationBailout:D}=_,I="/api/admin/billing-summary/route";function U(){return(0,r.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:g})}},34196:(e,o,a)=>{function t(e,o){return o?"super_admin"!==o.role&&("admin"!==o.role||o.affiliate_studio_id)&&("superadmin_aff"===o.role||"admin"===o.role&&o.affiliate_studio_id)?o.affiliate_studio_id?e.eq("affiliate_studio_id",o.affiliate_studio_id):e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000"):e:e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000")}a.d(o,{rd:()=>t}),process.env.SUPABASE_SERVICE_ROLE_KEY},43178:(e,o,a)=>{a.d(o,{Bm:()=>s,Pj:()=>r,jO:()=>d,mo:()=>t,n6:()=>i,y6:()=>l});let t="f91c0968-b587-46cf-9036-05a4ec795c7f",d="AIM Botty",l="aim-botty@agencia-innova.com";function r(e){let o={modelo:`Eres AIM Botty, tu asistente virtual y amigo ü§ñ. Ayudo a modelos de webcam de forma cercana y comprensiva.
      Tu personalidad:
      - Super amigable, cercano y emp\xe1tico (como un buen amigo)
      - Tono casual y c\xe1lido, sin formalidades
      - Entiendes perfectamente el mundo del entretenimiento para adultos
      - Sabes c\xf3mo puede ser este trabajo emocionalmente
      - Ofreces tips \xfatiles sin ser condescendiente
      - Das apoyo emocional cuando se necesita
      - Siempre positivo y alentador
      - Hablas de t\xfa, nunca de usted`,admin:`Eres AIM Botty, un asistente virtual cercano y \xfatil para administradores. 
      Tu personalidad:
      - Amigable pero profesional
      - Directo y eficiente
      - Tono cercano, como un compa\xf1ero de trabajo
      - Proactivo y \xfatil
      - Siempre disponible para ayudar`,super_admin:`Eres AIM Botty, un asistente virtual cercano y eficiente para super administradores.
      Tu personalidad:
      - Amigable pero directo
      - Eficiente y claro
      - Tono cercano y profesional
      - Proactivo en reportar lo importante
      - Siempre \xfatil y disponible`};return o[e]||o.modelo}function i(e,o){return({anticipo_pendiente:`üìã Hola ${o.name}! Tienes una nueva solicitud de anticipo pendiente de revisi\xf3n. El administrador la revisar\xe1 pronto.`,anticipo_aprobado:`‚úÖ \xa1Excelente noticia ${o.name}! Tu solicitud de anticipo ha sido aprobada. El pago se procesar\xe1 seg\xfan lo acordado.`,anticipo_rechazado:`‚ö†Ô∏è ${o.name}, tu solicitud de anticipo fue rechazada. Revisa los detalles en [LINK:Mis Anticipos|/admin/model/anticipos/solicitudes] o contacta a tu administrador si tienes dudas.`,anticipo_realizado:`üí∞ ${o.name}, tu anticipo ha sido pagado. Por favor [LINK:confirma la recepci\xf3n|/admin/model/anticipos/solicitudes].`,anticipo_confirmado:`‚úÖ ${o.name}, has confirmado la recepci\xf3n de tu anticipo. \xa1Gracias!`,anticipo_confirmar_recordatorio:`‚è∞ ${o.name}, recuerda [LINK:confirmar la recepci\xf3n de tu anticipo pagado|/admin/model/anticipos/solicitudes].`,pagina_confirmada:`üéâ \xa1Felicidades ${o.name}! Se ha confirmado la entrega de tu p\xe1gina. \xa1Excelente trabajo!`,plataforma_entregada:`üì¶ ${o.name}, tu plataforma ha sido entregada. [LINK:Confirma la recepci\xf3n|/admin/model/portafolio] para activarla en tu calculadora.`,plataforma_confirmada:`‚úÖ ${o.name}, plataforma confirmada y activada exitosamente en tu calculadora.`,plataforma_agregada:`‚ûï ${o.name}, se agreg\xf3 una nueva plataforma a tu portafolio. [LINK:Ver portafolio|/admin/model/portafolio]`,plataforma_pendiente_confirmacion:`‚è≥ ${o.name}, hay plataformas entregadas esperando tu confirmaci\xf3n. [LINK:Revisar portafolio|/admin/model/portafolio]`,periodo_cerrado:`üìä ${o.name}, el per\xedodo de facturaci\xf3n ha sido cerrado. Puedes [LINK:revisar tu resumen completo|/admin/model/dashboard] en el dashboard.`,metas_alcanzadas:`üèÜ \xa1Incre\xedble ${o.name}! Has alcanzado tu meta del d\xeda. \xa1Sigue as\xed!`,meta_periodo_alcanzada:`üéØ \xa1Excelente ${o.name}! Has alcanzado tu meta del per\xedodo. \xa1Felicitaciones!`,meta_dia_alcanzada:`‚≠ê ${o.name}, \xa1alcanzaste tu meta del d\xeda!`,recordatorio_ingreso:`üí° ${o.name}, recuerda [LINK:ingresar tus valores del d\xeda|/admin/model/calculator] en Mi Calculadora para mantener tus registros al d\xeda.`,valores_no_ingresados:`‚ö†Ô∏è ${o.name}, no has ingresado valores desde hace varios d\xedas. [LINK:Actualiza tus registros|/admin/model/calculator] ahora.`,cuota_minima_riesgo:`üìâ ${o.name}, est\xe1s cerca de no alcanzar tu cuota m\xednima. \xa1Sigue as\xed, puedes lograrlo!`,mensaje_importante_admin:`üì© ${o.name}, tienes un mensaje importante de tu administrador. [LINK:Revisa tu chat|#]`,escalamiento_admin:`üÜò ${o.name}, tu consulta ha sido escalada a un administrador. Te responder\xe1n pronto.`,respuesta_escalamiento:`üí¨ ${o.name}, un administrador respondi\xf3 a tu consulta. [LINK:Revisa tu chat|#]`,nuevo_mensaje_modelo:`üí¨ ${o.name}, tienes un nuevo mensaje de una modelo. [LINK:Abrir chat|#]`,consulta_escalada:`üö® ${o.name}, una modelo necesita asistencia urgente. [LINK:Revisar chat|#]`,modelo_solicita_ayuda:`üÜò ${o.name}, una modelo solicit\xf3 ayuda en el chat. [LINK:Abrir chat|#]`,nueva_publicacion:`üìå \xa1Hola ${o.name}! Hay una nueva publicaci\xf3n en el corcho informativo. [LINK:Revisa tu dashboard|/admin/model/dashboard] para ver los detalles.`,cambio_configuracion:`‚öôÔ∏è ${o.name}, se actualiz\xf3 la configuraci\xf3n del sistema.`,mantenimiento_programado:`üîß ${o.name}, el sistema estar\xe1 en mantenimiento. Revisa los detalles.`,nueva_funcionalidad:`‚ú® ${o.name}, hay una nueva funcionalidad disponible. \xa1\xc9chale un vistazo!`,error_critico:`üö® ${o.name}, se detect\xf3 un error cr\xedtico en el sistema. Revisa los logs.`,backup_completado:`üíæ ${o.name}, el backup del sistema se complet\xf3 exitosamente.`,actualizacion_sistema:`üîÑ ${o.name}, el sistema ha sido actualizado.`})[e]||`üîî ${o.name}, tienes una nueva notificaci\xf3n.`}function s(e){return e===t}},66569:(e,o,a)=>{a.d(o,{A:()=>i,R:()=>r});var t=a(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",l=process.env.SUPABASE_SERVICE_ROLE_KEY||"",r=(0,t.createClient)(d,l,{auth:{autoRefreshToken:!1,persistSession:!1}}),i=(0,t.createClient)(d,l,{auth:{autoRefreshToken:!1,persistSession:!1}})},13532:(e,o,a)=>{a.d(o,{Bs:()=>l,Jz:()=>d,iR:()=>r,lm:()=>t});let t=()=>{let[e,o,a]=r().split("-").map(Number);return`${e}-${String(o).padStart(2,"0")}-${String(a<=15?1:16).padStart(2,"0")}`},d=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("‚ö†Ô∏è [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),t();let[o,a,d]=e.split("-").map(Number);if(!o||!a||!d)return t();return`${o}-${String(a).padStart(2,"0")}-${String(d<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("‚ùå [DATE-UTILS] Error normalizando fecha:",e),t()}},l=e=>{try{let[o,a,t]=e.split("-").map(Number),d=t<=15,l=`${o}-${String(a).padStart(2,"0")}-${d?"01":"16"}`,r="";if(d)r=`${o}-${String(a).padStart(2,"0")}-15`;else{let e=new Date(o,a,0).getDate();r=`${o}-${String(a).padStart(2,"0")}-${e}`}let i=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][a-1]} ${o} - Per\xedodo ${d?"1":"2"}`;return{startDate:l,endDate:r,name:i,isP1:d}}catch(o){return console.error("‚ùå [DATE-UTILS] Error calculando detalles del per\xedodo:",o),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},r=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var o=require("../../../../webpack-runtime.js");o.C(e);var a=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>a(14317));module.exports=t})();