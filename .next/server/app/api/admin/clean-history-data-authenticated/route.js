"use strict";(()=>{var e={};e.id=4895,e.ids=[4895],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},72602:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>h,originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var t={};r.r(t),r.d(t,{POST:()=>n});var a=r(95419),i=r(69108),s=r(99678),d=r(78070),l=r(72964);async function n(e){try{console.log("\uD83D\uDD0D [CLEAN-HISTORY-AUTH] Iniciando limpieza autenticada...");let o=e.headers.get("authorization");if(!o||!o.startsWith("Bearer "))return d.Z.json({success:!1,error:"Token de autorizaci\xf3n requerido"},{status:401});let r=o.substring(7),t=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c",{global:{headers:{Authorization:`Bearer ${r}`}}}),{data:{user:a},error:i}=await t.auth.getUser();if(i||!a)return d.Z.json({success:!1,error:"Usuario no autenticado"},{status:401});console.log(`ðŸ” [CLEAN-HISTORY-AUTH] Usuario autenticado: ${a.id}`),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY-AUTH] 0. Verificando estado ANTES de la limpieza:");let{data:s,error:n}=await t.from("calculator_history").select("period_type, value, model_id");if(n)return console.error("âŒ Error obteniendo datos antes de limpieza:",n),d.Z.json({success:!1,error:"Error obteniendo datos antes de limpieza"},{status:500});let c={};s?.forEach(e=>{c[e.period_type]||(c[e.period_type]={registros:0,modelos:new Set,total_valor:0}),c[e.period_type].registros++,c[e.period_type].modelos.add(e.model_id),c[e.period_type].total_valor+=parseFloat(e.value||0)});let u={};Object.entries(c).forEach(([e,o])=>{u[e]={registros:o.registros,modelos:o.modelos.size,total_valor:o.total_valor}}),console.log("\uD83D\uDCCA Estado ANTES:",u),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY-AUTH] 1. Verificando datos del usuario:");let{data:p,error:m}=await t.from("calculator_history").select("*").eq("model_id",a.id).order("period_date",{ascending:!1});if(m)return console.error("âŒ Error obteniendo datos del usuario:",m),d.Z.json({success:!1,error:"Error obteniendo datos del usuario"},{status:500});console.log(`âœ… Registros del usuario: ${p?.length||0}`);let h={};p&&p.length>0&&(p.forEach(e=>{let o=`${e.period_type}-${e.period_date}`;h[o]||(h[o]={period_type:e.period_type,period_date:e.period_date,registros:0,plataformas:new Set,total_valor:0}),h[o].registros++,h[o].plataformas.add(e.platform_id),h[o].total_valor+=parseFloat(e.value||0)}),Object.values(h).forEach(e=>{e.plataformas=Array.from(e.plataformas)})),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY-AUTH] 2. Eliminando datos del per\xedodo 2 (16-31):");let{data:g,error:_}=await t.from("calculator_history").select("id").eq("model_id",a.id).eq("period_type","16-31"),f=0;if(_)console.error("âŒ Error obteniendo datos del per\xedodo 2:",_);else if(console.log(`âœ… Registros del per\xedodo 2 encontrados: ${g?.length||0}`),g&&g.length>0){let e=g.map(e=>e.id),{error:o}=await t.from("calculator_history").delete().in("id",e);o?console.error("âŒ Error eliminando per\xedodo 2:",o):(console.log(`âœ… Per\xedodo 2 eliminado: ${e.length} registros`),f=e.length)}console.log("\n\uD83D\uDCCA [CLEAN-HISTORY-AUTH] 3. Verificando duplicados en per\xedodo 1:");let{data:y,error:E}=await t.from("calculator_history").select("*").eq("model_id",a.id).eq("period_type","1-15").order("archived_at",{ascending:!1}),A=0;if(E)console.error("âŒ Error obteniendo datos del per\xedodo 1:",E);else if(console.log(`âœ… Registros del per\xedodo 1: ${y?.length||0}`),y&&y.length>0){let e={};y.forEach(o=>{let r=`${o.platform_id}-${o.period_date}`;e[r]||(e[r]=[]),e[r].push(o)});let o=Object.keys(e).filter(o=>e[o].length>1);if(console.log(`âœ… Registros con duplicados encontrados: ${o.length}`),o.length>0)for(let r of o){let o=e[r].sort((e,o)=>new Date(o.archived_at).getTime()-new Date(e.archived_at).getTime()).slice(1),a=o.map(e=>e.id),{error:i}=await t.from("calculator_history").delete().in("id",a);i?console.error(`âŒ Error eliminando duplicados para ${r}:`,i):(console.log(`âœ… Duplicados eliminados para ${r}: ${o.length} registros`),A+=o.length)}}console.log("\n\uD83D\uDCCA [CLEAN-HISTORY-AUTH] 4. Verificando estado DESPU\xc9S de la limpieza:");let{data:D,error:C}=await t.from("calculator_history").select("period_type, value, model_id");if(C)return console.error("âŒ Error obteniendo datos despu\xe9s de limpieza:",C),d.Z.json({success:!1,error:"Error obteniendo datos despu\xe9s de limpieza"},{status:500});let v={};D?.forEach(e=>{v[e.period_type]||(v[e.period_type]={registros:0,modelos:new Set,total_valor:0}),v[e.period_type].registros++,v[e.period_type].modelos.add(e.model_id),v[e.period_type].total_valor+=parseFloat(e.value||0)});let T={};return Object.entries(v).forEach(([e,o])=>{T[e]={registros:o.registros,modelos:o.modelos.size,total_valor:o.total_valor}}),console.log("\uD83D\uDCCA Estado DESPU\xc9S:",T),console.log("\nâœ… [CLEAN-HISTORY-AUTH] Limpieza completada"),d.Z.json({success:!0,message:"Limpieza de historial completada",results:{user_id:a.id,before:u,after:T,user_summary:h,period2_deleted:f,duplicates_deleted:A}})}catch(e){return console.error("âŒ [CLEAN-HISTORY-AUTH] Error general:",e),d.Z.json({success:!1,error:"Error general en limpieza de historial"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/clean-history-data-authenticated/route",pathname:"/api/admin/clean-history-data-authenticated",filename:"route",bundlePath:"app/api/admin/clean-history-data-authenticated/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\clean-history-data-authenticated\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:m,headerHooks:h,staticGenerationBailout:g}=c,_="/api/admin/clean-history-data-authenticated/route";function f(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>r(72602));module.exports=t})();