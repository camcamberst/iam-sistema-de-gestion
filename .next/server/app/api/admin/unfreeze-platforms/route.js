"use strict";(()=>{var e={};e.id=7693,e.ids=[7693],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},37290:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>D,originalPathname:()=>q,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>E,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>y});var t={};o.r(t),o.d(t,{DELETE:()=>f,GET:()=>p});var a=o(95419),s=o(69108),i=o(99678),n=o(78070),l=o(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",u=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return{error:"Token de autorizaci\xf3n requerido",user:null};let o=r.split(" ")[1];if(!o)return{error:"Token de autorizaci\xf3n requerido",user:null};let t=(0,l.createClient)(d,u,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:s}=await t.auth.getUser(o);if(s||!a)return{error:`Token inv\xe1lido: ${s?.message||"Usuario no encontrado"}`,user:null};let{data:i,error:n}=await t.from("users").select("role").eq("id",a.id).single();return n||!i?{error:"Error obteniendo datos de usuario",user:null}:"admin"!==i.role&&"super_admin"!==i.role?{error:"No autorizado. Se requiere rol de admin o super_admin",user:null}:{error:null,user:{id:a.id,role:i.role}}}let m=(0,l.createClient)(d,u);async function p(e){try{let r=await c(e);if(r.error||!r.user)return n.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let{searchParams:o}=new URL(e.url),t=o.get("modelId"),a=m.from("calculator_early_frozen_platforms").select("period_date, platform_id, model_id, frozen_at").order("frozen_at",{ascending:!1});t&&(a=a.eq("model_id",t));let{data:s,error:i}=await a;if(i)return n.Z.json({success:!1,error:i.message},{status:500});let l=new Map;s?.forEach(e=>{l.has(e.model_id)||l.set(e.model_id,[]),l.get(e.model_id).push(e)});let d=Array.from(l.keys()),{data:u}=await m.from("users").select("id, email").in("id",d),p=new Map(u?.map(e=>[e.id,e.email])||[]),f=Array.from(l.entries()).map(([e,r])=>({model_id:e,email:p.get(e)||e,frozen_count:r.length,platforms:Array.from(new Set(r.map(e=>e.platform_id))),periods:Array.from(new Set(r.map(e=>e.period_date)))}));return n.Z.json({success:!0,total_records:s?.length||0,total_models:l.size,summary:f,records:s||[]})}catch(e){return console.error("âŒ [UNFREEZE] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function f(e){try{let r=await c(e);if(r.error||!r.user)return n.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let{searchParams:o}=new URL(e.url),t=o.get("modelId"),a="true"===o.get("all");console.log("\uD83D\uDD13 [UNFREEZE] Iniciando descongelamiento de plataformas...",{modelId:t?.substring(0,8),all:a});let s="2025-12-16",i="16-31",{data:l}=await m.from("calculator_period_closure_status").select("status").eq("period_date",s).eq("period_type",i).order("created_at",{ascending:!1}).limit(1).single();l&&"completed"===l.status?console.log("âœ… [UNFREEZE] Per\xedodo P2 de diciembre ya estaba marcado como cerrado"):(console.log("\uD83D\uDD13 [UNFREEZE] Marcando per\xedodo P2 de diciembre como cerrado para desactivar detecci\xf3n autom\xe1tica..."),await m.from("calculator_period_closure_status").upsert({period_date:s,period_type:i,status:"completed",closed_at:new Date().toISOString()},{onConflict:"period_date,period_type"}),console.log("âœ… [UNFREEZE] Per\xedodo P2 de diciembre marcado como cerrado"));let d=m.from("calculator_early_frozen_platforms").delete();if(a)d=d.neq("id","00000000-0000-0000-0000-000000000000"),console.log("\uD83D\uDD13 [UNFREEZE] Descongelando TODAS las plataformas de TODOS los modelos...");else{if(!t)return n.Z.json({success:!1,error:"Se requiere modelId o all=true"},{status:400});d=d.eq("model_id",t),console.log(`ðŸ”“ [UNFREEZE] Descongelando plataformas para modelo ${t.substring(0,8)}...`)}let{data:u,error:p}=await d.select();if(p)return console.error("âŒ [UNFREEZE] Error:",p),n.Z.json({success:!1,error:p.message},{status:500});let f=u?.length||0;return console.log(`âœ… [UNFREEZE] Descongelamiento completado: ${f} registros eliminados`),n.Z.json({success:!0,deleted_count:f,message:`Se descongelaron ${f} plataforma(s)`})}catch(e){return console.error("âŒ [UNFREEZE] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let E=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/unfreeze-platforms/route",pathname:"/api/admin/unfreeze-platforms",filename:"route",bundlePath:"app/api/admin/unfreeze-platforms/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\unfreeze-platforms\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:h,headerHooks:D,staticGenerationBailout:y}=E,q="/api/admin/unfreeze-platforms/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(37290));module.exports=t})();