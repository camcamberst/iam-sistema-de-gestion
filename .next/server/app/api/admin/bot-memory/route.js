"use strict";(()=>{var e={};e.id=913,e.ids=[913],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},77092:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>g,originalPathname:()=>O,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>v});var a={};t.r(a),t.d(a,{DELETE:()=>p,GET:()=>l});var o=t(95419),n=t(69108),i=t(99678),s=t(78070),u=t(72964),c=t(91539);let m="https://mhernfrkvwigxdubiozm.supabase.co",d=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(e){try{let r=(0,u.createClient)(m,d,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let a=t.split(" ")[1],{data:{user:o},error:n}=await r.auth.getUser(a);if(n||!o)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{searchParams:i}=new URL(e.url),l=i.get("type"),p=await (0,c.ye)(o.id,l||void 0);return s.Z.json({success:!0,data:p})}catch(e){return console.error("Error en GET /api/admin/bot-memory:",e),s.Z.json({success:!1,error:e.message||"Error obteniendo memorias"},{status:500})}}async function p(e){try{let r=(0,u.createClient)(m,d,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let a=t.split(" ")[1],{data:{user:o},error:n}=await r.auth.getUser(a);if(n||!o)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{key:i}=await e.json();if(!i)return s.Z.json({error:"Key requerida"},{status:400});let l=await (0,c.lo)(o.id,i);return s.Z.json({success:l,message:l?"Memoria eliminada":"Error eliminando memoria"})}catch(e){return console.error("Error en DELETE /api/admin/bot-memory:",e),s.Z.json({success:!1,error:e.message||"Error eliminando memoria"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/bot-memory/route",pathname:"/api/admin/bot-memory",filename:"route",bundlePath:"app/api/admin/bot-memory/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\bot-memory\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:E,headerHooks:g,staticGenerationBailout:v}=f,O="/api/admin/bot-memory/route";function b(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:y})}},91539:(e,r,t)=>{t.d(r,{Ot:()=>c,YC:()=>m,Z7:()=>i,lo:()=>u,ye:()=>s});var a=t(72964);let o=process.env.SUPABASE_SERVICE_ROLE_KEY;function n(){return(0,a.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",o,{auth:{autoRefreshToken:!1,persistSession:!1}})}async function i(e){try{let r=n(),{data:t}=await r.from("bot_memory").select("id").eq("user_id",e.user_id).eq("key",e.key).single();if(t){let{error:a}=await r.from("bot_memory").update({value:e.value,metadata:e.metadata,updated_at:new Date().toISOString()}).eq("id",t.id);if(a)return console.error("❌ [BOT-MEMORY] Error actualizando memoria:",a),!1}else{let{error:t}=await r.from("bot_memory").insert({user_id:e.user_id,type:e.type,key:e.key,value:e.value,metadata:e.metadata});if(t)return console.error("❌ [BOT-MEMORY] Error guardando memoria:",t),!1}return!0}catch(e){return console.error("❌ [BOT-MEMORY] Error en saveMemory:",e),!1}}async function s(e,r){try{let t=n().from("bot_memory").select("*").eq("user_id",e);r&&(t=t.eq("type",r)),t=t.or("metadata->expires_at.is.null,metadata->expires_at.gt."+new Date().toISOString());let{data:a,error:o}=await t.order("updated_at",{ascending:!1});if(o)return console.error("❌ [BOT-MEMORY] Error obteniendo memorias:",o),[];return(a||[]).map(e=>({...e,value:"string"==typeof e.value?function(e){try{return JSON.parse(e)}catch{return e}}(e.value):e.value}))}catch(e){return console.error("❌ [BOT-MEMORY] Error en getUserMemories:",e),[]}}async function u(e,r){try{let t=n(),{error:a}=await t.from("bot_memory").delete().eq("user_id",e).eq("key",r);return!a}catch(e){return console.error("❌ [BOT-MEMORY] Error eliminando memoria:",e),!1}}async function c(e,r,t,a){try{for(let a of function(e){let r=e.toLowerCase(),t=[];if(r.match(/me gusta trabajar|prefiero trabajar|trabajo mejor|soy más productiv/)){let e=r.match(/(mañana|tarde|noche|madrugada|día|evening|morning|afternoon)/);e&&t.push({type:"preference",key:"preferred_hours",value:e[1],confidence:.8})}if(r.match(/mi plataforma favorita|me gusta más|prefiero usar|trabajo mejor en/)){let e=r.match(/(chaturbate|streamate|myfreecams|cam4|camsoda|stripchat|livejasmin|flirt4free|camcontacts|big7|mondo|superfoon)/);e&&t.push({type:"preference",key:"favorite_platforms",value:e[1],confidence:.8})}if(r.match(/mi meta|mi objetivo|quiero ganar|mi objetivo es/)){let e=r.match(/(\d+)\s*(usd|dólar|dolar)/);e&&t.push({type:"goal",key:"personal_goal",value:parseInt(e[1]),confidence:.7})}return r.match(/tengo un problema|estoy teniendo|no puedo|no funciona|me está pasando/)&&t.push({type:"issue",key:"last_mentioned_issue",value:e.substring(0,200),confidence:.6}),t}(t))await i({user_id:e,type:a.type,key:a.key,value:a.value,metadata:{source_conversation_id:r,mentioned_at:new Date().toISOString(),confidence:a.confidence||.7}})}catch(e){console.error("❌ [BOT-MEMORY] Error extrayendo memoria:",e)}}async function m(e){try{let r=await s(e);if(0===r.length)return"";let t=["MEMORIA DEL USUARIO (informaci\xf3n recordada de conversaciones anteriores):"],a=r.reduce((e,r)=>(e[r.type]||(e[r.type]=[]),e[r.type].push(r),e),{});if(a.preference?.length>0&&(t.push("\nPREFERENCIAS:"),a.preference.forEach(e=>{t.push(`- ${e.key}: ${d(e.value)}`)})),a.goal?.length>0&&(t.push("\nOBJETIVOS MENCIONADOS:"),a.goal.forEach(e=>{t.push(`- ${e.key}: ${d(e.value)}`)})),a.fact?.length>0&&(t.push("\nINFORMACI\xd3N RELEVANTE:"),a.fact.forEach(e=>{t.push(`- ${e.key}: ${d(e.value)}`)})),a.issue?.length>0){let e=a.issue[0];t.push(`
\xdaLTIMO PROBLEMA MENCIONADO: ${d(e.value)}`)}return t.join("\n")}catch(e){return console.error("❌ [BOT-MEMORY] Error obteniendo contexto de memoria:",e),""}}function d(e){return"object"==typeof e?JSON.stringify(e):String(e)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(77092));module.exports=a})();