"use strict";(()=>{var e={};e.id=5693,e.ids=[5693],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},69354:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>E,originalPathname:()=>h,patchFetch:()=>R,requestAsyncStorage:()=>_,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var s={};o.r(s),o.d(s,{GET:()=>l,POST:()=>c,dynamic:()=>n});var t=o(95419),a=o(69108),d=o(99678),i=o(78070);let u=(0,o(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),n="force-dynamic";async function l(e){try{let r=e.nextUrl.searchParams,o=r.get("period_date"),s=r.get("period_type");if(!o||!s)return i.Z.json({success:!1,error:"period_date y period_type son requeridos"},{status:400});let t=e.headers.get("authorization"),a=null;if(t&&t.startsWith("Bearer ")){let e=t.substring(7);try{let{data:{user:r},error:o}=await u.auth.getUser(e);!o&&r&&(a=r.id)}catch(e){console.warn("âš ï¸ [PERIOD-RATES-UPDATE] Error verificando autenticaci\xf3n:",e)}}if(!a)return i.Z.json({success:!1,error:"Autenticaci\xf3n requerida"},{status:401});let{data:d}=await u.from("users").select("role").eq("id",a).single(),n=d?.role||"modelo",l="super_admin"===n,c="gestor"===n;if(!("admin"===n||"super_admin"===n)&&!c)return i.Z.json({success:!1,error:"No autorizado: Solo admins, super_admins y gestores pueden consultar informaci\xf3n de per\xedodos"},{status:403});let p=[];if(!l&&!c){let{data:e}=await u.from("user_groups").select("group_id").eq("user_id",a);p=(e||[]).map(e=>e.group_id)}let _=u.from("calculator_history").select("*",{count:"exact",head:!0}).eq("period_date",o).eq("period_type",s).not("archived_at","is",null);if(!l&&!c&&p.length>0){let{data:e}=await u.from("user_groups").select("user_id").in("group_id",p),r=(e||[]).map(e=>e.user_id);if(!(r.length>0))return i.Z.json({success:!0,period_date:o,period_type:s,records_count:0,current_rates:{eur_usd:null,gbp_usd:null,usd_cop:null}});_=_.in("model_id",r)}let{count:g,error:m}=await _;if(m)return console.error("âŒ [PERIOD-RATES-UPDATE] Error contando registros:",m),i.Z.json({success:!1,error:"Error al obtener informaci\xf3n del per\xedodo"},{status:500});let E=u.from("calculator_history").select("rate_eur_usd, rate_gbp_usd, rate_usd_cop").eq("period_date",o).eq("period_type",s).not("archived_at","is",null).limit(1);if(!l&&!c&&p.length>0){let{data:e}=await u.from("user_groups").select("user_id").in("group_id",p),r=(e||[]).map(e=>e.user_id);r.length>0&&(E=E.in("model_id",r))}let{data:f,error:h}=await E.single();return h&&"PGRST116"!==h.code&&console.error("âŒ [PERIOD-RATES-UPDATE] Error obteniendo muestra:",h),i.Z.json({success:!0,period_date:o,period_type:s,records_count:g||0,current_rates:{eur_usd:f?.rate_eur_usd||null,gbp_usd:f?.rate_gbp_usd||null,usd_cop:f?.rate_usd_cop||null}})}catch(e){return console.error("âŒ [PERIOD-RATES-UPDATE] Error:",e),i.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function c(e){try{let{period_date:r,period_type:o,rates:s,admin_id:t,admin_name:a,group_id:d}=await e.json();if(!r||!o||!s)return i.Z.json({success:!1,error:"period_date, period_type y rates son requeridos"},{status:400});let n=e.headers.get("authorization"),l=null;if(n&&n.startsWith("Bearer ")){let e=n.substring(7);try{let{data:{user:r},error:o}=await u.auth.getUser(e);!o&&r&&(l=r.id)}catch(e){console.warn("âš ï¸ [PERIOD-RATES-UPDATE] Error verificando autenticaci\xf3n:",e)}}if(!l)return i.Z.json({success:!1,error:"Autenticaci\xf3n requerida"},{status:401});let{data:c}=await u.from("users").select("role, name, email").eq("id",l).single(),p=c?.role||"modelo",_="super_admin"===p,g="gestor"===p;if(!("admin"===p||"super_admin"===p)&&!g)return console.warn(`ðŸš« [PERIOD-RATES-UPDATE] Usuario ${l} sin permisos de edici\xf3n`),i.Z.json({success:!1,error:"No autorizado: Solo admins, super_admins y gestores pueden editar tasas hist\xf3ricas"},{status:403});let m=[];if(!_&&!g){let{data:e}=await u.from("user_groups").select("group_id").eq("user_id",l);if(m=(e||[]).map(e=>e.group_id),0===m.length)return i.Z.json({success:!1,error:"No tienes grupos asignados. Contacta al administrador."},{status:403})}let E={eur_usd:void 0!==s.eur_usd?Number(s.eur_usd):null,gbp_usd:void 0!==s.gbp_usd?Number(s.gbp_usd):null,usd_cop:void 0!==s.usd_cop?Number(s.usd_cop):null};if(null===E.eur_usd||null===E.gbp_usd||null===E.usd_cop)return i.Z.json({success:!1,error:"Todas las tasas (eur_usd, gbp_usd, usd_cop) son requeridas"},{status:400});let f={eur_usd:E.eur_usd,gbp_usd:E.gbp_usd,usd_cop:E.usd_cop};console.log(`ðŸ” [PERIOD-RATES-UPDATE] Buscando registros para per\xedodo: ${r} (${o})`),console.log(`ðŸ” [PERIOD-RATES-UPDATE] Usuario: ${l}, Rol: ${p}, SuperAdmin: ${_}`);let{data:h}=await u.from("calculator_period_closure_status").select("status, completed_at").eq("period_date",r).eq("period_type",o).order("created_at",{ascending:!1}).limit(1).maybeSingle(),R=h?.status==="completed"||h?.status&&["closing_calculators","waiting_summary","closing_summary","archiving"].includes(h.status),P="1-15"===o?`${r.split("-")[0]}-${r.split("-")[1]}-15`:`${r.split("-")[0]}-${r.split("-")[1]}-31`,{count:A}=await u.from("model_values").select("*",{count:"exact",head:!0}).gte("period_date",r).lte("period_date",P),D=0===(A||0);if(!R&&!D)return i.Z.json({success:!1,error:`El per\xedodo ${r} (${o}) no est\xe1 cerrado. Solo se pueden editar tasas de per\xedodos cerrados.`},{status:400});console.log(`âœ… [PERIOD-RATES-UPDATE] Per\xedodo verificado: cerrado=${R}, reseteado=${D}`);let T=u.from("calculator_history").select("*, model_id, archived_at").eq("period_date",r).eq("period_type",o).not("archived_at","is",null);if(_||g||!(m.length>0)){if(_||g){if(d){console.log(`ðŸ” [PERIOD-RATES-UPDATE] ${g?"Gestor":"SuperAdmin"}: filtrando por grupo espec\xedfico: ${d}`);let{data:e}=await u.from("user_groups").select("user_id").eq("group_id",d),r=(e||[]).map(e=>e.user_id);if(!(r.length>0))return i.Z.json({success:!1,error:"No hay modelos en el grupo especificado"},{status:404});T=T.in("model_id",r)}else console.log(`ðŸ” [PERIOD-RATES-UPDATE] ${g?"Gestor":"SuperAdmin"}: buscando todos los registros sin filtrar por grupos`)}else console.warn(`âš ï¸ [PERIOD-RATES-UPDATE] Usuario (${p}) sin grupos asignados`)}else{console.log(`ðŸ” [PERIOD-RATES-UPDATE] Usuario (${p}) con grupos asignados: ${m.length} grupos`);let e=m;if(d){if(!m.includes(d))return i.Z.json({success:!1,error:"No tienes acceso al grupo especificado"},{status:403});e=[d]}let{data:r,error:o}=await u.from("user_groups").select("user_id").in("group_id",e);o&&console.error("âŒ [PERIOD-RATES-UPDATE] Error obteniendo modelos de grupos:",o);let s=(r||[]).map(e=>e.user_id);if(console.log(`ðŸ” [PERIOD-RATES-UPDATE] Modelos en grupos del usuario: ${s.length}`),0===s.length)return console.warn(`âš ï¸ [PERIOD-RATES-UPDATE] No hay modelos en los grupos del usuario (${p})`),i.Z.json({success:!1,error:"No hay modelos en tus grupos asignados"},{status:404});T=T.in("model_id",s)}let{data:S,error:$}=await T;if(console.log(`ðŸ” [PERIOD-RATES-UPDATE] Query ejecutada. Registros encontrados: ${S?.length||0}`),$&&console.error("âŒ [PERIOD-RATES-UPDATE] Error en la consulta:",$),$)return console.error("âŒ [PERIOD-RATES-UPDATE] Error obteniendo registros:",$),i.Z.json({success:!1,error:"Error al obtener registros del per\xedodo"},{status:500});if(!S||0===S.length){let e=u.from("calculator_history").select("id, period_date, period_type, archived_at, model_id").eq("period_type",o);if(!_&&!g&&m.length>0){let{data:r}=await u.from("user_groups").select("user_id").in("group_id",m),o=(r||[]).map(e=>e.user_id);o.length>0&&(e=e.in("model_id",o))}let{data:s,error:t}=await e.eq("period_date",r).limit(10),[a,d]=r.split("-"),{data:n}=await u.from("calculator_history").select("period_date, period_type, archived_at, COUNT(*)").eq("period_type",o).gte("period_date",`${a}-${d}-01`).lte("period_date",`${a}-${d}-31`).limit(10);console.log(`ðŸ” [PERIOD-RATES-UPDATE] DEBUG - Registros encontrados:`,{period_date_exact:s?.length||0,period_date_sample:s?.slice(0,3),month_records:n?.length||0,month_sample:n?.slice(0,3),error:t});let c=s?.filter(e=>!e.archived_at)||[];if(c.length>0)return i.Z.json({success:!1,error:`Se encontraron ${s?.length||0} registros para el per\xedodo ${r} (${o}), pero ${c.length} no tienen 'archived_at'. El per\xedodo puede no haberse cerrado correctamente. Contacta al administrador.`},{status:404});if(R||D){let e;console.log(`âš ï¸ [PERIOD-RATES-UPDATE] Per\xedodo cerrado/reseteado pero sin registros archivados. Guardando rates en gestor_historical_rates.`),console.log(`ðŸ” [PERIOD-RATES-UPDATE] Estado de cierre: ${JSON.stringify(h)}, isPeriodClosed: ${R}, periodWasReset: ${D}`),console.log(`ðŸ’¾ [PERIOD-RATES-UPDATE] Guardando rates GLOBALES en gestor_historical_rates (aplican a todas las sedes)`);let{data:s}=await u.from("gestor_historical_rates").select("id").is("group_id",null).eq("period_date",r).eq("period_type",o).maybeSingle();if(s){let{error:r}=await u.from("gestor_historical_rates").update({rate_usd_cop:f.usd_cop,rate_eur_usd:f.eur_usd,rate_gbp_usd:f.gbp_usd,configurado_por:l,updated_at:new Date().toISOString()}).eq("id",s.id);e=r}else{let{error:s}=await u.from("gestor_historical_rates").insert({group_id:null,period_date:r,period_type:o,rate_usd_cop:f.usd_cop,rate_eur_usd:f.eur_usd,rate_gbp_usd:f.gbp_usd,configurado_por:l});e=s}if(e)return console.error(`âŒ [PERIOD-RATES-UPDATE] Error guardando rates globales:`,e),i.Z.json({success:!1,error:`Error guardando rates globales: ${e.message}`},{status:500});return i.Z.json({success:!0,message:`Per\xedodo ${r} (${o}) est\xe1 cerrado/reseteado pero no tiene registros archivados. Las rates GLOBALES se guardaron en gestor_historical_rates (aplican a todas las sedes).`,period_date:r,period_type:o,updated_count:0,saved_to_historical_rates:!0,warning:"No hay registros archivados para este per\xedodo. Las rates globales se guardaron para referencia futura."})}return i.Z.json({success:!1,error:`No se encontraron registros CERRADOS (archivados) para el per\xedodo ${r} (${o}). Solo se pueden editar tasas de per\xedodos que ya fueron cerrados. Total encontrado sin filtro: ${s?.length||0}`},{status:404})}if(!S.some(e=>e.archived_at))return i.Z.json({success:!1,error:"Este per\xedodo no est\xe1 cerrado. Solo se pueden editar tasas de per\xedodos archivados."},{status:400});console.log(`ðŸ“Š [PERIOD-RATES-UPDATE] Actualizando ${S.length} registros del per\xedodo ${r} (${o})`);let b=Array.from(new Set(S.map(e=>e.platform_id).filter(Boolean))),{data:y,error:v}=await u.from("calculator_platforms").select("id, currency").eq("active",!0).in("id",b);if(v)return console.error("âŒ [PERIOD-RATES-UPDATE] Error obteniendo plataformas:",v),i.Z.json({success:!1,error:"Error al obtener informaci\xf3n de plataformas"},{status:500});let U=new Map((y||[]).map(e=>[e.id,e])),O=(e,r,o,s)=>{if("EUR"===o)return"big7"===r?e*s.eur_usd*.84:"mondo"===r?e*s.eur_usd*.78:e*s.eur_usd;if("GBP"===o)return"aw"===r?e*s.gbp_usd*.677:e*s.gbp_usd;if("USD"===o){if("cmd"===r||"camlust"===r||"skypvt"===r)return .75*e;if("chaturbate"===r||"myfreecams"===r||"stripchat"===r)return .05*e;if("dxlive"===r)return .6*e;if("secretfriends"===r)return .5*e;else if("superfoon"===r)return e;else return e}return 0},x=S.map(e=>{let r=U.get(e.platform_id),o=r?.currency||"USD",s=Number(e.value)||0,t=e.platform_percentage||80,a=O(s,e.platform_id,o,f),d=t/100*a,i=d*f.usd_cop;return{id:e.id,rate_eur_usd:f.eur_usd,rate_gbp_usd:f.gbp_usd,rate_usd_cop:f.usd_cop,value_usd_bruto:parseFloat(a.toFixed(2)),value_usd_modelo:parseFloat(d.toFixed(2)),value_cop_modelo:parseFloat(i.toFixed(2))}}),w=0,I=[];console.log(`ðŸ”„ [PERIOD-RATES-UPDATE] Preparando actualizar ${x.length} registros...`);for(let e=0;e<x.length;e+=50){let r=x.slice(e,e+50);console.log(`ðŸ”„ [PERIOD-RATES-UPDATE] Procesando lote ${Math.floor(e/50)+1}/${Math.ceil(x.length/50)} (${r.length} registros)`);let o=r.map(async e=>{let{data:r,error:o}=await u.from("calculator_history").update({rate_eur_usd:e.rate_eur_usd,rate_gbp_usd:e.rate_gbp_usd,rate_usd_cop:e.rate_usd_cop,value_usd_bruto:e.value_usd_bruto,value_usd_modelo:e.value_usd_modelo,value_cop_modelo:e.value_cop_modelo}).eq("id",e.id).select("id").single();return o?(console.error(`âŒ [PERIOD-RATES-UPDATE] Error actualizando registro ${e.id}:`,{error:o,message:o.message,code:o.code,details:o.details,hint:o.hint}),I.push(`Registro ${e.id}: ${o.message||"Error desconocido"}`),!1):!!r&&!!r.id||(console.warn(`âš ï¸ [PERIOD-RATES-UPDATE] Registro ${e.id} no se actualiz\xf3. Posible problema de RLS o registro no encontrado.`),I.push(`Registro ${e.id}: No se encontr\xf3 para actualizar o bloqueado por RLS`),!1)}),s=(await Promise.all(o)).filter(e=>!0===e).length;w+=s,console.log(`âœ… [PERIOD-RATES-UPDATE] Lote completado: ${s}/${r.length} actualizados exitosamente`)}console.log(`ðŸ“Š [PERIOD-RATES-UPDATE] Resumen: ${w}/${x.length} registros actualizados exitosamente`);let q={action:"update_period_rates",period_date:r,period_type:o,admin_id:l,admin_name:c?.name||c?.email||"Desconocido",rates_before:{eur_usd:S[0]?.rate_eur_usd||null,gbp_usd:S[0]?.rate_gbp_usd||null,usd_cop:S[0]?.rate_usd_cop||null},rates_after:f,records_affected:w,updated_at:new Date().toISOString()};return console.log("\uD83D\uDCDD [PERIOD-RATES-AUDIT]",JSON.stringify(q,null,2)),I.length>0&&console.warn(`âš ï¸ [PERIOD-RATES-UPDATE] ${I.length} errores durante la actualizaci\xf3n`),console.log(`âœ… [PERIOD-RATES-UPDATE] ${w} de ${x.length} registros actualizados con nuevas tasas`),i.Z.json({success:!0,updated_count:w,total_records:S.length,errors:I.length>0?I:void 0,audit_log:q,message:`Tasas actualizadas exitosamente para ${w} registros del per\xedodo ${r} (${o}).`})}catch(e){return console.error("âŒ [PERIOD-RATES-UPDATE] Error:",e),i.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let p=new t.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/calculator-history/update-period-rates/route",pathname:"/api/admin/calculator-history/update-period-rates",filename:"route",bundlePath:"app/api/admin/calculator-history/update-period-rates/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\calculator-history\\update-period-rates\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:m,headerHooks:E,staticGenerationBailout:f}=p,h="/api/admin/calculator-history/update-period-rates/route";function R(){return(0,d.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),s=r.X(0,[1638,6206,2964],()=>o(69354));module.exports=s})();