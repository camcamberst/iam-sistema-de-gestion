"use strict";(()=>{var e={};e.id=7633,e.ids=[7633],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},78445:(e,t,o)=>{o.r(t),o.d(t,{headerHooks:()=>h,originalPathname:()=>v,patchFetch:()=>E,requestAsyncStorage:()=>m,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>_});var r={};o.r(r),o.d(r,{GET:()=>d,POST:()=>c});var a=o(95419),s=o(69108),n=o(99678),i=o(78070);let l=(0,o(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function c(e){try{console.log("\uD83D\uDD04 [UPDATE-MONTHLY-AVG] Iniciando actualizaci\xf3n de promedios mensuales...");let{data:e,error:t}=await l.from("users").select("id, email, name").eq("role","modelo");if(t)return console.error("❌ [UPDATE-MONTHLY-AVG] Error obteniendo modelos:",t),i.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});if(!e||0===e.length)return i.Z.json({success:!0,message:"No hay modelos para actualizar",updated:0});let o=new Date().toISOString().slice(0,7),r=new Date,a=new Date(r.getFullYear(),r.getMonth()+1,0).getDate(),s=0,n=[];for(let t of e)try{let{data:e,error:i}=await l.from("calculator_history").select("period_date").eq("model_id",t.id).gte("period_date",`${o}-01`).lt("period_date",`${o}-${a+1}`);if(i){console.error(`❌ [UPDATE-MONTHLY-AVG] Error obteniendo actividad para ${t.email}:`,i);continue}let c=new Set(e?.map(e=>e.period_date)||[]).size,d=Math.round(c/26*1e4)/100,{error:u}=await l.from("users").update({monthly_connection_avg:d,last_avg_calculation_date:r.toISOString().split("T")[0],last_avg_month:o}).eq("id",t.id);u?(console.error(`❌ [UPDATE-MONTHLY-AVG] Error actualizando ${t.email}:`,u),n.push({model:t.email,success:!1,error:u.message})):(console.log(`✅ [UPDATE-MONTHLY-AVG] Actualizado ${t.email}: ${d}% (${c}/26 d\xedas)`),n.push({model:t.email,success:!0,monthlyAvg:d,daysActive:c,workingDays:26}),s++)}catch(e){console.error(`❌ [UPDATE-MONTHLY-AVG] Error procesando ${t.email}:`,e),n.push({model:t.email,success:!1,error:e instanceof Error?e.message:"Error desconocido"})}return console.log(`✅ [UPDATE-MONTHLY-AVG] Proceso completado. ${s}/${e.length} modelos actualizados`),i.Z.json({success:!0,message:`Promedios mensuales actualizados para ${s} de ${e.length} modelos`,currentMonth:o,updated:s,total:e.length,results:n})}catch(e){return console.error("❌ [UPDATE-MONTHLY-AVG] Error general:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function d(e){try{let{data:e,error:t}=await l.from("users").select("id, email, name, monthly_connection_avg, last_avg_calculation_date, last_avg_month").eq("role","modelo").order("last_avg_calculation_date",{ascending:!1});if(t)return i.Z.json({success:!1,error:"Error al obtener datos"},{status:500});let o=new Date().toISOString().slice(0,7),r=e?.filter(e=>e.last_avg_month===o).length||0;return i.Z.json({success:!0,currentMonth:o,totalModels:e?.length||0,upToDate:r,needsUpdate:(e?.length||0)-r,models:e?.map(e=>({email:e.email,name:e.name,monthlyAvg:e.monthly_connection_avg,lastCalculation:e.last_avg_calculation_date,lastMonth:e.last_avg_month,isCurrentMonth:e.last_avg_month===o}))})}catch(e){return i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/update-monthly-connection-avg/route",pathname:"/api/admin/update-monthly-connection-avg",filename:"route",bundlePath:"app/api/admin/update-monthly-connection-avg/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\update-monthly-connection-avg\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:h,staticGenerationBailout:_}=u,v="/api/admin/update-monthly-connection-avg/route";function E(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[1638,6206,2964],()=>o(78445));module.exports=r})();