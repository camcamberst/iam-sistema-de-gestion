"use strict";(()=>{var e={};e.id=8627,e.ids=[8627],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},41119:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>h,originalPathname:()=>S,patchFetch:()=>E,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var t={};o.r(t),o.d(t,{GET:()=>c,POST:()=>l});var a=o(95419),s=o(69108),i=o(99678),n=o(78070);let d=(0,o(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(e){try{console.log("\uD83D\uDD04 [PROCESS-HISTORICAL-QUINCENAL] Iniciando procesamiento de datos hist\xf3ricos...");let{data:e,error:r}=await d.from("users").select("id, email, name").eq("role","modelo");if(r)return console.error("âŒ [PROCESS-HISTORICAL-QUINCENAL] Error obteniendo modelos:",r),n.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});if(!e||0===e.length)return n.Z.json({success:!0,message:"No hay modelos para procesar",processed:0});let o=0,t=[];for(let r of e){console.log(`ðŸ‘¤ Procesando datos hist\xf3ricos para: ${r.email}`);try{let{data:e,error:a}=await d.from("calculator_history").select(`
            platform_id,
            period_date,
            value
          `).eq("model_id",r.id).order("period_date",{ascending:!0});if(a){console.error(`âŒ Error obteniendo historial para ${r.email}:`,a),t.push({model:r.email,success:!1,error:a.message});continue}if(!e||0===e.length){console.log(`âš ï¸ No hay datos hist\xf3ricos para ${r.email}`),t.push({model:r.email,success:!0,message:"No hay datos hist\xf3ricos",quincenas:0});continue}let s=new Map;e.forEach(e=>{let r=new Date(e.period_date),o=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),a=r.getDate(),i=a>=1&&a<=15?"1":"2",n=`${o}-${t}-${i}`,d=e.platform_id;s.has(d)||s.set(d,new Map);let l=s.get(d);l.has(n)||l.set(n,{totalUsd:0,days:new Set,periodStart:r,periodEnd:r});let c=l.get(n),u=e.value||0;c.totalUsd+=u,c.days.add(e.period_date),c.periodStart=c.periodStart<r?c.periodStart:r,c.periodEnd=c.periodEnd>r?c.periodEnd:r});let i=0;for(let[e,o]of Array.from(s.entries()))for(let[t,a]of Array.from(o.entries()))try{let o=a.days.size>0?a.totalUsd/a.days.size:0,{error:s}=await d.from("platform_quincenal_stats").upsert({model_id:r.id,platform_id:e,quincena:t,daily_avg_usd:Math.round(100*o)/100,total_days:a.days.size,total_usd_modelo:Math.round(100*a.totalUsd)/100,period_start:a.periodStart.toISOString().split("T")[0],period_end:a.periodEnd.toISOString().split("T")[0]},{onConflict:"model_id,platform_id,quincena"});s?console.error(`âŒ Error insertando estad\xedstica para ${r.email} - ${e} - ${t}:`,s):(i++,console.log(`âœ… Procesado ${r.email} - ${e} - ${t}: $${o.toFixed(2)} (${a.days.size} d\xedas)`))}catch(e){console.error(`âŒ Error procesando quincena ${t} para ${r.email}:`,e)}t.push({model:r.email,success:!0,quincenas:i,platforms:s.size}),o++}catch(e){console.error(`âŒ Error procesando ${r.email}:`,e),t.push({model:r.email,success:!1,error:e instanceof Error?e.message:"Error desconocido"})}}return console.log(`âœ… [PROCESS-HISTORICAL-QUINCENAL] Proceso completado. ${o} modelos procesados`),n.Z.json({success:!0,message:`Datos hist\xf3ricos procesados: ${o} modelos`,processed:o,totalModels:e.length,results:t})}catch(e){return console.error("âŒ [PROCESS-HISTORICAL-QUINCENAL] Error general:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function c(e){try{let{data:e,error:r}=await d.from("calculator_history").select(`
        model_id,
        period_date,
        platform_id,
        usd_modelo,
        users!inner(email, name)
      `).order("period_date",{ascending:!1}).limit(100);if(r)return n.Z.json({success:!1,error:"Error al obtener datos hist\xf3ricos"},{status:500});let o=e?.reduce((e,r)=>{let o=r.users?.email||"Unknown";e[o]||(e[o]={email:o,name:r.users?.name||"Unknown",totalRecords:0,platforms:new Set,dateRange:{earliest:null,latest:null}}),e[o].totalRecords++,e[o].platforms.add(r.platform_id);let t=new Date(r.period_date);return(!e[o].dateRange.earliest||t<e[o].dateRange.earliest)&&(e[o].dateRange.earliest=t),(!e[o].dateRange.latest||t>e[o].dateRange.latest)&&(e[o].dateRange.latest=t),e},{})||{};return Object.values(o).forEach(e=>{e.platforms=Array.from(e.platforms),e.dateRange.earliest=e.dateRange.earliest?.toISOString().split("T")[0],e.dateRange.latest=e.dateRange.latest?.toISOString().split("T")[0]}),n.Z.json({success:!0,totalRecords:e?.length||0,models:Object.values(o),message:"Datos hist\xf3ricos disponibles para procesamiento"})}catch(e){return n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/process-historical-quincenal/route",pathname:"/api/admin/process-historical-quincenal",filename:"route",bundlePath:"app/api/admin/process-historical-quincenal/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\process-historical-quincenal\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:h,staticGenerationBailout:f}=u,S="/api/admin/process-historical-quincenal/route";function E(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(41119));module.exports=t})();