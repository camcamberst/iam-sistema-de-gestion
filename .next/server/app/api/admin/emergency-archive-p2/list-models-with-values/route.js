"use strict";(()=>{var e={};e.id=6740,e.ids=[6740],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},53624:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>f,originalPathname:()=>S,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{GET:()=>c});var o=r(95419),s=r(69108),i=r(99678),d=r(78070),l=r(72964);let n="https://mhernfrkvwigxdubiozm.supabase.co",u=process.env.SUPABASE_SERVICE_ROLE_KEY;async function p(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return{error:"No autorizado",user:null};let r=t.substring(7),a=(0,l.createClient)(n,u),{data:{user:o},error:s}=await a.auth.getUser(r);if(s||!o)return{error:"Token inv\xe1lido",user:null};let{data:i}=await a.from("users").select("role").eq("id",o.id).single();return i&&("admin"===i.role||"superadmin"===i.role)?{error:null,user:o}:{error:"No tienes permisos de administrador",user:null}}let m=(0,l.createClient)(n,u);async function c(e){try{let t,r,a;let o=await p(e);if(o.error||!o.user)return d.Z.json({success:!1,error:o.error||"No autorizado"},{status:401});let{searchParams:s}=new URL(e.url),i=s.get("period")||"p2-december";if(console.log("\uD83D\uDD0D [LIST-MODELS] Listando modelos con valores, per\xedodo:",i),"p2-december"===i)t="2025-12-16",r="2025-12-31",a="P2 de Diciembre 2025";else if("all"===i)t="2000-01-01",r="2099-12-31",a="Todos los per\xedodos";else{let e=new Date,o=e.getFullYear(),s=e.getMonth()+1;if(15>=e.getDate())t=`${o}-${String(s).padStart(2,"0")}-01`,r=`${o}-${String(s).padStart(2,"0")}-15`,a=`P1 de ${s}/${o}`;else{t=`${o}-${String(s).padStart(2,"0")}-16`;let e=new Date(o,s,0).getDate();r=`${o}-${String(s).padStart(2,"0")}-${String(e).padStart(2,"0")}`,a=`P2 de ${s}/${o}`}}let{data:l,error:n}=await m.from("model_values").select("model_id, platform_id, value, period_date, updated_at").gte("period_date",t).lte("period_date",r).order("model_id").order("period_date",{ascending:!1});if(n)return console.error("❌ [LIST-MODELS] Error obteniendo valores:",n),d.Z.json({success:!1,error:n.message},{status:500});let u=new Map;l?.forEach(e=>{u.has(e.model_id)||u.set(e.model_id,{model_id:e.model_id,email:"",total_values:0,unique_platforms:0,periods:[],values_by_period:{},latest_update:e.updated_at});let t=u.get(e.model_id);t.total_values++,t.periods.includes(e.period_date)||t.periods.push(e.period_date),t.values_by_period[e.period_date]||(t.values_by_period[e.period_date]=0),t.values_by_period[e.period_date]++,new Date(e.updated_at)>new Date(t.latest_update)&&(t.latest_update=e.updated_at)});let c=Array.from(u.keys());if(c.length>0){let{data:e}=await m.from("users").select("id, email").in("id",c);e?.forEach(e=>{let t=u.get(e.id);t&&(t.email=e.email)})}u.forEach((e,t)=>{let r=new Set(l?.filter(e=>e.model_id===t).map(e=>e.platform_id));e.unique_platforms=r.size});let _=Array.from(u.values()),{data:h,error:g}=await m.from("calculator_totals").select("model_id, period_date, total_usd_bruto, total_usd_modelo, updated_at").in("model_id",c.length>0?c:["00000000-0000-0000-0000-000000000000"]).gte("period_date",t).lte("period_date",r),v=new Map;return h?.forEach(e=>{v.has(e.model_id)||v.set(e.model_id,[]),v.get(e.model_id).push(e)}),_.forEach(e=>{e.totals=v.get(e.model_id)||[]}),d.Z.json({success:!0,period:a,date_range:{start:t,end:r},summary:{total_models:_.length,total_values:l?.length||0,models_with_totals:Array.from(v.keys()).length},models:_.map(e=>({...e,totals:e.totals||[]}))})}catch(e){return console.error("❌ [LIST-MODELS] Error:",e),d.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/list-models-with-values/route",pathname:"/api/admin/emergency-archive-p2/list-models-with-values",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/list-models-with-values/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\list-models-with-values\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:v,headerHooks:f,staticGenerationBailout:w}=_,S="/api/admin/emergency-archive-p2/list-models-with-values/route";function y(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2964],()=>r(53624));module.exports=a})();