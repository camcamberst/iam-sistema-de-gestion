"use strict";(()=>{var e={};e.id=2800,e.ids=[2800],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},51112:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>L,originalPathname:()=>A,patchFetch:()=>U,requestAsyncStorage:()=>p,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>T});var a={};r.r(a),r.d(a,{DELETE:()=>D,POST:()=>g});var t=r(95419),i=r(69108),l=r(99678),s=r(78070),n=r(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",E=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let o=e.headers.get("authorization");if(console.log("\uD83D\uDD10 [DELETE-AUTH] Verificando autenticaci\xf3n..."),console.log("\uD83D\uDD10 [DELETE-AUTH] Header authorization:",o?"Presente":"Ausente"),!o)return console.error("âŒ [DELETE-AUTH] No hay header de autorizaci\xf3n"),{error:"Token de autorizaci\xf3n requerido",user:null};if(!o.startsWith("Bearer "))return console.error("âŒ [DELETE-AUTH] Header no tiene formato Bearer"),{error:"Token de autorizaci\xf3n requerido",user:null};let r=o.split(" ")[1];if(!r)return console.error("âŒ [DELETE-AUTH] Token vac\xedo"),{error:"Token de autorizaci\xf3n requerido",user:null};console.log("\uD83D\uDD10 [DELETE-AUTH] Token obtenido, verificando con Supabase...");let a=(0,n.createClient)(d,E,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:t},error:i}=await a.auth.getUser(r);if(i)return console.error("âŒ [DELETE-AUTH] Error verificando token:",i.message),{error:`Token inv\xe1lido: ${i.message}`,user:null};if(!t)return console.error("âŒ [DELETE-AUTH] Usuario no encontrado"),{error:"Token inv\xe1lido",user:null};console.log("âœ… [DELETE-AUTH] Usuario autenticado:",t.id);let{data:l,error:s}=await a.from("users").select("role").eq("id",t.id).single();return s?(console.error("âŒ [DELETE-AUTH] Error obteniendo datos de usuario:",s.message),{error:`Error obteniendo datos de usuario: ${s.message}`,user:null}):l?(console.log("\uD83D\uDD10 [DELETE-AUTH] Rol del usuario:",l.role),"admin"!==l.role&&"super_admin"!==l.role)?(console.error("âŒ [DELETE-AUTH] Rol no autorizado:",l.role),{error:"No autorizado. Se requiere rol de admin o super_admin",user:null}):(console.log("âœ… [DELETE-AUTH] Autenticaci\xf3n exitosa para:",l.role),{error:null,user:{id:t.id,role:l.role}}):(console.error("âŒ [DELETE-AUTH] Datos de usuario no encontrados"),{error:"Error obteniendo datos de usuario",user:null})}let u=(0,n.createClient)(d,E);async function m(e=!1){let o="2025-12-16",r="2025-12-31",a="16-31",t=new Date(`${r}T23:59:59.999Z`).toISOString();e&&console.log("âš ï¸ [DELETE-VALUES] MODO FORZADO: Se eliminar\xe1n valores incluso sin archivo"),console.log("\uD83D\uDDD1ï¸ [DELETE-VALUES] Iniciando eliminaci\xf3n de valores de P2 de diciembre..."),console.log(`ðŸ“… [DELETE-VALUES] Rango: ${o} a ${r}`),e?console.log(`âš ï¸ [DELETE-VALUES] MODO FORZADO: Eliminando TODOS los valores del per\xedodo (sin filtro de updated_at)`):console.log(`â° [DELETE-VALUES] Solo valores hasta: ${t}`);let i=u.from("model_values").select("model_id").gte("period_date",o).lte("period_date",r);e||(i=i.lte("updated_at",t));let{data:l,error:s}=await i;if(s)throw console.error("âŒ [DELETE-VALUES] Error obteniendo valores:",s),Error(`Error obteniendo valores: ${s.message}`);if(!l||0===l.length)return{success:!0,mensaje:"No hay valores para eliminar",eliminados:0,resumen:{total_modelos:0,exitosos:0,errores:0,modelos_sin_archivo:0,total_eliminados:0,residuales_restantes:0},resultados:[]};let n=Array.from(new Set(l.map(e=>e.model_id)));console.log(`ðŸ“¦ [DELETE-VALUES] Modelos con valores: ${n.length}`);let{data:d}=await u.from("users").select("id, email").in("id",n),E=new Map(d?.map(e=>[e.id,e.email])||[]);console.log("\uD83D\uDD0D [DELETE-VALUES] Verificando que los modelos tienen archivo...");let c=[],m=0,D=0;for(let i of n){let l=E.get(i)||i,s={model_id:i,email:l,tiene_archivo:!1,registros_archivados:0,valores_eliminados:0,error:null,valores_en_model_values:0},n=u.from("model_values").select("*",{count:"exact",head:!0}).eq("model_id",i).gte("period_date",o).lte("period_date",r);e||(n=n.lte("updated_at",t));let{count:d}=await n;s.valores_en_model_values=d||0;let{data:g,error:_}=await u.from("calculator_history").select("platform_id, period_date").eq("model_id",i).eq("period_type",a).gte("period_date",o).lte("period_date",r);!_&&g&&g.length>0?(s.tiene_archivo=!0,s.registros_archivados=g.length,s.period_date_encontrado=g[0].period_date,m++,console.log(`âœ… [DELETE-VALUES] ${l}: Tiene ${g.length} registros archivados (period_date: ${g[0].period_date})`)):(D++,s.error=`No tiene archivo en calculator_history para period_date=${o}, period_type=${a}`,_&&(s.error+=` (Error: ${_.message})`),console.log(`âš ï¸ [DELETE-VALUES] ${l}: NO tiene archivo. Valores en model_values: ${s.valores_en_model_values}`)),c.push(s)}if(console.log(`âœ… [DELETE-VALUES] Modelos con archivo: ${m}`),console.log(`âš ï¸ [DELETE-VALUES] Modelos sin archivo (se omitir\xe1n): ${D}`),0===m&&!e)return console.log("âš ï¸ [DELETE-VALUES] No hay modelos con archivo. No se eliminar\xe1 ning\xfan valor."),{success:!0,mensaje:`No se eliminaron valores. ${D} modelo(s) no tienen archivo y fueron omitidos por seguridad.`,eliminados:0,resumen:{total_modelos:c.length,exitosos:0,errores:D,modelos_sin_archivo:D,total_eliminados:0,residuales_restantes:l.length},resultados:c};e&&0===m&&console.log("âš ï¸ [DELETE-VALUES] MODO FORZADO: Eliminando valores de modelos sin archivo...");let g=e?c.length:m,_=e?0:D;console.log(`ðŸ—‘ï¸ [DELETE-VALUES] Eliminando valores de ${g} modelo(s) ${e?"(MODO FORZADO - incluyendo sin archivo)":"(solo con archivo)"} (omitidos ${_} sin archivo)...`);let p=0,v=0,h=0;for(let a of c){if(!a.tiene_archivo&&!e){console.log(`â­ï¸ [DELETE-VALUES] ${a.email}: Omitido (no tiene archivo, ${a.valores_en_model_values} valores no eliminados)`);continue}!a.tiene_archivo&&e&&console.log(`âš ï¸ [DELETE-VALUES] ${a.email}: MODO FORZADO - Eliminando sin archivo (${a.valores_en_model_values} valores)`),console.log(`ðŸ—‘ï¸ [DELETE-VALUES] Eliminando valores de ${a.email}...`);try{let i=u.from("model_values").delete().eq("model_id",a.model_id).gte("period_date",o).lte("period_date",r);e?console.log(`   âš ï¸ [DELETE-VALUES] MODO FORZADO: Eliminando TODOS los valores del per\xedodo (sin filtro de updated_at)`):i=i.lte("updated_at",t);let{data:l,error:s}=await i.select();if(s)a.error=`Error eliminando: ${s.message}`,console.error(`âŒ [DELETE-VALUES] Error eliminando ${a.email}:`,s),v++;else{let e=l?.length||0;a.valores_eliminados=e,h+=e,console.log(`âœ… [DELETE-VALUES] ${a.email}: ${e} valores eliminados`),p++}}catch(e){a.error=e.message||"Error desconocido",console.error(`âŒ [DELETE-VALUES] Error cr\xedtico eliminando ${a.email}:`,e),v++}}console.log("\uD83D\uDD0D [DELETE-VALUES] Verificaci\xf3n final...");let L=u.from("model_values").select("model_id").gte("period_date",o).lte("period_date",r);e||(L=L.lte("updated_at",t));let{data:T}=await L,A=T?.length||0;console.log(`âœ… [DELETE-VALUES] Proceso completado: ${p} exitosos, ${v} errores, ${h} valores eliminados`);let U=c.filter(e=>!e.tiene_archivo),f=c.filter(e=>e.tiene_archivo&&e.error),S=`Eliminaci\xf3n completada. ${h} valores eliminados de ${p} modelo(s).`;return U.length>0&&(S+=` ${U.length} modelo(s) omitido(s) por no tener archivo.`),f.length>0&&(S+=` ${f.length} modelo(s) con errores.`),{success:!0,mensaje:S,resumen:{total_modelos:c.length,exitosos:p,errores:f.length,modelos_omitidos:U.length,modelos_sin_archivo:D,total_eliminados:h,residuales_restantes:A},resultados:c}}async function D(e){try{console.log("\uD83D\uDDD1ï¸ [DELETE-VALUES] Endpoint DELETE llamado");let o=await c(e);if(o.error||!o.user)return console.error("âŒ [DELETE-VALUES] Error de autenticaci\xf3n:",o.error),s.Z.json({success:!1,error:o.error||"No autorizado"},{status:401});console.log("âœ… [DELETE-VALUES] Autenticaci\xf3n exitosa, usuario:",o.user.id);let{searchParams:r}=new URL(e.url),a="true"===r.get("force"),t=await m(a);return s.Z.json(t)}catch(e){return console.error("âŒ [DELETE-VALUES] Error:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function g(e){try{console.log("\uD83D\uDDD1ï¸ [DELETE-VALUES] Endpoint POST llamado (alternativa)");let o=await c(e);if(o.error||!o.user)return console.error("âŒ [DELETE-VALUES] Error de autenticaci\xf3n:",o.error),s.Z.json({success:!1,error:o.error||"No autorizado"},{status:401});console.log("âœ… [DELETE-VALUES] Autenticaci\xf3n exitosa, usuario:",o.user.id);let r=!1;try{let o=await e.json();r=!0===o.force}catch{let{searchParams:o}=new URL(e.url);r="true"===o.get("force")}let a=await m(r);return s.Z.json(a)}catch(e){return console.error("âŒ [DELETE-VALUES] Error:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let _=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/delete/route",pathname:"/api/admin/emergency-archive-p2/delete",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/delete/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\delete\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:v,serverHooks:h,headerHooks:L,staticGenerationBailout:T}=_,A="/api/admin/emergency-archive-p2/delete/route";function U(){return(0,l.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}}};var o=require("../../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),a=o.X(0,[1638,6206,2964],()=>r(51112));module.exports=a})();