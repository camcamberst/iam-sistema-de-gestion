"use strict";(()=>{var e={};e.id=5789,e.ids=[5789],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},50144:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>A,originalPathname:()=>C,patchFetch:()=>T,requestAsyncStorage:()=>E,routeModule:()=>p,serverHooks:()=>R,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>h});var t={};r.r(t),r.d(t,{POST:()=>_});var l=r(95419),a=r(69108),s=r(99678),i=r(78070),d=r(72964);let c="https://mhernfrkvwigxdubiozm.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY;async function u(e){let o=e.headers.get("authorization");if(!o||!o.startsWith("Bearer "))return{error:"No autorizado",user:null};let r=o.substring(7),t=(0,d.createClient)(c,n),{data:{user:l},error:a}=await t.auth.getUser(r);if(a||!l)return{error:"Token inv\xe1lido",user:null};let{data:s}=await t.from("users").select("role").eq("id",l.id).single();return s&&("admin"===s.role||"superadmin"===s.role)?{error:null,user:l}:{error:"No tienes permisos de administrador",user:null}}let m=(0,d.createClient)(c,n);async function _(e){try{let o=await u(e);if(o.error||!o.user)return i.Z.json({success:!1,error:o.error||"No autorizado"},{status:401});let{modelId:r,resetAll:t}=await e.json();if(!r&&!t)return i.Z.json({success:!1,error:"Se requiere modelId o resetAll=true"},{status:400});console.log("\uD83D\uDD04 [RESET-CALCULATOR] Iniciando reset completo de calculadora(s)..."),console.log(`ðŸ“‹ [RESET-CALCULATOR] ModelId: ${r||"ALL"}, ResetAll: ${t||!1}`);let l=[];if(t){let{data:e,error:o}=await m.from("users").select("id, email").eq("role","modelo").eq("is_active",!0);if(o)throw Error(`Error obteniendo modelos: ${o.message}`);l=e?.map(e=>e.id)||[],console.log(`ðŸ“‹ [RESET-CALCULATOR] Resetear ${l.length} modelos`)}else r&&(l=[r]);let a=[],s=0,d=0,c=0,n=0;for(let e of l){let o={model_id:e,email:"",model_values_deleted:0,calculator_totals_deleted:0,error:null};try{let{data:r}=await m.from("users").select("email").eq("id",e).single();o.email=r?.email||e,console.log(`ðŸ”„ [RESET-CALCULATOR] Reseteando calculadora de ${o.email}...`),console.log(`   ðŸ—‘ï¸ [RESET-CALCULATOR] Eliminando valores de model_values...`);let{data:t,error:l}=await m.from("model_values").delete().eq("model_id",e).select();if(l)throw Error(`Error eliminando model_values: ${l.message}`);o.model_values_deleted=t?.length||0,s+=o.model_values_deleted,console.log(`   âœ… [RESET-CALCULATOR] ${o.model_values_deleted} valores eliminados de model_values`),console.log(`   ðŸ—‘ï¸ [RESET-CALCULATOR] Eliminando totales de calculator_totals...`);let{data:a,error:i}=await m.from("calculator_totals").delete().eq("model_id",e).select();if(i)throw Error(`Error eliminando calculator_totals: ${i.message}`);o.calculator_totals_deleted=a?.length||0,d+=o.calculator_totals_deleted,console.log(`   âœ… [RESET-CALCULATOR] ${o.calculator_totals_deleted} totales eliminados de calculator_totals`),c++,console.log(`   âœ… [RESET-CALCULATOR] ${o.email}: Reset completo exitoso`)}catch(e){o.error=e.message||"Error desconocido",n++,console.error(`   âŒ [RESET-CALCULATOR] Error reseteando ${o.email}:`,e)}a.push(o)}console.log("\uD83D\uDD0D [RESET-CALCULATOR] Verificaci\xf3n final...");let _=0,p=0;if(t){let{count:e}=await m.from("model_values").select("*",{count:"exact",head:!0}).in("model_id",l),{count:o}=await m.from("calculator_totals").select("*",{count:"exact",head:!0}).in("model_id",l);_=e||0,p=o||0}else if(r){let{count:e}=await m.from("model_values").select("*",{count:"exact",head:!0}).eq("model_id",r),{count:o}=await m.from("calculator_totals").select("*",{count:"exact",head:!0}).eq("model_id",r);_=e||0,p=o||0}return console.log(`âœ… [RESET-CALCULATOR] Proceso completado: ${c} exitosos, ${n} errores`),console.log(`ðŸ“Š [RESET-CALCULATOR] Total valores eliminados: ${s}, Total totales eliminados: ${d}`),console.log(`ðŸ” [RESET-CALCULATOR] Valores residuales: ${_}, Totales residuales: ${p}`),i.Z.json({success:!0,mensaje:`Reset completo realizado. ${s} valores y ${d} totales eliminados de ${c} modelo(s).`,resumen:{total_modelos:a.length,exitosos:c,errores:n,total_model_values_deleted:s,total_calculator_totals_deleted:d,residuales_model_values:_,residuales_calculator_totals:p},resultados:a})}catch(e){return console.error("âŒ [RESET-CALCULATOR] Error:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let p=new l.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/reset-calculator/route",pathname:"/api/admin/emergency-archive-p2/reset-calculator",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/reset-calculator/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\reset-calculator\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:E,staticGenerationAsyncStorage:g,serverHooks:R,headerHooks:A,staticGenerationBailout:h}=p,C="/api/admin/emergency-archive-p2/reset-calculator/route";function T(){return(0,s.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:g})}}};var o=require("../../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>r(50144));module.exports=t})();