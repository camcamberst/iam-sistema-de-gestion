"use strict";(()=>{var e={};e.id=1889,e.ids=[1889],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},42473:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>h,originalPathname:()=>A,patchFetch:()=>$,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>E});var a={};o.r(a),o.d(a,{POST:()=>_});var t=o(95419),s=o(69108),i=o(99678),l=o(78070),n=o(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",u=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let r=e.headers.get("authorization");if(console.log("\uD83D\uDD10 [AUTH] Verificando autenticaci\xf3n..."),console.log("\uD83D\uDD10 [AUTH] Header authorization:",r?"Presente":"Ausente"),!r)return console.error("‚ùå [AUTH] No hay header de autorizaci\xf3n"),{error:"Token de autorizaci\xf3n requerido",user:null};if(!r.startsWith("Bearer "))return console.error("‚ùå [AUTH] Header no tiene formato Bearer"),{error:"Token de autorizaci\xf3n requerido",user:null};let o=r.split(" ")[1];if(!o)return console.error("‚ùå [AUTH] Token vac\xedo"),{error:"Token de autorizaci\xf3n requerido",user:null};console.log("\uD83D\uDD10 [AUTH] Token obtenido, verificando con Supabase...");let a=(0,n.createClient)(d,u,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:t},error:s}=await a.auth.getUser(o);if(s)return console.error("‚ùå [AUTH] Error verificando token:",s.message),{error:`Token inv\xe1lido: ${s.message}`,user:null};if(!t)return console.error("‚ùå [AUTH] Usuario no encontrado"),{error:"Token inv\xe1lido",user:null};console.log("‚úÖ [AUTH] Usuario autenticado:",t.id);let{data:i,error:l}=await a.from("users").select("role").eq("id",t.id).single();return l?(console.error("‚ùå [AUTH] Error obteniendo datos de usuario:",l.message),{error:`Error obteniendo datos de usuario: ${l.message}`,user:null}):i?(console.log("\uD83D\uDD10 [AUTH] Rol del usuario:",i.role),"admin"!==i.role&&"super_admin"!==i.role)?(console.error("‚ùå [AUTH] Rol no autorizado:",i.role),{error:"No autorizado. Se requiere rol de admin o super_admin",user:null}):(console.log("‚úÖ [AUTH] Autenticaci\xf3n exitosa para:",i.role),{error:null,user:{id:t.id,role:i.role}}):(console.error("‚ùå [AUTH] Datos de usuario no encontrados"),{error:"Error obteniendo datos de usuario",user:null})}let p=(0,n.createClient)(d,u);async function _(e){try{let r=await c(e);if(r.error||!r.user)return l.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let o="16-31",a="2025-12-16",t="2025-12-31";console.log("\uD83D\uDEA8 [EMERGENCY-ARCHIVE] Iniciando archivado de emergencia para P2 de diciembre...");let{data:s,error:i}=await p.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1});if(i)throw i;let n={eur_usd:s?.find(e=>"EUR‚ÜíUSD"===e.kind)?.value||1.01,gbp_usd:s?.find(e=>"GBP‚ÜíUSD"===e.kind)?.value||1.2,usd_cop:s?.find(e=>"USD‚ÜíCOP"===e.kind)?.value||3900},{data:d,error:u}=await p.from("calculator_platforms").select("id, currency").eq("active",!0);if(u)throw u;let _=new Map(d.map(e=>[e.id,e])),m=new Date(`${t}T23:59:59.999Z`),g=m.toISOString();console.log(`üìÖ [EMERGENCY-ARCHIVE] Rango: ${a} a ${t}`),console.log(`‚è∞ [EMERGENCY-ARCHIVE] Solo valores hasta: ${g}`);let{data:f,error:v}=await p.from("model_values").select("model_id, platform_id, value, updated_at, period_date").gte("period_date",a).lte("period_date",t).order("updated_at",{ascending:!1});if(v)throw v;if(!f||0===f.length)return l.Z.json({success:!1,error:"No hay valores para archivar en el per\xedodo especificado"},{status:404});console.log(`üì¶ [EMERGENCY-ARCHIVE] Total valores encontrados: ${f.length}`);let h=f.filter(e=>new Date(e.updated_at)<=m);if(console.log(`üì¶ [EMERGENCY-ARCHIVE] Valores vigentes hasta ${g}: ${h.length}`),0===h.length)return l.Z.json({success:!1,error:`No hay valores vigentes hasta ${g} en el per\xedodo especificado`},{status:404});let E=new Map;h.forEach(e=>{E.has(e.model_id)||E.set(e.model_id,new Map);let r=E.get(e.model_id),o=r.get(e.platform_id);(!o||new Date(e.updated_at)>new Date(o.updated_at))&&r.set(e.platform_id,e)}),console.log(`üì¶ [EMERGENCY-ARCHIVE] Modelos a procesar: ${E.size}`);let A=new Set(f.map(e=>e.model_id)),$=new Set(h.map(e=>e.model_id)),R=Array.from(A).filter(e=>!$.has(e));R.length>0&&(console.log(`‚ö†Ô∏è [EMERGENCY-ARCHIVE] Modelos con valores pero excluidos por filtro de fecha: ${R.length}`),R.forEach(e=>{let r=f.filter(r=>r.model_id===e).reduce((e,r)=>{let o=new Date(r.updated_at);return o>e?o:e},new Date(0));console.log(`   - Modelo ${e}: m\xe1ximo updated_at = ${r.toISOString()} (l\xedmite: ${g})`)}));let H=Array.from(E.keys()),{data:C}=await p.from("users").select("id, email").in("id",H),y=new Map(C?.map(e=>[e.id,e.email])||[]),w=[],I=0,V=0;for(let[e,r]of Array.from(E.entries())){let t=y.get(e)||e,s={model_id:e,email:t,plataformas:r.size,archivados:0,eliminados:0,error:null};try{for(let[o,a]of(console.log(`
üì¶ [ARCHIVE] Procesando modelo: ${t} (${e})`),console.log(`üì¶ [ARCHIVE] Plataformas a archivar: ${r.size}`),console.log(`üì¶ [ARCHIVE] Valores a archivar:`),Array.from(r.entries())))console.log(`   - Plataforma ${o}: ${a.value} (updated_at: ${a.updated_at}, period_date: ${a.period_date})`);console.log(`üì¶ [ARCHIVE] Obteniendo configuraci\xf3n...`);let{data:i,error:l}=await p.from("calculator_config").select("percentage_override, group_percentage").eq("model_id",e).eq("active",!0).single();if(l&&"PGRST116"!==l.code)throw console.error(`‚ùå [ARCHIVE] Error obteniendo config:`,l),Error(`Error obteniendo configuraci\xf3n: ${l.message}`);let d=i?.percentage_override||i?.group_percentage||80;console.log(`üì¶ [ARCHIVE] Porcentaje del modelo: ${d}%`),console.log(`üì¶ [ARCHIVE] Preparando registros hist\xf3ricos...`);let u=[];for(let[t,s]of Array.from(r.entries())){let r=_.get(t),i=r?.currency||"USD",l=Number(s.value)||0;if(l<=0){console.log(`   ‚ö†Ô∏è Saltando plataforma ${t}: valor ${l} <= 0`);continue}let c=function(e,r,o,a){let t=String(r||"").toLowerCase().replace(/[^a-z0-9]/g,"");if("EUR"===o)return"big7"===t?e*a.eur_usd*.84:"mondo"===t?e*a.eur_usd*.78:e*a.eur_usd;if("GBP"===o)return"aw"===t?e*a.gbp_usd*.677:e*a.gbp_usd;if("USD"===o){if("cmd"===t||"camlust"===t||"skypvt"===t)return .75*e;if("chaturbate"===t||"myfreecams"===t||"stripchat"===t)return .05*e;if("dxlive"===t)return .6*e;if("secretfriends"===t)return .5*e;else if("superfoon"===t)return e;else return e}return 0}(l,t,i,n),p=d/100*c,m=p*n.usd_cop;if(!e||!t||!a||!o){console.error(`   ‚ùå Campos requeridos faltantes: modelId=${e}, platformId=${t}, startDate=${a}, periodType=${o}`);continue}let g={model_id:e,platform_id:t,period_date:a,period_type:o,value:parseFloat(l.toFixed(2)),rate_eur_usd:n.eur_usd||null,rate_gbp_usd:n.gbp_usd||null,rate_usd_cop:n.usd_cop||null,platform_percentage:d,value_usd_bruto:parseFloat(c.toFixed(2)),value_usd_modelo:parseFloat(p.toFixed(2)),value_cop_modelo:parseFloat(m.toFixed(2)),archived_at:new Date().toISOString(),original_updated_at:s.updated_at||null};if(isNaN(g.value)||isNaN(g.value_usd_bruto)||isNaN(g.value_usd_modelo)||isNaN(g.value_cop_modelo)){console.error(`   ‚ùå Valores num\xe9ricos inv\xe1lidos para plataforma ${t}:`,g);continue}u.push(g)}if(console.log(`üì¶ [ARCHIVE] Registros preparados: ${u.length}`),0===u.length){console.error(`‚ùå [ARCHIVE] No hay valores v\xe1lidos para ${t}`),s.error="No hay valores v\xe1lidos",V++,w.push(s);continue}console.log(`üì¶ [ARCHIVE] Insertando ${u.length} registros en calculator_history...`);let c=0,m=0,g=0;for(let e of u)try{let{data:r,error:o}=await p.from("calculator_history").select("id").eq("model_id",e.model_id).eq("platform_id",e.platform_id).eq("period_date",e.period_date).eq("period_type",e.period_type).single();if(o&&"PGRST116"!==o.code){console.error(`   ‚ö†Ô∏è Error verificando existencia:`,o),g++;continue}if(r){let{error:o}=await p.from("calculator_history").update({value:e.value,rate_eur_usd:e.rate_eur_usd,rate_gbp_usd:e.rate_gbp_usd,rate_usd_cop:e.rate_usd_cop,platform_percentage:e.platform_percentage,value_usd_bruto:e.value_usd_bruto,value_usd_modelo:e.value_usd_modelo,value_cop_modelo:e.value_cop_modelo,archived_at:e.archived_at,original_updated_at:e.original_updated_at}).eq("id",r.id);o?(console.error(`   ‚ùå Error actualizando registro:`,o),g++):m++}else{let{error:r}=await p.from("calculator_history").insert(e);r?(console.error(`   ‚ùå Error insertando registro:`,r),g++):c++}}catch(e){console.error(`   ‚ùå Error procesando registro:`,e),g++}if(console.log(`üì¶ [ARCHIVE] Resultado: ${c} insertados, ${m} actualizados, ${g} errores`),g>0&&0===c&&0===m)throw Error(`Error insertando registros: ${g} errores de ${u.length} intentos`);console.log(`üì¶ [ARCHIVE] Verificando inserci\xf3n...`);let{data:f,error:v}=await p.from("calculator_history").select("id, platform_id").eq("model_id",e).eq("period_date",a).eq("period_type",o);if(v)throw console.error(`‚ùå [ARCHIVE] Error verificando inserci\xf3n:`,v),Error(`Error verificando: ${v.message}`);let h=f?.length||0,E=c+m;if(console.log(`üì¶ [ARCHIVE] Verificados: ${h} de ${u.length} esperados`),console.log(`üì¶ [ARCHIVE] Procesados: ${E} (${c} insertados, ${m} actualizados)`),g>0&&0===E){let e=`Error procesando registros: ${g} errores de ${u.length} intentos`;throw console.error(`‚ùå [ARCHIVE] ${e}`),Error(e)}h<u.length&&E>0&&console.warn(`‚ö†Ô∏è [ARCHIVE] Se procesaron ${E} pero se verificaron ${h}. Continuando...`),s.archivados=h,s.eliminados=0,s.insertados=c,s.actualizados=m,s.errores_procesamiento=g,I++,w.push(s),console.log(`‚úÖ [ARCHIVE] Modelo ${t} archivado exitosamente: ${h} registros verificados`)}catch(r){let e=r.message||"Error desconocido";console.error(`‚ùå [ARCHIVE] Error procesando ${t}:`,e),console.error(`‚ùå [ARCHIVE] Stack trace:`,r.stack),s.error=e,s.detalle_error=r.stack||r.toString(),V++,w.push(s)}}let{data:x}=await p.from("model_values").select("model_id").gte("period_date",a).lte("period_date",t).lte("updated_at",g),{data:D}=await p.from("calculator_history").select("model_id, platform_id").eq("period_date",a).eq("period_type",o),S=w.filter(e=>!e.error).reduce((e,r)=>e+r.archivados,0);return l.Z.json({success:!0,mensaje:"Valores archivados correctamente. Los valores se mantienen en model_values para verificaci\xf3n.",resumen:{total_modelos:w.length,exitosos:I,errores:V,total_archivados:S,valores_en_model_values:x?.length||0,registros_en_history:D?.length||0,nota:"Los valores NO fueron eliminados de model_values. Puedes verificar el archivado antes de eliminarlos."},resultados:w})}catch(e){return console.error("‚ùå [EMERGENCY-ARCHIVE] Error:",e),l.Z.json({success:!1,error:e.message||"Error desconocido"},{status:500})}}let m=new t.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/route",pathname:"/api/admin/emergency-archive-p2",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:v,headerHooks:h,staticGenerationBailout:E}=m,A="/api/admin/emergency-archive-p2/route";function $(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>o(42473));module.exports=a})();