"use strict";(()=>{var e={};e.id=6566,e.ids=[6566],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},88946:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>q,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>w});var r={};a.r(r),a.d(r,{GET:()=>m});var d=a(95419),o=a(69108),i=a(99678),l=a(78070),s=a(72964);let u="https://mhernfrkvwigxdubiozm.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY;async function p(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return{error:"No autorizado",user:null};let a=t.substring(7),r=(0,s.createClient)(u,n),{data:{user:d},error:o}=await r.auth.getUser(a);if(o||!d)return{error:"Token inv\xe1lido",user:null};let{data:i}=await r.from("users").select("role").eq("id",d.id).single();return i&&("admin"===i.role||"superadmin"===i.role)?{error:null,user:d}:{error:"No tienes permisos de administrador",user:null}}let _=(0,s.createClient)(u,n);async function m(e){try{let t=await p(e);if(t.error||!t.user)return l.Z.json({success:!1,error:t.error||"No autorizado"},{status:401});let{searchParams:a}=new URL(e.url),r=a.get("modelId");if(!r)return l.Z.json({success:!1,error:"modelId es requerido"},{status:400});console.log("\uD83D\uDD0D [DIAGNOSE] Diagnosticando valores para modelo:",r);let{data:d,error:o}=await _.from("model_values").select("platform_id, value, period_date, updated_at").eq("model_id",r).order("period_date",{ascending:!1}).order("updated_at",{ascending:!1}),{data:i,error:s}=await _.from("calculator_totals").select("period_date, total_usd_bruto, total_usd_modelo, updated_at").eq("model_id",r).order("period_date",{ascending:!1}).order("updated_at",{ascending:!1}),u="2025-12-16",n="2025-12-31",m=new Date(`${n}T23:59:59.999Z`),c=m.toISOString(),{data:g,error:v}=await _.from("model_values").select("platform_id, value, period_date, updated_at").eq("model_id",r).gte("period_date",u).lte("period_date",n).order("updated_at",{ascending:!1}),{data:f,error:h}=await _.from("model_values").select("platform_id, value, period_date, updated_at").eq("model_id",r).gte("period_date",u).lte("period_date",n).lte("updated_at",c).order("updated_at",{ascending:!1}),{data:w,error:q}=await _.from("model_values").select("platform_id, value, period_date, updated_at").eq("model_id",r).gte("period_date",u).lte("period_date",n).order("updated_at",{ascending:!1}),{data:y}=await _.from("users").select("email").eq("id",r).single(),b=new Map;return d?.forEach(e=>{let t=e.period_date;b.has(t)||b.set(t,[]),b.get(t).push(e)}),l.Z.json({success:!0,model_id:r,email:y?.email||"N/A",diagnostic:{all_model_values:{total:d?.length||0,by_period:Array.from(b.entries()).map(([e,t])=>({period:e,count:t.length,platforms:t.map(e=>({platform_id:e.platform_id,value:e.value,updated_at:e.updated_at}))}))},all_totals:{total:i?.length||0,totals:i?.map(e=>({period_date:e.period_date,total_usd_bruto:e.total_usd_bruto,total_usd_modelo:e.total_usd_modelo,updated_at:e.updated_at}))||[]},p2_december_all:{total:w?.length||0,values:w?.map(e=>({platform_id:e.platform_id,value:e.value,period_date:e.period_date,updated_at:e.updated_at,is_after_limit:new Date(e.updated_at)>m}))||[]},p2_december_filtered:{total:f?.length||0,limit:c,values:f?.map(e=>({platform_id:e.platform_id,value:e.value,period_date:e.period_date,updated_at:e.updated_at}))||[]},p2_december_found:{total:g?.length||0,values:g?.map(e=>({platform_id:e.platform_id,value:e.value,period_date:e.period_date,updated_at:e.updated_at,is_after_limit:new Date(e.updated_at)>m}))||[]},summary:{total_values_all_periods:d?.length||0,total_totals_all_periods:i?.length||0,p2_values_total:w?.length||0,p2_values_after_limit:w?.filter(e=>new Date(e.updated_at)>m).length||0,p2_values_before_limit:f?.length||0,periods_with_values:Array.from(b.keys())}}})}catch(e){return console.error("âŒ [DIAGNOSE] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let c=new d.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/diagnose/route",pathname:"/api/admin/emergency-archive-p2/diagnose",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/diagnose/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\diagnose\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:v,serverHooks:f,headerHooks:h,staticGenerationBailout:w}=c,q="/api/admin/emergency-archive-p2/diagnose/route";function y(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,2964],()=>a(88946));module.exports=r})();