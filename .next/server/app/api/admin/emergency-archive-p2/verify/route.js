"use strict";(()=>{var e={};e.id=1864,e.ids=[1864],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},55100:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>v,originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>E});var t={};o.r(t),o.d(t,{GET:()=>p});var a=o(95419),s=o(69108),i=o(99678),n=o(78070),l=o(72964);let u="https://mhernfrkvwigxdubiozm.supabase.co",d=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let r=e.headers.get("authorization");if(console.log("\uD83D\uDD10 [VERIFY-AUTH] Verificando autenticaci\xf3n..."),console.log("\uD83D\uDD10 [VERIFY-AUTH] Header authorization:",r?"Presente":"Ausente"),!r)return console.error("❌ [VERIFY-AUTH] No hay header de autorizaci\xf3n"),{error:"Token de autorizaci\xf3n requerido",user:null};if(!r.startsWith("Bearer "))return console.error("❌ [VERIFY-AUTH] Header no tiene formato Bearer"),{error:"Token de autorizaci\xf3n requerido",user:null};let o=r.split(" ")[1];if(!o)return console.error("❌ [VERIFY-AUTH] Token vac\xedo"),{error:"Token de autorizaci\xf3n requerido",user:null};console.log("\uD83D\uDD10 [VERIFY-AUTH] Token obtenido, verificando con Supabase...");let t=(0,l.createClient)(u,d,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:s}=await t.auth.getUser(o);if(s)return console.error("❌ [VERIFY-AUTH] Error verificando token:",s.message),{error:`Token inv\xe1lido: ${s.message}`,user:null};if(!a)return console.error("❌ [VERIFY-AUTH] Usuario no encontrado"),{error:"Token inv\xe1lido",user:null};console.log("✅ [VERIFY-AUTH] Usuario autenticado:",a.id);let{data:i,error:n}=await t.from("users").select("role").eq("id",a.id).single();return n?(console.error("❌ [VERIFY-AUTH] Error obteniendo datos de usuario:",n.message),{error:`Error obteniendo datos de usuario: ${n.message}`,user:null}):i?(console.log("\uD83D\uDD10 [VERIFY-AUTH] Rol del usuario:",i.role),"admin"!==i.role&&"super_admin"!==i.role)?(console.error("❌ [VERIFY-AUTH] Rol no autorizado:",i.role),{error:"No autorizado. Se requiere rol de admin o super_admin",user:null}):(console.log("✅ [VERIFY-AUTH] Autenticaci\xf3n exitosa para:",i.role),{error:null,user:{id:a.id,role:i.role}}):(console.error("❌ [VERIFY-AUTH] Datos de usuario no encontrados"),{error:"Error obteniendo datos de usuario",user:null})}let m=(0,l.createClient)(u,d);async function p(e){try{let r=await c(e);if(r.error||!r.user)return n.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let o="2025-12-16",t="2025-12-31",{data:a,error:s}=await m.from("calculator_history").select("model_id, platform_id, period_date, period_type, value, archived_at").eq("period_date",o).eq("period_type","16-31");if(s)return n.Z.json({success:!1,error:`Error consultando calculator_history: ${s.message}`},{status:500});let i=new Date(`${t}T23:59:59.999Z`).toISOString(),{data:l,error:u}=await m.from("model_values").select("model_id, platform_id, period_date, value, updated_at").gte("period_date",o).lte("period_date",t).lte("updated_at",i);if(u)return n.Z.json({success:!1,error:`Error consultando model_values: ${u.message}`},{status:500});let d=new Set,p=new Set;a?.forEach(e=>d.add(e.model_id)),l?.forEach(e=>p.add(e.model_id));let _=new Map;l?.forEach(e=>{let r=_.get(e.model_id)||0;_.set(e.model_id,r+1)});let h=Array.from(new Set([...Array.from(d),...Array.from(p)])),{data:f}=await m.from("users").select("id, email").in("id",h),g=new Map(f?.map(e=>[e.id,e.email])||[]),v={registros_en_history:a?.length||0,registros_en_model_values:l?.length||0,modelos_en_history:d.size,modelos_en_model_values:p.size,modelos_solo_en_model_values:Array.from(p).filter(e=>!d.has(e)).length,fecha_limite:i},E=Array.from(p).map(e=>{let r=d.has(e),o=_.get(e)||0,t=g.get(e)||e;return{model_id:e,email:t,en_history:r,plataformas_en_model_values:o,necesita_archivado:!r}});return n.Z.json({success:!0,resumen:v,detalles:E.slice(0,50),total_modelos:E.length})}catch(e){return console.error("❌ [VERIFY-ARCHIVE] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/emergency-archive-p2/verify/route",pathname:"/api/admin/emergency-archive-p2/verify",filename:"route",bundlePath:"app/api/admin/emergency-archive-p2/verify/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\emergency-archive-p2\\verify\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:v,staticGenerationBailout:E}=_,y="/api/admin/emergency-archive-p2/verify/route";function A(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(55100));module.exports=t})();