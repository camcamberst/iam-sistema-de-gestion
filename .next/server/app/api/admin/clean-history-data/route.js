"use strict";(()=>{var e={};e.id=3516,e.ids=[3516],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},52068:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>g,originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>h});var t={};r.r(t),r.d(t,{POST:()=>n});var a=r(95419),i=r(69108),s=r(99678),l=r(78070);let d=(0,r(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c");async function n(e){try{console.log("\uD83D\uDD0D [CLEAN-HISTORY] Iniciando limpieza de datos incorrectos del historial..."),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 0. Verificando estado ANTES de la limpieza:");let{data:e,error:o}=await d.from("calculator_history").select("period_type, value, model_id");if(o)return console.error("❌ Error obteniendo datos antes de limpieza:",o),l.Z.json({success:!1,error:"Error obteniendo datos antes de limpieza"},{status:500});let r={};e?.forEach(e=>{r[e.period_type]||(r[e.period_type]={registros:0,modelos:new Set,total_valor:0}),r[e.period_type].registros++,r[e.period_type].modelos.add(e.model_id),r[e.period_type].total_valor+=parseFloat(e.value||0)});let t={};Object.entries(r).forEach(([e,o])=>{t[e]={registros:o.registros,modelos:o.modelos.size,total_valor:o.total_valor}}),console.log("\uD83D\uDCCA Estado ANTES:",t),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 1. Verificando datos del usuario espec\xedfico:");let{data:a,error:i}=await d.from("calculator_history").select("*").eq("model_id","fe54995d-1828-4721-8153-53fce6f4fe56").order("period_date",{ascending:!1});if(i)return console.error("❌ Error obteniendo datos del usuario:",i),l.Z.json({success:!1,error:"Error obteniendo datos del usuario"},{status:500});console.log(`✅ Registros del usuario espec\xedfico: ${a?.length||0}`);let s={};a&&a.length>0&&(a.forEach(e=>{let o=`${e.period_type}-${e.period_date}`;s[o]||(s[o]={period_type:e.period_type,period_date:e.period_date,registros:0,plataformas:new Set,total_valor:0}),s[o].registros++,s[o].plataformas.add(e.platform_id),s[o].total_valor+=parseFloat(e.value||0)}),Object.values(s).forEach(e=>{e.plataformas=Array.from(e.plataformas)})),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 2. Eliminando datos del per\xedodo 2 (16-31):");let{data:n,error:c}=await d.from("calculator_history").select("id").eq("period_type","16-31"),p=0;if(c)console.error("❌ Error obteniendo datos del per\xedodo 2:",c);else if(console.log(`✅ Registros del per\xedodo 2 encontrados: ${n?.length||0}`),n&&n.length>0)for(let e=0;e<n.length;e+=50){let o=n.slice(e,e+50),r=o.map(e=>e.id),{error:t}=await d.from("calculator_history").delete().in("id",r);t?console.error(`❌ Error eliminando lote ${e}-${e+o.length}:`,t):(console.log(`✅ Lote ${e}-${e+o.length} eliminado correctamente`),p+=o.length)}console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 3. Verificando duplicados en per\xedodo 1:");let{data:u,error:m}=await d.from("calculator_history").select("*").eq("period_type","1-15").order("archived_at",{ascending:!1}),g=0;if(m)console.error("❌ Error obteniendo datos del per\xedodo 1:",m);else if(console.log(`✅ Registros del per\xedodo 1: ${u?.length||0}`),u&&u.length>0){let e={};u.forEach(o=>{let r=`${o.model_id}-${o.platform_id}-${o.period_date}`;e[r]||(e[r]=[]),e[r].push(o)});let o=Object.keys(e).filter(o=>e[o].length>1);if(console.log(`✅ Registros con duplicados encontrados: ${o.length}`),o.length>0)for(let r of o){let o=e[r].sort((e,o)=>new Date(o.archived_at).getTime()-new Date(e.archived_at).getTime()).slice(1),t=o.map(e=>e.id),{error:a}=await d.from("calculator_history").delete().in("id",t);a?console.error(`❌ Error eliminando duplicados para ${r}:`,a):(console.log(`✅ Duplicados eliminados para ${r}: ${o.length} registros`),g+=o.length)}}console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 4. Verificando estado DESPU\xc9S de la limpieza:");let{data:h,error:_}=await d.from("calculator_history").select("period_type, value, model_id");if(_)return console.error("❌ Error obteniendo datos despu\xe9s de limpieza:",_),l.Z.json({success:!1,error:"Error obteniendo datos despu\xe9s de limpieza"},{status:500});let f={};h?.forEach(e=>{f[e.period_type]||(f[e.period_type]={registros:0,modelos:new Set,total_valor:0}),f[e.period_type].registros++,f[e.period_type].modelos.add(e.model_id),f[e.period_type].total_valor+=parseFloat(e.value||0)});let y={};Object.entries(f).forEach(([e,o])=>{y[e]={registros:o.registros,modelos:o.modelos.size,total_valor:o.total_valor}}),console.log("\uD83D\uDCCA Estado DESPU\xc9S:",y),console.log("\n\uD83D\uDCCA [CLEAN-HISTORY] 5. Verificando que no quedan datos del per\xedodo 2:");let{data:D,error:E}=await d.from("calculator_history").select("id").eq("period_type","16-31");return E?console.error("❌ Error verificando per\xedodo 2:",E):console.log(`✅ Registros del per\xedodo 2 restantes: ${D?.length||0}`),console.log("\n✅ [CLEAN-HISTORY] Limpieza completada"),l.Z.json({success:!0,message:"Limpieza de historial completada",results:{before:t,after:y,user_summary:s,period2_deleted:p,duplicates_deleted:g,period2_remaining:D?.length||0}})}catch(e){return console.error("❌ [CLEAN-HISTORY] Error general:",e),l.Z.json({success:!1,error:"Error general en limpieza de historial"},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/clean-history-data/route",pathname:"/api/admin/clean-history-data",filename:"route",bundlePath:"app/api/admin/clean-history-data/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\clean-history-data\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:m,headerHooks:g,staticGenerationBailout:h}=c,_="/api/admin/clean-history-data/route";function f(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:u})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>r(52068));module.exports=t})();