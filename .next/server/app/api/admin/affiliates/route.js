"use strict";(()=>{var e={};e.id=2418,e.ids=[2418],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},304:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>g,originalPathname:()=>q,patchFetch:()=>w,requestAsyncStorage:()=>F,routeModule:()=>_,serverHooks:()=>E,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>h});var a={};t.r(a),t.d(a,{GET:()=>f,POST:()=>p});var s=t(95419),i=t(69108),o=t(99678),n=t(78070),u=t(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",l=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return{error:"Token de autorizaci\xf3n requerido",user:null};let t=r.substring(7),a=(0,u.createClient)(d,l,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:s},error:i}=await a.auth.getUser(t);if(i||!s)return{error:"Token inv\xe1lido",user:null};let{data:o,error:n}=await a.from("users").select("role, affiliate_studio_id").eq("id",s.id).single();return n||!o?{error:"Error obteniendo datos de usuario",user:null}:"super_admin"!==o.role&&("admin"!==o.role||o.affiliate_studio_id)?{error:"No autorizado. Se requiere rol de super_admin o admin de Innova",user:null}:{error:null,user:{id:s.id,role:o.role}}}let m=(0,u.createClient)(d,l);async function f(e){try{let r=await c(e);if(r.error||!r.user)return n.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let{data:t,error:a}=await m.from("affiliate_studios").select(`
        id,
        name,
        description,
        commission_percentage,
        is_active,
        created_at,
        updated_at,
        created_by
      `).order("created_at",{ascending:!1});if(a)return console.error("❌ [AFFILIATES] Error obteniendo estudios:",a),n.Z.json({success:!1,error:a.message},{status:500});let s=await Promise.all((t||[]).map(async e=>{let r=null;if(e.created_by){let{data:t}=await m.from("users").select("id, name, email").eq("id",e.created_by).single();t&&(r=t)}let t=null,{data:a}=await m.from("users").select("id, name, email, is_active").eq("affiliate_studio_id",e.id).eq("role","superadmin_aff").limit(1).maybeSingle();a&&(t=a);let{count:s}=await m.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",e.id),{count:i}=await m.from("groups").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",e.id),{count:o}=await m.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",e.id).eq("role","modelo");return{...e,created_by_user:r,superadmin_aff:t,stats:{users:s||0,sedes:i||0,models:o||0}}}));return n.Z.json({success:!0,data:s,total:s.length})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function p(e){try{let r=await c(e);if(r.error||!r.user)return n.Z.json({success:!1,error:r.error||"No autorizado"},{status:401});let{name:t,description:a,commission_percentage:s,superadmin_email:i,superadmin_name:o,superadmin_password:u}=await e.json();if(!t||""===t.trim())return n.Z.json({success:!1,error:"El nombre del estudio es requerido"},{status:400});let d=s?parseFloat(s):10;if(isNaN(d)||d<0||d>100)return n.Z.json({success:!1,error:"El porcentaje de comisi\xf3n debe estar entre 0 y 100"},{status:400});let{data:l}=await m.from("affiliate_studios").select("id").eq("name",t.trim()).single();if(l)return n.Z.json({success:!1,error:"Ya existe un estudio afiliado con ese nombre"},{status:400});let{data:f,error:p}=await m.from("affiliate_studios").insert({name:t.trim(),description:a?.trim()||null,commission_percentage:d,is_active:!0,created_by:r.user.id}).select().single();if(p)return console.error("❌ [AFFILIATES] Error creando estudio:",p),n.Z.json({success:!1,error:p.message},{status:500});let _=null;if(i&&o&&u)try{console.log("\uD83D\uDC64 [AFFILIATES] Creando superadmin AFF para el estudio:",f.id);let{data:e,error:r}=await m.auth.admin.createUser({email:i.trim(),password:u,email_confirm:!0,user_metadata:{name:o.trim(),role:"superadmin_aff"}});if(r||!e.user)console.error("❌ [AFFILIATES] Error creando usuario en Auth:",r);else{let{data:r,error:t}=await m.from("users").insert({id:e.user.id,name:o.trim(),email:i.trim(),role:"superadmin_aff",affiliate_studio_id:f.id,is_active:!0}).select().single();t?(console.error("❌ [AFFILIATES] Error creando perfil de usuario:",t),await m.auth.admin.deleteUser(e.user.id)):(_={id:r.id,email:r.email,name:r.name},console.log("✅ [AFFILIATES] Superadmin AFF creado exitosamente:",_))}}catch(e){console.error("❌ [AFFILIATES] Error inesperado creando superadmin AFF:",e)}return n.Z.json({success:!0,data:{...f,superadmin_aff:_},message:_?"Estudio afiliado y superadmin AFF creados exitosamente":"Estudio afiliado creado exitosamente. Recuerda crear el superadmin AFF despu\xe9s."},{status:201})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/affiliates/route",pathname:"/api/admin/affiliates",filename:"route",bundlePath:"app/api/admin/affiliates/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\affiliates\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:F,staticGenerationAsyncStorage:A,serverHooks:E,headerHooks:g,staticGenerationBailout:h}=_,q="/api/admin/affiliates/route";function w(){return(0,o.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:A})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(304));module.exports=a})();