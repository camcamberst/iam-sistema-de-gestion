"use strict";(()=>{var e={};e.id=7320,e.ids=[7320],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},82816:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>_,originalPathname:()=>q,patchFetch:()=>w,requestAsyncStorage:()=>F,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>j});var a={};s.r(a),s.d(a,{DELETE:()=>E,POST:()=>f,PUT:()=>p});var t=s(95419),i=s(69108),o=s(99678),n=s(78070),u=s(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",l=process.env.SUPABASE_SERVICE_ROLE_KEY;async function c(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return{error:"Token de autorizaci\xf3n requerido",user:null};let s=r.substring(7),a=(0,u.createClient)(d,l,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:t},error:i}=await a.auth.getUser(s);if(i||!t)return{error:"Token inv\xe1lido",user:null};let{data:o,error:n}=await a.from("users").select("role, affiliate_studio_id").eq("id",t.id).single();return n||!o?{error:"Error obteniendo datos de usuario",user:null}:"super_admin"!==o.role?{error:"No autorizado. Se requiere rol de super_admin",user:null}:{error:null,user:{id:t.id,role:o.role}}}let m=(0,u.createClient)(d,l);async function f(e,{params:r}){try{let s=await c(e);if(s.error||!s.user)return n.Z.json({success:!1,error:s.error||"No autorizado"},{status:401});let{id:a}=r,{email:t,name:i,password:o}=await e.json();if(!t||!i||!o)return n.Z.json({success:!1,error:"Email, nombre y contrase\xf1a son requeridos"},{status:400});if(o.length<6)return n.Z.json({success:!1,error:"La contrase\xf1a debe tener al menos 6 caracteres"},{status:400});let{data:u,error:d}=await m.from("affiliate_studios").select("id, name").eq("id",a).single();if(d||!u)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});let{data:l}=await m.from("users").select("id").eq("affiliate_studio_id",a).eq("role","superadmin_aff").maybeSingle();if(l)return n.Z.json({success:!1,error:"Ya existe un superadmin AFF para este estudio. Elimina el existente primero."},{status:400});let{data:f}=await m.from("users").select("id").eq("email",t.trim()).maybeSingle();if(f)return n.Z.json({success:!1,error:"Este email ya est\xe1 registrado"},{status:400});let{data:p,error:E}=await m.auth.admin.createUser({email:t.trim(),password:o,email_confirm:!0,user_metadata:{name:i.trim(),role:"superadmin_aff"}});if(E||!p.user)return console.error("❌ [AFFILIATES] Error creando usuario en Auth:",E),n.Z.json({success:!1,error:E?.message||"Error creando usuario en Auth"},{status:500});let{data:g,error:F}=await m.from("users").insert({id:p.user.id,name:i.trim(),email:t.trim(),role:"superadmin_aff",affiliate_studio_id:a,is_active:!0}).select("id, name, email, is_active").single();if(F)return console.error("❌ [AFFILIATES] Error creando perfil de usuario:",F),await m.auth.admin.deleteUser(p.user.id),n.Z.json({success:!1,error:F.message||"Error creando perfil de usuario"},{status:500});return n.Z.json({success:!0,data:g,message:"Superadmin AFF creado exitosamente"},{status:201})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function p(e,{params:r}){try{let s=await c(e);if(s.error||!s.user)return n.Z.json({success:!1,error:s.error||"No autorizado"},{status:401});let{id:a}=r,{email:t,name:i,is_active:o,password:u}=await e.json(),{data:d}=await m.from("affiliate_studios").select("id").eq("id",a).single();if(!d)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});let{data:l,error:f}=await m.from("users").select("id, email").eq("affiliate_studio_id",a).eq("role","superadmin_aff").maybeSingle();if(f||!l)return n.Z.json({success:!1,error:"No se encontr\xf3 superadmin AFF para este estudio"},{status:404});let p={};if(void 0!==i&&(p.name=i.trim()),void 0!==o&&(p.is_active=!!o),void 0!==t&&t.trim()!==l.email){let{data:e}=await m.from("users").select("id").eq("email",t.trim()).neq("id",l.id).maybeSingle();if(e)return n.Z.json({success:!1,error:"Este email ya est\xe1 registrado"},{status:400});p.email=t.trim();let{error:r}=await m.auth.admin.updateUserById(l.id,{email:t.trim()});r&&console.error("❌ [AFFILIATES] Error actualizando email en Auth:",r)}if(void 0!==u&&""!==u.trim()){if(u.length<6)return n.Z.json({success:!1,error:"La contrase\xf1a debe tener al menos 6 caracteres"},{status:400});let{error:e}=await m.auth.admin.updateUserById(l.id,{password:u});if(e)return console.error("❌ [AFFILIATES] Error actualizando contrase\xf1a:",e),n.Z.json({success:!1,error:"Error actualizando contrase\xf1a"},{status:500})}let{data:E,error:g}=await m.from("users").update(p).eq("id",l.id).select("id, name, email, is_active").single();if(g)return console.error("❌ [AFFILIATES] Error actualizando usuario:",g),n.Z.json({success:!1,error:g.message||"Error actualizando usuario"},{status:500});return n.Z.json({success:!0,data:E,message:"Superadmin AFF actualizado exitosamente"})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function E(e,{params:r}){try{let s=await c(e);if(s.error||!s.user)return n.Z.json({success:!1,error:s.error||"No autorizado"},{status:401});let{id:a}=r,{data:t}=await m.from("affiliate_studios").select("id, name").eq("id",a).single();if(!t)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});let{data:i,error:o}=await m.from("users").select("id, name, email").eq("affiliate_studio_id",a).eq("role","superadmin_aff").maybeSingle();if(o||!i)return n.Z.json({success:!1,error:"No se encontr\xf3 superadmin AFF para este estudio"},{status:404});let{count:u}=await m.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",a).neq("id",i.id);if(u&&u>0){let{error:e}=await m.from("users").update({is_active:!1}).eq("id",i.id);if(e)return n.Z.json({success:!1,error:e.message||"Error desactivando superadmin AFF"},{status:500});return n.Z.json({success:!0,message:`Superadmin AFF desactivado. El estudio tiene ${u} usuario(s) asociado(s).`})}{let{error:e}=await m.auth.admin.deleteUser(i.id);e&&console.error("❌ [AFFILIATES] Error eliminando usuario de Auth:",e);let{error:r}=await m.from("users").delete().eq("id",i.id);if(r)return n.Z.json({success:!1,error:r.message||"Error eliminando superadmin AFF"},{status:500});return n.Z.json({success:!0,message:"Superadmin AFF eliminado exitosamente"})}}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let g=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/affiliates/[id]/superadmin/route",pathname:"/api/admin/affiliates/[id]/superadmin",filename:"route",bundlePath:"app/api/admin/affiliates/[id]/superadmin/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\affiliates\\[id]\\superadmin\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:F,staticGenerationAsyncStorage:A,serverHooks:h,headerHooks:_,staticGenerationBailout:j}=g,q="/api/admin/affiliates/[id]/superadmin/route";function w(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:A})}}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>s(82816));module.exports=a})();