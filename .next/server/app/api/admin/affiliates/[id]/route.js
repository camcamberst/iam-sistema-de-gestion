"use strict";(()=>{var e={};e.id=9447,e.ids=[9447],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},29747:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>v,originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>E,serverHooks:()=>q,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>j});var s={};t.r(s),t.d(s,{DELETE:()=>_,GET:()=>m,PUT:()=>p});var a=t(95419),i=t(69108),o=t(99678),n=t(78070),u=t(72964);let d="https://mhernfrkvwigxdubiozm.supabase.co",c=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return{error:"Token de autorizaci\xf3n requerido",user:null};let t=r.substring(7),s=(0,u.createClient)(d,c,{auth:{autoRefreshToken:!1,persistSession:!1}}),{data:{user:a},error:i}=await s.auth.getUser(t);if(i||!a)return{error:"Token inv\xe1lido",user:null};let{data:o,error:n}=await s.from("users").select("role, affiliate_studio_id").eq("id",a.id).single();return n||!o?{error:"Error obteniendo datos de usuario",user:null}:"super_admin"!==o.role&&("admin"!==o.role||o.affiliate_studio_id)?{error:"No autorizado. Se requiere rol de super_admin o admin de Innova",user:null}:{error:null,user:{id:a.id,role:o.role}}}let f=(0,u.createClient)(d,c);async function m(e,{params:r}){try{let t=await l(e);if(t.error||!t.user)return n.Z.json({success:!1,error:t.error||"No autorizado"},{status:401});let{id:s}=r,{data:a,error:i}=await f.from("affiliate_studios").select(`
        id,
        name,
        description,
        commission_percentage,
        is_active,
        created_at,
        updated_at,
        created_by
      `).eq("id",s).single();if(i){if("PGRST116"===i.code)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});return console.error("❌ [AFFILIATES] Error obteniendo estudio:",i),n.Z.json({success:!1,error:i.message},{status:500})}let o=null;if(a.created_by){let{data:e}=await f.from("users").select("id, name, email").eq("id",a.created_by).single();e&&(o=e)}let{count:u}=await f.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",s),{count:d}=await f.from("groups").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",s),{count:c}=await f.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",s).eq("role","modelo");return n.Z.json({success:!0,data:{...a,created_by_user:o,stats:{users:u||0,sedes:d||0,models:c||0}}})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function p(e,{params:r}){try{let t=await l(e);if(t.error||!t.user)return n.Z.json({success:!1,error:t.error||"No autorizado"},{status:401});let{id:s}=r,{name:a,description:i,commission_percentage:o,is_active:u}=await e.json(),{data:d}=await f.from("affiliate_studios").select("id").eq("id",s).single();if(!d)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});let c={};if(void 0!==a){if(""===a.trim())return n.Z.json({success:!1,error:"El nombre del estudio no puede estar vac\xedo"},{status:400});let{data:e}=await f.from("affiliate_studios").select("id").eq("name",a.trim()).neq("id",s).single();if(e)return n.Z.json({success:!1,error:"Ya existe otro estudio afiliado con ese nombre"},{status:400});c.name=a.trim()}if(void 0!==i&&(c.description=i?.trim()||null),void 0!==o){let e=parseFloat(o);if(isNaN(e)||e<0||e>100)return n.Z.json({success:!1,error:"El porcentaje de comisi\xf3n debe estar entre 0 y 100"},{status:400});c.commission_percentage=e}void 0!==u&&(c.is_active=!!u);let{data:m,error:p}=await f.from("affiliate_studios").update(c).eq("id",s).select().single();if(p)return console.error("❌ [AFFILIATES] Error actualizando estudio:",p),n.Z.json({success:!1,error:p.message},{status:500});return n.Z.json({success:!0,data:m,message:"Estudio afiliado actualizado exitosamente"})}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function _(e,{params:r}){try{let t=await l(e);if(t.error||!t.user)return n.Z.json({success:!1,error:t.error||"No autorizado"},{status:401});let{id:s}=r,{data:a}=await f.from("affiliate_studios").select("id, name").eq("id",s).single();if(!a)return n.Z.json({success:!1,error:"Estudio afiliado no encontrado"},{status:404});let{count:i}=await f.from("users").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",s);if(i&&i>0){let{data:e,error:r}=await f.from("affiliate_studios").update({is_active:!1}).eq("id",s).select().single();if(r)return console.error("❌ [AFFILIATES] Error desactivando estudio:",r),n.Z.json({success:!1,error:r.message},{status:500});return n.Z.json({success:!0,data:e,message:`Estudio afiliado "${a.name}" desactivado exitosamente. Tiene ${i} usuario(s) asociado(s).`})}{let{error:e}=await f.from("affiliate_studios").delete().eq("id",s);if(e)return console.error("❌ [AFFILIATES] Error eliminando estudio:",e),n.Z.json({success:!1,error:e.message},{status:500});return n.Z.json({success:!0,message:`Estudio afiliado "${a.name}" eliminado exitosamente`})}}catch(e){return console.error("❌ [AFFILIATES] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let E=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/affiliates/[id]/route",pathname:"/api/admin/affiliates/[id]",filename:"route",bundlePath:"app/api/admin/affiliates/[id]/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\affiliates\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:q,headerHooks:v,staticGenerationBailout:j}=E,w="/api/admin/affiliates/[id]/route";function x(){return(0,o.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:h})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,6206,2964],()=>t(29747));module.exports=s})();