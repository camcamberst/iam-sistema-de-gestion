"use strict";(()=>{var e={};e.id=1012,e.ids=[1012],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},84297:(e,a,r)=>{r.r(a),r.d(a,{headerHooks:()=>_,originalPathname:()=>g,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>E});var t={};r.r(t),r.d(t,{GET:()=>c,POST:()=>u});var o=r(95419),s=r(69108),n=r(99678),l=r(78070);let i=(0,r(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e){try{console.log("\uD83D\uDD04 [UPDATE-QUINCENAL-STATS] Iniciando actualizaci\xf3n de estad\xedsticas quincenales...");let{data:e,error:a}=await i.from("users").select("id, email, name").eq("role","modelo");if(a)return console.error("❌ [UPDATE-QUINCENAL-STATS] Error obteniendo modelos:",a),l.Z.json({success:!1,error:"Error al obtener modelos"},{status:500});if(!e||0===e.length)return l.Z.json({success:!0,message:"No hay modelos para actualizar",updated:0});let{data:r,error:t}=await i.from("calculator_platforms").select("id, name").eq("active",!0);if(t)return console.error("❌ [UPDATE-QUINCENAL-STATS] Error obteniendo plataformas:",t),l.Z.json({success:!1,error:"Error al obtener plataformas"},{status:500});let o=new Date,s=o.getFullYear(),n=String(o.getMonth()+1).padStart(2,"0"),u=o.getDate(),c=`${s}-${n}-${u>=1&&u<=15?"1":"2"}`;console.log(`📅 Procesando quincena: ${c}`);let d=0,m=[];for(let a of e)for(let e of(console.log(`👤 Procesando modelo: ${a.email}`),r))try{let{data:r,error:t}=await i.from("modelo_plataformas").select("id, status").eq("model_id",a.id).eq("platform_id",e.id).eq("status","confirmada").single();if(t||!r)continue;let{error:o}=await i.rpc("update_quincenal_stats",{p_model_id:a.id,p_platform_id:e.id,p_quincena:c});o?(console.error(`❌ [UPDATE-QUINCENAL-STATS] Error actualizando ${a.email} - ${e.name}:`,o),m.push({model:a.email,platform:e.name,success:!1,error:o.message})):(console.log(`✅ [UPDATE-QUINCENAL-STATS] Actualizado ${a.email} - ${e.name}`),m.push({model:a.email,platform:e.name,success:!0,quincena:c}),d++)}catch(r){console.error(`❌ [UPDATE-QUINCENAL-STATS] Error procesando ${a.email} - ${e.name}:`,r),m.push({model:a.email,platform:e.name,success:!1,error:r instanceof Error?r.message:"Error desconocido"})}return console.log(`✅ [UPDATE-QUINCENAL-STATS] Proceso completado. ${d} estad\xedsticas actualizadas`),l.Z.json({success:!0,message:`Estad\xedsticas quincenales actualizadas: ${d} registros`,quincena:c,updated:d,totalModels:e.length,totalPlatforms:r?.length||0,results:m})}catch(e){return console.error("❌ [UPDATE-QUINCENAL-STATS] Error general:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function c(e){try{let{data:e,error:a}=await i.from("platform_quincenal_stats").select(`
        model_id,
        platform_id,
        quincena,
        daily_avg_usd,
        total_days,
        total_usd_modelo,
        created_at,
        users!inner(email, name),
        calculator_platforms!inner(name)
      `).order("created_at",{ascending:!1}).limit(50);if(a)return l.Z.json({success:!1,error:"Error al obtener estad\xedsticas"},{status:500});let r=e?.reduce((e,a)=>{let r=a.users?.email||"Unknown";return e[r]||(e[r]={email:r,name:a.users?.name||"Unknown",platforms:[]}),e[r].platforms.push({platform:a.calculator_platforms?.name||a.platform_id,quincena:a.quincena,daily_avg:a.daily_avg_usd,total_days:a.total_days,total_usd:a.total_usd_modelo}),e},{})||{};return l.Z.json({success:!0,totalRecords:e?.length||0,summary:Object.values(r),recentStats:e?.slice(0,10)||[]})}catch(e){return l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/update-quincenal-stats/route",pathname:"/api/admin/update-quincenal-stats",filename:"route",bundlePath:"app/api/admin/update-quincenal-stats/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\admin\\update-quincenal-stats\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:p,serverHooks:f,headerHooks:_,staticGenerationBailout:E}=d,g="/api/admin/update-quincenal-stats/route";function A(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:p})}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[1638,6206,2964],()=>r(84297));module.exports=t})();