"use strict";(()=>{var e={};e.id=5701,e.ids=[5701],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},55277:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>P,originalPathname:()=>j,patchFetch:()=>U,requestAsyncStorage:()=>_,routeModule:()=>p,serverHooks:()=>E,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>I});var s={};r.r(s),r.d(s,{DELETE:()=>f,GET:()=>m,POST:()=>g,PUT:()=>D,dynamic:()=>d});var a=r(95419),i=r(69108),n=r(99678),t=r(78070),l=r(66569),u=r(34196);let d="force-dynamic";async function c(e){try{let o=e.headers.get("authorization");if(!o||!o.startsWith("Bearer "))return null;let r=o.substring(7),{data:{user:s},error:a}=await l.A.auth.getUser(r);if(a||!s)return null;let{data:i}=await l.R.from("users").select("role, affiliate_studio_id").eq("id",s.id).single();if(!i)return null;return{id:s.id,role:i.role,affiliate_studio_id:i.affiliate_studio_id}}catch(e){return console.error("âŒ [API] Error obteniendo usuario autenticado:",e),null}}async function m(e){try{console.log("\uD83D\uDC65 [API] Obteniendo usuarios (SOLO DATOS VITALES)");let o=l.R,r=await c(e),s=o.from("users").select(`
        id,
        name,
        email,
        role,
        is_active,
        created_at,
        affiliate_studio_id,
        user_groups(
          groups!inner(
            id,
            name
          )
        )
      `);s=(0,u.rd)(s,r);let{data:a,error:i}=await s.order("created_at",{ascending:!1});if(i)return console.error("âŒ [API] Error:",i),t.Z.json({success:!1,error:"Error obteniendo usuarios"},{status:500});let n=(a||[]).filter(e=>"modelo"===e.role).map(e=>e.id),d={};if(console.log(`ðŸ” [DEBUG] Usuarios totales: ${(a||[]).length}`),console.log(`ðŸ” [DEBUG] Usuarios modelo: ${n.length}`),console.log(`ðŸ” [DEBUG] IDs de usuarios modelo:`,n),n.length>0){console.log(`ðŸ” [DEBUG] Obteniendo asignaciones para ${n.length} usuarios modelo`);try{let{data:e,error:r}=await o.from("room_assignments_detailed").select("model_id, jornada, room_id, room_name").in("model_id",n);r?(console.error("âŒ [API] Error obteniendo asignaciones:",r),console.log("\uD83D\uDD0D [DEBUG] Error details:",JSON.stringify(r,null,2))):(console.log(`ðŸ” [DEBUG] Asignaciones raw:`,e),d=(e||[]).reduce((e,o)=>(e[o.model_id]=o,e),{}),console.log(`âœ… [API] Asignaciones obtenidas: ${Object.keys(d).length}`))}catch(e){console.error("âŒ [API] Error en try-catch de asignaciones:",e)}}else console.log("\uD83D\uDD0D [DEBUG] No hay usuarios modelo, saltando consulta de asignaciones");let m=(a||[]).map(e=>{let o=e.user_groups?.map(e=>({id:e.groups.id,name:e.groups.name}))||[],r=d[e.id]||null;return console.log(`ðŸ” [DEBUG] Usuario ${e.name} (${e.email}):`,{user_groups_raw:e.user_groups,formatted_groups:o,groups_count:o.length,active_assignment:r}),{id:e.id,name:e.name,email:e.email,role:e.role,is_active:e.is_active,created_at:e.created_at,affiliate_studio_id:e.affiliate_studio_id||null,groups:o,user_groups:o,jornada:r?.jornada||void 0,room_id:r?.room_id||void 0}});return console.log("âœ… [API] Usuarios obtenidos:",m.length),t.Z.json({success:!0,users:m})}catch(e){return console.error("âŒ [API] Error general:",e),t.Z.json({success:!1,error:"Error interno"},{status:500})}}async function g(e){try{console.log("âž• [API] Creando usuario (SOLO DATOS VITALES)");let o=l.R,r=await c(e),s=await e.json();console.log("\uD83D\uDD0D [DEBUG] Body completo recibido:",JSON.stringify(s,null,2));let{email:a,password:i,name:n,role:u,group_ids:d,jornada:m,room_id:g}=s;if(console.log("\uD83D\uDD0D [DEBUG] Datos extra\xeddos:",{email:a,name:n,role:u,group_ids:d,jornada:m,room_id:g}),!a||!i||!n||!u)return console.log("âŒ [DEBUG] Datos faltantes:",{email:!!a,password:!!i,name:!!n,role:!!u}),t.Z.json({success:!1,error:"Datos vitales faltantes"},{status:400});let D=null;r&&("superadmin_aff"===r.role||"admin"===r.role&&r.affiliate_studio_id)&&(D=r.affiliate_studio_id,console.log("\uD83D\uDD0D [API] Usuario afiliado creando usuario, asignando affiliate_studio_id:",D)),console.log("\uD83D\uDCCB [API] Datos recibidos:",{name:n,email:a,role:u,group_ids:d,affiliateStudioId:D}),console.log("\uD83D\uDD0D [DEBUG] Creando usuario en Auth con:",{email:a,name:n,role:u});let{data:f,error:p}=await o.auth.admin.createUser({email:a,password:i,email_confirm:!0,user_metadata:{name:n,role:u}});if(p||!f.user)return console.error("âŒ [API] Error Auth:",p),console.log("\uD83D\uDD0D [DEBUG] Auth error details:",JSON.stringify(p,null,2)),t.Z.json({success:!1,error:"Este email ya est\xe1 registrado. Por favor, usa un email diferente."},{status:400});console.log("âœ… [API] Usuario creado en Auth:",f.user.id),console.log("\uD83D\uDD0D [DEBUG] Auth user metadata:",f.user.user_metadata);let _={id:f.user.id,name:n,email:a,role:u,is_active:!0};D&&(_.affiliate_studio_id=D),console.log("\uD83D\uDD0D [DEBUG] Creando perfil en users con:",_);let{error:A}=await o.from("users").insert(_);if(A)return console.error("âŒ [API] Error perfil:",A),console.log("\uD83D\uDD0D [DEBUG] Profile error details:",JSON.stringify(A,null,2)),t.Z.json({success:!1,error:"Error creando perfil"},{status:500});console.log("âœ… [API] Perfil creado en users");let E=[];if(d&&d.length>0){console.log("\uD83D\uDCCB [API] Asignando grupos:",d),console.log("\uD83D\uDD0D [DEBUG] Group IDs recibidos:",JSON.stringify(d,null,2));let e=d.map(e=>({user_id:f.user.id,group_id:e,is_manager:!1}));console.log("\uD83D\uDD0D [DEBUG] User groups a insertar:",JSON.stringify(e,null,2));let{data:r,error:s}=await o.from("user_groups").insert(e).select(`
          groups!inner(
            id,
            name
          )
        `);if(s)console.error("âŒ [API] Error asignando grupos:",s),console.log("\uD83D\uDD0D [DEBUG] Groups error details:",JSON.stringify(s,null,2));else{if(E=r?.map(e=>({id:e.groups.id,name:e.groups.name}))||[],console.log("âœ… [API] Grupos asignados:",E.length),console.log("\uD83D\uDD0D [DEBUG] Grupos asignados:",JSON.stringify(E,null,2)),"admin"===u&&E.length>0)for(let e of(console.log("\uD83C\uDFD7ï¸ [API] Verificando si se debe crear sede autom\xe1ticamente..."),E)){let{data:r,error:s}=await o.from("group_rooms").select("id, room_name").eq("group_id",e.id);if(s){console.error(`âŒ [API] Error verificando rooms para ${e.name}:`,s);continue}if(r&&0!==r.length)console.log(`â„¹ï¸ [API] ${e.name} ya tiene ${r.length} rooms configurados`);else{console.log(`ðŸ—ï¸ [API] Creando room por defecto para ${e.name}...`);let{data:r,error:s}=await o.from("group_rooms").insert({group_id:e.id,room_name:"ROOM01",is_active:!0}).select().single();s?console.error(`âŒ [API] Error creando room para ${e.name}:`,s):console.log(`âœ… [API] Room creado autom\xe1ticamente: ${r.room_name} para ${e.name}`)}}console.log("\uD83D\uDD0D [DEBUG] Verificando grupos asignados en BD...");let{data:e,error:s}=await o.from("user_groups").select(`
            groups!inner(
              id,
              name
            )
          `).eq("user_id",f.user.id);if(s)console.error("âŒ [DEBUG] Error verificando grupos:",s);else{let o=e?.map(e=>({id:e.groups.id,name:e.groups.name}))||[];console.log("\uD83D\uDD0D [DEBUG] Grupos verificados en BD:",JSON.stringify(o,null,2))}}}else console.log("\uD83D\uDD0D [DEBUG] No se proporcionaron grupos o est\xe1n vac\xedos");if("modelo"===u&&m&&g&&d&&d.length>0){console.log("\uD83D\uDCCB [API] Creando asignaci\xf3n de modelo:",{jornada:m,room_id:g,group_id:d[0]}),console.log("\uD83D\uDD0D [API] Validando conflicto de asignaci\xf3n...");let{data:e,error:r}=await o.from("room_assignments").select("id, model_id").eq("room_id",g).eq("jornada",m);if(r)return console.error("âŒ [API] Error verificando asignaciones existentes:",r),t.Z.json({success:!1,error:"Error verificando disponibilidad"},{status:500});if(e&&e.length>0)return console.log("âŒ [API] Conflicto detectado:",e),t.Z.json({success:!1,error:"Este room ya est\xe1 ocupado en la jornada seleccionada para este grupo"},{status:400});let{data:s,error:a}=await o.from("room_assignments").select("id, jornada").eq("model_id",f.user.id).eq("room_id",g);if(a)return console.error("âŒ [API] Error verificando asignaciones de la misma modelo:",a),t.Z.json({success:!1,error:"Error verificando asignaciones de la modelo"},{status:500});if(s&&s.length>0){let e=s.map(e=>e.jornada);return console.log("âŒ [API] Modelo ya asignada a este room en otras jornadas:",e),t.Z.json({success:!1,error:`Esta modelo ya est\xe1 asignada a este room en la(s) jornada(s): ${e.join(", ")}`},{status:400})}console.log("âœ… [API] No hay conflictos, procediendo con la asignaci\xf3n");try{let{error:e}=await o.from("room_assignments").insert({model_id:f.user.id,room_id:g,jornada:m,assigned_by:f.user.id});if(e)console.error("âŒ [API] Error creando asignaci\xf3n:",e),console.log("âš ï¸ [WARNING] Asignaci\xf3n no creada, pero usuario s\xed");else{console.log("âœ… [API] Asignaci\xf3n de modelo creada exitosamente");let{error:e}=await o.from("jornada_states").update({state:"OCUPADA",model_id:f.user.id,updated_at:new Date().toISOString(),updated_by:f.user.id}).eq("group_id",d[0]).eq("room_id",g).eq("jornada",m);e?console.error("âŒ [API] Error actualizando estado de jornada:",e):console.log("âœ… [API] Estado de jornada actualizado a OCUPADA")}}catch(e){console.error("âŒ [API] Error general en asignaci\xf3n:",e),console.log("âš ï¸ [WARNING] Asignaci\xf3n no creada, pero usuario s\xed")}}else"modelo"===u&&console.log("\uD83D\uDD0D [DEBUG] Usuario modelo creado sin asignaci\xf3n (datos faltantes):",{jornada:!!m,room_id:!!g,group_ids:d?.length||0});return console.log("âœ… [API] Usuario creado completamente:",f.user.id),t.Z.json({success:!0,user:{id:f.user.id,name:n,email:a,role:u,is_active:!0,groups:E}})}catch(e){return console.error("âŒ [API] Error general:",e),t.Z.json({success:!1,error:"Error interno"},{status:500})}}async function D(e){try{console.log("âœï¸ [API] Editando usuario (SOLO DATOS VITALES)");let o=l.R,r=await c(e);if(!r)return t.Z.json({success:!1,error:"No autenticado"},{status:401});let s=await e.json();console.log("\uD83D\uDD0D [DEBUG] Body completo recibido en PUT:",JSON.stringify(s,null,2));let{id:a,name:i,email:n,password:u,role:d,is_active:m,group_ids:g,jornada:D,room_id:f}=s;if(console.log("\uD83D\uDD0D [DEBUG] Datos extra\xeddos en PUT:",{id:a,name:i,email:n,password:!!u,role:d,is_active:m,group_ids:g,jornada:D,room_id:f}),!a||!i||!n||!d)return console.log("âŒ [DEBUG] Datos faltantes en PUT:",{id:!!a,name:!!i,email:!!n,role:!!d}),t.Z.json({success:!1,error:"Datos vitales faltantes"},{status:400});let{data:p,error:_}=await o.from("users").select("id, role, affiliate_studio_id").eq("id",a).single();if(_||!p)return t.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if("super_admin"===r.role);else if("superadmin_aff"===r.role){if("super_admin"===p.role||"superadmin_aff"===p.role)return t.Z.json({success:!1,error:"No tienes permisos para editar este usuario"},{status:403});if(!r.affiliate_studio_id)return t.Z.json({success:!1,error:"No tienes permisos para editar usuarios"},{status:403});if(p.affiliate_studio_id!==r.affiliate_studio_id)return t.Z.json({success:!1,error:"Solo puedes editar usuarios de tu estudio afiliado"},{status:403})}else if("admin"!==r.role)return t.Z.json({success:!1,error:"No tienes permisos para editar usuarios"},{status:403});else if("super_admin"===p.role)return t.Z.json({success:!1,error:"No tienes permisos para editar este usuario"},{status:403});console.log("\uD83D\uDD0D [DEBUG] Actualizando usuario con:",{id:a,name:i,email:n,role:d,is_active:m});let{error:A}=await o.from("users").update({name:i,email:n,role:d,is_active:void 0===m||m}).eq("id",a);if(A)return console.error("âŒ [API] Error actualizando:",A),console.log("\uD83D\uDD0D [DEBUG] Update error details:",JSON.stringify(A,null,2)),t.Z.json({success:!1,error:"Error actualizando usuario"},{status:500});console.log("âœ… [API] Usuario actualizado exitosamente (tabla users):",a);try{let e={};if(n&&(e.email=n),u&&"string"==typeof u&&u.trim().length>=6&&(e.password=u.trim()),void 0!==m?m?(e.email_confirm=!0,console.log("âœ… [API] Activando usuario en Auth - confirmando email para permitir login")):(e.email_confirm=!0,console.log("âš ï¸ [API] Desactivando usuario - email permanece confirmado para reactivaci\xf3n futura")):e.email_confirm=!0,e.email||e.password||void 0!==e.email_confirm){console.log("\uD83D\uDD10 [API] Sincronizando con Supabase Auth:",{hasEmail:!!e.email,hasPassword:!!e.password,emailConfirm:e.email_confirm});let{error:o}=await l.A.auth.admin.updateUserById(a,e);o?console.error("âŒ [API] Error sincronizando con Auth:",o):console.log("âœ… [API] Auth actualizado para usuario:",a)}}catch(e){console.error("âš ï¸ [API] Excepci\xf3n sincronizando con Auth (continuando):",e)}if(void 0!==g){console.log("\uD83D\uDD0D [DEBUG] Actualizando grupos:",g),console.log("\uD83D\uDD0D [DEBUG] Group IDs recibidos en PUT:",JSON.stringify(g,null,2));let{error:e}=await o.from("user_groups").delete().eq("user_id",a);if(e?console.error("âŒ [API] Error eliminando grupos existentes:",e):console.log("âœ… [API] Grupos antiguos eliminados"),g.length>0){let e=g.map(e=>({user_id:a,group_id:e,is_manager:!1}));console.log("\uD83D\uDD0D [DEBUG] User groups a insertar en PUT:",JSON.stringify(e,null,2));let{error:r,data:s}=await o.from("user_groups").insert(e).select();if(r)console.error("âŒ [API] Error actualizando grupos:",r),console.log("\uD83D\uDD0D [DEBUG] Groups error details en PUT:",JSON.stringify(r,null,2));else{console.log("âœ… [API] Grupos actualizados exitosamente"),console.log("\uD83D\uDD0D [DEBUG] Grupos insertados:",JSON.stringify(s,null,2));let{data:e,error:r}=await o.from("user_groups").select("group_id").eq("user_id",a);r?console.error("âŒ [API] Error verificando grupos insertados:",r):console.log("âœ… [API] Verificaci\xf3n de grupos:",e?.map(e=>e.group_id))}}else console.log("âš ï¸ [API] Array de grupos vac\xedo - todos los grupos fueron eliminados")}else console.log("â„¹ï¸ [API] group_ids no proporcionado - grupos existentes se preservan");if("modelo"===d&&D&&f&&g&&g.length>0){console.log("\uD83D\uDCCB [API] Actualizando asignaci\xf3n de modelo:",{jornada:D,room_id:f,group_id:g[0]}),console.log("\uD83D\uDD0D [API] Validando conflicto de asignaci\xf3n en edici\xf3n...");let{data:e,error:r}=await o.from("room_assignments").select("id, model_id").eq("room_id",f).eq("jornada",D).neq("model_id",a);if(r)return console.error("âŒ [API] Error verificando asignaciones existentes:",r),t.Z.json({success:!1,error:"Error verificando disponibilidad"},{status:500});if(e&&e.length>0)return console.log("âŒ [API] Conflicto detectado en edici\xf3n:",e),t.Z.json({success:!1,error:"Este room ya est\xe1 ocupado en la jornada seleccionada para este grupo"},{status:400});let{data:s,error:i}=await o.from("room_assignments").select("id, jornada").eq("model_id",a).eq("room_id",f).neq("jornada",D);if(i)return console.error("âŒ [API] Error verificando asignaciones de la misma modelo:",i),t.Z.json({success:!1,error:"Error verificando asignaciones de la modelo"},{status:500});if(s&&s.length>0){let e=s.map(e=>e.jornada);return console.log("âŒ [API] Modelo ya asignada a este room en otras jornadas:",e),t.Z.json({success:!1,error:`Esta modelo ya est\xe1 asignada a este room en la(s) jornada(s): ${e.join(", ")}`},{status:400})}console.log("âœ… [API] No hay conflictos, procediendo con la actualizaci\xf3n");try{await o.from("room_assignments").delete().eq("model_id",a);let{error:e}=await o.from("room_assignments").insert({model_id:a,room_id:f,jornada:D,assigned_by:a});if(e)console.error("âŒ [API] Error actualizando asignaci\xf3n:",e),console.log("âš ï¸ [WARNING] Asignaci\xf3n no actualizada, pero usuario s\xed");else{console.log("âœ… [API] Asignaci\xf3n de modelo actualizada exitosamente");let{error:e}=await o.from("jornada_states").update({state:"OCUPADA",model_id:a,updated_at:new Date().toISOString(),updated_by:a}).eq("group_id",g[0]).eq("room_id",f).eq("jornada",D);e?console.error("âŒ [API] Error actualizando estado de jornada:",e):console.log("âœ… [API] Estado de jornada actualizado a OCUPADA")}}catch(e){console.error("âŒ [API] Error general en actualizaci\xf3n de asignaci\xf3n:",e),console.log("âš ï¸ [WARNING] Asignaci\xf3n no actualizada, pero usuario s\xed")}}else"modelo"===d&&(console.log("\uD83D\uDD0D [DEBUG] Eliminando asignaciones existentes para modelo sin jornada/room"),await o.from("room_assignments").delete().eq("model_id",a));console.log("âœ… [API] Usuario actualizado:",a);let E=[];if(void 0!==g){if(g.length>0){let{data:e}=await o.from("user_groups").select(`
            groups!inner(
              id,
              name
            )
          `).eq("user_id",a);E=e?.map(e=>({id:e.groups.id,name:e.groups.name}))||[]}}else{let{data:e}=await o.from("user_groups").select(`
          groups!inner(
            id,
            name
          )
        `).eq("user_id",a);E=e?.map(e=>({id:e.groups.id,name:e.groups.name}))||[]}return t.Z.json({success:!0,user:{id:a,name:i,email:n,role:d,is_active:m,groups:E}})}catch(e){return console.error("âŒ [API] Error general:",e),t.Z.json({success:!1,error:"Error interno"},{status:500})}}async function f(e){try{console.log("\uD83D\uDDD1ï¸ [API] Eliminando usuario (SOLO DATOS VITALES)");let o=l.R,{searchParams:r}=new URL(e.url),s=r.get("id");if(!s)return t.Z.json({success:!1,error:"ID requerido"},{status:400});let a=await c(e);if(!a)return t.Z.json({success:!1,error:"No autenticado"},{status:401});let{data:i,error:n}=await o.from("users").select("id, role, affiliate_studio_id").eq("id",s).single();if(n||!i)return t.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if("super_admin"===a.role);else if("superadmin_aff"===a.role){if("super_admin"===i.role||"superadmin_aff"===i.role)return t.Z.json({success:!1,error:"No tienes permisos para eliminar este usuario"},{status:403});if(!a.affiliate_studio_id)return t.Z.json({success:!1,error:"No tienes permisos para eliminar usuarios"},{status:403});if(i.affiliate_studio_id!==a.affiliate_studio_id)return t.Z.json({success:!1,error:"Solo puedes eliminar usuarios de tu estudio afiliado"},{status:403})}else if("admin"!==a.role)return t.Z.json({success:!1,error:"No tienes permisos para eliminar usuarios"},{status:403});else if("super_admin"===i.role)return t.Z.json({success:!1,error:"No tienes permisos para eliminar este usuario"},{status:403});await o.from("user_groups").delete().eq("user_id",s);let{error:u}=await o.from("users").delete().eq("id",s);if(u)return console.error("âŒ [API] Error eliminando:",u),t.Z.json({success:!1,error:"Error eliminando usuario"},{status:500});return await o.auth.admin.deleteUser(s),console.log("âœ… [API] Usuario eliminado:",s),t.Z.json({success:!0})}catch(e){return console.error("âŒ [API] Error general:",e),t.Z.json({success:!1,error:"Error interno"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/users/route",pathname:"/api/users",filename:"route",bundlePath:"app/api/users/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\users\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:A,serverHooks:E,headerHooks:P,staticGenerationBailout:I}=p,j="/api/users/route";function U(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:A})}},34196:(e,o,r)=>{function s(e,o){return o?"super_admin"!==o.role&&("admin"!==o.role||o.affiliate_studio_id)&&("superadmin_aff"===o.role||"admin"===o.role&&o.affiliate_studio_id)?o.affiliate_studio_id?e.eq("affiliate_studio_id",o.affiliate_studio_id):e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000"):e:e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000")}r.d(o,{rd:()=>s}),process.env.SUPABASE_SERVICE_ROLE_KEY},66569:(e,o,r)=>{r.d(o,{A:()=>t,R:()=>n});var s=r(72964);let a="https://mhernfrkvwigxdubiozm.supabase.co",i=process.env.SUPABASE_SERVICE_ROLE_KEY||"",n=(0,s.createClient)(a,i,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=(0,s.createClient)(a,i,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var o=require("../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),s=o.X(0,[1638,6206,2964],()=>r(55277));module.exports=s})();