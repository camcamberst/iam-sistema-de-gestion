"use strict";(()=>{var e={};e.id=8832,e.ids=[8832],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},17452:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>g,originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>I,routeModule:()=>m,serverHooks:()=>P,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>S});var a={};r.r(a),r.d(a,{GET:()=>l,PUT:()=>p});var t=r(95419),i=r(69108),s=r(99678),n=r(78070),c=r(72964),d=r(37863);let u=(0,c.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(e,{params:o}){try{let{id:e}=o;console.log("\uD83D\uDD0D [API ANTICIPOS] GET anticipo:",e);let{data:r,error:a}=await u.from("anticipos").select(`
        *,
        model:users!anticipos_model_id_fkey(id, name, email, role),
        period:periods(id, name, start_date, end_date)
      `).eq("id",e).single();if(a)return console.error("❌ [API ANTICIPOS] Error:",a),n.Z.json({success:!1,error:a.message},{status:500});if(!r)return n.Z.json({success:!1,error:"Anticipo no encontrado"},{status:404});return n.Z.json({success:!0,data:r})}catch(e){return console.error("❌ [API ANTICIPOS] Error general:",e),n.Z.json({success:!1,error:e.message},{status:500})}}async function p(e,{params:o}){try{let{id:r}=o,a=await e.json();console.log("\uD83D\uDD0D [API ANTICIPOS] PUT anticipo:",r,a);let{estado:t,comentarios_admin:i,comentarios_rechazo:s,admin_id:c,model_id:l}=a;if(!t)return n.Z.json({success:!1,error:"Estado es requerido"},{status:400});if(!["pendiente","aprobado","rechazado","realizado","confirmado","cancelado"].includes(t))return n.Z.json({success:!1,error:"Estado inv\xe1lido"},{status:400});let{data:p,error:m}=await u.from("anticipos").select("*").eq("id",r).single();if(m||!p)return n.Z.json({success:!1,error:"Anticipo no encontrado"},{status:404});let I={estado:t,updated_at:new Date().toISOString()};"aprobado"===t?(I.comentarios_admin=i,I.approved_at=new Date().toISOString(),I.approved_by=c):"rechazado"===t?(I.comentarios_rechazo=s,I.rejected_at=new Date().toISOString(),I.rejected_by=c):"realizado"===t?(I.realized_at=new Date().toISOString(),I.realized_by=c):"confirmado"===t?(I.confirmed_at=new Date().toISOString(),I.confirmed_by=l||c):"cancelado"===t&&(I.cancelled_at=new Date().toISOString(),I.cancelled_by=c);let{data:A,error:P}=await u.from("anticipos").update(I).eq("id",r).select(`
        *,
        model:users!anticipos_model_id_fkey(id, name, email, role),
        period:periods(id, name, start_date, end_date)
      `).single();if(P)return console.error("❌ [API ANTICIPOS] Error actualizando:",P),n.Z.json({success:!1,error:P.message},{status:500});console.log("✅ [API ANTICIPOS] Anticipo actualizado:",r,t);let g=A.model_id,S=A.model?.name||"Modelo",_=A.monto_solicitado;try{"aprobado"===t?(await (0,d.mw)(g),console.log("✅ [API ANTICIPOS] Notificaci\xf3n de aprobaci\xf3n enviada")):"rechazado"===t?(await (0,d.nS)(g),console.log("✅ [API ANTICIPOS] Notificaci\xf3n de rechazo enviada")):"realizado"===t?(await (0,d.Pk)(g,_),console.log("✅ [API ANTICIPOS] Notificaci\xf3n de realizado enviada")):"confirmado"===t&&(await (0,d._3)(g,S,_),console.log("✅ [API ANTICIPOS] Notificaci\xf3n de confirmaci\xf3n enviada a admins"))}catch(e){console.error("⚠️ [API ANTICIPOS] Error enviando notificaci\xf3n:",e)}return n.Z.json({success:!0,data:A,message:`Anticipo ${t} correctamente`})}catch(e){return console.error("❌ [API ANTICIPOS] Error general:",e),n.Z.json({success:!1,error:e.message},{status:500})}}let m=new t.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/anticipos/[id]/route",pathname:"/api/anticipos/[id]",filename:"route",bundlePath:"app/api/anticipos/[id]/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\anticipos\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:I,staticGenerationAsyncStorage:A,serverHooks:P,headerHooks:g,staticGenerationBailout:S}=m,_="/api/anticipos/[id]/route";function f(){return(0,s.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:A})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),a=o.X(0,[1638,6206,2964,7863],()=>r(17452));module.exports=a})();