"use strict";(()=>{var e={};e.id=4574,e.ids=[4574],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},4562:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>P,originalPathname:()=>S,patchFetch:()=>C,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>A,staticGenerationAsyncStorage:()=>D,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{GET:()=>I,POST:()=>m,dynamic:()=>c});var t=r(95419),a=r(69108),i=r(99678),n=r(78070),d=r(72964);let u=()=>{let e=new Date(new Date().toLocaleString("en-US",{timeZone:"America/Bogota"})),o=e.getDate(),r=e.getMonth(),s=e.getFullYear();console.log("\uD83D\uDD0D [ANTICIPO-RESTRICTIONS] Validando fecha:",{colombiaDate:e.toISOString(),day:o,month:r+1,year:s});let t=new Date(s,r,0).getDate(),a=o>=t||o<=5,i=o>=15&&o<=20;if(console.log("\uD83D\uDD0D [ANTICIPO-RESTRICTIONS] Validaciones:",{lastDayOfPrevMonth:t,isInFirstRestriction:a,isInSecondRestriction:i}),a||i){let o=new Date(e);a?o.setDate(6):i&&o.setDate(21);let r=a?`No se pueden solicitar anticipos del ${t} al 5 de cada mes`:"No se pueden solicitar anticipos del 15 al 20 de cada mes";return console.log("\uD83D\uDEAB [ANTICIPO-RESTRICTIONS] Solicitud bloqueada:",{reason:r,nextAvailable:o.toISOString()}),{allowed:!1,reason:r,nextAvailable:o}}return console.log("✅ [ANTICIPO-RESTRICTIONS] Solicitud permitida"),{allowed:!0}},c="force-dynamic",l=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c",p=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",l);async function I(e){try{let{searchParams:o}=new URL(e.url),r=o.get("modelId"),s=o.get("periodDate"),t=o.get("estado"),a=o.get("adminId");if(console.log("\uD83D\uDD0D [API ANTICIPOS] GET request:",{modelId:r,periodDate:s,estado:t,adminId:a}),a){console.log("\uD83D\uDD0D [API ANTICIPOS] Buscando admin con ID:",a);let{data:e,error:o}=await p.from("users").select("role").eq("id",a).single();if(console.log("\uD83D\uDD0D [API ANTICIPOS] Resultado admin:",{adminUser:e,adminError:o}),o)return console.error("❌ [API ANTICIPOS] Error al buscar admin:",o),n.Z.json({success:!1,error:`Error al buscar admin: ${o.message}`},{status:500});if(!e)return console.error("❌ [API ANTICIPOS] Admin no encontrado con ID:",a),n.Z.json({success:!1,error:"Admin no encontrado"},{status:404});console.log("\uD83D\uDD0D [API ANTICIPOS] Rol del admin:",e.role);let r=p.from("anticipos").select(`
          *,
          model:users!anticipos_model_id_fkey(
            id, 
            name, 
            email, 
            role,
            user_groups!user_groups_user_id_fkey(
              group_id,
              groups!user_groups_group_id_fkey(id, name)
            )
          ),
          period:periods(id, name, start_date, end_date)
        `).order("created_at",{ascending:!1});if(console.log("\uD83D\uDD0D [API ANTICIPOS] Aplicando filtros para rol:",e.role),"admin"===e.role){let{data:e}=await p.from("user_groups").select("group_id").eq("user_id",a);if(e&&e.length>0){let o=e.map(e=>e.group_id),{data:s}=await p.from("user_groups").select(`
              user_id,
              users!user_groups_user_id_fkey (
                id,
                role
              )
            `).in("group_id",o).eq("users.role","modelo");if(s&&s.length>0){let e=s.map(e=>e.user_id);r=r.in("model_id",e)}else r=r.eq("id","no-exists")}else r=r.eq("id","no-exists")}if(s&&(r=r.eq("period_id",p.from("periods").select("id").eq("start_date",s))),t&&"todos"!==t){if(t.includes(",")){let e=t.split(",").map(e=>e.trim());r=r.in("estado",e)}else r=r.eq("estado",t)}let{data:i,error:d}=await r;if(console.log("\uD83D\uDD0D [API ANTICIPOS] Resultado de la consulta:",{anticiposCount:i?.length||0,error:d?.message}),d)return console.error("❌ [API ANTICIPOS] Error fetching anticipos:",d),n.Z.json({success:!1,error:"Error al obtener anticipos"},{status:500});return n.Z.json({success:!0,anticipos:i||[]})}if(!r)return n.Z.json({success:!1,error:"Par\xe1metros inv\xe1lidos"},{status:400});{let e=p.from("anticipos").select(`
          *,
          model:users!anticipos_model_id_fkey(
            id, 
            name, 
            email, 
            role,
            groups:user_groups(
              group:groups(id, name)
            )
          ),
          period:periods(id, name, start_date, end_date)
        `).eq("model_id",r).order("created_at",{ascending:!1});if(s&&(e=e.eq("period_id",p.from("periods").select("id").eq("start_date",s))),t){if(t.includes(",")){let o=t.split(",").map(e=>e.trim());e=e.in("estado",o)}else e=e.eq("estado",t)}let{data:o,error:a}=await e;if(a)return console.error("❌ [API ANTICIPOS] Error:",a),n.Z.json({success:!1,error:a.message},{status:500});return console.log("✅ [API ANTICIPOS] Anticipos encontrados:",o?.length||0),n.Z.json({success:!0,data:o||[],count:o?.length||0})}}catch(e){return console.error("❌ [API ANTICIPOS] Error general:",e),n.Z.json({success:!1,error:e.message},{status:500})}}async function m(e){try{let o=u();if(!o.allowed)return console.log("\uD83D\uDEAB [API ANTICIPOS] Solicitud bloqueada por restricci\xf3n temporal:",o.reason),n.Z.json({success:!1,error:o.reason},{status:400});let r=await e.json();console.log("\uD83D\uDD0D [API ANTICIPOS] POST request body:",r);let{model_id:s,period_date:t,monto_solicitado:a,porcentaje_solicitado:i,monto_disponible:d,medio_pago:c,nombre_beneficiario:l,numero_telefono:I,nombre_titular:m,banco:g,banco_otro:_,tipo_cuenta:D,numero_cuenta:A,documento_titular:P}=r;if(!s||!t||!a||!c)return n.Z.json({success:!1,error:"Datos requeridos: model_id, period_date, monto_solicitado, medio_pago"},{status:400});if(a<=0)return n.Z.json({success:!1,error:"El monto debe ser mayor a 0"},{status:400});let{data:f,error:S}=await p.from("periods").select("id").eq("start_date",t).single();if(S&&"PGRST116"!==S.code)return console.error("❌ [API ANTICIPOS] Error obteniendo per\xedodo:",S),n.Z.json({success:!1,error:"Error obteniendo per\xedodo"},{status:500});let C=f?.id;if(!C){let{data:e,error:o}=await p.from("periods").insert({name:`Per\xedodo ${t}`,start_date:t,end_date:t,is_active:!0}).select("id").single();if(o)return console.error("❌ [API ANTICIPOS] Error creando per\xedodo:",o),n.Z.json({success:!1,error:"Error creando per\xedodo"},{status:500});C=e.id}let{data:O,error:E}=await p.from("anticipos").select("id, estado").eq("model_id",s).eq("period_id",C).eq("estado","pendiente").single();if(O)return n.Z.json({success:!1,error:"Ya tienes una solicitud pendiente para este per\xedodo"},{status:400});let T={model_id:s,period_id:C,monto_solicitado:a,porcentaje_solicitado:i,monto_disponible:d,medio_pago:c,estado:"pendiente"};"nequi"===c||"daviplata"===c?(T.nombre_beneficiario=l,T.numero_telefono=I):"cuenta_bancaria"===c&&(T.nombre_titular=m,T.banco=g,T.banco_otro=_,T.tipo_cuenta=D,T.numero_cuenta=A,T.documento_titular=P);let{data:N,error:q}=await p.from("anticipos").insert(T).select(`
        *,
        model:users!anticipos_model_id_fkey(id, name, email),
        period:periods(id, name, start_date, end_date)
      `).single();if(q)return console.error("❌ [API ANTICIPOS] Error creando anticipo:",q),n.Z.json({success:!1,error:q.message},{status:500});return console.log("✅ [API ANTICIPOS] Anticipo creado:",N.id),n.Z.json({success:!0,data:N,message:"Solicitud de anticipo enviada correctamente"})}catch(e){return console.error("❌ [API ANTICIPOS] Error general:",e),n.Z.json({success:!1,error:e.message},{status:500})}}console.log("\uD83D\uDD0D [API ANTICIPOS] Configuraci\xf3n Supabase:",{url:"✅ Configurado",serviceKey:process.env.SUPABASE_SERVICE_ROLE_KEY?"✅ Configurado":"❌ No configurado",anonKey:"✅ Configurado",usingKey:process.env.SUPABASE_SERVICE_ROLE_KEY?"SERVICE_ROLE":"ANON"});let g=new t.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/anticipos/route",pathname:"/api/anticipos",filename:"route",bundlePath:"app/api/anticipos/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\anticipos\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:D,serverHooks:A,headerHooks:P,staticGenerationBailout:f}=g,S="/api/anticipos/route";function C(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:D})}}};var o=require("../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),s=o.X(0,[1638,6206,2964],()=>r(4562));module.exports=s})();