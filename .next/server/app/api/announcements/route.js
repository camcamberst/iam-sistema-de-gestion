"use strict";(()=>{var e={};e.id=5864,e.ids=[5864],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},81580:(e,i,o)=>{o.r(i),o.d(i,{headerHooks:()=>h,originalPathname:()=>C,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>N,staticGenerationBailout:()=>D});var a={};o.r(a),o.d(a,{GET:()=>g,POST:()=>p});var t=o(95419),r=o(69108),n=o(99678),s=o(78070),l=o(72964),u=o(37863);let d="https://mhernfrkvwigxdubiozm.supabase.co",c=process.env.SUPABASE_SERVICE_ROLE_KEY;async function _(e,i,o,a,t){try{let r=(0,l.createClient)(d,c),n=[];if(i){let e=r.from("users").select("id").eq("role","modelo").eq("is_active",!0);t?(e=e.eq("affiliate_studio_id",t),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Filtrando notificaciones por affiliate_studio_id:",t)):(e=e.is("affiliate_studio_id",null),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Anuncio de Innova, notificando solo a modelos de Innova"));let{data:i}=await e;n=i?.map(e=>e.id)||[]}else if(o.length>0){let{data:e}=await r.from("user_groups").select("user_id").in("group_id",o),i=e?.map(e=>e.user_id)||[];if(i.length>0){let e=r.from("users").select("id").in("id",i).eq("role","modelo").eq("is_active",!0);t?(e=e.eq("affiliate_studio_id",t),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Filtrando notificaciones por grupos y affiliate_studio_id:",t)):e=e.is("affiliate_studio_id",null);let{data:o}=await e;n=o?.map(e=>e.id)||[]}}console.log("\uD83D\uDCE2 [ANNOUNCEMENTS] Enviando notificaciones a usuarios:",{announcementId:e,isGeneral:i,groupIds:o,totalUsers:n.length});let s=n.map(e=>(0,u.Hz)(e,a).catch(i=>(console.error(`❌ [ANNOUNCEMENTS] Error notificando a usuario ${e}:`,i),!1)));Promise.all(s).then(e=>{let i=e.filter(e=>!0===e).length;console.log(`✅ [ANNOUNCEMENTS] Notificaciones enviadas: ${i}/${n.length}`)})}catch(e){console.error("❌ [ANNOUNCEMENTS] Error notificando usuarios:",e)}}async function g(e){try{let{searchParams:i}=new URL(e.url),o=i.get("category"),a=parseInt(i.get("limit")||"10"),t=parseInt(i.get("offset")||"0"),r=i.get("userId"),n=i.get("userRole"),u=i.get("userGroups")?.split(",")||[],_=(0,l.createClient)(d,c),g=e.headers.get("authorization");if(!g)return s.Z.json({error:"No autorizado"},{status:401});let p=g.replace("Bearer ",""),{data:{user:f},error:m}=await _.auth.getUser(p);if(m||!f)return s.Z.json({error:"Usuario no autenticado"},{status:401});let{data:N}=await _.from("users").select("id, role, affiliate_studio_id").eq("id",f.id).single(),E=N?.role||n,h="super_admin"===E||"admin"===E,D="super_admin"===E,C="superadmin_aff"===E,A=N?.affiliate_studio_id||null,S=_.from("announcements").select(`
        *,
        category:announcement_categories(*),
        author:users(id, name, email),
        group_targets:announcement_group_targets(
          group:groups(id, name)
        ),
        target_roles
      `);if(h&&!D){let{data:e}=await _.from("announcements").select("id").eq("author_id",f.id),i=e?.map(e=>e.id)||[],{data:o}=await _.from("announcements").select("id").eq("is_general",!0).eq("is_published",!0).is("affiliate_studio_id",null),a=o?.map(e=>e.id)||[],{data:t}=await _.from("user_groups").select("group_id").eq("user_id",f.id),r=t?.map(e=>e.group_id)||[],n=[];if(r.length>0){let{data:e}=await _.from("announcement_group_targets").select("announcement_id").in("group_id",r);n=e?.map(e=>e.announcement_id)||[]}let{data:s}=await _.from("announcements").select("id, target_roles").eq("is_published",!0),l=[];if(s&&s.length>0)for(let e of s)e.target_roles&&Array.isArray(e.target_roles)&&e.target_roles.length>0&&e.target_roles.includes(E)&&l.push(e.id);let u=[...i,...a,...n,...l].filter((e,i,o)=>o.indexOf(e)===i);S=u.length>0?S.in("id",u):S.eq("id","00000000-0000-0000-0000-000000000000")}if("modelo"===E&&(S=S.eq("is_published",!0).or("expires_at.is.null,expires_at.gt."+new Date().toISOString())),h&&!D&&"modelo"!==E&&(S=S.eq("is_published",!0)),C&&A?(console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Aplicando filtro de afiliado para superadmin_aff:",A),S=(S=S.or(`affiliate_studio_id.eq.${A},and(affiliate_studio_id.is.null,share_with_affiliates.eq.true)`)).eq("is_published",!0)):C&&!A&&(console.log("⚠️ [ANNOUNCEMENTS] Superadmin_aff sin affiliate_studio_id, no se mostrar\xe1n anuncios"),S=S.eq("id","00000000-0000-0000-0000-000000000000")),"modelo"===E){A?(console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Aplicando filtro de afiliado para modelo de afiliado:",A),S=S.or(`affiliate_studio_id.eq.${A},and(affiliate_studio_id.is.null,share_with_affiliates.eq.true)`)):(console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Aplicando filtro para modelo de Innova - solo anuncios sin affiliate_studio_id"),S=S.is("affiliate_studio_id",null));let{data:e}=await _.from("user_groups").select("group_id").eq("user_id",r),i=e?.map(e=>e.group_id)||[];if(console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Filtrado para modelo:",{userId:r,userGroupIds:i,userGroupsParam:u,userAffiliateStudioId:A,isInnovaModel:!A}),i.length>0){let{data:e}=await _.from("announcement_group_targets").select("announcement_id").in("group_id",i),o=e?.map(e=>e.announcement_id)||[];console.log("\uD83D\uDCCB [ANNOUNCEMENTS] Anuncios con grupos objetivo:",{targetAnnouncementIds:o,userGroupIds:i}),S=o.length>0?S.or(`is_general.eq.true,id.in.(${o.join(",")})`):S.eq("is_general",!0)}else S=S.eq("is_general",!0)}o&&(S=S.eq("category.slug",o)),S=S.order("is_pinned",{ascending:!1}).order("published_at",{ascending:!1}).order("priority",{ascending:!1}).range(t,t+a-1);let{data:O,error:U}=await S;if(U)return console.error("❌ [ANNOUNCEMENTS] Error obteniendo anuncios:",U),s.Z.json({error:U.message},{status:500});console.log("\uD83D\uDCCA [ANNOUNCEMENTS] Resultados obtenidos:",{count:O?.length||0,userId:r,userRole:n,isAdmin:h,announcements:O?.map(e=>({id:e.id,title:e.title,is_published:e.is_published,is_general:e.is_general,published_at:e.published_at,group_targets_count:e.group_targets?.length||0}))});let q=(O||[]).map(e=>({id:e.id,title:e.title,content:e.content,excerpt:e.excerpt||e.title,featured_image_url:e.featured_image_url,image_urls:e.image_urls||[],category:e.category?{id:e.category.id,name:e.category.name,slug:e.category.slug,icon:e.category.icon,color:e.category.color}:null,author:e.author?{id:e.author.id,name:e.author.name,email:e.author.email}:null,is_general:e.is_general,is_pinned:e.is_pinned,priority:e.priority,views_count:e.views_count,published_at:e.published_at,expires_at:e.expires_at,created_at:e.created_at,group_targets:e.group_targets?.map(e=>({id:e.group.id,name:e.group.name}))||[],target_roles:e.target_roles||[]}));return s.Z.json({success:!0,data:q,count:q.length})}catch(e){return console.error("❌ [ANNOUNCEMENTS] Error en GET:",e),s.Z.json({error:e.message||"Error interno"},{status:500})}}async function p(e){try{let i=await e.json(),{title:o,content:a,excerpt:t,category_id:r,featured_image_url:n,image_urls:u,is_general:g,group_ids:p,target_roles:f,is_published:m,is_pinned:N,priority:E,expires_at:h}=i;if(!o||!a)return s.Z.json({error:"T\xedtulo y contenido son requeridos"},{status:400});let D=e.headers.get("authorization");if(!D)return s.Z.json({error:"No autorizado"},{status:401});let C=(0,l.createClient)(d,c),A=D.replace("Bearer ",""),{data:{user:S},error:O}=await C.auth.getUser(A);if(O||!S)return s.Z.json({error:"Usuario no autenticado"},{status:401});let{data:U}=await C.from("users").select("id, role, organization_id, affiliate_studio_id").eq("id",S.id).single();if(!U||!["super_admin","admin"].includes(U.role)&&"superadmin_aff"!==U.role)return s.Z.json({error:"No tienes permisos para crear anuncios"},{status:403});let q=i.organization_id||U.organization_id,T=i.affiliate_studio_id||null;"superadmin_aff"===U.role&&U.affiliate_studio_id&&(T=U.affiliate_studio_id,console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Superadmin_aff creando anuncio, asignando affiliate_studio_id:",T));let w=!1;"super_admin"===U.role&&!0===i.share_with_affiliates&&(w=!0,console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Superadmin marcando anuncio para compartir con afiliados"));let M={author_id:S.id,category_id:r||null,title:o,content:a,excerpt:t||o.substring(0,150),featured_image_url:n||null,image_urls:u||[],is_general:g||!1,organization_id:q,target_roles:f&&f.length>0?f:[],is_published:m||!1,is_pinned:N||!1,priority:E||0,published_at:m?new Date().toISOString():null,expires_at:h||null};T&&(M.affiliate_studio_id=T),"super_admin"===U.role&&(M.share_with_affiliates=w),console.log("\uD83D\uDCDD [ANNOUNCEMENTS] Creando anuncio:",{title:o,is_published:m,is_general:g,group_ids:p||[],target_roles:f||[],published_at:M.published_at});let{data:b,error:y}=await C.from("announcements").insert(M).select().single();if(y)return console.error("❌ [ANNOUNCEMENTS] Error creando anuncio:",y),s.Z.json({error:y.message},{status:500});if(console.log("✅ [ANNOUNCEMENTS] Anuncio creado:",{id:b.id,title:b.title,is_published:b.is_published,is_general:b.is_general,published_at:b.published_at}),!g&&p&&p.length>0){if("admin"===U.role){let{data:e}=await C.from("user_groups").select("group_id").eq("user_id",S.id),i=e?.map(e=>e.group_id)||[],o=p.filter(e=>i.includes(e));if(o.length>0){let e=o.map(e=>({announcement_id:b.id,group_id:e}));console.log("\uD83D\uDD17 [ANNOUNCEMENTS] Creando relaciones con grupos (admin):",e);let{error:i}=await C.from("announcement_group_targets").insert(e);i?console.error("❌ [ANNOUNCEMENTS] Error creando relaciones con grupos:",i):console.log("✅ [ANNOUNCEMENTS] Relaciones con grupos creadas exitosamente")}}else{let e=p.map(e=>({announcement_id:b.id,group_id:e}));console.log("\uD83D\uDD17 [ANNOUNCEMENTS] Creando relaciones con grupos (super_admin):",e);let{error:i}=await C.from("announcement_group_targets").insert(e);i?console.error("❌ [ANNOUNCEMENTS] Error creando relaciones con grupos:",i):console.log("✅ [ANNOUNCEMENTS] Relaciones con grupos creadas exitosamente")}}else g&&console.log("\uD83D\uDCE2 [ANNOUNCEMENTS] Anuncio general, no se crean relaciones con grupos");return f&&f.length>0&&console.log("✅ [ANNOUNCEMENTS] Roles objetivo guardados:",f),m&&b&&await _(b.id,g,p||[],b.title,b.affiliate_studio_id||null),s.Z.json({success:!0,data:b})}catch(e){return console.error("❌ [ANNOUNCEMENTS] Error en POST:",e),s.Z.json({error:e.message||"Error interno"},{status:500})}}let f=new t.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/announcements/route",pathname:"/api/announcements",filename:"route",bundlePath:"app/api/announcements/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\announcements\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:N,serverHooks:E,headerHooks:h,staticGenerationBailout:D}=f,C="/api/announcements/route";function A(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:N})}}};var i=require("../../../webpack-runtime.js");i.C(e);var o=e=>i(i.s=e),a=i.X(0,[1638,6206,2964,7863],()=>o(81580));module.exports=a})();