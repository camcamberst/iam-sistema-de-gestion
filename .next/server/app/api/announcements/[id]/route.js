"use strict";(()=>{var e={};e.id=1950,e.ids=[1950],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},59186:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>v,originalPathname:()=>y,patchFetch:()=>q,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>N,staticGenerationBailout:()=>w});var i={};r.r(i),r.d(i,{DELETE:()=>g,GET:()=>p,PUT:()=>m});var a=r(95419),o=r(69108),n=r(99678),s=r(78070),u=r(72964),d=r(37863);let l="https://mhernfrkvwigxdubiozm.supabase.co",c=process.env.SUPABASE_SERVICE_ROLE_KEY;async function _(e,t,r,i,a){try{let o=(0,u.createClient)(l,c),n=[];if(t){let e=o.from("users").select("id").eq("role","modelo").eq("is_active",!0);a?(e=e.eq("affiliate_studio_id",a),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Filtrando notificaciones por affiliate_studio_id:",a)):(e=e.is("affiliate_studio_id",null),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Anuncio de Innova, notificando solo a modelos de Innova"));let{data:t}=await e;n=t?.map(e=>e.id)||[]}else if(r.length>0){let{data:e}=await o.from("user_groups").select("user_id").in("group_id",r),t=e?.map(e=>e.user_id)||[];if(t.length>0){let e=o.from("users").select("id").in("id",t).eq("role","modelo").eq("is_active",!0);a?(e=e.eq("affiliate_studio_id",a),console.log("\uD83D\uDD0D [ANNOUNCEMENTS] Filtrando notificaciones por grupos y affiliate_studio_id:",a)):e=e.is("affiliate_studio_id",null);let{data:r}=await e;n=r?.map(e=>e.id)||[]}}console.log("\uD83D\uDCE2 [ANNOUNCEMENTS] Enviando notificaciones a usuarios:",{announcementId:e,isGeneral:t,groupIds:r,totalUsers:n.length});let s=n.map(e=>(0,d.Hz)(e,i).catch(t=>(console.error(`❌ [ANNOUNCEMENTS] Error notificando a usuario ${e}:`,t),!1)));Promise.all(s).then(e=>{let t=e.filter(e=>!0===e).length;console.log(`✅ [ANNOUNCEMENTS] Notificaciones enviadas: ${t}/${n.length}`)})}catch(e){console.error("❌ [ANNOUNCEMENTS] Error notificando usuarios:",e)}}async function p(e,{params:t}){try{let{id:r}=t,i=(0,u.createClient)(l,c),{data:a,error:o}=await i.from("announcements").select(`
        *,
        category:announcement_categories(*),
        author:users(id, name, email),
        group_targets:announcement_group_targets(
          group:groups(id, name)
        )
      `).eq("id",r).single();if(o)return console.error("❌ [ANNOUNCEMENTS] Error obteniendo anuncio:",o),s.Z.json({error:o.message},{status:500});if(!a)return s.Z.json({error:"Anuncio no encontrado"},{status:404});let n={id:a.id,title:a.title,content:a.content,excerpt:a.excerpt||a.title,featured_image_url:a.featured_image_url,image_urls:a.image_urls||[],category:a.category?{id:a.category.id,name:a.category.name,slug:a.category.slug,icon:a.category.icon,color:a.category.color}:null,author:a.author?{id:a.author.id,name:a.author.name,email:a.author.email}:null,is_general:a.is_general,is_pinned:a.is_pinned,priority:a.priority,views_count:a.views_count,published_at:a.published_at,expires_at:a.expires_at,created_at:a.created_at,updated_at:a.updated_at,group_targets:a.group_targets?.map(e=>({id:e.group.id,name:e.group.name}))||[]},d=e.headers.get("authorization");if(d&&a.is_published){let e=d.replace("Bearer ",""),{data:{user:t}}=await i.auth.getUser(e);t&&(await i.from("announcement_views").upsert({announcement_id:r,user_id:t.id,viewed_at:new Date().toISOString()},{onConflict:"announcement_id,user_id"}),await i.from("announcements").update({views_count:(a.views_count||0)+1}).eq("id",r))}return s.Z.json({success:!0,data:n})}catch(e){return console.error("❌ [ANNOUNCEMENTS] Error en GET [id]:",e),s.Z.json({error:e.message||"Error interno"},{status:500})}}async function m(e,{params:t}){try{let{id:r}=t,i=await e.json(),a=e.headers.get("authorization");if(!a)return s.Z.json({error:"No autorizado"},{status:401});let o=(0,u.createClient)(l,c),n=a.replace("Bearer ",""),{data:{user:d},error:p}=await o.auth.getUser(n);if(p||!d)return s.Z.json({error:"Usuario no autenticado"},{status:401});let{data:m}=await o.from("users").select("id, role, affiliate_studio_id").eq("id",d.id).single();if(!m||!["super_admin","admin"].includes(m.role)&&"superadmin_aff"!==m.role)return s.Z.json({error:"No tienes permisos para editar anuncios"},{status:403});let{data:g}=await o.from("announcements").select("author_id, organization_id, published_at, affiliate_studio_id").eq("id",r).single();if(!g)return s.Z.json({error:"Anuncio no encontrado"},{status:404});let f=g.author_id===d.id,h="super_admin"===m.role,N="superadmin_aff"===m.role&&m.affiliate_studio_id&&g.affiliate_studio_id===m.affiliate_studio_id;if(!f&&!h&&!N)return s.Z.json({error:"No tienes permisos para editar este anuncio"},{status:403});let E={};void 0!==i.title&&(E.title=i.title),void 0!==i.content&&(E.content=i.content),void 0!==i.excerpt&&(E.excerpt=i.excerpt),void 0!==i.category_id&&(E.category_id=i.category_id),void 0!==i.featured_image_url&&(E.featured_image_url=i.featured_image_url),void 0!==i.image_urls&&(E.image_urls=i.image_urls),void 0!==i.is_general&&(E.is_general=i.is_general),void 0!==i.is_published&&(E.is_published=i.is_published,i.is_published&&!g.published_at&&(E.published_at=new Date().toISOString())),void 0!==i.is_pinned&&(E.is_pinned=i.is_pinned),void 0!==i.priority&&(E.priority=i.priority),void 0!==i.expires_at&&(E.expires_at=i.expires_at),"super_admin"===m.role&&void 0!==i.share_with_affiliates&&(E.share_with_affiliates=i.share_with_affiliates),void 0!==i.target_roles&&(E.target_roles=i.target_roles||[]);let{data:v,error:w}=await o.from("announcements").update(E).eq("id",r).select().single();if(w)return console.error("❌ [ANNOUNCEMENTS] Error actualizando anuncio:",w),s.Z.json({error:w.message},{status:500});let y=[];if(void 0!==i.group_ids)y=i.group_ids;else{let{data:e}=await o.from("announcement_group_targets").select("group_id").eq("announcement_id",r);y=e?.map(e=>e.group_id)||[]}if(void 0!==i.group_ids&&(await o.from("announcement_group_targets").delete().eq("announcement_id",r),i.group_ids.length>0)){if("admin"===m.role){let{data:e}=await o.from("user_groups").select("group_id").eq("user_id",d.id),t=e?.map(e=>e.group_id)||[],a=i.group_ids.filter(e=>t.includes(e));a.length>0&&await o.from("announcement_group_targets").insert(a.map(e=>({announcement_id:r,group_id:e}))),y=a}else await o.from("announcement_group_targets").insert(i.group_ids.map(e=>({announcement_id:r,group_id:e})))}return void 0!==i.target_roles&&i.target_roles.length>0&&console.log("✅ [ANNOUNCEMENTS] Roles objetivo actualizados:",i.target_roles),!0===i.is_published&&!g.published_at&&v&&await _(r,v.is_general||!1,y,v.title||"Nueva publicaci\xf3n",v.affiliate_studio_id||null),s.Z.json({success:!0,data:v})}catch(e){return console.error("❌ [ANNOUNCEMENTS] Error en PUT [id]:",e),s.Z.json({error:e.message||"Error interno"},{status:500})}}async function g(e,{params:t}){try{let{id:r}=t,i=e.headers.get("authorization");if(!i)return s.Z.json({error:"No autorizado"},{status:401});let a=(0,u.createClient)(l,c),o=i.replace("Bearer ",""),{data:{user:n},error:d}=await a.auth.getUser(o);if(d||!n)return s.Z.json({error:"Usuario no autenticado"},{status:401});let{data:_}=await a.from("users").select("id, role, affiliate_studio_id").eq("id",n.id).single();if(!_||!["super_admin","admin"].includes(_.role)&&"superadmin_aff"!==_.role)return s.Z.json({error:"No tienes permisos para eliminar anuncios"},{status:403});let{data:p}=await a.from("announcements").select("author_id, affiliate_studio_id").eq("id",r).single();if(!p)return s.Z.json({error:"Anuncio no encontrado"},{status:404});let m=p.author_id===n.id,g="super_admin"===_.role,f="superadmin_aff"===_.role&&_.affiliate_studio_id&&p.affiliate_studio_id===_.affiliate_studio_id;if(!m&&!g&&!f)return s.Z.json({error:"No tienes permisos para eliminar este anuncio"},{status:403});let{error:h}=await a.from("announcements").delete().eq("id",r);if(h)return console.error("❌ [ANNOUNCEMENTS] Error eliminando anuncio:",h),s.Z.json({error:h.message},{status:500});return s.Z.json({success:!0,message:"Anuncio eliminado correctamente"})}catch(e){return console.error("❌ [ANNOUNCEMENTS] Error en DELETE [id]:",e),s.Z.json({error:e.message||"Error interno"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/announcements/[id]/route",pathname:"/api/announcements/[id]",filename:"route",bundlePath:"app/api/announcements/[id]/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\announcements\\[id]\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:h,staticGenerationAsyncStorage:N,serverHooks:E,headerHooks:v,staticGenerationBailout:w}=f,y="/api/announcements/[id]/route";function q(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:N})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[1638,6206,2964,7863],()=>r(59186));module.exports=i})();