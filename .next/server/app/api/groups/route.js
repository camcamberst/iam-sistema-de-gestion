"use strict";(()=>{var e={};e.id=7475,e.ids=[7475],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},81398:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>A,originalPathname:()=>I,patchFetch:()=>h,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>D,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>P});var s={};o.r(s),o.d(s,{DELETE:()=>p,GET:()=>l,POST:()=>c,PUT:()=>f});var i=o(95419),a=o(69108),t=o(99678),n=o(78070),u=o(66569),d=o(34196);async function l(e){try{console.log("\uD83C\uDFE2 [API] Obteniendo grupos...");let r=u.R,o=e.headers.get("authorization"),s="admin",i=[];if(o)try{let e=o.replace("Bearer ",""),{data:{user:r},error:a}=await u.A.auth.getUser(e);if(!a&&r){let{data:e,error:o}=await u.R.from("users").select("role, groups").eq("id",r.id).single();!o&&e&&(s=e.role,i=e.groups||[],console.log("\uD83D\uDD0D [API] Usuario:",{role:s,groups:i}))}}catch(e){console.log("⚠️ [API] No se pudo obtener info del usuario, usando defaults")}let a=null;if(o)try{let e=o.replace("Bearer ",""),{data:{user:r},error:s}=await u.A.auth.getUser(e);if(!s&&r){let{data:e}=await u.R.from("users").select("role, affiliate_studio_id").eq("id",r.id).single();e&&(a={id:r.id,role:e.role,affiliate_studio_id:e.affiliate_studio_id})}}catch(e){console.log("⚠️ [API] No se pudo obtener usuario completo")}let t=r.from("groups").select("id, name, is_active, description, created_at, affiliate_studio_id");"super_admin"!==s||a?.affiliate_studio_id?a?.affiliate_studio_id?(t=(0,d.rd)(t,a),console.log("\uD83C\uDFE2 [API] Usuario afiliado - mostrando solo grupos de su estudio")):(t=(0,d.rd)(t,a),i.length>0&&(t=t.in("id",i),console.log("\uD83D\uDD12 [API] Filtrando grupos para admin:",i))):(t=t.is("affiliate_studio_id",null),console.log("\uD83D\uDC51 [API] Super admin master - mostrando solo sedes de Agencia Innova"),console.log("\uD83D\uDD0D [API] Usuario:",{role:s,affiliate_studio_id:a?.affiliate_studio_id}));let{data:l,error:c}=await t.order("name",{ascending:!0});if(c)return console.error("❌ [API] Error obteniendo grupos:",c),n.Z.json({success:!1,error:`Error obteniendo grupos: ${c.message}`},{status:500});if(console.log("✅ [API] Grupos obtenidos:",l?.length||0,"para rol:",s),"super_admin"===s&&!a?.affiliate_studio_id){let e=(l||[]).filter(e=>null===e.affiliate_studio_id||void 0===e.affiliate_studio_id),r=(l||[]).filter(e=>null!==e.affiliate_studio_id&&void 0!==e.affiliate_studio_id);return console.log("\uD83D\uDD0D [API] Debug - Total grupos obtenidos:",l?.length||0),console.log("\uD83D\uDD0D [API] Debug - Grupos con afiliado (ser\xe1n filtrados):",r.length),console.log("\uD83D\uDD0D [API] Debug - Grupos sin afiliado (Innova - se mostrar\xe1n):",e.length),r.length>0&&(console.log("⚠️ [API] WARNING: Se encontraron grupos de afiliados que ser\xe1n filtrados!"),console.log("\uD83D\uDD0D [API] Grupos con afiliado:",r.map(e=>({id:e.id,name:e.name,affiliate_studio_id:e.affiliate_studio_id})))),console.log("\uD83D\uDD27 [API] Aplicando filtro en servidor para superadmin master"),n.Z.json({success:!0,groups:e,userRole:s})}return n.Z.json({success:!0,groups:l||[],userRole:s})}catch(e){return console.error("❌ [API] Error general:",e),n.Z.json({success:!1,error:`Error interno: ${e.message}`},{status:500})}}async function c(e){try{let r=await e.json();if(r.userRole&&r.userGroups){console.log("\uD83C\uDFE2 [API] Obteniendo grupos con info del usuario...");let o=u.R,s=r.userRole,i=r.userGroups;console.log("\uD83D\uDD0D [API] Usuario desde body:",{role:s,groups:i});let a=null,t=e.headers.get("authorization");if(console.log("\uD83D\uDD0D [API] Authorization header presente:",!!t),t)try{let e=t.replace("Bearer ",""),{data:{user:r},error:o}=await u.A.auth.getUser(e);if(o)console.error("❌ [API] Error obteniendo usuario del token:",o);else if(r){console.log("✅ [API] Usuario obtenido del token:",r.id);let{data:e,error:o}=await u.R.from("users").select("affiliate_studio_id, role").eq("id",r.id).single();o?console.error("❌ [API] Error obteniendo datos del usuario:",o):e&&(a=e.affiliate_studio_id,console.log("\uD83D\uDD0D [API] Usuario:",{id:r.id,role:e.role,affiliate_studio_id:a}))}}catch(e){console.error("❌ [API] Error en autenticaci\xf3n:",e)}else console.warn("⚠️ [API] No se proporcion\xf3 header de Authorization");let d=o.from("groups").select("id, name, is_active, description, created_at, affiliate_studio_id");"super_admin"!==s||a?"superadmin_aff"===s?a?(d=d.eq("affiliate_studio_id",a),console.log("\uD83C\uDFE2 [API] Superadmin_aff - mostrando solo grupos de su estudio:",a)):(d=d.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000"),console.warn("⚠️ [API] Superadmin_aff sin affiliate_studio_id - no se mostrar\xe1n grupos")):"admin"===s&&a?(d=d.eq("affiliate_studio_id",a),console.log("\uD83C\uDFE2 [API] Admin afiliado - mostrando solo grupos de su estudio:",a)):i.length>0&&(d=d.in("id",i),console.log("\uD83D\uDD12 [API] Filtrando grupos para admin:",i)):(d=d.is("affiliate_studio_id",null),console.log("\uD83D\uDC51 [API] Super admin master - mostrando solo sedes de Agencia Innova"));let{data:l,error:c}=await d.order("name",{ascending:!0});if(c)return console.error("❌ [API] Error obteniendo grupos:",c),n.Z.json({success:!1,error:`Error obteniendo grupos: ${c.message}`},{status:500});let f=l||[];return"superadmin_aff"===s?a?(f=f.filter(e=>e.affiliate_studio_id===a),console.log("\uD83D\uDD27 [API] Filtro adicional aplicado para superadmin_aff:",f.length,"grupos"),console.log("\uD83D\uDD0D [API] Grupos filtrados:",f.map(e=>({id:e.id,name:e.name,affiliate_studio_id:e.affiliate_studio_id})))):(f=[],console.warn("⚠️ [API] Superadmin_aff sin affiliate_studio_id - retornando lista vac\xeda")):"admin"===s&&a&&(f=f.filter(e=>e.affiliate_studio_id===a),console.log("\uD83D\uDD27 [API] Filtro adicional aplicado para admin afiliado:",f.length,"grupos")),"super_admin"!==s||a||(f=f.filter(e=>null===e.affiliate_studio_id||void 0===e.affiliate_studio_id),console.log("\uD83D\uDD27 [API] Filtro adicional aplicado para super_admin master:",f.length,"grupos")),console.log("✅ [API] Grupos obtenidos:",f.length,"para rol:",s),n.Z.json({success:!0,groups:f,userRole:s})}console.log("\uD83C\uDFE2 [API] Creando grupo...");let{name:o}=r;if(!o||!o.trim())return n.Z.json({success:!1,error:"El nombre del grupo es requerido"},{status:400});let s=u.R,i=e.headers.get("authorization"),a="admin",t=null,d=null,l=null;if(!i)return console.error("❌ [API] No se proporcion\xf3 token de autorizaci\xf3n"),n.Z.json({success:!1,error:"Token de autorizaci\xf3n requerido"},{status:401});try{let e=i.replace("Bearer ",""),{data:{user:r},error:o}=await u.A.auth.getUser(e);if(o||!r)return console.error("❌ [API] Error autenticando usuario:",o),n.Z.json({success:!1,error:"Token inv\xe1lido o expirado"},{status:401});d=r.id,console.log("\uD83D\uDD0D [API] Usuario autenticado:",d);let{data:s,error:c}=await u.R.from("users").select("role, affiliate_studio_id, organization_id").eq("id",r.id).single();if(c||!s)return console.error("❌ [API] Error obteniendo datos del usuario:",c),n.Z.json({success:!1,error:"Usuario no encontrado en la base de datos"},{status:404});a=s.role,t=s.affiliate_studio_id,l=s.organization_id,console.log("\uD83D\uDD0D [API] Datos del usuario:",{role:a,affiliate_studio_id:t,organization_id:l})}catch(e){return console.error("❌ [API] Error en autenticaci\xf3n:",e),n.Z.json({success:!1,error:"Error de autenticaci\xf3n"},{status:401})}if("super_admin"!==a&&"superadmin_aff"!==a)return console.error("❌ [API] Usuario sin permisos:",a),n.Z.json({success:!1,error:"Solo los super administradores pueden crear grupos"},{status:403});if("superadmin_aff"===a&&!t)return console.error("❌ [API] Superadmin_aff sin affiliate_studio_id"),n.Z.json({success:!1,error:"El usuario no est\xe1 asociado a un estudio afiliado"},{status:400});let c=l;if(!c){let{data:e,error:r}=await u.R.from("organizations").select("id").eq("name","Organizaci\xf3n Principal").single();if(r||!e){let{data:e,error:r}=await u.R.from("organizations").insert({name:"Organizaci\xf3n Principal",description:"Organizaci\xf3n principal del sistema",is_active:!0}).select("id").single();if(r||!e)return console.error("❌ [API] Error creando organizaci\xf3n por defecto:",r),n.Z.json({success:!1,error:"Error configurando organizaci\xf3n"},{status:500});c=e.id,console.log("✅ [API] Organizaci\xf3n por defecto creada:",c)}else c=e.id,console.log("\uD83D\uDD0D [API] Usando organizaci\xf3n por defecto existente:",c)}let f={name:o.trim(),organization_id:c,is_active:!0};"superadmin_aff"===a&&t&&(f.affiliate_studio_id=t,console.log("\uD83D\uDD0D [API] Superadmin_aff creando grupo, asignando affiliate_studio_id:",t)),console.log("\uD83D\uDD0D [API] Datos del grupo a crear:",f);let{data:p,error:g}=await s.from("groups").insert(f).select("id, name, is_active, description, created_at, affiliate_studio_id").single();if(g){if(console.error("❌ [API] Error creando grupo:",g),console.error("❌ [API] Detalles del error:",{code:g.code,message:g.message,details:g.details,hint:g.hint}),"23505"===g.code)return n.Z.json({success:!1,error:"Ya existe un grupo con ese nombre"},{status:400});let e=g.message||"Error creando grupo";return n.Z.json({success:!1,error:e},{status:500})}return console.log("✅ [API] Grupo creado:",p),n.Z.json({success:!0,group:p})}catch(e){return console.error("❌ [API] Error general:",e),n.Z.json({success:!1,error:"Error interno"},{status:500})}}async function f(e){try{let{id:r,name:o,description:s,is_active:i}=await e.json();if(!r)return n.Z.json({success:!1,error:"ID del grupo es requerido"},{status:400});if(!o||!o.trim())return n.Z.json({success:!1,error:"El nombre del grupo es requerido"},{status:400});let a=u.R,t=e.headers.get("authorization");if(!t)return n.Z.json({success:!1,error:"Token de autorizaci\xf3n requerido"},{status:401});let d=t.replace("Bearer ",""),{data:{user:l},error:c}=await u.A.auth.getUser(d);if(c||!l)return n.Z.json({success:!1,error:"Token inv\xe1lido o expirado"},{status:401});let{data:f,error:p}=await u.R.from("users").select("role, affiliate_studio_id").eq("id",l.id).single();if(p||!f)return n.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if("super_admin"!==f.role&&"superadmin_aff"!==f.role)return n.Z.json({success:!1,error:"No tienes permisos para editar sedes"},{status:403});let{data:g,error:_}=await a.from("groups").select("id, name, affiliate_studio_id").eq("id",r).single();if(_||!g)return n.Z.json({success:!1,error:"Sede no encontrada"},{status:404});if("superadmin_aff"===f.role&&f.affiliate_studio_id&&g.affiliate_studio_id!==f.affiliate_studio_id)return n.Z.json({success:!1,error:"No tienes permisos para editar esta sede"},{status:403});let m={name:o.trim(),updated_at:new Date().toISOString()};void 0!==s&&(m.description=s),void 0!==i&&(m.is_active=i);let{data:D,error:A}=await a.from("groups").update(m).eq("id",r).select("id, name, is_active, description, created_at, affiliate_studio_id").single();if(A){if(console.error("❌ [API] Error actualizando grupo:",A),"23505"===A.code)return n.Z.json({success:!1,error:"Ya existe una sede con ese nombre"},{status:400});return n.Z.json({success:!1,error:A.message||"Error actualizando sede"},{status:500})}return console.log("✅ [API] Grupo actualizado:",D),n.Z.json({success:!0,group:D})}catch(e){return console.error("❌ [API] Error general:",e),n.Z.json({success:!1,error:"Error interno"},{status:500})}}async function p(e){try{let{searchParams:r}=new URL(e.url),o=r.get("id");if(!o)return n.Z.json({success:!1,error:"ID del grupo es requerido"},{status:400});let s=u.R,i=e.headers.get("authorization");if(!i)return n.Z.json({success:!1,error:"Token de autorizaci\xf3n requerido"},{status:401});let a=i.replace("Bearer ",""),{data:{user:t},error:d}=await u.A.auth.getUser(a);if(d||!t)return n.Z.json({success:!1,error:"Token inv\xe1lido o expirado"},{status:401});let{data:l,error:c}=await u.R.from("users").select("role, affiliate_studio_id").eq("id",t.id).single();if(c||!l)return n.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if("super_admin"!==l.role&&"superadmin_aff"!==l.role)return n.Z.json({success:!1,error:"No tienes permisos para eliminar sedes"},{status:403});let{data:f,error:p}=await s.from("groups").select("id, name, affiliate_studio_id").eq("id",o).single();if(p||!f)return n.Z.json({success:!1,error:"Sede no encontrada"},{status:404});if("superadmin_aff"===l.role&&l.affiliate_studio_id&&f.affiliate_studio_id!==l.affiliate_studio_id)return n.Z.json({success:!1,error:"No tienes permisos para eliminar esta sede"},{status:403});let{data:g,error:_}=await s.from("user_groups").select("user_id").eq("group_id",o).limit(1);if(_)return console.error("❌ [API] Error verificando usuarios en grupo:",_),n.Z.json({success:!1,error:"Error verificando dependencias"},{status:500});let{data:m,error:D}=await s.from("rooms").select("id").eq("group_id",o).limit(1);if(D)return console.error("❌ [API] Error verificando rooms en grupo:",D),n.Z.json({success:!1,error:"Error verificando dependencias"},{status:500});if(g&&g.length>0||m&&m.length>0)return n.Z.json({success:!1,error:"No se puede eliminar la sede porque tiene usuarios o rooms asignados. Primero elimina o reasigna los usuarios y rooms.",hasDependencies:!0,usersCount:g?.length||0,roomsCount:m?.length||0},{status:400});let{error:A}=await s.from("groups").delete().eq("id",o);if(A)return console.error("❌ [API] Error eliminando grupo:",A),n.Z.json({success:!1,error:A.message||"Error eliminando sede"},{status:500});return console.log("✅ [API] Grupo eliminado:",o),n.Z.json({success:!0,message:"Sede eliminada exitosamente"})}catch(e){return console.error("❌ [API] Error general:",e),n.Z.json({success:!1,error:"Error interno"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/groups/route",pathname:"/api/groups",filename:"route",bundlePath:"app/api/groups/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\groups\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:D,headerHooks:A,staticGenerationBailout:P}=g,I="/api/groups/route";function h(){return(0,t.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:m})}},34196:(e,r,o)=>{function s(e,r){return r?"super_admin"!==r.role&&("admin"!==r.role||r.affiliate_studio_id)&&("superadmin_aff"===r.role||"admin"===r.role&&r.affiliate_studio_id)?r.affiliate_studio_id?e.eq("affiliate_studio_id",r.affiliate_studio_id):e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000"):e:e.eq("affiliate_studio_id","00000000-0000-0000-0000-000000000000")}o.d(r,{rd:()=>s}),process.env.SUPABASE_SERVICE_ROLE_KEY},66569:(e,r,o)=>{o.d(r,{A:()=>n,R:()=>t});var s=o(72964);let i="https://mhernfrkvwigxdubiozm.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY||"",t=(0,s.createClient)(i,a,{auth:{autoRefreshToken:!1,persistSession:!1}}),n=(0,s.createClient)(i,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),s=r.X(0,[1638,6206,2964],()=>o(81398));module.exports=s})();