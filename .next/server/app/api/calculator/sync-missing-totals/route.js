"use strict";(()=>{var e={};e.id=7124,e.ids=[7124],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},81872:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>v,originalPathname:()=>D,patchFetch:()=>h,requestAsyncStorage:()=>S,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var a={};t.r(a),t.d(a,{POST:()=>p,dynamic:()=>d});var o=t(95419),s=t(69108),n=t(99678),i=t(78070),l=t(72964),u=t(13532);let d="force-dynamic",c=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e){try{let{modelId:r,periodDate:t}=await e.json();if(!r)return i.Z.json({success:!1,error:"modelId es requerido"},{status:400});let a=t||(0,u.iR)();console.log("\uD83D\uDD0D [SYNC-MISSING-TOTALS] Sincronizando totales para:",{modelId:r,targetDate:a});let{data:o,error:s}=await c.from("model_values").select(`
        *,
        platforms!inner(id, name, currency, percentage)
      `).eq("model_id",r).gte("period_date",new Date(new Date(a).setDate(new Date(a).getDate()-2)).toISOString().split("T")[0]).lte("period_date",new Date(new Date(a).setDate(new Date(a).getDate()+2)).toISOString().split("T")[0]).order("updated_at",{ascending:!1});if(s)return console.error("❌ [SYNC-MISSING-TOTALS] Error obteniendo valores:",s),i.Z.json({success:!1,error:`Error obteniendo valores: ${s.message}`},{status:500});if(!o||0===o.length)return i.Z.json({success:!1,error:"No se encontraron valores para este modelo"},{status:404});let{data:n,error:l}=await c.from("calculator_config").select("percentage_override, group_percentage").eq("model_id",r).eq("active",!0).single();l&&"PGRST116"!==l.code&&console.error("❌ [SYNC-MISSING-TOTALS] Error obteniendo configuraci\xf3n:",l);let{data:d,error:p}=await c.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),m={usd_cop:3900,eur_usd:1.01,gbp_usd:1.2};!p&&d&&d.forEach(e=>{"USD→COP"===e.kind&&(m.usd_cop=e.value),"EUR→USD"===e.kind&&(m.eur_usd=e.value),"GBP→USD"===e.kind&&(m.gbp_usd=e.value)});let{data:S,error:g}=await c.from("platforms").select("id, name, currency, percentage");g&&console.error("❌ [SYNC-MISSING-TOTALS] Error obteniendo plataformas:",g);let _=new Map;S?.forEach(e=>{_.set(e.id,e)});let v=0,f=0,D=new Map;o.forEach(e=>{let r=e.platform_id;(!D.has(r)||new Date(e.updated_at)>new Date(D.get(r).updated_at))&&D.set(r,e)}),D.forEach((e,r)=>{let t=_.get(r);if(!t||!e.value||e.value<=0)return;let a=0,o=0;"EUR"===t.currency?a="big7"===r?e.value*m.eur_usd*.84:"mondo"===r?e.value*m.eur_usd*.78:e.value*m.eur_usd:"GBP"===t.currency?a="aw"===r?e.value*m.gbp_usd*.677:e.value*m.gbp_usd:"USD"===t.currency&&(a="cmd"===r||"camlust"===r||"skypvt"===r?.75*e.value:"chaturbate"===r||"myfreecams"===r||"stripchat"===r?.05*e.value:"dxlive"===r?.6*e.value:"secretfriends"===r?.5*e.value:e.value),v+=a,o=t.percentage/100*a,f+=o});let h=n?.percentage_override||n?.group_percentage||70,T=(f=h/100*v)*m.usd_cop,{data:b,error:E}=await c.from("calculator_totals").upsert({model_id:r,period_date:a,total_usd_bruto:Math.round(100*v)/100,total_usd_modelo:Math.round(100*f)/100,total_cop_modelo:Math.round(T),updated_at:new Date().toISOString()},{onConflict:"model_id,period_date"}).select().single();if(E)return console.error("❌ [SYNC-MISSING-TOTALS] Error guardando totales:",E),i.Z.json({success:!1,error:`Error guardando totales: ${E.message}`},{status:500});return console.log("✅ [SYNC-MISSING-TOTALS] Totales sincronizados:",{modelId:r,targetDate:a,totalUsdBruto:v,totalUsdModelo:f,totalCopModelo:T}),i.Z.json({success:!0,message:"Totales sincronizados correctamente",data:b,calculated:{totalUsdBruto:v,totalUsdModelo:f,totalCopModelo:T,modelPercentage:h}})}catch(e){return console.error("❌ [SYNC-MISSING-TOTALS] Error:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/sync-missing-totals/route",pathname:"/api/calculator/sync-missing-totals",filename:"route",bundlePath:"app/api/calculator/sync-missing-totals/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\sync-missing-totals\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:S,staticGenerationAsyncStorage:g,serverHooks:_,headerHooks:v,staticGenerationBailout:f}=m,D="/api/calculator/sync-missing-totals/route";function h(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:g})}},13532:(e,r,t)=>{t.d(r,{Bs:()=>s,Jz:()=>o,iR:()=>n,lm:()=>a});let a=()=>{let[e,r,t]=n().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},o=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("⚠️ [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),a();let[r,t,o]=e.split("-").map(Number);if(!r||!t||!o)return a();return`${r}-${String(t).padStart(2,"0")}-${String(o<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("❌ [DATE-UTILS] Error normalizando fecha:",e),a()}},s=e=>{try{let[r,t,a]=e.split("-").map(Number),o=a<=15,s=`${r}-${String(t).padStart(2,"0")}-${o?"01":"16"}`,n="";if(o)n=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();n=`${r}-${String(t).padStart(2,"0")}-${e}`}let i=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${o?"1":"2"}`;return{startDate:s,endDate:n,name:i,isP1:o}}catch(r){return console.error("❌ [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},n=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(81872));module.exports=a})();