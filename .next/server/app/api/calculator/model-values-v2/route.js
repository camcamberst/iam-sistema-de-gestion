"use strict";(()=>{var e={};e.id=7987,e.ids=[7987],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},18388:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>v,originalPathname:()=>S,patchFetch:()=>V,requestAsyncStorage:()=>p,routeModule:()=>E,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>L});var t={};o.r(t),o.d(t,{GET:()=>c,POST:()=>D});var a=o(95419),s=o(69108),n=o(99678),l=o(78070),u=o(72964),i=o(13532);let d=(0,u.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function c(e){let{searchParams:r}=new URL(e.url),o=r.get("modelId"),t=r.get("periodDate")||(0,i.iR)();if(!o)return l.Z.json({success:!1,error:"modelId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Loading values:",{modelId:o,periodDate:t}),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Service role key configured:",!!process.env.SUPABASE_SERVICE_ROLE_KEY),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Starting database query..."),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Buscando datos recientes sin filtro de fecha espec\xedfico...");let e=new Date;e.setDate(e.getDate()-7);let r=e.toISOString().split("T")[0],{data:a,error:s}=await d.from("model_values").select(`
        model_id, platform_id, value, period_date, updated_at
      `).eq("model_id",o).gte("period_date",r).order("updated_at",{ascending:!1}).limit(200);console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Found recent values:",a?.length||0);let n=new Map;a?.forEach(e=>{n.has(e.platform_id)||n.set(e.platform_id,e)});let u=Array.from(n.values());if(console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Unique platform values:",u.length),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Found values:",u?.length||0),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Current values query completed. Values:",u),console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Current values count:",u?.length||0),s)return console.error("❌ [MODEL-VALUES-V2] Database error:",s),l.Z.json({success:!1,error:s.message,details:s,modelId:o,periodDate:t},{status:500});return console.log("✅ [MODEL-VALUES-V2] Success! Returning data:",u||[]),l.Z.json({success:!0,data:u||[],count:u?.length||0,modelId:o,periodDate:t})}catch(e){return console.error("❌ [MODEL-VALUES-V2] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function D(e){try{let{modelId:r,values:o,periodDate:t}=await e.json();if(!r||!o)return l.Z.json({success:!1,error:"modelId y values son requeridos"},{status:400});let a=(0,i.iR)();console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Saving values:",{modelId:r,effectiveDate:a,values:o});let s=Object.entries(o).map(([e,o])=>({model_id:r,platform_id:e,value:Number.parseFloat(String(o))||0,period_date:a}));console.log("\uD83D\uDD0D [MODEL-VALUES-V2] Rows to upsert:",s);let{data:n,error:u}=await d.from("model_values").upsert(s,{onConflict:"model_id,platform_id,period_date"}).select();if(u)return console.error("❌ [MODEL-VALUES-V2] Error al guardar valores:",u),l.Z.json({success:!1,error:u.message},{status:500});return console.log("✅ [MODEL-VALUES-V2] Values saved successfully:",n),l.Z.json({success:!0,data:n||[],message:"Valores guardados correctamente"})}catch(e){return console.error("❌ [MODEL-VALUES-V2] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let E=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/model-values-v2/route",pathname:"/api/calculator/model-values-v2",filename:"route",bundlePath:"app/api/calculator/model-values-v2/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\model-values-v2\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:g,headerHooks:v,staticGenerationBailout:L}=E,S="/api/calculator/model-values-v2/route";function V(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},13532:(e,r,o)=>{o.d(r,{LQ:()=>n,iR:()=>a,t2:()=>l,wU:()=>u});let t=()=>(console.warn("⚠️ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),s=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),n=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},l=()=>{let e=new Date;return e.setDate(e.getDate()+1),s(e)},u=async e=>{let{createClient:r}=await o.e(2964).then(o.bind(o,72964)),a=r("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e||t();try{let{data:e,error:r}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",s).eq("end_date",s).eq("is_active",!0).single();if(r&&"PGRST116"!==r.code)throw console.error("❌ [CREATE-PERIOD] Error verificando per\xedodo:",r),r;if(e)return console.log("✅ [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",s);let{data:o,error:t}=await a.from("periods").insert({name:`Per\xedodo ${s}`,start_date:s,end_date:s,is_active:!0}).select().single();if(t)throw console.error("❌ [CREATE-PERIOD] Error creando per\xedodo:",t),t;return console.log("✅ [CREATE-PERIOD] Per\xedodo creado exitosamente:",o),o}catch(e){throw console.error("❌ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(18388));module.exports=t})();