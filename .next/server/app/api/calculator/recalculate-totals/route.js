"use strict";(()=>{var e={};e.id=545,e.ids=[545],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},49159:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>_,originalPathname:()=>T,patchFetch:()=>A,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>v});var a={};t.r(a),t.d(a,{POST:()=>c});var o=t(95419),l=t(69108),i=t(99678),s=t(78070),n=t(72964),u=t(13532);let d=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function c(e){try{console.log("\uD83D\uDD04 [RECALCULATE-TOTALS] Iniciando rec\xe1lculo de totales...");let{data:e,error:r}=await d.from("calculator_config").select("model_id, percentage_override, group_percentage").eq("active",!0);if(r)return console.error("‚ùå [RECALCULATE-TOTALS] Error al obtener configuraciones:",r),s.Z.json({success:!1,error:"Error al obtener configuraciones"},{status:500});if(!e||0===e.length)return s.Z.json({success:!0,message:"No hay configuraciones para recalcular"});console.log(`üîç [RECALCULATE-TOTALS] Encontradas ${e.length} configuraciones`);let{data:t,error:a}=await d.from("rates").select("kind, value, valid_from").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),o={usd_cop:3900,eur_usd:1.01,gbp_usd:1.2};if(!a&&t){let e=t?.filter(e=>"USD‚ÜíCOP"===e.kind)||[],r=t?.filter(e=>"EUR‚ÜíUSD"===e.kind)||[],a=t?.filter(e=>"GBP‚ÜíUSD"===e.kind)||[],l=e.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],i=r.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],s=a.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0];o={usd_cop:l?.value||3900,eur_usd:i?.value||1.01,gbp_usd:s?.value||1.2}}console.log("\uD83D\uDD0D [RECALCULATE-TOTALS] Tasas:",o);let{data:l,error:i}=await d.from("calculator_platforms").select("*").eq("active",!0);if(i)return console.error("‚ùå [RECALCULATE-TOTALS] Error al obtener plataformas:",i),s.Z.json({success:!1,error:"Error al obtener plataformas"},{status:500});l?.map(e=>[e.id,e]);let n=(0,u.iR)(),c=new Date;c.setDate(c.getDate()-7);let m=c.toISOString().split("T")[0],{data:p,error:g}=await d.from("model_values").select("model_id, platform_id, value, period_date, updated_at").gte("period_date",m).order("updated_at",{ascending:!1});if(g)return console.error("‚ùå [RECALCULATE-TOTALS] Error al obtener valores:",g),s.Z.json({success:!1,error:"Error al obtener valores"},{status:500});let f=[];for(let r of e){let e=r.model_id,t=r.percentage_override||r.group_percentage||80;console.log(`üîç [RECALCULATE-TOTALS] Procesando modelo ${e} con porcentaje ${t}%`);let a=p?.filter(r=>r.model_id===e)||[],i=new Map;a.forEach(e=>{i.has(e.platform_id)||i.set(e.platform_id,e)});let s=0;for(let[e,r]of Array.from(i.entries())){let t=l?.find(r=>r.id===e);if(!t||!r.value)continue;let a=0;"EUR"===t.currency?a="big7"===t.id?Number(r.value)*o.eur_usd*.84:"mondo"===t.id?Number(r.value)*o.eur_usd*.78:Number(r.value)*o.eur_usd:"GBP"===t.currency?a="aw"===t.id?Number(r.value)*o.gbp_usd*.677:Number(r.value)*o.gbp_usd:"USD"===t.currency&&("cmd"===t.id||"camlust"===t.id||"skypvt"===t.id?a=.75*Number(r.value):"chaturbate"===t.id||"myfreecams"===t.id||"stripchat"===t.id?a=.05*Number(r.value):"dxlive"===t.id?a=.6*Number(r.value):"secretfriends"===t.id?a=.5*Number(r.value):("superfoon"===t.id||"mdh"===t.id||"livejasmin"===t.id||"imlive"===t.id||"hegre"===t.id||"dirtyfans"===t.id||t.id,a=Number(r.value))),s+=a}let u=t/100*s,d=u*o.usd_cop;f.push({model_id:e,period_date:n,total_usd_bruto:Math.round(100*s)/100,total_usd_modelo:Math.round(100*u)/100,total_cop_modelo:Math.round(d),updated_at:new Date().toISOString()}),console.log(`‚úÖ [RECALCULATE-TOTALS] Modelo ${e}: USD Bruto=${s.toFixed(2)}, USD Modelo=${u.toFixed(2)}, Porcentaje=${t}%`)}if(f.length>0){let{error:e}=await d.from("calculator_totals").upsert(f,{onConflict:"model_id,period_date"});if(e)return console.error("‚ùå [RECALCULATE-TOTALS] Error al actualizar totales:",e),s.Z.json({success:!1,error:"Error al actualizar totales"},{status:500});console.log(`‚úÖ [RECALCULATE-TOTALS] Actualizados ${f.length} totales`)}return s.Z.json({success:!0,message:`Recalculados ${f.length} totales con la nueva l\xf3gica simple`,recalculated:f.length,rates:o})}catch(e){return console.error("‚ùå [RECALCULATE-TOTALS] Error general:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/calculator/recalculate-totals/route",pathname:"/api/calculator/recalculate-totals",filename:"route",bundlePath:"app/api/calculator/recalculate-totals/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\recalculate-totals\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:_,staticGenerationBailout:v}=m,T="/api/calculator/recalculate-totals/route";function A(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},13532:(e,r,t)=>{t.d(r,{Bs:()=>l,Jz:()=>o,iR:()=>i,lm:()=>a});let a=()=>{let[e,r,t]=i().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},o=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("‚ö†Ô∏è [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),a();let[r,t,o]=e.split("-").map(Number);if(!r||!t||!o)return a();return`${r}-${String(t).padStart(2,"0")}-${String(o<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("‚ùå [DATE-UTILS] Error normalizando fecha:",e),a()}},l=e=>{try{let[r,t,a]=e.split("-").map(Number),o=a<=15,l=`${r}-${String(t).padStart(2,"0")}-${o?"01":"16"}`,i="";if(o)i=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();i=`${r}-${String(t).padStart(2,"0")}-${e}`}let s=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${o?"1":"2"}`;return{startDate:l,endDate:i,name:s,isP1:o}}catch(r){return console.error("‚ùå [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},i=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(49159));module.exports=a})();