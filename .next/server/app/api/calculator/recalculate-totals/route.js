"use strict";(()=>{var e={};e.id=545,e.ids=[545],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},49159:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>_,originalPathname:()=>v,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>E,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var o={};t.r(o),t.d(o,{POST:()=>u});var a=t(95419),s=t(69108),l=t(99678),i=t(78070),n=t(72964),d=t(13532);let c=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e){try{console.log("\uD83D\uDD04 [RECALCULATE-TOTALS] Iniciando rec\xe1lculo de totales...");let{data:e,error:r}=await c.from("calculator_config").select("model_id, percentage_override, group_percentage").eq("active",!0);if(r)return console.error("❌ [RECALCULATE-TOTALS] Error al obtener configuraciones:",r),i.Z.json({success:!1,error:"Error al obtener configuraciones"},{status:500});if(!e||0===e.length)return i.Z.json({success:!0,message:"No hay configuraciones para recalcular"});console.log(`🔍 [RECALCULATE-TOTALS] Encontradas ${e.length} configuraciones`);let{data:t,error:o}=await c.from("rates").select("kind, value, valid_from").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),a={usd_cop:3900,eur_usd:1.01,gbp_usd:1.2};if(!o&&t){let e=t?.filter(e=>"USD→COP"===e.kind)||[],r=t?.filter(e=>"EUR→USD"===e.kind)||[],o=t?.filter(e=>"GBP→USD"===e.kind)||[],s=e.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],l=r.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],i=o.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0];a={usd_cop:s?.value||3900,eur_usd:l?.value||1.01,gbp_usd:i?.value||1.2}}console.log("\uD83D\uDD0D [RECALCULATE-TOTALS] Tasas:",a);let{data:s,error:l}=await c.from("calculator_platforms").select("*").eq("active",!0);if(l)return console.error("❌ [RECALCULATE-TOTALS] Error al obtener plataformas:",l),i.Z.json({success:!1,error:"Error al obtener plataformas"},{status:500});s?.map(e=>[e.id,e]);let n=(0,d.iR)(),u=new Date;u.setDate(u.getDate()-7);let p=u.toISOString().split("T")[0],{data:m,error:g}=await c.from("model_values").select("model_id, platform_id, value, period_date, updated_at").gte("period_date",p).order("updated_at",{ascending:!1});if(g)return console.error("❌ [RECALCULATE-TOTALS] Error al obtener valores:",g),i.Z.json({success:!1,error:"Error al obtener valores"},{status:500});let E=[];for(let r of e){let e=r.model_id,t=r.percentage_override||r.group_percentage||80;console.log(`🔍 [RECALCULATE-TOTALS] Procesando modelo ${e} con porcentaje ${t}%`);let o=m?.filter(r=>r.model_id===e)||[],l=new Map;o.forEach(e=>{l.has(e.platform_id)||l.set(e.platform_id,e)});let i=0;for(let[e,r]of Array.from(l.entries())){let t=s?.find(r=>r.id===e);if(!t||!r.value)continue;let o=0;"EUR"===t.currency?o="big7"===t.id?Number(r.value)*a.eur_usd*.84:"mondo"===t.id?Number(r.value)*a.eur_usd*.78:Number(r.value)*a.eur_usd:"GBP"===t.currency?o="aw"===t.id?Number(r.value)*a.gbp_usd*.677:Number(r.value)*a.gbp_usd:"USD"===t.currency&&("cmd"===t.id||"camlust"===t.id||"skypvt"===t.id?o=.75*Number(r.value):"chaturbate"===t.id||"myfreecams"===t.id||"stripchat"===t.id?o=.05*Number(r.value):"dxlive"===t.id?o=.6*Number(r.value):"secretfriends"===t.id?o=.5*Number(r.value):("superfoon"===t.id||"mdh"===t.id||"livejasmin"===t.id||"imlive"===t.id||"hegre"===t.id||"dirtyfans"===t.id||t.id,o=Number(r.value))),i+=o}let d=t/100*i,c=d*a.usd_cop;E.push({model_id:e,period_date:n,total_usd_bruto:Math.round(100*i)/100,total_usd_modelo:Math.round(100*d)/100,total_cop_modelo:Math.round(c),updated_at:new Date().toISOString()}),console.log(`✅ [RECALCULATE-TOTALS] Modelo ${e}: USD Bruto=${i.toFixed(2)}, USD Modelo=${d.toFixed(2)}, Porcentaje=${t}%`)}if(E.length>0){let{error:e}=await c.from("calculator_totals").upsert(E,{onConflict:"model_id,period_date"});if(e)return console.error("❌ [RECALCULATE-TOTALS] Error al actualizar totales:",e),i.Z.json({success:!1,error:"Error al actualizar totales"},{status:500});console.log(`✅ [RECALCULATE-TOTALS] Actualizados ${E.length} totales`)}return i.Z.json({success:!0,message:`Recalculados ${E.length} totales con la nueva l\xf3gica simple`,recalculated:E.length,rates:a})}catch(e){return console.error("❌ [RECALCULATE-TOTALS] Error general:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/recalculate-totals/route",pathname:"/api/calculator/recalculate-totals",filename:"route",bundlePath:"app/api/calculator/recalculate-totals/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\recalculate-totals\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:E,headerHooks:_,staticGenerationBailout:f}=p,v="/api/calculator/recalculate-totals/route";function A(){return(0,l.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:g})}},13532:(e,r,t)=>{t.d(r,{LQ:()=>l,iR:()=>a,t2:()=>i,wU:()=>n});let o=()=>(console.warn("⚠️ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),s=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),l=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},i=()=>{let e=new Date;return e.setDate(e.getDate()+1),s(e)},n=async e=>{let{createClient:r}=await t.e(2964).then(t.bind(t,72964)),a=r("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e||o();try{let{data:e,error:r}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",s).eq("end_date",s).eq("is_active",!0).single();if(r&&"PGRST116"!==r.code)throw console.error("❌ [CREATE-PERIOD] Error verificando per\xedodo:",r),r;if(e)return console.log("✅ [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",s);let{data:t,error:o}=await a.from("periods").insert({name:`Per\xedodo ${s}`,start_date:s,end_date:s,is_active:!0}).select().single();if(o)throw console.error("❌ [CREATE-PERIOD] Error creando per\xedodo:",o),o;return console.log("✅ [CREATE-PERIOD] Per\xedodo creado exitosamente:",t),t}catch(e){throw console.error("❌ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(49159));module.exports=o})();