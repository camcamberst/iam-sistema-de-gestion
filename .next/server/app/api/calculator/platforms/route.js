"use strict";(()=>{var e={};e.id=1242,e.ids=[1242],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},37898:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>A,originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>P,routeModule:()=>p,serverHooks:()=>S,staticGenerationAsyncStorage:()=>D,staticGenerationBailout:()=>_});var t={};s.r(t),s.d(t,{DELETE:()=>m,GET:()=>l,PATCH:()=>f,POST:()=>i,PUT:()=>d});var a=s(95419),o=s(69108),n=s(99678),u=s(78070);let c=(0,s(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(){try{console.log("\uD83D\uDD0D [API-PLATFORMS] Iniciando consulta a calculator_platforms...");let{data:e,error:r}=await c.from("calculator_platforms").select("*").eq("active",!0).order("name");if(console.log("\uD83D\uDD0D [API-PLATFORMS] Error de Supabase:",r),console.log("\uD83D\uDD0D [API-PLATFORMS] Data raw:",e),console.log("\uD83D\uDD0D [API-PLATFORMS] Data type:",typeof e),console.log("\uD83D\uDD0D [API-PLATFORMS] Data length:",e?.length),console.log("\uD83D\uDD0D [API-PLATFORMS] Data is array:",Array.isArray(e)),r)return console.error("❌ [API-PLATFORMS] Error al obtener plataformas:",r),u.Z.json({success:!1,error:r.message},{status:500});let s={success:!0,config:{platforms:e||[]}};return console.log("\uD83D\uDD0D [API-PLATFORMS] Response final:",s),console.log("\uD83D\uDD0D [API-PLATFORMS] Response platforms length:",s.config.platforms?.length),u.Z.json(s)}catch(e){return console.error("❌ [API-PLATFORMS] Error en /api/calculator/platforms:",e),u.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function i(e){try{let{id:r,name:s,description:t,currency:a,token_rate:o,discount_factor:n,tax_rate:l,direct_payout:i,payment_frequency:d,created_by:m}=await e.json();if(console.log("\uD83D\uDD0D [API-PLATFORMS-POST] Iniciando creaci\xf3n de plataforma:",{id:r,name:s,currency:a}),!m)return u.Z.json({success:!1,error:"created_by es requerido"},{status:400});let{data:f,error:p}=await c.from("users").select("role").eq("id",m).single();if(p||!f||"super_admin"!==f.role)return console.error("❌ [API-PLATFORMS-POST] Usuario no autorizado:",{userError:p,user:f}),u.Z.json({success:!1,error:"Solo Super Admins pueden crear plataformas"},{status:403});if(!r||!s||!a)return u.Z.json({success:!1,error:"id, name y currency son requeridos"},{status:400});let P=r.toLowerCase().trim();if(!/^[a-z0-9_-]+$/.test(P))return u.Z.json({success:!1,error:"ID debe contener solo letras min\xfasculas, n\xfameros, guiones y guiones bajos"},{status:400});let D=a.toUpperCase();if(!["USD","EUR","GBP"].includes(D))return u.Z.json({success:!1,error:"currency debe ser USD, EUR o GBP"},{status:400});let{data:S,error:A}=await c.from("calculator_platforms").select("id").eq("id",P).single();if(S)return console.error("❌ [API-PLATFORMS-POST] ID duplicado:",P),u.Z.json({success:!1,error:"Ya existe una plataforma con ese ID"},{status:409});let _=null!=o&&""!==o,g=null!=n&&""!==n,y=null!=l&&""!==l,j=!0===i;if("USD"===D&&_){if(g||y)return u.Z.json({success:!1,error:"Plataformas con token_rate no pueden tener discount_factor o tax_rate"},{status:400});let e=Number(o);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"token_rate debe ser un n\xfamero entre 0 y 1"},{status:400})}else if("USD"!==D||_){if("EUR"===D||"GBP"===D){if(_)return u.Z.json({success:!1,error:"Plataformas EUR/GBP no pueden tener token_rate"},{status:400});if(g){let e=Number(n);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"discount_factor debe ser un n\xfamero entre 0 y 1"},{status:400})}if(y){let e=Number(l);if(isNaN(e)||e<0||e>1)return u.Z.json({success:!1,error:"tax_rate debe ser un n\xfamero entre 0 y 1"},{status:400})}}}else{if(j&&(g||y))return u.Z.json({success:!1,error:"Plataformas con direct_payout no pueden tener discount_factor o tax_rate"},{status:400});if(g){let e=Number(n);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"discount_factor debe ser un n\xfamero entre 0 y 1"},{status:400})}}if(d&&!["quincenal","mensual"].includes(d))return u.Z.json({success:!1,error:'payment_frequency debe ser "quincenal" o "mensual"'},{status:400});let T={id:P,name:s.trim(),description:t?.trim()||null,currency:D,token_rate:_?Number(o):null,discount_factor:g?Number(n):null,tax_rate:y?Number(l):null,direct_payout:j||!1,payment_frequency:d||"quincenal",active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("\uD83D\uDD0D [API-PLATFORMS-POST] Datos a insertar:",T);let{data:Z,error:O}=await c.from("calculator_platforms").insert(T).select().single();if(O)return console.error("❌ [API-PLATFORMS-POST] Error al crear plataforma:",O),u.Z.json({success:!1,error:O.message||"Error al crear plataforma"},{status:500});return console.log("✅ [API-PLATFORMS-POST] Plataforma creada exitosamente:",Z.id),u.Z.json({success:!0,platform:Z,message:"Plataforma creada exitosamente"})}catch(e){return console.error("❌ [API-PLATFORMS-POST] Error en POST:",e),u.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function d(e){try{let{id:r,name:s,description:t,currency:a,token_rate:o,discount_factor:n,tax_rate:l,direct_payout:i,payment_frequency:d,login_url:m,updated_by:f}=await e.json();if(console.log("\uD83D\uDD0D [API-PLATFORMS-PUT] Iniciando actualizaci\xf3n de plataforma:",{id:r,name:s}),!f)return u.Z.json({success:!1,error:"updated_by es requerido"},{status:400});let{data:p,error:P}=await c.from("users").select("role").eq("id",f).single();if(P||!p||"super_admin"!==p.role)return console.error("❌ [API-PLATFORMS-PUT] Usuario no autorizado:",{userError:P,user:p}),u.Z.json({success:!1,error:"Solo Super Admins pueden actualizar plataformas"},{status:403});if(!r||!s||!a)return u.Z.json({success:!1,error:"id, name y currency son requeridos"},{status:400});let D=a.toUpperCase();if(!["USD","EUR","GBP"].includes(D))return u.Z.json({success:!1,error:"currency debe ser USD, EUR o GBP"},{status:400});let S=null!=o&&""!==o,A=null!=n&&""!==n,_=null!=l&&""!==l,g=!0===i;if("USD"===D&&S){if(A||_)return u.Z.json({success:!1,error:"Plataformas con token_rate no pueden tener discount_factor o tax_rate"},{status:400});let e=Number(o);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"token_rate debe ser un n\xfamero entre 0 y 1"},{status:400})}else if("USD"!==D||S){if("EUR"===D||"GBP"===D){if(S)return u.Z.json({success:!1,error:"Plataformas EUR/GBP no pueden tener token_rate"},{status:400});if(A){let e=Number(n);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"discount_factor debe ser un n\xfamero entre 0 y 1"},{status:400})}if(_){let e=Number(l);if(isNaN(e)||e<0||e>1)return u.Z.json({success:!1,error:"tax_rate debe ser un n\xfamero entre 0 y 1"},{status:400})}}}else{if(g&&(A||_))return u.Z.json({success:!1,error:"Plataformas con direct_payout no pueden tener discount_factor o tax_rate"},{status:400});if(A){let e=Number(n);if(isNaN(e)||e<=0||e>1)return u.Z.json({success:!1,error:"discount_factor debe ser un n\xfamero entre 0 y 1"},{status:400})}}if(d&&!["quincenal","mensual"].includes(d))return u.Z.json({success:!1,error:'payment_frequency debe ser "quincenal" o "mensual"'},{status:400});if(null!=m&&""!==m)try{new URL(m.trim())}catch{return u.Z.json({success:!1,error:"login_url debe ser una URL v\xe1lida"},{status:400})}let y={name:s.trim(),description:t?.trim()||null,currency:D,token_rate:S?Number(o):null,discount_factor:A?Number(n):null,tax_rate:_?Number(l):null,direct_payout:g||!1,payment_frequency:d||"quincenal",login_url:m?.trim()||null,updated_at:new Date().toISOString()};console.log("\uD83D\uDD0D [API-PLATFORMS-PUT] Datos a actualizar:",y);let{data:j,error:T}=await c.from("calculator_platforms").update(y).eq("id",r).select().single();if(T)return console.error("❌ [API-PLATFORMS-PUT] Error al actualizar plataforma:",T),u.Z.json({success:!1,error:T.message||"Error al actualizar plataforma"},{status:500});return console.log("✅ [API-PLATFORMS-PUT] Plataforma actualizada exitosamente:",j.id),u.Z.json({success:!0,platform:j,message:"Plataforma actualizada exitosamente"})}catch(e){return console.error("❌ [API-PLATFORMS-PUT] Error en PUT:",e),u.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function m(e){try{let{searchParams:r}=new URL(e.url),s=r.get("id"),t=r.get("deleted_by");if(!s||!t)return u.Z.json({success:!1,error:"id y deleted_by son requeridos"},{status:400});let{data:a,error:o}=await c.from("users").select("role").eq("id",t).single();if(o||!a||"super_admin"!==a.role)return u.Z.json({success:!1,error:"Solo Super Admins pueden eliminar plataformas"},{status:403});let{error:n}=await c.from("calculator_platforms").update({active:!1,updated_at:new Date().toISOString()}).eq("id",s);if(n)return u.Z.json({success:!1,error:n.message},{status:500});return u.Z.json({success:!0,message:"Plataforma eliminada exitosamente"})}catch(e){return u.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function f(e){try{let{platformId:r,payment_frequency:s}=await e.json();if(!r||!s)return u.Z.json({success:!1,error:"platformId y payment_frequency son requeridos"},{status:400});if(!["quincenal","mensual"].includes(s))return u.Z.json({success:!1,error:'payment_frequency debe ser "quincenal" o "mensual"'},{status:400});let{data:t,error:a}=await c.from("calculator_platforms").update({payment_frequency:s,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(a)return console.error("❌ [API-PLATFORMS] Error al actualizar plataforma:",a),u.Z.json({success:!1,error:a.message},{status:500});return u.Z.json({success:!0,platform:t})}catch(e){return console.error("❌ [API-PLATFORMS] Error en PATCH:",e),u.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/calculator/platforms/route",pathname:"/api/calculator/platforms",filename:"route",bundlePath:"app/api/calculator/platforms/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\platforms\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:P,staticGenerationAsyncStorage:D,serverHooks:S,headerHooks:A,staticGenerationBailout:_}=p,g="/api/calculator/platforms/route";function y(){return(0,n.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:D})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>s(37898));module.exports=t})();