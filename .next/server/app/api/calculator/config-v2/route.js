"use strict";(()=>{var e={};e.id=9346,e.ids=[9346],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},67205:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>_,originalPathname:()=>D,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var a={};o.r(a),o.d(a,{GET:()=>u,POST:()=>l});var t=o(95419),n=o(69108),i=o(99678),s=o(78070);let c=(0,o(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function u(e){let{searchParams:r}=new URL(e.url),o=r.get("userId"),a=r.get("modelId"),t=a||o;if(!t)return s.Z.json({success:!1,error:"modelId o userId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [CONFIG-V2] Loading config for modelId:",t,{via:a?"modelId":"userId-legacy"});let{data:e,error:r}=await c.from("calculator_config").select("*").eq("model_id",t).eq("active",!0).single();if(r&&"PGRST116"!==r.code)return console.error("Error al obtener configuraci\xf3n:",r),s.Z.json({success:!1,error:r.message},{status:500});if(!e)return console.log("\uD83D\uDD0D [CONFIG-V2] No config found for modelId:",t),s.Z.json({success:!0,config:{model_id:t,active:!1,platforms:[]}});let{data:o,error:n}=await c.from("calculator_platforms").select("*").in("id",e.enabled_platforms).eq("active",!0).order("name");if(n)return console.error("Error al obtener plataformas:",n),s.Z.json({success:!1,error:n.message},{status:500});console.log("\uD83D\uDD0D [CONFIG-V2] Raw config data:",{percentage_override:e.percentage_override,group_percentage:e.group_percentage,min_quota_override:e.min_quota_override,group_min_quota:e.group_min_quota}),console.log("\uD83D\uDD0D [CONFIG-V2] DEBUG - Platform mapping:",o.map(r=>({id:r.id,name:r.name,percentage_override:e.percentage_override,group_percentage:e.group_percentage,final_group_percentage:e.group_percentage})));let i={model_id:t,active:!0,platforms:o.map(r=>({id:r.id,name:r.name,description:r.description,currency:r.currency,token_rate:r.token_rate,discount_factor:r.discount_factor,tax_rate:r.tax_rate,direct_payout:r.direct_payout,enabled:!0,percentage_override:e.percentage_override,group_percentage:e.group_percentage,min_quota_override:e.min_quota_override,group_min_quota:e.group_min_quota}))};return console.log("\uD83D\uDD0D [CONFIG-V2] Returning config:",i),s.Z.json({success:!0,config:i})}catch(e){return console.error("❌ [CONFIG-V2] Error:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function l(e){try{let{modelId:r,adminId:o,groupId:a,enabledPlatforms:t,percentageOverride:n,minQuotaOverride:i,groupPercentage:u,groupMinQuota:l}=await e.json();if(!r||!o||!a)return s.Z.json({success:!1,error:"modelId, adminId y groupId son requeridos"},{status:400});let{data:d,error:p}=await c.from("users").select("role").eq("id",o).single();if(p)return console.error("Error al obtener admin:",p),s.Z.json({success:!1,error:"Admin no encontrado"},{status:404});let g="super_admin"===d.role,m="admin"===d.role;if(!g&&!m)return s.Z.json({success:!1,error:"No tienes permisos para configurar esta modelo"},{status:403});await c.from("calculator_config").update({active:!1}).eq("model_id",r);let{data:_,error:f}=await c.from("calculator_config").insert({model_id:r,admin_id:o,group_id:a,enabled_platforms:t||[],percentage_override:n||null,min_quota_override:i||null,group_percentage:void 0!==u?u:null,group_min_quota:l||null}).select().single();if(f)return console.error("Error al crear configuraci\xf3n:",f),s.Z.json({success:!1,error:f.message},{status:500});console.log("\uD83D\uDD0D [CONFIG-V2] Configuraci\xf3n aplicada solo a la modelo seleccionada. NO se propaga a otras modelos del grupo."),console.log("\uD83D\uDD0D [CONFIG-V2] Creando Portafolio autom\xe1ticamente para configuraci\xf3n inicial...");try{let{data:e,error:a}=await c.from("modelo_plataformas").select("id").eq("model_id",r).limit(1);if(a)console.error("Error al verificar Portafolio existente:",a);else if(e&&0!==e.length)console.log("\uD83D\uDD0D [CONFIG-V2] Portafolio ya existe para esta modelo, saltando creaci\xf3n autom\xe1tica");else{console.log("\uD83D\uDD0D [CONFIG-V2] No existe Portafolio, creando autom\xe1ticamente...");let e=t.map(e=>({model_id:r,platform_id:e,status:"entregada",is_initial_config:!0,requested_at:new Date().toISOString(),delivered_at:new Date().toISOString(),requested_by:o,delivered_by:o,notes:"Configuraci\xf3n inicial autom\xe1tica"})),{error:a}=await c.from("modelo_plataformas").insert(e);a?console.error("Error al crear Portafolio autom\xe1ticamente:",a):console.log("✅ [CONFIG-V2] Portafolio creado autom\xe1ticamente con",e.length,"plataformas")}}catch(e){console.error("Error en creaci\xf3n autom\xe1tica de Portafolio:",e)}return console.log("\uD83D\uDD0D [CONFIG-V2] Created config:",_),s.Z.json({success:!0,config:_})}catch(e){return console.error("❌ [CONFIG-V2] Error:",e),s.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let d=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/calculator/config-v2/route",pathname:"/api/calculator/config-v2",filename:"route",bundlePath:"app/api/calculator/config-v2/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\config-v2\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:m,headerHooks:_,staticGenerationBailout:f}=d,D="/api/calculator/config-v2/route";function v(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>o(67205));module.exports=a})();