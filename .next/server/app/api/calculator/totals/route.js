"use strict";(()=>{var e={};e.id=2608,e.ids=[2608],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},44117:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>D,originalPathname:()=>C,patchFetch:()=>_,requestAsyncStorage:()=>A,routeModule:()=>T,serverHooks:()=>L,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>O});var o={};r.r(o),r.d(o,{GET:()=>p,POST:()=>m,PUT:()=>g,dynamic:()=>u});var a=r(95419),s=r(69108),l=r(99678),n=r(78070),i=r(72964),d=r(13532);let u="force-dynamic",c=(0,i.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e){let{searchParams:t}=new URL(e.url),r=t.get("modelId"),o=t.get("periodDate")||(0,d.lm)(),a=(0,d.Jz)(o);if(!r)return n.Z.json({success:!1,error:"modelId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Obteniendo totales:",{modelId:r,periodDate:a,rawPeriodDate:o});let[e,t,s]=a.split("-").map(Number),l=new Date(e,t-1,s>=16?new Date(e,t,0).getDate():15).toISOString().split("T")[0],{data:i,error:d}=await c.from("calculator_totals").select("*").eq("model_id",r).gte("period_date",a).lte("period_date",l).order("updated_at",{ascending:!1}).limit(1);if(d&&"PGRST116"!==d.code)return console.error("❌ [CALCULATOR-TOTALS] Error al obtener totales:",d),n.Z.json({success:!1,error:d.message},{status:500});let u=i&&i.length>0?i[0]:null;return console.log("✅ [CALCULATOR-TOTALS] Totales obtenidos:",u),n.Z.json({success:!0,data:u,modelId:r,periodDate:a})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function m(e){try{let{modelId:t,periodDate:r,totalUsdBruto:o,totalUsdModelo:a,totalCopModelo:s}=await e.json();if(!t||void 0===o||void 0===a||void 0===s)return n.Z.json({success:!1,error:"modelId, totalUsdBruto, totalUsdModelo y totalCopModelo son requeridos"},{status:400});console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Guardando totales:",{modelId:t,periodDate:r,totalUsdBruto:o,totalUsdModelo:a,totalCopModelo:s});let l=r||(0,d.lm)(),i=(0,d.Jz)(l);console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Fecha normalizada:",{original:r,normalized:i});let{data:u,error:p}=await c.from("calculator_totals").upsert({model_id:t,period_date:i,total_usd_bruto:Number.parseFloat(String(o))||0,total_usd_modelo:Number.parseFloat(String(a))||0,total_cop_modelo:Number.parseFloat(String(s))||0,updated_at:new Date().toISOString()},{onConflict:"model_id,period_date"}).select();if(p)return console.error("❌ [CALCULATOR-TOTALS] Error al guardar totales:",p),n.Z.json({success:!1,error:p.message},{status:500});return console.log("✅ [CALCULATOR-TOTALS] Totales guardados:",u),n.Z.json({success:!0,data:u?.[0]||null,message:"Totales guardados correctamente",periodDate:i})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function g(e){let{searchParams:t}=new URL(e.url),r=t.get("modelIds")?.split(",")||[],o=t.get("periodDate")||(0,d.lm)(),a=(0,d.Jz)(o);if(0===r.length)return n.Z.json({success:!1,error:"modelIds es requerido"},{status:400});try{console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Obteniendo totales m\xfaltiples:",{modelIds:r,periodDate:a,rawPeriodDate:o});let[e,t,s]=a.split("-").map(Number),l=new Date(e,t-1,s>=16?new Date(e,t,0).getDate():15).toISOString().split("T")[0],{data:i,error:d}=await c.from("calculator_totals").select(`
        *,
        users!inner(email, name)
      `).in("model_id",r).gte("period_date",a).lte("period_date",l).order("updated_at",{ascending:!1});if(d)return console.error("❌ [CALCULATOR-TOTALS] Error al obtener totales m\xfaltiples:",d),n.Z.json({success:!1,error:d.message},{status:500});let u=new Map;i&&i.length>0&&i.forEach(e=>{let t=u.get(e.model_id);(!t||new Date(e.updated_at)>new Date(t.updated_at))&&u.set(e.model_id,e)});let p=Array.from(u.values());return console.log("✅ [CALCULATOR-TOTALS] Totales m\xfaltiples obtenidos:",p.length,"de",i?.length||0,"registros"),n.Z.json({success:!0,data:p,count:p.length,periodDate:a})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let T=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/totals/route",pathname:"/api/calculator/totals",filename:"route",bundlePath:"app/api/calculator/totals/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\totals\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:A,staticGenerationAsyncStorage:S,serverHooks:L,headerHooks:D,staticGenerationBailout:O}=T,C="/api/calculator/totals/route";function _(){return(0,l.patchFetch)({serverHooks:L,staticGenerationAsyncStorage:S})}},13532:(e,t,r)=>{r.d(t,{Bs:()=>s,Jz:()=>a,iR:()=>l,lm:()=>o});let o=()=>{let[e,t,r]=l().split("-").map(Number);return`${e}-${String(t).padStart(2,"0")}-${String(r<=15?1:16).padStart(2,"0")}`},a=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("⚠️ [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),o();let[t,r,a]=e.split("-").map(Number);if(!t||!r||!a)return o();return`${t}-${String(r).padStart(2,"0")}-${String(a<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("❌ [DATE-UTILS] Error normalizando fecha:",e),o()}},s=e=>{try{let[t,r,o]=e.split("-").map(Number),a=o<=15,s=`${t}-${String(r).padStart(2,"0")}-${a?"01":"16"}`,l="";if(a)l=`${t}-${String(r).padStart(2,"0")}-15`;else{let e=new Date(t,r,0).getDate();l=`${t}-${String(r).padStart(2,"0")}-${e}`}let n=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][r-1]} ${t} - Per\xedodo ${a?"1":"2"}`;return{startDate:s,endDate:l,name:n,isP1:a}}catch(t){return console.error("❌ [DATE-UTILS] Error calculando detalles del per\xedodo:",t),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},l=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2964],()=>r(44117));module.exports=o})();