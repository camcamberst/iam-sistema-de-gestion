"use strict";(()=>{var e={};e.id=2608,e.ids=[2608],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},44117:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>E,originalPathname:()=>R,patchFetch:()=>O,requestAsyncStorage:()=>g,routeModule:()=>T,serverHooks:()=>L,staticGenerationAsyncStorage:()=>C,staticGenerationBailout:()=>D});var o={};r.r(o),r.d(o,{GET:()=>p,POST:()=>m,PUT:()=>A,dynamic:()=>c});var s=r(95419),a=r(69108),n=r(99678),l=r(78070),i=r(72964),d=r(13532);let c="force-dynamic",u=(0,i.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e){let{searchParams:t}=new URL(e.url),r=t.get("modelId"),o=t.get("periodDate")||(0,d.iR)();if(!r)return l.Z.json({success:!1,error:"modelId es requerido"},{status:400});try{console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Obteniendo totales:",{modelId:r,periodDate:o});let{data:e,error:t}=await u.from("calculator_totals").select("*").eq("model_id",r).eq("period_date",o).single();if(t&&"PGRST116"!==t.code)return console.error("❌ [CALCULATOR-TOTALS] Error al obtener totales:",t),l.Z.json({success:!1,error:t.message},{status:500});return console.log("✅ [CALCULATOR-TOTALS] Totales obtenidos:",e),l.Z.json({success:!0,data:e||null,modelId:r,periodDate:o})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function m(e){try{let{modelId:t,periodDate:r,totalUsdBruto:o,totalUsdModelo:s,totalCopModelo:a}=await e.json();if(!t||void 0===o||void 0===s||void 0===a)return l.Z.json({success:!1,error:"modelId, totalUsdBruto, totalUsdModelo y totalCopModelo son requeridos"},{status:400});console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Guardando totales:",{modelId:t,periodDate:r,totalUsdBruto:o,totalUsdModelo:s,totalCopModelo:a});let n=(0,d.iR)(),{data:i,error:c}=await u.from("calculator_totals").upsert({model_id:t,period_date:n,total_usd_bruto:Number.parseFloat(String(o))||0,total_usd_modelo:Number.parseFloat(String(s))||0,total_cop_modelo:Number.parseFloat(String(a))||0,updated_at:new Date().toISOString()},{onConflict:"model_id,period_date"}).select();if(c)return console.error("❌ [CALCULATOR-TOTALS] Error al guardar totales:",c),l.Z.json({success:!1,error:c.message},{status:500});return console.log("✅ [CALCULATOR-TOTALS] Totales guardados:",i),l.Z.json({success:!0,data:i?.[0]||null,message:"Totales guardados correctamente",periodDate:n})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}async function A(e){let{searchParams:t}=new URL(e.url),r=t.get("modelIds")?.split(",")||[],o=t.get("periodDate")||(0,d.iR)();if(0===r.length)return l.Z.json({success:!1,error:"modelIds es requerido"},{status:400});try{console.log("\uD83D\uDD0D [CALCULATOR-TOTALS] Obteniendo totales m\xfaltiples:",{modelIds:r,periodDate:o});let{data:e,error:t}=await u.from("calculator_totals").select(`
        *,
        users!inner(email, name)
      `).in("model_id",r).eq("period_date",o);if(t)return console.error("❌ [CALCULATOR-TOTALS] Error al obtener totales m\xfaltiples:",t),l.Z.json({success:!1,error:t.message},{status:500});return console.log("✅ [CALCULATOR-TOTALS] Totales m\xfaltiples obtenidos:",e?.length||0),l.Z.json({success:!0,data:e||[],count:e?.length||0,periodDate:o})}catch(e){return console.error("❌ [CALCULATOR-TOTALS] Error:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let T=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/calculator/totals/route",pathname:"/api/calculator/totals",filename:"route",bundlePath:"app/api/calculator/totals/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\totals\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:C,serverHooks:L,headerHooks:E,staticGenerationBailout:D}=T,R="/api/calculator/totals/route";function O(){return(0,n.patchFetch)({serverHooks:L,staticGenerationAsyncStorage:C})}},13532:(e,t,r)=>{r.d(t,{LQ:()=>n,iR:()=>s,t2:()=>l,wU:()=>i});let o=()=>(console.warn("⚠️ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),s()),s=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),n=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},l=()=>{let e=new Date;return e.setDate(e.getDate()+1),a(e)},i=async e=>{let{createClient:t}=await r.e(2964).then(r.bind(r,72964)),s=t("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),a=e||o();try{let{data:e,error:t}=await s.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",a).eq("end_date",a).eq("is_active",!0).single();if(t&&"PGRST116"!==t.code)throw console.error("❌ [CREATE-PERIOD] Error verificando per\xedodo:",t),t;if(e)return console.log("✅ [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",a);let{data:r,error:o}=await s.from("periods").insert({name:`Per\xedodo ${a}`,start_date:a,end_date:a,is_active:!0}).select().single();if(o)throw console.error("❌ [CREATE-PERIOD] Error creando per\xedodo:",o),o;return console.log("✅ [CREATE-PERIOD] Per\xedodo creado exitosamente:",r),r}catch(e){throw console.error("❌ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2964],()=>r(44117));module.exports=o})();