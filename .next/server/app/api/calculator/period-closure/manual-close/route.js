"use strict";(()=>{var e={};e.id=2438,e.ids=[2438],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},7093:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>D,originalPathname:()=>v,patchFetch:()=>T,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{POST:()=>g});var i=r(95419),o=r(69108),s=r(99678),n=r(78070),u=r(72964),l=r(18539),c=r(1065);let d={pending:["early_freezing","closing_calculators","failed"],early_freezing:["closing_calculators","failed"],closing_calculators:["waiting_summary","failed"],waiting_summary:["closing_summary","failed"],closing_summary:["archiving","failed"],archiving:["completed","failed"],completed:[],failed:["pending"]},p=(e,t)=>d[e]?.includes(t)||!1,m=(0,u.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function g(e){try{let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return n.Z.json({success:!1,error:"Token de autorizaci\xf3n requerido"},{status:401});let r=t.split(" ")[1],{data:{user:a},error:i}=await m.auth.getUser(r);if(i||!a)return n.Z.json({success:!1,error:"Token inv\xe1lido"},{status:401});let{data:o}=await m.from("users").select("role").eq("id",a.id).single();if(!o||"admin"!==o.role&&"super_admin"!==o.role)return n.Z.json({success:!1,error:"No tienes permisos para realizar cierre manual"},{status:403});let{periodDate:s,targetStatus:u,force:d}=await e.json();if(!s||!u)return n.Z.json({success:!1,error:"periodDate y targetStatus son requeridos"},{status:400});let g=s||(0,l.iR)(),y=(0,l.im)(),{data:f}=await m.from("calculator_period_closure_status").select("*").eq("period_date",g).order("created_at",{ascending:!1}).limit(1).single();if(f&&!d&&!p(f.status,u))return n.Z.json({success:!1,error:`Transici\xf3n inv\xe1lida: ${f.status} -> ${u}`,current_status:f.status,valid_next:["pending","early_freezing","closing_calculators","waiting_summary","closing_summary","archiving","completed","failed"]},{status:400});return await (0,c.H4)(g,y,u,{manual_closure:!0,executed_by:a.id,executed_at:new Date().toISOString(),previous_status:f?.status||null}),console.log(`✅ [MANUAL-CLOSE] Estado actualizado manualmente: ${f?.status||"none"} -> ${u}`),n.Z.json({success:!0,message:"Estado actualizado manualmente",period_date:g,period_type:y,previous_status:f?.status||null,new_status:u,executed_by:a.id})}catch(e){return console.error("❌ [MANUAL-CLOSE] Error:",e),n.Z.json({success:!1,error:"Error interno del servidor",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/calculator/period-closure/manual-close/route",pathname:"/api/calculator/period-closure/manual-close",filename:"route",bundlePath:"app/api/calculator/period-closure/manual-close/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\manual-close\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:_,headerHooks:D,staticGenerationBailout:w}=y,v="/api/calculator/period-closure/manual-close/route";function T(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},18539:(e,t,r)=>{r.d(t,{Bm:()=>i,Ck:()=>p,UX:()=>m,Y:()=>n,a9:()=>s,g5:()=>u,iR:()=>a,im:()=>l,ns:()=>d,o8:()=>o,sF:()=>c});let a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),i=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),o=e=>{let t=e||new Date,r=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),a=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(t),i={};a.forEach(e=>{"literal"!==e.type&&(i[e.type]=e.value)});let o=new Date(`${i.year}-${i.month}-${i.day}T00:00:00Z`),s=null;for(let e of[1,2]){let t=new Date(o.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(t)){s=t;break}}s||(s=new Date(o.getTime()-54e5));let n=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(s),u={};return n.forEach(e=>{"literal"!==e.type&&(u[e.type]=e.value)}),{colombiaTime:`${u.hour}:${u.minute}:${u.second}`||"00:00:00",colombiaDate:`${u.year}-${u.month}-${u.day}`,colombiaDateTime:s,europeDate:r}},s=()=>{let e=new Date,t=i(),r=o(e),[a,s]=t.split(" ")[1]?.split(":")||["00","00"],[n,u]=r.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(a)+parseInt(s)-(60*parseInt(n)+parseInt(u)))},n=()=>{let e=i(),[t,r]=e.split(" ")[1]?.split(":")||["00","00"],a=parseInt(t),o=parseInt(r);return 0===a&&o>=0&&o<=15},u=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],l=()=>{let e=parseInt(a().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=a(),[t,r,i]=e.split("-").map(Number);if(1===i){let e=1===r?12:r-1,a=1===r?t-1:t;return new Date(a,e,0).getDate(),{periodDate:`${a}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===i?{periodDate:`${t}-${String(r).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:i<=15?"1-15":"16-31"}},d=()=>{let e=a(),[t,r,i]=e.split("-").map(Number);return 1===i?{periodDate:e,periodType:"1-15"}:16===i?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:i<=15?"1-15":"16-31"}},p=()=>{let e=parseInt(a().split("-")[2]);return 1===e||16===e},m=()=>{let[e,t,r]=a().split("-").map(Number);return 15===r||r===new Date(e,t,0).getDate()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,2964,1065],()=>r(7093));module.exports=a})();