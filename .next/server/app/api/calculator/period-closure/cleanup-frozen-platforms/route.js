"use strict";(()=>{var e={};e.id=9147,e.ids=[9147],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},67818:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>y,patchFetch:()=>D,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>E});var o={};r.r(o),r.d(o,{GET:()=>u,POST:()=>c});var a=r(95419),i=r(69108),s=r(99678),l=r(78070),n=r(72964),d=r(18539);let p=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("modelId"),o="true"===t.get("force"),a=e.headers.get("x-cleanup-secret"),i=process.env.CRON_SECRET_KEY||"cron-secret";if(a!==i)return l.Z.json({success:!1,error:"No autorizado"},{status:401});let s=(0,d.iR)(),n=parseInt(s.split("-")[2]),[c,u]=s.split("-"),m=n<=15?`${c}-${u}-01`:`${c}-${u}-16`;console.log("\uD83E\uDDF9 [CLEANUP-FROZEN] Iniciando limpieza de plataformas congeladas...",{modelId:r?.substring(0,8),currentPeriodDate:m,forceCleanup:o});let g=0;if(r){if(o){let{data:e,error:t}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",r).select();if(t)return console.error("❌ [CLEANUP-FROZEN] Error en limpieza forzada:",t),l.Z.json({success:!1,error:t.message},{status:500});g=e?.length||0,console.log(`✅ [CLEANUP-FROZEN] Limpieza forzada: ${g} registros eliminados para modelo ${r.substring(0,8)}`)}else{let{data:e}=await p.from("calculator_period_closure_status").select("period_date").eq("status","completed");if(e&&e.length>0){let t=e.map(e=>e.period_date),{data:o,error:a}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",r).in("period_date",t).select();a||(g+=o?.length||0,console.log(`✅ [CLEANUP-FROZEN] Eliminados ${o?.length||0} registros de per\xedodos cerrados`))}let{data:t,error:o}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",r).neq("period_date",m).select();o||(g+=t?.length||0,console.log(`✅ [CLEANUP-FROZEN] Eliminados ${t?.length||0} registros fuera del per\xedodo actual`))}}else{let{data:e}=await p.from("calculator_period_closure_status").select("period_date").eq("status","completed");if(e&&e.length>0){let t=e.map(e=>e.period_date),{data:r,error:o}=await p.from("calculator_early_frozen_platforms").delete().in("period_date",t).select();o||(g=r?.length||0,console.log(`✅ [CLEANUP-FROZEN] Eliminados ${g} registros de per\xedodos cerrados (todos los modelos)`))}}return l.Z.json({success:!0,deleted_count:g,current_period_date:m,message:`Limpieza completada: ${g} registros eliminados`})}catch(e){return console.error("❌ [CLEANUP-FROZEN] Error:",e),l.Z.json({success:!1,error:e instanceof Error?e.message:"Error desconocido"},{status:500})}}async function u(e){try{let{searchParams:t}=new URL(e.url),r=t.get("modelId"),o=(0,d.iR)(),a=parseInt(o.split("-")[2]),[i,s]=o.split("-"),n=a<=15?`${i}-${s}-01`:`${i}-${s}-16`,c=p.from("calculator_early_frozen_platforms").select("period_date, platform_id, model_id, frozen_at").order("frozen_at",{ascending:!1}).limit(100);r&&(c=c.eq("model_id",r));let{data:u,error:m}=await c;if(m)return l.Z.json({success:!1,error:m.message},{status:500});let g=new Map;u?.forEach(e=>{let t=e.period_date;g.has(t)||g.set(t,[]),g.get(t).push(e)});let{data:f}=await p.from("calculator_period_closure_status").select("period_date, period_type, status").eq("status","completed");return l.Z.json({success:!0,current_period_date:n,total_records:u?.length||0,records_by_period:Object.fromEntries(g),closed_periods:f||[],records_in_closed_periods:u?.filter(e=>f?.some(t=>t.period_date===e.period_date)).length||0})}catch(e){return console.error("❌ [CLEANUP-FROZEN] Error:",e),l.Z.json({success:!1,error:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/cleanup-frozen-platforms/route",pathname:"/api/calculator/period-closure/cleanup-frozen-platforms",filename:"route",bundlePath:"app/api/calculator/period-closure/cleanup-frozen-platforms/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\cleanup-frozen-platforms\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:_,headerHooks:h,staticGenerationBailout:E}=m,y="/api/calculator/period-closure/cleanup-frozen-platforms/route";function D(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:f})}},18539:(e,t,r)=>{r.d(t,{Bm:()=>a,Ck:()=>u,UX:()=>m,Y:()=>l,a9:()=>s,g5:()=>n,iR:()=>o,im:()=>d,ns:()=>c,o8:()=>i,sF:()=>p});let o=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let t=e||new Date,r=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(t),o=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(t),a={};o.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),s=null;for(let e of[1,2]){let t=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(t)){s=t;break}}s||(s=new Date(i.getTime()-54e5));let l=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(s),n={};return l.forEach(e=>{"literal"!==e.type&&(n[e.type]=e.value)}),{colombiaTime:`${n.hour}:${n.minute}:${n.second}`||"00:00:00",colombiaDate:`${n.year}-${n.month}-${n.day}`,colombiaDateTime:s,europeDate:r}},s=()=>{let e=new Date,t=a(),r=i(e),[o,s]=t.split(" ")[1]?.split(":")||["00","00"],[l,n]=r.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(o)+parseInt(s)-(60*parseInt(l)+parseInt(n)))},l=()=>{let e=a(),[t,r]=e.split(" ")[1]?.split(":")||["00","00"],o=parseInt(t),i=parseInt(r);return 0===o&&i>=0&&i<=15},n=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],d=()=>{let e=parseInt(o().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},p=()=>{let e=o(),[t,r,a]=e.split("-").map(Number);if(1===a){let e=1===r?12:r-1,o=1===r?t-1:t;return new Date(o,e,0).getDate(),{periodDate:`${o}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${t}-${String(r).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},c=()=>{let e=o(),[t,r,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},u=()=>{let e=parseInt(o().split("-")[2]);return 1===e||16===e},m=()=>{let[e,t,r]=o().split("-").map(Number);return 15===r||r===new Date(e,t,0).getDate()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2964],()=>r(67818));module.exports=o})();