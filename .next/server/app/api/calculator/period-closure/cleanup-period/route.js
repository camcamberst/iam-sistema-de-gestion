"use strict";(()=>{var e={};e.id=4707,e.ids=[4707],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},84780:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>P,originalPathname:()=>T,patchFetch:()=>O,requestAsyncStorage:()=>v,routeModule:()=>D,serverHooks:()=>I,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>A});var t={};o.r(t),o.d(t,{GET:()=>y,POST:()=>_,dynamic:()=>c,maxDuration:()=>p});var a=o(95419),i=o(69108),s=o(99678),l=o(78070),n=o(72964),d=o(18539);let c="force-dynamic",p=300,u=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function _(e){let r=Date.now(),o=null,t=null,a=null;try{let i=await e.json(),s=i.userId,n=i.groupId;if(a=s,!s)return l.Z.json({success:!1,error:"userId es requerido"},{status:400});let{data:c,error:p}=await u.from("users").select("id, email, name, role, affiliate_studio_id, groups:user_groups(group_id)").eq("id",s).single();if(p||!c)return l.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if(!["super_admin","admin","superadmin_aff","admin_aff"].includes(c.role))return l.Z.json({success:!1,error:"No tienes permisos para ejecutar esta operaci\xf3n"},{status:403});if(console.log(`ðŸ§¹ [CLEANUP-PERIOD] Iniciando limpieza por ${c.email} (${c.role})`),!(0,d.Ck)())return l.Z.json({success:!1,error:"Solo se puede limpiar en d\xedas 1 o 16"},{status:400});let _=(0,d.sF)(),y=(0,d.ns)();console.log(`ðŸ“… [CLEANUP-PERIOD] Per\xedodo a limpiar:`,_),console.log(`ðŸ†• [CLEANUP-PERIOD] Nuevo per\xedodo:`,y);let D=await m(_.periodDate,_.periodType,c);if(!D.valid)return l.Z.json({success:!1,error:"Validaci\xf3n fallida: No se puede ejecutar la limpieza",validation_errors:D.errors},{status:400});console.log(`âœ… [CLEANUP-PERIOD] Validaciones pasadas:`,D.stats);let{data:v}=await u.rpc("acquire_period_closure_lock",{p_period_date:_.periodDate,p_period_type:_.periodType,p_operation_type:"cleanup",p_user_id:s,p_user_email:c.email,p_user_name:c.name||c.email});if(!v||!v.success)return l.Z.json({success:!1,error:"El proceso de limpieza ya est\xe1 en ejecuci\xf3n",locked_by:v?.locked_by,locked_at:v?.locked_at},{status:409});o=v.lock_id,console.log(`ðŸ”’ [CLEANUP-PERIOD] Lock adquirido: ${o}`),t=crypto.randomUUID(),await u.from("period_closure_audit_log").insert({operation_type:"cleanup_start",period_date:_.periodDate,period_type:_.periodType,batch_id:t,user_id:s,user_email:c.email,user_role:c.role,user_group_id:n,status:"success",details:{action:"Iniciando limpieza de per\xedodo",lock_id:o,validation_stats:D.stats}}),console.log(`ðŸ“¦ [CLEANUP-PERIOD] Moviendo datos a archivo...`);let w=await g(_.periodDate,_.periodType,t,s);console.log(`âœ… [CLEANUP-PERIOD] ${w} registros movidos a archived_model_values`),console.log(`ðŸ”„ [CLEANUP-PERIOD] Reseteando totales...`);let I=await h(_.periodDate);console.log(`âœ… [CLEANUP-PERIOD] ${I} totales reseteados`),console.log(`ðŸ”“ [CLEANUP-PERIOD] Descongelando calculadoras...`),await f(),console.log(`âœ… [CLEANUP-PERIOD] Calculadoras descongeladas`),await u.from("calculator_period_closure_status").update({status:"completed",completed_at:new Date().toISOString()}).eq("period_date",_.periodDate).eq("period_type",_.periodType),console.log(`ðŸ“¢ [CLEANUP-PERIOD] Creando anuncio de nuevo per\xedodo...`),await E(_,y,s,c.email);let P=Date.now()-r;return await u.from("period_closure_audit_log").insert({operation_type:"cleanup_complete",period_date:_.periodDate,period_type:_.periodType,batch_id:t,user_id:s,user_email:c.email,user_role:c.role,user_group_id:n,status:"success",records_affected:w,execution_time_ms:P,details:{records_archived:w,totals_reset:I,new_period:y}}),await u.rpc("release_period_closure_lock",{p_lock_id:o,p_status:"completed"}),console.log(`âœ… [CLEANUP-PERIOD] Limpieza completada exitosamente`),l.Z.json({success:!0,records_archived:w,totals_reset:I,calculators_unfrozen:!0,execution_time_ms:P})}catch(e){return console.error("âŒ [CLEANUP-PERIOD] Error:",e),o&&await u.rpc("release_period_closure_lock",{p_lock_id:o,p_status:"failed",p_failure_reason:e.message}),t&&a&&await u.from("period_closure_audit_log").insert({operation_type:"cleanup_error",period_date:(0,d.sF)().periodDate,period_type:(0,d.sF)().periodType,batch_id:t,user_id:a,status:"failed",error_message:e.message,execution_time_ms:Date.now()-r}),l.Z.json({success:!1,error:e.message},{status:500})}}async function m(e,r,o){let t=[];try{let{data:r,error:o}=await u.from("calculator_history").select("model_id, platform_id").eq("period_date",e);if(o)return t.push(`Error verificando historial: ${o.message}`),{valid:!1,errors:t};if(!r||0===r.length)return t.push("âŒ NO SE HA EJECUTADO EL ARCHIVADO. Debes crear el archivo hist\xf3rico primero."),{valid:!1,errors:t};let{data:a,error:i}=await u.from("calc_snapshots").select("id").eq("period_date",e).single();i&&"PGRST116"!==i.code&&t.push(`Error verificando snapshot: ${i.message}`),a||t.push("âš ï¸ NO EXISTE BACKUP DE SEGURIDAD. Es recomendable tener un snapshot.");let s=new Set(r.filter(e=>"__CONSOLIDATED_TOTAL__"!==e.platform_id).map(e=>e.model_id)),{data:l,error:n}=await u.from("model_values").select("model_id, platform_id").eq("period_date",e);if(n)return t.push(`Error obteniendo valores actuales: ${n.message}`),{valid:!1,errors:t};let d=new Set(l?.map(e=>e.model_id)||[]),c=[];for(let e of d)s.has(e)||c.push(e);c.length>0&&t.push(`âŒ HAY ${c.length} MODELOS CON VALORES QUE NO EST\xc1N EN EL HISTORIAL. El archivado est\xe1 incompleto.`);let{data:p}=await u.rpc("calculate_period_totals",{p_period_date:e}),{data:_}=await u.from("calculator_history").select("model_id, value").eq("period_date",e).eq("platform_id","__CONSOLIDATED_TOTAL__");p&&_&&_.length>0&&console.log(`  â„¹ï¸ Verificaci\xf3n de totales: ${_.length} consolidados en historial`);let{data:m}=await u.from("period_closure_locks").select("operation_type, locked_by, admin_email").eq("period_date",e).eq("status","active").single();m&&"archive"===m.operation_type&&t.push(`âŒ HAY UN PROCESO DE ARCHIVADO EN EJECUCI\xd3N por ${m.admin_email}. Espera a que termine.`);let g={models_in_history:s.size,models_with_values:d.size,total_records_in_history:r.length,total_records_in_values:l?.length||0};if(t.length>0)return{valid:!1,errors:t,stats:g};return{valid:!0,errors:[],stats:g}}catch(e){return t.push(`Error en validaci\xf3n: ${e.message}`),{valid:!1,errors:t}}}async function g(e,r,o,t){try{let{data:a,error:i}=await u.from("model_values").select("*").eq("period_date",e);if(i)throw Error(`Error obteniendo valores: ${i.message}`);if(!a||0===a.length)return console.log(`  â„¹ï¸ No hay valores para archivar`),0;let[s,l]=e.split("-").map(Number),n=a.map(e=>({id:e.id,model_id:e.model_id,platform_id:e.platform_id,value:e.value,period_date:e.period_date,created_at:e.created_at,updated_at:e.updated_at,archived_at:new Date().toISOString(),archived_by:t,archive_batch_id:o,period_type:r,period_year:s,period_month:l,original_table:"model_values",archive_reason:"manual_period_closure",can_restore:!0})),{error:d}=await u.from("archived_model_values").insert(n);if(d)throw Error(`Error insertando en archived_model_values: ${d.message}`);let{error:c}=await u.from("model_values").delete().eq("period_date",e);if(c)throw Error(`Error eliminando de model_values: ${c.message}`);return console.log(`  âœ… ${a.length} registros movidos a archived_model_values`),a.length}catch(e){throw console.error(`  âŒ Error en softDeleteModelValues: ${e.message}`),e}}async function h(e){try{let{data:r,error:o}=await u.from("calculator_totals").select("id").eq("period_date",e);if(o)throw Error(`Error obteniendo totales: ${o.message}`);if(!r||0===r.length)return console.log(`  â„¹ï¸ No hay totales para resetear`),0;let{error:t}=await u.from("calculator_totals").delete().eq("period_date",e);if(t)throw Error(`Error eliminando totales: ${t.message}`);return console.log(`  âœ… ${r.length} totales reseteados`),r.length}catch(e){throw console.error(`  âŒ Error en resetCalculatorTotals: ${e.message}`),e}}async function f(){try{let{error:e}=await u.from("calculator_frozen_platforms").delete().neq("id","00000000-0000-0000-0000-000000000000");if(e)throw Error(`Error descongelando: ${e.message}`);let{error:r}=await u.from("calculator_period_closure_status").update({frozen:!1}).eq("frozen",!0);r&&console.warn(`  âš ï¸ Error actualizando estado de cierre: ${r.message}`),console.log(`  âœ… Calculadoras descongeladas`)}catch(e){throw console.error(`  âŒ Error en unfreezeAllCalculators: ${e.message}`),e}}async function E(e,r,o,t){try{let a={title:"\uD83D\uDD04 Nuevo Per\xedodo Iniciado",message:`El per\xedodo ${e.periodType} ha sido cerrado exitosamente. Ya puedes empezar a registrar valores para el per\xedodo ${r.periodType}.`,type:"period_change",priority:"high",created_by:o,metadata:{closed_period:e,new_period:r,closed_by:t,closed_at:new Date().toISOString()}},{error:i}=await u.from("announcements").insert(a);i?console.warn(`  âš ï¸ Error creando anuncio: ${i.message}`):console.log(`  âœ… Anuncio de Botty creado`)}catch(e){console.warn(`  âš ï¸ Error en createPeriodChangeAnnouncement: ${e.message}`)}}async function y(e){try{let{searchParams:r}=new URL(e.url),o=r.get("userId");if(!o)return l.Z.json({success:!1,error:"userId es requerido"},{status:400});let{data:t}=await u.from("users").select("id, email, role, affiliate_studio_id").eq("id",o).single();if(!t)return l.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});let a=(0,d.sF)(),i=await m(a.periodDate,a.periodType,t);return l.Z.json({success:!0,can_cleanup:i.valid,validation_errors:i.errors,stats:i.stats})}catch(e){return console.error("âŒ [CLEANUP-PERIOD] GET Error:",e),l.Z.json({success:!1,error:e.message},{status:500})}}let D=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/cleanup-period/route",pathname:"/api/calculator/period-closure/cleanup-period",filename:"route",bundlePath:"app/api/calculator/period-closure/cleanup-period/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\cleanup-period\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:v,staticGenerationAsyncStorage:w,serverHooks:I,headerHooks:P,staticGenerationBailout:A}=D,T="/api/calculator/period-closure/cleanup-period/route";function O(){return(0,s.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:w})}},18539:(e,r,o)=>{o.d(r,{Bm:()=>a,Ck:()=>u,UX:()=>_,Y:()=>l,a9:()=>s,g5:()=>n,iR:()=>t,im:()=>d,ns:()=>p,o8:()=>i,sF:()=>c});let t=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let r=e||new Date,o=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(r),t=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(r),a={};t.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),s=null;for(let e of[1,2]){let r=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(r)){s=r;break}}s||(s=new Date(i.getTime()-54e5));let l=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(s),n={};return l.forEach(e=>{"literal"!==e.type&&(n[e.type]=e.value)}),{colombiaTime:`${n.hour}:${n.minute}:${n.second}`||"00:00:00",colombiaDate:`${n.year}-${n.month}-${n.day}`,colombiaDateTime:s,europeDate:o}},s=()=>{let e=new Date,r=a(),o=i(e),[t,s]=r.split(" ")[1]?.split(":")||["00","00"],[l,n]=o.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(t)+parseInt(s)-(60*parseInt(l)+parseInt(n)))},l=()=>{let e=a(),[r,o]=e.split(" ")[1]?.split(":")||["00","00"],t=parseInt(r),i=parseInt(o);return 0===t&&i>=0&&i<=15},n=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],d=()=>{let e=parseInt(t().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=t(),[r,o,a]=e.split("-").map(Number);if(1===a){let e=1===o?12:o-1,t=1===o?r-1:r;return new Date(t,e,0).getDate(),{periodDate:`${t}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${r}-${String(o).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},p=()=>{let e=t(),[r,o,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},u=()=>{let e=parseInt(t().split("-")[2]);return 1===e||16===e},_=()=>{let[e,r,o]=t().split("-").map(Number);return 15===o||o===new Date(e,r,0).getDate()}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(84780));module.exports=t})();