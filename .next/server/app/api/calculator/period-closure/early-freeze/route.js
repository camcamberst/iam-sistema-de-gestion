"use strict";(()=>{var e={};e.id=8183,e.ids=[8183],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},90315:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>D,originalPathname:()=>R,patchFetch:()=>T,requestAsyncStorage:()=>g,routeModule:()=>E,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>y});var o={};t.r(o),t.d(o,{POST:()=>m});var a=t(95419),i=t(69108),s=t(99678),n=t(78070),l=t(72964),d=t(18539),c=t(1065),u=t(37863);let p=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function m(e){try{console.log("\uD83D\uDD12 [EARLY-FREEZE] Iniciando congelaci\xf3n anticipada...");let r=(0,d.iR)(),t=(0,d.im)(),o="true"===e.headers.get("x-testing-mode");if(!o&&!(0,d.a9)())return console.log("â° [EARLY-FREEZE] No es momento de congelaci\xf3n anticipada"),n.Z.json({success:!1,error:"No es momento de congelaci\xf3n anticipada (medianoche Europa Central)"},{status:400});o&&console.log("\uD83E\uDDEA [EARLY-FREEZE] MODO TESTING ACTIVADO");let{data:a}=await p.from("calculator_period_closure_status").select("id, status").eq("period_date",r).eq("status","early_freezing").single();if(a)return console.log("âš ï¸ [EARLY-FREEZE] Ya se ejecut\xf3 la congelaci\xf3n hoy"),n.Z.json({success:!0,message:"Congelaci\xf3n anticipada ya ejecutada",already_executed:!0});await (0,c.H4)(r,t,"early_freezing");let{data:i,error:s}=await p.from("users").select("id, email, name").eq("role","modelo").eq("is_active",!0);if(s)return console.error("âŒ [EARLY-FREEZE] Error obteniendo modelos:",s),await (0,c.H4)(r,t,"failed",{error:"Error obteniendo modelos"}),n.Z.json({success:!1,error:"Error obteniendo modelos"},{status:500});console.log(`ðŸ”„ [EARLY-FREEZE] Procesando ${i?.length||0} modelos...`);let l=[],m=0,E=0;for(let e of i||[])try{let t=await (0,c.vk)(r,e.id,d.g5);t.success?(m++,l.push({model_id:e.id,model_email:e.email,status:"success"}),await (0,u.MW)(e.id,"periodo_cerrado","Las plataformas especiales (SUPERFOON, LIVECREATOR, MDH, 777, XMODELS, BIG7, MONDO, VX, BABESTATION, DIRTYFANS) han sido bloqueadas para edici\xf3n. El per\xedodo est\xe1 cerrado para estas plataformas.")):(E++,l.push({model_id:e.id,model_email:e.email,status:"error",error:t.error}))}catch(r){E++,console.error(`âŒ [EARLY-FREEZE] Error procesando modelo ${e.email}:`,r),l.push({model_id:e.id,model_email:e.email,status:"error",error:r instanceof Error?r.message:"Error desconocido"})}return await (0,c.H4)(r,t,"closing_calculators",{models_processed:i?.length||0,success_count:m,error_count:E}),console.log("âœ… [EARLY-FREEZE] Congelaci\xf3n anticipada completada:",{total:i?.length||0,success:m,errors:E}),n.Z.json({success:!0,message:"Congelaci\xf3n anticipada completada",period_date:r,period_type:t,results:{total_models:i?.length||0,successful:m,failed:E},frozen_platforms:d.g5,details:l})}catch(t){console.error("âŒ [EARLY-FREEZE] Error:",t);let e=(0,d.iR)(),r=(0,d.im)();return await (0,c.H4)(e,r,"failed",{error:t instanceof Error?t.message:"Error desconocido"}),n.Z.json({success:!1,error:"Error interno del servidor",details:t instanceof Error?t.message:"Error desconocido"},{status:500})}}let E=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/early-freeze/route",pathname:"/api/calculator/period-closure/early-freeze",filename:"route",bundlePath:"app/api/calculator/period-closure/early-freeze/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\early-freeze\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:D,staticGenerationBailout:y}=E,R="/api/calculator/period-closure/early-freeze/route";function T(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},18539:(e,r,t)=>{t.d(r,{Bm:()=>a,Ck:()=>p,UX:()=>m,Y:()=>n,a9:()=>s,g5:()=>l,iR:()=>o,im:()=>d,ns:()=>u,o8:()=>i,sF:()=>c});let o=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let r=e||new Date,t=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(r),o=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(r),a={};o.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),s=null;for(let e of[1,2]){let r=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(r)){s=r;break}}s||(s=new Date(i.getTime()-54e5));let n=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(s),l={};return n.forEach(e=>{"literal"!==e.type&&(l[e.type]=e.value)}),{colombiaTime:`${l.hour}:${l.minute}:${l.second}`||"00:00:00",colombiaDate:`${l.year}-${l.month}-${l.day}`,colombiaDateTime:s,europeDate:t}},s=()=>{let e=new Date,r=a(),t=i(e),[o,s]=r.split(" ")[1]?.split(":")||["00","00"],[n,l]=t.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(o)+parseInt(s)-(60*parseInt(n)+parseInt(l)))},n=()=>{let e=a(),[r,t]=e.split(" ")[1]?.split(":")||["00","00"],o=parseInt(r),i=parseInt(t);return 0===o&&i>=0&&i<=15},l=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],d=()=>{let e=parseInt(o().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=o(),[r,t,a]=e.split("-").map(Number);if(1===a){let e=1===t?12:t-1,o=1===t?r-1:r;return new Date(o,e,0).getDate(),{periodDate:`${o}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${r}-${String(t).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},u=()=>{let e=o(),[r,t,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},p=()=>{let e=parseInt(o().split("-")[2]);return 1===e||16===e},m=()=>{let[e,r,t]=o().split("-").map(Number);return 15===t||t===new Date(e,r,0).getDate()}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964,7863,1065],()=>t(90315));module.exports=o})();