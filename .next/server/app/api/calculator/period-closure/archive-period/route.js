"use strict";(()=>{var e={};e.id=6809,e.ids=[6809],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},27136:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>E,originalPathname:()=>I,patchFetch:()=>b,requestAsyncStorage:()=>v,routeModule:()=>y,serverHooks:()=>D,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>$});var o={};t.r(o),t.d(o,{GET:()=>f,POST:()=>_,dynamic:()=>c,maxDuration:()=>p});var a=t(95419),i=t(69108),s=t(99678),d=t(78070),l=t(72964),n=t(18539);let c="force-dynamic",p=300,u=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function _(e){let r=Date.now(),t=null,o=null,a=null;try{let i=await e.json(),s=i.userId,l=i.groupId;if(a=s,!s)return d.Z.json({success:!1,error:"userId es requerido"},{status:400});let{data:c,error:p}=await u.from("users").select("id, email, name, role, affiliate_studio_id, groups:user_groups(group_id)").eq("id",s).single();if(p||!c)return d.Z.json({success:!1,error:"Usuario no encontrado"},{status:404});if(!["super_admin","admin","superadmin_aff","admin_aff"].includes(c.role))return d.Z.json({success:!1,error:"No tienes permisos para ejecutar esta operaci\xf3n"},{status:403});if(console.log(`üì¶ [ARCHIVE-PERIOD] Iniciando archivado por ${c.email} (${c.role})`),!(0,n.Ck)())return d.Z.json({success:!1,error:"Solo se puede archivar en d\xedas 1 o 16"},{status:400});let _=(0,n.sF)();console.log(`üìÖ [ARCHIVE-PERIOD] Per\xedodo a cerrar:`,_);let{data:g}=await u.from("calculator_history").select("id").eq("period_date",_.periodDate).limit(1);if(g&&g.length>0)return d.Z.json({success:!1,error:"Ya existe un archivo hist\xf3rico para este per\xedodo"},{status:400});let{data:f}=await u.rpc("acquire_period_closure_lock",{p_period_date:_.periodDate,p_period_type:_.periodType,p_operation_type:"archive",p_user_id:s,p_user_email:c.email,p_user_name:c.name||c.email});if(!f||!f.success)return d.Z.json({success:!1,error:"El proceso de archivado ya est\xe1 en ejecuci\xf3n",locked_by:f?.locked_by,locked_at:f?.locked_at},{status:409});t=f.lock_id,console.log(`üîí [ARCHIVE-PERIOD] Lock adquirido: ${t}`),o=crypto.randomUUID(),await u.from("period_closure_audit_log").insert({operation_type:"archive_start",period_date:_.periodDate,period_type:_.periodType,batch_id:o,user_id:s,user_email:c.email,user_role:c.role,user_group_id:l,status:"success",details:{action:"Iniciando archivado de per\xedodo",lock_id:t}});let y=u.from("users").select("id, name, email, affiliate_studio_id, groups:user_groups(group_id)").eq("role","modelo").eq("active",!0);if("superadmin_aff"===c.role||"admin_aff"===c.role)y=y.eq("affiliate_studio_id",c.affiliate_studio_id);else if("admin"===c.role){let e=c.groups?.map(e=>e.group_id)||[];if(0===e.length)return d.Z.json({success:!1,error:"Admin sin grupos asignados"},{status:403})}let{data:v,error:w}=await y;if(w||!v)throw Error(`Error obteniendo modelos: ${w?.message}`);let D=v;if("admin"===c.role){let e=c.groups?.map(e=>e.group_id)||[];D=v.filter(r=>(r.groups?.map(e=>e.group_id)||[]).some(r=>e.includes(r)))}if(console.log(`üë• [ARCHIVE-PERIOD] ${D.length} modelos a archivar`),0===D.length)return await u.rpc("release_period_closure_lock",{p_lock_id:t,p_status:"completed"}),d.Z.json({success:!0,message:"No hay modelos para archivar",models_archived:0});let E={succeeded:[],failed:[]};for(let e=0;e<D.length;e++){let r=D[e];await u.rpc("update_lock_progress",{p_lock_id:t,p_models_processed:e,p_models_total:D.length});let a=await m(r.id,r.name||r.email,_.periodDate,_.periodType,o,s);a.success?E.succeeded.push(r.id):E.failed.push({model_id:r.id,model_name:r.name||r.email,error:a.error||"Error desconocido",retry_count:a.retry_count||0})}await u.rpc("update_lock_progress",{p_lock_id:t,p_models_processed:D.length,p_models_total:D.length});let $=await h(_.periodDate,_.periodType,o,s),I=Date.now()-r,b=E.failed.length>0,T=E.failed.length===D.length?"failed":b?"partial":"success";await u.from("period_closure_audit_log").insert({operation_type:"archive_complete",period_date:_.periodDate,period_type:_.periodType,batch_id:o,user_id:s,user_email:c.email,user_role:c.role,user_group_id:l,status:T,models_affected:E.succeeded.length,execution_time_ms:I,details:{models_attempted:D.length,models_succeeded:E.succeeded.length,models_failed:E.failed.length,failed_models:E.failed,snapshot_created:$}}),await u.rpc("release_period_closure_lock",{p_lock_id:t,p_status:"failed"===T?"failed":"completed",p_failure_reason:b?`${E.failed.length} modelos fallaron`:null}),console.log(`‚úÖ [ARCHIVE-PERIOD] Completado: ${E.succeeded.length}/${D.length} modelos archivados`);let k={success:!0,batch_id:o,models_archived:E.succeeded.length,snapshot_created:$,execution_time_ms:I};return b&&(k.partial={models_attempted:D.length,models_succeeded:E.succeeded.length,models_failed:E.failed.length,failed_models:E.failed}),d.Z.json(k)}catch(e){return console.error("‚ùå [ARCHIVE-PERIOD] Error:",e),t&&await u.rpc("release_period_closure_lock",{p_lock_id:t,p_status:"failed",p_failure_reason:e.message}),o&&a&&await u.from("period_closure_audit_log").insert({operation_type:"archive_error",period_date:(0,n.sF)().periodDate,period_type:(0,n.sF)().periodType,batch_id:o,user_id:a,status:"failed",error_message:e.message,execution_time_ms:Date.now()-r}),d.Z.json({success:!1,error:e.message},{status:500})}}async function m(e,r,t,o,a,i,s=3){let d="";for(let l=1;l<=s;l++)try{return console.log(`  üìù [${r}] Intento ${l}/${s}...`),await g(e,t,o,a,i),console.log(`  ‚úÖ [${r}] Archivado exitoso`),{success:!0,retry_count:l-1}}catch(e){if(d=e.message,console.error(`  ‚ö†Ô∏è [${r}] Intento ${l} fall\xf3: ${d}`),l===s)return console.error(`  ‚ùå [${r}] Fall\xf3 despu\xe9s de ${s} intentos`),{success:!1,error:d,retry_count:s};await new Promise(e=>setTimeout(e,1e3*Math.pow(2,l-1)))}return{success:!1,error:d,retry_count:s}}async function g(e,r,t,o,a){let{data:i,error:s}=await u.from("model_values").select("*").eq("model_id",e).eq("period_date",r);if(s)throw Error(`Error obteniendo valores: ${s.message}`);if(!i||0===i.length){console.log(`  ‚ÑπÔ∏è Modelo ${e} no tiene valores para archivar`);return}let{data:d,error:l}=await u.from("calculator_totals").select("*").eq("model_id",e).eq("period_date",r).single();if(l&&"PGRST116"!==l.code)throw Error(`Error obteniendo totales: ${l.message}`);let n=i.map(i=>({model_id:e,period_date:r,period_type:t,platform_id:i.platform_id,value:i.value,created_by:a,batch_id:o,metadata:{archived_at:new Date().toISOString(),original_created_at:i.created_at,original_updated_at:i.updated_at}})),{error:c}=await u.from("calculator_history").insert(n);if(c)throw Error(`Error creando historial: ${c.message}`);if(d){let{error:i}=await u.from("calculator_history").insert({model_id:e,period_date:r,period_type:t,platform_id:"__CONSOLIDATED_TOTAL__",value:d.total_usd||0,created_by:a,batch_id:o,metadata:{archived_at:new Date().toISOString(),is_consolidated:!0,...d}});i&&console.warn(`  ‚ö†Ô∏è Error creando total consolidado: ${i.message}`)}console.log(`  ‚úÖ ${i.length} registros archivados para modelo ${e}`)}async function h(e,r,t,o){try{let{data:a,error:i}=await u.from("model_values").select("*").eq("period_date",e);if(i||!a)return console.error(`  ‚ùå Error obteniendo valores para snapshot: ${i?.message}`),!1;let{data:s,error:d}=await u.from("calculator_totals").select("*").eq("period_date",e);d&&console.error(`  ‚ö†Ô∏è Error obteniendo totales para snapshot: ${d.message}`);let{error:l}=await u.from("calc_snapshots").insert({period_date:e,period_type:r,snapshot_data:{values:a,totals:s||[],archived_at:new Date().toISOString(),batch_id:t,created_by:o},created_by:o});if(l)return console.error(`  ‚ùå Error creando snapshot: ${l.message}`),!1;return console.log(`  ‚úÖ Snapshot creado para per\xedodo ${e}`),!0}catch(e){return console.error(`  ‚ùå Error en createPeriodSnapshot: ${e.message}`),!1}}async function f(e){try{let{searchParams:r}=new URL(e.url),t=r.get("periodDate");if(!t)return d.Z.json({success:!1,error:"periodDate es requerido"},{status:400});let{data:o}=await u.from("calculator_history").select("batch_id, created_at").eq("period_date",t).limit(1),{data:a}=await u.from("period_closure_locks").select("*").eq("period_date",t).eq("operation_type","archive").eq("status","active").single(),{data:i}=await u.from("period_closure_audit_log").select("*").eq("period_date",t).in("operation_type",["archive_start","archive_complete","archive_error"]).order("timestamp",{ascending:!1}).limit(1).single();return d.Z.json({success:!0,archived:!!(o&&o.length>0),in_progress:!!a,lock:a,last_log:i})}catch(e){return console.error("‚ùå [ARCHIVE-PERIOD] GET Error:",e),d.Z.json({success:!1,error:e.message},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/archive-period/route",pathname:"/api/calculator/period-closure/archive-period",filename:"route",bundlePath:"app/api/calculator/period-closure/archive-period/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\archive-period\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:v,staticGenerationAsyncStorage:w,serverHooks:D,headerHooks:E,staticGenerationBailout:$}=y,I="/api/calculator/period-closure/archive-period/route";function b(){return(0,s.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:w})}},18539:(e,r,t)=>{t.d(r,{Bm:()=>a,Ck:()=>u,UX:()=>_,Y:()=>d,a9:()=>s,g5:()=>l,iR:()=>o,im:()=>n,ns:()=>p,o8:()=>i,sF:()=>c});let o=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let r=e||new Date,t=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(r),o=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(r),a={};o.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),s=null;for(let e of[1,2]){let r=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(r)){s=r;break}}s||(s=new Date(i.getTime()-54e5));let d=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(s),l={};return d.forEach(e=>{"literal"!==e.type&&(l[e.type]=e.value)}),{colombiaTime:`${l.hour}:${l.minute}:${l.second}`||"00:00:00",colombiaDate:`${l.year}-${l.month}-${l.day}`,colombiaDateTime:s,europeDate:t}},s=()=>{let e=new Date,r=a(),t=i(e),[o,s]=r.split(" ")[1]?.split(":")||["00","00"],[d,l]=t.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(o)+parseInt(s)-(60*parseInt(d)+parseInt(l)))},d=()=>{let e=a(),[r,t]=e.split(" ")[1]?.split(":")||["00","00"],o=parseInt(r),i=parseInt(t);return 0===o&&i>=0&&i<=15},l=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],n=()=>{let e=parseInt(o().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=o(),[r,t,a]=e.split("-").map(Number);if(1===a){let e=1===t?12:t-1,o=1===t?r-1:r;return new Date(o,e,0).getDate(),{periodDate:`${o}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${r}-${String(t).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},p=()=>{let e=o(),[r,t,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},u=()=>{let e=parseInt(o().split("-")[2]);return 1===e||16===e},_=()=>{let[e,r,t]=o().split("-").map(Number);return 15===t||t===new Date(e,r,0).getDate()}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(27136));module.exports=o})();