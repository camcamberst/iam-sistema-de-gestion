"use strict";(()=>{var e={};e.id=2801,e.ids=[2801],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},72627:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>A,patchFetch:()=>D,requestAsyncStorage:()=>g,routeModule:()=>S,serverHooks:()=>$,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>f});var a={};t.r(a),t.d(a,{GET:()=>m,POST:()=>p,dynamic:()=>u});var o=t(95419),i=t(69108),s=t(99678),l=t(78070),d=t(72964),n=t(13532);let u="force-dynamic",c=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function p(e){try{let r,t,a;console.log("\uD83E\uDDF9 [CLEANUP-RESIDUAL] Iniciando limpieza de valores residuales...");let o=e.headers.get("authorization"),i=e.headers.get("x-cron-secret"),s=process.env.CRON_SECRET_KEY||"cron-secret",u=i===s;if(!u&&o)try{let e=o.replace("Bearer ",""),r=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c"),{data:{user:t},error:a}=await r.auth.getUser(e);if(t&&!a){let{data:e}=await c.from("users").select("role").eq("id",t.id).single();e?.role==="super_admin"&&(u=!0,console.log("\uD83D\uDEE1Ô∏è [CLEANUP-RESIDUAL] Super Admin autenticado:",t.email))}}catch(e){console.warn("‚ö†Ô∏è [CLEANUP-RESIDUAL] Error validando auth:",e)}if(!u)return l.Z.json({success:!1,error:"No autorizado"},{status:401});let p=!1,m=!1;try{let r=await e.json();p=!0===r.cleanCurrentPeriod,m=!0===r.cleanAllPeriods}catch(e){}if(m){console.log("\uD83E\uDDF9 [CLEANUP-RESIDUAL] Limpiando TODOS los valores de model_values...");let{data:e,error:r}=await c.from("model_values").delete().neq("model_id","00000000-0000-0000-0000-000000000000").select();if(r)throw r;return l.Z.json({success:!0,message:`Limpieza completa: ${e?.length||0} valores eliminados de TODOS los per\xedodos`,deleted:e?.length||0})}let[S,g,E]=(0,n.iR)().split("-").map(Number);if(p){if(E>=16){r=`${S}-${String(g).padStart(2,"0")}-16`;let e=new Date(S,g,0).getDate();t=`${S}-${String(g).padStart(2,"0")}-${e}`,a="16-31"}else r=`${S}-${String(g).padStart(2,"0")}-01`,t=`${S}-${String(g).padStart(2,"0")}-15`,a="1-15"}else if(E>=16)r=`${S}-${String(g).padStart(2,"0")}-01`,t=`${S}-${String(g).padStart(2,"0")}-15`,a="1-15";else{let e=1===g?12:g-1,o=1===g?S-1:S,i=new Date(o,e,0).getDate();r=`${o}-${String(e).padStart(2,"0")}-16`,t=`${o}-${String(e).padStart(2,"0")}-${i}`,a="16-31"}console.log(`üìÖ [CLEANUP-RESIDUAL] Limpiando per\xedodo ${a}: ${r} a ${t}`);let{data:$,error:h}=await c.from("model_values").select("id, model_id, platform_id, value, period_date").gte("period_date",r).lte("period_date",t);if(h)throw console.error("‚ùå [CLEANUP-RESIDUAL] Error contando valores:",h),h;let f=$?.length||0;if(console.log(`üîç [CLEANUP-RESIDUAL] Encontrados ${f} valores residuales`),0===f)return l.Z.json({success:!0,message:"No hay valores residuales para limpiar",period:{startDate:r,endDate:t,periodType:a},deleted:0});let{data:A,error:D}=await c.from("model_values").delete().gte("period_date",r).lte("period_date",t).select();if(D)throw console.error("‚ùå [CLEANUP-RESIDUAL] Error eliminando valores:",D),D;let _=A?.length||0;console.log(`‚úÖ [CLEANUP-RESIDUAL] Eliminados ${_} valores residuales`);let v={};return A?.forEach(e=>{v[e.model_id]=(v[e.model_id]||0)+1}),l.Z.json({success:!0,message:`Limpieza completada: ${_} valores eliminados del per\xedodo ${p?"ACTUAL":"ANTERIOR"}`,period:{startDate:r,endDate:t,periodType:a,isCurrent:p},deleted:_,models_affected:Object.keys(v).length,summary:v})}catch(e){return console.error("‚ùå [CLEANUP-RESIDUAL] Error:",e),l.Z.json({success:!1,error:e instanceof Error?e.message:"Error interno del servidor"},{status:500})}}async function m(e){try{let e,r,t;let a=(0,n.iR)(),[o,i,s]=a.split("-").map(Number);if(s>=16)e=`${o}-${String(i).padStart(2,"0")}-01`,r=`${o}-${String(i).padStart(2,"0")}-15`,t="1-15";else{let a=1===i?12:i-1,s=1===i?o-1:o,l=new Date(s,a,0).getDate();e=`${s}-${String(a).padStart(2,"0")}-16`,r=`${s}-${String(a).padStart(2,"0")}-${l}`,t="16-31"}let{data:d,error:u}=await c.from("model_values").select("id, model_id, platform_id, value, period_date").gte("period_date",e).lte("period_date",r);if(u)throw u;let p=d?.length||0,m={};return d?.forEach(e=>{m[e.model_id]||(m[e.model_id]={count:0,platforms:[]}),m[e.model_id].count++,m[e.model_id].platforms.includes(e.platform_id)||m[e.model_id].platforms.push(e.platform_id)}),l.Z.json({success:!0,current_date:a,previous_period:{startDate:e,endDate:r,periodType:t},residual_count:p,models_with_residuals:Object.keys(m).length,summary:m})}catch(e){return console.error("‚ùå [CLEANUP-RESIDUAL] Error:",e),l.Z.json({success:!1,error:e instanceof Error?e.message:"Error interno del servidor"},{status:500})}}let S=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/cleanup-residual/route",pathname:"/api/calculator/period-closure/cleanup-residual",filename:"route",bundlePath:"app/api/calculator/period-closure/cleanup-residual/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\cleanup-residual\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:$,headerHooks:h,staticGenerationBailout:f}=S,A="/api/calculator/period-closure/cleanup-residual/route";function D(){return(0,s.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:E})}},13532:(e,r,t)=>{t.d(r,{Bs:()=>i,Jz:()=>o,iR:()=>s,lm:()=>a});let a=()=>{let[e,r,t]=s().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},o=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("‚ö†Ô∏è [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),a();let[r,t,o]=e.split("-").map(Number);if(!r||!t||!o)return a();return`${r}-${String(t).padStart(2,"0")}-${String(o<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("‚ùå [DATE-UTILS] Error normalizando fecha:",e),a()}},i=e=>{try{let[r,t,a]=e.split("-").map(Number),o=a<=15,i=`${r}-${String(t).padStart(2,"0")}-${o?"01":"16"}`,s="";if(o)s=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();s=`${r}-${String(t).padStart(2,"0")}-${e}`}let l=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${o?"1":"2"}`;return{startDate:i,endDate:s,name:l,isP1:o}}catch(r){return console.error("‚ùå [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},s=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(72627));module.exports=a})();