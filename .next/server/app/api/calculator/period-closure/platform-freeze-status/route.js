"use strict";(()=>{var e={};e.id=8545,e.ids=[8545],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},25283:(e,o,t)=>{t.r(o),t.d(o,{headerHooks:()=>f,originalPathname:()=>A,patchFetch:()=>F,requestAsyncStorage:()=>g,routeModule:()=>u,serverHooks:()=>T,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>S});var r={};t.r(r),t.d(r,{GET:()=>m});var a=t(95419),i=t(69108),l=t(99678),s=t(78070),n=t(72964),d=t(18539),c=t(1065);let p=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function m(e){try{let{searchParams:o}=new URL(e.url),t=o.get("modelId"),r=o.get("periodDate")||(0,d.iR)(),a="true"===o.get("forceUnfreeze");if(!t)return s.Z.json({success:!1,error:"modelId es requerido"},{status:400});let i=(0,d.iR)(),l=parseInt(i.split("-")[2]),[n,m]=i.split("-"),u=l<=15?"1-15":"16-31",g=l<=15?`${n}-${m}-01`:`${n}-${m}-16`,E=!1,{data:T}=await p.from("calculator_period_closure_status").select("status").eq("period_date",g).eq("period_type",u).order("created_at",{ascending:!1}).limit(1).single(),f=["completed","closing_calculators","waiting_summary","closing_summary"];if(E=!!T?.status&&f.includes(T.status),l>=16&&!E){let e=`${n}-${m}-01`,o=`${n}-${m}-15`,{data:t}=await p.from("calculator_period_closure_status").select("status, period_date").eq("period_type","1-15").in("period_date",[e,o]).order("created_at",{ascending:!1}).limit(1).single();t?.status&&f.includes(t.status)&&(E=!0,console.log(`‚úÖ [PLATFORM-FREEZE-STATUS] Per\xedodo anterior (1-15, date: ${t.period_date}) est\xe1 cerrado o en proceso (status: ${t.status}). Estamos en per\xedodo nuevo (16-31). No aplicar early freeze.`))}let S=[];E?console.log(`‚úÖ [PLATFORM-FREEZE-STATUS] Per\xedodo ${u} (${g}) ya cerrado. No buscar registros en BD.`):S=await (0,c.Z)(g,t);let A=new Set(S.map(e=>e.toLowerCase())),F=(0,d.Ck)(),R=(0,d.iR)(),h=parseInt(R.split("-")[2]),y=31===h||15===h;E?console.log(`‚úÖ [PLATFORM-FREEZE-STATUS] Per\xedodo ${u} (${g}) ya fue cerrado. No aplicar early freeze.`):console.log(`üìÖ [PLATFORM-FREEZE-STATUS] Per\xedodo ${u} (${g}) a\xfan no ha sido cerrado. Early freeze puede aplicarse.`);try{let{data:e}=await p.from("calculator_period_closure_status").select("period_date").eq("status","completed");if(e&&e.length>0){let o=e.map(e=>e.period_date);console.log(`üßπ [PLATFORM-FREEZE-STATUS] Encontrados ${o.length} per\xedodos cerrados:`,o);let{data:r,error:a}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",t).in("period_date",o).select(),i=r?.length||0;a?console.warn("‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] Error limpiando per\xedodos cerrados:",a):console.log(`üßπ [PLATFORM-FREEZE-STATUS] Limpieza de per\xedodos cerrados: ${i||0} registros eliminados para modelo ${t.substring(0,8)}`)}let{error:o}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",t).neq("period_date",g);if(o?console.warn("‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] Error limpiando registros del per\xedodo actual:",o):console.log(`üßπ [PLATFORM-FREEZE-STATUS] Limpieza de registros fuera del per\xedodo actual completada`),E){let{error:e}=await p.from("calculator_early_frozen_platforms").delete().eq("model_id",t);e?console.warn("‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] Error limpiando todos los registros (per\xedodo cerrado):",e):(console.log(`üßπ [PLATFORM-FREEZE-STATUS] Limpieza completa: per\xedodo cerrado, todos los registros eliminados`),A.clear())}}catch(e){console.warn("‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] Error en limpieza:",e)}if(console.log(`üîç [PLATFORM-FREEZE-STATUS] Verificando early freeze:`,{modelId:t.substring(0,8),periodDateParam:r,currentColombiaDate:i,currentDay:l,currentPeriodDate:g,currentPeriodType:u,isClosureDay:F,isDayBeforeClosure:y,periodAlreadyClosed:E,frozenFromDB:S.length}),(F||y)&&!E&&!a){let e=new Date,o=(0,d.o8)(e),[r,a]=((0,d.Bm)().split(" ")[1]||"00:00:00").split(":").map(Number),[i,l]=o.colombiaTime.split(":").map(Number),s=60*r+a,n=60*i+l,c=(0,d.iR)(),m=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit"}).format(o.colombiaDateTime),u=m>c,g=u||s>=n+5;if(console.log(`üîç [PLATFORM-FREEZE-STATUS] C\xe1lculo de hora:`,{currentTimeColombia:`${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`,currentTimeMinutes:s,targetTimeColombia:`${String(i).padStart(2,"0")}:${String(l).padStart(2,"0")}`,targetTimeMinutes:n,margin:5,nowColombiaDate:c,targetColombiaDate:m,targetIsTomorrow:u,hasPassedEarlyFreeze:g,europeMidnightDate:o.europeDate,europeMidnightColombiaTime:o.colombiaTime}),g?(console.log(`üîí [PLATFORM-FREEZE-STATUS] Early freeze autom\xe1tico activo para modelo ${t.substring(0,8)}...`),console.log(`   Hora Colombia: ${r}:${String(a).padStart(2,"0")}`),console.log(`   Medianoche Europa Central (Colombia): ${i}:${String(l).padStart(2,"0")}`),console.log(`   Agregando ${d.g5.length} plataformas:`,d.g5),d.g5.forEach(e=>{A.add(e.toLowerCase())})):(console.log(`‚è≥ [PLATFORM-FREEZE-STATUS] A\xfan no es hora de early freeze`),u||console.log(`   Falta ${n+5-s} minutos`)),s>=600?(console.log(`üîí [PLATFORM-FREEZE-STATUS] DX Live congelado (10:00 AM Colombia)`),A.add("dxlive")):(console.log(`‚è≥ [PLATFORM-FREEZE-STATUS] DX Live a\xfan no est\xe1 congelado (antes de 10:00 AM Colombia)`),console.log(`   Falta ${600-s} minutos`)),s>=1439){console.log(`üîí [PLATFORM-FREEZE-STATUS] CIERRE TOTAL - Todas las plataformas congeladas (23:59 Colombia)`);try{let{data:e,error:o}=await p.from("platforms").select("id").eq("enabled",!0);if(o){console.error("‚ùå [PLATFORM-FREEZE-STATUS] Error obteniendo plataformas activas:",o);let e=["chaturbate","myfreecams","stripchat","bongacams","cam4","camsoda","flirt4free","streamate","livejasmin","imlive","dxlive","superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"];e.forEach(e=>A.add(e.toLowerCase())),console.warn(`‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] Usando lista fallback de ${e.length} plataformas`)}else{let o=e?.length||0;e?.forEach(e=>{A.add(e.id.toLowerCase())}),console.log(`‚úÖ [PLATFORM-FREEZE-STATUS] ${o} plataformas activas congeladas din\xe1micamente`)}}catch(e){console.error("‚ùå [PLATFORM-FREEZE-STATUS] Error cr\xedtico obteniendo plataformas:",e)}}else{let e=1439-s;e<60&&console.log(`‚è≥ [PLATFORM-FREEZE-STATUS] Faltan ${e} minutos para cierre total (23:59 Colombia)`)}}else console.log(`üìÖ [PLATFORM-FREEZE-STATUS] No es d\xeda de cierre (d\xedas 1, 15, 16 o 31)`);let b=Array.from(A),$=E||a?[]:b;if((E||a)&&b.length>0){let e=E?"per\xedodo cerrado":"descongelamiento forzado";console.warn(`‚ö†Ô∏è [PLATFORM-FREEZE-STATUS] ${e} pero hab\xeda ${b.length} plataformas congeladas. Forzando desbloqueo.`)}return console.log(`‚úÖ [PLATFORM-FREEZE-STATUS] Respuesta final:`,{modelId:t.substring(0,8),frozenPlatformsCount:$.length,frozenPlatforms:$,fromDB:S.length,autoDetected:b.length>S.length,periodClosed:E,forcedUnfreeze:E&&b.length>0}),s.Z.json({success:!0,model_id:t,period_date:g,frozen_platforms:$,is_frozen:$.length>0,auto_detected:b.length>S.length,period_closed:E,force_unfreeze:a,debug:{isClosureDay:F,currentColombiaDate:i,currentDay:l,currentPeriodDate:g,currentPeriodType:u,periodAlreadyClosed:E,frozenFromDB:S.length,frozenAuto:b.length-S.length,finalFrozenCount:$.length,forcedUnfreeze:E&&b.length>0}})}catch(e){return console.error("‚ùå [PLATFORM-FREEZE-STATUS] Error:",e),s.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/platform-freeze-status/route",pathname:"/api/calculator/period-closure/platform-freeze-status",filename:"route",bundlePath:"app/api/calculator/period-closure/platform-freeze-status/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\platform-freeze-status\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:T,headerHooks:f,staticGenerationBailout:S}=u,A="/api/calculator/period-closure/platform-freeze-status/route";function F(){return(0,l.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:E})}},18539:(e,o,t)=>{t.d(o,{Bm:()=>a,Ck:()=>m,UX:()=>u,Y:()=>s,a9:()=>l,g5:()=>n,iR:()=>r,im:()=>d,ns:()=>p,o8:()=>i,sF:()=>c});let r=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let o=e||new Date,t=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(o),r=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(o),a={};r.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),l=null;for(let e of[1,2]){let o=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(o)){l=o;break}}l||(l=new Date(i.getTime()-54e5));let s=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(l),n={};return s.forEach(e=>{"literal"!==e.type&&(n[e.type]=e.value)}),{colombiaTime:`${n.hour}:${n.minute}:${n.second}`||"00:00:00",colombiaDate:`${n.year}-${n.month}-${n.day}`,colombiaDateTime:l,europeDate:t}},l=()=>{let e=new Date,o=a(),t=i(e),[r,l]=o.split(" ")[1]?.split(":")||["00","00"],[s,n]=t.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(r)+parseInt(l)-(60*parseInt(s)+parseInt(n)))},s=()=>{let e=a(),[o,t]=e.split(" ")[1]?.split(":")||["00","00"],r=parseInt(o),i=parseInt(t);return 0===r&&i>=0&&i<=15},n=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],d=()=>{let e=parseInt(r().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=r(),[o,t,a]=e.split("-").map(Number);if(1===a){let e=1===t?12:t-1,r=1===t?o-1:o;return new Date(r,e,0).getDate(),{periodDate:`${r}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${o}-${String(t).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},p=()=>{let e=r(),[o,t,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},m=()=>{let e=parseInt(r().split("-")[2]);return 1===e||16===e},u=()=>{let[e,o,t]=r().split("-").map(Number);return 15===t||t===new Date(e,o,0).getDate()}}};var o=require("../../../../../webpack-runtime.js");o.C(e);var t=e=>o(o.s=e),r=o.X(0,[1638,6206,2964,1065],()=>t(25283));module.exports=r})();