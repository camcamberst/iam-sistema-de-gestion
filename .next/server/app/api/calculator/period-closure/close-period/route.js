"use strict";(()=>{var e={};e.id=2031,e.ids=[2031],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},157:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>y,originalPathname:()=>$,patchFetch:()=>C,requestAsyncStorage:()=>S,routeModule:()=>O,serverHooks:()=>L,staticGenerationAsyncStorage:()=>v,staticGenerationBailout:()=>w});var t={};r.r(t),r.d(t,{POST:()=>D});var a=r(95419),i=r(69108),l=r(99678),s=r(78070),d=r(72964),n=r(18539),c=r(1065),u=r(37863);let p=process.env.SUPABASE_SERVICE_ROLE_KEY,m=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",p);async function _(e,o,r,t){try{let{data:a,error:i}=await m.from("affiliate_studios").select("id, name, commission_percentage").eq("id",e).single();if(i||!a)return console.error("âŒ [AFFILIATE-BILLING] Error obteniendo estudio:",i),null;let l=new Date(o),s=l.getFullYear(),d=l.getMonth(),n=new Date(s,d+1,0).getDate(),c="P1"===r?`${s}-${String(d+1).padStart(2,"0")}-01`:`${s}-${String(d+1).padStart(2,"0")}-16`,u="P1"===r?`${s}-${String(d+1).padStart(2,"0")}-15`:`${s}-${String(d+1).padStart(2,"0")}-${String(n).padStart(2,"0")}`,{data:p,error:_}=await m.from("users").select("id").eq("affiliate_studio_id",e).eq("role","modelo").eq("is_active",!0);if(_)return console.error("âŒ [AFFILIATE-BILLING] Error obteniendo modelos:",_),null;let f=p?.map(e=>e.id)||[];if(0===f.length)return{affiliate_studio_id:e,affiliate_name:a.name,commission_percentage:a.commission_percentage,period_date:o,period_type:r,total_usd_bruto:0,total_usd_affiliate:0,total_usd_innova:0,total_cop_affiliate:0,total_cop_innova:0,models_count:0,sedes_count:0,usd_cop_rate:t||3900};let E=new Date().toISOString().split("T")[0],g=E>=c&&E<=u,h=0,I=0;if(g){let{data:o,error:r}=await m.from("calculator_totals").select("model_id, total_usd_bruto, total_usd_modelo, updated_at").in("model_id",f).eq("affiliate_studio_id",e).gte("period_date",c).lte("period_date",u);if(r)console.error("âŒ [AFFILIATE-BILLING] Error obteniendo totales:",r);else if(o&&o.length>0){let e=new Map;o.forEach(o=>{let r=e.get(o.model_id);(!r||new Date(o.updated_at)>new Date(r.updated_at))&&e.set(o.model_id,o)}),e.forEach(e=>{h+=parseFloat(e.total_usd_bruto||0),I+=parseFloat(e.total_usd_modelo||0)})}}else{let{data:t,error:a}=await m.from("calculator_history").select("model_id, value_usd_bruto, value_usd_modelo").in("model_id",f).eq("affiliate_studio_id",e).eq("period_date",o).eq("period_type","P1"===r?"1-15":"16-31");if(a)console.error("âŒ [AFFILIATE-BILLING] Error obteniendo historial:",a);else if(t&&t.length>0){let e=new Map;t.forEach(o=>{let r=e.get(o.model_id);r?(r.usd_bruto+=parseFloat(o.value_usd_bruto||0),r.usd_modelo+=parseFloat(o.value_usd_modelo||0)):e.set(o.model_id,{usd_bruto:parseFloat(o.value_usd_bruto||0),usd_modelo:parseFloat(o.value_usd_modelo||0)})}),e.forEach(e=>{h+=e.usd_bruto,I+=e.usd_modelo})}}let D=t;if(!D){let{data:e}=await m.from("rates").select("value").eq("kind","USDâ†’COP").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}).limit(1).single();D=e?.value?parseFloat(e.value):3900}let O=parseFloat(a.commission_percentage)||10,S=O/100*h,v=h-S,L=Math.round(S*D),y=Math.round(v*D),{count:w}=await m.from("groups").select("*",{count:"exact",head:!0}).eq("affiliate_studio_id",e);return{affiliate_studio_id:e,affiliate_name:a.name,commission_percentage:O,period_date:o,period_type:r,total_usd_bruto:Math.round(100*h)/100,total_usd_affiliate:Math.round(100*v)/100,total_usd_innova:Math.round(100*S)/100,total_cop_affiliate:y,total_cop_innova:L,models_count:f.length,sedes_count:w||0,usd_cop_rate:D}}catch(e){return console.error("âŒ [AFFILIATE-BILLING] Error calculando facturaci\xf3n:",e),null}}async function f(e){try{let{error:o}=await m.from("affiliate_billing_summary").upsert({affiliate_studio_id:e.affiliate_studio_id,period_date:e.period_date,period_type:e.period_type,total_usd_bruto:e.total_usd_bruto,total_usd_affiliate:e.total_usd_affiliate,total_usd_innova:e.total_usd_innova,total_cop_affiliate:e.total_cop_affiliate,total_cop_innova:e.total_cop_innova,models_count:e.models_count,sedes_count:e.sedes_count},{onConflict:"affiliate_studio_id,period_date,period_type"});if(o)return console.error("âŒ [AFFILIATE-BILLING] Error guardando resumen:",o),!1;return!0}catch(e){return console.error("âŒ [AFFILIATE-BILLING] Error:",e),!1}}async function E(e,o,r){try{let{data:t,error:a}=await m.from("affiliate_studios").select("id").eq("is_active",!0);if(a||!t||0===t.length)return console.log("â„¹ï¸ [AFFILIATE-BILLING] No hay estudios afiliados activos"),{success:0,errors:0};let i=0,l=0;for(let a of t){let t=await _(a.id,e,o,r);t?await f(t)?(i++,console.log(`âœ… [AFFILIATE-BILLING] Facturaci\xf3n calculada para ${t.affiliate_name}`)):(l++,console.error(`âŒ [AFFILIATE-BILLING] Error guardando facturaci\xf3n para ${a.id}`)):(l++,console.error(`âŒ [AFFILIATE-BILLING] Error calculando facturaci\xf3n para ${a.id}`))}return{success:i,errors:l}}catch(e){return console.error("âŒ [AFFILIATE-BILLING] Error:",e),{success:0,errors:1}}}let g=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),h=e=>String(e).padStart(2,"0"),I=(e,o)=>{let[r,t]=e.split("-"),a=Number(r),i=Number(t);if(!Number.isFinite(a)||!Number.isFinite(i))return console.warn("âš ï¸ [CLOSE-PERIOD] No se pudo interpretar periodDate forzado, usando c\xe1lculo predeterminado"),(0,n.ns)();if("1-15"===o)return{periodDate:`${a}-${h(i)}-16`,periodType:"16-31"};let l=new Date(a,i-1+1,1);return{periodDate:`${l.getFullYear()}-${h(l.getMonth()+1)}-01`,periodType:"1-15"}};async function D(e){try{let o,r;console.log("\uD83D\uDD12 [CLOSE-PERIOD] Iniciando cierre completo de per\xedodo...");let t=(0,n.iR)(),a="true"===e.headers.get("x-testing-mode"),i=e.headers.get("x-force-period-date"),l=e.headers.get("x-force-period-type"),p=e.headers.get("x-force-close-secret"),m=process.env.CRON_SECRET_KEY||"cron-secret",_=!!(p&&p===m),f=!1,h=e.headers.get("authorization");if(h)try{let e=h.replace("Bearer ",""),o=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c"),{data:{user:r},error:t}=await o.auth.getUser(e);if(r&&!t){let{data:e}=await g.from("users").select("role").eq("id",r.id).single();e?.role==="super_admin"&&(f=!0,console.log("\uD83D\uDEE1ï¸ [CLOSE-PERIOD] Super Admin autenticado solicitando cierre manual:",r.email))}}catch(e){console.warn("âš ï¸ [CLOSE-PERIOD] Error validando super admin:",e)}let D=a||_||f,O="1-15"===l||"16-31"===l,S=!!(i&&O&&D),{periodDate:v,periodType:L}=(0,n.sF)(),y=!1;S&&i&&O&&(v=i,L=l,y=!0,console.log("\uD83D\uDEE0ï¸ [CLOSE-PERIOD] Per\xedodo forzado v\xeda encabezados:",{periodToCloseDate:v,periodToCloseType:L}));let{periodDate:w,periodType:$}=y?I(v,L):(0,n.ns)();if(console.log(`ðŸ“… [CLOSE-PERIOD] Fecha de hoy: ${t}`),console.log(`ðŸ“¦ [CLOSE-PERIOD] Per\xedodo a cerrar: ${v} (${L})`),console.log(`ðŸ†• [CLOSE-PERIOD] Nuevo per\xedodo que inicia: ${w} (${$})`),!D&&!(0,n.Ck)())return s.Z.json({success:!1,error:"No es d\xeda de cierre (d\xedas 1 y 16)"},{status:400});if(!D&&!(0,n.Y)())return s.Z.json({success:!1,error:"No es momento de cierre completo (00:00 Colombia)"},{status:400});D&&console.log("\uD83E\uDDEA [CLOSE-PERIOD] MODO BYPASS ACTIVADO",{testingMode:a,forcedBySecret:_});let{data:C}=await g.from("calculator_period_closure_status").select("status").eq("period_date",v).eq("period_type",L).order("created_at",{ascending:!1}).limit(1).single();if(C?.status==="completed"){if(!D)return s.Z.json({success:!0,message:"Per\xedodo ya fue cerrado",already_closed:!0});console.warn("âš ï¸ [CLOSE-PERIOD] Reejecuci\xf3n forzada sobre per\xedodo marcado como completado")}await (0,c.H4)(v,L,"closing_calculators");let{data:P,error:b}=await g.from("users").select("id, email, name").eq("role","modelo").eq("is_active",!0);if(b)return console.error("âŒ [CLOSE-PERIOD] Error obteniendo modelos:",b),await (0,c.H4)(v,L,"failed",{error:"Error obteniendo modelos"}),s.Z.json({success:!1,error:"Error obteniendo modelos"},{status:500});console.log(`ðŸ”„ [CLOSE-PERIOD] Procesando ${P?.length||0} modelos...`),console.log("\uD83D\uDCBE [CLOSE-PERIOD] Creando backups de seguridad antes del archivado...");let R=[],F=0,A=0;for(let e of P||[])try{let o=await (0,c.M_)(e.id,v,L);o.success?(F++,R.push({model_id:e.id,model_email:e.email,status:"success",snapshot_id:o.snapshotId})):(A++,console.error(`âŒ [CLOSE-PERIOD] Error creando backup para ${e.email}:`,o.error),R.push({model_id:e.id,model_email:e.email,status:"error",error:o.error}))}catch(r){A++;let o=r instanceof Error?r.message:"Error desconocido";console.error(`âŒ [CLOSE-PERIOD] Error cr\xedtico creando backup para ${e.email}:`,r),R.push({model_id:e.id,model_email:e.email,status:"error",error:o})}console.log(`ðŸ’¾ [CLOSE-PERIOD] Backups completados: ${F} exitosos, ${A} errores`),A>0&&console.warn(`âš ï¸ [CLOSE-PERIOD] ${A} backups fallaron, pero continuando con el archivado...`);let T=[],x=0,q=0;for(let e of P||[])try{let o=await (0,c.Dv)(e.id,v,L);if(o.success)0===o.archived&&o.deleted>0?console.log(`âš ï¸ [CLOSE-PERIOD] Modelo ${e.email}: No hab\xeda valores para archivar (puede ser normal si el per\xedodo ya estaba limpio)`):0===o.archived&&console.log(`â„¹ï¸ [CLOSE-PERIOD] Modelo ${e.email}: No hab\xeda valores para procesar`),x++,T.push({model_id:e.id,model_email:e.email,status:"completed",archived_count:o.archived,deleted_count:o.deleted});else{q++;let r=o.error||"Error desconocido en atomicArchiveAndReset";console.error(`âŒ [CLOSE-PERIOD] Error en cierre at\xf3mico para ${e.email}:`,r),T.push({model_id:e.id,model_email:e.email,status:"error",error:r})}}catch(r){q++;let o=r instanceof Error?r.message:"Error desconocido";console.error(`âŒ [CLOSE-PERIOD] Error cerrando modelo ${e.email}:`,r),T.push({model_id:e.id,model_email:e.email,status:"error",error:o})}if(console.log(`âœ… [CLOSE-PERIOD] Proceso de archivo completado: ${x} exitosos, ${q} errores`),x>0){console.log(`ðŸ“Š [CLOSE-PERIOD] Verificando integridad del archivo completo generado...`);let{data:e,error:o}=await g.from("calculator_history").select("model_id, platform_id").eq("period_date",v).eq("period_type",L);if(!o&&e){let o=new Map;e.forEach(e=>{o.has(e.model_id)||o.set(e.model_id,new Set),o.get(e.model_id)?.add(e.platform_id)}),console.log(`âœ… [CLOSE-PERIOD] Archivo completo generado correctamente:`),console.log(`   - Total modelos con archivo: ${o.size}`),console.log(`   - Total registros archivados: ${e.length}`),console.log(`   - Promedio de plataformas por modelo: ${(e.length/o.size).toFixed(1)}`);let r=Array.from(T).filter(e=>"completed"===e.status&&0===e.archived_count).map(e=>e.model_email);r.length>0&&console.warn(`âš ï¸ [CLOSE-PERIOD] ${r.length} modelos marcados como exitosos pero sin plataformas archivadas: ${r.join(", ")}`)}else o&&console.error(`âŒ [CLOSE-PERIOD] Error obteniendo resumen del archivo:`,o)}let N=Math.floor(.1*(P?.length||0));if(q>N&&!D){let e=`Demasiados errores en el archivo (${q} de ${P?.length||0}). El proceso se detiene para evitar p\xe9rdida de datos.`;return console.error(`âŒ [CLOSE-PERIOD] ${e}`),await (0,c.H4)(v,L,"failed",{error:e,archive_results:{total:P?.length||0,successful:x,failed:q},failed_at:new Date().toISOString()}),s.Z.json({success:!1,error:e,archive_summary:{total:P?.length||0,successful:x,failed:q},details:{closure:T}},{status:500})}console.log("â³ [CLOSE-PERIOD] Esperando para \xfaltima actualizaci\xf3n del resumen..."),await (0,c.H4)(v,L,"waiting_summary");let B=D?5e3:15e4;D&&console.log("\uD83E\uDDEA [CLOSE-PERIOD] Modo bypass: espera reducida a 5 segundos"),await new Promise(e=>setTimeout(e,B)),console.log("âœ… [CLOSE-PERIOD] Tiempo de espera completado"),await (0,c.H4)(v,L,"closing_summary"),console.log("\uD83D\uDCB0 [CLOSE-PERIOD] Calculando facturaci\xf3n de afiliados...");let M="1-15"===L?"P1":"P2",{data:k}=await g.from("rates").select("value").eq("kind","USDâ†’COP").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}).limit(1).single(),z=k?.value?parseFloat(k.value):void 0,Z=await E(v,M,z);for(let e of(console.log(`âœ… [CLOSE-PERIOD] Facturaci\xf3n de afiliados calculada: ${Z.success} exitosos, ${Z.errors} errores`),P||[]))try{await (0,u.MW)(e.id,"periodo_cerrado",'El per\xedodo ha cerrado. Tus valores han sido archivados y puedes revisarlos en "Mi Historial". La calculadora se ha reiniciado para el nuevo per\xedodo. Puedes comenzar a ingresar valores nuevamente.')}catch(o){console.error(`âŒ [CLOSE-PERIOD] Error notificando modelo ${e.email}:`,o)}let{data:G}=await g.from("users").select("id, email, name").in("role",["admin","super_admin"]).eq("is_active",!0);for(let e of G||[])try{await (0,u.MW)(e.id,"periodo_cerrado",`Per\xedodo ${L} (${v}) cerrado exitosamente. El resumen est\xe1 disponible en "Consulta Hist\xf3rica" del Dashboard de Sedes. Nuevo per\xedodo ${$} (${w}) iniciado.`)}catch(o){console.error(`âŒ [CLOSE-PERIOD] Error notificando admin ${e.email}:`,o)}console.log("\uD83E\uDDF9 [CLOSE-PERIOD] Limpiando registros de early freeze del per\xedodo cerrado...");let[j,H]=v.split("-").map(Number);if("1-15"===L)o=`${j}-${String(H).padStart(2,"0")}-01`,r=`${j}-${String(H).padStart(2,"0")}-15`;else{o=`${j}-${String(H).padStart(2,"0")}-16`;let e=new Date(j,H,0).getDate();r=`${j}-${String(H).padStart(2,"0")}-${String(e).padStart(2,"0")}`}let{data:U,error:Y}=await g.from("calculator_early_frozen_platforms").delete().eq("period_date",v).select(),{data:J,error:V}=await g.from("calculator_early_frozen_platforms").delete().gte("period_date",o).lte("period_date",r).neq("period_date",v).select(),X=U?.length||0,K=J?.length||0;return Y||V?console.error("âŒ [CLOSE-PERIOD] Error limpiando early freeze:",Y||V):console.log(`âœ… [CLOSE-PERIOD] Registros de early freeze limpiados: ${X+K} registros eliminados`),await (0,c.H4)(v,L,"completed",{backup_summary:{total:P?.length||0,successful:F,failed:A},archive_results:{total:P?.length||0,successful:x,failed:q},reset_results:{total:P?.length||0,successful:x,failed:q},completed_at:new Date().toISOString()}),console.log("âœ… [CLOSE-PERIOD] Cierre completo exitoso"),s.Z.json({success:!0,message:"Cierre de per\xedodo completado exitosamente (MODO AT\xd3MICO)",period_date:v,period_type:L,new_period_date:w,new_period_type:$,backup_summary:{total:P?.length||0,successful:F,failed:A},archive_summary:{total:P?.length||0,successful:x,failed:q},reset_summary:{total:P?.length||0,successful:x,failed:q},details:{closure:T}})}catch(r){console.error("âŒ [CLOSE-PERIOD] Error:",r);let{periodDate:e,periodType:o}=(0,n.sF)();return await (0,c.H4)(e,o,"failed",{error:r instanceof Error?r.message:"Error desconocido",failed_at:new Date().toISOString()}),s.Z.json({success:!1,error:"Error interno del servidor",details:r instanceof Error?r.message:"Error desconocido"},{status:500})}}let O=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/period-closure/close-period/route",pathname:"/api/calculator/period-closure/close-period",filename:"route",bundlePath:"app/api/calculator/period-closure/close-period/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\period-closure\\close-period\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:S,staticGenerationAsyncStorage:v,serverHooks:L,headerHooks:y,staticGenerationBailout:w}=O,$="/api/calculator/period-closure/close-period/route";function C(){return(0,l.patchFetch)({serverHooks:L,staticGenerationAsyncStorage:v})}},18539:(e,o,r)=>{r.d(o,{Bm:()=>a,Ck:()=>p,UX:()=>m,Y:()=>s,a9:()=>l,g5:()=>d,iR:()=>t,im:()=>n,ns:()=>u,o8:()=>i,sF:()=>c});let t=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),a=()=>new Date().toLocaleString("sv-SE",{timeZone:"America/Bogota"}),i=e=>{let o=e||new Date,r=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit"}).format(o),t=new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(o),a={};t.forEach(e=>{"literal"!==e.type&&(a[e.type]=e.value)});let i=new Date(`${a.year}-${a.month}-${a.day}T00:00:00Z`),l=null;for(let e of[1,2]){let o=new Date(i.getTime()-36e5*e);if("00:00:00"===new Intl.DateTimeFormat("en-US",{timeZone:"Europe/Berlin",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(o)){l=o;break}}l||(l=new Date(i.getTime()-54e5));let s=new Intl.DateTimeFormat("en-US",{timeZone:"America/Bogota",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(l),d={};return s.forEach(e=>{"literal"!==e.type&&(d[e.type]=e.value)}),{colombiaTime:`${d.hour}:${d.minute}:${d.second}`||"00:00:00",colombiaDate:`${d.year}-${d.month}-${d.day}`,colombiaDateTime:l,europeDate:r}},l=()=>{let e=new Date,o=a(),r=i(e),[t,l]=o.split(" ")[1]?.split(":")||["00","00"],[s,d]=r.colombiaTime.split(":");return 5>=Math.abs(60*parseInt(t)+parseInt(l)-(60*parseInt(s)+parseInt(d)))},s=()=>{let e=a(),[o,r]=e.split(" ")[1]?.split(":")||["00","00"],t=parseInt(o),i=parseInt(r);return 0===t&&i>=0&&i<=15},d=["superfoon","livecreator","mdh","777","xmodels","big7","mondo","vx","babestation","dirtyfans"],n=()=>{let e=parseInt(t().split("-")[2]);return e>=1&&e<=15?"1-15":"16-31"},c=()=>{let e=t(),[o,r,a]=e.split("-").map(Number);if(1===a){let e=1===r?12:r-1,t=1===r?o-1:o;return new Date(t,e,0).getDate(),{periodDate:`${t}-${String(e).padStart(2,"0")}-16`,periodType:"16-31"}}return 16===a?{periodDate:`${o}-${String(r).padStart(2,"0")}-01`,periodType:"1-15"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},u=()=>{let e=t(),[o,r,a]=e.split("-").map(Number);return 1===a?{periodDate:e,periodType:"1-15"}:16===a?{periodDate:e,periodType:"16-31"}:{periodDate:e,periodType:a<=15?"1-15":"16-31"}},p=()=>{let e=parseInt(t().split("-")[2]);return 1===e||16===e},m=()=>{let[e,o,r]=t().split("-").map(Number);return 15===r||r===new Date(e,o,0).getDate()}}};var o=require("../../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964,7863,1065],()=>r(157));module.exports=t})();