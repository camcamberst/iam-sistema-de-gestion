"use strict";(()=>{var e={};e.id=3386,e.ids=[3386],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},44914:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>O,originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>D});var t={};r.r(t),r.d(t,{GET:()=>p,POST:()=>u});var a=r(95419),s=r(69108),i=r(99678),d=r(78070),l=r(72964),n=r(13532);let c=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function u(e){try{console.log("\uD83D\uDD04 [AUTO-CLOSE] Iniciando cierre autom\xe1tico de per\xedodo...");let e=(0,n.iR)(),o=(0,n.LQ)();console.log("\uD83D\uDD04 [AUTO-CLOSE] Fecha actual:",e),console.log("\uD83D\uDD04 [AUTO-CLOSE] Per\xedodo:",o.description),console.log("\uD83D\uDD04 [AUTO-CLOSE] Verificando/creando per\xedodo actual...");let r=await (0,n.wU)(e);console.log("âœ… [AUTO-CLOSE] Per\xedodo actual:",r);let{data:t,error:a}=await c.from("calculator_config").select("model_id, active").eq("active",!0);if(a)return console.error("âŒ [AUTO-CLOSE] Error obteniendo configuraciones:",a),d.Z.json({success:!1,error:"Error obteniendo configuraciones"},{status:500});console.log("\uD83D\uDD04 [AUTO-CLOSE] Configuraciones encontradas:",t?.length||0);let s=[];for(let r of t||[])try{console.log(`ðŸ”„ [AUTO-CLOSE] Procesando modelo: ${r.model_id}`);let{data:t,error:a}=await c.from("model_values").select("*").eq("model_id",r.model_id).eq("period_date",e);if(a){console.error(`âŒ [AUTO-CLOSE] Error obteniendo valores para ${r.model_id}:`,a);continue}if(t&&t.length>0){console.log(`ðŸ”„ [AUTO-CLOSE] Archivando ${t.length} valores para ${r.model_id}`);let e=t.map(e=>({model_id:e.model_id,platform_id:e.platform_id,value:e.value,period_date:e.period_date,period_type:o.type,archived_at:new Date().toISOString(),original_updated_at:e.updated_at})),{error:a}=await c.from("calculator_history").insert(e);if(a){console.error(`âŒ [AUTO-CLOSE] Error archivando valores para ${r.model_id}:`,a);continue}console.log(`âœ… [AUTO-CLOSE] Valores archivados para ${r.model_id}`)}let{error:i}=await c.from("model_values").delete().eq("model_id",r.model_id).eq("period_date",e);if(i){console.error(`âŒ [AUTO-CLOSE] Error eliminando valores para ${r.model_id}:`,i);continue}console.log(`âœ… [AUTO-CLOSE] Calculadora reseteada para ${r.model_id}`),s.push({model_id:r.model_id,status:"success",values_archived:t?.length||0})}catch(e){console.error(`âŒ [AUTO-CLOSE] Error procesando modelo ${r.model_id}:`,e),s.push({model_id:r.model_id,status:"error",error:e instanceof Error?e.message:"Error desconocido"})}let i=new Date().getDate();if(1===i||16===i){console.log("\uD83D\uDD04 [AUTO-CLOSE] Es d\xeda de corte, creando per\xedodo siguiente...");let e=(0,n.t2)(),o=await (0,n.wU)(e);console.log("âœ… [AUTO-CLOSE] Per\xedodo siguiente creado:",o)}return console.log("âœ… [AUTO-CLOSE] Cierre autom\xe1tico completado"),console.log("\uD83D\uDCCA [AUTO-CLOSE] Resultados:",s),d.Z.json({success:!0,message:"Cierre autom\xe1tico completado",period:o.description,date:e,current_period:r,results:s,summary:{total_models:s.length,successful:s.filter(e=>"success"===e.status).length,failed:s.filter(e=>"error"===e.status).length}})}catch(e){return console.error("âŒ [AUTO-CLOSE] Error en cierre autom\xe1tico:",e),d.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}async function p(e){try{let e=(0,n.iR)(),o=(0,n.LQ)(),{data:r}=await c.from("calculator_config").select("model_id").eq("active",!0),{data:t}=await c.from("model_values").select("model_id").eq("period_date",e),{data:a}=await c.from("calculator_history").select("id",{count:"exact"});return d.Z.json({success:!0,system_status:{current_date:e,current_period:o.description,active_models:r?.length||0,models_with_values:new Set(t?.map(e=>e.model_id)||[]).size,total_historical_records:a?.length||0}})}catch(e){return console.error("âŒ [AUTO-CLOSE] Error verificando estado:",e),d.Z.json({success:!1,error:"Error verificando estado del sistema"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/auto-close-period/route",pathname:"/api/calculator/auto-close-period",filename:"route",bundlePath:"app/api/calculator/auto-close-period/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\auto-close-period\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:_,staticGenerationAsyncStorage:E,serverHooks:g,headerHooks:O,staticGenerationBailout:D}=m,h="/api/calculator/auto-close-period/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:E})}},13532:(e,o,r)=>{r.d(o,{LQ:()=>i,iR:()=>a,t2:()=>d,wU:()=>l});let t=()=>(console.warn("âš ï¸ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),s=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),i=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},d=()=>{let e=new Date;return e.setDate(e.getDate()+1),s(e)},l=async e=>{let{createClient:o}=await r.e(2964).then(r.bind(r,72964)),a=o("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e||t();try{let{data:e,error:o}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",s).eq("end_date",s).eq("is_active",!0).single();if(o&&"PGRST116"!==o.code)throw console.error("âŒ [CREATE-PERIOD] Error verificando per\xedodo:",o),o;if(e)return console.log("âœ… [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",s);let{data:r,error:t}=await a.from("periods").insert({name:`Per\xedodo ${s}`,start_date:s,end_date:s,is_active:!0}).select().single();if(t)throw console.error("âŒ [CREATE-PERIOD] Error creando per\xedodo:",t),t;return console.log("âœ… [CREATE-PERIOD] Per\xedodo creado exitosamente:",r),r}catch(e){throw console.error("âŒ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>r(44914));module.exports=t})();