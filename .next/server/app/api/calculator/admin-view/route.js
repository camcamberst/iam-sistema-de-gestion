"use strict";(()=>{var e={};e.id=2007,e.ids=[2007],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},87414:(e,r,o)=>{o.r(r),o.d(r,{headerHooks:()=>f,originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>D,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>E});var t={};o.r(t),o.d(t,{GET:()=>p,dynamic:()=>l});var a=o(95419),s=o(69108),n=o(99678),i=o(78070),d=o(72964),u=o(13532);let l="force-dynamic",c=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function p(e){try{let{searchParams:r}=new URL(e.url),o=r.get("modelId"),t=r.get("adminId");if(console.log("\uD83D\uDD0D [ADMIN-VIEW] GET request:",{modelId:o,adminId:t}),!o||!t)return i.Z.json({success:!1,error:"modelId y adminId son requeridos"},{status:400});let{data:a,error:s}=await c.from("users").select("role, groups:user_groups(group_id)").eq("id",t).single();if(s)return console.error("❌ [ADMIN-VIEW] Error al obtener admin:",s),i.Z.json({success:!1,error:"Admin no encontrado"},{status:404});let n="super_admin"===a.role,d="admin"===a.role;if(!n&&!d)return i.Z.json({success:!1,error:"No tienes permisos para acceder a esta funci\xf3n"},{status:403});let{data:l,error:p}=await c.from("users").select(`
        id,
        name,
        email,
        role,
        groups:user_groups(
          group_id,
          group:groups(id, name)
        )
      `).eq("id",o).eq("role","modelo").single();if(p)return console.error("❌ [ADMIN-VIEW] Error al obtener modelo:",p),i.Z.json({success:!1,error:"Modelo no encontrado"},{status:404});if(d&&!n){let e=a.groups?.map(e=>e.group_id)||[];if(!(l.groups?.map(e=>e.group_id)||[]).some(r=>e.includes(r)))return i.Z.json({success:!1,error:"No tienes permisos para ver este modelo"},{status:403})}let{data:m,error:g}=await c.from("calculator_config").select("*").eq("model_id",o).eq("active",!0).single();if(g&&"PGRST116"!==g.code)return console.error("❌ [ADMIN-VIEW] Error al obtener configuraci\xf3n:",g),i.Z.json({success:!1,error:"Error al obtener configuraci\xf3n"},{status:500});let _=[];if(m){let{data:e,error:r}=await c.from("calculator_platforms").select("*").in("id",m.enabled_platforms).eq("active",!0).order("name");if(r)return console.error("❌ [ADMIN-VIEW] Error al obtener plataformas:",r),i.Z.json({success:!1,error:"Error al obtener plataformas"},{status:500});_=(e||[]).map(e=>({id:e.id,name:e.name,description:e.description,currency:e.currency,token_rate:e.token_rate,discount_factor:e.discount_factor,tax_rate:e.tax_rate,direct_payout:e.direct_payout,percentage:m.percentage_override||m.group_percentage||80,min_quota:m.min_quota_override||m.group_min_quota||470}))}let{data:D,error:f}=await c.from("rates").select("kind, value").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1}),E=null;!f&&D?(E={usd_cop:D.find(e=>"USD→COP"===e.kind)?.value||3900,eur_usd:D.find(e=>"EUR→USD"===e.kind)?.value||1.01,gbp_usd:D.find(e=>"GBP→USD"===e.kind)?.value||1.2},console.log("\uD83D\uDD0D [ADMIN-VIEW] Loaded rates:",E)):f&&console.error("❌ [ADMIN-VIEW] Error loading rates:",f);let v=(0,u.iR)(),I=new Date;I.setDate(I.getDate()-7);let q=I.toISOString().split("T")[0];console.log("\uD83D\uDD0D [ADMIN-VIEW] Loading values with date filter:",{modelId:o,today:v,sevenDaysAgoStr:q});let{data:A,error:w}=await c.from("model_values").select(`
        platform_id,
        value,
        tokens,
        value_usd,
        platform,
        period_date,
        created_at,
        updated_at
      `).eq("model_id",o).gte("period_date",q).order("updated_at",{ascending:!1}),h=new Map;A?.forEach(e=>{h.has(e.platform_id)||h.set(e.platform_id,e)});let R=Array.from(h.values());if(console.log("\uD83D\uDD0D [ADMIN-VIEW] Found unique values:",R.length),w)return console.error("❌ [ADMIN-VIEW] Error al obtener valores:",w),i.Z.json({success:!1,error:"Error al obtener valores"},{status:500});let P={success:!0,model:{id:l.id,name:l.name,email:l.email,groups:l.groups?.map(e=>e.group)||[]},config:m?{id:m.id,active:m.active,enabled_platforms:m.enabled_platforms,percentage_override:m.percentage_override,min_quota_override:m.min_quota_override,group_percentage:m.group_percentage,group_min_quota:m.group_min_quota,created_at:m.created_at}:null,platforms:_.map(e=>({id:e.id,name:e.name,enabled:!0,percentage:e.percentage,min_quota:e.min_quota,currency:e.currency})),values:R||[],periodDate:v,rates:E,isConfigured:!!m};return console.log("✅ [ADMIN-VIEW] Data loaded successfully:",{modelName:l.name,isConfigured:!!m,platformsCount:_.length,valuesCount:R?.length||0}),i.Z.json(P)}catch(e){return console.error("❌ [ADMIN-VIEW] Error general:",e),i.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/calculator/admin-view/route",pathname:"/api/calculator/admin-view",filename:"route",bundlePath:"app/api/calculator/admin-view/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\admin-view\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:D,headerHooks:f,staticGenerationBailout:E}=m,v="/api/calculator/admin-view/route";function I(){return(0,n.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:_})}},13532:(e,r,o)=>{o.d(r,{LQ:()=>n,iR:()=>a,t2:()=>i,wU:()=>d});let t=()=>(console.warn("⚠️ getCalculatorDate() is deprecated. Use getColombiaDate() instead."),a()),a=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),s=e=>e.toLocaleDateString("en-CA",{timeZone:"America/Bogota"}),n=()=>{let e=new Date().getDate();return e>=1&&e<=15?{type:"1-15",start:1,end:15,description:"Per\xedodo 1 (d\xedas 1-15)"}:{type:"16-31",start:16,end:31,description:"Per\xedodo 2 (d\xedas 16-31)"}},i=()=>{let e=new Date;return e.setDate(e.getDate()+1),s(e)},d=async e=>{let{createClient:r}=await o.e(2964).then(o.bind(o,72964)),a=r("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e||t();try{let{data:e,error:r}=await a.from("periods").select("id, name, start_date, end_date, is_active").eq("start_date",s).eq("end_date",s).eq("is_active",!0).single();if(r&&"PGRST116"!==r.code)throw console.error("❌ [CREATE-PERIOD] Error verificando per\xedodo:",r),r;if(e)return console.log("✅ [CREATE-PERIOD] Per\xedodo ya existe:",e),e;console.log("\uD83D\uDD04 [CREATE-PERIOD] Creando per\xedodo para:",s);let{data:o,error:t}=await a.from("periods").insert({name:`Per\xedodo ${s}`,start_date:s,end_date:s,is_active:!0}).select().single();if(t)throw console.error("❌ [CREATE-PERIOD] Error creando per\xedodo:",t),t;return console.log("✅ [CREATE-PERIOD] Per\xedodo creado exitosamente:",o),o}catch(e){throw console.error("❌ [CREATE-PERIOD] Error en createPeriodIfNeeded:",e),e}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>o(87414));module.exports=t})();