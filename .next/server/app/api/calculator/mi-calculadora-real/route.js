"use strict";(()=>{var e={};e.id=779,e.ids=[779],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},73301:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>_,originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>D,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>A});var o={};t.r(o),t.d(o,{GET:()=>m,dynamic:()=>u});var a=t(95419),i=t(69108),n=t(99678),l=t(78070),s=t(72964),d=t(13532),c=t(25506);let u="force-dynamic",p=(0,s.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function m(e){let{searchParams:r}=new URL(e.url),t=r.get("modelId");if(!t)return l.Z.json({success:!1,error:"modelId es requerido"},{status:400});try{let e=(0,d.iR)(),r=new Date(new Date(e).getTime()-864e5).toISOString().split("T")[0],o=(0,d.Jz)(e);console.log("\uD83D\uDD0D [MI-CALCULADORA-REAL] Obteniendo valores para modelId:",t),console.log("\uD83D\uDD0D [MI-CALCULADORA-REAL] Fechas: Hoy=",e,"Ayer=",r,"Periodo=",o);let{data:a,error:i}=await p.from("rates").select("kind, value, valid_from").eq("active",!0).is("valid_to",null).order("valid_from",{ascending:!1});if(i)throw Error(`Error al obtener tasas: ${i.message}`);let n=a?.filter(e=>"USD→COP"===e.kind)||[],s=a?.filter(e=>"EUR→USD"===e.kind)||[],u=a?.filter(e=>"GBP→USD"===e.kind)||[],m=n.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],g=s.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],D=u.sort((e,r)=>new Date(r.valid_from).getTime()-new Date(e.valid_from).getTime())[0],S={usd_cop:m?.value||3900,eur_usd:g?.value||1.01,gbp_usd:D?.value||1.2},{data:f,error:_}=await p.from("calculator_config").select("*").eq("model_id",t).eq("active",!0).single();if(_&&"PGRST116"!==_.code)throw Error(`Error al obtener configuraci\xf3n: ${_.message}`);if(!f)return console.log("\uD83D\uDD0D [MI-CALCULADORA-REAL] No se encontr\xf3 configuraci\xf3n para modelId:",t),l.Z.json({success:!0,data:{usdModelo:0,copModelo:0,anticipoDisponible:0,anticiposPagados:0}});let{data:A,error:h}=await p.from("calculator_platforms").select("*").in("id",f.enabled_platforms).eq("active",!0);if(h)throw Error(`Error al obtener plataformas: ${h.message}`);let I=parseInt(o.split("-")[2])>=16,E=new Date(o);I?(E.setMonth(E.getMonth()+1),E.setDate(0)):E.setDate(15);let v=E.toISOString().split("T")[0];console.log("\uD83D\uDD0D [MI-CALCULADORA-REAL] Buscando valores en rango:",{periodStart:o,periodEnd:v});let{data:w,error:L}=await p.from("model_values").select("platform_id, value, period_date, updated_at").eq("model_id",t).gte("period_date",o).lte("period_date",v).order("updated_at",{ascending:!1});if(L)throw Error(`Error al obtener valores del periodo: ${L.message}`);let T=new Map;w?.forEach(e=>{T.has(e.platform_id)||T.set(e.platform_id,Number(e.value)||0)});let b={};T.forEach((e,r)=>{b[r]=e}),console.log(`✅ [MI-CALCULADORA-REAL] Valores consolidados encontrados: ${T.size}`);let{data:C,error:$}=await p.from("model_values").select("platform_id, value").eq("model_id",t).eq("period_date",r);$&&console.warn("⚠️ [MI-CALCULADORA-REAL] Error al obtener valores de ayer (no cr\xedtico):",$.message);let U={};C?.forEach(e=>{U[e.platform_id]=Number(e.value)||0});let R=(await (0,c.g4)(t,o)).total,O=0;for(let e of A||[]){let r=b[e.id]||0;if(r<=0)continue;let t=e.currency||"USD",o=f.percentage_override??f.group_percentage??e.percentage??80,a=0;"EUR"===t?a="big7"===e.id?r*S.eur_usd*.84:"mondo"===e.id?r*S.eur_usd*.78:r*S.eur_usd:"GBP"===t?a="aw"===e.id?r*S.gbp_usd*.677:r*S.gbp_usd:"USD"===t&&("cmd"===e.id||"camlust"===e.id||"skypvt"===e.id?a=.75*r:"chaturbate"===e.id||"myfreecams"===e.id||"stripchat"===e.id?a=.05*r:"dxlive"===e.id?a=.6*r:"secretfriends"===e.id?a=.5*r:(e.id,a=r));let i="superfoon"===e.id?a:o/100*a;O+=i}let P=Math.round(O*S.usd_cop),M=Math.round(.9*P),q=Math.max(0,M-R);return console.log("✅ [MI-CALCULADORA-REAL] Resultados calculados (L\xf3gica Dashboard):",{usdModelo:O,copModelo:P,anticipoDisponible:q,anticiposPagados:R}),l.Z.json({success:!0,data:{usdModelo:Math.round(100*O)/100,copModelo:P,anticipoDisponible:q,anticiposPagados:R}})}catch(e){return console.error("❌ [MI-CALCULADORA-REAL] Error general:",e),l.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/calculator/mi-calculadora-real/route",pathname:"/api/calculator/mi-calculadora-real",filename:"route",bundlePath:"app/api/calculator/mi-calculadora-real/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\calculator\\mi-calculadora-real\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:D,staticGenerationAsyncStorage:S,serverHooks:f,headerHooks:_,staticGenerationBailout:A}=g,h="/api/calculator/mi-calculadora-real/route";function I(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:S})}},25506:(e,r,t)=>{t.d(r,{QY:()=>a,g4:()=>i});let o=(0,t(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});async function a(e,r){try{let t=new Date(r||new Date().toISOString().split("T")[0]),a=t.getFullYear(),i=t.getMonth()+1;console.log("\uD83D\uDD0D [ANTICIPOS-UTILS] Buscando per\xedodos del mes:",a,i);let{data:n,error:l}=await o.from("periods").select("id").gte("start_date",`${a}-${i.toString().padStart(2,"0")}-01`).lt("start_date",`${a}-${(i+1).toString().padStart(2,"0")}-01`);if(l)throw console.error("❌ [ANTICIPOS-UTILS] Error al obtener per\xedodos del mes:",l),Error("Error al obtener per\xedodos del mes");let s=n?.map(e=>e.id)||[];console.log("\uD83D\uDD0D [ANTICIPOS-UTILS] Per\xedodos del mes encontrados:",s);let{data:d,error:c}=await o.from("anticipos").select("monto_solicitado, estado, period_id, created_at, realized_at").eq("model_id",e).in("period_id",s).eq("estado","confirmado");if(c)throw console.error("❌ [ANTICIPOS-UTILS] Error al obtener anticipos:",c),Error("Error al obtener anticipos");let u=d?.reduce((e,r)=>e+(r.monto_solicitado||0),0)||0;return console.log("✅ [ANTICIPOS-UTILS] Anticipos encontrados:",{count:d?.length||0,total:u,periodIds:s}),{anticipos:d||[],total:u,count:d?.length||0,periodIds:s}}catch(e){throw console.error("❌ [ANTICIPOS-UTILS] Error general:",e),e}}async function i(e,r){try{let t=new Date(r||new Date().toISOString().split("T")[0]),a=t.getFullYear(),i=t.getMonth()+1,n=t.getDate(),l=n<=15?15:new Date(a,i,0).getDate(),s=`${a}-${String(i).padStart(2,"0")}-${String(n<=15?1:16).padStart(2,"0")}`,d=`${a}-${String(i).padStart(2,"0")}-${String(l).padStart(2,"0")}`,{data:c,error:u}=await o.from("periods").select("id, start_date").gte("start_date",s).lte("start_date",d);if(u)return console.warn("⚠️ [ANTICIPOS-UTILS] No se pudieron obtener per\xedodos del corte (continuando sin anticipos):",u.message),{anticipos:[],total:0,count:0,periodIds:[]};let p=(c||[]).map(e=>e.id);if(0===p.length)return console.log("\uD83D\uDD0D [ANTICIPOS-UTILS] No se encontraron per\xedodos en el rango:",{startDate:s,endDate:d}),{anticipos:[],total:0,count:0,periodIds:[]};let{data:m,error:g}=await o.from("anticipos").select("monto_solicitado, estado, period_id, created_at, realized_at").eq("model_id",e).in("period_id",p).in("estado",["confirmado","realizado"]);if(g)throw console.error("❌ [ANTICIPOS-UTILS] Error al obtener anticipos pagados del corte:",g),Error("Error al obtener anticipos pagados del corte");let D=m?.reduce((e,r)=>e+(r.monto_solicitado||0),0)||0;return{anticipos:m||[],total:D,count:m?.length||0,periodIds:p}}catch(e){throw console.error("❌ [ANTICIPOS-UTILS] Error general:",e),e}}},13532:(e,r,t)=>{t.d(r,{Bs:()=>i,Jz:()=>a,iR:()=>n,lm:()=>o});let o=()=>{let[e,r,t]=n().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},a=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("⚠️ [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),o();let[r,t,a]=e.split("-").map(Number);if(!r||!t||!a)return o();return`${r}-${String(t).padStart(2,"0")}-${String(a<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("❌ [DATE-UTILS] Error normalizando fecha:",e),o()}},i=e=>{try{let[r,t,o]=e.split("-").map(Number),a=o<=15,i=`${r}-${String(t).padStart(2,"0")}-${a?"01":"16"}`,n="";if(a)n=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();n=`${r}-${String(t).padStart(2,"0")}-${e}`}let l=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${a?"1":"2"}`;return{startDate:i,endDate:n,name:l,isP1:a}}catch(r){return console.error("❌ [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},n=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(73301));module.exports=o})();