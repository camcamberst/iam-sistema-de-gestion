"use strict";(()=>{var e={};e.id=6992,e.ids=[6992],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},14569:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>S,patchFetch:()=>E,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>P});var o={};t.r(o),t.d(o,{POST:()=>p,dynamic:()=>l});var a=t(95419),s=t(69108),i=t(99678),c=t(78070),n=t(72964);let d=process.env.SUPABASE_SERVICE_ROLE_KEY,u=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",d),l="force-dynamic";async function p(e){try{let r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return c.Z.json({success:!1,error:"No autorizado"},{status:401});let t=r.split(" ")[1],{data:{user:o},error:a}=await u.auth.getUser(t);if(a||!o)return c.Z.json({success:!1,error:"No autenticado"},{status:401});let{data:s,error:i}=await u.from("users").select("role").eq("id",o.id).single();if(i||!s)return c.Z.json({success:!1,error:"Error verificando usuario"},{status:500});if(!["gestor","admin","super_admin"].includes(s.role))return c.Z.json({success:!1,error:"Solo gestores, admins y super_admins pueden aplicar rates hist\xf3ricas"},{status:403});let{groupId:n,periodDate:d,periodType:l}=await e.json();if(!n||!d||!l)return c.Z.json({success:!1,error:"Faltan par\xe1metros requeridos: groupId, periodDate, periodType"},{status:400});if(!["1-15","16-31"].includes(l))return c.Z.json({success:!1,error:'periodType debe ser "1-15" o "16-31"'},{status:400});let{data:p,error:_}=await u.from("gestor_historical_rates").select("*").eq("group_id",n).eq("period_date",d).eq("period_type",l).single();if(_||!p)return c.Z.json({success:!1,error:"No se encontraron rates hist\xf3ricas configuradas para este per\xedodo"},{status:404});let{data:m,error:g}=await u.from("calculator_history").select("*").eq("period_date",d).eq("period_type",l).eq("group_id",n);if(g)return console.error("❌ [APPLY RATES] Error obteniendo historial:",g),c.Z.json({success:!1,error:g.message},{status:500});if(!m||0===m.length)return c.Z.json({success:!1,error:"No se encontraron registros hist\xf3ricos para este per\xedodo"},{status:404});let{data:f,error:h}=await u.from("calculator_platforms").select("*").eq("active",!0);if(h)return console.error("❌ [APPLY RATES] Error obteniendo plataformas:",h),c.Z.json({success:!1,error:h.message},{status:500});let P=Array.from(new Set(m.map(e=>e.model_id))),{data:S,error:E}=await u.from("calculator_config").select("model_id, percentage_override, group_percentage").in("model_id",P).eq("active",!0);E&&console.error("❌ [APPLY RATES] Error obteniendo configuraciones:",E);let y=new Map((S||[]).map(e=>[e.model_id,e])),A={USD_COP:parseFloat(p.rate_usd_cop),EUR_USD:parseFloat(p.rate_eur_usd),GBP_USD:parseFloat(p.rate_gbp_usd)},R=[],U=0,v=0;for(let e of m)try{let r=f?.find(r=>r.id===e.platform_id);if(!r){console.warn(`⚠️ [APPLY RATES] Plataforma no encontrada: ${e.platform_id}`),v++;continue}let t=y.get(e.model_id),o=t?.percentage_override||t?.group_percentage||80,a=0,s=parseFloat(e.value)||0;"EUR"===r.currency?a="big7"===r.id?s*A.EUR_USD*.84:"mondo"===r.id?s*A.EUR_USD*.78:s*A.EUR_USD:"GBP"===r.currency?a="aw"===r.id?s*A.GBP_USD*.677:s*A.GBP_USD:"USD"===r.currency&&("cmd"===r.id||"camlust"===r.id||"skypvt"===r.id?a=.75*s:"chaturbate"===r.id||"myfreecams"===r.id||"stripchat"===r.id?a=.05*s:"dxlive"===r.id?a=.6*s:"secretfriends"===r.id?a=.5*s:(r.id,a=s));let i=a;"superfoon"!==r.id&&(i=o/100*a);let c=Math.round(i*A.USD_COP);R.push({id:e.id,rate_eur_usd:A.EUR_USD,rate_gbp_usd:A.GBP_USD,rate_usd_cop:A.USD_COP,platform_percentage:o,value_usd_bruto:Math.round(100*a)/100,value_usd_modelo:Math.round(100*i)/100,value_cop_modelo:c}),U++}catch(r){console.error(`❌ [APPLY RATES] Error calculando registro ${e.id}:`,r),v++}if(R.length>0)for(let e=0;e<R.length;e+=100)for(let r of R.slice(e,e+100)){let{id:e,...t}=r,{error:o}=await u.from("calculator_history").update(t).eq("id",e);o&&(console.error(`❌ [APPLY RATES] Error actualizando registro ${e}:`,o),v++)}let{error:q}=await u.from("gestor_historical_rates").update({aplicado_at:new Date().toISOString(),aplicado_por:o.id}).eq("id",p.id);return q&&console.error("❌ [APPLY RATES] Error marcando rates como aplicadas:",q),console.log(`✅ [APPLY RATES] Rates aplicadas: ${U} actualizados, ${v} errores`),c.Z.json({success:!0,data:{updatedCount:U,errorCount:v,totalRecords:m.length},message:`Rates hist\xf3ricas aplicadas correctamente. ${U} registros actualizados.`})}catch(e){return console.error("❌ [APPLY RATES] Error inesperado:",e),c.Z.json({success:!1,error:e.message||"Error inesperado"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/gestor/historical-rates/apply/route",pathname:"/api/gestor/historical-rates/apply",filename:"route",bundlePath:"app/api/gestor/historical-rates/apply/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\gestor\\historical-rates\\apply\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:h,staticGenerationBailout:P}=_,S="/api/gestor/historical-rates/apply/route";function E(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(14569));module.exports=o})();