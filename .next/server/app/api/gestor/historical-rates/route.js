"use strict";(()=>{var r={};r.id=2008,r.ids=[2008],r.modules={30517:r=>{r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:r=>{r.exports=require("http")},95687:r=>{r.exports=require("https")},85477:r=>{r.exports=require("punycode")},12781:r=>{r.exports=require("stream")},57310:r=>{r.exports=require("url")},59796:r=>{r.exports=require("zlib")},11179:(r,e,s)=>{s.r(e),s.d(e,{headerHooks:()=>S,originalPathname:()=>E,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>j});var t={};s.r(t),s.d(t,{GET:()=>l,POST:()=>g,dynamic:()=>p});var o=s(95419),a=s(69108),i=s(99678),u=s(78070),n=s(72964);let d=process.env.SUPABASE_SERVICE_ROLE_KEY,c=(0,n.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",d),p="force-dynamic";async function l(r){try{let{searchParams:e}=new URL(r.url),s=e.get("groupId"),t=e.get("periodDate"),o=e.get("periodType"),a=e.get("year"),i=e.get("month"),n=r.headers.get("authorization");if(!n?.startsWith("Bearer "))return u.Z.json({success:!1,error:"No autorizado"},{status:401});let d=n.split(" ")[1],{data:{user:p},error:l}=await c.auth.getUser(d);if(l||!p)return u.Z.json({success:!1,error:"No autenticado"},{status:401});let{data:g,error:_}=await c.from("users").select("role").eq("id",p.id).single();if(_||!g)return u.Z.json({success:!1,error:"Error verificando usuario"},{status:500});if(!["gestor","admin","super_admin","modelo"].includes(g.role))return u.Z.json({success:!1,error:"No autorizado"},{status:403});let m=c.from("gestor_historical_rates").select(`
        *,
        configurado_por_user:users!gestor_historical_rates_configurado_por_fkey(id, name, email),
        aplicado_por_user:users!gestor_historical_rates_aplicado_por_fkey(id, name, email),
        group:groups(id, name)
      `).order("period_date",{ascending:!1}).order("period_type",{ascending:!1});if(s&&(m=m.eq("group_id",s)),t&&(m=m.eq("period_date",t)),o&&(m=m.eq("period_type",o)),a&&i){let r=`${a}-${String(i).padStart(2,"0")}-01`,e=`${a}-${String(i).padStart(2,"0")}-16`;m=m.in("period_date",[r,e])}let{data:f,error:h}=await m;if(h)return console.error("❌ [HISTORICAL RATES] Error obteniendo rates:",h),u.Z.json({success:!1,error:h.message},{status:500});return u.Z.json({success:!0,data:f||[]})}catch(r){return console.error("❌ [HISTORICAL RATES] Error inesperado:",r),u.Z.json({success:!1,error:r.message||"Error inesperado"},{status:500})}}async function g(r){try{let e=r.headers.get("authorization");if(!e?.startsWith("Bearer "))return u.Z.json({success:!1,error:"No autorizado"},{status:401});let s=e.split(" ")[1],{data:{user:t},error:o}=await c.auth.getUser(s);if(o||!t)return u.Z.json({success:!1,error:"No autenticado"},{status:401});let{data:a,error:i}=await c.from("users").select("role").eq("id",t.id).single();if(i||!a)return u.Z.json({success:!1,error:"Error verificando usuario"},{status:500});if(!["gestor","admin","super_admin"].includes(a.role))return u.Z.json({success:!1,error:"Solo gestores, admins y super_admins pueden configurar rates hist\xf3ricas"},{status:403});let{groupId:n,periodDate:d,periodType:p,rateUsdCop:l,rateEurUsd:g,rateGbpUsd:_}=await r.json();if(!n||!d||!p)return u.Z.json({success:!1,error:"Faltan par\xe1metros requeridos: groupId, periodDate, periodType"},{status:400});if(!l||!g||!_)return u.Z.json({success:!1,error:"Faltan rates requeridas: rateUsdCop, rateEurUsd, rateGbpUsd"},{status:400});if(!["1-15","16-31"].includes(p))return u.Z.json({success:!1,error:'periodType debe ser "1-15" o "16-31"'},{status:400});let{data:m,error:f}=await c.from("groups").select("id").eq("id",n).single();if(f||!m)return u.Z.json({success:!1,error:"Grupo no encontrado"},{status:404});let h=new Date(d),S=new Date;if(S.setHours(0,0,0,0),h>=S)return u.Z.json({success:!1,error:"Solo se pueden configurar rates para per\xedodos hist\xf3ricos (pasados)"},{status:400});let{data:j,error:E}=await c.from("gestor_historical_rates").upsert({group_id:n,period_date:d,period_type:p,rate_usd_cop:parseFloat(l),rate_eur_usd:parseFloat(g),rate_gbp_usd:parseFloat(_),configurado_por:t.id,updated_at:new Date().toISOString()},{onConflict:"group_id,period_date,period_type"}).select().single();if(E)return console.error("❌ [HISTORICAL RATES] Error guardando rate:",E),u.Z.json({success:!1,error:E.message},{status:500});return console.log("✅ [HISTORICAL RATES] Rate hist\xf3rica guardada:",j),u.Z.json({success:!0,data:j,message:"Rates hist\xf3ricas guardadas correctamente"})}catch(r){return console.error("❌ [HISTORICAL RATES] Error inesperado:",r),u.Z.json({success:!1,error:r.message||"Error inesperado"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/gestor/historical-rates/route",pathname:"/api/gestor/historical-rates",filename:"route",bundlePath:"app/api/gestor/historical-rates/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\gestor\\historical-rates\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:S,staticGenerationBailout:j}=_,E="/api/gestor/historical-rates/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}}};var e=require("../../../../webpack-runtime.js");e.C(r);var s=r=>e(e.s=r),t=e.X(0,[1638,6206,2964],()=>s(11179));module.exports=t})();