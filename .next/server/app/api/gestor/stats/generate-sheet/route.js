"use strict";(()=>{var e={};e.id=1353,e.ids=[1353],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},25080:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>S,originalPathname:()=>$,patchFetch:()=>T,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>_});var o={};t.r(o),t.d(o,{GET:()=>E,POST:()=>c});var s=t(95419),a=t(69108),i=t(99678),n=t(78070),l=t(72964),d=t(13532);let u=process.env.SUPABASE_SERVICE_ROLE_KEY,p=(0,l.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",u);async function c(e){try{let r,t;let{year:o,month:s,groupId:a}=await e.json().catch(()=>({}));if(o&&s)r=parseInt(o),t=parseInt(s);else{let[e,o]=(0,d.iR)().split("-").map(Number);r=e,t=o}if(t<1||t>12)return n.Z.json({success:!1,error:"Mes inv\xe1lido (debe ser entre 1 y 12)"},{status:400});let i=`${r}-${String(t).padStart(2,"0")}-01`,l=`${r}-${String(t).padStart(2,"0")}-16`;console.log(`üìä [GENERATE-SHEET] Generando planilla mensual para ${r}-${String(t).padStart(2,"0")} (P1: ${i}, P2: ${l})`);let{data:u,error:c}=await p.from("calculator_platforms").select("id").eq("active",!0);if(c)return console.error("‚ùå [GENERATE-SHEET] Error obteniendo plataformas:",c),n.Z.json({success:!1,error:"Error obteniendo plataformas"},{status:500});if(!u||0===u.length)return n.Z.json({success:!1,error:"No hay plataformas activas"},{status:400});console.log(`‚úÖ [GENERATE-SHEET] ${u.length} plataformas activas encontradas`);let E=p.from("groups").select("id").eq("is_active",!0);a&&(E=E.eq("id",a));let{data:g,error:m}=await E;if(m)return console.error("‚ùå [GENERATE-SHEET] Error obteniendo grupos:",m),n.Z.json({success:!1,error:"Error obteniendo grupos"},{status:500});if(!g||0===g.length)return n.Z.json({success:!1,error:"No hay grupos activos"},{status:400});console.log(`‚úÖ [GENERATE-SHEET] ${g.length} grupos activos encontrados`);let f=[],h=0;for(let e of g){let{data:r,error:t}=await p.from("user_groups").select("user_id").eq("group_id",e.id);if(t){console.warn(`‚ö†Ô∏è [GENERATE-SHEET] Error obteniendo usuarios del grupo ${e.id}:`,t);continue}if(!r||0===r.length){console.log(`‚ö†Ô∏è [GENERATE-SHEET] Grupo ${e.id} no tiene usuarios asignados`);continue}let o=r.map(e=>e.user_id),{data:s,error:a}=await p.from("users").select("id").eq("role","modelo").eq("is_active",!0).in("id",o);if(a){console.warn(`‚ö†Ô∏è [GENERATE-SHEET] Error obteniendo modelos del grupo ${e.id}:`,a);continue}if(!s||0===s.length){console.log(`‚ö†Ô∏è [GENERATE-SHEET] Grupo ${e.id} no tiene modelos activos`);continue}for(let r of(console.log(`‚úÖ [GENERATE-SHEET] Grupo ${e.id}: ${s.length} modelos activos`),s)){for(let t of u){let{data:o}=await p.from("gestor_stats_values").select("id").eq("model_id",r.id).eq("platform_id",t.id).eq("period_date",i).eq("period_type","1-15").single();o||f.push({model_id:r.id,group_id:e.id,platform_id:t.id,period_date:i,period_type:"1-15",value:0});let{data:s}=await p.from("gestor_stats_values").select("id").eq("model_id",r.id).eq("platform_id",t.id).eq("period_date",l).eq("period_type","16-31").single();s||f.push({model_id:r.id,group_id:e.id,platform_id:t.id,period_date:l,period_type:"16-31",value:0})}h++}}if(0===f.length)return n.Z.json({success:!0,message:"La planilla ya existe para este mes",recordsCreated:0,totalModels:h,totalGroups:g.length,year:r,month:t});console.log(`üìù [GENERATE-SHEET] Creando ${f.length} registros para ambos per\xedodos...`);let{data:S,error:_}=await p.from("gestor_stats_values").insert(f).select("id");if(_)return console.error("‚ùå [GENERATE-SHEET] Error insertando registros:",_),n.Z.json({success:!1,error:"Error insertando registros",details:_.message},{status:500});return console.log(`‚úÖ [GENERATE-SHEET] Planilla mensual generada exitosamente: ${S?.length||0} registros creados`),n.Z.json({success:!0,message:"Planilla mensual generada exitosamente",recordsCreated:S?.length||0,totalModels:h,totalGroups:g.length,year:r,month:t,periodDateP1:i,periodDateP2:l})}catch(e){return console.error("‚ùå [GENERATE-SHEET] Error inesperado:",e),n.Z.json({success:!1,error:"Error interno del servidor",details:e.message},{status:500})}}async function E(e){try{let r,t;let{searchParams:o}=new URL(e.url),s=o.get("year"),a=o.get("month");if(s&&a)r=parseInt(s),t=parseInt(a);else{let[e,o]=(0,d.iR)().split("-").map(Number);r=e,t=o}let i=`${r}-${String(t).padStart(2,"0")}-01`,l=`${r}-${String(t).padStart(2,"0")}-16`,{data:u,error:c}=await p.from("gestor_stats_values").select("id, model_id, group_id, platform_id, period_type").in("period_date",[i,l]).in("period_type",["1-15","16-31"]);if(c)return n.Z.json({success:!1,error:"Error consultando planilla"},{status:500});let E=u?.filter(e=>"1-15"===e.period_type).length||0,g=u?.filter(e=>"16-31"===e.period_type).length||0;return n.Z.json({success:!0,year:r,month:t,periodDateP1:i,periodDateP2:l,totalRecords:u?.length||0,p1Records:E,p2Records:g,exists:(u?.length||0)>0,complete:E>0&&g>0})}catch(e){return console.error("‚ùå [GENERATE-SHEET] Error inesperado:",e),n.Z.json({success:!1,error:"Error interno del servidor"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/gestor/stats/generate-sheet/route",pathname:"/api/gestor/stats/generate-sheet",filename:"route",bundlePath:"app/api/gestor/stats/generate-sheet/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\gestor\\stats\\generate-sheet\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:S,staticGenerationBailout:_}=g,$="/api/gestor/stats/generate-sheet/route";function T(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},13532:(e,r,t)=>{t.d(r,{Bs:()=>a,Jz:()=>s,iR:()=>i,lm:()=>o});let o=()=>{let[e,r,t]=i().split("-").map(Number);return`${e}-${String(r).padStart(2,"0")}-${String(t<=15?1:16).padStart(2,"0")}`},s=e=>{try{if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return console.warn("‚ö†Ô∏è [DATE-UTILS] Formato de fecha inv\xe1lido para normalizar:",e),o();let[r,t,s]=e.split("-").map(Number);if(!r||!t||!s)return o();return`${r}-${String(t).padStart(2,"0")}-${String(s<=15?1:16).padStart(2,"0")}`}catch(e){return console.error("‚ùå [DATE-UTILS] Error normalizando fecha:",e),o()}},a=e=>{try{let[r,t,o]=e.split("-").map(Number),s=o<=15,a=`${r}-${String(t).padStart(2,"0")}-${s?"01":"16"}`,i="";if(s)i=`${r}-${String(t).padStart(2,"0")}-15`;else{let e=new Date(r,t,0).getDate();i=`${r}-${String(t).padStart(2,"0")}-${e}`}let n=`${["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][t-1]} ${r} - Per\xedodo ${s?"1":"2"}`;return{startDate:a,endDate:i,name:n,isP1:s}}catch(r){return console.error("‚ùå [DATE-UTILS] Error calculando detalles del per\xedodo:",r),{startDate:e,endDate:e,name:`Per\xedodo ${e}`,isP1:!0}}},i=()=>new Date().toLocaleDateString("en-CA",{timeZone:"America/Bogota"})}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(25080));module.exports=o})();