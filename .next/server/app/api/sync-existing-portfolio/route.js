"use strict";(()=>{var e={};e.id=9920,e.ids=[9920],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},94029:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>f,originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>g});var t={};r.r(t),r.d(t,{POST:()=>c});var s=r(95419),a=r(69108),i=r(99678),n=r(78070);let l=(0,r(72964).createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function c(e){try{console.log("\uD83D\uDD0D Sincronizando Portafolio de modelos existentes...");let{data:e,error:o}=await l.from("users").select("id, email, name").eq("role","modelo");if(o)return console.error("Error obteniendo modelos:",o),n.Z.json({success:!1,error:o.message},{status:500});if(!e||0===e.length)return n.Z.json({success:!0,message:"No hay modelos en el sistema",synced:0});let{data:r,error:t}=await l.from("calculator_config").select("model_id, enabled_platforms, admin_id, created_at").eq("active",!0);if(t)return console.error("Error obteniendo configuraciones:",t),n.Z.json({success:!1,error:t.message},{status:500});let s=e.map(e=>{let o=r?.find(o=>o.model_id===e.id);return o?{...e,calculator_config:[o]}:null}).filter(e=>null!==e);if(console.log("\uD83D\uDCCB Modelos encontrados con configuraci\xf3n:",s.length),0===s.length)return n.Z.json({success:!0,message:"No hay modelos con configuraci\xf3n de calculadora",synced:0});let a=[];for(let e of s){let{data:o,error:r}=await l.from("modelo_plataformas").select("id").eq("model_id",e.id).limit(1);if(r){console.error(`Error verificando Portafolio de ${e.email}:`,r);continue}o&&0!==o.length?console.log(`✅ ${e.email} ya tiene Portafolio`):a.push(e)}if(console.log(`🔄 Modelos que necesitan sincronizaci\xf3n: ${a.length}`),0===a.length)return n.Z.json({success:!0,message:"Todas las modelos ya tienen Portafolio sincronizado",synced:0});let i=[];for(let e of a){console.log(`🔄 Sincronizando Portafolio para: ${e.email}`);let o=e.calculator_config[0],r=o.enabled_platforms.map(r=>({model_id:e.id,platform_id:r,status:"entregada",is_initial_config:!0,requested_at:o.created_at,delivered_at:o.created_at,requested_by:o.admin_id,delivered_by:o.admin_id,notes:"Sincronizaci\xf3n autom\xe1tica de configuraci\xf3n existente"})),{error:t}=await l.from("modelo_plataformas").insert(r);t?(console.error(`❌ Error sincronizando ${e.email}:`,t),i.push({email:e.email,success:!1,error:t.message})):(console.log(`✅ Portafolio creado para ${e.email} con ${r.length} plataformas`),i.push({email:e.email,success:!0,platforms:r.length}))}let c=i.filter(e=>e.success).length;return console.log("\uD83C\uDF89 Sincronizaci\xf3n completada"),n.Z.json({success:!0,message:`Sincronizaci\xf3n completada. ${c}/${a.length} modelos procesadas exitosamente`,results:i,synced:c})}catch(e){return console.error("❌ Error en sincronizaci\xf3n:",e),n.Z.json({success:!1,error:e.message||"Error interno del servidor"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sync-existing-portfolio/route",pathname:"/api/sync-existing-portfolio",filename:"route",bundlePath:"app/api/sync-existing-portfolio/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\sync-existing-portfolio\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:p,headerHooks:f,staticGenerationBailout:g}=d,h="/api/sync-existing-portfolio/route";function _(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}}};var o=require("../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2964],()=>r(94029));module.exports=t})();