"use strict";(()=>{var e={};e.id=7499,e.ids=[7499],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},8835:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>E,originalPathname:()=>j,patchFetch:()=>Z,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>q,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>w});var a={};t.r(a),t.d(a,{DELETE:()=>v,GET:()=>l,POST:()=>_,dynamic:()=>d});var i=t(95419),o=t(69108),n=t(99678),s=t(78070),c=t(72964);let d="force-dynamic",u="https://mhernfrkvwigxdubiozm.supabase.co",p=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(e){try{let r=(0,c.createClient)(u,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let a=t.split(" ")[1],{data:{user:i},error:o}=await r.auth.getUser(a);if(o||!i)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{data:n,error:d}=await r.from("chat_conversations").select(`
        id,
        participant_1_id,
        participant_2_id,
        created_at,
        last_message_at,
        is_active,
        conversation_type,
        participant_1:participant_1_id(id, name, email, role),
        participant_2:participant_2_id(id, name, email, role)
      `).or(`participant_1_id.eq.${i.id},participant_2_id.eq.${i.id}`).eq("is_active",!0).order("last_message_at",{ascending:!1});if(d)return console.error("Error obteniendo conversaciones:",d),s.Z.json({error:"Error obteniendo conversaciones"},{status:500});let l=await Promise.all(n.map(async e=>{let{data:t}=await r.from("chat_messages").select("content, created_at, sender_id").eq("conversation_id",e.id).order("created_at",{ascending:!1}).limit(1).single(),a=e.participant_1_id===i.id?e.participant_2:e.participant_1;return{...e,other_participant:a,last_message:t}}));return s.Z.json({success:!0,conversations:l})}catch(e){return console.error("Error en GET /api/chat/conversations:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}async function _(e){try{let r=(0,c.createClient)(u,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let a=t.split(" ")[1],{data:{user:i},error:o}=await r.auth.getUser(a);if(o||!i)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{participant_2_id:n,conversation_type:d="direct"}=await e.json();if(!n)return s.Z.json({error:"ID del participante requerido"},{status:400});let l=await m(r,i.id,n);if(!l.allowed)return s.Z.json({error:l.reason},{status:403});let{data:_}=await r.from("chat_conversations").select("id").or(`and(participant_1_id.eq.${i.id},participant_2_id.eq.${n}),and(participant_1_id.eq.${n},participant_2_id.eq.${i.id})`).eq("is_active",!0).single();if(_)return s.Z.json({success:!0,conversation:_,message:"Conversaci\xf3n ya existe"});let{data:v,error:h}=await r.from("chat_conversations").insert({participant_1_id:i.id,participant_2_id:n,conversation_type:d}).select(`
        id,
        participant_1_id,
        participant_2_id,
        created_at,
        conversation_type,
        participant_1:participant_1_id(id, name, email, role),
        participant_2:participant_2_id(id, name, email, role)
      `).single();if(h)return console.error("Error creando conversaci\xf3n:",h),s.Z.json({error:"Error creando conversaci\xf3n"},{status:500});return s.Z.json({success:!0,conversation:v})}catch(e){return console.error("Error en POST /api/chat/conversations:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}async function m(e,r,t){let{data:a,error:i}=await e.from("users").select("id, role").in("id",[r,t]);if(i||!a||2!==a.length)return{allowed:!1,reason:"Error obteniendo informaci\xf3n de usuarios"};let o=a.find(e=>e.id===r),n=a.find(e=>e.id===t);if(!o||!n)return{allowed:!1,reason:"Usuario no encontrado"};if("super_admin"===o.role||"super_admin"===n.role||"admin"===o.role&&"super_admin"===n.role)return{allowed:!0};if("modelo"===o.role&&"admin"===n.role||"admin"===o.role&&"modelo"===n.role){let{data:a}=await e.from("user_groups").select("group_id").eq("user_id",r),{data:i}=await e.from("user_groups").select("group_id").eq("user_id",t),o=a?.map(e=>e.group_id)||[],n=i?.map(e=>e.group_id)||[];return o.some(e=>n.includes(e))?{allowed:!0}:{allowed:!1,reason:"No pertenecen al mismo grupo"}}return{allowed:!1,reason:"No tiene permisos para iniciar esta conversaci\xf3n"}}async function v(e){try{let r=(0,c.createClient)(u,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let a=t.split(" ")[1],{data:{user:i},error:o}=await r.auth.getUser(a);if(o||!i)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{searchParams:n}=new URL(e.url),d=n.get("conversation_id");if(!d)return s.Z.json({error:"ID de conversaci\xf3n requerido"},{status:400});let{data:l,error:_}=await r.from("chat_conversations").select("id, participant_1_id, participant_2_id").eq("id",d).single();if(_||!l)return s.Z.json({error:"Conversaci\xf3n no encontrada"},{status:404});if(l.participant_1_id!==i.id&&l.participant_2_id!==i.id)return s.Z.json({error:"No tienes permisos para eliminar esta conversaci\xf3n"},{status:403});let{error:m}=await r.from("chat_conversations").delete().eq("id",d);if(m)return console.error("Error eliminando conversaci\xf3n:",m),s.Z.json({error:"Error eliminando conversaci\xf3n"},{status:500});return s.Z.json({success:!0,message:"Conversaci\xf3n eliminada exitosamente"})}catch(e){return console.error("Error en DELETE conversaci\xf3n:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/conversations/route",pathname:"/api/chat/conversations",filename:"route",bundlePath:"app/api/chat/conversations/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\conversations\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:q,headerHooks:E,staticGenerationBailout:w}=h,j="/api/chat/conversations/route";function Z(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,2964],()=>t(8835));module.exports=a})();