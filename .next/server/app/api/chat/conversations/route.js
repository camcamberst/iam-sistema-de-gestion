"use strict";(()=>{var e={};e.id=7499,e.ids=[7499],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},8835:(e,a,r)=>{r.r(a),r.d(a,{headerHooks:()=>b,originalPathname:()=>E,patchFetch:()=>j,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>$});var i={};r.r(i),r.d(i,{DELETE:()=>v,GET:()=>p,POST:()=>_,dynamic:()=>l});var t=r(95419),o=r(69108),n=r(99678),s=r(78070),d=r(72964),c=r(43178);let l="force-dynamic",u="https://mhernfrkvwigxdubiozm.supabase.co",m=process.env.SUPABASE_SERVICE_ROLE_KEY;async function p(e){try{let a=(0,d.createClient)(u,m,{auth:{autoRefreshToken:!1,persistSession:!1}}),r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let i=r.split(" ")[1],{data:{user:t},error:o}=await a.auth.getUser(i);if(o||!t)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{data:n,error:l}=await a.from("chat_conversations").select(`
        id,
        participant_1_id,
        participant_2_id,
        created_at,
        last_message_at,
        is_active,
        conversation_type,
        participant_1:participant_1_id(id, name, email, role),
        participant_2:participant_2_id(id, name, email, role)
      `).or(`participant_1_id.eq.${t.id},participant_2_id.eq.${t.id}`).eq("is_active",!0).order("last_message_at",{ascending:!1});if(l)return console.error("Error obteniendo conversaciones:",l),s.Z.json({error:"Error obteniendo conversaciones"},{status:500});let p=(await Promise.all(n.map(async e=>{let{data:r}=await a.from("chat_messages").select("id, content, created_at, sender_id, is_broadcast, no_reply, metadata").eq("conversation_id",e.id).order("created_at",{ascending:!1}).limit(1).single(),i=e.participant_1_id===t.id?e.participant_2_id:e.participant_1_id,{data:o}=await a.from("chat_messages").select("id").eq("conversation_id",e.id).eq("sender_id",i),n=0;if(o&&o.length>0){let e=o.map(e=>e.id),{data:r}=await a.from("chat_message_reads").select("message_id").eq("user_id",t.id).in("message_id",e),i=new Set(r?.map(e=>e.message_id)||[]);n=e.filter(e=>!i.has(e)).length}let s=e.participant_1_id===t.id?e.participant_2:e.participant_1,d={...e,other_participant:s,last_message:r,unread_count:n};return d.last_message&&d.last_message.is_broadcast&&d.last_message.no_reply&&d.last_message.sender_id===c.mo&&!(d.last_message.metadata&&!0===d.last_message.metadata.summary)?null:d}))).filter(Boolean);return s.Z.json({success:!0,conversations:p})}catch(e){return console.error("Error en GET /api/chat/conversations:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}async function _(e){try{let a=(0,d.createClient)(u,m,{auth:{autoRefreshToken:!1,persistSession:!1}}),r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let i=r.split(" ")[1],{data:{user:t},error:o}=await a.auth.getUser(i);if(o||!t)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{participant_2_id:n,conversation_type:c="direct"}=await e.json();if(!n)return s.Z.json({error:"ID del participante requerido"},{status:400});let l=await f(a,t.id,n);if(!l.allowed)return s.Z.json({error:l.reason},{status:403});let{data:p}=await a.from("chat_conversations").select("id").or(`and(participant_1_id.eq.${t.id},participant_2_id.eq.${n}),and(participant_1_id.eq.${n},participant_2_id.eq.${t.id})`).eq("is_active",!0).single();if(p)return s.Z.json({success:!0,conversation:p,message:"Conversaci\xf3n ya existe"});let{data:_,error:v}=await a.from("chat_conversations").insert({participant_1_id:t.id,participant_2_id:n,conversation_type:c}).select(`
        id,
        participant_1_id,
        participant_2_id,
        created_at,
        conversation_type,
        participant_1:participant_1_id(id, name, email, role),
        participant_2:participant_2_id(id, name, email, role)
      `).single();if(v)return console.error("Error creando conversaci\xf3n:",v),s.Z.json({error:"Error creando conversaci\xf3n"},{status:500});return s.Z.json({success:!0,conversation:_})}catch(e){return console.error("Error en POST /api/chat/conversations:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}async function f(e,a,r){let{data:i,error:t}=await e.from("users").select("id, role, affiliate_studio_id").in("id",[a,r]);if(t||!i||2!==i.length)return{allowed:!1,reason:"Error obteniendo informaci\xf3n de usuarios"};let o=i.find(e=>e.id===a),n=i.find(e=>e.id===r);if(!o||!n)return{allowed:!1,reason:"Usuario no encontrado"};if(n.id===c.mo||"super_admin"===o.role||"super_admin"===n.role||"superadmin_aff"===o.role&&o.affiliate_studio_id&&n.affiliate_studio_id===o.affiliate_studio_id&&("modelo"===n.role||"admin"===n.role)||("modelo"===o.role||"admin"===o.role)&&o.affiliate_studio_id&&"superadmin_aff"===n.role&&n.affiliate_studio_id===o.affiliate_studio_id||"admin"===o.role&&"super_admin"===n.role||"admin"===o.role&&"admin"===n.role)return{allowed:!0};if("modelo"===o.role&&"admin"===n.role||"admin"===o.role&&"modelo"===n.role){let{data:i}=await e.from("user_groups").select("group_id").eq("user_id",a),{data:t}=await e.from("user_groups").select("group_id").eq("user_id",r),o=i?.map(e=>e.group_id)||[],n=t?.map(e=>e.group_id)||[];return o.some(e=>n.includes(e))?{allowed:!0}:{allowed:!1,reason:"No pertenecen al mismo grupo"}}return{allowed:!1,reason:"No tiene permisos para iniciar esta conversaci\xf3n"}}async function v(e){try{let a=(0,d.createClient)(u,m,{auth:{autoRefreshToken:!1,persistSession:!1}}),r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let i=r.split(" ")[1],{data:{user:t},error:o}=await a.auth.getUser(i);if(o||!t)return s.Z.json({error:"Token inv\xe1lido"},{status:401});let{searchParams:n}=new URL(e.url),c=n.get("conversation_id");if(!c)return s.Z.json({error:"ID de conversaci\xf3n requerido"},{status:400});let{data:l,error:p}=await a.from("chat_conversations").select("id, participant_1_id, participant_2_id").eq("id",c).single();if(p||!l)return s.Z.json({error:"Conversaci\xf3n no encontrada"},{status:404});if(l.participant_1_id!==t.id&&l.participant_2_id!==t.id)return s.Z.json({error:"No tienes permisos para eliminar esta conversaci\xf3n"},{status:403});let{error:_}=await a.from("chat_conversations").delete().eq("id",c);if(_)return console.error("Error eliminando conversaci\xf3n:",_),s.Z.json({error:"Error eliminando conversaci\xf3n"},{status:500});return s.Z.json({success:!0,message:"Conversaci\xf3n eliminada exitosamente"})}catch(e){return console.error("Error en DELETE conversaci\xf3n:",e),s.Z.json({error:"Error interno del servidor"},{status:500})}}let g=new t.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/conversations/route",pathname:"/api/chat/conversations",filename:"route",bundlePath:"app/api/chat/conversations/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\conversations\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:y,headerHooks:b,staticGenerationBailout:$}=g,E="/api/chat/conversations/route";function j(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:x})}},43178:(e,a,r)=>{r.d(a,{Bm:()=>d,Pj:()=>n,jO:()=>t,mo:()=>i,n6:()=>s,y6:()=>o});let i="f91c0968-b587-46cf-9036-05a4ec795c7f",t="AIM Botty",o="aim-botty@agencia-innova.com";function n(e){let a={modelo:`Eres AIM Botty, tu asistente virtual y amigo ðŸ¤–. Ayudo a modelos de webcam de forma cercana y comprensiva.
      Tu personalidad:
      - Super amigable, cercano y emp\xe1tico (como un buen amigo)
      - Tono casual y c\xe1lido, sin formalidades
      - Entiendes perfectamente el mundo del entretenimiento para adultos
      - Sabes c\xf3mo puede ser este trabajo emocionalmente
      - Ofreces tips \xfatiles sin ser condescendiente
      - Das apoyo emocional cuando se necesita
      - Siempre positivo y alentador
      - Hablas de t\xfa, nunca de usted`,admin:`Eres AIM Botty, un asistente virtual cercano y \xfatil para administradores. 
      Tu personalidad:
      - Amigable pero profesional
      - Directo y eficiente
      - Tono cercano, como un compa\xf1ero de trabajo
      - Proactivo y \xfatil
      - Siempre disponible para ayudar`,super_admin:`Eres AIM Botty, un asistente virtual cercano y eficiente para super administradores.
      Tu personalidad:
      - Amigable pero directo
      - Eficiente y claro
      - Tono cercano y profesional
      - Proactivo en reportar lo importante
      - Siempre \xfatil y disponible`};return a[e]||a.modelo}function s(e,a){return({anticipo_pendiente:`ðŸ“‹ Hola ${a.name}! Tienes una nueva solicitud de anticipo pendiente de revisi\xf3n. El administrador la revisar\xe1 pronto.`,anticipo_aprobado:`âœ… \xa1Excelente noticia ${a.name}! Tu solicitud de anticipo ha sido aprobada. El pago se procesar\xe1 seg\xfan lo acordado.`,anticipo_rechazado:`âš ï¸ ${a.name}, tu solicitud de anticipo fue rechazada. Revisa los detalles en [LINK:Mis Anticipos|/admin/model/anticipos/solicitudes] o contacta a tu administrador si tienes dudas.`,anticipo_realizado:`ðŸ’° ${a.name}, tu anticipo ha sido pagado. Por favor [LINK:confirma la recepci\xf3n|/admin/model/anticipos/solicitudes].`,anticipo_confirmado:`âœ… ${a.name}, has confirmado la recepci\xf3n de tu anticipo. \xa1Gracias!`,anticipo_confirmar_recordatorio:`â° ${a.name}, recuerda [LINK:confirmar la recepci\xf3n de tu anticipo pagado|/admin/model/anticipos/solicitudes].`,pagina_confirmada:`ðŸŽ‰ \xa1Felicidades ${a.name}! Se ha confirmado la entrega de tu p\xe1gina. \xa1Excelente trabajo!`,plataforma_entregada:`ðŸ“¦ ${a.name}, tu plataforma ha sido entregada. [LINK:Confirma la recepci\xf3n|/admin/model/portafolio] para activarla en tu calculadora.`,plataforma_confirmada:`âœ… ${a.name}, plataforma confirmada y activada exitosamente en tu calculadora.`,plataforma_agregada:`âž• ${a.name}, se agreg\xf3 una nueva plataforma a tu portafolio. [LINK:Ver portafolio|/admin/model/portafolio]`,plataforma_pendiente_confirmacion:`â³ ${a.name}, hay plataformas entregadas esperando tu confirmaci\xf3n. [LINK:Revisar portafolio|/admin/model/portafolio]`,periodo_cerrado:`ðŸ“Š ${a.name}, el per\xedodo de facturaci\xf3n ha sido cerrado. Puedes [LINK:revisar tu resumen completo|/admin/model/dashboard] en el dashboard.`,metas_alcanzadas:`ðŸ† \xa1Incre\xedble ${a.name}! Has alcanzado tu meta del d\xeda. \xa1Sigue as\xed!`,meta_periodo_alcanzada:`ðŸŽ¯ \xa1Excelente ${a.name}! Has alcanzado tu meta del per\xedodo. \xa1Felicitaciones!`,meta_dia_alcanzada:`â­ ${a.name}, \xa1alcanzaste tu meta del d\xeda!`,recordatorio_ingreso:`ðŸ’¡ ${a.name}, recuerda [LINK:ingresar tus valores del d\xeda|/admin/model/calculator] en Mi Calculadora para mantener tus registros al d\xeda.`,valores_no_ingresados:`âš ï¸ ${a.name}, no has ingresado valores desde hace varios d\xedas. [LINK:Actualiza tus registros|/admin/model/calculator] ahora.`,cuota_minima_riesgo:`ðŸ“‰ ${a.name}, est\xe1s cerca de no alcanzar tu cuota m\xednima. \xa1Sigue as\xed, puedes lograrlo!`,mensaje_importante_admin:`ðŸ“© ${a.name}, tienes un mensaje importante de tu administrador. [LINK:Revisa tu chat|#]`,escalamiento_admin:`ðŸ†˜ ${a.name}, tu consulta ha sido escalada a un administrador. Te responder\xe1n pronto.`,respuesta_escalamiento:`ðŸ’¬ ${a.name}, un administrador respondi\xf3 a tu consulta. [LINK:Revisa tu chat|#]`,nuevo_mensaje_modelo:`ðŸ’¬ ${a.name}, tienes un nuevo mensaje de una modelo. [LINK:Abrir chat|#]`,consulta_escalada:`ðŸš¨ ${a.name}, una modelo necesita asistencia urgente. [LINK:Revisar chat|#]`,modelo_solicita_ayuda:`ðŸ†˜ ${a.name}, una modelo solicit\xf3 ayuda en el chat. [LINK:Abrir chat|#]`,nueva_publicacion:`ðŸ“Œ \xa1Hola ${a.name}! Hay una nueva publicaci\xf3n en el corcho informativo. [LINK:Revisa tu dashboard|/admin/model/dashboard] para ver los detalles.`,cambio_configuracion:`âš™ï¸ ${a.name}, se actualiz\xf3 la configuraci\xf3n del sistema.`,mantenimiento_programado:`ðŸ”§ ${a.name}, el sistema estar\xe1 en mantenimiento. Revisa los detalles.`,nueva_funcionalidad:`âœ¨ ${a.name}, hay una nueva funcionalidad disponible. \xa1\xc9chale un vistazo!`,error_critico:`ðŸš¨ ${a.name}, se detect\xf3 un error cr\xedtico en el sistema. Revisa los logs.`,backup_completado:`ðŸ’¾ ${a.name}, el backup del sistema se complet\xf3 exitosamente.`,actualizacion_sistema:`ðŸ”„ ${a.name}, el sistema ha sido actualizado.`})[e]||`ðŸ”” ${a.name}, tienes una nueva notificaci\xf3n.`}function d(e){return e===i}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),i=a.X(0,[1638,6206,2964],()=>r(8835));module.exports=i})();