"use strict";(()=>{var e={};e.id=9992,e.ids=[9992],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},59768:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>g,originalPathname:()=>C,patchFetch:()=>U,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>E,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>f});var o={};t.r(o),t.d(o,{GET:()=>p,POST:()=>d});var s=t(95419),a=t(69108),n=t(99678),i=t(78070),u=t(72964);let c="https://mhernfrkvwigxdubiozm.supabase.co",l=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c";async function d(e){try{let e=(0,u.createClient)(c,l,{auth:{autoRefreshToken:!1,persistSession:!1}});console.log("\uD83E\uDDF9 [AUTO-CLEANUP] Iniciando limpieza autom\xe1tica de usuarios inactivos...");let r=new Date(Date.now()-12e4).toISOString(),{data:t,error:o}=await e.from("chat_user_status").select("user_id, last_seen, updated_at").eq("is_online",!0).lt("updated_at",r);if(o)return console.error("âŒ [AUTO-CLEANUP] Error obteniendo usuarios inactivos:",o),i.Z.json({error:"Error obteniendo usuarios inactivos"},{status:500});if(!t||0===t.length)return console.log("âœ… [AUTO-CLEANUP] No hay usuarios inactivos para limpiar"),i.Z.json({success:!0,message:"No hay usuarios inactivos para limpiar",cleanedCount:0});console.log(`ðŸ” [AUTO-CLEANUP] Encontrados ${t.length} usuarios inactivos:`,t.map(e=>e.user_id));let s=t.map(e=>e.user_id),{error:a}=await e.from("chat_user_status").update({is_online:!1,updated_at:new Date().toISOString()}).in("user_id",s);if(a)return console.error("âŒ [AUTO-CLEANUP] Error marcando usuarios como offline:",a),i.Z.json({error:"Error marcando usuarios como offline"},{status:500});return console.log(`âœ… [AUTO-CLEANUP] ${t.length} usuarios marcados como offline`),i.Z.json({success:!0,message:`${t.length} usuarios marcados como offline`,cleanedCount:t.length,cleanedUsers:t.map(e=>e.user_id)})}catch(e){return console.error("âŒ [AUTO-CLEANUP] Error general:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function p(e){try{let e=(0,u.createClient)(c,l,{auth:{autoRefreshToken:!1,persistSession:!1}});console.log("\uD83D\uDCCA [AUTO-CLEANUP] Obteniendo estad\xedsticas de usuarios...");let{data:r,error:t}=await e.from("chat_user_status").select("is_online, updated_at");if(t)return console.error("âŒ [AUTO-CLEANUP] Error obteniendo estad\xedsticas:",t),i.Z.json({error:"Error obteniendo estad\xedsticas"},{status:500});let o=new Date,s=new Date(o.getTime()-12e4),a={total:r?.length||0,online:r?.filter(e=>e.is_online).length||0,offline:r?.filter(e=>!e.is_online).length||0,potentiallyInactive:r?.filter(e=>e.is_online&&new Date(e.updated_at)<s).length||0,lastCleanup:new Date().toISOString()};return console.log("\uD83D\uDCCA [AUTO-CLEANUP] Estad\xedsticas:",a),i.Z.json({success:!0,stats:a})}catch(e){return console.error("âŒ [AUTO-CLEANUP] Error obteniendo estad\xedsticas:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/chat/auto-cleanup/route",pathname:"/api/chat/auto-cleanup",filename:"route",bundlePath:"app/api/chat/auto-cleanup/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\auto-cleanup\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:A,serverHooks:E,headerHooks:g,staticGenerationBailout:f}=h,C="/api/chat/auto-cleanup/route";function U(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:A})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(59768));module.exports=o})();