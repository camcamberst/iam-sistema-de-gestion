"use strict";(()=>{var e={};e.id=6265,e.ids=[6265],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},81324:e=>{e.exports=require("undici")},14300:e=>{e.exports=require("buffer")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},84492:e=>{e.exports=require("node:stream")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},13087:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>R,originalPathname:()=>P,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>S,serverHooks:()=>w,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>N});var o={};a.r(o),a.d(o,{POST:()=>T});var r=a(95419),s=a(69108),n=a(99678),i=a(78070),c=a(72964),l=a(70973),u=a(43178),d=a(84528);let p={modelo:["analytics_own_stats","analytics_own_productivity","analytics_comparison","analytics_trends","recommendations_own_platforms","config_view_own","anticipo_view_own","anticipo_request","action_request_anticipo","action_cancel_own_anticipo","notifications_receive","query_own_data","query_historical_own","action_export_own_data"],admin:["analytics_group_stats","analytics_comparison","analytics_trends","analytics_rankings","recommendations_group","config_view_group","config_edit_group","anticipo_view_group","anticipo_approve","anticipo_reject","notifications_receive","notifications_configure","query_group_data","query_historical_group","action_export_group_data"],super_admin:["analytics_own_stats","analytics_sede_stats","analytics_system_wide","analytics_comparison","analytics_trends","analytics_rankings","recommendations_system","recommendations_group","recommendations_own_platforms","config_view_all","config_edit_all","config_edit_group","config_view_own","anticipo_view_all","anticipo_approve","anticipo_reject","notifications_receive","notifications_configure","query_all_data","query_historical_all","query_own_data","action_export_all_data","action_export_group_data","action_export_own_data"]};var m=a(43186),g=a(91539),f=a(31057);let _=null;async function y(e){try{if(!e||!e.startsWith("http://")&&!e.startsWith("https://"))return{url:e,title:"",content:"",success:!1,error:"URL inv\xe1lida"};console.log(`ðŸŒ [WEB-FETCHER] Obteniendo contenido de: ${e}`);let t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},signal:AbortSignal.timeout(1e4)});if(!t.ok)return{url:e,title:"",content:"",success:!1,error:`Error HTTP ${t.status}: ${t.statusText}`};let o=await t.text();_||(_=(await a.e(2301).then(a.bind(a,12301))).default);let r=_.load(o),s=r("title").text()||r('meta[property="og:title"]').attr("content")||r("h1").first().text()||"Sin t\xedtulo";r("script, style, nav, footer, header, aside, .ad, .ads, .advertisement").remove();let n="",i=r("article").first(),c=r("main").first(),l=r("body");return(i.length?i:c.length?c:l).find("p, li, h1, h2, h3, h4, h5, h6").each((e,t)=>{let a=r(t).text().trim();a&&a.length>20&&(n+=a+"\n\n")}),n.length<200&&(n=l.text().trim()),(n=n.replace(/\s+/g," ").replace(/\n{3,}/g,"\n\n").trim()).length>8e3&&(n=n.substring(0,8e3)+"... [contenido truncado]"),console.log(`âœ… [WEB-FETCHER] Contenido obtenido: ${n.length} caracteres de "${s}"`),{url:e,title:s.trim(),content:n.trim(),success:!0}}catch(t){return console.error(`âŒ [WEB-FETCHER] Error obteniendo contenido de ${e}:`,t),{url:e,title:"",content:"",success:!1,error:t.message||"Error desconocido al obtener contenido"}}}var h=a(30948);let E=process.env.SUPABASE_SERVICE_ROLE_KEY,O=null;async function T(e){try{console.log("\uD83E\uDD16 [BOTTY-API] Recibida solicitud para generar respuesta");let r=(0,c.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",E,{auth:{autoRefreshToken:!1,persistSession:!1}}),s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return console.error("âŒ [BOTTY-API] Token de autorizaci\xf3n no encontrado"),i.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let n=s.split(" ")[1],{data:{user:l},error:m}=await r.auth.getUser(n);if(m||!l)return console.error("âŒ [BOTTY-API] Error de autenticaci\xf3n:",m),i.Z.json({error:"Token inv\xe1lido"},{status:401});console.log("âœ… [BOTTY-API] Usuario autenticado:",l.id);let{conversation_id:_,message_content:y,conversation_history:h=[]}=await e.json();if(console.log("\uD83E\uDD16 [BOTTY-API] Datos recibidos:",{conversation_id:_,message_length:y?.length,history_count:h?.length}),!_||!y?.trim())return console.error("âŒ [BOTTY-API] Datos faltantes"),i.Z.json({error:"conversation_id y message_content son requeridos"},{status:400});let{data:O,error:T}=await r.from("chat_conversations").select("id, participant_1_id, participant_2_id").eq("id",_).single();if(T||!O)return console.error("âŒ [BOTTY-API] Error obteniendo conversaci\xf3n:",T),i.Z.json({error:"Conversaci\xf3n no encontrada"},{status:404});console.log("\uD83E\uDD16 [BOTTY-API] Conversaci\xf3n encontrada:",{participant_1:O.participant_1_id,participant_2:O.participant_2_id,botId:u.mo});let S=O.participant_1_id===l.id,x=O.participant_2_id===l.id,A=O.participant_1_id===u.mo,w=O.participant_2_id===u.mo;if(console.log("\uD83E\uDD16 [BOTTY-API] Verificaci\xf3n de participantes:",{isParticipant1:S,isParticipant2:x,botIsParticipant1:A,botIsParticipant2:w}),!S&&!x||!A&&!w)return console.error("âŒ [BOTTY-API] Esta conversaci\xf3n no es con AIM Botty"),i.Z.json({error:"Esta conversaci\xf3n no es con AIM Botty"},{status:403});console.log("\uD83E\uDD16 [BOTTY-API] Obteniendo contexto del usuario...");let R=(0,f.iu)("user_context",{userId:l.id}),N=await (0,f.DN)(R,()=>v(l.id,r),3e5),P=null,q=function(e,t){let a=e.toLowerCase();if("super_admin"===t){if(a.match(/sede.*productiv|productiv.*sede|sede.*mÃ¡s.*productiv|mÃ¡s.*productiv.*sede/))return{type:"productivity_by_sede",params:{months:b(a)||6}};if(a.match(/grupo.*productiv|productiv.*grupo|grupo.*mÃ¡s.*productiv/))return{type:"productivity_by_group",params:{months:b(a)||6}};if(a.match(/ranking.*sede|sede.*ranking|ordenar.*sede|sede.*orden|top.*sede/))return{type:"sede_ranking",params:{months:b(a)||6}}}if("admin"===t||"super_admin"===t){if(a.match(/grupo.*productiv|productiv.*grupo|grupo.*mÃ¡s.*productiv/))return{type:"productivity_by_group",params:{months:b(a)||6}};if(a.match(/top.*modelo|mejor.*modelo|modelo.*mÃ¡s.*productiv|ranking.*modelo/)){let e=function(e,t){let a=e.match(t);if(a&&a[1])return parseInt(a[1])}(a,/top\s*(\d+)/)||10;return{type:"top_models",params:{limit:e,months:b(a)||6}}}if(a.match(/tendencia|evoluci|crecimiento|dismin|aumento.*productiv/))return{type:"productivity_trend",params:{months:b(a)||6}};if(a.match(/ranking.*grupo|grupo.*ranking|ordenar.*grupo/))return{type:"group_ranking",params:{months:b(a)||6}}}return a.match(/mi.*estadÃ­stica|mi.*productividad|mi.*rendimiento|cuÃ¡nto.*gan|mis.*datos/)?{type:"model_statistics",params:{months:b(a)||6}}:null}(y,N.role);if(q){console.log("\uD83D\uDCCA [BOTTY-API] Consulta anal\xedtica detectada:",q);try{var t,a,o;let e={productivity_by_sede:"analytics_sede_stats",productivity_by_group:"analytics_group_stats",top_models:"analytics_rankings",productivity_trend:"analytics_trends",period_comparison:"analytics_comparison",group_ranking:"analytics_rankings",sede_ranking:"analytics_sede_stats",model_statistics:"analytics_own_stats"}[q.type]||null;if(e&&(t=N.role,a=e,!(p[t]||[]).includes(a))){let t=(o=N.role,({config_edit_own:"Lo siento, no puedes modificar configuraciones. Solo los administradores pueden hacer cambios en porcentajes, objetivos y configuraciones del sistema.",analytics_group_stats:"No tienes acceso a estad\xedsticas de grupos. Solo puedes ver tus propias estad\xedsticas.",analytics_sede_stats:"No tienes acceso a estad\xedsticas de sedes. Esta funcionalidad est\xe1 disponible solo para super administradores.",query_group_data:"No puedes consultar datos de otros usuarios. Solo tienes acceso a tu propia informaci\xf3n.",recommendations_system:"Las recomendaciones generales del sistema solo est\xe1n disponibles para administradores. Puedo ayudarte con recomendaciones espec\xedficas sobre tus plataformas."})[e]||`Lo siento, tu rol (${o}) no tiene permisos para realizar esta acci\xf3n. Por favor, contacta a tu administrador si necesitas acceso a esta funcionalidad.`);return i.Z.json({error:t},{status:403})}let r=await (0,d._)(q,l.id,N.role);r.success&&(P=r.data,console.log("âœ… [BOTTY-API] Consulta anal\xedtica ejecutada exitosamente"))}catch(e){if(console.error("âŒ [BOTTY-API] Error ejecutando consulta anal\xedtica:",e),e.message?.includes("permisos")||e.message?.includes("permisos"))return i.Z.json({error:e.message||"No tienes permisos para esta consulta"},{status:403})}}await (0,g.Ot)(l.id,_,y,N),console.log("\uD83E\uDD16 [BOTTY-API] Generando respuesta con IA...");let D=await I(y,N,h,P,_);console.log("âœ… [BOTTY-API] Respuesta generada, longitud:",D.length);let{data:L,error:C}=await r.from("chat_messages").insert({conversation_id:_,sender_id:u.mo,content:D,message_type:"ai_response"}).select().single();if(C)return console.error("âŒ [BOTTY-API] Error creando mensaje del bot:",C),i.Z.json({error:"Error generando respuesta del bot"},{status:500});return console.log("âœ… [BOTTY-API] Mensaje del bot creado exitosamente:",L.id),i.Z.json({success:!0,message:L})}catch(e){return console.error("Error en POST /api/chat/aim-botty:",e),i.Z.json({error:"Error interno del servidor"},{status:500})}}async function v(e,t){let{data:a}=await t.from("users").select("id, name, email, role").eq("id",e).single(),o=[];if(a?.role!=="super_admin"){let{data:a}=await t.from("user_groups").select("groups(name)").eq("user_id",e);o=(a||[]).map(e=>e.groups?.name).filter(Boolean)}let r=[];if(a?.role==="modelo"){let{data:a}=await t.from("calculator_config").select("platforms").eq("user_id",e).single();a?.platforms&&(r=a.platforms.filter(e=>e.enabled))}let{data:s}=await t.from("anticipos").select("created_at").eq("user_id",e).order("created_at",{ascending:!1}).limit(1).single();return{userId:a?.id||e,role:a?.role||"modelo",name:a?.name||a?.email?.split("@")[0]||"Usuario",email:a?.email||"",groups:o,portfolio:r,recentActivity:{lastAnticipo:s?.created_at}}}function b(e){if(e.match(/Ãºltimo\s*semestre|semestre/))return 6;if(e.match(/Ãºltimo\s*trimestre|trimestre/))return 3;if(e.match(/Ãºltimo\s*mes/))return 1;if(e.match(/Ãºltimo\s*aÃ±o|aÃ±o/))return 12;let t=e.match(/(\d+)\s*mes/);if(t)return parseInt(t[1])}async function I(e,t,o,r,s){try{let n=process.env.GOOGLE_GEMINI_API_KEY;if(!n)return console.error("âŒ [BOTTY-GEN] GOOGLE_GEMINI_API_KEY no est\xe1 configurada"),console.error("âŒ [BOTTY-GEN] Variables de entorno disponibles:",{hasSupabaseUrl:!0,hasSupabaseKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasGeminiKey:!1}),"Lo siento, el servicio de IA no est\xe1 configurado. Por favor, contacta a tu administrador.";console.log("âœ… [BOTTY-GEN] API Key encontrada, longitud:",n.length);let i=(0,u.Pj)(t.role),c=o.slice(-10).map(e=>{let a=e.sender_id===u.mo;return`${a?"AIM Botty":t.name}: ${e.content}`}).join("\n"),d=await (0,g.YC)(t.userId),{formatSystemKnowledgeForPrompt:p}=await a.e(1190).then(a.bind(a,31190)),f=p(t.role),{getRelevantResources:_,formatResourcesForPrompt:E}=await a.e(7042).then(a.bind(a,27042)),T=await _(e,t);E(T);let v=T.map(e=>e.url),b="";if("super_admin"===t.role||"admin"===t.role){let{getRelevantKnowledge:t,formatKnowledgeForPrompt:o}=await Promise.resolve().then(a.bind(a,30948)),r=await t(e,5);b=o(r)}let I="",S="";if(r&&(S=`
DATOS ANAL\xcdTICOS DISPONIBLES:
${JSON.stringify(r,null,2)}

IMPORTANTE: Usa estos datos anal\xedticos para responder la pregunta del usuario. Presenta la informaci\xf3n de manera clara y estructurada, destacando los resultados m\xe1s importantes. Si hay rankings, menciona los top 3-5. Si hay totales, incl\xfayelos en tu respuesta. Formatea los n\xfameros de manera legible (ej: $1,234.56 USD).
`),"modelo"===t.role){let e="super_admin"!==t.role&&"admin"!==t.role&&t.portfolio&&0!==t.portfolio.length?t.portfolio.filter(e=>e.enabled).map(e=>e.platform_id||e.platform_name):[];I=`
INFORMACI\xd3N DEL MODELO:
- Nombre: ${t.name}
- Plataformas activas: ${t.portfolio?.length||0}
- \xdaltimo anticipo: ${t.recentActivity?.lastAnticipo?new Date(t.recentActivity.lastAnticipo).toLocaleDateString():"N/A"}

PLATAFORMAS EN PORTAFOLIO (SOLO ESTAS):
${t.portfolio?.map(e=>`- ${e.platform_name||e.platform_id}`).join("\n")||"Ninguna configurada"}

âš ï¸ L\xcdMITES Y RESTRICCIONES IMPORTANTES:
- SOLO puedes consultar tus PROPIOS datos y estad\xedsticas
- SOLO puedes recibir informaci\xf3n y tips sobre TUS plataformas del portafolio
- NO puedes acceder a datos de otros modelos
- NO puedes modificar configuraciones (porcentajes, objetivos, etc.)
- NO puedes recibir recomendaciones de plataformas que NO est\xe1n en tu portafolio
- Para cambios de configuraci\xf3n, debes contactar a tu administrador

CAPACIDADES DISPONIBLES:
- Informaci\xf3n sobre TUS plataformas del portafolio \xfanicamente
- Tips de transmisi\xf3n (make up, \xe1ngulos, iluminaci\xf3n) para TUS plataformas
- Consejer\xeda emocional y apoyo
- Tips para potenciar transmisiones en TUS plataformas
- Consultas sobre MIS propias estad\xedsticas y productividad
- Solicitud de anticipos
- Escalamiento a admin cuando sea necesario

PLATAFORMAS PERMITIDAS PARA RECOMENDACIONES:
${e.length>0?e.map(e=>`- ${e}`).join("\n"):"Ninguna - Solo puedes recibir tips sobre tus plataformas configuradas"}
`}else I="admin"===t.role?`
INFORMACI\xd3N DEL ADMIN:
- Nombre: ${t.name}
- Grupos gestionados: ${t.groups?.length||0}
- Grupos: ${t.groups?.join(", ")||"Ninguno"}

CAPACIDADES ANAL\xcdTICAS DISPONIBLES:
- An\xe1lisis de productividad por grupo (grupos que gestionas)
- Top modelos por productividad
- Tendencia de productividad
- Ranking de grupos
- Estad\xedsticas individuales de modelos
`:`
INFORMACI\xd3N DEL SUPER ADMIN:
- Nombre: ${t.name}
- Acceso completo al sistema

CAPACIDADES ANAL\xcdTICAS DISPONIBLES:
- An\xe1lisis de productividad por sede (organizaci\xf3n)
- An\xe1lisis de productividad por grupo
- Top modelos por productividad
- Tendencia de productividad
- Ranking de sedes y grupos
- Comparaci\xf3n entre per\xedodos
- Estad\xedsticas completas del sistema
`;let x=`
${i}

${f}

${I}

${d?`
${d}
`:""}

${S}

${b}

${c?`
HISTORIAL DE CONVERSACI\xd3N (\xfaltimos 10 mensajes):
${c}
`:""}

MENSAJE DEL USUARIO: ${e}

INSTRUCCIONES CR\xcdTICAS DE SEGURIDAD Y L\xcdMITES:
${"modelo"===t.role?`
âš ï¸ RESTRICCIONES ABSOLUTAS PARA MODELOS:
1. SI el usuario pregunta sobre plataformas que NO est\xe1n en su portafolio, debes decirle claramente: 
   "Lo siento, solo puedo ayudarte con informaci\xf3n sobre tus plataformas configuradas: [lista plataformas]. Si tienes preguntas sobre otras plataformas, contacta a tu administrador."

2. SI el usuario intenta consultar datos de otros usuarios, di: 
   "Solo puedo ayudarte con tus propios datos. No tengo acceso a informaci\xf3n de otros usuarios."

3. SI el usuario intenta modificar configuraciones (porcentajes, objetivos, etc.), di: 
   "No puedo modificar configuraciones. Solo los administradores pueden hacer cambios. Si necesitas modificar algo, contacta a tu administrador."

4. SI el usuario pregunta sobre plataformas, SOLO proporciona informaci\xf3n de SUS plataformas del portafolio.
`:""}

INSTRUCCIONES GENERALES:
1. Responde de manera natural y conversacional
2. ${r?"USA los datos anal\xedticos proporcionados para responder con informaci\xf3n precisa y espec\xedfica. Presenta los datos de forma estructurada y legible.":""}
3. ${"modelo"===t.role?"Si el usuario pregunta sobre plataformas, VERIFICA primero que est\xe9n en su portafolio. SOLO proporciona tips de SUS plataformas.":"Si el usuario pregunta sobre plataformas, proporciona tips espec\xedficos"}
4. Si necesita soporte t\xe9cnico, ofrece soluciones pr\xe1cticas primero
5. Si no puedes resolver algo t\xe9cnico, menciona que puedes escalarlo al admin
6. Si pregunta sobre consejer\xeda emocional, s\xe9 emp\xe1tico y comprensivo
7. ${"super_admin"===t.role||"admin"===t.role?"Si el usuario pregunta sobre productividad, sedes, grupos, rankings o an\xe1lisis de datos, puedes proporcionar informaci\xf3n anal\xedtica detallada usando los datos del sistema.":""}
8. Mant\xe9n las respuestas concisas pero \xfatiles. ${r?"Para consultas anal\xedticas, puedes extender la respuesta para incluir toda la informaci\xf3n relevante.":"M\xe1ximo 3-4 p\xe1rrafos."}
9. Usa emojis apropiados pero con moderaci\xf3n
10. Si es una consulta que requiere escalamiento, indica claramente "Puedo escalar esto a tu administrador"
${r?"11. Formatea n\xfameros grandes de manera legible (ej: $1,234.56 USD, $2.5M USD)":""}
${"modelo"===t.role?"12. SIEMPRE verifica que cualquier plataforma mencionada est\xe9 en el portafolio del usuario antes de dar informaci\xf3n sobre ella.":""}
13. IMPORTANTE: Si el usuario pregunta sobre CUALQUIER aspecto del sistema (funcionalidades, c\xf3mo funciona algo, arquitectura, m\xf3dulos, flujos de trabajo, APIs, estructura de datos, permisos, etc.), usa el CONOCIMIENTO DEL SISTEMA proporcionado arriba para dar una respuesta completa y precisa.
14. Para preguntas t\xe9cnicas sobre el sistema, s\xe9 espec\xedfico y detallado. Explica c\xf3mo funcionan las cosas, qu\xe9 tablas se usan, qu\xe9 flujos se ejecutan, etc.
15. Si preguntan "\xbfc\xf3mo funciona X?", explica el flujo completo desde el inicio hasta el final usando el conocimiento del sistema.
16. Si necesitas informaci\xf3n detallada de alguna URL de los recursos disponibles, usa la funci\xf3n fetch_url_content para obtener el contenido. Solo usa esta funci\xf3n si realmente necesitas informaci\xf3n espec\xedfica de la URL.
17. Si obtienes contenido de una URL, \xfasalo para responder de manera precisa y detallada al usuario.
18. ${"super_admin"===t.role||"admin"===t.role?'IMPORTANTE: Si el usuario te pide que guardes informaci\xf3n (ej: "guarda esto", "recuerda esto", "aprende esto"), usa la funci\xf3n save_knowledge para guardar el conocimiento en la base de datos. Aseg\xfarate de extraer un t\xedtulo claro, categor\xeda apropiada, contenido completo y tags relevantes.':""}
19. Si el usuario te pide que recuerdes algo sobre \xe9l (preferencias, metas, informaci\xf3n personal), usa la funci\xf3n save_memory para guardarlo en su memoria personal.
20. Cuando guardes conocimiento o memoria, confirma al usuario que lo has guardado exitosamente.

RESPUESTA:
`,A=null,w=function(){if(!O){let e=process.env.GOOGLE_GEMINI_API_KEY;if(!e)throw Error("GOOGLE_GEMINI_API_KEY no est\xe1 configurada en las variables de entorno");O=new l.$D(e)}return O}(),R=[{name:"fetch_url_content",description:"Obtiene el contenido de una URL espec\xedfica. \xdasala cuando necesites informaci\xf3n detallada de un recurso o enlace web para responder con precisi\xf3n.",parameters:{type:"object",properties:{url:{type:"string",description:"La URL completa del recurso del cual obtener el contenido"}},required:["url"]}}];("super_admin"===t.role||"admin"===t.role)&&R.push({name:"save_knowledge",description:'Guarda informaci\xf3n importante en la base de conocimiento de Botty para que la use en futuras conversaciones. SOLO usa esta funci\xf3n si el usuario (admin/super admin) te pide expl\xedcitamente que guardes algo, o si dice "recuerda esto", "guarda esto", "aprende esto", etc.',parameters:{type:"object",properties:{category:{type:"string",enum:["system_info","tips","policies","procedures","faq","custom"],description:"Categor\xeda del conocimiento"},title:{type:"string",description:"T\xedtulo breve y descriptivo del conocimiento"},content:{type:"string",description:"Contenido completo del conocimiento a guardar"},tags:{type:"array",items:{type:"string"},description:'Tags relevantes para b\xfasqueda (ej: ["makeup", "iluminacion", "anticipos"])'}},required:["category","title","content"]}}),R.push({name:"save_memory",description:"Guarda informaci\xf3n importante sobre el usuario actual en su memoria personal. SOLO usa esta funci\xf3n si el usuario te pide que recuerdes algo sobre \xe9l, o si menciona informaci\xf3n personal relevante (preferencias, metas, problemas, etc.).",parameters:{type:"object",properties:{type:{type:"string",enum:["preference","context","fact","reminder","goal","issue"],description:"Tipo de memoria"},key:{type:"string",description:'Clave \xfanica para esta memoria (ej: "favorite_platform", "preferred_hours")'},value:{type:"string",description:"Valor de la memoria (puede ser texto, n\xfamero, o JSON)"}},required:["type","key","value"]}});let N=v.length>0?`

RECURSOS DISPONIBLES (URLs que puedes consultar si necesitas informaci\xf3n detallada):
${v.map((e,t)=>`${t+1}. ${e}`).join("\n")}
`:"",P=x+N;for(let e of(console.log("\uD83E\uDD16 [BOTTY-GEN] Generando respuesta con IA..."),console.log("\uD83E\uDD16 [BOTTY-GEN] Prompt length:",P.length),["gemini-3.0-pro","gemini-3-pro-preview","gemini-3.0-flash","gemini-3-flash-preview","gemini-2.5-flash","gemini-2.5-pro","gemini-2.5-flash-lite","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"]))try{console.log(`ðŸ¤– [BOTTY-GEN] Intentando con modelo: ${e}`);let a=w.getGenerativeModel({model:e,tools:[{functionDeclarations:R}]}),o=await (0,m.k)(async()=>{let e=await a.generateContent(P),o=e.response||e;for(;o.candidates&&o.candidates[0]?.content?.parts?.[0]?.functionCall;){let r=o.candidates[0].content.parts[0].functionCall;if(console.log(`ðŸ”§ [BOTTY-GEN] Gemini quiere usar funci\xf3n: ${r.name}`),"fetch_url_content"===r.name){let t=r.args?.url;if(!t){console.error("âŒ [BOTTY-GEN] URL no proporcionada en function call");break}console.log(`ðŸŒ [BOTTY-GEN] Obteniendo contenido de: ${t}`);let s=await y(t),n={functionResponse:{name:"fetch_url_content",response:s.success?{success:!0,url:s.url,title:s.title,content:s.content}:{success:!1,url:s.url,error:s.error||"Error desconocido"}}},i=(e=await a.generateContent([{text:P},...o.candidates[0]?.content?.parts||[],n])).response||e;Object.assign(o,i)}else if("save_knowledge"===r.name){if("super_admin"!==t.role&&"admin"!==t.role){let t={functionResponse:{name:"save_knowledge",response:{success:!1,error:"No tienes permisos para guardar conocimiento. Solo admins y super admins pueden hacerlo."}}},r=(e=await a.generateContent([{text:P},...o.candidates[0]?.content?.parts||[],t])).response||e;Object.assign(o,r);continue}let{category:s,title:n,content:i,tags:c}=r.args||{};if(!s||!n||!i){console.error("âŒ [BOTTY-GEN] Par\xe1metros incompletos para save_knowledge");break}console.log(`ðŸ’¾ [BOTTY-GEN] Guardando conocimiento: ${n}`);let l=await (0,h.TK)({category:s,title:n,content:i,tags:c||[],priority:0,is_active:!0,created_by:t.userId}),u={functionResponse:{name:"save_knowledge",response:l?{success:!0,message:`Conocimiento guardado exitosamente: "${n}". Ahora lo usar\xe9 en futuras conversaciones.`}:{success:!1,error:"Error al guardar el conocimiento"}}},d=(e=await a.generateContent([{text:P},...o.candidates[0]?.content?.parts||[],u])).response||e;Object.assign(o,d)}else if("save_memory"===r.name){let{type:n,key:i,value:c}=r.args||{};if(!n||!i||!c){console.error("âŒ [BOTTY-GEN] Par\xe1metros incompletos para save_memory");break}console.log(`ðŸ’¾ [BOTTY-GEN] Guardando memoria: ${i} = ${c}`);let l=await (0,g.Z7)({user_id:t.userId,type:n,key:i,value:c,metadata:{source_conversation_id:s,mentioned_at:new Date().toISOString()}}),u={functionResponse:{name:"save_memory",response:l?{success:!0,message:`Informaci\xf3n guardada en tu memoria. La recordar\xe9 en futuras conversaciones.`}:{success:!1,error:"Error al guardar la memoria"}}},d=(e=await a.generateContent([{text:P},...o.candidates[0]?.content?.parts||[],u])).response||e;Object.assign(o,d)}else{console.warn(`âš ï¸ [BOTTY-GEN] Funci\xf3n desconocida: ${r.name}`);break}}return e}),r=o.response?.text?.()||o.text?.()||"",n="string"==typeof r?r.trim():r;return n=n.replace(/```[\s\S]*?```/g,"").trim(),console.log(`âœ… [BOTTY-GEN] Respuesta generada exitosamente con ${e}, longitud:`,n.length),n}catch(t){if(console.error(`âŒ [BOTTY-GEN] Error con ${e}:`,{message:t?.message,status:t?.status,statusText:t?.statusText}),A=t,t?.message?.includes("404")||t?.message?.includes("not found")||t?.status===404){console.log(`âš ï¸ [BOTTY-GEN] ${e} no disponible, intentando siguiente modelo...`);continue}if(t?.message?.includes("API key")||t?.message?.includes("authentication")||t?.message?.includes("PERMISSION_DENIED"))throw console.error("âŒ [BOTTY-GEN] Error de autenticaci\xf3n, no intentando m\xe1s modelos"),t;if(t?.status===429||t?.message?.includes("rate limit")){console.log(`âš ï¸ [BOTTY-GEN] Rate limit en ${e}, intentando siguiente modelo...`);continue}if(t?.message?.includes("model")||t?.message?.includes("Model"))continue;throw t}if(console.error("âŒ [BOTTY-GEN] Todos los modelos fallaron. \xdaltimo error:",A),A?.message?.includes("API key")||A?.message?.includes("authentication"))return"Lo siento, hay un problema con la configuraci\xf3n del servicio de IA. Por favor, contacta a tu administrador.";if(A?.message?.includes("404")||A?.message?.includes("not found"))return"Lo siento, el modelo de IA no est\xe1 disponible en este momento. Por favor, intenta m\xe1s tarde o contacta a tu administrador.";if(A?.status===429||A?.message?.includes("rate limit"))return"Lo siento, el servicio est\xe1 experimentando alta demanda. Por favor, intenta en unos momentos.";return"Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo o contacta a tu administrador."}catch(e){if(console.error("âŒ [BOTTY-GEN] Error generando respuesta del bot:",e),console.error("âŒ [BOTTY-GEN] Error details:",{message:e?.message,stack:e?.stack,name:e?.name,status:e?.status,statusText:e?.statusText,code:e?.code,response:e?.response?{status:e.response.status,statusText:e.response.statusText,data:e.response.data}:null}),e?.response&&console.error("âŒ [BOTTY-GEN] Error response completo:",JSON.stringify(e.response,null,2)),e?.message?.includes("API key")||e?.message?.includes("authentication")||e?.message?.includes("PERMISSION_DENIED")||e?.message?.includes("no est\xe1 configurada"))return"Lo siento, hay un problema con la configuraci\xf3n del servicio de IA. Por favor, contacta a tu administrador.";if(e?.message?.includes("404")||e?.message?.includes("not found")||e?.message?.includes("Todos los modelos fallaron")||e?.status===404||e?.response?.status===404)return console.error("âŒ [BOTTY-GEN] Todos los modelos fallaron con 404 - verificando API key..."),console.error("âŒ [BOTTY-GEN] API Key presente:",!!process.env.GOOGLE_GEMINI_API_KEY),"Lo siento, el modelo de IA no est\xe1 disponible en este momento. Por favor, intenta m\xe1s tarde o contacta a tu administrador.";if(e?.status===429||e?.message?.includes("rate limit"))return"Lo siento, el servicio est\xe1 experimentando alta demanda. Por favor, intenta en unos momentos.";return console.error("âŒ [BOTTY-GEN] Error desconocido, mostrando mensaje gen\xe9rico"),"Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo o contacta a tu administrador."}}let S=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/chat/aim-botty/route",pathname:"/api/chat/aim-botty",filename:"route",bundlePath:"app/api/chat/aim-botty/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\aim-botty\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:A,serverHooks:w,headerHooks:R,staticGenerationBailout:N}=S,P="/api/chat/aim-botty/route";function q(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:A})}},30948:(e,t,a)=>{a.d(t,{TK:()=>n,formatKnowledgeForPrompt:()=>l,getRelevantKnowledge:()=>u});var o=a(72964);a(91539);let r=process.env.SUPABASE_SERVICE_ROLE_KEY;function s(){return(0,o.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",r,{auth:{autoRefreshToken:!1,persistSession:!1}})}async function n(e){try{let t=s(),{data:a,error:o}=await t.from("bot_knowledge_base").insert({category:e.category,title:e.title,content:e.content,tags:e.tags||[],priority:e.priority||0,is_active:!1!==e.is_active,created_by:e.created_by}).select().single();if(o)return console.error("âŒ [BOT-KNOWLEDGE] Error guardando conocimiento:",o),null;return a}catch(e){return console.error("âŒ [BOT-KNOWLEDGE] Error en saveKnowledge:",e),null}}async function i(e){try{let t=s().from("bot_knowledge_base").select("*").eq("is_active",!0).order("priority",{ascending:!1}).order("updated_at",{ascending:!1});e&&(t=t.eq("category",e));let{data:a,error:o}=await t;if(o)return console.error("âŒ [BOT-KNOWLEDGE] Error obteniendo conocimiento:",o),[];return a||[]}catch(e){return console.error("âŒ [BOT-KNOWLEDGE] Error en getAllKnowledge:",e),[]}}async function c(e){try{let t=s(),{data:a,error:o}=await t.from("bot_knowledge_base").select("*").eq("is_active",!0).order("priority",{ascending:!1});if(o)return console.error("âŒ [BOT-KNOWLEDGE] Error buscando conocimiento:",o),[];let r=e.map(e=>e.toLowerCase());return(a||[]).filter(e=>{let t=(e.tags||[]).map(e=>e.toLowerCase()),a=`${e.title} ${e.content}`.toLowerCase();return r.some(e=>t.some(t=>t.includes(e))||a.includes(e))})}catch(e){return console.error("âŒ [BOT-KNOWLEDGE] Error en searchKnowledge:",e),[]}}function l(e){if(0===e.length)return"";let t=e.map((e,t)=>{let a=e.tags.length>0?` [Tags: ${e.tags.join(", ")}]`:"";return`
${t+1}. [${e.category.toUpperCase()}] ${e.title}${a}
   ${e.content}`}).join("\n");return`
CONOCIMIENTO ADICIONAL DEL SISTEMA (Aprendido por admins):
============================================================
${t}

IMPORTANTE: Usa este conocimiento adicional para responder preguntas relacionadas. Este conocimiento tiene prioridad sobre el conocimiento base del sistema.
`}async function u(e,t=10){try{let a=function(e){let t=e.toLowerCase();return[...["makeup","maquillaje","iluminacion","iluminaci\xf3n","angulos","\xe1ngulos","camara","c\xe1mara","audio","sonido","micr\xf3fono","microfono","anticipo","anticipos","solicitud","aprobar","rechazar","calculadora","ingresos","ganancias","productividad","plataforma","chaturbate","stripchat","myfreecams","grupo","grupos","sede","sedes","organizaci\xf3n","usuario","usuarios","modelo","modelos","admin","administrador","facturaci\xf3n","billing","totales","per\xedodo","periodo","configuraci\xf3n","configuracion","settings","ajustes"].filter(e=>t.includes(e)),...e.toLowerCase().split(/\s+/).filter(e=>e.length>4&&!["para","como","que","con","por","del","las","los","una","uno","este","esta","esto"].includes(e))]}(e),o=await c(a);if(0===o.length)return(await i()).slice(0,t);return o.slice(0,t)}catch(e){return console.error("âŒ [BOT-KNOWLEDGE] Error obteniendo conocimiento relevante:",e),[]}}},91539:(e,t,a)=>{a.d(t,{Ot:()=>l,YC:()=>u,Z7:()=>n,lo:()=>c,ye:()=>i});var o=a(72964);let r=process.env.SUPABASE_SERVICE_ROLE_KEY;function s(){return(0,o.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",r,{auth:{autoRefreshToken:!1,persistSession:!1}})}async function n(e){try{let t=s(),{data:a}=await t.from("bot_memory").select("id").eq("user_id",e.user_id).eq("key",e.key).single();if(a){let{error:o}=await t.from("bot_memory").update({value:e.value,metadata:e.metadata,updated_at:new Date().toISOString()}).eq("id",a.id);if(o)return console.error("âŒ [BOT-MEMORY] Error actualizando memoria:",o),!1}else{let{error:a}=await t.from("bot_memory").insert({user_id:e.user_id,type:e.type,key:e.key,value:e.value,metadata:e.metadata});if(a)return console.error("âŒ [BOT-MEMORY] Error guardando memoria:",a),!1}return!0}catch(e){return console.error("âŒ [BOT-MEMORY] Error en saveMemory:",e),!1}}async function i(e,t){try{let a=s().from("bot_memory").select("*").eq("user_id",e);t&&(a=a.eq("type",t)),a=a.or("metadata->expires_at.is.null,metadata->expires_at.gt."+new Date().toISOString());let{data:o,error:r}=await a.order("updated_at",{ascending:!1});if(r)return console.error("âŒ [BOT-MEMORY] Error obteniendo memorias:",r),[];return(o||[]).map(e=>({...e,value:"string"==typeof e.value?function(e){try{return JSON.parse(e)}catch{return e}}(e.value):e.value}))}catch(e){return console.error("âŒ [BOT-MEMORY] Error en getUserMemories:",e),[]}}async function c(e,t){try{let a=s(),{error:o}=await a.from("bot_memory").delete().eq("user_id",e).eq("key",t);return!o}catch(e){return console.error("âŒ [BOT-MEMORY] Error eliminando memoria:",e),!1}}async function l(e,t,a,o){try{for(let o of function(e){let t=e.toLowerCase(),a=[];if(t.match(/me gusta trabajar|prefiero trabajar|trabajo mejor|soy mÃ¡s productiv/)){let e=t.match(/(maÃ±ana|tarde|noche|madrugada|dÃ­a|evening|morning|afternoon)/);e&&a.push({type:"preference",key:"preferred_hours",value:e[1],confidence:.8})}if(t.match(/mi plataforma favorita|me gusta mÃ¡s|prefiero usar|trabajo mejor en/)){let e=t.match(/(chaturbate|streamate|myfreecams|cam4|camsoda|stripchat|livejasmin|flirt4free|camcontacts|big7|mondo|superfoon)/);e&&a.push({type:"preference",key:"favorite_platforms",value:e[1],confidence:.8})}if(t.match(/mi meta|mi objetivo|quiero ganar|mi objetivo es/)){let e=t.match(/(\d+)\s*(usd|dÃ³lar|dolar)/);e&&a.push({type:"goal",key:"personal_goal",value:parseInt(e[1]),confidence:.7})}return t.match(/tengo un problema|estoy teniendo|no puedo|no funciona|me estÃ¡ pasando/)&&a.push({type:"issue",key:"last_mentioned_issue",value:e.substring(0,200),confidence:.6}),a}(a))await n({user_id:e,type:o.type,key:o.key,value:o.value,metadata:{source_conversation_id:t,mentioned_at:new Date().toISOString(),confidence:o.confidence||.7}})}catch(e){console.error("âŒ [BOT-MEMORY] Error extrayendo memoria:",e)}}async function u(e){try{let t=await i(e);if(0===t.length)return"";let a=["MEMORIA DEL USUARIO (informaci\xf3n recordada de conversaciones anteriores):"],o=t.reduce((e,t)=>(e[t.type]||(e[t.type]=[]),e[t.type].push(t),e),{});if(o.preference?.length>0&&(a.push("\nPREFERENCIAS:"),o.preference.forEach(e=>{a.push(`- ${e.key}: ${d(e.value)}`)})),o.goal?.length>0&&(a.push("\nOBJETIVOS MENCIONADOS:"),o.goal.forEach(e=>{a.push(`- ${e.key}: ${d(e.value)}`)})),o.fact?.length>0&&(a.push("\nINFORMACI\xd3N RELEVANTE:"),o.fact.forEach(e=>{a.push(`- ${e.key}: ${d(e.value)}`)})),o.issue?.length>0){let e=o.issue[0];a.push(`
\xdaLTIMO PROBLEMA MENCIONADO: ${d(e.value)}`)}return a.join("\n")}catch(e){return console.error("âŒ [BOT-MEMORY] Error obteniendo contexto de memoria:",e),""}}function d(e){return"object"==typeof e?JSON.stringify(e):String(e)}},43186:(e,t,a)=>{a.d(t,{k:()=>s});class o{constructor(e){this.requestsPerMinute=15,this.requestsPerDay=1500,this.recentRequests=[],this.dailyRequests=[],this.queue=[],this.processing=!1,e&&(this.requestsPerMinute=e.requestsPerMinute,this.requestsPerDay=e.requestsPerDay),setInterval(()=>this.cleanOldLogs(),6e4)}cleanOldLogs(){let e=Date.now(),t=e-6e4,a=e-864e5;this.recentRequests=this.recentRequests.filter(e=>e.timestamp>t),this.dailyRequests=this.dailyRequests.filter(e=>e.timestamp>a)}canMakeRequest(){this.cleanOldLogs();let e=this.recentRequests.length,t=this.dailyRequests.length;return e<this.requestsPerMinute&&t<this.requestsPerDay}getWaitTime(){if(this.cleanOldLogs(),this.recentRequests.length>=this.requestsPerMinute){let e=this.recentRequests[0];return Math.max(0,6e4-(Date.now()-e.timestamp))}return 0}async waitForCapacity(){if(!this.canMakeRequest())return new Promise((e,t)=>{let a=this.getWaitTime();a>0?(console.log(`â³ [RATE-LIMITER] Esperando ${Math.ceil(a/1e3)}s por l\xedmite de tasa...`),setTimeout(()=>{this.waitForCapacity().then(e).catch(t)},a)):setTimeout(()=>{this.waitForCapacity().then(e).catch(t)},1e3)})}async recordRequest(e){let t={timestamp:Date.now(),tokens:e};this.recentRequests.push(t),this.dailyRequests.push(t),console.log(`ðŸ“Š [RATE-LIMITER] Request registrado. \xdaltimo minuto: ${this.recentRequests.length}/${this.requestsPerMinute}, Hoy: ${this.dailyRequests.length}/${this.requestsPerDay}`)}getStats(){return this.cleanOldLogs(),{requestsLastMinute:this.recentRequests.length,requestsPerMinuteLimit:this.requestsPerMinute,requestsToday:this.dailyRequests.length,requestsPerDayLimit:this.requestsPerDay,canMakeRequest:this.canMakeRequest(),waitTime:this.getWaitTime()}}}let r=new o({requestsPerMinute:15,requestsPerDay:1500});async function s(e,t){await r.waitForCapacity();let a=await e();return await r.recordRequest(t),a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[1638,6206,2964,973,4528],()=>a(13087));module.exports=o})();