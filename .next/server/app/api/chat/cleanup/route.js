"use strict";(()=>{var e={};e.id=2534,e.ids=[2534],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},8808:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>A,originalPathname:()=>g,patchFetch:()=>T,requestAsyncStorage:()=>h,routeModule:()=>E,serverHooks:()=>_,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>f});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>p});var o=r(95419),a=r(69108),n=r(99678),i=r(78070),c=r(72964),u=r(37542);let l=process.env.SUPABASE_SERVICE_ROLE_KEY,d=(0,c.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",l,{auth:{autoRefreshToken:!1,persistSession:!1}});async function p(e){try{console.log("\uD83E\uDDF9 [CLEANUP] Iniciando limpieza de usuarios inactivos..."),await (0,u.GZ)();let{data:e,error:t}=await d.from("chat_user_status").select("*").eq("is_online",!0);t&&console.error("âŒ [CLEANUP] Error obteniendo estad\xedsticas:",t);let r={timestamp:new Date().toISOString(),usersOnline:e?.length||0,cleanupExecuted:!0};return console.log("âœ… [CLEANUP] Limpieza completada:",r),i.Z.json({success:!0,message:"Limpieza de usuarios inactivos completada",stats:r})}catch(e){return console.error("âŒ [CLEANUP] Error en limpieza:",e),i.Z.json({success:!1,error:"Error ejecutando limpieza de usuarios inactivos",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}async function m(e){try{let{data:e,error:t}=await d.from("chat_user_status").select("*").eq("is_online",!0),{data:r,error:s}=await d.from("chat_user_status").select("*");if(t||s)return console.error("âŒ [CLEANUP] Error obteniendo estad\xedsticas:",t||s),i.Z.json({success:!1,error:"Error obteniendo estad\xedsticas"},{status:500});let o={timestamp:new Date().toISOString(),usersOnline:e?.length||0,totalUsers:r?.length||0,usersOffline:(r?.length||0)-(e?.length||0)};return i.Z.json({success:!0,stats:o})}catch(e){return console.error("âŒ [CLEANUP] Error obteniendo estad\xedsticas:",e),i.Z.json({success:!1,error:"Error obteniendo estad\xedsticas",details:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let E=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/chat/cleanup/route",pathname:"/api/chat/cleanup",filename:"route",bundlePath:"app/api/chat/cleanup/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\cleanup\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:S,serverHooks:_,headerHooks:A,staticGenerationBailout:f}=E,g="/api/chat/cleanup/route";function T(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:S})}},37542:(e,t,r)=>{r.d(t,{GZ:()=>c,MY:()=>n,lH:()=>i});var s=r(72964);function o(){{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,s.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1}})}}async function a(e,t){try{console.log(`ðŸ“Š [CHAT-STATUS] Actualizando estado de usuario ${e}: ${t?"EN L\xcdNEA":"OFFLINE"}`);let r=o(),{error:s}=await r.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});s?console.error("âŒ [CHAT-STATUS] Error actualizando estado:",s):console.log(`âœ… [CHAT-STATUS] Estado actualizado exitosamente: ${t?"EN L\xcdNEA":"OFFLINE"}`)}catch(e){console.error("âŒ [CHAT-STATUS] Error general:",e)}}async function n(e){await a(e,!0)}async function i(e){await a(e,!1)}async function c(){try{let e=o(),t=new Date(Date.now()-12e4).toISOString(),{count:r}=await e.from("chat_user_status").select("*",{count:"exact",head:!0}).eq("is_online",!0).or(`updated_at.lt.${t},last_seen.lt.${t}`),{error:s}=await e.from("chat_user_status").update({is_online:!1}).eq("is_online",!0).or(`updated_at.lt.${t},last_seen.lt.${t}`);s?console.error("âŒ [CHAT-STATUS] Error limpiando usuarios inactivos:",s):r&&r>0&&console.log(`âœ… [CHAT-STATUS] ${r} usuarios inactivos (>2 min) marcados como offline`)}catch(e){console.error("âŒ [CHAT-STATUS] Error en limpieza:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1638,6206,2964],()=>r(8808));module.exports=s})();