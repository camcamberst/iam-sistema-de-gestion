"use strict";(()=>{var e={};e.id=2831,e.ids=[2831],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},23088:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>g,originalPathname:()=>f,patchFetch:()=>j,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>_});var t={};s.r(t),s.d(t,{POST:()=>d,dynamic:()=>c});var a=s(95419),o=s(69108),i=s(99678),n=s(78070),u=s(72964);let c="force-dynamic";async function d(e){try{let r=e.headers.get("authorization")||"",s=r.startsWith("Bearer ")?r.slice(7):null;if(!s)return n.Z.json({success:!1,error:"Unauthorized"},{status:401});let{conversation_id:t}=await e.json()||{};if(!t)return n.Z.json({success:!1,error:"conversation_id requerido"},{status:400});let a=(0,u.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{global:{headers:{Authorization:`Bearer ${s}`}}}),{data:{user:o},error:i}=await a.auth.getUser(s);if(i||!o)return n.Z.json({success:!1,error:"No se pudo autenticar usuario"},{status:401});let{data:c,error:d}=await a.from("chat_messages").select("id").eq("conversation_id",t).neq("sender_id",o.id);if(d)return console.error("❌ [API-READ] Error obteniendo mensajes:",d),n.Z.json({success:!1,error:"Error obteniendo mensajes"},{status:500});if(!c||0===c.length)return n.Z.json({success:!0,updated:0});let l=c.map(e=>e.id),{data:p}=await a.from("chat_message_reads").select("message_id").eq("user_id",o.id).in("message_id",l),m=new Set(p?.map(e=>e.message_id)||[]),h=l.filter(e=>!m.has(e)).map(e=>({message_id:e,user_id:o.id}));if(h.length>0){let{data:e,error:r}=await a.from("chat_message_reads").upsert(h,{onConflict:"user_id,message_id",ignoreDuplicates:!0}).select("message_id");if(r)return console.error("❌ [API-READ] Error insertando lecturas:",r),n.Z.json({success:!1,error:"Error insertando lecturas"},{status:200});return console.log(`✅ [API-READ] ${e?.length||0} mensajes marcados como le\xeddos`),n.Z.json({success:!0,updated:e?.length||0})}return n.Z.json({success:!0,updated:0})}catch(e){return console.error("Error en marcar vistos:",e),n.Z.json({success:!1,error:"Error interno"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/messages/read/route",pathname:"/api/chat/messages/read",filename:"route",bundlePath:"app/api/chat/messages/read/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\messages\\read\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:g,staticGenerationBailout:_}=l,f="/api/chat/messages/read/route";function j(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[1638,6206,2964],()=>s(23088));module.exports=t})();