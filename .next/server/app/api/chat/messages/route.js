"use strict";(()=>{var e={};e.id=9402,e.ids=[9402],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},31421:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>v,originalPathname:()=>E,patchFetch:()=>Z,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>j});var s={};t.r(s),t.d(s,{GET:()=>l,POST:()=>m,dynamic:()=>c});var a=t(95419),i=t(69108),n=t(99678),o=t(78070),d=t(72964);let c="force-dynamic",u="https://mhernfrkvwigxdubiozm.supabase.co",p=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(e){try{let r=(0,d.createClient)(u,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return o.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let s=t.split(" ")[1],{data:{user:a},error:i}=await r.auth.getUser(s);if(i||!a)return o.Z.json({error:"Token inv\xe1lido"},{status:401});let{searchParams:n}=new URL(e.url),c=n.get("conversation_id"),l=parseInt(n.get("limit")||"50"),m=parseInt(n.get("offset")||"0");if(!c)return o.Z.json({error:"ID de conversaci\xf3n requerido"},{status:400});let{data:_,error:h}=await r.from("chat_conversations").select("id, participant_1_id, participant_2_id").eq("id",c).single();if(h||!_)return o.Z.json({error:"Conversaci\xf3n no encontrada"},{status:404});if(_.participant_1_id!==a.id&&_.participant_2_id!==a.id)return o.Z.json({error:"No tienes acceso a esta conversaci\xf3n"},{status:403});let{data:g,error:f}=await r.from("chat_messages").select(`
        id,
        content,
        message_type,
        created_at,
        is_read,
        read_at,
        sender_id,
        sender:sender_id(id, name, email, role)
      `).eq("conversation_id",c).order("created_at",{ascending:!1}).range(m,m+l-1);if(f)return console.error("Error obteniendo mensajes:",f),o.Z.json({error:"Error obteniendo mensajes"},{status:500});let v=g.filter(e=>!e.is_read&&e.sender_id!==a.id).map(e=>e.id);return v.length>0&&await r.from("chat_messages").update({is_read:!0,read_at:new Date().toISOString()}).in("id",v),o.Z.json({success:!0,messages:g.reverse(),has_more:g.length===l})}catch(e){return console.error("Error en GET /api/chat/messages:",e),o.Z.json({error:"Error interno del servidor"},{status:500})}}async function m(e){try{let r=(0,d.createClient)(u,p,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return o.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let s=t.split(" ")[1],{data:{user:a},error:i}=await r.auth.getUser(s);if(i||!a)return o.Z.json({error:"Token inv\xe1lido"},{status:401});let{conversation_id:n,content:c,message_type:l="text"}=await e.json();if(!n||!c?.trim())return o.Z.json({error:"ID de conversaci\xf3n y contenido requeridos"},{status:400});let{data:m,error:_}=await r.from("chat_conversations").select("id, participant_1_id, participant_2_id, is_active").eq("id",n).single();if(_||!m)return o.Z.json({error:"Conversaci\xf3n no encontrada"},{status:404});if(!m.is_active)return o.Z.json({error:"Conversaci\xf3n inactiva"},{status:400});if(m.participant_1_id!==a.id&&m.participant_2_id!==a.id)return o.Z.json({error:"No tienes acceso a esta conversaci\xf3n"},{status:403});console.log("\uD83D\uDCE4 [API] Creando mensaje:",{conversation_id:n,sender_id:a.id,content:c.trim(),message_type:l});let{data:h,error:g}=await r.from("chat_messages").insert({conversation_id:n,sender_id:a.id,content:c.trim(),message_type:l}).select(`
        id,
        content,
        message_type,
        created_at,
        sender_id,
        sender:sender_id(id, name, email, role)
      `).single();if(g)return console.error("❌ [API] Error creando mensaje:",g),o.Z.json({error:"Error enviando mensaje"},{status:500});return console.log("✅ [API] Mensaje creado exitosamente:",h),await r.from("chat_user_status").upsert({user_id:a.id,is_online:!0,last_seen:new Date().toISOString()}),o.Z.json({success:!0,message:h})}catch(e){return console.error("Error en POST /api/chat/messages:",e),o.Z.json({error:"Error interno del servidor"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/messages/route",pathname:"/api/chat/messages",filename:"route",bundlePath:"app/api/chat/messages/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\messages\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:v,staticGenerationBailout:j}=_,E="/api/chat/messages/route";function Z(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[1638,6206,2964],()=>t(31421));module.exports=s})();