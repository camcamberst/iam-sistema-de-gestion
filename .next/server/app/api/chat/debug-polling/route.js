"use strict";(()=>{var e={};e.id=9353,e.ids=[9353],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},1322:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>m,originalPathname:()=>v,patchFetch:()=>E,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>b});var o={};t.r(o),t.d(o,{GET:()=>p,dynamic:()=>u});var n=t(95419),i=t(69108),a=t(99678),s=t(78070),d=t(72964);let u="force-dynamic",c=process.env.SUPABASE_SERVICE_ROLE_KEY;async function p(e){try{let r=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",c,{auth:{autoRefreshToken:!1,persistSession:!1}}),t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido",debug:"No se encontr\xf3 header Authorization"},{status:401});let o=t.split(" ")[1];console.log("\uD83D\uDD0D [DEBUG-POLLING] Token recibido:",o.substring(0,20)+"...");let{data:{user:n},error:i}=await r.auth.getUser(o);if(i)return console.error("❌ [DEBUG-POLLING] Error de autenticaci\xf3n:",i),s.Z.json({error:"Error de autenticaci\xf3n",debug:i.message},{status:401});if(!n)return s.Z.json({error:"Usuario no encontrado",debug:"Token v\xe1lido pero sin usuario"},{status:401});console.log("✅ [DEBUG-POLLING] Usuario autenticado:",n.id);let{searchParams:a}=new URL(e.url),u=a.get("conversation_id");if(!u)return s.Z.json({error:"ID de conversaci\xf3n requerido",debug:"No se proporcion\xf3 conversation_id"},{status:400});let{data:p,error:l}=await r.from("chat_conversations").select("id, participant_1_id, participant_2_id, created_at").eq("id",u).single();if(l)return console.error("❌ [DEBUG-POLLING] Error obteniendo conversaci\xf3n:",l),s.Z.json({error:"Error obteniendo conversaci\xf3n",debug:l.message},{status:500});if(!p)return s.Z.json({error:"Conversaci\xf3n no encontrada",debug:`Conversaci\xf3n ${u} no existe`},{status:404});if(!(p.participant_1_id===n.id||p.participant_2_id===n.id))return s.Z.json({error:"Sin permisos para esta conversaci\xf3n",debug:`Usuario ${n.id} no es participante de conversaci\xf3n ${u}`},{status:403});let{data:g,error:h}=await r.from("chat_messages").select("id, content, sender_id, created_at").eq("conversation_id",u).order("created_at",{ascending:!0});if(h)return console.error("❌ [DEBUG-POLLING] Error obteniendo mensajes:",h),s.Z.json({error:"Error obteniendo mensajes",debug:h.message},{status:500});let _={success:!0,debug:{userId:n.id,userEmail:n.email,conversationId:u,conversation:{id:p.id,participant_1_id:p.participant_1_id,participant_2_id:p.participant_2_id,created_at:p.created_at},messagesCount:g?.length||0,lastMessage:g&&g.length>0?{id:g[g.length-1].id,content:g[g.length-1].content.substring(0,50)+"...",sender_id:g[g.length-1].sender_id,created_at:g[g.length-1].created_at}:null,timestamp:new Date().toISOString()}};return console.log("✅ [DEBUG-POLLING] Diagn\xf3stico exitoso:",_.debug),s.Z.json(_)}catch(e){return console.error("❌ [DEBUG-POLLING] Error general:",e),s.Z.json({error:"Error interno del servidor",debug:e instanceof Error?e.message:"Error desconocido"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/chat/debug-polling/route",pathname:"/api/chat/debug-polling",filename:"route",bundlePath:"app/api/chat/debug-polling/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\debug-polling\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:_,headerHooks:m,staticGenerationBailout:b}=l,v="/api/chat/debug-polling/route";function E(){return(0,a.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206,2964],()=>t(1322));module.exports=o})();