"use strict";(()=>{var a={};a.id=1359,a.ids=[1359],a.modules={30517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},13685:a=>{a.exports=require("http")},95687:a=>{a.exports=require("https")},85477:a=>{a.exports=require("punycode")},12781:a=>{a.exports=require("stream")},57310:a=>{a.exports=require("url")},59796:a=>{a.exports=require("zlib")},91987:(a,e,i)=>{i.r(e),i.d(e,{headerHooks:()=>h,originalPathname:()=>v,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>x});var t={};i.r(t),i.d(t,{POST:()=>m,dynamic:()=>l});var r=i(95419),o=i(69108),n=i(99678),s=i(78070),d=i(72964),c=i(43178);let l="force-dynamic",u=process.env.SUPABASE_SERVICE_ROLE_KEY;async function m(a){let e=(0,d.createClient)("https://mhernfrkvwigxdubiozm.supabase.co",u,{auth:{autoRefreshToken:!1,persistSession:!1}});try{let i=a.headers.get("authorization");if(!i?.startsWith("Bearer "))return s.Z.json({error:"Token de autorizaci\xf3n requerido"},{status:401});let t=i.split(" ")[1],{data:{user:r}}=await e.auth.getUser(t);if(!r)return s.Z.json({error:"No autenticado"},{status:401});let{data:o,error:n}=await e.from("users").select("id, role").eq("id",r.id).single();if(n||!o)return s.Z.json({error:"Usuario no encontrado"},{status:401});let d=await a.json(),l=(d.content||"").trim();if(!l)return s.Z.json({error:"Contenido requerido"},{status:400});let u=[];if(Array.isArray(d.userIds)&&d.userIds.length>0&&(u=Array.from(new Set(d.userIds))),0===u.length&&Array.isArray(d.roles)&&d.roles.length>0){let{data:a}=await e.from("users").select("id, role, is_active").in("role",d.roles).eq("is_active",!0);u=(a||[]).map(a=>a.id)}if(0===u.length&&Array.isArray(d.groupIds)&&d.groupIds.length>0){let{data:a}=await e.from("user_groups").select("user_id, group_id").in("group_id",d.groupIds);a&&(u=Array.from(new Set(a.map(a=>a.user_id))))}if(u=u.filter(a=>a&&a!==c.mo&&a!==r.id),0===u.length)return s.Z.json({error:"No hay destinatarios"},{status:400});if("admin"===o.role){let{data:a}=await e.from("users").select("id, role").in("id",u);if((a||[]).some(a=>"admin"===a.role||"super_admin"===a.role))return s.Z.json({error:"No autorizado para enviar a administradores"},{status:403})}let{data:m,error:p}=await e.from("chat_broadcasts").insert({created_by:r.id,scope_type:d.userIds?.length?"users":d.roles?.length?"roles":"groups",scope_values:d.userIds?.length?d.userIds:d.roles?.length?d.roles:d.groupIds||[],title:d.title||null,content:l}).select("id").single(),f=m?.id||null;for(let a of u){let{data:i}=await e.from("chat_conversations").select("id, participant_1_id, participant_2_id").or(`and(participant_1_id.eq.${a},participant_2_id.eq.${c.mo}),and(participant_1_id.eq.${c.mo},participant_2_id.eq.${a})`).maybeSingle(),t=i?.id;if(!t){let{data:i,error:r}=await e.from("chat_conversations").insert({participant_1_id:a,participant_2_id:c.mo}).select("id").single();if(r)continue;t=i?.id}t&&(await e.from("chat_messages").insert({conversation_id:t,sender_id:c.mo,content:l,is_broadcast:!0,no_reply:!0,broadcast_id:f,metadata:{label:"Difusi\xf3n",summary:!1}}),f&&await e.from("chat_broadcast_targets").insert({broadcast_id:f,user_id:a,delivered_at:new Date().toISOString()}))}let{data:_}=await e.from("chat_conversations").select("id").or(`and(participant_1_id.eq.${r.id},participant_2_id.eq.${c.mo}),and(participant_1_id.eq.${c.mo},participant_2_id.eq.${r.id})`).maybeSingle(),g=_?.id;if(!g){let{data:a}=await e.from("chat_conversations").insert({participant_1_id:r.id,participant_2_id:c.mo}).select("id").single();g=a?.id||void 0}if(g){let a=d.userIds?.length?`Usuarios: ${d.userIds.length}`:d.roles?.length?`Roles: ${d.roles.join(", ")}`:d.groupIds?.length?`Grupos: ${d.groupIds.length}`:"Destinatarios definidos";await e.from("chat_messages").insert({conversation_id:g,sender_id:c.mo,content:`Difusi\xf3n enviada (${u.length} destinatarios). ${a}.`,is_broadcast:!0,no_reply:!0,broadcast_id:f,metadata:{label:"Difusi\xf3n",summary:!0,scope:{roles:d.roles||[],groupIds:d.groupIds||[],userIds:d.userIds||[]}}})}return s.Z.json({success:!0,recipients:u.length,broadcast_id:f})}catch(a){return s.Z.json({error:a?.message||"Error interno"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/chat/broadcast/route",pathname:"/api/chat/broadcast",filename:"route",bundlePath:"app/api/chat/broadcast/route"},resolvedPagePath:"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\api\\chat\\broadcast\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:f,staticGenerationAsyncStorage:_,serverHooks:g,headerHooks:h,staticGenerationBailout:x}=p,v="/api/chat/broadcast/route";function b(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},43178:(a,e,i)=>{i.d(e,{Bm:()=>d,Pj:()=>n,jO:()=>r,mo:()=>t,n6:()=>s,y6:()=>o});let t="f91c0968-b587-46cf-9036-05a4ec795c7f",r="AIM Botty",o="aim-botty@agencia-innova.com";function n(a){let e={modelo:`Eres AIM Botty, tu asistente virtual y amigo ðŸ¤–. Ayudo a modelos de webcam de forma cercana y comprensiva.
      Tu personalidad:
      - Super amigable, cercano y emp\xe1tico (como un buen amigo)
      - Tono casual y c\xe1lido, sin formalidades
      - Entiendes perfectamente el mundo del entretenimiento para adultos
      - Sabes c\xf3mo puede ser este trabajo emocionalmente
      - Ofreces tips \xfatiles sin ser condescendiente
      - Das apoyo emocional cuando se necesita
      - Siempre positivo y alentador
      - Hablas de t\xfa, nunca de usted`,admin:`Eres AIM Botty, un asistente virtual cercano y \xfatil para administradores. 
      Tu personalidad:
      - Amigable pero profesional
      - Directo y eficiente
      - Tono cercano, como un compa\xf1ero de trabajo
      - Proactivo y \xfatil
      - Siempre disponible para ayudar`,super_admin:`Eres AIM Botty, un asistente virtual cercano y eficiente para super administradores.
      Tu personalidad:
      - Amigable pero directo
      - Eficiente y claro
      - Tono cercano y profesional
      - Proactivo en reportar lo importante
      - Siempre \xfatil y disponible`};return e[a]||e.modelo}function s(a,e){return({anticipo_pendiente:`ðŸ“‹ Hola ${e.name}! Tienes una nueva solicitud de anticipo pendiente de revisi\xf3n. El administrador la revisar\xe1 pronto.`,anticipo_aprobado:`âœ… \xa1Excelente noticia ${e.name}! Tu solicitud de anticipo ha sido aprobada. El pago se procesar\xe1 seg\xfan lo acordado.`,anticipo_rechazado:`âš ï¸ ${e.name}, tu solicitud de anticipo fue rechazada. Revisa los detalles en [LINK:Mis Anticipos|/admin/model/anticipos/solicitudes] o contacta a tu administrador si tienes dudas.`,anticipo_realizado:`ðŸ’° ${e.name}, tu anticipo ha sido pagado. Por favor [LINK:confirma la recepci\xf3n|/admin/model/anticipos/solicitudes].`,anticipo_confirmado:`âœ… ${e.name}, has confirmado la recepci\xf3n de tu anticipo. \xa1Gracias!`,anticipo_confirmar_recordatorio:`â° ${e.name}, recuerda [LINK:confirmar la recepci\xf3n de tu anticipo pagado|/admin/model/anticipos/solicitudes].`,pagina_confirmada:`ðŸŽ‰ \xa1Felicidades ${e.name}! Se ha confirmado la entrega de tu p\xe1gina. \xa1Excelente trabajo!`,plataforma_entregada:`ðŸ“¦ ${e.name}, tu plataforma ha sido entregada. [LINK:Confirma la recepci\xf3n|/admin/model/portafolio] para activarla en tu calculadora.`,plataforma_confirmada:`âœ… ${e.name}, plataforma confirmada y activada exitosamente en tu calculadora.`,plataforma_agregada:`âž• ${e.name}, se agreg\xf3 una nueva plataforma a tu portafolio. [LINK:Ver portafolio|/admin/model/portafolio]`,plataforma_pendiente_confirmacion:`â³ ${e.name}, hay plataformas entregadas esperando tu confirmaci\xf3n. [LINK:Revisar portafolio|/admin/model/portafolio]`,periodo_cerrado:`ðŸ“Š ${e.name}, el per\xedodo de facturaci\xf3n ha sido cerrado. Puedes [LINK:revisar tu resumen completo|/admin/model/dashboard] en el dashboard.`,metas_alcanzadas:`ðŸ† \xa1Incre\xedble ${e.name}! Has alcanzado tu meta del d\xeda. \xa1Sigue as\xed!`,meta_periodo_alcanzada:`ðŸŽ¯ \xa1Excelente ${e.name}! Has alcanzado tu meta del per\xedodo. \xa1Felicitaciones!`,meta_dia_alcanzada:`â­ ${e.name}, \xa1alcanzaste tu meta del d\xeda!`,recordatorio_ingreso:`ðŸ’¡ ${e.name}, recuerda [LINK:ingresar tus valores del d\xeda|/admin/model/calculator] en Mi Calculadora para mantener tus registros al d\xeda.`,valores_no_ingresados:`âš ï¸ ${e.name}, no has ingresado valores desde hace varios d\xedas. [LINK:Actualiza tus registros|/admin/model/calculator] ahora.`,cuota_minima_riesgo:`ðŸ“‰ ${e.name}, est\xe1s cerca de no alcanzar tu cuota m\xednima. \xa1Sigue as\xed, puedes lograrlo!`,mensaje_importante_admin:`ðŸ“© ${e.name}, tienes un mensaje importante de tu administrador. [LINK:Revisa tu chat|#]`,escalamiento_admin:`ðŸ†˜ ${e.name}, tu consulta ha sido escalada a un administrador. Te responder\xe1n pronto.`,respuesta_escalamiento:`ðŸ’¬ ${e.name}, un administrador respondi\xf3 a tu consulta. [LINK:Revisa tu chat|#]`,nuevo_mensaje_modelo:`ðŸ’¬ ${e.name}, tienes un nuevo mensaje de una modelo. [LINK:Abrir chat|#]`,consulta_escalada:`ðŸš¨ ${e.name}, una modelo necesita asistencia urgente. [LINK:Revisar chat|#]`,modelo_solicita_ayuda:`ðŸ†˜ ${e.name}, una modelo solicit\xf3 ayuda en el chat. [LINK:Abrir chat|#]`,nueva_publicacion:`ðŸ“Œ \xa1Hola ${e.name}! Hay una nueva publicaci\xf3n en el corcho informativo. [LINK:Revisa tu dashboard|/admin/model/dashboard] para ver los detalles.`,cambio_configuracion:`âš™ï¸ ${e.name}, se actualiz\xf3 la configuraci\xf3n del sistema.`,mantenimiento_programado:`ðŸ”§ ${e.name}, el sistema estar\xe1 en mantenimiento. Revisa los detalles.`,nueva_funcionalidad:`âœ¨ ${e.name}, hay una nueva funcionalidad disponible. \xa1\xc9chale un vistazo!`,error_critico:`ðŸš¨ ${e.name}, se detect\xf3 un error cr\xedtico en el sistema. Revisa los logs.`,backup_completado:`ðŸ’¾ ${e.name}, el backup del sistema se complet\xf3 exitosamente.`,actualizacion_sistema:`ðŸ”„ ${e.name}, el sistema ha sido actualizado.`})[a]||`ðŸ”” ${e.name}, tienes una nueva notificaci\xf3n.`}function d(a){return a===t}}};var e=require("../../../../webpack-runtime.js");e.C(a);var i=a=>e(e.s=a),t=e.X(0,[1638,6206,2964],()=>i(91987));module.exports=t})();