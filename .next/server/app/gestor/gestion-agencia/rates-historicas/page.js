(()=>{var e={};e.id=8632,e.ids=[8632],e.modules={47849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},25528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},57310:e=>{"use strict";e.exports=require("url")},59796:e=>{"use strict";e.exports=require("zlib")},8162:(e,r,t)=>{"use strict";t.r(r),t.d(r,{GlobalError:()=>d.a,__next_app__:()=>u,originalPathname:()=>g,pages:()=>c,routeModule:()=>p,tree:()=>l});var a=t(50482),s=t(69108),o=t(62563),d=t.n(o),i=t(68300),n={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>i[e]);t.d(r,n);let l=["",{children:["gestor",{children:["gestion-agencia",{children:["rates-historicas",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,25746)),"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\gestor\\gestion-agencia\\rates-historicas\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,68876)),"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\gestor\\layout.tsx"]}]},{layout:[()=>Promise.resolve().then(t.bind(t,41878)),"C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,69361,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\Users\\camca\\OneDrive\\Documentos\\GitHub\\iam-sistema-de-gestion\\app\\gestor\\gestion-agencia\\rates-historicas\\page.tsx"],g="/gestor/gestion-agencia/rates-historicas/page",u={require:t,loadChunk:()=>Promise.resolve()},p=new a.AppPageRouteModule({definition:{kind:s.x.APP_PAGE,page:"/gestor/gestion-agencia/rates-historicas/page",pathname:"/gestor/gestion-agencia/rates-historicas",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:l}})},28869:(e,r,t)=>{Promise.resolve().then(t.bind(t,68101))},68101:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>d});var a=t(95344),s=t(3729),o=t(72829);function d(){let[e,r]=(0,s.useState)(!0),[t,d]=(0,s.useState)([]),[i,n]=(0,s.useState)(""),[l,c]=(0,s.useState)(new Date().getFullYear()),[g,u]=(0,s.useState)(new Date().getMonth()+1),[p,x]=(0,s.useState)({}),[m,b]=(0,s.useState)(!1),[h,y]=(0,s.useState)(!1),[_,f]=(0,s.useState)(null);(0,s.useEffect)(()=>{k()},[]),(0,s.useEffect)(()=>{i&&v()},[i,l,g]);let k=async()=>{try{let{data:e}=await o.supabase.from("groups").select("id, name").eq("is_active",!0).order("name");e&&(d(e),e.length>0&&!i&&n(e[0].id))}catch(e){console.error("Error cargando grupos:",e)}},v=async()=>{if(i)try{r(!0);let e=`${l}-${String(g).padStart(2,"0")}-01`,t=`${l}-${String(g).padStart(2,"0")}-16`,a=(await o.supabase.auth.getSession()).data.session?.access_token;if(!a)throw Error("No autenticado");let s=await fetch(`/api/gestor/historical-rates?groupId=${i}&year=${l}&month=${g}`,{headers:{Authorization:`Bearer ${a}`}}),d=await s.json();if(!s.ok||!d.success)throw Error(d.error||"Error cargando rates");let n={};d.data&&d.data.forEach(e=>{n[`${e.period_date}_${e.period_type}`]={id:e.id,group_id:e.group_id,period_date:e.period_date,period_type:e.period_type,rate_usd_cop:parseFloat(e.rate_usd_cop),rate_eur_usd:parseFloat(e.rate_eur_usd),rate_gbp_usd:parseFloat(e.rate_gbp_usd),aplicado_at:e.aplicado_at,aplicado_por:e.aplicado_por}});let c=`${e}_1-15`,u=`${t}_16-31`;n[c]||(n[c]={group_id:i,period_date:e,period_type:"1-15",rate_usd_cop:3900,rate_eur_usd:1.01,rate_gbp_usd:1.2}),n[u]||(n[u]={group_id:i,period_date:t,period_type:"16-31",rate_usd_cop:3900,rate_eur_usd:1.01,rate_gbp_usd:1.2}),x(n)}catch(e){console.error("Error cargando rates:",e),f({type:"error",text:e.message||"Error cargando rates hist\xf3ricas"})}finally{r(!1)}},w=(e,r,t)=>{let a="1-15"===e?`${l}-${String(g).padStart(2,"0")}-01`:`${l}-${String(g).padStart(2,"0")}-16`,s=`${a}_${e}`;x(o=>({...o,[s]:{...o[s],group_id:i,period_date:a,period_type:e,[r]:parseFloat(t)||0}}))},j=async e=>{if(!i){f({type:"error",text:"Por favor selecciona un grupo"});return}try{b(!0);let r="1-15"===e?`${l}-${String(g).padStart(2,"0")}-01`:`${l}-${String(g).padStart(2,"0")}-16`,t=p[`${r}_${e}`];if(!t)throw Error("Rate no encontrada");let a=(await o.supabase.auth.getSession()).data.session?.access_token;if(!a)throw Error("No autenticado");let s=await fetch("/api/gestor/historical-rates",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({groupId:t.group_id,periodDate:t.period_date,periodType:t.period_type,rateUsdCop:t.rate_usd_cop,rateEurUsd:t.rate_eur_usd,rateGbpUsd:t.rate_gbp_usd})}),d=await s.json();if(!s.ok||!d.success)throw Error(d.error||"Error guardando rates");f({type:"success",text:`Rates de ${e} guardadas correctamente`}),setTimeout(()=>f(null),3e3),await v()}catch(e){console.error("Error guardando rates:",e),f({type:"error",text:e.message||"Error guardando rates hist\xf3ricas"})}finally{b(!1)}},N=async e=>{if(!i){f({type:"error",text:"Por favor selecciona un grupo"});return}if(confirm(`\xbfEst\xe1s seguro de aplicar las rates de ${e}? Esto recalcular\xe1 todos los valores hist\xf3ricos de este per\xedodo.`))try{y(!0);let r="1-15"===e?`${l}-${String(g).padStart(2,"0")}-01`:`${l}-${String(g).padStart(2,"0")}-16`,t=(await o.supabase.auth.getSession()).data.session?.access_token;if(!t)throw Error("No autenticado");let a=await fetch("/api/gestor/historical-rates/apply",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({groupId:i,periodDate:r,periodType:e})}),s=await a.json();if(!a.ok||!s.success)throw Error(s.error||"Error aplicando rates");f({type:"success",text:`Rates aplicadas correctamente. ${s.data?.updatedCount||0} registros actualizados.`}),setTimeout(()=>f(null),5e3),await v()}catch(e){console.error("Error aplicando rates:",e),f({type:"error",text:e.message||"Error aplicando rates hist\xf3ricas"})}finally{y(!1)}},S=`${l}-${String(g).padStart(2,"0")}-01`,$=`${l}-${String(g).padStart(2,"0")}-16`,E=`${$}_16-31`,C=p[`${S}_1-15`],P=p[E];return e?a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-gray-600 border-t-gray-400 rounded-full"})}):a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 p-6",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-6",children:[a.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Configurar Rates Hist\xf3ricas"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Configura rates hist\xf3ricas para recalcular per\xedodos pasados. Estas rates SOLO afectan a per\xedodos hist\xf3ricos."})]}),_&&a.jsx("div",{className:`mb-4 p-4 rounded-lg ${"success"===_.type?"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200":"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200"}`,children:_.text}),a.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Grupo/Sede"}),(0,a.jsxs)("select",{value:i,onChange:e=>n(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",children:[a.jsx("option",{value:"",children:"Seleccionar grupo"}),t.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"A\xf1o"}),a.jsx("input",{type:"number",value:l,onChange:e=>c(parseInt(e.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",min:"2020",max:new Date().getFullYear()})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Mes"}),a.jsx("select",{value:g,onChange:e=>u(parseInt(e.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",children:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"].map((e,r)=>a.jsx("option",{value:r+1,children:e},r+1))})]})]})}),i&&(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Per\xedodo 1 (1-15)"}),C?.aplicado_at&&a.jsx("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded",children:"Aplicado"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"USD → COP"}),a.jsx("input",{type:"number",step:"0.0001",value:C?.rate_usd_cop||"",onChange:e=>w("1-15","rate_usd_cop",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"EUR → USD"}),a.jsx("input",{type:"number",step:"0.0001",value:C?.rate_eur_usd||"",onChange:e=>w("1-15","rate_eur_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"GBP → USD"}),a.jsx("input",{type:"number",step:"0.0001",value:C?.rate_gbp_usd||"",onChange:e=>w("1-15","rate_gbp_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{className:"flex gap-2 pt-2",children:[a.jsx("button",{onClick:()=>j("1-15"),disabled:m,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:m?"Guardando...":"Guardar Rates"}),a.jsx("button",{onClick:()=>N("1-15"),disabled:h||!C?.id,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:h?"Aplicando...":"Aplicar Rates"})]})]})]}),(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Per\xedodo 2 (16-31)"}),P?.aplicado_at&&a.jsx("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded",children:"Aplicado"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"USD → COP"}),a.jsx("input",{type:"number",step:"0.0001",value:P?.rate_usd_cop||"",onChange:e=>w("16-31","rate_usd_cop",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"EUR → USD"}),a.jsx("input",{type:"number",step:"0.0001",value:P?.rate_eur_usd||"",onChange:e=>w("16-31","rate_eur_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"GBP → USD"}),a.jsx("input",{type:"number",step:"0.0001",value:P?.rate_gbp_usd||"",onChange:e=>w("16-31","rate_gbp_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{className:"flex gap-2 pt-2",children:[a.jsx("button",{onClick:()=>j("16-31"),disabled:m,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:m?"Guardando...":"Guardar Rates"}),a.jsx("button",{onClick:()=>N("16-31"),disabled:h||!P?.id,className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:h?"Aplicando...":"Aplicar Rates"})]})]})]})]}),a.jsx("div",{className:"mt-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4",children:(0,a.jsxs)("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:[a.jsx("strong",{children:"⚠️ Importante:"})," Las rates hist\xf3ricas SOLO afectan a per\xedodos pasados en ",a.jsx("code",{children:"calculator_history"}),'. NO afectan a rates actuales ni a per\xedodos en curso. Al hacer clic en "Aplicar Rates", se recalcular\xe1n todos los valores hist\xf3ricos del per\xedodo seleccionado usando estas rates.']})})]})})}},25746:(e,r,t)=>{"use strict";t.r(r),t.d(r,{$$typeof:()=>o,__esModule:()=>s,default:()=>d});let a=(0,t(86843).createProxy)(String.raw`C:\Users\camca\OneDrive\Documentos\GitHub\iam-sistema-de-gestion\app\gestor\gestion-agencia\rates-historicas\page.tsx`),{__esModule:s,$$typeof:o}=a,d=a.default}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6611,6654,1586,1582,4659],()=>t(8162));module.exports=a})();