(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8603],{2344:function(e,t,a){"use strict";var n=a(7437),o=a(2265);t.Z=()=>{let[e,t]=(0,o.useState)("light"),[a,r]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{r(!0);let e=localStorage.getItem("theme");if(e)t(e),document.documentElement.classList.toggle("dark","dark"===e);else{let e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";t(e),document.documentElement.classList.toggle("dark","dark"===e)}},[]),a)?(0,n.jsx)("button",{"data-theme-toggle":!0,onClick:()=>{let a="light"===e?"dark":"light";document.documentElement.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",t(a),localStorage.setItem("theme",a),document.documentElement.classList.toggle("dark","dark"===a);let n=document.querySelector("[data-theme-toggle]");n&&(n.style.transform="scale(0.95)",setTimeout(()=>{n.style.transform="scale(1)"},150)),setTimeout(()=>{document.documentElement.style.transition="",document.body.style.transition=""},600)},className:"p-2.5 text-gray-600 hover:text-gray-900 hover:bg-white/60 rounded-lg transition-all duration-200 hover:shadow-sm   dark:text-gray-300 dark:hover:text-white dark:hover:bg-gray-700",title:"light"===e?"Cambiar a modo oscuro":"Cambiar a modo claro",children:"light"===e?(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"})}):(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h1M3 12H2m15.325 6.675l-.707.707M6.707 6.707l-.707-.707m10.626 0l.707-.707M6.707 17.293l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z"})})}):(0,n.jsx)("div",{className:"p-2.5 text-gray-600 rounded-lg",children:(0,n.jsx)("div",{className:"w-5 h-5"})})}},1014:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var n=a(7437),o=a(2265),r=a(5922),s=a(8115);function i(e){let{userId:t,userRole:a}=e,[i,c]=(0,o.useState)(!1),[l,d]=(0,o.useState)([]),[u,h]=(0,o.useState)([]),[g,m]=(0,o.useState)(null),[x,f]=(0,o.useState)([]),[v,p]=(0,o.useState)(""),[D,C]=(0,o.useState)(!1),[j,w]=(0,o.useState)(!0),[y,b]=(0,o.useState)(!1),[N,E]=(0,o.useState)({online:!0,offline:!1}),[_,W]=(0,o.useState)(!1),[k,A]=(0,o.useState)(!1),[S,T]=(0,o.useState)(0),[I,L]=(0,o.useState)(!1),[M,O]=(0,o.useState)(null),[z,U]=(0,o.useState)(null),H=(0,o.useRef)(null),[B,F]=(0,o.useState)(null),J=(0,o.useRef)(null),[V,R]=(0,o.useState)(!1),P=e=>"modelo"===e.role?e.email.split("@")[0]:e.name;(0,o.useEffect)(()=>{(async()=>{let{data:{session:e}}=await r.O.auth.getSession();F(e)})()},[]),(0,o.useEffect)(()=>{let e;let t=()=>{R(!0),clearTimeout(e),e=setTimeout(()=>{R(!1)},150)};return window.addEventListener("scroll",t,{passive:!0}),()=>{window.removeEventListener("scroll",t),clearTimeout(e)}},[]),(0,o.useEffect)(()=>{if(!t)return;let e=async()=>{try{await (0,s.do)(t)}catch(e){console.error("❌ [ChatWidget] Error enviando heartbeat:",e)}};e(),J.current=setInterval(e,3e4);let a=async()=>{try{await (0,s.lH)(t)}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}},n=async()=>{document.hidden?(J.current&&clearInterval(J.current),J.current=setInterval(e,6e4)):(J.current&&clearInterval(J.current),J.current=setInterval(e,3e4),e())};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",n),()=>{J.current&&clearInterval(J.current),window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",n),(0,s.lH)(t).catch(e=>{console.error("❌ [ChatWidget] Error marcando usuario offline en cleanup:",e)})}},[t]);let q=async()=>{if(B)try{let e=await fetch("/api/chat/conversations",{headers:{Authorization:"Bearer ".concat(B.access_token)}}),a=await e.json();if(a.success){d(a.conversations);let e=a.conversations.reduce((e,a)=>a.last_message&&a.last_message.sender_id!==t?e+1:e,0);console.log("\uD83D\uDCCA [ChatWidget] Mensajes no le\xeddos detectados:",{unread:e,lastUnreadCount:S,hasNewMessage:e>S}),!(e>0)||i||I||(console.log("\uD83D\uDD14 [ChatWidget] \xa1NUEVO MENSAJE DETECTADO! Activando notificaci\xf3n..."),L(!0),en()),e>S&&S>=0&&!I&&(console.log("\uD83D\uDD14 [ChatWidget] \xa1INCREMENTO DE MENSAJES DETECTADO!",{unread:e,lastUnreadCount:S,isOpen:i,notificationTriggered:I}),i?console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - No activando notificaci\xf3n"):(console.log("\uD83D\uDD14 [ChatWidget] Chat cerrado - Activando notificaci\xf3n autom\xe1tica..."),L(!0),en())),i&&I&&(console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando notificaciones..."),L(!1),W(!1),A(!1)),T(e)}}catch(e){console.error("Error cargando conversaciones:",e)}},Z=async()=>{if(B)try{let e=await fetch("/api/chat/users",{headers:{Authorization:"Bearer ".concat(B.access_token)}}),t=await e.json();t.success&&h(t.users)}catch(e){console.error("Error cargando usuarios:",e)}},G=async e=>{if(B)try{let a=await fetch("/api/chat/messages?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(B.access_token)}}),n=await a.json();if(n.success)f(e=>{let a=n.messages;if(e.length!==a.length||e.some((e,t)=>!a[t]||e.id!==a[t].id)){if(console.log("\uD83D\uDCE8 [ChatWidget] Mensajes actualizados:",{previous:e.length,new:a.length}),a.length>e.length){let e=a[a.length-1];e&&e.sender_id!==t&&(console.log("\uD83D\uDD14 [ChatWidget] Nuevo mensaje detectado via polling, activando notificaci\xf3n..."),en())}return a}return e}),m(e);else{if(console.error("❌ [ChatWidget] Error en respuesta de mensajes:",n),n.error&&(n.error.includes("no encontrada")||n.error.includes("no existe"))){console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante carga de mensajes, preparando nueva conversaci\xf3n..."),await Y(e);return}await X(e)}}catch(t){console.error("❌ [ChatWidget] Error cargando mensajes:",t),await X(e)}},Y=async e=>{if(B){console.log("\uD83D\uDD04 [ChatWidget] Manejando conversaci\xf3n eliminada:",e);try{if(await q(),e.startsWith("temp_"))console.log("\uD83E\uDDF9 [ChatWidget] Limpiando conversaci\xf3n temporal eliminada"),f([]),O(null),w(!0);else{console.log("\uD83D\uDCA1 [ChatWidget] Conversaci\xf3n eliminada, preparando nueva conversaci\xf3n autom\xe1ticamente");let a=x[x.length-1];if(a&&a.sender_id!==t){let e=a.sender_id,t=u.find(t=>t.id===e);if(t){console.log("\uD83C\uDFAF [ChatWidget] Usuario identificado para nueva conversaci\xf3n:",t.name||t.email),O(t),m("temp_".concat(e)),f([]);let a={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Conversaci\xf3n reiniciada con ".concat(P(t),". Puedes continuar chateando."),sender_id:"system",conversation_id:"temp_".concat(e),created_at:new Date().toISOString(),is_system_message:!0};f([a]);return}}console.log("⚠️ [ChatWidget] No se pudo identificar al usuario, mostrando mensaje gen\xe9rico"),f([]),O(null);let n={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Esta conversaci\xf3n fue eliminada. Selecciona un usuario para iniciar una nueva conversaci\xf3n.",sender_id:"system",conversation_id:e,created_at:new Date().toISOString(),is_system_message:!0};f([n]),w(!0)}}catch(e){console.error("❌ [ChatWidget] Error manejando conversaci\xf3n eliminada:",e),f([]),O(null),w(!0)}}},X=async e=>{if(B)try{console.log("\uD83D\uDD0D [ChatWidget] Ejecutando diagn\xf3stico de polling...");let t=await fetch("/api/chat/debug-polling?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(B.access_token)}}),a=await t.json();a.success?console.log("✅ [ChatWidget] Diagn\xf3stico exitoso:",a.debug):console.error("❌ [ChatWidget] Diagn\xf3stico fall\xf3:",a)}catch(e){console.error("❌ [ChatWidget] Error en diagn\xf3stico:",e)}},K=async()=>{if(v.trim()&&g&&B){console.log("\uD83D\uDCE4 [ChatWidget] Enviando mensaje:",{content:v.trim(),conversationId:g,userId:t}),C(!0);try{let e=g;if(g.startsWith("temp_")){console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n temporal...");let t=g.replace("temp_",""),a=await $(t);if(a)e=a,m(a),O(null),console.log("✅ [ChatWidget] Conversaci\xf3n creada:",a);else{console.error("❌ [ChatWidget] Error creando conversaci\xf3n");return}}let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(B.access_token)},body:JSON.stringify({conversation_id:e,content:v.trim()})}),a=await t.json();console.log("\uD83D\uDCE8 [ChatWidget] Respuesta del servidor:",a),a.success?(console.log("✅ [ChatWidget] Mensaje enviado exitosamente"),p(""),setTimeout(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Recargando mensajes como fallback..."),await G(e)},1e3),await q()):(console.error("❌ [ChatWidget] Error en respuesta del servidor:",a),a.error&&(a.error.includes("no encontrada")||a.error.includes("no existe"))&&(console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante env\xedo, preparando nueva conversaci\xf3n..."),await Y(e)))}catch(e){console.error("❌ [ChatWidget] Error enviando mensaje:",e)}finally{C(!1)}}},Q=async e=>{if(!B)return;console.log("\uD83D\uDCAC [ChatWidget] Abriendo chat con usuario:",e);let t=l.find(t=>t.other_participant.id===e);if(t)console.log("\uD83D\uDCC2 [ChatWidget] Conversaci\xf3n existente encontrada:",t.id),w(!1),m(t.id),O(null),await G(t.id);else{let t=u.find(t=>t.id===e);console.log("\uD83C\uDD95 [ChatWidget] Iniciando nueva conversaci\xf3n con:",(null==t?void 0:t.name)||(null==t?void 0:t.email)),w(!1),m("temp_".concat(e)),O(t||null),f([])}},$=async e=>{if(B){try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(B.access_token)},body:JSON.stringify({participant_2_id:e})}),a=await t.json();if(a.success)return a.conversation.id}catch(e){console.error("Error creando conversaci\xf3n:",e)}return null}},ee=async e=>{if(B)try{let t=await fetch("/api/chat/conversations?conversation_id=".concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(B.access_token)}}),a=await t.json();a.success?(console.log("\uD83D\uDDD1️ [ChatWidget] Conversaci\xf3n eliminada exitosamente"),await q(),g===e&&(m(null),f([]),O(null),console.log("\uD83E\uDDF9 [ChatWidget] Estado de chat limpiado despu\xe9s de eliminaci\xf3n")),U(null)):console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",a.error)}catch(e){console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",e)}},et=e=>{E(t=>({...t,[e]:!t[e]}))},ea=()=>{try{console.log("\uD83C\uDFB5 [ChatWidget] Iniciando reproducci\xf3n de sonido...");let e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),a=e.createGain();t.connect(a),a.connect(e.destination),t.type="sine";let n=[400,600,800,1e3,1200,1e3,800,600,400,600,800,1e3,1200];console.log("\uD83C\uDFBC [ChatWidget] Configurando frecuencias:",n),n.forEach((a,o)=>{let r=e.currentTime+o/n.length*.5;t.frequency.setValueAtTime(a,r)}),a.gain.setValueAtTime(0,e.currentTime),a.gain.linearRampToValueAtTime(.4,e.currentTime+.02),a.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5),console.log("✅ [ChatWidget] Sonido de notificaci\xf3n reproducido exitosamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido de notificaci\xf3n:",e)}},en=()=>{if(console.log("\uD83D\uDD0D [ChatWidget] triggerNotification llamada - isOpen:",i),i){console.log("\uD83D\uDCC2 [ChatWidget] Chat abierto - NO activando notificaciones");return}console.log("\uD83D\uDD14 [ChatWidget] TRIGGER NOTIFICATION - Activando notificaciones (chat cerrado)..."),console.log("\uD83D\uDD0A [ChatWidget] Reproduciendo sonido de notificaci\xf3n...");try{ea(),console.log("✅ [ChatWidget] Sonido iniciado correctamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido:",e)}console.log("\uD83D\uDCAB [ChatWidget] Activando parpadeo del bot\xf3n..."),W(!0),A(!0),console.log("\uD83D\uDCC2 [ChatWidget] Abriendo chat autom\xe1ticamente..."),c(!0),setTimeout(()=>{console.log("⏹️ [ChatWidget] Deteniendo latido de coraz\xf3n..."),W(!1)},6e3)};(0,o.useEffect)(()=>{B&&(q(),Z())},[B]),(0,o.useEffect)(()=>{if(!B)return;let e=setInterval(()=>{Z()},1e4);return()=>{clearInterval(e)}},[B]),(0,o.useEffect)(()=>{if(!B||!g)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de mensajes como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando mensajes nuevos..."),await G(g)},3e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de mensajes..."),clearInterval(e)}},[B,g]),(0,o.useEffect)(()=>{if(!B)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de conversaciones como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando conversaciones actualizadas..."),await q()},5e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de conversaciones..."),clearInterval(e)}},[B]),(0,o.useEffect)(()=>{var e;null===(e=H.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[x]),(0,o.useEffect)(()=>{if(!B||!t)return;console.log("\uD83D\uDD14 [ChatWidget] Configurando suscripci\xf3n en tiempo real...");let e=r.O.channel("chat-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},async e=>{let a=e.new;console.log("\uD83D\uDCE8 [ChatWidget] Nuevo mensaje recibido:",a);try{let{data:e,error:n}=await r.O.from("chat_conversations").select("participant_1_id, participant_2_id").eq("id",a.conversation_id).single();if(n||!e){console.log("❌ [ChatWidget] Error verificando conversaci\xf3n:",n);return}e.participant_1_id===t||e.participant_2_id===t?(console.log("✅ [ChatWidget] Usuario es participante de la conversaci\xf3n"),g===a.conversation_id&&(console.log("\uD83D\uDCAC [ChatWidget] Agregando mensaje a conversaci\xf3n activa"),f(e=>e.some(e=>e.id===a.id)?(console.log("⚠️ [ChatWidget] Mensaje ya existe en la lista, no agregando"),e):(console.log("➕ [ChatWidget] Agregando nuevo mensaje a la lista"),[...e,a]))),console.log("\uD83D\uDD04 [ChatWidget] Actualizando lista de conversaciones..."),q(),a.sender_id!==t?(console.log("\uD83D\uDD14 [ChatWidget] Activando notificaci\xf3n para mensaje de otro usuario"),en()):console.log("\uD83D\uDC64 [ChatWidget] Mensaje del usuario actual, no notificando")):console.log("❌ [ChatWidget] Usuario no es participante de la conversaci\xf3n")}catch(e){console.error("❌ [ChatWidget] Error en verificaci\xf3n de conversaci\xf3n:",e)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_conversations"},e=>{let t=e.new;console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n actualizada:",t),l.some(e=>e.id===t.id)&&(console.log("✅ [ChatWidget] Conversaci\xf3n relevante actualizada, recargando lista..."),q())}).subscribe(e=>{console.log("\uD83D\uDCE1 [ChatWidget] Estado de suscripci\xf3n:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n en tiempo real"),r.O.removeChannel(e)}},[B,t]),(0,o.useEffect)(()=>{},[l,g]);let eo=()=>{let e=!i;c(e),e&&B&&q(),e?(A(!1),W(!1),L(!1),console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando todas las notificaciones")):O(null)};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:eo,onContextMenu:e=>{e.preventDefault(),console.log("\uD83E\uDDEA [ChatWidget] Prueba manual de notificaci\xf3n"),en()},className:"fixed bottom-6 right-6 w-10 h-10 bg-gray-900 hover:w-16 hover:h-10 text-white rounded-2xl shadow-lg transition-all duration-300 flex items-center justify-center z-[9995] group overflow-hidden ".concat(_?"animate-heartbeat bg-gradient-to-r from-red-500 via-pink-500 to-red-600":""),"aria-label":"Abrir chat de soporte (clic derecho para probar notificaci\xf3n)",children:(0,n.jsxs)("div",{className:"flex items-center justify-center",children:[(0,n.jsx)("span",{className:"text-white font-bold text-sm group-hover:hidden",children:"A"}),(0,n.jsx)("span",{className:"text-white font-bold text-xs hidden group-hover:block whitespace-nowrap",children:"AIM"})]})}),i&&(0,n.jsxs)("div",{className:"fixed bottom-6 right-24 w-80 h-[500px] bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9995]",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-white font-bold text-sm",children:M?P(M).charAt(0).toUpperCase():"AIM"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-white font-semibold",children:M?P(M):"AIM Assistant"}),(0,n.jsx)("p",{className:"text-gray-400 text-xs",children:M?M.role:"Soporte y tips"})]})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,n.jsx)("button",{onClick:()=>{w(!j),m(null),O(null)},className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":j?"Ver conversaciones":"Ver usuarios",children:j?(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}):(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),(0,n.jsx)("button",{onClick:eo,className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar chat",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),j&&!g&&(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[(0,n.jsx)("h4",{className:"text-white text-sm font-medium mb-3",children:"Usuarios disponibles"}),(0,n.jsxs)("div",{className:"mb-4",children:[(0,n.jsxs)("button",{onClick:()=>et("online"),className:"flex items-center space-x-2 mb-2 w-full hover:bg-gray-700 rounded-lg p-1 transition-colors",children:[(0,n.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),(0,n.jsxs)("span",{className:"text-green-400 text-xs font-medium",children:["En l\xednea (",u.filter(e=>e.is_online).length,")"]}),(0,n.jsx)("svg",{className:"w-3 h-3 text-green-400 transition-transform duration-200 ml-auto ".concat(N.online?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),N.online&&(0,n.jsx)("div",{className:"space-y-2",children:u.filter(e=>e.is_online).map(e=>(0,n.jsxs)("button",{onClick:()=>Q(e.id),className:"w-full flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-lg transition-colors",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-white text-xs font-medium",children:P(e).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1 text-left",children:[(0,n.jsx)("div",{className:"text-white text-sm font-medium",children:P(e)}),(0,n.jsx)("div",{className:"text-gray-400 text-xs",children:e.role})]}),(0,n.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full"})]},e.id))})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("button",{onClick:()=>et("offline"),className:"flex items-center space-x-2 mb-2 w-full hover:bg-gray-700 rounded-lg p-1 transition-colors",children:[(0,n.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full"}),(0,n.jsxs)("span",{className:"text-gray-400 text-xs font-medium",children:["Offline (",u.filter(e=>!e.is_online).length,")"]}),(0,n.jsx)("svg",{className:"w-3 h-3 text-gray-400 transition-transform duration-200 ml-auto ".concat(N.offline?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),N.offline&&(0,n.jsx)("div",{className:"space-y-2",children:u.filter(e=>!e.is_online).map(e=>(0,n.jsxs)("button",{onClick:()=>Q(e.id),className:"w-full flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-lg transition-colors opacity-75",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-white text-xs font-medium",children:P(e).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1 text-left",children:[(0,n.jsx)("div",{className:"text-white text-sm font-medium",children:P(e)}),(0,n.jsx)("div",{className:"text-gray-400 text-xs",children:e.role})]}),(0,n.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full"})]},e.id))})]})]}),!j&&!g&&(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",children:[(0,n.jsx)("h4",{className:"text-white text-sm font-medium mb-3",children:"Conversaciones"}),(0,n.jsx)("div",{className:"space-y-1",children:l.map(e=>{var t;return(0,n.jsxs)("div",{className:"group flex items-center space-x-2 p-2 hover:bg-gray-700 rounded-lg transition-colors",children:[(0,n.jsxs)("button",{onClick:()=>G(e.id),className:"flex-1 flex items-center space-x-2 min-w-0",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0",children:(0,n.jsx)("span",{className:"text-white text-xs font-medium",children:P(e.other_participant).charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,n.jsx)("div",{className:"text-white text-sm font-medium truncate",children:P(e.other_participant)}),(0,n.jsx)("div",{className:"text-gray-400 text-xs truncate",children:(null===(t=e.last_message)||void 0===t?void 0:t.content)||"Sin mensajes"})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[(0,n.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(e.other_participant.is_online?"bg-green-500":"bg-gray-500")}),(0,n.jsx)("div",{className:"text-gray-400 text-xs",children:new Date(e.last_message_at).toLocaleDateString()})]})]}),(0,n.jsx)("button",{onClick:()=>U(e.id),className:"opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-400 transition-all",title:"Eliminar conversaci\xf3n (disponible para todos los participantes)",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},e.id)})})]}),g&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,n.jsxs)("div",{className:"space-y-4",children:[x.map(e=>e.is_system_message?(0,n.jsx)("div",{className:"flex justify-center",children:(0,n.jsx)("div",{className:"max-w-[80%] p-2 rounded-lg bg-yellow-600/20 border border-yellow-600/30 text-yellow-200 text-center",children:(0,n.jsx)("div",{className:"text-sm",children:e.content})})},e.id):(0,n.jsx)("div",{className:"flex ".concat(e.sender_id===t?"justify-end":"justify-start"),children:(0,n.jsxs)("div",{className:"max-w-[80%] p-3 rounded-lg ".concat(e.sender_id===t?"bg-blue-600 text-white":"bg-gray-700 text-white"),children:[(0,n.jsx)("div",{className:"text-sm",children:e.content}),(0,n.jsx)("div",{className:"text-xs opacity-70 mt-1",children:new Date(e.created_at).toLocaleTimeString()})]})},e.id)),(0,n.jsx)("div",{ref:H})]})}),(0,n.jsxs)("div",{className:"p-4 border-t border-gray-700 bg-gray-800",children:[(0,n.jsxs)("div",{className:"flex items-end space-x-2",children:[(0,n.jsx)("div",{className:"flex-1 relative",children:(0,n.jsx)("textarea",{value:v,onChange:e=>p(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),K())},placeholder:"Escribe tu mensaje...",className:"w-full resize-none border border-gray-600 bg-gray-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent placeholder-gray-400",rows:1,disabled:D})}),(0,n.jsx)("button",{onClick:()=>b(!y),className:"p-2 text-gray-400 hover:text-white transition-colors","aria-label":"Abrir emojis",children:(0,n.jsx)("span",{className:"text-lg",children:"\uD83D\uDE0A"})}),(0,n.jsx)("button",{onClick:K,disabled:!v.trim()||D,className:"p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg transition-colors","aria-label":"Enviar mensaje",children:D?(0,n.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,n.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,n.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]}),(0,n.jsxs)("div",{className:"flex items-center justify-between mt-2 text-xs text-gray-400",children:[(0,n.jsx)("button",{onClick:()=>m(null),className:"hover:text-white transition-colors",children:"← Volver a conversaciones"}),(0,n.jsx)("span",{children:"• Sesi\xf3n activa"})]})]})]})]}),z&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9995]",children:(0,n.jsxs)("div",{className:"bg-gray-800 border border-gray-700 rounded-lg p-6 max-w-sm w-full mx-4",children:[(0,n.jsx)("h3",{className:"text-white text-lg font-semibold mb-4",children:"Eliminar conversaci\xf3n"}),(0,n.jsx)("p",{className:"text-gray-300 text-sm mb-6",children:"\xbfEst\xe1s seguro de que quieres eliminar esta conversaci\xf3n? Esta acci\xf3n eliminar\xe1 todos los mensajes y no se puede deshacer."}),(0,n.jsxs)("div",{className:"flex space-x-3",children:[(0,n.jsx)("button",{onClick:()=>U(null),className:"flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors",children:"Cancelar"}),(0,n.jsx)("button",{onClick:()=>ee(z),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Eliminar"})]})]})})]})}},9853:function(e,t,a){"use strict";a.d(t,{E4:function(){return r},P1:function(){return s}});var n=a(5922),o=a(8115);async function r(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:t,error:a}=await n.O.auth.signInWithPassword({email:e.email,password:e.password});if(a)return console.error("❌ [AUTH] Error de autenticaci\xf3n:",a.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!t.user)return{success:!1,error:"Usuario no encontrado"};console.log("✅ [AUTH] Usuario autenticado en Supabase:",t.user.id);let{data:r,error:s}=await n.O.from("users").select("\n        id,\n        name,\n        email,\n        role,\n        is_active,\n        last_login,\n        organization_id,\n        user_groups!inner(\n          group_id,\n          is_manager,\n          groups!inner(\n            id,\n            name\n          )\n        )\n      ").eq("id",t.user.id).single();if(s)return console.error("❌ [AUTH] Error obteniendo perfil:",s.message),{success:!1,error:"Error obteniendo perfil de usuario"};if(!r)return{success:!1,error:"Perfil de usuario no encontrado"};if(!r.is_active)return{success:!1,error:"Usuario inactivo"};await n.O.from("users").update({last_login:new Date().toISOString()}).eq("id",t.user.id);let i={id:r.id,email:t.user.email,name:r.name,role:r.role,organization_id:r.organization_id,groups:r.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:r.is_active,last_login:r.last_login};console.log("✅ [AUTH] Login exitoso:",{id:i.id,email:i.email,role:i.role,groups:i.groups.length});try{await (0,o.MY)(i.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:i}}catch(e){return console.error("❌ [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function s(){try{let{data:{user:e}}=await n.O.auth.getUser(),{error:t}=await n.O.auth.signOut();if(t&&console.error("❌ [AUTH] Error en logout:",t.message),e)try{await (0,o.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("❌ [AUTH] Error general en logout:",e)}}},8115:function(e,t,a){"use strict";a.d(t,{MY:function(){return r},do:function(){return i},lH:function(){return s}});var n=a(5922);async function o(e,t){try{console.log("\uD83D\uDCCA [CHAT-STATUS] Actualizando estado de usuario ".concat(e,": ").concat(t?"EN L\xcdNEA":"OFFLINE"));let{error:a}=await n.O.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});a?console.error("❌ [CHAT-STATUS] Error actualizando estado:",a):console.log("✅ [CHAT-STATUS] Estado actualizado exitosamente: ".concat(t?"EN L\xcdNEA":"OFFLINE"))}catch(e){console.error("❌ [CHAT-STATUS] Error general:",e)}}async function r(e){await o(e,!0)}async function s(e){await o(e,!1)}async function i(e){try{let{error:t}=await n.O.from("chat_user_status").upsert({user_id:e,is_online:!0,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});t&&console.error("❌ [CHAT-STATUS] Error actualizando heartbeat:",t)}catch(e){console.error("❌ [CHAT-STATUS] Error en heartbeat:",e)}}},5922:function(e,t,a){"use strict";a.d(t,{O:function(){return n}});let n=(0,a(5257).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c")},4033:function(e,t,a){e.exports=a(5313)}}]);