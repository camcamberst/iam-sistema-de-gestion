(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3905],{2344:function(e,t,n){"use strict";var a=n(7437),o=n(2265);t.Z=()=>{let[e,t]=(0,o.useState)("light"),[n,r]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{r(!0);let e=localStorage.getItem("theme");if(e)t(e),document.documentElement.classList.toggle("dark","dark"===e);else{let e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";t(e),document.documentElement.classList.toggle("dark","dark"===e)}},[]),n)?(0,a.jsx)("button",{"data-theme-toggle":!0,onClick:()=>{let n="light"===e?"dark":"light";document.documentElement.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",document.body.style.transition="all 0.6s cubic-bezier(0.4, 0, 0.2, 1)",t(n),localStorage.setItem("theme",n),document.documentElement.classList.toggle("dark","dark"===n);let a=document.querySelector("[data-theme-toggle]");a&&(a.style.transform="scale(0.95)",setTimeout(()=>{a.style.transform="scale(1)"},150)),setTimeout(()=>{document.documentElement.style.transition="",document.body.style.transition=""},600)},className:"p-2.5 text-gray-600 hover:text-gray-900 hover:bg-white/60 rounded-lg transition-all duration-200 hover:shadow-sm   dark:text-gray-300 dark:hover:text-white dark:hover:bg-gray-700",title:"light"===e?"Cambiar a modo oscuro":"Cambiar a modo claro",children:"light"===e?(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"})}):(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h1M3 12H2m15.325 6.675l-.707.707M6.707 6.707l-.707-.707m10.626 0l.707-.707M6.707 17.293l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z"})})}):(0,a.jsx)("div",{className:"p-2.5 text-gray-600 rounded-lg",children:(0,a.jsx)("div",{className:"w-5 h-5"})})}},842:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var a=n(7437),o=n(2265),r=n(5922),s=n(8115);function i(e){let{conversationId:t,otherUser:n,onClose:s,userId:i,userRole:l,session:c,windowIndex:d=0,isInChatBar:u=!1}=e,[h,g]=(0,o.useState)([]),[m,x]=(0,o.useState)(""),[f,v]=(0,o.useState)(!1),[p,D]=(0,o.useState)(!1),[C,w]=(0,o.useState)(!1),[y,b]=(0,o.useState)({x:0,y:0}),[j,E]=(0,o.useState)({x:0,y:0}),N=(0,o.useRef)(null),k=(0,o.useRef)(null),W=()=>{if(u){let e=window.innerWidth-24-320,t=window.innerWidth-e+8+328*d;return console.log("\uD83E\uDE9F [IndividualChatWindow] Posici\xf3n en barra de chat (derecha a izquierda):",{windowIndex:d,windowInnerWidth:window.innerWidth,mainChatLeftEdge:e,finalRight:t,isInChatBar:u}),{right:t,y:0}}{let e=window.innerHeight-500-24,t=window.innerWidth-24-320,n=t-20,a=n-320-340*d,o=Math.max(20,a);return console.log("\uD83E\uDE9F [IndividualChatWindow] Calculando posici\xf3n flotante:",{windowIndex:d,windowWidth:320,windowHeight:500,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,mainChatLeftEdge:t,individualWindowRightEdge:n,finalX:a,adjustedX:o,finalY:e}),{x:o,y:e}}};(0,o.useEffect)(()=>{b(W())},[d]);let _=async()=>{if(t&&c)try{v(!0);let e=await fetch("/api/chat/messages?conversation_id=".concat(t),{headers:{Authorization:"Bearer ".concat(c.access_token)}}),n=await e.json();n.success&&g(n.messages||[])}catch(e){console.error("Error cargando mensajes:",e)}finally{v(!1)}},A=async()=>{if(console.log("\uD83D\uDCE4 [IndividualChat] Intentando enviar mensaje:",{newMessage:m.trim(),conversationId:t,hasSession:!!c,sessionToken:(null==c?void 0:c.access_token)?"Presente":"Ausente"}),!m.trim()||!t||!c){console.log("❌ [IndividualChat] Validaci\xf3n fallida:",{hasMessage:!!m.trim(),hasConversationId:!!t,hasSession:!!c});return}try{console.log("\uD83D\uDE80 [IndividualChat] Enviando mensaje a API...");let e=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(c.access_token)},body:JSON.stringify({conversation_id:t,content:m.trim()})});console.log("\uD83D\uDCE1 [IndividualChat] Respuesta de API:",e.status,e.statusText);let n=await e.json();console.log("\uD83D\uDCCB [IndividualChat] Datos de respuesta:",n),n.success?(console.log("✅ [IndividualChat] Mensaje enviado exitosamente"),x(""),await _()):console.log("❌ [IndividualChat] Error en respuesta:",n.error)}catch(e){console.error("❌ [IndividualChat] Error enviando mensaje:",e)}},S=()=>{var e;null===(e=k.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,o.useEffect)(()=>{S()},[h]),(0,o.useEffect)(()=>{_()},[t]),(0,o.useEffect)(()=>{if(!t)return;let e=r.O.channel("individual-chat-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"conversation_id=eq.".concat(t)},async e=>{console.log("\uD83D\uDCE8 [IndividualChat] Nuevo mensaje recibido:",e),await _()}).subscribe();return()=>{r.O.removeChannel(e)}},[t]);let I=e=>{p&&b({x:e.clientX-j.x,y:e.clientY-j.y})},T=()=>{D(!1)};(0,o.useEffect)(()=>{if(p)return document.addEventListener("mousemove",I),document.addEventListener("mouseup",T),()=>{document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",T)}},[p,j]);let L=((null==n?void 0:n.email)||"").split("@")[0]||n.name||n.email||"Usuario";return(0,a.jsxs)("div",{ref:N,className:"w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] fixed",style:u?{right:"".concat(y.right,"px"),bottom:"0px",cursor:"default",height:C?"48px":"500px"}:{left:"".concat(y.x,"px"),top:"".concat(y.y,"px"),cursor:p?"grabbing":"default",height:C?"48px":"500px"},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between ".concat(C?"px-3 py-2":"p-4"," border-b border-gray-700 bg-gray-900 rounded-t-lg ").concat(u?"cursor-default":"cursor-grab active:cursor-grabbing"),onMouseDown:u?void 0:e=>{if(N.current){let t=N.current.getBoundingClientRect();E({x:e.clientX-t.left,y:e.clientY-t.top}),D(!0)}},children:[C?(0,a.jsx)("div",{className:"flex items-center min-w-0 pr-2",children:(0,a.jsx)("span",{className:"text-white text-sm font-medium truncate",title:L,children:L})}):(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md",children:(0,a.jsx)("span",{className:"text-white font-bold text-xs tracking-wider",children:(n.name||n.email||"Usuario").charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-white font-semibold",children:n.name||n.email||"Usuario"}),(0,a.jsx)("p",{className:"text-gray-400 text-xs",children:n.role})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[(0,a.jsx)("button",{onClick:()=>w(e=>!e),className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Minimizar","aria-expanded":!C,children:C?(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8h12a2 2 0 0 1 2 2v8H6a2 2 0 0 1-2-2V8z"})}):(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("button",{onClick:s,className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar",children:(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),!C&&(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[f?(0,a.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,a.jsx)("div",{className:"text-gray-400",children:"Cargando mensajes..."})}):0===h.length?(0,a.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,a.jsxs)("div",{className:"text-gray-400 text-center",children:[(0,a.jsx)("p",{children:"No hay mensajes a\xfan"}),(0,a.jsx)("p",{className:"text-xs mt-1",children:"Env\xeda el primer mensaje"})]})}):h.map(e=>(0,a.jsx)("div",{className:"flex ".concat(e.sender_id===i?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-[70%] px-3 py-2 rounded-lg ".concat(e.sender_id===i?"bg-blue-600 text-white":"bg-gray-700 text-gray-100"),children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsx)("p",{className:"text-xs opacity-70 mt-1",children:new Date(e.created_at).toLocaleTimeString()})]})},e.id)),(0,a.jsx)("div",{ref:k})]}),!C&&(0,a.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"text",value:m,onChange:e=>x(e.target.value),onKeyDown:e=>{console.log("⌨️ [IndividualChat] Tecla presionada:",e.key),"Enter"!==e.key||e.shiftKey||(e.preventDefault(),console.log("\uD83D\uDE80 [IndividualChat] Enter presionado, enviando mensaje..."),A())},placeholder:"Escribe tu mensaje...",className:"flex-1 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,a.jsx)("button",{onClick:()=>{console.log("\uD83D\uDDB1️ [IndividualChat] Bot\xf3n enviar clickeado"),A()},disabled:!m.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg transition-colors","aria-label":"Enviar mensaje",children:(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]})}var l=n(5051),c=e=>{let{onClose:t,userId:n,userRole:o,session:r,windowIndex:s=0,view:i="users",setView:c,availableUsers:d=[],expandedSections:u={online:!0,offline:!1},setExpandedSections:h,openChatWithUser:g,conversations:m=[],selectedConversation:x,setSelectedConversation:f,messages:v=[],newMessage:p="",setNewMessage:D,sendMessage:C,handleKeyPress:w,showDeleteConfirm:y,setShowDeleteConfirm:b,deleteConversation:j,tempChatUser:E,getDisplayName:N=e=>e.name||e.email}=e,k=(m||[]).filter(e=>{var t;let n=null==e?void 0:null===(t=e.last_message)||void 0===t?void 0:t.content;return"string"==typeof n&&n.trim().length>0});return(0,a.jsxs)("div",{className:"w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] fixed",style:{right:"".concat(24,"px"),bottom:"0px",cursor:"default",maxHeight:"calc(100vh - 20px)",height:"500px"},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg cursor-default",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300 rounded-xl flex items-center justify-center shadow-md border border-white/20 dark:border-gray-700/30",children:(0,a.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-xs tracking-wider",children:"AIM"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-white text-sm font-semibold",children:"AIM Assistant"}),(0,a.jsx)("p",{className:"text-gray-400 text-xs",children:"Soporte y tips"})]})]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-white",children:(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsxs)("div",{className:"flex border-b border-gray-700 px-2 gap-2",children:[(0,a.jsx)("button",{onClick:()=>null==c?void 0:c("users"),className:"flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ".concat("users"===i?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"),children:"Usuarios disponibles"}),(0,a.jsxs)("button",{onClick:()=>null==c?void 0:c("conversations"),className:"flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ".concat("conversations"===i?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"),children:["Conversaciones (",k.length,")"]})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:["users"===i&&(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:[(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("button",{onClick:()=>null==h?void 0:h({...u,online:!u.online}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,a.jsxs)("span",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"En l\xednea (",d.filter(e=>e.is_online).length,")"]}),(0,a.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(u.online?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),u.online&&(0,a.jsx)("div",{className:"ml-4 space-y-1",children:d.filter(e=>e.is_online).map(e=>(0,a.jsxs)("button",{onClick:()=>null==g?void 0:g(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,a.jsx)("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3",children:(0,a.jsx)("span",{className:"text-white text-xs font-bold",children:N(e).charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:N(e)}),(0,a.jsx)("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("button",{onClick:()=>null==h?void 0:h({...u,offline:!u.offline}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,a.jsxs)("span",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-gray-500 rounded-full mr-2"}),"Offline (",d.filter(e=>!e.is_online).length,")"]}),(0,a.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(u.offline?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),u.offline&&(0,a.jsx)("div",{className:"ml-4 space-y-1",children:d.filter(e=>!e.is_online).map(e=>(0,a.jsxs)("button",{onClick:()=>null==g?void 0:g(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,a.jsx)("div",{className:"w-6 h-6 bg-gradient-to-br from-gray-500 to-gray-600 rounded-full flex items-center justify-center mr-3",children:(0,a.jsx)("span",{className:"text-white text-xs font-bold",children:N(e).charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:N(e)}),(0,a.jsx)("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]})]})})}),"conversations"===i&&(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:(0,a.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:0===k.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[(0,a.jsx)("svg",{className:"w-12 h-12 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,a.jsx)("p",{className:"text-sm text-center",children:"No hay conversaciones activas"}),(0,a.jsx)("p",{className:"text-xs text-center mt-1",children:"Los mensajes aparecer\xe1n aqu\xed cuando inicies una conversaci\xf3n"})]}):k.map(e=>{var t;return(0,a.jsxs)("div",{className:"flex items-center w-full p-2 text-left rounded-lg transition-colors ".concat(x===e.id?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:[(0,a.jsxs)("button",{onClick:()=>{null==g||g(e.other_participant.id)},className:"flex items-center flex-1 min-w-0 text-left",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3",children:(0,a.jsx)("span",{className:"text-white text-xs font-bold",children:N(e.other_participant).charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium truncate",children:N(e.other_participant)}),(0,a.jsx)("p",{className:"text-xs text-gray-400 truncate",children:null===(t=e.last_message)||void 0===t?void 0:t.content})]})]}),e.unread_count>0&&(0,a.jsx)("div",{className:"bg-red-500 text-white text-[10px] rounded-full px-2 py-1 min-w-[20px] text-center ml-2",children:e.unread_count}),(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),null==b||b(e.id)},className:"ml-2 p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-600/50","aria-label":"Eliminar conversaci\xf3n",title:"Eliminar conversaci\xf3n",children:(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-7 0a2 2 0 012-2h4a2 2 0 012 2m-8 0H5"})})})]},e.id)})})})}),"chat"===i&&x&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"flex-1 p-4 overflow-y-auto custom-scrollbar min-h-0",children:v.map(e=>(0,a.jsx)("div",{className:"flex mb-4 ".concat(e.sender_id===n?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-[70%] p-3 rounded-lg ".concat(e.sender_id===n?"bg-blue-600 text-white":"bg-gray-700 text-white"),children:[(0,a.jsx)("p",{className:"text-sm",children:e.content}),(0,a.jsx)("span",{className:"text-xs text-gray-300 block text-right mt-1",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},e.id))}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-700 flex-shrink-0",children:(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("input",{type:"text",value:p,onChange:e=>null==D?void 0:D(e.target.value),onKeyPress:w,placeholder:"Escribe tu mensaje...",className:"flex-1 p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,a.jsx)("button",{onClick:C,disabled:!p.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})]}),y&&(0,a.jsxs)(l.Z,{isOpen:!0,onClose:()=>null==b?void 0:b(null),title:"Eliminar conversaci\xf3n",maxWidthClass:"max-w-md",children:[(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mb-6",children:"\xbfEst\xe1s seguro de que quieres eliminar esta conversaci\xf3n? Esta acci\xf3n no se puede deshacer."}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsx)("button",{onClick:()=>null==b?void 0:b(null),className:"flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:"Cancelar"}),(0,a.jsx)("button",{onClick:()=>null==j?void 0:j(y),className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Eliminar"})]})]})]})]})},d=e=>{let{openChatWindows:t,onCloseWindow:n,userId:o,userRole:r,session:s,isMainChatOpen:l=!1,onCloseMainChat:d,view:u,setView:h,availableUsers:g=[],expandedSections:m={online:!0,offline:!1},setExpandedSections:x,openChatWithUser:f,conversations:v,selectedConversation:p,setSelectedConversation:D,messages:C,newMessage:w,setNewMessage:y,sendMessage:b,handleKeyPress:j,showDeleteConfirm:E,setShowDeleteConfirm:N,deleteConversation:k,tempChatUser:W,getDisplayName:_}=e;return 0!==t.length||l?(0,a.jsxs)(a.Fragment,{children:[l&&(0,a.jsx)(c,{onClose:d,userId:o,userRole:r,session:s,windowIndex:-1,view:u,setView:h,availableUsers:g,expandedSections:m,setExpandedSections:x,openChatWithUser:f,conversations:v,selectedConversation:p,setSelectedConversation:D,messages:C,newMessage:w,setNewMessage:y,sendMessage:b,handleKeyPress:j,showDeleteConfirm:E,setShowDeleteConfirm:N,deleteConversation:k,tempChatUser:W,getDisplayName:_}),t.map((e,t)=>(0,a.jsx)(i,{conversationId:e.conversationId,otherUser:e.otherUser,onClose:()=>n(e.id),userId:o,userRole:r,session:s,windowIndex:t,isInChatBar:!0},e.id))]}):null};function u(e){let{userId:t,userRole:n}=e,[i,l]=(0,o.useState)(!1),[c,u]=(0,o.useState)([]),[h,g]=(0,o.useState)([]),[m,x]=(0,o.useState)(null),[f,v]=(0,o.useState)([]),[p,D]=(0,o.useState)(""),[C,w]=(0,o.useState)(!1),[y,b]=(0,o.useState)("users"),[j,E]=(0,o.useState)(!1),[N,k]=(0,o.useState)({online:!0,offline:!1}),[W,_]=(0,o.useState)(!1),[A,S]=(0,o.useState)(!1),[I,T]=(0,o.useState)(0),[L,M]=(0,o.useState)(!1),[U,O]=(0,o.useState)(null),[z,B]=(0,o.useState)(null),F=(0,o.useRef)(null),[H,P]=(0,o.useState)(null),R=(0,o.useRef)(null),[J,V]=(0,o.useState)(!1),[q,Z]=(0,o.useState)([]);(0,o.useEffect)(()=>{console.log("\uD83E\uDE9F [ChatWidget] Ventanas abiertas actualizadas:",q.length,q)},[q]);let K=e=>"modelo"===e.role?e.email.split("@")[0]:e.name;(0,o.useEffect)(()=>{(async()=>{let{data:{session:e}}=await r.O.auth.getSession();P(e)})()},[]),(0,o.useEffect)(()=>{let e;let t=()=>{V(!0),clearTimeout(e),e=setTimeout(()=>{V(!1)},150)};return window.addEventListener("scroll",t,{passive:!0}),()=>{window.removeEventListener("scroll",t),clearTimeout(e)}},[]),(0,o.useEffect)(()=>{if(!t)return;let e=async()=>{try{await (0,s.do)(t)}catch(e){console.error("❌ [ChatWidget] Error enviando heartbeat:",e)}};e(),R.current=setInterval(e,3e4);let n=async()=>{try{await (0,s.lH)(t)}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}},a=async()=>{document.hidden?(R.current&&clearInterval(R.current),R.current=setInterval(e,6e4)):(R.current&&clearInterval(R.current),R.current=setInterval(e,3e4),e())};return window.addEventListener("beforeunload",n),document.addEventListener("visibilitychange",a),()=>{R.current&&clearInterval(R.current),window.removeEventListener("beforeunload",n),document.removeEventListener("visibilitychange",a),(0,s.lH)(t).catch(e=>{console.error("❌ [ChatWidget] Error marcando usuario offline en cleanup:",e)})}},[t]),(0,o.useEffect)(()=>{let e=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n restaurada"),t)try{await eo(!0),console.log("\uD83D\uDFE2 [ChatWidget] Usuario marcado como online tras restaurar conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario online:",e)}},n=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n perdida"),t)try{await eo(!1),console.log("\uD83D\uDD34 [ChatWidget] Usuario marcado como offline por p\xe9rdida de conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}};return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}},[t]);let Y=async()=>{if(H)try{let e=await fetch("/api/chat/conversations",{headers:{Authorization:"Bearer ".concat(H.access_token)}}),n=await e.json();if(n.success){u(n.conversations);let e=n.conversations.reduce((e,n)=>n.last_message&&n.last_message.sender_id!==t?e+1:e,0);console.log("\uD83D\uDCCA [ChatWidget] Mensajes no le\xeddos detectados:",{unread:e,lastUnreadCount:I,hasNewMessage:e>I}),!(e>0)||i||L||(console.log("\uD83D\uDD14 [ChatWidget] \xa1NUEVO MENSAJE DETECTADO! Activando notificaci\xf3n..."),M(!0),es()),e>I&&I>=0&&!L&&(console.log("\uD83D\uDD14 [ChatWidget] \xa1INCREMENTO DE MENSAJES DETECTADO!",{unread:e,lastUnreadCount:I,isOpen:i,notificationTriggered:L}),i?console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - No activando notificaci\xf3n"):(console.log("\uD83D\uDD14 [ChatWidget] Chat cerrado - Activando notificaci\xf3n autom\xe1tica..."),M(!0),es())),i&&L&&(console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando notificaciones..."),M(!1),_(!1),S(!1)),T(e)}}catch(e){console.error("Error cargando conversaciones:",e)}},G=async()=>{if(H)try{let e=await fetch("/api/chat/users",{headers:{Authorization:"Bearer ".concat(H.access_token)}}),t=await e.json();t.success&&g(t.users)}catch(e){console.error("Error cargando usuarios:",e)}},X=async e=>{if(H)try{let n=await fetch("/api/chat/messages?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(H.access_token)}}),a=await n.json();if(a.success)v(e=>{let n=a.messages;if(e.length!==n.length||e.some((e,t)=>!n[t]||e.id!==n[t].id)){if(console.log("\uD83D\uDCE8 [ChatWidget] Mensajes actualizados:",{previous:e.length,new:n.length}),n.length>e.length){let e=n[n.length-1];e&&e.sender_id!==t&&(console.log("\uD83D\uDD14 [ChatWidget] Nuevo mensaje detectado via polling, activando notificaci\xf3n..."),es())}return n}return e}),x(e);else{if(console.error("❌ [ChatWidget] Error en respuesta de mensajes:",a),a.error&&(a.error.includes("no encontrada")||a.error.includes("no existe"))){console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante carga de mensajes, preparando nueva conversaci\xf3n..."),await Q(e);return}await $(e)}}catch(t){console.error("❌ [ChatWidget] Error cargando mensajes:",t),await $(e)}},Q=async e=>{if(H){console.log("\uD83D\uDD04 [ChatWidget] Manejando conversaci\xf3n eliminada:",e);try{if(await Y(),e.startsWith("temp_"))console.log("\uD83E\uDDF9 [ChatWidget] Limpiando conversaci\xf3n temporal eliminada"),v([]),O(null),b("users");else{console.log("\uD83D\uDCA1 [ChatWidget] Conversaci\xf3n eliminada, preparando nueva conversaci\xf3n autom\xe1ticamente");let n=f[f.length-1];if(n&&n.sender_id!==t){let e=n.sender_id,t=h.find(t=>t.id===e);if(t){console.log("\uD83C\uDFAF [ChatWidget] Usuario identificado para nueva conversaci\xf3n:",t.name||t.email),O(t),x("temp_".concat(e)),v([]);let n={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Conversaci\xf3n reiniciada con ".concat(K(t),". Puedes continuar chateando."),sender_id:"system",conversation_id:"temp_".concat(e),created_at:new Date().toISOString(),is_system_message:!0};v([n]);return}}console.log("⚠️ [ChatWidget] No se pudo identificar al usuario, mostrando mensaje gen\xe9rico"),v([]),O(null);let a={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Esta conversaci\xf3n fue eliminada. Selecciona un usuario para iniciar una nueva conversaci\xf3n.",sender_id:"system",conversation_id:e,created_at:new Date().toISOString(),is_system_message:!0};v([a]),b("users")}}catch(e){console.error("❌ [ChatWidget] Error manejando conversaci\xf3n eliminada:",e),v([]),O(null),b("users")}}},$=async e=>{if(H)try{console.log("\uD83D\uDD0D [ChatWidget] Ejecutando diagn\xf3stico de polling...");let t=await fetch("/api/chat/debug-polling?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(H.access_token)}}),n=await t.json();n.success?console.log("✅ [ChatWidget] Diagn\xf3stico exitoso:",n.debug):console.error("❌ [ChatWidget] Diagn\xf3stico fall\xf3:",n)}catch(e){console.error("❌ [ChatWidget] Error en diagn\xf3stico:",e)}},ee=async()=>{if(p.trim()&&m&&H){console.log("\uD83D\uDCE4 [ChatWidget] Enviando mensaje:",{content:p.trim(),conversationId:m,userId:t}),w(!0);try{let e=m;if(m.startsWith("temp_")){console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n temporal...");let t=m.replace("temp_",""),n=await en(t);if(n)e=n,x(n),O(null),console.log("✅ [ChatWidget] Conversaci\xf3n creada:",n);else{console.error("❌ [ChatWidget] Error creando conversaci\xf3n");return}}let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(H.access_token)},body:JSON.stringify({conversation_id:e,content:p.trim()})}),n=await t.json();console.log("\uD83D\uDCE8 [ChatWidget] Respuesta del servidor:",n),n.success?(console.log("✅ [ChatWidget] Mensaje enviado exitosamente"),D(""),setTimeout(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Recargando mensajes como fallback..."),await X(e)},1e3),await Y()):(console.error("❌ [ChatWidget] Error en respuesta del servidor:",n),n.error&&(n.error.includes("no encontrada")||n.error.includes("no existe"))&&(console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante env\xedo, preparando nueva conversaci\xf3n..."),await Q(e)))}catch(e){console.error("❌ [ChatWidget] Error enviando mensaje:",e)}finally{w(!1)}}},et=async e=>{if(console.log("\uD83D\uDDB1️ [ChatWidget] Click detectado en usuario:",e),console.log("\uD83D\uDDB1️ [ChatWidget] Sesi\xf3n disponible:",!!H),console.log("\uD83D\uDDB1️ [ChatWidget] Usuarios disponibles:",h.length),!H){console.log("❌ [ChatWidget] No hay sesi\xf3n disponible");return}console.log("\uD83D\uDCAC [ChatWidget] Abriendo chat con usuario:",e);let t=c.find(t=>t.other_participant.id===e),n=h.find(t=>t.id===e);if(console.log("\uD83D\uDC64 [ChatWidget] Usuario encontrado:",n),!n){console.log("❌ [ChatWidget] Usuario no encontrado en availableUsers");return}if(q.find(t=>t.otherUser.id===e)){console.log("\uD83E\uDE9F [ChatWidget] Ventana ya abierta para este usuario");return}if(t){console.log("\uD83D\uDCC2 [ChatWidget] Abriendo conversaci\xf3n existente en ventana individual:",t.id);let e={id:"window_".concat(t.id),conversationId:t.id,otherUser:n};Z(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando ventana:",e),[...t,e]))}else{console.log("\uD83C\uDD95 [ChatWidget] Creando nueva conversaci\xf3n en ventana individual con:",n.name||n.email);try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(H.access_token)},body:JSON.stringify({participant_2_id:e})}),a=await t.json();if(console.log("\uD83D\uDCE1 [ChatWidget] Respuesta API crear conversaci\xf3n:",a),a.success){let e={id:"window_".concat(a.conversation.id),conversationId:a.conversation.id,otherUser:n};Z(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando nueva ventana:",e),[...t,e])),await Y()}else console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",a.error)}catch(e){console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",e)}}},en=async e=>{if(H){try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(H.access_token)},body:JSON.stringify({participant_2_id:e})}),n=await t.json();if(n.success)return n.conversation.id}catch(e){console.error("Error creando conversaci\xf3n:",e)}return null}},ea=async e=>{if(H)try{let t=await fetch("/api/chat/conversations?conversation_id=".concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(H.access_token)}}),n=await t.json();n.success?(console.log("\uD83D\uDDD1️ [ChatWidget] Conversaci\xf3n eliminada exitosamente"),await Y(),m===e&&(x(null),v([]),O(null),console.log("\uD83E\uDDF9 [ChatWidget] Estado de chat limpiado despu\xe9s de eliminaci\xf3n")),B(null)):console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",n.error)}catch(e){console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n:",e)}},eo=async e=>{if(H)try{await fetch("/api/chat/users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(H.access_token)},body:JSON.stringify({is_online:e})})}catch(e){console.error("Error actualizando estado:",e)}},er=()=>{try{console.log("\uD83C\uDFB5 [ChatWidget] Iniciando reproducci\xf3n de sonido...");let e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine";let a=[400,600,800,1e3,1200,1e3,800,600,400,600,800,1e3,1200];console.log("\uD83C\uDFBC [ChatWidget] Configurando frecuencias:",a),a.forEach((n,o)=>{let r=e.currentTime+o/a.length*.5;t.frequency.setValueAtTime(n,r)}),n.gain.setValueAtTime(0,e.currentTime),n.gain.linearRampToValueAtTime(.4,e.currentTime+.02),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5),console.log("✅ [ChatWidget] Sonido de notificaci\xf3n reproducido exitosamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido de notificaci\xf3n:",e)}},es=()=>{if(console.log("\uD83D\uDD0D [ChatWidget] triggerNotification llamada - isOpen:",i),i){console.log("\uD83D\uDCC2 [ChatWidget] Chat abierto - NO activando notificaciones");return}console.log("\uD83D\uDD14 [ChatWidget] TRIGGER NOTIFICATION - Activando notificaciones (chat cerrado)..."),console.log("\uD83D\uDD0A [ChatWidget] Reproduciendo sonido de notificaci\xf3n...");try{er(),console.log("✅ [ChatWidget] Sonido iniciado correctamente")}catch(e){console.error("❌ [ChatWidget] Error reproduciendo sonido:",e)}console.log("\uD83D\uDCAB [ChatWidget] Activando parpadeo del bot\xf3n..."),_(!0),S(!0),console.log("\uD83D\uDCC2 [ChatWidget] Abriendo chat autom\xe1ticamente..."),l(!0),setTimeout(()=>{console.log("⏹️ [ChatWidget] Deteniendo latido de coraz\xf3n..."),_(!1)},6e3)};return(0,o.useEffect)(()=>{H&&(Y(),G(),eo(!0))},[H]),(0,o.useEffect)(()=>{if(!H)return;let e=setInterval(()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling de respaldo: actualizando lista de usuarios..."),G()},3e4);return()=>{clearInterval(e)}},[H]),(0,o.useEffect)(()=>{if(!H||!m)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de mensajes como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando mensajes nuevos..."),await X(m)},3e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de mensajes..."),clearInterval(e)}},[H,m]),(0,o.useEffect)(()=>{if(!H)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de conversaciones como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando conversaciones actualizadas..."),await Y()},5e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de conversaciones..."),clearInterval(e)}},[H]),(0,o.useEffect)(()=>{var e;null===(e=F.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[f]),(0,o.useEffect)(()=>{if(!H||!t)return;console.log("\uD83D\uDD14 [ChatWidget] Configurando suscripci\xf3n en tiempo real...");let e=r.O.channel("chat-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},async e=>{let n=e.new;console.log("\uD83D\uDCE8 [ChatWidget] Nuevo mensaje recibido:",n);try{let{data:e,error:a}=await r.O.from("chat_conversations").select("participant_1_id, participant_2_id").eq("id",n.conversation_id).single();if(a||!e){console.log("❌ [ChatWidget] Error verificando conversaci\xf3n:",a);return}e.participant_1_id===t||e.participant_2_id===t?(console.log("✅ [ChatWidget] Usuario es participante de la conversaci\xf3n"),m===n.conversation_id&&(console.log("\uD83D\uDCAC [ChatWidget] Agregando mensaje a conversaci\xf3n activa"),v(e=>e.some(e=>e.id===n.id)?(console.log("⚠️ [ChatWidget] Mensaje ya existe en la lista, no agregando"),e):(console.log("➕ [ChatWidget] Agregando nuevo mensaje a la lista"),[...e,n]))),console.log("\uD83D\uDD04 [ChatWidget] Actualizando lista de conversaciones..."),Y(),n.sender_id!==t?(console.log("\uD83D\uDD14 [ChatWidget] Activando notificaci\xf3n para mensaje de otro usuario"),es()):console.log("\uD83D\uDC64 [ChatWidget] Mensaje del usuario actual, no notificando")):console.log("❌ [ChatWidget] Usuario no es participante de la conversaci\xf3n")}catch(e){console.error("❌ [ChatWidget] Error en verificaci\xf3n de conversaci\xf3n:",e)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_conversations"},e=>{let t=e.new;console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n actualizada:",t),c.some(e=>e.id===t.id)&&(console.log("✅ [ChatWidget] Conversaci\xf3n relevante actualizada, recargando lista..."),Y())}).subscribe(e=>{console.log("\uD83D\uDCE1 [ChatWidget] Estado de suscripci\xf3n:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n en tiempo real"),r.O.removeChannel(e)}},[H,t]),(0,o.useEffect)(()=>{if(!H)return;console.log("\uD83D\uDC65 [ChatWidget] Configurando suscripci\xf3n para estados de usuarios...");let e=r.O.channel("chat-user-status-realtime").on("postgres_changes",{event:"*",schema:"public",table:"chat_user_status"},async e=>{console.log("\uD83D\uDC65 [ChatWidget] Estado de usuario actualizado:",e),await G()}).subscribe(e=>{console.log("\uD83D\uDC65 [ChatWidget] Estado de suscripci\xf3n de usuarios:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n de estados de usuarios"),r.O.removeChannel(e)}},[H]),(0,o.useEffect)(()=>{},[c,m]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>{let e=!i;l(e),e&&H&&Y(),e?(S(!1),_(!1),M(!1),console.log("\uD83D\uDD14 [ChatWidget] Chat abierto - Desactivando todas las notificaciones")):O(null)},onContextMenu:e=>{e.preventDefault(),console.log("\uD83E\uDDEA [ChatWidget] Prueba manual de notificaci\xf3n"),es()},className:"fixed bottom-6 right-6 w-10 h-10 bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300 hover:w-16 hover:h-10 text-white dark:text-gray-900 rounded-xl shadow-lg border border-white/20 dark:border-gray-700/30 transition-all duration-300 flex items-center justify-center z-[9995] group overflow-hidden ".concat(W?"animate-heartbeat bg-gradient-to-r from-red-500 via-pink-500 to-red-600 text-white":""),"aria-label":"Abrir chat de soporte (clic derecho para probar notificaci\xf3n)",children:(0,a.jsxs)("div",{className:"flex items-center justify-center",children:[(0,a.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-sm group-hover:hidden drop-shadow-sm",children:"A"}),(0,a.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-xs hidden group-hover:block whitespace-nowrap drop-shadow-sm",children:"AIM"})]})}),(0,a.jsx)(d,{openChatWindows:q,onCloseWindow:e=>{Z(t=>t.filter(t=>t.id!==e))},userId:t,userRole:n,session:H,isMainChatOpen:i,onCloseMainChat:()=>l(!1),view:y,setView:b,availableUsers:h,expandedSections:N,setExpandedSections:k,openChatWithUser:et,conversations:c,selectedConversation:m,setSelectedConversation:x,messages:f,newMessage:p,setNewMessage:D,sendMessage:ee,handleKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ee())},showDeleteConfirm:z,setShowDeleteConfirm:B,deleteConversation:ea,tempChatUser:U,getDisplayName:K})]})}},5051:function(e,t,n){"use strict";n.d(t,{Z:function(){return r}});var a=n(7437),o=n(2265);function r(e){let{isOpen:t,onClose:n,children:r,title:s,maxWidthClass:i="max-w-lg",paddingClass:l="p-7",headerMarginClass:c="mb-5",formSpaceYClass:d="space-y-5",className:u="",showCloseButton:h=!0,closeOnBackdrop:g=!0}=e,[m,x]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{if(!t)return;let e=requestAnimationFrame(()=>x(!0));return()=>{cancelAnimationFrame(e),x(!1)}},[t]),(0,o.useEffect)(()=>{if(!t)return;let e=e=>{"Escape"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[t,n]),t)?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-200 ".concat(m?"opacity-100":"opacity-0"),onClick:()=>{g&&n()},"aria-modal":"true",role:"dialog",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-2xl shadow-xl ".concat(l," w-full ").concat(i," max-h-[90vh] overflow-y-auto transform transition-all duration-200 ease-out ").concat(m?"opacity-100 scale-100":"opacity-0 scale-95"," ").concat(u),onClick:e=>e.stopPropagation(),children:[(s||h)&&(0,a.jsxs)("div",{className:"flex items-center justify-between ".concat(c),children:[s?(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:s}):(0,a.jsx)("div",{}),h&&(0,a.jsx)("button",{onClick:n,className:"text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300","aria-label":"Cerrar",children:(0,a.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsx)("div",{className:d,children:r})]})}):null}},9853:function(e,t,n){"use strict";n.d(t,{E4:function(){return r},P1:function(){return s}});var a=n(5922),o=n(8115);async function r(e){try{console.log("\uD83D\uDD10 [AUTH] Iniciando login moderno:",{email:e.email});let{data:t,error:n}=await a.O.auth.signInWithPassword({email:e.email,password:e.password});if(n)return console.error("❌ [AUTH] Error de autenticaci\xf3n:",n.message),{success:!1,error:"Credenciales inv\xe1lidas"};if(!t.user)return{success:!1,error:"Usuario no encontrado"};console.log("✅ [AUTH] Usuario autenticado en Supabase:",t.user.id);let{data:r,error:s}=await a.O.from("users").select("\n        id,\n        name,\n        email,\n        role,\n        is_active,\n        last_login,\n        organization_id,\n        user_groups!inner(\n          group_id,\n          is_manager,\n          groups!inner(\n            id,\n            name\n          )\n        )\n      ").eq("id",t.user.id).single();if(s)return console.error("❌ [AUTH] Error obteniendo perfil:",s.message),{success:!1,error:"Error obteniendo perfil de usuario"};if(!r)return{success:!1,error:"Perfil de usuario no encontrado"};if(!r.is_active)return{success:!1,error:"Usuario inactivo"};await a.O.from("users").update({last_login:new Date().toISOString()}).eq("id",t.user.id);let i={id:r.id,email:t.user.email,name:r.name,role:r.role,organization_id:r.organization_id,groups:r.user_groups.map(e=>({id:e.groups.id,name:e.groups.name,is_manager:e.is_manager})),is_active:r.is_active,last_login:r.last_login};console.log("✅ [AUTH] Login exitoso:",{id:i.id,email:i.email,role:i.role,groups:i.groups.length});try{await (0,o.MY)(i.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como en l\xednea en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como en l\xednea:",e)}return{success:!0,user:i}}catch(e){return console.error("❌ [AUTH] Error general:",e),{success:!1,error:"Error interno del servidor"}}}async function s(){try{let{data:{user:e}}=await a.O.auth.getUser(),{error:t}=await a.O.auth.signOut();if(t&&console.error("❌ [AUTH] Error en logout:",t.message),e)try{await (0,o.lH)(e.id),console.log("\uD83D\uDCCA [AUTH] Usuario marcado como offline en el chat")}catch(e){console.error("❌ [AUTH] Error marcando usuario como offline:",e)}}catch(e){console.error("❌ [AUTH] Error general en logout:",e)}}},8115:function(e,t,n){"use strict";n.d(t,{MY:function(){return r},do:function(){return i},lH:function(){return s}});var a=n(5922);async function o(e,t){try{console.log("\uD83D\uDCCA [CHAT-STATUS] Actualizando estado de usuario ".concat(e,": ").concat(t?"EN L\xcdNEA":"OFFLINE"));let{error:n}=await a.O.from("chat_user_status").upsert({user_id:e,is_online:t,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});n?console.error("❌ [CHAT-STATUS] Error actualizando estado:",n):console.log("✅ [CHAT-STATUS] Estado actualizado exitosamente: ".concat(t?"EN L\xcdNEA":"OFFLINE"))}catch(e){console.error("❌ [CHAT-STATUS] Error general:",e)}}async function r(e){await o(e,!0)}async function s(e){await o(e,!1)}async function i(e){try{let{error:t}=await a.O.from("chat_user_status").upsert({user_id:e,is_online:!0,last_seen:new Date().toISOString(),updated_at:new Date().toISOString()});t&&console.error("❌ [CHAT-STATUS] Error actualizando heartbeat:",t)}catch(e){console.error("❌ [CHAT-STATUS] Error en heartbeat:",e)}}},5922:function(e,t,n){"use strict";n.d(t,{O:function(){return a}});let a=(0,n(5257).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c")},4033:function(e,t,n){e.exports=n(5313)}}]);