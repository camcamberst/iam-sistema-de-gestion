(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8632,5922],{528:function(e,r,a){Promise.resolve().then(a.bind(a,359))},359:function(e,r,a){"use strict";a.r(r),a.d(r,{default:function(){return d}});var t=a(7437),s=a(2265),o=a(5922);function d(){let[e,r]=(0,s.useState)(!0),[a,d]=(0,s.useState)([]),[n,i]=(0,s.useState)(""),[l,c]=(0,s.useState)(new Date().getFullYear()),[u,g]=(0,s.useState)(new Date().getMonth()+1),[p,x]=(0,s.useState)({}),[b,m]=(0,s.useState)(!1),[h,y]=(0,s.useState)(!1),[_,f]=(0,s.useState)(null);(0,s.useEffect)(()=>{v()},[]),(0,s.useEffect)(()=>{n&&k()},[n,l,u]);let v=async()=>{try{let{data:e}=await o.supabase.from("groups").select("id, name").eq("is_active",!0).order("name");e&&(d(e),e.length>0&&!n&&i(e[0].id))}catch(e){console.error("Error cargando grupos:",e)}},k=async()=>{if(n)try{var e;r(!0);let a="".concat(l,"-").concat(String(u).padStart(2,"0"),"-01"),t="".concat(l,"-").concat(String(u).padStart(2,"0"),"-16"),s=null===(e=(await o.supabase.auth.getSession()).data.session)||void 0===e?void 0:e.access_token;if(!s)throw Error("No autenticado");let d=await fetch("/api/gestor/historical-rates?groupId=".concat(n,"&year=").concat(l,"&month=").concat(u),{headers:{Authorization:"Bearer ".concat(s)}}),i=await d.json();if(!d.ok||!i.success)throw Error(i.error||"Error cargando rates");let c={};i.data&&i.data.forEach(e=>{c["".concat(e.period_date,"_").concat(e.period_type)]={id:e.id,group_id:e.group_id,period_date:e.period_date,period_type:e.period_type,rate_usd_cop:parseFloat(e.rate_usd_cop),rate_eur_usd:parseFloat(e.rate_eur_usd),rate_gbp_usd:parseFloat(e.rate_gbp_usd),aplicado_at:e.aplicado_at,aplicado_por:e.aplicado_por}});let g="".concat(a,"_1-15"),p="".concat(t,"_16-31");c[g]||(c[g]={group_id:n,period_date:a,period_type:"1-15",rate_usd_cop:3900,rate_eur_usd:1.01,rate_gbp_usd:1.2}),c[p]||(c[p]={group_id:n,period_date:t,period_type:"16-31",rate_usd_cop:3900,rate_eur_usd:1.01,rate_gbp_usd:1.2}),x(c)}catch(e){console.error("Error cargando rates:",e),f({type:"error",text:e.message||"Error cargando rates hist\xf3ricas"})}finally{r(!1)}},w=(e,r,a)=>{let t="1-15"===e?"".concat(l,"-").concat(String(u).padStart(2,"0"),"-01"):"".concat(l,"-").concat(String(u).padStart(2,"0"),"-16"),s="".concat(t,"_").concat(e);x(o=>({...o,[s]:{...o[s],group_id:n,period_date:t,period_type:e,[r]:parseFloat(a)||0}}))},j=async e=>{if(!n){f({type:"error",text:"Por favor selecciona un grupo"});return}try{var r;m(!0);let a="1-15"===e?"".concat(l,"-").concat(String(u).padStart(2,"0"),"-01"):"".concat(l,"-").concat(String(u).padStart(2,"0"),"-16"),t=p["".concat(a,"_").concat(e)];if(!t)throw Error("Rate no encontrada");let s=null===(r=(await o.supabase.auth.getSession()).data.session)||void 0===r?void 0:r.access_token;if(!s)throw Error("No autenticado");let d=await fetch("/api/gestor/historical-rates",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify({groupId:t.group_id,periodDate:t.period_date,periodType:t.period_type,rateUsdCop:t.rate_usd_cop,rateEurUsd:t.rate_eur_usd,rateGbpUsd:t.rate_gbp_usd})}),n=await d.json();if(!d.ok||!n.success)throw Error(n.error||"Error guardando rates");f({type:"success",text:"Rates de ".concat(e," guardadas correctamente")}),setTimeout(()=>f(null),3e3),await k()}catch(e){console.error("Error guardando rates:",e),f({type:"error",text:e.message||"Error guardando rates hist\xf3ricas"})}finally{m(!1)}},N=async e=>{if(!n){f({type:"error",text:"Por favor selecciona un grupo"});return}if(confirm("\xbfEst\xe1s seguro de aplicar las rates de ".concat(e,"? Esto recalcular\xe1 todos los valores hist\xf3ricos de este per\xedodo.")))try{var r,a;y(!0);let t="1-15"===e?"".concat(l,"-").concat(String(u).padStart(2,"0"),"-01"):"".concat(l,"-").concat(String(u).padStart(2,"0"),"-16"),s=null===(r=(await o.supabase.auth.getSession()).data.session)||void 0===r?void 0:r.access_token;if(!s)throw Error("No autenticado");let d=await fetch("/api/gestor/historical-rates/apply",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify({groupId:n,periodDate:t,periodType:e})}),i=await d.json();if(!d.ok||!i.success)throw Error(i.error||"Error aplicando rates");f({type:"success",text:"Rates aplicadas correctamente. ".concat((null===(a=i.data)||void 0===a?void 0:a.updatedCount)||0," registros actualizados.")}),setTimeout(()=>f(null),5e3),await k()}catch(e){console.error("Error aplicando rates:",e),f({type:"error",text:e.message||"Error aplicando rates hist\xf3ricas"})}finally{y(!1)}},S="".concat(l,"-").concat(String(u).padStart(2,"0"),"-01"),E="".concat(l,"-").concat(String(u).padStart(2,"0"),"-16"),C=p["".concat(S,"_1-15")],O=p["".concat(E,"_16-31")];return e?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsx)("div",{className:"animate-spin w-8 h-8 border-2 border-gray-600 border-t-gray-400 rounded-full"})}):(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 p-6",children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Configurar Rates Hist\xf3ricas"}),(0,t.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Configura rates hist\xf3ricas para recalcular per\xedodos pasados. Estas rates SOLO afectan a per\xedodos hist\xf3ricos."})]}),_&&(0,t.jsx)("div",{className:"mb-4 p-4 rounded-lg ".concat("success"===_.type?"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200":"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200"),children:_.text}),(0,t.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6",children:(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Grupo/Sede"}),(0,t.jsxs)("select",{value:n,onChange:e=>i(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",children:[(0,t.jsx)("option",{value:"",children:"Seleccionar grupo"}),a.map(e=>(0,t.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"A\xf1o"}),(0,t.jsx)("input",{type:"number",value:l,onChange:e=>c(parseInt(e.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",min:"2020",max:new Date().getFullYear()})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Mes"}),(0,t.jsx)("select",{value:u,onChange:e=>g(parseInt(e.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",children:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"].map((e,r)=>(0,t.jsx)("option",{value:r+1,children:e},r+1))})]})]})}),n&&(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,t.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Per\xedodo 1 (1-15)"}),(null==C?void 0:C.aplicado_at)&&(0,t.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded",children:"Aplicado"})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"USD → COP"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==C?void 0:C.rate_usd_cop)||"",onChange:e=>w("1-15","rate_usd_cop",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"EUR → USD"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==C?void 0:C.rate_eur_usd)||"",onChange:e=>w("1-15","rate_eur_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"GBP → USD"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==C?void 0:C.rate_gbp_usd)||"",onChange:e=>w("1-15","rate_gbp_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,t.jsx)("button",{onClick:()=>j("1-15"),disabled:b,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:b?"Guardando...":"Guardar Rates"}),(0,t.jsx)("button",{onClick:()=>N("1-15"),disabled:h||!(null==C?void 0:C.id),className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:h?"Aplicando...":"Aplicar Rates"})]})]})]}),(0,t.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-md p-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Per\xedodo 2 (16-31)"}),(null==O?void 0:O.aplicado_at)&&(0,t.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded",children:"Aplicado"})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"USD → COP"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==O?void 0:O.rate_usd_cop)||"",onChange:e=>w("16-31","rate_usd_cop",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"EUR → USD"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==O?void 0:O.rate_eur_usd)||"",onChange:e=>w("16-31","rate_eur_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"GBP → USD"}),(0,t.jsx)("input",{type:"number",step:"0.0001",value:(null==O?void 0:O.rate_gbp_usd)||"",onChange:e=>w("16-31","rate_gbp_usd",e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,t.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,t.jsx)("button",{onClick:()=>j("16-31"),disabled:b,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:b?"Guardando...":"Guardar Rates"}),(0,t.jsx)("button",{onClick:()=>N("16-31"),disabled:h||!(null==O?void 0:O.id),className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm font-medium",children:h?"Aplicando...":"Aplicar Rates"})]})]})]})]}),(0,t.jsx)("div",{className:"mt-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4",children:(0,t.jsxs)("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:[(0,t.jsx)("strong",{children:"⚠️ Importante:"})," Las rates hist\xf3ricas SOLO afectan a per\xedodos pasados en ",(0,t.jsx)("code",{children:"calculator_history"}),'. NO afectan a rates actuales ni a per\xedodos en curso. Al hacer clic en "Aplicar Rates", se recalcular\xe1n todos los valores hist\xf3ricos del per\xedodo seleccionado usando estas rates.']})})]})})}},5922:function(e,r,a){"use strict";a.r(r),a.d(r,{supabase:function(){return t}});let t=(0,a(5257).createClient)("https://mhernfrkvwigxdubiozm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZXJuZnJrdndpZ3hkdWJpb3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MTY1NDcsImV4cCI6MjA3NDM5MjU0N30.v7qBceGTwaqyDZe5h9yLBjWwuuGEwAq6KVsAH_RNw8c")},622:function(e,r,a){"use strict";var t=a(2265),s=Symbol.for("react.element"),o=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,n=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function l(e,r,a){var t,o={},l=null,c=null;for(t in void 0!==a&&(l=""+a),void 0!==r.key&&(l=""+r.key),void 0!==r.ref&&(c=r.ref),r)d.call(r,t)&&!i.hasOwnProperty(t)&&(o[t]=r[t]);if(e&&e.defaultProps)for(t in r=e.defaultProps)void 0===o[t]&&(o[t]=r[t]);return{$$typeof:s,type:e,key:l,ref:c,props:o,_owner:n.current}}r.Fragment=o,r.jsx=l,r.jsxs=l},7437:function(e,r,a){"use strict";e.exports=a(622)}},function(e){e.O(0,[5257,2971,4938,1744],function(){return e(e.s=528)}),_N_E=e.O()}]);