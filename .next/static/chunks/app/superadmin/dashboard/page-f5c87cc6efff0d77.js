(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6344],{6759:function(e,a,r){Promise.resolve().then(r.bind(r,8771))},8771:function(e,a,r){"use strict";r.r(a),r.d(a,{default:function(){return u}});var l=r(7437),s=r(2265),t=r(5922),d=r(1185),o=r(6727);function i(e){let{modelId:a,adminView:r=!1,adminId:t,onSave:d}=e,[i,n]=(0,s.useState)(null),[c,u]=(0,s.useState)([]),[m,g]=(0,s.useState)(null),[x,h]=(0,s.useState)((0,o.dB)()),[v,p]=(0,s.useState)({}),[f,b]=(0,s.useState)(!0),[y,j]=(0,s.useState)(null),[N,k]=(0,s.useState)(null),[D,w]=(0,s.useState)(!1),[L,C]=(0,s.useState)(!1);console.log("\uD83D\uDD0D [MODEL-CALCULATOR] System configuration:",{ENABLE_AUTOSAVE:!1,SYSTEM_VERSION:"V2_ONLY",modelId:a,adminView:r,adminId:t}),(0,s.useEffect)(()=>{(async()=>{try{if(b(!0),r&&t){let e={id:a,name:"Modelo",email:"modelo@ejemplo.com",role:"modelo",groups:[],organization_id:"",is_active:!0,last_login:new Date().toISOString()};n(e)}await O(a)}finally{b(!1)}})()},[a,r,t]);let O=async e=>{try{var a,r,l,s;console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Loading config for userId:",e);let t=await fetch("/api/rates-v2?activeOnly=true"),d=await t.json();if(console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Rates data:",d),d.success&&d.data){let e={usd_cop:(null===(r=d.data.find(e=>"USD→COP"===e.kind))||void 0===r?void 0:r.value)||3900,eur_usd:(null===(l=d.data.find(e=>"EUR→USD"===e.kind))||void 0===l?void 0:l.value)||1.01,gbp_usd:(null===(s=d.data.find(e=>"GBP→USD"===e.kind))||void 0===s?void 0:s.value)||1.2};g(e)}let o=await fetch("/api/calculator/config-v2?modelId=".concat(e));if(!o.ok)throw Error("Error al cargar configuraci\xf3n");let i=await o.json();if(console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Config data:",i),console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Platforms received:",null===(a=i.config)||void 0===a?void 0:a.platforms),!i.success)throw Error(i.error||"Error al cargar configuraci\xf3n");let n=i.config.platforms.filter(e=>e.enabled).map(e=>({id:e.id,name:e.name,enabled:!0,value:0,percentage:e.percentage_override||e.group_percentage||80,minQuota:470,currency:e.currency||"USD",percentage_override:e.percentage_override,group_percentage:e.group_percentage}));console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Enabled platforms:",n),u(n);try{console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Loading saved values - V2 system only");let a=await fetch("/api/calculator/model-values-v2?modelId=".concat(e,"&periodDate=").concat(x)),r=await a.json();if(console.log("\uD83D\uDD0D [MODEL-CALCULATOR] Saved values (v2):",r),r.success&&Array.isArray(r.data)&&r.data.length>0){let e={};r.data.forEach(a=>{e[a.platform_id]=a.value.toString()}),p(e),u(a=>a.map(a=>({...a,value:parseFloat(e[a.id])||0})))}}catch(e){console.warn("⚠️ [MODEL-CALCULATOR] Error loading saved values:",e)}}catch(e){console.error("❌ [MODEL-CALCULATOR] Error loading calculator config:",e),j("Error al cargar configuraci\xf3n de la calculadora")}},E=(e,a)=>{p(r=>({...r,[e]:a})),u(r=>r.map(r=>r.id===e?{...r,value:parseFloat(a)||0}:r))},S=()=>{if(!m)return;let e=c.filter(e=>e.enabled&&e.value>0);if(0===e.length){k(null);return}let a=e.map(e=>{let a=0,r=0;"EUR"===e.currency?r="big7"===e.id?.84*(a=e.value*m.eur_usd):"mondo"===e.id?.78*(a=e.value*m.eur_usd):a=e.value*m.eur_usd:"GBP"===e.currency?r="aw"===e.id?.677*(a=e.value*m.gbp_usd):a=e.value*m.gbp_usd:"USD"===e.currency&&("cmd"===e.id||"camlust"===e.id||"skypvt"===e.id?(a=e.value,r=.75*e.value):"chaturbate"===e.id||"myfreecams"===e.id||"stripchat"===e.id?(a=e.value,r=.05*e.value):"dxlive"===e.id?(a=e.value,r=.6*e.value):"secretfriends"===e.id?(a=e.value,r=.5*e.value):(e.id,a=e.value,r=e.value));let l=(r=e.percentage/100*r)*m.usd_cop;return{platformId:e.id,usdBruto:a,usdModelo:r,copModelo:l}}),r=a.reduce((e,a)=>e+a.usdBruto,0),l=a.reduce((e,a)=>e+a.usdModelo,0),s=a.reduce((e,a)=>e+a.copModelo,0);k({perPlatform:a,totalUsdBruto:r,totalUsdModelo:l,totalCopModelo:s,cuotaMinimaAlert:{below:l<470,percentToReach:l<470?(470-l)/470*100:0},anticipoMaxCop:.9*s})},_=async()=>{if(i)try{C(!0);let e=c.filter(e=>e.enabled&&e.value>0).reduce((e,a)=>(e[a.id]=a.value,e),{}),a=await fetch("/api/calculator/model-values-v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({modelId:i.id,values:e,periodDate:x})}),r=await a.json();if(!r.success)throw Error(r.error||"Error al guardar valores");if(console.log("✅ [MODEL-CALCULATOR] Values saved successfully"),N){let e=await fetch("/api/calculator/totals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({modelId:i.id,periodDate:x,totalUsdBruto:N.totalUsdBruto,totalUsdModelo:N.totalUsdModelo,totalCopModelo:N.totalCopModelo})}),a=await e.json();a.success?console.log("✅ [MODEL-CALCULATOR] Totals saved successfully"):console.error("❌ [MODEL-CALCULATOR] Error saving totals:",a.error)}d&&d(c)}catch(e){console.error("❌ [MODEL-CALCULATOR] Error saving values:",e),j("Error al guardar valores")}finally{C(!1)}};return((0,s.useEffect)(()=>{S()},[c,m]),f)?(0,l.jsx)("div",{className:"min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center",children:(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,l.jsx)("p",{className:"text-gray-600 dark:text-gray-300",children:"Cargando calculadora..."})]})}):y?(0,l.jsx)("div",{className:"min-h-screen bg-white dark:bg-gray-900 flex items-center justify-center",children:(0,l.jsxs)("div",{className:"text-center p-6 bg-red-50 rounded-xl border border-red-200",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold text-red-800 mb-4",children:"Error"}),(0,l.jsx)("p",{className:"text-red-700",children:y})]})}):(0,l.jsx)("div",{className:"min-h-screen bg-white dark:bg-gray-900",children:(0,l.jsxs)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[(0,l.jsx)("div",{className:"mb-6 flex items-center justify-between",children:(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-1",children:"Mi Calculadora"}),(0,l.jsxs)("p",{className:"text-gray-500 dark:text-gray-300 text-sm",children:["Bienvenida, ",(null==i?void 0:i.name)||"Usuario"," \xb7 Ingresa tus valores por plataforma"]})]})}),m&&(0,l.jsxs)("div",{className:"mb-6",children:[(0,l.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3",children:"Tasas Actualizadas"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,l.jsx)("div",{className:"bg-blue-50 p-4 rounded-lg",children:(0,l.jsxs)("div",{className:"text-2xl font-bold text-blue-900",children:["$",m.usd_cop.toLocaleString()," USD→COP"]})}),(0,l.jsx)("div",{className:"bg-green-50 p-4 rounded-lg",children:(0,l.jsxs)("div",{className:"text-2xl font-bold text-green-900",children:[m.eur_usd," EUR→USD"]})}),(0,l.jsx)("div",{className:"bg-purple-50 p-4 rounded-lg",children:(0,l.jsxs)("div",{className:"text-2xl font-bold text-purple-900",children:[m.gbp_usd," GBP→USD"]})})]}),(0,l.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-300 mt-2",children:"Configuradas por tu administrador"})]}),(0,l.jsxs)("div",{className:"bg-white dark:bg-gray-700 rounded-xl shadow-sm dark:shadow-lg dark:shadow-indigo-900/10 dark:ring-0.5 dark:ring-indigo-500/15 border border-gray-200 dark:border-gray-600 p-6",children:[(0,l.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4",children:"Calculadora de Ingresos"}),0===c.length?(0,l.jsxs)("div",{className:"text-center py-12",children:[(0,l.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,l.jsx)("svg",{className:"w-8 h-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),(0,l.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"No hay plataformas habilitadas"}),(0,l.jsx)("p",{className:"text-gray-500 dark:text-gray-300",children:"Tu administrador a\xfan no ha configurado las plataformas para tu calculadora."})]}):(0,l.jsx)("div",{className:"space-y-4",children:c.map(e=>(0,l.jsxs)("div",{className:"flex items-center space-x-4 p-4 bg-gray-50 rounded-lg",children:[(0,l.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,l.jsx)("input",{type:"checkbox",checked:e.enabled,onChange:a=>{u(r=>r.map(r=>r.id===e.id?{...r,enabled:a.target.checked}:r))},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),(0,l.jsx)("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:e.name})]}),e.enabled&&(0,l.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,l.jsx)("input",{type:"text",value:v[e.id]||"",onChange:a=>E(e.id,a.target.value),className:"w-24 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"0"}),(0,l.jsx)("span",{className:"text-sm text-gray-500 dark:text-gray-300",children:e.currency}),(0,l.jsxs)("span",{className:"text-sm text-gray-500 dark:text-gray-300",children:["(",e.percentage,"%)"]})]})]},e.id))}),N&&(0,l.jsx)("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-100",children:"Total USD:"}),(0,l.jsxs)("div",{className:"text-lg font-bold text-blue-900",children:["$",N.totalUsdModelo.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-100",children:"Total COP:"}),(0,l.jsxs)("div",{className:"text-lg font-bold text-green-900",children:["$",N.totalCopModelo.toLocaleString("es-CO")]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-100",children:"Anticipo M\xe1ximo:"}),(0,l.jsxs)("div",{className:"text-lg font-bold text-purple-900",children:["$",N.anticipoMaxCop.toLocaleString("es-CO")]})]})]})}),c.length>0&&(0,l.jsx)("div",{className:"mt-6 flex justify-end",children:(0,l.jsx)("button",{onClick:_,disabled:L,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:L?"Guardando...":"Guardar Valores"})})]})]})})}var n=r(9728),c=r(4065);function u(){let[e,a]=(0,s.useState)({total:0,super_admin:0,admin:0,modelo:0}),[r,o]=(0,s.useState)(!0),[u,m]=(0,s.useState)(null);return(0,s.useEffect)(()=>{(async()=>{try{var e,r,l,s;o(!0);let{data:d}=await t.O.auth.getUser(),i=null==d?void 0:null===(e=d.user)||void 0===e?void 0:e.id;if(!i){m(null),o(!1);return}let{data:n}=await t.O.from("users").select("id,name,email,role").eq("id",i).single(),c=[];if(n&&"super_admin"!==n.role){let{data:e}=await t.O.from("user_groups").select("groups(name)").eq("user_id",i);c=(e||[]).map(e=>{var a;return null===(a=e.groups)||void 0===a?void 0:a.name}).filter(Boolean)}let u={id:(null==n?void 0:n.id)||i,name:(null==n?void 0:n.name)||(null===(l=d.user)||void 0===l?void 0:null===(r=l.email)||void 0===r?void 0:r.split("@")[0])||"Usuario",email:(null==n?void 0:n.email)||(null===(s=d.user)||void 0===s?void 0:s.email)||"",role:(null==n?void 0:n.role)||"modelo",groups:c};m(u);let{data:g}=await t.O.from("users").select("id,role");if(g){let e=g.length,r=g.filter(e=>"super_admin"===e.role).length,l=g.filter(e=>"admin"===e.role).length,s=g.filter(e=>"modelo"===e.role).length;a({total:e,super_admin:r,admin:l,modelo:s})}}finally{o(!1)}})()},[]),(0,l.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900",children:(0,l.jsxs)("div",{className:"max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-16",children:[(0,l.jsx)("div",{className:"mb-12",children:(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-600/10 to-indigo-600/10 rounded-xl blur-xl"}),(0,l.jsx)("div",{className:"relative bg-white/80 dark:bg-gray-700/80 backdrop-blur-sm rounded-xl p-6 border border-white/20 dark:border-gray-600/20 shadow-lg dark:shadow-lg dark:shadow-blue-900/15 dark:ring-0.5 dark:ring-blue-400/20",children:(0,l.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,l.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md",children:(0,l.jsx)("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h1",{className:"text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 dark:from-gray-100 dark:to-gray-300 bg-clip-text text-transparent",children:"Dashboard"}),u&&(0,l.jsxs)("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:["Bienvenido, ",u.name," \xb7 Rol: ",String(u.role).replace("_"," "),"super_admin"!==u.role&&u.groups.length>0&&" \xb7 Grupos: ".concat(u.groups.join(", "))]})]})]})})]})}),((null==u?void 0:u.role)==="super_admin"||(null==u?void 0:u.role)==="admin")&&(0,l.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10",children:[(0,l.jsx)(d.Z,{compact:!0}),(0,l.jsx)(c.Z,{userRole:u.role,userId:u.id,userGroups:u.groups})]}),((null==u?void 0:u.role)==="super_admin"||(null==u?void 0:u.role)==="admin")&&(0,l.jsx)("div",{className:"mb-10",children:(0,l.jsx)(n.Z,{userRole:u.role,userGroups:u.groups})}),(null==u?void 0:u.role)==="modelo"&&(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"relative bg-white/70 dark:bg-gray-800/70 backdrop-blur-sm rounded-xl shadow-md border border-white/20 dark:border-gray-700/20 p-6",children:[(0,l.jsxs)("div",{className:"flex items-center space-x-2 mb-4",children:[(0,l.jsx)("div",{className:"w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-md flex items-center justify-center",children:(0,l.jsx)("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),(0,l.jsx)("h2",{className:"text-base font-semibold text-gray-900 dark:text-gray-100",children:"Mi perfil"})]}),(0,l.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-4",children:"Revisa tu informaci\xf3n"}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("div",{className:"text-sm text-gray-700 dark:text-gray-200",children:["Email: ",u.email]}),(0,l.jsxs)("div",{className:"text-sm text-gray-700 dark:text-gray-200",children:["Grupo: ",u.groups[0]||"—"]})]})]}),(0,l.jsx)(i,{modelId:u.id,adminView:!1})]})]})})}}},function(e){e.O(0,[5257,9922,3792,2971,4938,1744],function(){return e(e.s=6759)}),_N_E=e.O()}]);