"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4452],{4452:function(e,t,n){n.r(t),n.d(t,{default:function(){return N}});var r=n(7437),a=n(2265),o=n(4887),s=n(5922),i=n(8115);let l="f91c0968-b587-46cf-9036-05a4ec795c7f",c="AIM Botty",d="aim-botty@agencia-innova.com";function u(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"medium",a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=(null==e?void 0:e.id)===l||(null==e?void 0:e.email)===d,s=(null==e?void 0:e.role)||"modelo",i=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return n?"bg-gradient-to-br from-purple-500 via-indigo-500 to-purple-600":t?"bg-gradient-to-br from-gray-500 to-gray-600":"super_admin"===e?"bg-gradient-to-br from-amber-500 via-yellow-500 to-amber-600":"admin"===e?"bg-gradient-to-br from-blue-500 to-indigo-600":"bg-gradient-to-br from-pink-500 via-rose-500 to-purple-500"}(s,a,o),c="small"===n?"w-6 h-6":"w-8 h-8",u=o?"rounded-xl border border-purple-400/30":"rounded-full",h="medium"===n?"shadow-md":"shadow-sm";return o?(0,r.jsx)("div",{className:"".concat(c," ").concat(i," ").concat(u," flex items-center justify-center ").concat(h," flex-shrink-0"),children:(0,r.jsx)("span",{className:"text-xs leading-none",children:"\uD83E\uDD16"})}):(t="super_admin"===s?(0,r.jsxs)("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-full h-full",children:[(0,r.jsx)("path",{d:"M5 16L3 10l5.5-2L12 10l3.5-2L21 10l-2 6H5zm14.5-7.5L18.5 8l-3.5 1.5L12 8l-2.5 1.5L6 8l-1 0.5L5 11l14 0.5z"}),(0,r.jsx)("circle",{cx:"8",cy:"16",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"16",cy:"16",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"12",cy:"14",r:"1.5",fill:"currentColor",opacity:"0.9"})]},"crown"):"admin"===s?(0,r.jsx)("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-full h-full",children:(0,r.jsx)("path",{d:"M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.4-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"})},"gear"):(0,r.jsxs)("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-full h-full",children:[(0,r.jsx)("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor"}),(0,r.jsx)("circle",{cx:"12",cy:"8",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"12",cy:"16",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"8",cy:"12",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"16",cy:"12",r:"1.5",fill:"currentColor",opacity:"0.8"}),(0,r.jsx)("circle",{cx:"10",cy:"10",r:"1.2",fill:"currentColor",opacity:"0.7"}),(0,r.jsx)("circle",{cx:"14",cy:"10",r:"1.2",fill:"currentColor",opacity:"0.7"}),(0,r.jsx)("circle",{cx:"10",cy:"14",r:"1.2",fill:"currentColor",opacity:"0.7"}),(0,r.jsx)("circle",{cx:"14",cy:"14",r:"1.2",fill:"currentColor",opacity:"0.7"})]},"flower"),(0,r.jsx)("div",{className:"".concat(c," ").concat(i," ").concat(u," flex items-center justify-center ").concat(h," flex-shrink-0 relative overflow-hidden border border-white/20"),children:(0,r.jsx)("div",{className:"".concat("small"===n?"w-3.5 h-3.5":"w-4.5 h-4.5"," text-white flex items-center justify-center"),children:t})}))}var h=e=>{var t;let{message:n,onCancel:a}=e,o=(null===(t=n.sender)||void 0===t?void 0:t.name)||"Usuario",s=n.content.length>50?n.content.substring(0,50)+"...":n.content;return(0,r.jsxs)("div",{className:"flex items-start gap-2 p-2 bg-gray-700/50 border-l-4 border-blue-500 rounded mb-2",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-xs text-blue-400 font-medium mb-1",children:o}),(0,r.jsx)("p",{className:"text-sm text-gray-300 truncate",children:s})]}),(0,r.jsx)("button",{onClick:a,className:"flex-shrink-0 text-gray-400 hover:text-white transition-colors","aria-label":"Cancelar respuesta",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})},m=e=>{var t;let{message:n,isOwnMessage:a=!1}=e,o=(null===(t=n.sender)||void 0===t?void 0:t.name)||"Usuario",s=n.content.length>100?n.content.substring(0,100)+"...":n.content;return(0,r.jsxs)("div",{className:"mt-1 mb-2 p-2 rounded border-l-4 ".concat(a?"bg-blue-500/20 border-blue-400":"bg-gray-700/50 border-gray-500"),children:[(0,r.jsx)("p",{className:"text-xs font-medium mb-1 text-gray-400",children:o}),(0,r.jsx)("p",{className:"text-xs text-gray-300 line-clamp-2",children:s})]})};function g(e){let{conversationId:t,otherUser:n,onClose:o,userId:i,userRole:g,session:x,windowIndex:f=0,isInChatBar:v=!1}=e,[p,D]=(0,a.useState)([]),[w,b]=(0,a.useState)(""),[y,j]=(0,a.useState)(!1),[C,E]=(0,a.useState)(null),[N,_]=(0,a.useState)(!1),[k,W]=(0,a.useState)(!1),[L,S]=(0,a.useState)({}),[I,A]=(0,a.useState)({x:0,y:0}),[M,T]=(0,a.useState)({x:0,y:0}),B=(0,a.useRef)(null),R=(0,a.useRef)(null),F=(0,a.useRef)(null),z=()=>{if(v)return{x:8+336*f,y:0};{let e=window.innerHeight-500-24,t=window.innerWidth-24-320,n=t-20+340*f,r=Math.max(20,n);return console.log("\uD83E\uDE9F [IndividualChatWindow] Posici\xf3n flotante (DERECHA A IZQUIERDA):",{windowIndex:f,finalX:n,adjustedX:r,finalY:e,mainChatLeftEdge:t,calculation:"".concat(t," - ").concat(20," + (").concat(f," * (").concat(320," + ").concat(20,"))")}),{x:r,y:e}}};(0,a.useEffect)(()=>{A(z())},[f,v]),(0,a.useEffect)(()=>{if(p.length>0){let e=p[p.length-1];if(e.sender_id!==i){let t=new Date(e.created_at);new Date().getTime()-t.getTime()<5e3&&console.log("\uD83D\uDD14 [IndividualChat] Mensaje nuevo detectado")}}},[p]),(0,a.useEffect)(()=>{if(!t||!x)return;let e=async()=>{try{let e=await fetch("/api/chat/messages?conversation_id=".concat(t),{headers:{Authorization:"Bearer ".concat(x.access_token)}});if(e.ok){let t=await e.json();t.success&&t.messages&&D(t.messages)}}catch(e){console.error("❌ [IndividualChat] Error en polling:",e)}};e();let n=setInterval(e,2e3);return()=>clearInterval(n)},[t,x]),(0,a.useEffect)(()=>{if(!k&&p.length>0){let e=setTimeout(()=>{p.forEach(e=>{e.sender_id!==i&&S(t=>({...t,[e.id]:"read"}))})},2e3);return()=>clearTimeout(e)}},[p,k,i]);let O=e=>e.id===l||e.email===d?c:"modelo"===e.role?e.email.split("@")[0]:e.name||e.email||"Usuario",P=e=>{let t=new Date,n=new Date(e),r=Math.floor((t.getTime()-n.getTime())/6e4);return r<1?"Ahora":r<60?"hace ".concat(r,"m"):r<1440?"hace ".concat(Math.floor(r/60),"h"):r<10080?"hace ".concat(Math.floor(r/1440),"d"):n.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"})},U=async()=>{if(t&&x){null!==F.current&&F.current!==t&&(console.log("\uD83D\uDD04 [IndividualChat] Limpiando mensajes previos al cambiar de conversaci\xf3n"),D([]),b(""));try{j(!0);let e=await fetch("/api/chat/messages?conversation_id=".concat(t),{headers:{Authorization:"Bearer ".concat(x.access_token)}}),n=await e.json();if(n.success){let e=n.messages||[];console.log("\uD83D\uDCE8 [IndividualChat] Mensajes cargados:",{conversationId:t,count:e.length}),D(e)}}catch(e){console.error("Error cargando mensajes:",e)}finally{j(!1)}}},H=async()=>{if(console.log("\uD83D\uDCE4 [IndividualChat] Intentando enviar mensaje:",{newMessage:w.trim(),conversationId:t,hasSession:!!x,sessionToken:(null==x?void 0:x.access_token)?"Presente":"Ausente"}),!w.trim()||!t||!x){console.log("❌ [IndividualChat] Validaci\xf3n fallida:",{hasMessage:!!w.trim(),hasConversationId:!!t,hasSession:!!x});return}try{console.log("\uD83D\uDE80 [IndividualChat] Enviando mensaje a API...");let n=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(x.access_token)},body:JSON.stringify({conversation_id:t,content:w.trim(),reply_to_message_id:C?C.id:void 0})});console.log("\uD83D\uDCE1 [IndividualChat] Respuesta de API:",n.status,n.statusText);let r=await n.json();if(console.log("\uD83D\uDCCB [IndividualChat] Datos de respuesta:",r),r.success){var e;console.log("✅ [IndividualChat] Mensaje enviado exitosamente"),(null===(e=r.message)||void 0===e?void 0:e.id)&&(S(e=>({...e,[r.message.id]:"sent"})),setTimeout(()=>{S(e=>({...e,[r.message.id]:"delivered"}))},1e3)),b(""),E(null),await U()}else console.log("❌ [IndividualChat] Error en respuesta:",r.error)}catch(e){console.error("❌ [IndividualChat] Error enviando mensaje:",e)}},V=()=>{var e;null===(e=R.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,a.useEffect)(()=>{V()},[p]),(0,a.useEffect)(()=>{null!==F.current&&F.current!==t&&t&&(console.log("\uD83D\uDD04 [IndividualChat] Cambio de conversaci\xf3n detectado:",{from:F.current,to:t}),D([]),b(""),S({})),F.current=t},[t]),(0,a.useEffect)(()=>{U()},[t]),(0,a.useEffect)(()=>{if(!t)return;let e=s.supabase.channel("individual-chat-".concat(t)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"conversation_id=eq.".concat(t)},async e=>{console.log("\uD83D\uDCE8 [IndividualChat] Nuevo mensaje recibido:",e),await U()}).subscribe();return()=>{s.supabase.removeChannel(e)}},[t]);let q=e=>{N&&A({x:e.clientX-M.x,y:e.clientY-M.y})},J=()=>{_(!1)};(0,a.useEffect)(()=>{if(N)return document.addEventListener("mousemove",q),document.addEventListener("mouseup",J),()=>{document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",J)}},[N,M]);let K=((null==n?void 0:n.email)||"").split("@")[0]||O(n);return(0,r.jsxs)("div",{ref:B,className:"w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] ".concat(v?"absolute":"fixed"),style:v?{left:"".concat(I.x,"px"),bottom:"0px",cursor:"default",height:k?"48px":"500px"}:{left:"".concat(I.x,"px"),top:"".concat(I.y,"px"),cursor:N?"grabbing":"default",height:k?"48px":"500px"},children:[(0,r.jsxs)("div",{className:"flex items-center justify-between ".concat(k?"px-3 py-2":"p-4"," border-b border-gray-700 bg-gray-900 rounded-t-lg ").concat(v?"cursor-default":"cursor-grab active:cursor-grabbing"),onMouseDown:v?void 0:e=>{if(B.current){let t=B.current.getBoundingClientRect();T({x:e.clientX-t.left,y:e.clientY-t.top}),_(!0)}},children:[k?(0,r.jsx)("div",{className:"flex items-center min-w-0 pr-2",children:(0,r.jsx)("span",{className:"text-white text-sm font-medium truncate",title:K,children:K})}):(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[u(n,"medium",!1),(0,r.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,r.jsx)("h3",{className:"text-white font-semibold text-sm truncate",children:O(n)}),n.id!==l&&n.email!==d&&(0,r.jsx)("p",{className:"text-gray-400 text-xs truncate",children:n.role})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[(0,r.jsx)("button",{onClick:()=>W(e=>!e),className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Minimizar","aria-expanded":!k,children:k?(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8h12a2 2 0 0 1 2 2v8H6a2 2 0 0 1-2-2V8z"})}):(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,r.jsx)("button",{onClick:o,className:"p-1 text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),!k&&(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[y?(0,r.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,r.jsx)("div",{className:"text-gray-400",children:"Cargando mensajes..."})}):0===p.length?(0,r.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,r.jsxs)("div",{className:"text-gray-400 text-center",children:[(0,r.jsx)("p",{children:"No hay mensajes a\xfan"}),(0,r.jsx)("p",{className:"text-xs mt-1",children:"Env\xeda el primer mensaje"})]})}):p.map(e=>(0,r.jsx)("div",{className:"flex ".concat(e.sender_id===i?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-[70%] px-3 py-2 rounded-lg group ".concat(e.sender_id===i?"bg-blue-600 text-white":"bg-gray-700 text-gray-100"),children:[e.is_broadcast&&(0,r.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-purple-500/20 text-purple-200 border border-purple-400/30 mr-2",children:"Difusi\xf3n"}),e.reply_to_message&&(0,r.jsx)(m,{message:e.reply_to_message,isOwnMessage:e.sender_id===i}),(0,r.jsx)("p",{className:"text-sm",children:(()=>{let t;let n=e.content||"",a=/\[LINK:([^\|]+)\|([^\]]+)\]/g,o=[],s=0,i=0;for(;null!==(t=a.exec(n));){t.index>s&&o.push(n.substring(s,t.index));let e=t[1],a=t[2],l="#"===a;o.push((0,r.jsx)("a",{href:a,onClick:e=>{if(l){e.preventDefault();return}e.preventDefault(),window.location.href=a},className:"underline font-medium hover:opacity-80 transition-opacity text-blue-300",target:a.startsWith("http")?"_blank":void 0,rel:a.startsWith("http")?"noopener noreferrer":void 0,children:e},i++)),s=t.index+t[0].length}return s<n.length&&o.push(n.substring(s)),o.length>0?(0,r.jsx)(r.Fragment,{children:o}):n})()}),(0,r.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>E(e),className:"opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-gray-600/50 text-gray-300 hover:text-white",title:"Responder mensaje","aria-label":"Responder mensaje",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})})}),(0,r.jsx)("p",{className:"text-xs opacity-70",children:P(e.created_at)})]}),e.sender_id===i&&(0,r.jsx)("span",{className:"ml-2 flex items-center",title:e.is_read_by_other?"Visto":"Entregado",children:e.is_read_by_other?(0,r.jsxs)("span",{className:"inline-flex items-center",style:{width:"16px"},children:[(0,r.jsx)("svg",{className:"w-3.5 h-3.5 text-cyan-300",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),(0,r.jsx)("svg",{className:"w-3.5 h-3.5 text-cyan-300 -ml-1.5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}):(0,r.jsx)("svg",{className:"w-3.5 h-3.5 text-white/70",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]})]})},e.id)),(0,r.jsx)("div",{ref:R})]}),!k&&(0,r.jsxs)("div",{className:"p-4 border-t border-gray-700",children:[C&&(0,r.jsx)(h,{message:C,onCancel:()=>E(null)}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("input",{type:"text",value:w,onChange:e=>b(e.target.value),onKeyDown:e=>{console.log("⌨️ [IndividualChat] Tecla presionada:",e.key),"Enter"!==e.key||e.shiftKey||(e.preventDefault(),console.log("\uD83D\uDE80 [IndividualChat] Enter presionado, enviando mensaje..."),H())},placeholder:"Escribe tu mensaje...",className:"flex-1 bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,r.jsx)("button",{onClick:()=>{console.log("\uD83D\uDDB1️ [IndividualChat] Bot\xf3n enviar clickeado"),H()},disabled:!w.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg transition-colors","aria-label":"Enviar mensaje",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})]})}function x(e){let{count:t,variant:n="blue",size:a="small",className:o=""}=e;if(0===t)return null;let s=t>99?"99+":t.toString();return(0,r.jsx)("span",{className:"".concat("rounded-full text-white font-medium flex items-center justify-center shadow-sm"," ").concat("small"===a?"text-[10px] px-1 py-0.5 min-w-[16px] h-[16px]":"text-xs px-1.5 py-0.5 min-w-[18px] h-[18px]"," ").concat("blue"===n?"bg-blue-500/90":"bg-rose-600 shadow-rose-500/30 animate-pulse"," ").concat(o),"aria-label":"".concat(t," ").concat(1===t?"mensaje":"mensajes"," no le\xeddos"),children:s})}var f=n(6918);let v=null,p=!1;function D(){if(!v)try{v=new(window.AudioContext||window.webkitAudioContext)}catch(e){return console.warn("⚠️ Web Audio API no disponible:",e),null}return"suspended"===v.state&&v.resume().catch(()=>{console.warn("⚠️ No se pudo reanudar AudioContext")}),v}function w(){if(p&&v&&"running"===v.state)return;let e=D();if(e)try{"suspended"===e.state&&e.resume().catch(e=>console.warn("⚠️ No se pudo reanudar AudioContext en unlock:",e));let t=e.createBuffer(1,1,22050),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start(0),p=!0,console.log("\uD83D\uDD0A [Audio] Sistema de audio desbloqueado y listo")}catch(e){console.warn("⚠️ Error al desbloquear audio:",e)}}async function b(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.6,t=D();if(!t)return!1;try{"suspended"===t.state&&await t.resume();let n=t.currentTime,r=t.createOscillator(),a=t.createGain();return r.connect(a),a.connect(t.destination),r.frequency.setValueAtTime(800,n),r.frequency.exponentialRampToValueAtTime(400,n+.1),r.type="sine",a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(e,n+.01),a.gain.exponentialRampToValueAtTime(.01,n+.3),r.start(n),r.stop(n+.3),r.onended=()=>{r.disconnect(),a.disconnect()},!0}catch(e){return console.warn("⚠️ Error reproduciendo sonido con Web Audio API:",e),!1}}function y(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.6;p||w(),b(e).catch(e=>{console.warn("⚠️ Error al reproducir sonido:",e)})}var j=e=>{var t;let{onClose:n,userId:o,userRole:s,session:i,windowIndex:c=0,view:g="users",setView:v,availableUsers:p=[],expandedSections:D={online:!0,offline:!1},setExpandedSections:b,openChatWithUser:j,conversations:C=[],selectedConversation:E,setSelectedConversation:N,messages:_=[],newMessage:k="",setNewMessage:W,sendMessage:L,handleKeyPress:S,showDeleteConfirm:I,setShowDeleteConfirm:A,deleteConversation:M,tempChatUser:T,getDisplayName:B=e=>e.name||e.email,replyTo:R,setReplyTo:F}=e,z=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"medium",n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return u(e,t,n)},[O,P]=(0,a.useState)(""),[U,H]=(0,a.useState)(!1),[V,q]=(0,a.useState)(!1),J=(0,a.useRef)(null),[K,Y]=(0,a.useState)(!1),[Z,G]=(0,a.useState)(null),X=(0,a.useRef)(new Set);(0,a.useEffect)(()=>{if(_&&_.length>0){let e=_[_.length-1];if(X.current.has(e.id))return;let t="botty_action_processed_".concat(e.id);if(localStorage.getItem(t)){X.current.add(e.id);return}let n=new Date(e.created_at).getTime();if(!(new Date().getTime()-n<6e4)){e.sender_id===l&&"string"==typeof e.content&&e.content.includes("<<ACTION:")&&(X.current.add(e.id),localStorage.setItem(t,"true"));return}if(e.sender_id===l&&"string"==typeof e.content&&e.content.includes("<<ACTION:OPEN_BOOST_MODAL")){let n=e.content.match(/<<ACTION:OPEN_BOOST_MODAL\|([^|]+)\|([^|]+)\|([^>]+)>>/);if(n){let[r,a,o,s]=n;console.log("\uD83D\uDE80 [CHAT-LAUNCHER] Ejecutando acci\xf3n Boost Page:",{modelId:a,modelName:o}),X.current.add(e.id),localStorage.setItem(t,"true"),G({id:a,name:o,email:s}),Y(!0)}}}},[_]);let Q=e=>e?e.replace(/<<ACTION:[^>]+>>/g,"").trim():"",$=(e,t)=>{let n;if(!e)return null;let a=/\[LINK:([^\|]+)\|([^\]]+)\]/g,o=[],s=0,i=0,l=!1;for(a.lastIndex=0;null!==(n=a.exec(e));){l=!0,n.index>s&&o.push(e.substring(s,n.index));let a=n[1],c=n[2],d="#"===c;o.push((0,r.jsx)("a",{href:c,onClick:e=>{if(d){e.preventDefault();return}e.preventDefault(),window.location.href=c},className:"underline font-medium hover:opacity-80 transition-opacity ".concat(t?"text-blue-100":"text-blue-400"),target:c.startsWith("http")?"_blank":void 0,rel:c.startsWith("http")?"noopener noreferrer":void 0,children:a},i++)),s=n.index+n[0].length}return(s<e.length&&o.push(e.substring(s)),l&&o.length>0)?(0,r.jsx)(r.Fragment,{children:o}):null},ee=(C||[]).filter(e=>{var t;let n=null==e?void 0:null===(t=e.last_message)||void 0===t?void 0:t.content;return"string"==typeof n&&n.trim().length>0}),et="chat"===g&&E?null===(t=(C||[]).find(e=>e.id===E))||void 0===t?void 0:t.other_participant:null,en=e=>{let t=new Date;t.setHours(0,0,0,0);let n=new Date(t);n.setDate(n.getDate()-1);let r=new Date(e);return(r.setHours(0,0,0,0),r.getTime()===t.getTime())?"Hoy":r.getTime()===n.getTime()?"Ayer":r.toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})},er=(e,t)=>{let n=new Date(e),r=new Date(t);return n.setHours(0,0,0,0),r.setHours(0,0,0,0),n.getTime()!==r.getTime()},ea=(e,t)=>!!e&&!!t&&e.sender_id===t.sender_id&&3e5>Math.abs(new Date(t.created_at).getTime()-new Date(e.created_at).getTime()),eo=e=>{let t=new Date(e),n=new Date,r=n.getTime()-t.getTime(),a=Math.floor(r/6e4);if(a<60&&t.toDateString()===n.toDateString())return a<1?"hace un momento":1===a?"hace 1 min":"hace ".concat(a," min");if(t.toDateString()===n.toDateString())return t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});let o=new Date(n);if(o.setDate(o.getDate()-1),t.toDateString()===o.toDateString())return"Ayer, ".concat(t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}));if(7>Math.floor(r/864e5)){let e=t.toLocaleDateString("es-ES",{weekday:"short"});return"".concat(e,", ").concat(t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}))}return t.toLocaleDateString("es-ES",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})},es=(0,a.useRef)(null),ei=(0,a.useRef)(null),el=(0,a.useRef)(!1),ec=(0,a.useRef)(null),ed=(0,a.useRef)(0),eu=()=>{try{if(!ei.current)return!0;let e=ei.current;return e.scrollHeight-e.scrollTop-e.clientHeight<=50}catch(e){return!0}},eh=function(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{if(el.current&&!t||!t&&!eu())return;let n=ei.current;if(!n)return;es.current&&es.current.scrollIntoView({behavior:e?"smooth":"auto",block:"end",inline:"nearest"}),n.scrollTop=n.scrollHeight}catch(e){console.error("Error en scrollToBottom:",e),ei.current&&(ei.current.scrollTop=ei.current.scrollHeight)}};(0,a.useEffect)(()=>{"chat"===g&&E&&(el.current=!1,ed.current=0,_.length>0&&requestAnimationFrame(()=>{setTimeout(()=>{eh(!1,!0)},100)}))},[g,E]),(0,a.useEffect)(()=>{"chat"===g&&E&&_.length>0&&(ed.current,ed.current=_.length,requestAnimationFrame(()=>{setTimeout(()=>{eh(!1,!0)},150)}))},[_.length,E]),(0,a.useEffect)(()=>{if("chat"===g&&_.length>0){let e=ed.current;_.length>e&&e>0&&setTimeout(()=>{(!el.current||eu())&&eh(!0,!1)},100),ed.current=_.length}},[_.length]),(0,a.useEffect)(()=>()=>{ec.current&&clearTimeout(ec.current)},[]),(0,a.useEffect)(()=>{P(""),H(!1)},[E]),(0,a.useEffect)(()=>{J.current&&((k||"").includes("\n")?(J.current.style.height="auto",J.current.style.height="".concat(Math.min(J.current.scrollHeight,120),"px"),J.current.style.overflowY="auto"):(J.current.style.height="42px",J.current.style.overflowY="hidden"))},[k]),(0,a.useEffect)(()=>{let e=e=>{let t=e.target;!V||t.closest(".emoji-picker-container")||t.closest(".emoji-button")||q(!1)};if(V)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[V]);let em=e=>{if(W&&J.current){let t=J.current,n=t.selectionStart,r=t.selectionEnd,a=k||"";W(a.substring(0,n)+e+a.substring(r)),setTimeout(()=>{t.focus(),t.setSelectionRange(n+e.length,n+e.length)},0)}};return(0,r.jsxs)("div",{className:"w-[calc(100%-2rem)] sm:w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl flex flex-col z-[9996] fixed left-4 right-4 sm:left-auto sm:right-[calc(24px+40px+28px)]",style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + ".concat(24,"px)"),cursor:"default",maxHeight:"calc(100vh - 20px)",height:"500px"},children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900 rounded-t-lg cursor-default",children:[(0,r.jsx)("div",{className:"flex items-center space-x-3 min-w-0 flex-1",children:et?(0,r.jsxs)(r.Fragment,{children:[z(et,"medium"),(0,r.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,r.jsx)("p",{className:"text-white text-sm font-semibold truncate",title:null==B?void 0:B(et),children:null==B?void 0:B(et)}),et.id!==l&&et.email!==d&&(0,r.jsx)("p",{className:"text-gray-400 text-xs truncate",children:et.role})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300 rounded-xl flex items-center justify-center shadow-md border border-white/20 dark:border-gray-700/30 flex-shrink-0",children:(0,r.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-xs tracking-wider",children:"AIM"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-white text-sm font-semibold",children:"AIM Assistant"}),(0,r.jsx)("p",{className:"text-gray-400 text-xs",children:"Soporte y tips"})]})]})}),"chat"===g&&(0,r.jsx)(r.Fragment,{children:U?(0,r.jsxs)("div",{className:"flex items-center space-x-2 flex-1 ml-4",children:[(0,r.jsx)("input",{type:"text",value:O,onChange:e=>P(e.target.value),placeholder:"Buscar en conversaci\xf3n...",className:"flex-1 px-2 py-1.5 text-sm rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0,"aria-label":"Buscar mensajes"}),(0,r.jsx)("button",{onClick:()=>{P(""),H(!1)},className:"text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar b\xfasqueda",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}):(0,r.jsx)("button",{onClick:()=>H(!0),className:"text-gray-400 hover:text-white transition-colors ml-2","aria-label":"Buscar en conversaci\xf3n",title:"Buscar en conversaci\xf3n",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})}),(0,r.jsx)("button",{onClick:n,className:"text-gray-400 hover:text-white ml-2",children:(0,r.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),w(),y(.8)},className:"text-gray-600 hover:text-gray-400 ml-1 p-1 opacity-0 hover:opacity-100 transition-opacity",title:"Probar sonido (Debug)",children:(0,r.jsx)("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),(0,r.jsxs)("div",{className:"flex border-b border-gray-700 px-2 gap-2",children:[(0,r.jsx)("button",{onClick:()=>null==v?void 0:v("users"),className:"flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ".concat("users"===g?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"),children:"Usuarios disponibles"}),(0,r.jsxs)("button",{onClick:()=>{null==v||v("conversations")},className:"flex-1 px-3 py-2 text-xs font-medium rounded-t-md transition-colors ".concat("conversations"===g?"text-white bg-gray-700/60 ring-1 ring-inset ring-gray-600":"text-gray-300 hover:text-white hover:bg-gray-700/40"," ").concat(""),children:["Conversaciones (",ee.length,")"]})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden relative",children:["users"===g&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:[(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsxs)("button",{onClick:()=>null==b?void 0:b({...D,online:!D.online}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,r.jsxs)("span",{className:"flex items-center",children:[(0,r.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"En l\xednea (",p.filter(e=>e.is_online).length,")"]}),(0,r.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(D.online?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),D.online&&(0,r.jsx)("div",{className:"ml-4 space-y-1",children:p.filter(e=>e.is_online).map(e=>(0,r.jsxs)("button",{onClick:()=>null==j?void 0:j(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,r.jsx)("div",{className:"mr-3",children:z(e,"small")}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm font-medium",children:B(e)}),e.id!==l&&e.email!==d&&(0,r.jsx)("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsxs)("button",{onClick:()=>null==b?void 0:b({...D,offline:!D.offline}),className:"flex items-center justify-between w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,r.jsxs)("span",{className:"flex items-center",children:[(0,r.jsx)("span",{className:"w-2 h-2 bg-gray-500 rounded-full mr-2"}),"Offline (",p.filter(e=>!e.is_online).length,")"]}),(0,r.jsx)("svg",{className:"w-4 h-4 transition-transform ".concat(D.offline?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),D.offline&&(0,r.jsx)("div",{className:"ml-4 space-y-1",children:p.filter(e=>!e.is_online).map(e=>(0,r.jsxs)("button",{onClick:()=>null==j?void 0:j(e.id),className:"flex items-center w-full p-2 text-left text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition-colors",children:[(0,r.jsx)("div",{className:"mr-3",children:z(e,"small",!0)}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm font-medium",children:B(e)}),e.id!==l&&e.email!==d&&(0,r.jsx)("p",{className:"text-xs text-gray-400",children:e.role})]})]},e.id))})]})]})})}),"conversations"===g&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"p-4 flex-1 flex flex-col min-h-0",children:(0,r.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar space-y-2 min-h-0",children:0===ee.length?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[(0,r.jsx)("svg",{className:"w-12 h-12 mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,r.jsx)("p",{className:"text-sm text-center",children:"No hay conversaciones activas"}),(0,r.jsx)("p",{className:"text-xs text-center mt-1",children:"Los mensajes aparecer\xe1n aqu\xed cuando inicies una conversaci\xf3n"})]}):ee.map(e=>{var t;return(0,r.jsxs)("div",{className:"flex items-center w-full p-2 text-left rounded-lg transition-colors ".concat(E===e.id?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:[(0,r.jsxs)("button",{onClick:()=>{null==j||j(e.other_participant.id)},className:"flex items-center flex-1 min-w-0 text-left",children:[(0,r.jsx)("div",{className:"mr-3",children:z(e.other_participant,"medium")}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium truncate",children:B(e.other_participant)}),(0,r.jsx)("p",{className:"text-xs text-gray-400 truncate",children:null===(t=e.last_message)||void 0===t?void 0:t.content})]})]}),e.unread_count>0&&(0,r.jsx)("div",{className:"ml-2",children:e.unread_count<=3?(0,r.jsx)("span",{className:"w-2 h-2 bg-blue-500 rounded-full inline-block","aria-label":"".concat(e.unread_count," mensajes no le\xeddos")}):(0,r.jsx)(x,{count:e.unread_count,variant:"blue",size:"small"})}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),null==A||A(e.id)},className:"ml-2 p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-600/50","aria-label":"Eliminar conversaci\xf3n",title:"Eliminar conversaci\xf3n",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-7 0a2 2 0 012-2h4a2 2 0 012 2m-8 0H5"})})})]},e.id)})})})}),"chat"===g&&E&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{ref:ei,className:"flex-1 px-1 py-4 overflow-y-auto custom-scrollbar min-h-0",onScroll:()=>{ei.current&&(ec.current&&clearTimeout(ec.current),eu()?el.current=!1:(el.current=!0,ec.current=setTimeout(()=>{eu()&&(el.current=!1)},1500)))},children:[O&&(0,r.jsx)("div",{className:"mb-2 text-center",children:(0,r.jsxs)("p",{className:"text-xs text-gray-400",children:[_.filter(e=>{var t;return null===(t=e.content)||void 0===t?void 0:t.toLowerCase().includes(O.toLowerCase())}).length," resultado",1!==_.filter(e=>{var t;return null===(t=e.content)||void 0===t?void 0:t.toLowerCase().includes(O.toLowerCase())}).length?"s":""]})}),(O?_.filter(e=>{var t;return null===(t=e.content)||void 0===t?void 0:t.toLowerCase().includes(O.toLowerCase())}):_).map((e,t,n)=>{var s,i;let l=t>0?n[t-1]:null,c=t<n.length-1?n[t+1]:null,d=!l||er(l.created_at,e.created_at),u=e.is_system_message||"system"===e.message_type||"system"===e.sender_id,h=e.is_broadcast,g=u||h,x=!g&&l&&ea(l,e),f=!c||!ea(e,c)||er(e.created_at,c.created_at);l&&ea(l,e)&&er(l.created_at,e.created_at);let v=e.sender_id!==o&&!g&&(et||e.sender)||null;return g?(0,r.jsxs)(a.Fragment,{children:[d&&(0,r.jsx)("div",{className:"flex justify-center mt-1 mb-2",children:(0,r.jsx)("span",{className:"px-3 py-1 text-xs text-gray-400 bg-gray-800/50 rounded-full",children:en(new Date(e.created_at))})}),(0,r.jsx)("div",{className:"flex justify-center my-3",children:(0,r.jsxs)("div",{className:"inline-flex items-center max-w-[85%] px-3 py-2 rounded-xl shadow-sm animate-fadeIn ".concat(h?"bg-purple-500/10 border border-purple-500/30 text-purple-200":"bg-gray-800/60 border border-gray-600/50 text-gray-300"),role:"article","aria-label":h?"Mensaje de difusi\xf3n":"Mensaje del sistema",children:[(0,r.jsxs)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium mr-2 ".concat(h?"bg-purple-500/20 text-purple-200 border border-purple-400/30":"bg-gray-700/50 text-gray-400 border border-gray-600/50"),children:[h?(0,r.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3.14a.5.5 0 01.656.736A3.973 3.973 0 0115 8c0 1.477-.998 2.764-2.5 3.5M12 20a3 3 0 100-6 3 3 0 000 6z"})}):(0,r.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),h?"Difusi\xf3n":"Sistema"]}),(0,r.jsx)("p",{className:"text-xs leading-relaxed",children:O?null===(i=Q(e.content))||void 0===i?void 0:i.split(RegExp("(".concat(O,")"),"gi")).map((e,t)=>e.toLowerCase()===O.toLowerCase()?(0,r.jsx)("mark",{className:"bg-yellow-500/40 text-yellow-200 rounded px-0.5",children:e},t):$(e,!1)||e):$(Q(e.content),!1)||Q(e.content)})]})})]},e.id):(0,r.jsxs)(a.Fragment,{children:[d&&(0,r.jsx)("div",{className:"flex justify-center mt-1 mb-2",children:(0,r.jsx)("span",{className:"px-3 py-1 text-xs text-gray-400 bg-gray-800/50 rounded-full",children:en(new Date(e.created_at))})}),(0,r.jsx)("div",{className:"group flex items-start ".concat(x?"mb-1":"mb-3"," ").concat(e.sender_id===o?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"relative max-w-[85%] rounded-2xl animate-fadeIn ".concat(e.sender_id===o?"bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-[0_2px_8px_rgba(59,130,246,0.25)]":"bg-gray-800/95 backdrop-blur-sm text-gray-50 shadow-[0_2px_8px_rgba(0,0,0,0.15)]"),role:"article","aria-label":"Mensaje de ".concat(e.sender_id===o?"ti":B(v||{})," enviado ").concat(eo(e.created_at)),children:[(0,r.jsxs)("div",{className:"px-3.5 py-2.5",children:[e.reply_to_message&&(0,r.jsx)(m,{message:e.reply_to_message,isOwnMessage:e.sender_id===o}),(0,r.jsx)("p",{className:"text-sm leading-[1.4] ".concat(e.sender_id===o?"text-white":"text-gray-50"),children:O?null===(s=Q(e.content))||void 0===s?void 0:s.split(RegExp("(".concat(O,")"),"gi")).map((t,n)=>t.toLowerCase()===O.toLowerCase()?(0,r.jsx)("mark",{className:"".concat(e.sender_id===o?"bg-blue-400/30 text-blue-100":"bg-yellow-500/30 text-yellow-200"," rounded px-0.5"),children:t},n):$(t,e.sender_id===o)||t):$(Q(e.content),e.sender_id===o)||Q(e.content)})]}),f&&(0,r.jsx)("div",{className:"flex items-center justify-between px-3.5 py-1.5 border-t ".concat(e.sender_id===o?"border-blue-400/20":"border-gray-700/50"),children:e.sender_id===o?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"text-[10px] leading-none text-blue-100/70",title:new Date(e.created_at).toLocaleString("es-ES"),children:eo(e.created_at)}),(0,r.jsx)("span",{className:"flex items-center",title:e.is_read_by_other?"Visto":"Entregado",children:e.is_read_by_other?(0,r.jsxs)("span",{className:"inline-flex items-center",style:{width:"13px"},children:[(0,r.jsx)("svg",{className:"w-3 h-3 text-cyan-300",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),(0,r.jsx)("svg",{className:"w-3 h-3 text-cyan-300 -ml-1.5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}):(0,r.jsx)("svg",{className:"w-3 h-3 text-white/70",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),(0,r.jsxs)("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[(0,r.jsx)("button",{onClick:()=>{navigator.clipboard.writeText(e.content)},className:"p-1 rounded-md transition-colors hover:bg-blue-500/30 text-blue-100/70 hover:text-white",title:"Copiar mensaje","aria-label":"Copiar mensaje",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})}),(0,r.jsx)("button",{onClick:()=>{F&&F(e)},className:"p-1 rounded-md transition-colors hover:bg-blue-500/30 text-blue-100/70 hover:text-white",title:"Responder mensaje","aria-label":"Responder mensaje",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})})})]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[(0,r.jsx)("button",{onClick:()=>{navigator.clipboard.writeText(e.content)},className:"p-1 rounded-md transition-colors hover:bg-gray-700/50 text-gray-400/70 hover:text-gray-200",title:"Copiar mensaje","aria-label":"Copiar mensaje",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})}),(0,r.jsx)("button",{onClick:()=>{F&&F(e)},className:"p-1 rounded-md transition-colors hover:bg-gray-700/50 text-gray-400/70 hover:text-gray-200",title:"Responder mensaje","aria-label":"Responder mensaje",children:(0,r.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})})})]}),(0,r.jsx)("div",{className:"flex items-center gap-1.5",children:(0,r.jsx)("span",{className:"text-[10px] leading-none text-gray-400/70",title:new Date(e.created_at).toLocaleString("es-ES"),children:eo(e.created_at)})})]})})]})})]},e.id)}),(0,r.jsx)("div",{ref:es})]}),(0,r.jsxs)("div",{className:"p-4 border-t border-gray-700 flex-shrink-0 bg-gray-800",children:[V&&(0,r.jsxs)("div",{className:"emoji-picker-container mb-3 bg-gray-900/95 backdrop-blur-sm border border-gray-600/50 rounded-xl shadow-2xl p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h4",{className:"text-xs font-semibold text-gray-300",children:"Emojis"}),(0,r.jsx)("button",{onClick:()=>q(!1),className:"text-gray-400 hover:text-white transition-colors","aria-label":"Cerrar emojis",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsx)("div",{className:"space-y-3 max-h-[200px] overflow-y-auto custom-scrollbar",children:Object.entries({smileys:["\uD83D\uDE00","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE05","\uD83E\uDD23","\uD83D\uDE02","\uD83D\uDE42","\uD83D\uDE43","\uD83D\uDE09","\uD83D\uDE0A","\uD83D\uDE07","\uD83E\uDD70","\uD83D\uDE0D","\uD83E\uDD29","\uD83D\uDE18","\uD83D\uDE17","\uD83D\uDE1A","\uD83D\uDE19"],gestures:["\uD83D\uDC4B","\uD83E\uDD1A","\uD83D\uDD90","✋","\uD83D\uDD96","\uD83D\uDC4C","\uD83E\uDD0C","\uD83E\uDD0F","✌️","\uD83E\uDD1E","\uD83E\uDD1F","\uD83E\uDD18","\uD83E\uDD19","\uD83D\uDC48","\uD83D\uDC49","\uD83D\uDC46","\uD83D\uDD95","\uD83D\uDC47","☝️","\uD83D\uDC4D"],hearts:["❤️","\uD83E\uDDE1","\uD83D\uDC9B","\uD83D\uDC9A","\uD83D\uDC99","\uD83D\uDC9C","\uD83D\uDDA4","\uD83E\uDD0D","\uD83E\uDD0E","\uD83D\uDC94","❤️‍\uD83D\uDD25","❤️‍\uD83E\uDE79","\uD83D\uDC95","\uD83D\uDC9E","\uD83D\uDC93","\uD83D\uDC97","\uD83D\uDC96","\uD83D\uDC98","\uD83D\uDC9D","\uD83D\uDC9F"],objects:["\uD83C\uDF89","\uD83C\uDF8A","✨","⭐","\uD83C\uDF1F","\uD83D\uDCAB","\uD83D\uDD25","\uD83D\uDCAF","✅","❌","⚠️","\uD83D\uDCA1","\uD83C\uDFAF","\uD83D\uDE80","\uD83D\uDC8E","\uD83C\uDFC6","\uD83E\uDD47","\uD83C\uDF96️","\uD83C\uDFC5","\uD83C\uDF97️"],symbols:["\uD83D\uDC4D","\uD83D\uDC4E","\uD83D\uDC4F","\uD83D\uDE4C","\uD83D\uDC50","\uD83E\uDD32","\uD83E\uDD1D","\uD83D\uDE4F","✍️","\uD83D\uDCAA","\uD83E\uDDBE","\uD83E\uDDBF","\uD83E\uDDB5","\uD83E\uDDB6","\uD83D\uDC42","\uD83E\uDDBB","\uD83D\uDC43","\uD83E\uDDE0","\uD83E\uDEC0","\uD83E\uDEC1"]}).map(e=>{let[t,n]=e;return(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("p",{className:"text-[10px] text-gray-500 uppercase tracking-wider px-1",children:"smileys"===t?"Caras":"gestures"===t?"Gestos":"hearts"===t?"Corazones":"objects"===t?"Objetos":"S\xedmbolos"}),(0,r.jsx)("div",{className:"grid grid-cols-10 gap-1",children:n.map((e,n)=>(0,r.jsx)("button",{onClick:()=>{em(e),q(!1)},className:"w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-700/50 transition-colors duration-200 text-lg hover:scale-110",title:e,"aria-label":"Insertar emoji ".concat(e),children:e},"".concat(t,"-").concat(n)))})]},t)})})]}),R&&F&&(0,r.jsx)(h,{message:R,onCancel:()=>F(null)}),(0,r.jsxs)("div",{className:"flex space-x-2 items-end",children:[(0,r.jsx)("textarea",{ref:J,value:k,onChange:e=>null==W?void 0:W(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),(null==k?void 0:k.trim())&&L&&L())},placeholder:"Escribe tu mensaje...",className:"flex-1 p-2.5 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none h-[42px] max-h-[120px] text-sm leading-relaxed","aria-label":"Escribe tu mensaje","aria-required":"false",rows:1,style:{overflowY:"hidden",scrollbarWidth:"thin",scrollbarColor:"#4B5563 #374151"}}),(0,r.jsxs)("div",{className:"flex space-x-1.5 items-center",children:[(0,r.jsx)("button",{type:"button",onClick:()=>q(!V),className:"emoji-button flex-shrink-0 p-2 rounded-lg bg-gray-700/50 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600/50 hover:border-gray-500 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500",title:"Emojis","aria-label":"Abrir selector de emojis",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,r.jsx)("button",{onClick:L,disabled:!k.trim(),className:"flex-shrink-0 bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg",title:"Enviar mensaje (Enter)","aria-label":"Enviar mensaje",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})]})]}),I&&(0,r.jsxs)("div",{className:"absolute inset-0 z-[5]",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/40",onClick:()=>null==A?void 0:A(null)}),(0,r.jsxs)("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-[300px] bg-gray-900 border border-gray-700 rounded-xl shadow-2xl p-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"text-sm font-semibold text-white",children:"Eliminar conversaci\xf3n"}),(0,r.jsx)("button",{onClick:()=>null==A?void 0:A(null),className:"text-gray-400 hover:text-white",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsx)("p",{className:"text-xs text-gray-300 mb-4",children:"\xbfEst\xe1s seguro de que quieres eliminar esta conversaci\xf3n? Esta acci\xf3n no se puede deshacer."}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),null==A||A(null)},className:"flex-1 px-3 py-2 rounded-lg bg-gray-800 text-gray-200 hover:bg-gray-700 text-xs",children:"Cancelar"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),console.log("\uD83D\uDD34 [MainChatWindow] Click en Eliminar confirmado. ID:",I),M&&I?M(I):console.error("❌ [MainChatWindow] Funci\xf3n deleteConversation no disponible o ID inv\xe1lido")},className:"flex-1 px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-xs",children:"Eliminar"})]})]})]})]}),(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("div",{id:"aim-embedded-windows",className:"absolute bottom-0 left-0 right-0"})}),K&&Z&&o&&(0,r.jsx)(f.Z,{isOpen:K,onClose:()=>{Y(!1),G(null)},modelId:Z.id,modelName:Z.name,modelEmail:Z.email,userId:o})]})},C=e=>{let{openChatWindows:t,onCloseWindow:n,userId:s,userRole:i,session:l,isMainChatOpen:c=!1,onCloseMainChat:d,view:u,setView:h,availableUsers:m=[],expandedSections:x={online:!0,offline:!1},setExpandedSections:f,openChatWithUser:v,conversations:p,selectedConversation:D,setSelectedConversation:w,messages:b,newMessage:y,setNewMessage:C,sendMessage:E,handleKeyPress:N,showDeleteConfirm:_,setShowDeleteConfirm:k,deleteConversation:W,tempChatUser:L,getDisplayName:S,replyTo:I,setReplyTo:A}=e,[M,T]=(0,a.useState)(!1);if((0,a.useEffect)(()=>{T(!0)},[]),!M||"undefined"==typeof document||0===t.length&&!c)return null;let B=document.getElementById("aim-embedded-windows");return(0,r.jsxs)(r.Fragment,{children:[c&&document.body&&(0,o.createPortal)((0,r.jsx)(j,{onClose:d,userId:s,userRole:i,session:l,windowIndex:-1,view:u,setView:h,availableUsers:m,expandedSections:x,setExpandedSections:f,openChatWithUser:v,conversations:p,selectedConversation:D,setSelectedConversation:w,messages:b,newMessage:y,setNewMessage:C,sendMessage:E,handleKeyPress:N,showDeleteConfirm:_,setShowDeleteConfirm:k,deleteConversation:W,tempChatUser:L,getDisplayName:S,replyTo:I,setReplyTo:A}),document.body),c&&B?t.map((e,t)=>(0,o.createPortal)((0,r.jsx)(g,{conversationId:e.conversationId,otherUser:e.otherUser,onClose:()=>n(e.id),userId:s,userRole:i,session:l,windowIndex:t,isInChatBar:!0},e.id),B)):t.map((e,t)=>(0,r.jsx)(g,{conversationId:e.conversationId,otherUser:e.otherUser,onClose:()=>n(e.id),userId:s,userRole:i,session:l,windowIndex:t,isInChatBar:!0},e.id))]})};function E(e){let{id:t,senderName:n,senderAvatar:s,messagePreview:i,conversationId:l,onOpenConversation:c,onClose:d,duration:u=4e3}=e,[h,m]=(0,a.useState)(!1),[g,x]=(0,a.useState)(!1),[f,v]=(0,a.useState)(!1);(0,a.useEffect)(()=>{x(!0),setTimeout(()=>m(!0),10)},[]),(0,a.useEffect)(()=>{if(!h)return;let e=setTimeout(()=>{v(!0),setTimeout(()=>{d(t)},300)},u);return()=>clearTimeout(e)},[h,u,t,d]);let p=i.length>50?i.substring(0,50)+"...":i;if(!g)return null;let D=(0,r.jsx)("div",{className:"fixed top-4 right-4 z-[99999] max-w-sm transition-all duration-300 ".concat(h&&!f?"opacity-100 translate-y-0":"opacity-0 translate-y-[-10px] pointer-events-none"),role:"alert","aria-live":"polite",children:(0,r.jsx)("div",{onClick:()=>{c(l),d(t)},className:"bg-white/95 dark:bg-gray-800/95 backdrop-blur-md border border-gray-100 dark:border-gray-700/50 border-l-4 border-l-blue-500 rounded-lg shadow-2xl p-4 cursor-pointer hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 animate-fadeIn ring-1 ring-black/5 dark:ring-white/5",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20 flex-shrink-0 text-white font-bold text-sm tracking-wide",children:s?(0,r.jsx)("img",{src:s,alt:n,className:"w-full h-full rounded-full object-cover ring-2 ring-white/20"}):(0,r.jsx)("span",{children:n.charAt(0).toUpperCase()})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100 truncate",children:n}),(0,r.jsx)("div",{className:"text-xs text-gray-600 dark:text-gray-400 mt-0.5 line-clamp-2",children:p})]}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),d(t)},className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors flex-shrink-0","aria-label":"Cerrar notificaci\xf3n",children:(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})});return"undefined"!=typeof document&&document.body?(0,o.createPortal)(D,document.body):null}function N(e){let{userId:t,userRole:n}=e,[u,h]=(0,a.useState)(!1),[m,g]=(0,a.useState)([]),[f,v]=(0,a.useState)([]),[p,D]=(0,a.useState)(null),[b,j]=(0,a.useState)([]),[N,_]=(0,a.useState)(""),[k,W]=(0,a.useState)(!1),[L,S]=(0,a.useState)("users"),[I,A]=(0,a.useState)(!1),[M,T]=(0,a.useState)({online:!0,offline:!1}),[B,R]=(0,a.useState)(null),[F,z]=(0,a.useState)(null),[O,P]=(0,a.useState)(null),[U,H]=(0,a.useState)([]);(0,a.useEffect)(()=>{let e=()=>{console.log("\uD83D\uDD0A [ChatWidget] Inicializando sistema de audio por interacci\xf3n del usuario"),w(),window.removeEventListener("click",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)};return window.addEventListener("click",e),window.addEventListener("keydown",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)}},[]);let V=(0,a.useRef)(0),q=(0,a.useRef)(0),J=(0,a.useRef)(null),K=(0,a.useRef)(new Set),Y=(0,a.useRef)(""),Z=(0,a.useRef)(null),G=(0,a.useRef)(0);(0,a.useEffect)(()=>{{Y.current||(Y.current=document.title||"AIM Sistema",console.log("\uD83D\uDCDD [ChatWidget] T\xedtulo original guardado:",Y.current));let e=localStorage.getItem("chat_last_unread_count");e&&(V.current=parseInt(e,10));let t=localStorage.getItem("chat_processed_messages");if(t)try{let e=JSON.parse(t);K.current=new Set(e)}catch(e){console.warn("⚠️ [ChatWidget] Error parseando processedMessages desde localStorage:",e),K.current=new Set}}},[]);let[X,Q]=(0,a.useState)({}),$=(0,a.useRef)({}),ee=(0,a.useRef)(!0),et=(e,t)=>{Q(n=>{let r={...n,[e]:t};return $.current=r,r})},en=(0,a.useRef)(new Set),er=(0,a.useRef)(new Map),ea=(0,a.useRef)(new Map),eo=async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!el||!e||e.startsWith("temp_")||en.current.has(e))return;let n=ea.current.get(e)||0,r=Date.now();if(!t&&r-n<2e3)return;let a=er.current.get(e);a&&(clearTimeout(a),er.current.delete(e));let o=async()=>{en.current.add(e);try{let t=await fetch("/api/chat/messages/read",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({conversation_id:e})});ea.current.set(e,Date.now());let n=await t.json();n.success?(es(e),eb.current.add(e),n.updated>0&&setTimeout(()=>{ey()},200)):console.warn("⚠️ [ChatWidget] Advertencia al marcar le\xeddo:",n.error)}catch(e){console.error("❌ [ChatWidget] Error en fetch de marcar como le\xeddo:",e)}finally{en.current.delete(e)}};if(t)await o();else{let t=setTimeout(o,500);er.current.set(e,t)}},es=e=>{g(t=>t.map(t=>t.id===e?{...t,unread_count:0}:t))};(0,a.useEffect)(()=>{$.current=X},[X]);let ei=(0,a.useRef)(null),[el,ec]=(0,a.useState)(null),ed=(0,a.useRef)(null),eu=(0,a.useRef)(null),[eh,em]=(0,a.useState)(!1),[eg,ex]=(0,a.useState)(!1),[ef,ev]=(0,a.useState)([]);(0,a.useEffect)(()=>{console.log("\uD83E\uDE9F [ChatWidget] Ventanas abiertas actualizadas:",ef.length,ef)},[ef]);let ep=e=>e.id===l||e.email===d?c:"modelo"===e.role?e.email.split("@")[0]:e.name,eD=m.reduce((e,t)=>e+(t.unread_count||0),0),ew=async()=>{try{let{data:{session:e},error:t}=await s.supabase.auth.getSession();if(t||!e)return console.warn("⚠️ [ChatWidget] No hay sesi\xf3n disponible:",null==t?void 0:t.message),null;let n=e.expires_at;if(n){let e=Math.floor(Date.now()/1e3);if(n-e<60){console.log("\uD83D\uDD04 [ChatWidget] Token expirando pronto, refrescando sesi\xf3n...");let{data:{session:e},error:t}=await s.supabase.auth.refreshSession();if(t||!e)return console.error("❌ [ChatWidget] Error refrescando sesi\xf3n:",t),null;return ec(e),e.access_token}}return e!==el&&ec(e),e.access_token}catch(e){return console.error("❌ [ChatWidget] Error obteniendo token v\xe1lido:",e),null}};(0,a.useEffect)(()=>{em(!0),(async()=>{let{data:{session:e}}=await s.supabase.auth.getSession();ec(e)})()},[]),(0,a.useEffect)(()=>()=>{},[]),(0,a.useEffect)(()=>{if(!t)return;let e=async()=>{try{await (0,i.do)(t)}catch(e){console.error("❌ [ChatWidget] Error enviando heartbeat:",e)}};e(),ed.current=setInterval(e,3e4);let n=async()=>{try{await (0,i.lH)(t)}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}},r=async()=>{document.hidden?(ed.current&&clearInterval(ed.current),ed.current=setInterval(e,6e4)):(ed.current&&clearInterval(ed.current),ed.current=setInterval(e,3e4),e(),Z.current&&(clearInterval(Z.current),Z.current=null),G.current=0,document.title=Y.current,console.log("\uD83D\uDCE2 [ChatWidget] T\xedtulo de pesta\xf1a restaurado"))};return window.addEventListener("beforeunload",n),document.addEventListener("visibilitychange",r),()=>{ed.current&&clearInterval(ed.current),window.removeEventListener("beforeunload",n),document.removeEventListener("visibilitychange",r),(0,i.lH)(t).catch(e=>{console.error("❌ [ChatWidget] Error marcando usuario offline en cleanup:",e)})}},[t]),(0,a.useEffect)(()=>{let e=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n restaurada"),t)try{await eS(!0),console.log("\uD83D\uDFE2 [ChatWidget] Usuario marcado como online tras restaurar conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario online:",e)}},n=async()=>{if(console.log("\uD83C\uDF10 [ChatWidget] Conexi\xf3n perdida"),t)try{await eS(!1),console.log("\uD83D\uDD34 [ChatWidget] Usuario marcado como offline por p\xe9rdida de conexi\xf3n")}catch(e){console.error("❌ [ChatWidget] Error marcando usuario offline:",e)}};return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}},[t]);let eb=(0,a.useRef)(new Set),ey=async()=>{if(!el||!el.access_token){console.warn("⚠️ [ChatWidget] No hay sesi\xf3n disponible para cargar conversaciones");return}try{let e=await fetch("/api/chat/conversations",{headers:{Authorization:"Bearer ".concat(el.access_token)}});if(401===e.status){console.warn("⚠️ [ChatWidget] Token inv\xe1lido (401) al cargar conversaciones");return}let n=await e.json();if(n.success){let e=(n.conversations||[]).map(e=>{let t=u&&"chat"===L&&p===e.id,n=eb.current.has(e.id);return t||n?(e.unread_count>0&&t&&eo(e.id,!0),{...e,unread_count:0}):e});g(e);let r=e.reduce((e,t)=>e+(t.unread_count||0),0);u?ee.current&&(ee.current=!1):ee.current?(console.log("\uD83D\uDD07 [ChatWidget] Primera carga: silenciando notificaciones iniciales"),e.forEach(e=>{e.last_message&&K.current.add(e.last_message.id)}),ee.current=!1):e.forEach(e=>{if(e.unread_count>0&&e.last_message){let n=e.last_message.id;if(K.current.has(n))return;let r=m.find(t=>t.id===e.id),a=(null==r?void 0:r.unread_count)||0;if(e.unread_count>a&&e.last_message.sender_id!==t){K.current.add(n);{let e=Array.from(K.current).slice(-100);localStorage.setItem("chat_processed_messages",JSON.stringify(e)),K.current=new Set(e)}eI(e,e.last_message)}}}),V.current=r,localStorage.setItem("chat_last_unread_count",r.toString())}}catch(e){console.error("Error cargando conversaciones:",e)}},ej=async()=>{if(el)try{let e=await fetch("/api/chat/users",{headers:{Authorization:"Bearer ".concat(el.access_token)}}),t=await e.json();t.success&&v(t.users)}catch(e){console.error("Error cargando usuarios:",e)}},eC=async e=>{if(el){p!==e&&(console.log("\uD83D\uDD04 [ChatWidget] Limpiando mensajes previos al cambiar de conversaci\xf3n"),j([]),_(""));try{let n=await fetch("/api/chat/messages?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(el.access_token)}}),r=await n.json();if(r.success){let n=r.messages||[];if(console.log("\uD83D\uDCE8 [ChatWidget] Mensajes cargados:",{conversationId:e,count:n.length}),j(n),n.length>0){let r=n[n.length-1];r&&r.sender_id!==t&&r.id!==J.current&&!u&&(J.current=r.id),et(e,r.id)}p!==e&&D(e),await eo(e,!0),es(e)}else{if(console.error("❌ [ChatWidget] Error en respuesta de mensajes:",r),r.error&&(r.error.includes("no encontrada")||r.error.includes("no existe"))){console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante carga de mensajes, preparando nueva conversaci\xf3n..."),await eE(e);return}await eN(e)}}catch(t){console.error("❌ [ChatWidget] Error cargando mensajes:",t),await eN(e)}}},eE=async e=>{if(el){console.log("\uD83D\uDD04 [ChatWidget] Manejando conversaci\xf3n eliminada:",e);try{if(await ey(),e.startsWith("temp_"))console.log("\uD83E\uDDF9 [ChatWidget] Limpiando conversaci\xf3n temporal eliminada"),j([]),R(null),S("users");else{console.log("\uD83D\uDCA1 [ChatWidget] Conversaci\xf3n eliminada, preparando nueva conversaci\xf3n autom\xe1ticamente");let n=b[b.length-1];if(n&&n.sender_id!==t){let e=n.sender_id,t=f.find(t=>t.id===e);if(t){console.log("\uD83C\uDFAF [ChatWidget] Usuario identificado para nueva conversaci\xf3n:",t.name||t.email),R(t),D("temp_".concat(e)),j([]);let n={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Conversaci\xf3n reiniciada con ".concat(ep(t),". Puedes continuar chateando."),sender_id:"system",conversation_id:"temp_".concat(e),created_at:new Date().toISOString(),is_system_message:!0};j([n]);return}}console.log("⚠️ [ChatWidget] No se pudo identificar al usuario, mostrando mensaje gen\xe9rico"),j([]),R(null);let r={id:"info_".concat(Date.now()),content:"\uD83D\uDCAC Esta conversaci\xf3n fue eliminada. Selecciona un usuario para iniciar una nueva conversaci\xf3n.",sender_id:"system",conversation_id:e,created_at:new Date().toISOString(),is_system_message:!0};j([r]),S("users")}}catch(e){console.error("❌ [ChatWidget] Error manejando conversaci\xf3n eliminada:",e),j([]),R(null),S("users")}}},eN=async e=>{try{console.log("\uD83D\uDD0D [ChatWidget] Ejecutando diagn\xf3stico de polling...");let t=await ew();if(!t){console.error("❌ [ChatWidget] No se pudo obtener token v\xe1lido para diagn\xf3stico");return}let n=await fetch("/api/chat/debug-polling?conversation_id=".concat(e),{headers:{Authorization:"Bearer ".concat(t)}}),r=await n.json();r.success?console.log("✅ [ChatWidget] Diagn\xf3stico exitoso:",r.debug):console.error("❌ [ChatWidget] Diagn\xf3stico fall\xf3:",r)}catch(e){console.error("❌ [ChatWidget] Error en diagn\xf3stico:",e)}},e_=async()=>{if(N.trim()&&p&&el){console.log("\uD83D\uDCE4 [ChatWidget] Enviando mensaje:",{content:N.trim(),conversationId:p,userId:t}),W(!0);try{let e=p;if(p.startsWith("temp_")){console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n temporal...");let t=p.replace("temp_",""),n=await eW(t);if(n)e=n,D(n),R(null),console.log("✅ [ChatWidget] Conversaci\xf3n creada:",n);else{console.error("❌ [ChatWidget] Error creando conversaci\xf3n");return}}let t=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({conversation_id:e,content:N.trim(),reply_to_message_id:O?O.id:void 0})}),n=await t.json();console.log("\uD83D\uDCE8 [ChatWidget] Respuesta del servidor:",n),n.success?(console.log("✅ [ChatWidget] Mensaje enviado exitosamente"),_(""),P(null),setTimeout(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Recargando mensajes como fallback..."),await eC(e)},1e3),await ey()):(console.error("❌ [ChatWidget] Error en respuesta del servidor:",n),n.error&&(n.error.includes("no encontrada")||n.error.includes("no existe"))&&(console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n eliminada durante env\xedo, preparando nueva conversaci\xf3n..."),await eE(e)))}catch(e){console.error("❌ [ChatWidget] Error enviando mensaje:",e)}finally{W(!1)}}},ek=async e=>{if(console.log("\uD83D\uDDB1️ [ChatWidget] Click detectado en usuario:",e),console.log("\uD83D\uDDB1️ [ChatWidget] Sesi\xf3n disponible:",!!el),console.log("\uD83D\uDDB1️ [ChatWidget] Usuarios disponibles:",f.length),!el){console.log("❌ [ChatWidget] No hay sesi\xf3n disponible");return}console.log("\uD83D\uDCAC [ChatWidget] Abriendo chat con usuario:",e);let t=m.find(t=>t.other_participant.id===e),n=f.find(t=>t.id===e);if(console.log("\uD83D\uDC64 [ChatWidget] Usuario encontrado:",n),!n){console.log("❌ [ChatWidget] Usuario no encontrado en availableUsers");return}if(u){if(t)console.log("\uD83E\uDE9F [ChatWidget] Integrando conversaci\xf3n existente dentro del AIM Assistant:",t.id),D(t.id),S("chat"),await eC(t.id);else{console.log("\uD83C\uDD95 [ChatWidget] Creando conversaci\xf3n integrada en AIM Assistant con:",n.name||n.email);try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({participant_2_id:e})}),n=await t.json();n.success?(D(n.conversation.id),S("chat"),await eC(n.conversation.id),await ey()):console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",n.error)}catch(e){console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",e)}}return}if(ef.find(t=>t.otherUser.id===e)){console.log("\uD83E\uDE9F [ChatWidget] Ventana ya abierta para este usuario");return}if(t){console.log("\uD83D\uDCC2 [ChatWidget] Abriendo conversaci\xf3n existente en ventana individual:",t.id);let e={id:"window_".concat(t.id),conversationId:t.id,otherUser:n};ev(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando ventana:",e),[...t,e]))}else{console.log("\uD83C\uDD95 [ChatWidget] Creando nueva conversaci\xf3n en ventana individual con:",n.name||n.email);try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({participant_2_id:e})}),r=await t.json();if(console.log("\uD83D\uDCE1 [ChatWidget] Respuesta API crear conversaci\xf3n:",r),r.success){let e={id:"window_".concat(r.conversation.id),conversationId:r.conversation.id,otherUser:n};ev(t=>(console.log("\uD83E\uDE9F [ChatWidget] Agregando nueva ventana:",e),[...t,e])),await ey()}else console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",r.error)}catch(e){console.error("❌ [ChatWidget] Error creando conversaci\xf3n:",e)}}},eW=async e=>{if(el){try{let t=await fetch("/api/chat/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({participant_2_id:e})}),n=await t.json();if(n.success)return n.conversation.id}catch(e){console.error("Error creando conversaci\xf3n:",e)}return null}},eL=async e=>{if(console.log("\uD83D\uDDD1️ [ChatWidget] Solicitud de eliminaci\xf3n para conversaci\xf3n:",e),!el){console.error("❌ [ChatWidget] Error: No hay sesi\xf3n activa para eliminar conversaci\xf3n");return}try{console.log("⏳ [ChatWidget] Enviando petici\xf3n DELETE a API...");let t=await fetch("/api/chat/conversations?conversation_id=".concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(el.access_token)}}),n=await t.json();n.success?(console.log("✅ [ChatWidget] Conversaci\xf3n eliminada exitosamente"),await ey(),p===e&&(D(null),j([]),R(null),console.log("\uD83E\uDDF9 [ChatWidget] Estado de chat limpiado despu\xe9s de eliminaci\xf3n")),z(null)):console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n (API):",n.error)}catch(e){console.error("❌ [ChatWidget] Error eliminando conversaci\xf3n (Network/Code):",e)}},eS=async e=>{if(el)try{await fetch("/api/chat/users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(el.access_token)},body:JSON.stringify({is_online:e})})}catch(e){console.error("Error actualizando estado:",e)}},eI=(e,t)=>{if(u&&"chat"===L&&p===e.id)return;if(0===e.unread_count||!e.unread_count){console.log("⏭️ [ChatWidget] No mostrar toast: conversaci\xf3n ya est\xe1 marcada como le\xedda");return}if(K.current.has(t.id)){console.log("⏭️ [ChatWidget] No mostrar toast: mensaje ya procesado:",t.id);return}let n="".concat(e.id,"-").concat(t.id,"-").concat(Date.now()),r=e.other_participant;H([]),H([{id:n,conversationId:e.id,senderName:ep(r),senderAvatar:null,messagePreview:t.content||""}]);let a=Date.now();a-q.current>2e3&&(y(.6),q.current=a)},eA=e=>{H(t=>t.filter(t=>t.id!==e))},eM=e=>{var t;h(!0),S("chat"),D(e),eA((null===(t=U.find(t=>t.conversationId===e))||void 0===t?void 0:t.id)||"")};(0,a.useEffect)(()=>{el&&(ey(),ej(),eS(!0))},[el]),(0,a.useEffect)(()=>{el&&p&&u&&"chat"===L&&!p.startsWith("temp_")&&eo(p,!0)},[el,p,u,L]),(0,a.useEffect)(()=>{p&&u&&"chat"===L&&!p.startsWith("temp_")?localStorage.setItem("chat_last_open_conversation",p):u&&"chat"===L||localStorage.removeItem("chat_last_open_conversation")},[p,u,L]),(0,a.useEffect)(()=>{if(el&&m.length>0){let t=localStorage.getItem("chat_last_open_conversation");if(t&&u&&"chat"===L){var e;let n=m.find(e=>e.id===t);n&&(null!==(e=n.unread_count)&&void 0!==e?e:0)>0&&(console.log("\uD83D\uDC41️ [ChatWidget] Marcando conversaci\xf3n como le\xedda al recargar:",t),eo(t,!0),eb.current.add(t),es(t))}}},[m,el,u,L]),(0,a.useEffect)(()=>{if(!el)return;let e=setInterval(()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling de respaldo: actualizando lista de usuarios..."),ej()},15e3);return()=>{clearInterval(e)}},[el]),(0,a.useEffect)(()=>{if(!el||!p)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling de mensajes como respaldo...");let e=setInterval(async()=>{console.log("\uD83D\uDD04 [ChatWidget] Polling: verificando mensajes nuevos..."),await eC(p)},3e3);return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Deteniendo polling de mensajes..."),clearInterval(e)}},[el,p]),(0,a.useEffect)(()=>{let e=()=>{w(),setTimeout(()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)},100)};return window.addEventListener("click",e),window.addEventListener("keydown",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",e),window.removeEventListener("touchstart",e)}},[]),(0,a.useEffect)(()=>{if(!el)return;console.log("\uD83D\uDD04 [ChatWidget] Iniciando polling inteligente de conversaciones...");let e=setInterval(async()=>{try{let n=await ew();if(!n){console.warn("⚠️ [Polling] No se pudo obtener token v\xe1lido, deteniendo polling"),clearInterval(e);return}let r=await fetch("/api/chat/conversations",{headers:{Authorization:"Bearer ".concat(n)}});if(401===r.status){console.warn("⚠️ [Polling] Token inv\xe1lido (401), deteniendo polling"),clearInterval(e);return}if(!r.ok)return;let a=await r.json();if(!a.success||!a.conversations)return;let o=a.conversations;g(e=>(o.forEach(n=>{let r=e.find(e=>e.id===n.id);if(r&&n.last_message_at>r.last_message_at){let e=n.last_message;e&&e.sender_id!==t&&(console.log("\uD83D\uDD04 [Polling] Mensaje nuevo detectado en polling:",e),K.current.has(e.id)||(console.log("\uD83D\uDD14 [Polling] Disparando notificaci\xf3n de respaldo..."),K.current.add(e.id),y(.8),h(e=>e||(setTimeout(()=>{S("chat"),D(n.id)},50),!0)),D(e=>e!==n.id?n.id:e)))}}),o))}catch(e){console.error("Error en polling:",e)}},4e3);return()=>clearInterval(e)},[el,t]);let eT=(0,a.useRef)(null);return(0,a.useEffect)(()=>{null!==eT.current&&eT.current!==p&&null!==p&&(console.log("\uD83D\uDD04 [ChatWidget] Cambio de conversaci\xf3n detectado:",{from:eT.current,to:p}),j([]),_(""),R(null)),eT.current=p},[p]),(0,a.useEffect)(()=>{var e;null===(e=ei.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[b]),(0,a.useEffect)(()=>{var e;if(!u||"chat"!==L||!p||p.startsWith("temp_"))return;eo(p,!0),eb.current.add(p),H(e=>e.filter(e=>e.conversationId!==p)),es(p);let t=m.find(e=>e.id===p);if(null==t?void 0:null===(e=t.last_message)||void 0===e?void 0:e.id){K.current.add(t.last_message.id);{let e=Array.from(K.current).slice(-100);localStorage.setItem("chat_processed_messages",JSON.stringify(e)),K.current=new Set(e)}}},[u,L,p,m]),(0,a.useEffect)(()=>{if(!el||!t)return;console.log("\uD83D\uDD14 [ChatWidget] Configurando suscripci\xf3n en tiempo real...");let e=s.supabase.channel("chat-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},async e=>{let n=e.new;console.log("\uD83D\uDCE8 [ChatWidget] Nuevo mensaje recibido:",n),console.log("\uD83D\uDCCA [ChatWidget] Estado actual - isOpen:",u,"selectedConversation:",p,"userId:",t);try{let{data:e,error:a}=await s.supabase.from("chat_conversations").select("participant_1_id, participant_2_id").eq("id",n.conversation_id).single();if(a||!e){console.log("❌ [ChatWidget] Error verificando conversaci\xf3n:",a);return}let o=e.participant_1_id===t||e.participant_2_id===t;if(console.log("\uD83D\uDC64 [ChatWidget] Es participante?",o,"sender_id:",n.sender_id,"userId:",t),o){if(console.log("✅ [ChatWidget] Usuario es participante de la conversaci\xf3n"),n.sender_id!==t){console.log("\uD83D\uDD14 [ChatWidget] \xa1MENSAJE DE OTRO USUARIO DETECTADO!");let e=document.hidden;if(console.log("\uD83D\uDCCA [ChatWidget] Estado de pesta\xf1a - document.hidden:",e,"originalTitle:",Y.current),e){console.log("\uD83D\uDCE2 [ChatWidget] Usuario en otra pesta\xf1a, notificando..."),Y.current||(Y.current=document.title||"AIM Sistema");let e=f.find(e=>e.id===n.sender_id),t=(null==e?void 0:e.name)||"Alguien";G.current+=1,Z.current&&clearInterval(Z.current);let a=!1;if(Z.current=setInterval(()=>{(a=!a)&&G.current>0?document.title="\uD83D\uDD14 (".concat(G.current,") Nuevo mensaje - ").concat(Y.current):G.current>0?document.title="(".concat(G.current,") Nuevo mensaje - ").concat(Y.current):document.title=Y.current},1e3),"Notification"in window&&"granted"===Notification.permission)try{var r;new Notification("Nuevo mensaje de ".concat(t),{body:(null===(r=n.content)||void 0===r?void 0:r.substring(0,100))||"Tienes un nuevo mensaje",icon:"/favicon.ico",tag:"chat-".concat(n.conversation_id),requireInteraction:!1}),console.log("✅ [ChatWidget] Notificaci\xf3n del navegador mostrada")}catch(e){console.warn("⚠️ [ChatWidget] Error mostrando notificaci\xf3n del navegador:",e)}else"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission().then(e=>{if("granted"===e)try{var r;new Notification("Nuevo mensaje de ".concat(t),{body:(null===(r=n.content)||void 0===r?void 0:r.substring(0,100))||"Tienes un nuevo mensaje",icon:"/favicon.ico",tag:"chat-".concat(n.conversation_id)}),console.log("✅ [ChatWidget] Notificaci\xf3n del navegador mostrada (despu\xe9s de permiso)")}catch(e){console.warn("⚠️ [ChatWidget] Error mostrando notificaci\xf3n del navegador:",e)}});if("vibrate"in navigator)try{navigator.vibrate([200,100,200]),console.log("✅ [ChatWidget] Vibraci\xf3n activada")}catch(e){console.warn("⚠️ [ChatWidget] Error en vibraci\xf3n:",e)}}else console.log("\uD83D\uDC41️ [ChatWidget] Usuario est\xe1 viendo la pesta\xf1a, no se notifica");console.log("\uD83D\uDD0A [ChatWidget] Intentando reproducir sonido...");try{y(.8),console.log("\uD83D\uDD0A [ChatWidget] Comando de sonido enviado")}catch(e){console.error("❌ [ChatWidget] Error al reproducir sonido:",e)}h(e=>(console.log("\uD83D\uDCC2 [ChatWidget] Estado isOpen actual:",e),e)?(console.log("\uD83D\uDCC2 [ChatWidget] El chat ya estaba abierto"),D(e=>e!==n.conversation_id?(console.log("\uD83D\uDD04 [ChatWidget] Cambiando a conversaci\xf3n del mensaje nuevo"),S("chat"),setTimeout(()=>{ey()},100),n.conversation_id):(console.log("\uD83D\uDD04 [ChatWidget] Ya estaba en la conversaci\xf3n correcta"),e)),e):(console.log("\uD83D\uDCC2 [ChatWidget] ⚡ ABRIENDO CHAT AUTOM\xc1TICAMENTE - Chat estaba cerrado"),setTimeout(()=>{S("chat"),D(n.conversation_id),ey()},100),!0));let t=Date.now();t-q.current>2e3&&(console.log("\uD83D\uDD14 [ChatWidget] Reproduciendo sonido para mensaje nuevo"),y(.6),q.current=t)}if(p===n.conversation_id?(console.log("\uD83D\uDCAC [ChatWidget] Agregando mensaje a conversaci\xf3n activa"),j(e=>e.some(e=>e.id===n.id)?(console.log("⚠️ [ChatWidget] Mensaje ya existe en la lista, no agregando"),e):(console.log("➕ [ChatWidget] Agregando nuevo mensaje a la lista"),[...e,n])),eo(n.conversation_id,!0).catch(()=>{}),eb.current.add(n.conversation_id),es(n.conversation_id)):(console.log("\uD83D\uDD04 [ChatWidget] Nuevo mensaje en conversaci\xf3n no activa, actualizando lista..."),ey()),n.sender_id===l&&n.id!==eu.current&&n.sender_id!==t){console.log("\uD83E\uDD16 [ChatWidget] Mensaje nuevo de AIM Botty detectado, abriendo ventana autom\xe1ticamente..."),eu.current=n.id;let e=ef.some(e=>e.otherUser.id===l||e.otherUser.email===d);!e&&u?(console.log("\uD83E\uDE9F [ChatWidget] Abriendo ventana de AIM Botty autom\xe1ticamente..."),setTimeout(()=>{ek(l)},500)):e&&console.log("\uD83E\uDE9F [ChatWidget] Ventana de AIM Botty ya est\xe1 abierta")}}else console.log("❌ [ChatWidget] Usuario no es participante de la conversaci\xf3n")}catch(e){console.error("❌ [ChatWidget] Error en verificaci\xf3n de conversaci\xf3n:",e)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_conversations"},e=>{let t=e.new;console.log("\uD83D\uDD04 [ChatWidget] Conversaci\xf3n actualizada:",t),m.some(e=>e.id===t.id)&&(console.log("✅ [ChatWidget] Conversaci\xf3n relevante actualizada, recargando lista..."),ey())}).subscribe(e=>{console.log("\uD83D\uDCE1 [ChatWidget] Estado de suscripci\xf3n:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n en tiempo real"),s.supabase.removeChannel(e),er.current.forEach(e=>clearTimeout(e)),er.current.clear(),en.current.clear()}},[el,t]),(0,a.useEffect)(()=>{if(!el)return;console.log("\uD83D\uDC65 [ChatWidget] Configurando suscripci\xf3n para estados de usuarios...");let e=s.supabase.channel("chat-user-status-realtime").on("postgres_changes",{event:"*",schema:"public",table:"chat_user_status"},async e=>{if(console.log("\uD83D\uDC65 [ChatWidget] Estado de usuario actualizado:",e),await ej(),e.new){let t=e.new;console.log("\uD83D\uDCCA [ChatWidget] Usuario ".concat(t.user_id," ahora est\xe1 ").concat(t.is_online?"EN L\xcdNEA":"OFFLINE"))}}).subscribe(e=>{console.log("\uD83D\uDC65 [ChatWidget] Estado de suscripci\xf3n de usuarios:",e)});return()=>{console.log("\uD83E\uDDF9 [ChatWidget] Limpiando suscripci\xf3n de estados de usuarios"),s.supabase.removeChannel(e)}},[el]),(0,a.useEffect)(()=>{},[m,p]),(0,r.jsxs)(r.Fragment,{children:[eh&&"undefined"!=typeof document&&document.body&&(0,o.createPortal)((0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("button",{onClick:()=>{let e=!u;h(e),e&&w(),e&&el&&ey(),e?H([]):R(null)},style:{right:24,bottom:"calc(env(safe-area-inset-bottom, 0px) + 24px)"},className:"fixed w-10 h-10 hover:w-16 hover:h-10 text-white dark:text-gray-900 rounded-xl shadow-lg border border-white/20 dark:border-gray-700/30 transition-all duration-300 flex items-center justify-center z-[9995] group overflow-visible ".concat(eD>0?"bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 animate-gradient-x shadow-blue-500/30 ring-2 ring-blue-400/30":"bg-gradient-to-br from-gray-900 to-black dark:from-gray-100 dark:to-gray-300"),"aria-label":"Abrir chat de soporte".concat(eD>0?" (".concat(eD," mensajes no le\xeddos)"):""),children:(0,r.jsxs)("div",{className:"flex items-center justify-center relative w-full h-full",children:[(0,r.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-sm group-hover:hidden drop-shadow-sm",children:"A"}),(0,r.jsx)("span",{className:"text-white dark:text-gray-900 font-bold text-xs hidden group-hover:block whitespace-nowrap drop-shadow-sm",children:"AIM"}),eD>0&&(0,r.jsx)("div",{className:"absolute top-0 right-0 translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none opacity-90",children:(0,r.jsx)(x,{count:eD,variant:"blue",size:"small"})})]})})}),document.body),(0,r.jsx)(C,{openChatWindows:ef,onCloseWindow:e=>{ev(t=>t.filter(t=>t.id!==e))},userId:t,userRole:n,session:el,isMainChatOpen:u,onCloseMainChat:()=>h(!1),view:L,setView:S,availableUsers:f,expandedSections:M,setExpandedSections:T,openChatWithUser:ek,conversations:m,selectedConversation:p,setSelectedConversation:D,messages:b,newMessage:N,setNewMessage:_,sendMessage:e_,handleKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e_())},showDeleteConfirm:F,setShowDeleteConfirm:z,deleteConversation:eL,tempChatUser:B,getDisplayName:ep,replyTo:O,setReplyTo:P}),U.filter(e=>!(u&&"chat"===L&&p===e.conversationId)).map(e=>(0,r.jsx)(E,{id:e.id,senderName:e.senderName,senderAvatar:e.senderAvatar,messagePreview:e.messagePreview,conversationId:e.conversationId,onOpenConversation:eM,onClose:eA,duration:4e3},e.id))]})}}}]);